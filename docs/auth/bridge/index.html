<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Galactly — Setting things up…</title>
<meta name="color-scheme" content="dark light"/>
<link rel="canonical" href="https://galactly.com/auth/bridge"/>
<!-- Optional: share API base with step-3 convention; can be overridden by localStorage('apiBase') -->
<meta name="api-base" content="">

<script>
/* Canonicalize /index.html → folder path (keep ? and #) */
(function(){
  if (/\/index\.html$/i.test(location.pathname)) {
    var q = location.search || '', h = location.hash || '';
    var p = location.pathname.replace(/index\.html$/i, '');
    if (!/\/$/.test(p)) p += '/';
    history.replaceState(null, '', p + q + h);
  }
})();
</script>

<style>
  :root{
    --bg: #0b0f14;
    --halo1: rgba(246,205,98,.18);
    --halo2: rgba(88,175,255,.18);
    --fg: #e9ecf3;
    --muted: #9aa3b2;
    --accent: #2fe077;
    --accent-shadow: rgba(47,224,119,.25);
    --card: rgba(15,16,22,.86);
    --card-border: rgba(255,255,255,.08);
    --radius: 16px;

    --main-h: 86px;
    --side-h: 64px;
    --gap: 16px;

    /* dwell range; we can shorten when session is ready */
    --rot-ms: 2200ms;
    --total-min: 2600;   /* min when session resolves quickly */
    --total-max: 5200;   /* nicer snap */
    --fallback-min: 10000; /* if session slow/unavailable */
    --fallback-max: 15000;

    --bar-ms: 1400ms;
  }

  html,body{height:100%;margin:0}
  body{
    color:var(--fg);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 800px at 72% 24%, var(--halo1), transparent 60%),
      radial-gradient(1100px 760px at 28% 76%, var(--halo2), transparent 62%),
      linear-gradient(180deg, #0f1218, var(--bg));
    -webkit-font-smoothing: antialiased;
    overflow:hidden;
  }

  .wrap{
    min-height:100svh;
    display:grid;
    place-items:center;
    padding: 12svh 16px 10svh;
  }

  .head{
    width:min(560px, 92vw);
    margin: 0 auto 18px;
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,.04);
    border:1px solid var(--card-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .head .who{ font-size:13px; color:var(--muted) }
  .head strong{ color:var(--fg); font-weight:700 }
  .ok{ width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 6px var(--accent-shadow) }

  .stack{ width:min(560px, 92vw); display:grid; gap: var(--gap); filter: drop-shadow(0 16px 44px rgba(0,0,0,.55)); }
  .card{
    position:relative;
    display:grid;
    grid-template-columns: 38px 1fr;
    align-items:center; gap:12px;
    padding: 12px 14px;
    border-radius: calc(var(--radius) + 2px);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid var(--card-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 12px 30px rgba(0,0,0,.35);
    transition: transform .6s cubic-bezier(.22,1,.36,1), opacity .6s ease, height .6s ease, filter .6s ease;
    overflow:hidden;
  }
  .card .title{ font-weight:700; font-size:14px; letter-spacing:.2px }
  .card .meta{ color:var(--muted); font-size:12px; margin-top:3px }
  .ic{ width:24px; height:24px; display:grid; place-items:center; color:#dfe7f5; opacity:.95 }
  .ic svg{ width:20px; height:20px; display:block }

  .bar{ height:8px; border-radius:999px; background: rgba(255,255,255,.06); overflow:hidden; margin-top:8px }
  .fill{
    width:22%; height:100%;
    background:
      linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.22), rgba(255,255,255,0)),
      linear-gradient(90deg, var(--accent), var(--accent));
    filter: drop-shadow(0 0 10px var(--accent-shadow));
    animation: slide var(--bar-ms) linear infinite;
  }
  @keyframes slide{ from{transform:translateX(-120%)} to{transform:translateX(220%)} }

  .slot-top    { height: var(--side-h);   opacity:.55; transform: scale(.94); filter: blur(.2px) }
  .slot-main   { height: var(--main-h);   opacity:1;    transform: scale(1);   filter: blur(0) }
  .slot-bottom { height: var(--side-h);   opacity:.55; transform: scale(.94); filter: blur(.2px) }

  .is-pending .bar{ display:none }
  .is-done    .bar{ display:none }

  .actions{ margin-top: 18px; display:flex; justify-content:center; gap:12px; opacity:.85; }
  .link{
    appearance:none; background:transparent; color:var(--fg);
    border:1px solid var(--card-border); border-radius:10px;
    padding:10px 14px; cursor:pointer; font-weight:600; font-size:13px;
  }
  .link:hover{ border-color: rgba(255,255,255,.22); }

  .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden }

  @media (prefers-reduced-motion: reduce){
    *{ animation-duration:1ms !important; transition:none !important }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="head" id="head">
    <div class="who">
      Preparing workspace for <strong id="h-email">—</strong>
      <span id="h-site" style="color:var(--muted)"></span>
    </div>
    <div class="ok" aria-hidden="true"></div>
  </div>

  <div class="stack" id="stack" role="status" aria-live="polite">
    <div class="card slot-top   is-done"    id="card-top"></div>
    <div class="card slot-main  is-active"  id="card-main"></div>
    <div class="card slot-bottom is-pending" id="card-bottom"></div>
  </div>

  <div class="actions" id="actDefault">
    <button class="link" id="backBtn" type="button">Back</button>
  </div>
  <div class="actions" id="actConfirm" style="display:none">
    <button class="link" id="yesBtn" type="button">Yes, that's us</button>
    <button class="link" id="noBtn"  type="button">No, change email</button>
  </div>

  <div class="sr" id="sr" aria-live="polite"></div>
</div>

<script>
/* ===================== Endpoints & helpers ===================== */
const ENDPOINTS = {
  session: '/api/session',                // { authenticated:boolean, plan:'free'|'pro'|'vip'|null }
  step3:  '/auth/step-3/',                // Step 3 lives under /auth/step-3/
  signup: '/auth/signup/',
  login:  '/auth/login/',
  portal: '/api/billing/portal'           // optional
};

const qs       = new URLSearchParams(location.search);
const emailQ   = (qs.get('email') || '').trim();
const roleQ    = (qs.get('role')  || '').trim();       // 'supplier' | 'buyer'
const siteQ    = (qs.get('site')  || '').replace(/^(https?:)?\/\//i,'').replace(/^www\./i,'').trim();
const from     = (qs.get('from')  || '').trim();       // 'google' | 'password' | 'unknown'
const nextQ    = (qs.get('next')  || '').trim();

/* Persist / hydrate lightweight context so Bridge & Step-3 can read them even if query is missing */
const LS = { role:'gg_role', email:'gg_email', site:'gg_site', origin:'gg_origin', apiBase:'apiBase' };
const role   = roleQ || localStorage.getItem(LS.role)   || '';
const email  = emailQ|| localStorage.getItem(LS.email)  || '';
const site   = siteQ || localStorage.getItem(LS.site)   || '';

if (role)  try{ localStorage.setItem(LS.role, role); }catch{}
if (email) try{ localStorage.setItem(LS.email,email);}catch{}
if (site)  try{ localStorage.setItem(LS.site, site);}catch{}

/* Header fill */
document.getElementById('h-email').textContent = email || 'new user';
document.getElementById('h-site').textContent  = site ? `• ${site}` : '';

/* Normalize/whitelist next path: internal only, no protocol */
function sanitizeNext(raw){
  if(!raw) return '';
  try{ raw = decodeURIComponent(raw); }catch(_){}
  if (/^https?:/i.test(raw)) {
    try {
      const u = new URL(raw, location.origin);
      if (u.origin !== location.origin) return '';
      raw = u.pathname + u.search + u.hash;
    }catch(_){ return ''; }
  }
  if (!raw.startsWith('/')) return '';
  raw = raw.replace(/\/{2,}/g,'/');
  return raw;
}
const nextSafe = sanitizeNext(nextQ);

/* Domain utils */
const PERSONAL = new Set([
  "gmail.com","googlemail.com","yahoo.com","ymail.com","outlook.com","hotmail.com","live.com","msn.com",
  "icloud.com","me.com","mac.com","aol.com","proton.me","protonmail.com","pm.me","mail.com","yandex.com","yandex.ru",
  "gmx.com","zoho.com","fastmail.com","hey.com","inbox.com"
]);
const emailHost = (()=>{
  const m = String(email).match(/@([^@\s>]+)$/);
  return m ? m[1].toLowerCase() : '';
})();
function baseDomain(h){
  if(!h) return '';
  const parts = h.toLowerCase().split('.').filter(Boolean);
  if(parts.length <= 2) return parts.join('.');
  const tlds2 = new Set(['co.uk','com.au','com.br','co.jp','co.in','com.mx','com.tr','com.cn','co.za','com.sg']);
  const last2 = parts.slice(-2).join('.');
  const last3 = parts.slice(-3).join('.');
  return tlds2.has(last2) ? last3 : last2;
}
function isBusinessEmailHost(h){ return !!h && !PERSONAL.has(h); }

/* Bounce back with inline error banner and a step-2 hint */
function bounce(backTo, code, msg){
  const url = new URL(backTo || ENDPOINTS.signup, location.origin);
  if(code) url.searchParams.set('err', code);
  if(msg)  url.searchParams.set('msg', msg);
  if(email) url.searchParams.set('email', email);
  if(site)  url.searchParams.set('site', site);
  if(role)  url.searchParams.set('role', role);
  if(nextSafe) url.searchParams.set('next', nextSafe);
  url.searchParams.set('auto','step2');
  const full = url.pathname + url.search + '#s2';
  location.replace(full);
}

/* Heuristic: where to bounce if not authenticated */
function pickOrigin(){
  const originHint = (sessionStorage.getItem(LS.origin) || '').trim(); // 'signup'|'login'
  if (originHint === 'login' || originHint === 'signup') return originHint;
  return (role || site) ? 'signup' : 'login';
}

/* ===================== UI rotor (unchanged visuals) ===================== */
const sr = (t)=>{ const el=document.getElementById('sr'); if(el) el.textContent=t; };

function renderCard(el, title, meta, state){
  el.className = el.className.replace(/\bis-(active|pending|done)\b/g,'').trim();
  el.classList.add('card');
  if(el.id === 'card-top')    el.classList.add('slot-top');
  if(el.id === 'card-main')   el.classList.add('slot-main');
  if(el.id === 'card-bottom') el.classList.add('slot-bottom');
  el.classList.add('is-' + (state||'pending'));

  el.innerHTML = `
    <div class="ic" aria-hidden="true">
      ${state === 'done'
        ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <circle cx="12" cy="12" r="10"></circle><path d="M8 12l3 3 5-6"></path>
           </svg>`
        : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <circle cx="12" cy="12" r="10" opacity=".9"></circle><path d="M12 6v6l4 2" opacity=".9"></path>
           </svg>`
      }
    </div>
    <div>
      <div class="title">${title}</div>
      <div class="meta">${meta || ''}</div>
      ${state === 'active' ? `<div class="bar"><div class="fill"></div></div>` : ``}
    </div>
  `;
}

/* Steps copy */
const forSupplier = [
  ['Verifying details',      email || 'Signing in'],
  ['Matching your domain',   site || 'Detecting business website'],
  ['Scanning website',       'Public pages & metadata'],
  ['Finding buyers with intent', 'Recent signals'],
  ['Training outreach agent','Tone & guardrails'],
  ['Creating your workspace','Teams, roles & defaults'],
];
const forBuyer = [
  ['Verifying details',        email || 'Signing in'],
  ['Matching your domain',     site || 'Detecting business website'],
  ['Scanning website',         'Public pages & metadata'],
  ['Finding vetted suppliers', 'Category & region'],
  ['Collecting timelines',     'MOQ, lead times'],
  ['Creating your workspace',  'Projects & defaults'],
];
const defaultSteps = [
  ['Verifying details',      email || 'Signing in'],
  ['Matching your domain',   site || 'Detecting business website'],
  ['Scanning website',       'Public pages & metadata'],
  ['Enriching company data', 'Signals & contacts'],
  ['Configuring defaults',   'Preferences & roles'],
  ['Creating your workspace','Final touches'],
];
const stepsSource = role === 'supplier' ? forSupplier : role === 'buyer' ? forBuyer : defaultSteps;

/* initialize three slots */
const topEl    = document.getElementById('card-top');
const mainEl   = document.getElementById('card-main');
const bottomEl = document.getElementById('card-bottom');

let queue = stepsSource.map(([t,m]) => ({title:t, meta:m}));
if(queue.length < 3){ queue = queue.concat(queue).slice(0,3); }
renderCard(topEl,    queue[0].title, queue[0].meta, 'done');
renderCard(mainEl,   queue[1].title, queue[1].meta, 'active');
renderCard(bottomEl, queue[2].title, queue[2].meta, 'pending');

function rotateOnce(nextTask){
  renderCard(topEl, mainEl.querySelector('.title').textContent, mainEl.querySelector('.meta').textContent, 'done');
  renderCard(mainEl, bottomEl.querySelector('.title').textContent, bottomEl.querySelector('.meta').textContent, 'active');
  renderCard(bottomEl, nextTask.title, nextTask.meta, 'pending');
  sr(mainEl.querySelector('.title').textContent + '…');
}

/* ===================== Session & routing ===================== */
async function getSession(){
  try{
    const r = await fetch(ENDPOINTS.session, { credentials:'include', cache:'no-store' });
    if(!r.ok) throw new Error('bad session');
    const j = await r.json();
    return { ok:true, ...j }; // {authenticated, plan}
  }catch(_){
    return { ok:false, authenticated:false, plan:null };
  }
}

function decideDestination(session){
  // Priority 1: an explicit next= path
  if (nextSafe) return nextSafe;

  // Default: go to Step 3 (post-verify setup)
  const url = new URL(ENDPOINTS.step3, location.origin);
  if (email) url.searchParams.set('email', email);
  if (site)  url.searchParams.set('site', site);
  if (role)  url.searchParams.set('role', role);
  return url.pathname + url.search;
}

/* ===================== API helpers (shared with step-3 style) ===================== */
function getApiBase(){
  const meta = document.querySelector('meta[name="api-base"]')?.content || "";
  const v = localStorage.getItem(LS.apiBase) || meta || "";
  return (v||"").trim().replace(/\/+$/,"");
}
function setApiBase(raw){
  const v = (raw||"").trim().replace(/\/+$/,"");
  if (v) try{ localStorage.setItem(LS.apiBase, v);}catch{}
}
function ensureApi(){
  let base = getApiBase();
  if (!base) {
    const v = prompt("API base (with or without /api). Example:\nhttps://YOUR-SUBDOMAIN.code.run/api","")||"";
    if (v) { setApiBase(v); base = getApiBase(); }
  }
  return base;
}
function join(b,t){ return b.replace(/\/+$/,"") + "/" + String(t).replace(/^\/+/,""); }

async function fetchClassify(host){
  const base = ensureApi(); if (!base) return null;
  const u1 = new URL(join(base,"/classify")); u1.searchParams.set("host", host); u1.searchParams.set("maxPages","8");
  const u2 = new URL(join(base.replace(/\/api\/?$/i,""),"/api/classify")); u2.searchParams.set("host", host); u2.searchParams.set("maxPages","8");
  const tryFetch = async (url)=>{
    try{
      const r = await fetch(url, {credentials:"omit"});
      const t = await r.text();
      try{ return JSON.parse(t); }catch{ return {ok:false, error:"bad_json", raw:t}; }
    }catch{
      return {ok:false, error:"network"};
    }
  };
  let d = await tryFetch(u1.toString());
  if (!d?.ok) d = await tryFetch(u2.toString());
  return d;
}

/* ===================== Validations & crawl checks ===================== */
/* Simple reachability probe for site */
function imgReachable(host, timeoutMs=3500){
  return new Promise((resolve)=>{
    if(!host) return resolve(false);
    const img = new Image();
    let done = false;
    const url = 'https://' + host + '/favicon.ico?__ping=' + Date.now();
    const timer = setTimeout(()=>{ if(!done){ done=true; resolve(false); } }, timeoutMs);
    img.onload = ()=>{ if(!done){ done=true; clearTimeout(timer); resolve(true); } };
    img.onerror= ()=>{ if(!done){ done=true; clearTimeout(timer); resolve(true); } }; // error still means host responded
    img.referrerPolicy = 'no-referrer';
    img.src = url;
  });
}

async function runValidations(){
  const hostFromSite  = (site || '').toLowerCase();
  const hostFromEmail = emailHost;

  if (email && !isBusinessEmailHost(hostFromEmail)) {
    const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
    bounce(backTo, 'personal_email', 'Use a work email (Gmail/Outlook/Yahoo are not allowed).');
    return false;
  }

  if (hostFromSite && hostFromEmail && baseDomain(hostFromSite) !== baseDomain(hostFromEmail)) {
    const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
    bounce(backTo, 'domain_mismatch', `Your email domain (${baseDomain(hostFromEmail)}) doesn’t match the website (${baseDomain(hostFromSite)}).`);
    return false;
  }

  const guessSite = hostFromSite || hostFromEmail || '';
  if (!guessSite) {
    const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
    bounce(backTo, 'no_site', 'Add your company website (work email or site).');
    return false;
  }

  const reachable = await imgReachable(guessSite);
  if(!reachable){
    const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
    bounce(backTo, 'site_unreachable', 'We couldn’t reach that site. Check that it’s public and spelled correctly.');
    return false;
  }
  return true;
}

/* ===================== Confirm identity UI ===================== */
const actDefault = document.getElementById('actDefault');
const actConfirm = document.getElementById('actConfirm');
const yesBtn = document.getElementById('yesBtn');
const noBtn  = document.getElementById('noBtn');

function showConfirmCard(payload){
  // payload: { host, favicon?, summary? }
  const host = (payload?.host || site || '').replace(/^www\./,'');
  const fav  = payload?.favicon || ('https://' + host + '/favicon.ico');
  const summary = (payload?.summary || '').trim();
  const line = summary || `We found ${host}.`;

  // Promote the main card to a confirmation card (no CSS changes, reuse .card structure)
  mainEl.className = mainEl.className.replace(/\bis-(active|pending|done)\b/g,'').trim();
  mainEl.classList.add('card','slot-main','is-active');
  mainEl.innerHTML = `
    <div class="ic" aria-hidden="true">
      <img alt="" src="${fav}" style="width:20px;height:20px;border-radius:4px;object-fit:cover" onerror="this.style.display='none'"/>
    </div>
    <div>
      <div class="title">Is this your company?</div>
      <div class="meta">${line}</div>
    </div>
  `;

  actDefault.style.display = 'none';
  actConfirm.style.display = 'flex';
}

function rejectToSignup(code, msg){
  const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
  bounce(backTo, code, msg);
}

/* ===================== Flow ===================== */
async function runSessionAndRoute(){
  // Session fetch + light rotor while waiting
  const sessionPromise = getSession();
  let session = null, sessionResolved = false;
  const sessionTimer = sessionPromise.then(s => { sessionResolved = true; session = s; });

  // Small animation dwell to keep experience smooth
  let spent = 0, p = 2;
  async function spinWindow(msMin, msMax){
    const until = Math.floor(msMin + Math.random()*(msMax-msMin));
    while(spent < until - 600){
      const dwell = Math.floor(1500 + Math.random()*900);
      p = (p + 1) % queue.length;
      rotateOnce(queue[p]);
      await new Promise(r=>setTimeout(r, dwell));
      spent += dwell;
      if (sessionResolved) break;
    }
  }
  await spinWindow(1200, 2200);
  if(!sessionResolved){
    await spinWindow(Number(getComputedStyle(document.documentElement).getPropertyValue('--fallback-min'))|0,
                     Number(getComputedStyle(document.documentElement).getPropertyValue('--fallback-max'))|0);
  }
  if(!sessionResolved){ session = await sessionPromise; }

  rotateOnce({title:'Creating your workspace', meta:'Final checks'});
  await new Promise(r=>setTimeout(r, 420));

  if(!session || session.ok === false){
    rejectToSignup('not_authenticated', 'We couldn’t confirm your sign-in. Please try again.');
    return;
  }
  if(!session.authenticated){
    const msg = (from==='password' || from==='google')
      ? 'Almost there—complete sign-in or verification to continue.'
      : 'We couldn’t confirm your sign-in. Please try again.';
    rejectToSignup('not_authenticated', msg);
    return;
  }

  const dest = decideDestination(session);
  location.href = dest;
}

async function startFlow(){
  // 1) Fast validations (email/host alignment, reachability)
  const ok = await runValidations();
  if (!ok) return;

  // 2) Quick classify to detect redirects/robots & collect a friendly summary
  const host = (site || emailHost || '').toLowerCase();
  let payload = {host: host, favicon: '', summary: ''};
  try{
    const data = await fetchClassify(host);
    if (data && data.ok){
      payload.host = (data.host || host).toLowerCase();
      payload.favicon = data.favicon || '';
      payload.summary = (typeof data.summary === 'string' ? data.summary : '') || '';
      // Reject: redirected to a different base domain (likely competitor or wrong site)
      if (host && payload.host && baseDomain(payload.host) !== baseDomain(host)){
        rejectToSignup('site_redirect_mismatch', `That domain forwards to ${payload.host}. Use your own company website.`);
        return;
      }
      // Optional rejects if server returns structured reasons
      if (data.robotsDenied){ rejectToSignup('robots_blocked','Your robots.txt blocks crawling. Please allow public access.'); return; }
      if (data.crawlError){  rejectToSignup('site_not_readable','We couldn’t read your public pages. Check availability and try again.'); return; }
    }
  }catch(_){ /* fallback to reachability-only */ }

  // 3) Ask: "Is this your company?"
  showConfirmCard(payload);

  // Wire buttons
  yesBtn.onclick = async ()=>{
    actConfirm.style.display = 'none';
    actDefault.style.display = 'flex';
    await runSessionAndRoute();
  };
  noBtn.onclick = ()=>{
    rejectToSignup('not_you', 'Update your business email to point to the right website.');
  };
}

/* Back button */
document.getElementById('backBtn').addEventListener('click', ()=>{
  if (history.length > 1) { history.back(); return; }
  const backTo = pickOrigin()==='login' ? ENDPOINTS.login : ENDPOINTS.signup;
  location.href = backTo + (nextSafe ? ('?next='+encodeURIComponent(nextSafe)) : '');
});

/* Boot */
startFlow();
</script>
</body>
</html>