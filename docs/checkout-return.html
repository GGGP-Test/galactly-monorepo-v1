<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly — Checkout</title>
<style>
  :root{--bg:#0b0f14;--panel:#121822;--divider:#1b2531;--ink:#e9f1f7;--mut:#8aa0b2;--cta:#6de1ff;--ctaText:#082433;--bad:#ff6b6b}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Inter,Arial}
  .wrap{max-width:760px;margin:15vh auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:22px;text-align:center}
  h1{margin:0 0 8px;font-weight:800}
  p{margin:6px 0 14px}
  .mut{color:var(--mut)}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 16px;border-radius:12px;border:1px solid var(--divider);background:#152333;color:#cfe0ee;text-decoration:none;cursor:pointer}
  .btn.primary{background:var(--cta);border:none;color:var(--ctaText);font-weight:800}
  .err{color:var(--bad)}
  code{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Finishing up…</h1>
    <p id="msg" class="mut">Verifying your checkout session.</p>
    <div class="row">
      <a class="btn" href="free-panel.html">Go to Dashboard</a>
      <a id="manage" class="btn" href="manage-billing.html" style="display:none">Manage Billing</a>
      <a id="retry" class="btn" href="#" style="display:none">Retry</a>
    </div>
    <p id="detail" class="mut" style="margin-top:10px"></p>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const qs = Object.fromEntries(new URLSearchParams(location.search).entries());
  const sessionId = qs.session_id || "";
  const canceled = "canceled" in qs || qs.canceled === "1";
  const success  = "success"  in qs || qs.success  === "1";

  function apiBase(){
    const raw = localStorage.getItem("apiBase")||"";
    let b = raw.trim().replace(/\/+$/,"");
    const m=b.match(/^(.*?)(?:\/api(?:\/.*)?)$/i); if(m) b=m[1];
    return (b? b : location.origin) + "/api";
  }

  async function verify(){
    $("#retry").style.display="none";
    $("#title").textContent = "Finishing up…";
    $("#msg").textContent = "Verifying your checkout session.";
    $("#detail").textContent = "";

    const base = apiBase();
    const headers = {"Content-Type":"application/json"};
    const email = localStorage.getItem("fp.user.email")||localStorage.getItem("x-user-email")||"";
    if (email) headers["x-user-email"] = email;

    // prefer /v1/onboard/verify; fallback to /events/checkout/verify
    async function tryVerify(url){
      try{
        const r = await fetch(url, {method:"POST", headers, body: JSON.stringify({ session_id: sessionId })});
        if (!r.ok) return null;
        return await r.json();
      }catch{ return null; }
    }

    const u1 = `${base}/v1/onboard/verify${sessionId?`?session_id=${encodeURIComponent(sessionId)}`:""}`;
    const u2 = `${base}/events/checkout/verify${sessionId?`?session_id=${encodeURIComponent(sessionId)}`:""}`;
    let data = await tryVerify(u1); if(!data) data = await tryVerify(u2);

    // Interpret result
    if (data && data.ok !== false){
      const plan  = data.plan || data.tier || data.status || (success? "pro" : "free");
      const em    = data.email || email || "";
      if (em) localStorage.setItem("fp.user.email", em);
      if (plan) localStorage.setItem("x-user-plan", plan);

      $("#title").textContent = success ? "Welcome aboard!" : (canceled ? "Checkout canceled" : "Updated");
      $("#msg").textContent   = success
        ? `You’re on plan: ${plan.toUpperCase()}.`
        : (canceled ? "No charges were made." : `Your plan is: ${plan.toUpperCase()}.`);
      $("#manage").style.display = "inline-flex";
      $("#detail").textContent = data.message || "";
      return;
    }

    // If backend doesn’t expose a verifier, still show a sane outcome
    if (success){
      $("#title").textContent = "Success";
      $("#msg").textContent = "Your payment succeeded. You can manage billing or go to the dashboard.";
      $("#manage").style.display = "inline-flex";
      return;
    }
    if (canceled){
      $("#title").textContent = "Checkout canceled";
      $("#msg").textContent = "No charges occurred. You can try again anytime.";
      return;
    }

    $("#title").textContent = "We couldn’t verify the session";
    $("#msg").innerHTML = "Your backend did not respond to <code>/api/v1/onboard/verify</code> or <code>/api/events/checkout/verify</code>.";
    $("#detail").textContent = "Add one of these endpoints, or keep this page as a soft landing.";
    $("#retry").style.display="inline-flex";
  }

  $("#retry").onclick = (e)=>{ e.preventDefault(); verify(); };
  verify();
})();
</script>
</body>
</html>