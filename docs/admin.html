<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin / Monitor â€” Artemis BV1</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0f14;color:#e9f1f7;font:14px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #15202b;background:#0e141b}
  h1{font-size:16px;margin:0}
  .muted{color:#9ab0c0}
  main{padding:18px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  .card{background:#121822;border:1px solid #1c2532;border-radius:12px;padding:12px}
  input,button{border-radius:10px;border:1px solid #223042;background:#0d1520;color:#e9f1f7}
  input{padding:10px;width:100%}
  input[type="password"]{letter-spacing:0.1em}
  button{padding:10px 14px;border:0;background:#6de1ff;color:#082433;font-weight:700;cursor:pointer}
  .btn{margin-left:8px}
  .row{display:grid;gap:10px}
  .log{font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;height:280px;overflow:auto;background:#0d1520;border-radius:10px;border:1px solid #223042;padding:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  dl{display:grid;grid-template-columns:max-content 1fr;gap:6px 14px;margin:0}
  dt{color:#9ab0c0}
  .switch{display:flex;align-items:center;gap:8px}
  .small{font-size:12px}
  .rowcols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .inline{display:flex;gap:8px;align-items:center}
  .pill{font:11px;padding:4px 8px;border-radius:999px;background:#0d1520;border:1px solid #223042}
</style>
</head>
<body>
  <header>
    <h1>Admin / Monitor <span class="muted" id="sseNote">SSE: error</span></h1>
    <div>
      <button class="btn" id="btnPing">Ping</button>
      <button class="btn" id="btnHealth">Health</button>
      <button class="btn" id="btnReload">Reload catalog</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="gap:8px">
        <label class="muted small">Base</label>
        <input id="base" placeholder="https://YOUR.code.run/api">
        <div class="rowcols">
          <button id="save">Save</button>
          <button id="test" class="btn">Test</button>
        </div>
      </div>

      <div class="row" style="gap:8px;margin-top:14px">
        <div class="inline">
          <label class="muted small">Admin key</label>
          <span class="pill muted small">sent as <code>x-admin-key</code></span>
        </div>
        <input id="adminKey" type="password" placeholder="paste your admin key">
        <div class="rowcols">
          <button id="saveKey">Save key</button>
          <button id="clearKey" class="btn">Clear</button>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <label class="muted small">Find buyers</label>
        <input id="host" placeholder="yourcompany.com">
        <input id="city" placeholder="e.g., San Diego">
        <button id="find" class="btn">Find buyers</button>
      </div>

      <div class="row" style="margin-top:16px">
        <label class="muted small">Prefs</label>
        <button id="applyPrefs">Apply demo prefs</button>
        <div class="muted small">Upserts prefs for the Host above (requires admin key).</div>
      </div>

      <div class="row" style="margin-top:16px">
        <label class="muted small">Options</label>
        <label class="switch"><input type="checkbox" id="autoscroll" checked> <span class="small muted">Auto-scroll logs</span></label>
      </div>
    </section>

    <section class="card">
      <div class="log" id="log"></div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <div class="grid2">
        <div>
          <div class="muted small" style="margin-bottom:8px">LAST HEALTH SNAPSHOT</div>
          <dl id="healthDl">
            <dt>service</dt><dd>-</dd>
            <dt>uptimeSec</dt><dd>-</dd>
            <dt>allowTiers</dt><dd>-</dd>
            <dt>catalog.total</dt><dd>-</dd>
            <dt>catalog.byTier</dt><dd>-</dd>
            <dt>now</dt><dd>-</dd>
          </dl>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const logEl = $("#log");
  const healthDl = $("#healthDl");

  // ---- Base & Admin key handling ----
  const DEFAULT_BASE = "https://p01--animated-cellar--vz4ftkwrzdfs.code.run/api";
  function getBase(){
    const v = (localStorage.getItem("apiBase") || DEFAULT_BASE).trim();
    return v.replace(/\/+$/,"");
  }
  function setBase(v){
    const val = (v||"").trim().replace(/\/+$/,"");
    localStorage.setItem("apiBase", val);
    $("#base").value = val;
  }
  function getKey(){ return (localStorage.getItem("adminKey") || "").trim(); }
  function setKey(v){ localStorage.setItem("adminKey", (v||"").trim()); $("#adminKey").value = (v||"").trim(); }
  $("#base").value = getBase();
  $("#adminKey").value = getKey();

  // ---- tiny helpers ----
  function say(s){
    const t = `[${new Date().toTimeString().slice(0,8)}] ${s}\n`;
    logEl.textContent += t;
    if ($("#autoscroll").checked) logEl.scrollTop = logEl.scrollHeight;
  }
  function adminHeaders(){
    const h = { "Content-Type":"application/json" };
    const k = getKey();
    if (k) (h)["x-admin-key"] = k;
    return h;
  }
  async function hit(method, path, body, withKey=false){
    const url = getBase() + path;
    const init = { method, headers: withKey ? adminHeaders() : { "Content-Type":"application/json" } };
    if (body) init.body = JSON.stringify(body);
    try{
      const r = await fetch(url, init);
      const txt = await r.text();
      let data = txt;
      try { data = JSON.parse(txt); } catch {}
      return { ok:r.ok, status:r.status, data, url };
    }catch(e){
      return { ok:false, status:0, data:String(e), url };
    }
  }
  function setHealth(h){
    const map = {
      service: h?.service, uptimeSec: h?.uptimeSec, allowTiers: h?.env?.allowTiers ?? h?.allowTiers,
      "catalog.total": h?.catalog?.total, "catalog.byTier": JSON.stringify(h?.catalog?.byTier ?? {}),
      now: h?.now
    };
    healthDl.innerHTML = Object.entries(map).map(([k,v])=>(
      `<dt>${k}</dt><dd>${(v===undefined||v===null)?'-':String(v)}</dd>`
    )).join("");
  }

  // ---- UI actions ----
  $("#save").onclick = ()=>{ setBase($("#base").value); say("API base saved."); };
  $("#test").onclick = async ()=>{
    const r = await hit("GET","/ping");
    say(`Test: /ping -> ${r.status}`);
  };
  $("#saveKey").onclick = ()=>{ setKey($("#adminKey").value); say("Admin key saved locally."); };
  $("#clearKey").onclick = ()=>{ setKey(""); say("Admin key cleared."); };

  $("#btnPing").onclick = async ()=>{
    const r = await hit("GET","/ping");
    say(`Ping -> ${r.status}`);
  };
  $("#btnHealth").onclick = async ()=>{
    const r = await hit("GET","/health");
    say(`Health -> ${r.status}`);
    if (r.ok && r.data) setHealth(r.data);
  };
  $("#btnReload").onclick = async ()=>{
    // (optionally protected later) send key just in case
    const r = await hit("POST","/catalog/reload",{}, true);
    say(`Reload -> ${r.status}`);
    if (!r.ok && r.data) say(JSON.stringify(r.data,null,2));
  };

  $("#find").onclick = async ()=>{
    const host = ($("#host").value||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
    const city = ($("#city").value||"").trim();
    if(!host){ say("Find: missing host"); return; }
    const q = new URLSearchParams({ host }); if(city) q.set("city",city);
    const r = await hit("GET","/leads/find-buyers?"+q.toString());
    say(`Find buyers -> ${r.status}`);
    if (r.ok) say(JSON.stringify(r.data, null, 2));
  };

  $("#applyPrefs").onclick = async ()=>{
    const host = ($("#host").value||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
    if(!host){ say("Prefs: set Host first"); return; }
    const demo = {
      host,
      city:"San Diego",
      general:{ mids:true, near:true, ecommerce:false, retail:true, wholesale:true },
      likeTags:["film","labels","food","beverage"],
      preferSmallMid:true,
      sizeWeight:{ micro:1.2, small:1.0, mid:0.6, large:-1.2 },
      signalWeight:{ local:1.6, ecommerce:0.1, retail:0.35, wholesale:0.35 },
      inboundOptIn:true
    };
    const r = await hit("POST","/prefs/upsert", demo, true /* send x-admin-key */);
    say(`Prefs upsert -> ${r.status}`);
    if (!r.ok && r.data) say(JSON.stringify(r.data,null,2));
  };

  // initial health poll
  (async ()=>{
    const r = await hit("GET","/health");
    say(`Health -> ${r.status}${r.ok && r.data?.catalog?` (catalog.total=${r.data.catalog.total})`:""}`);
    if (r.ok) setHealth(r.data);
  })();

  // light periodic health poll
  setInterval(async ()=>{
    const r = await hit("GET","/health");
    if (r.ok && r.data) setHealth(r.data);
  }, 30000);
})();
</script>
</body>
</html>