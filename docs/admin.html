<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin / Live — Artemis BV1</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0f14;color:#e9f1f7;font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #15202b;background:#0e141b}
  h1{font-size:16px;margin:0}
  .muted{color:#9ab0c0}
  main{padding:18px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  .card{background:#121822;border:1px solid #1c2532;border-radius:12px;padding:12px}
  input,button,select{border-radius:10px;border:1px solid #223042;background:#0d1520;color:#e9f1f7}
  input,select{padding:10px;width:100%}
  input[type="password"]{letter-spacing:0.08em}
  button{padding:10px 14px;border:0;background:#6de1ff;color:#082433;font-weight:700;cursor:pointer}
  .btn{margin-left:8px}
  .row{display:grid;gap:10px}
  .rowcols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px}
  .pill{font:11px;padding:4px 8px;border-radius:999px;background:#0d1520;border:1px solid #223042}
  .log{font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;height:360px;overflow:auto;background:#0d1520;border-radius:10px;border:1px solid #223042;padding:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{font-size:12px;color:#9ab0c0}
</style>
</head>
<body>
  <header>
    <h1>Admin / Live <span class="muted" id="sseNote">disconnected</span></h1>
    <div>
      <button class="btn" id="btnPing">Ping</button>
      <button class="btn" id="btnHealth">Health</button>
      <button class="btn" id="btnReload">Reload catalog</button>
    </div>
  </header>

  <main>
    <!-- LEFT -->
    <section class="card">
      <div class="row" style="gap:8px">
        <label>API Base</label>
        <input id="base" placeholder="https://YOUR.code.run/api">
        <div class="rowcols">
          <button id="save">Save</button>
          <button id="test" class="btn">Test</button>
        </div>
      </div>

      <div class="row" style="gap:8px;margin-top:14px">
        <div class="inline">
          <label>Admin auth</label>
          <span class="pill muted small">sent as <code id="hdrLabel">x-admin-key</code></span>
        </div>
        <div class="rowcols">
          <select id="adminHeader">
            <option value="x-admin-key">x-admin-key</option>
            <option value="x-admin-token">x-admin-token</option>
          </select>
          <input id="adminKey" type="password" placeholder="paste your admin key">
        </div>
        <div class="rowcols">
          <button id="saveKey">Save key</button>
          <button id="clearKey" class="btn">Clear</button>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <label>Find buyers</label>
        <input id="host" placeholder="yourcompany.com">
        <input id="city" placeholder="e.g., San Diego">

        <div class="rowcols">
          <div>
            <label>Source</label>
            <select id="source">
              <option value="web" selected>Web (live)</option>
              <option value="catalog">Catalog (fallback)</option>
            </select>
          </div>
          <div>
            <label>Limit</label>
            <input id="limit" type="number" min="1" max="100" value="24">
          </div>
        </div>

        <div class="rowcols">
          <div>
            <label>Company size</label>
            <select id="sizePref">
              <option value="small" selected>Small (Tier C)</option>
              <option value="medium">Medium (Tier B)</option>
              <option value="large">Large (Tier A)</option>
            </select>
          </div>
          <div>
            <label>Band (exact)</label>
            <select id="band">
              <option value="COOL">COOL</option>
              <option value="WARM" selected>WARM</option>
              <option value="HOT">HOT</option>
            </select>
          </div>
        </div>

        <button id="find" class="btn">Find buyers</button>
      </div>

      <div class="row" style="margin-top:16px">
        <label>Prefs</label>
        <button id="applyPrefs">Apply demo prefs</button>
        <div class="muted small">Upserts prefs for the Host above (requires admin key).</div>
      </div>

      <div class="row" style="margin-top:16px">
        <label>Events</label>
        <div class="rowcols">
          <button id="evStats">Stats (snapshot)</button>
          <button id="evRecent" class="btn">Recent (50)</button>
        </div>
        <div class="rowcols" style="margin-top:8px">
          <button id="evStart">Start stream</button>
          <button id="evStop" class="btn">Stop stream</button>
        </div>
        <div class="rowcols" style="margin-top:8px">
          <button id="evTest2">Send test event</button>
          <button id="evExport" class="btn">Export CSV</button>
        </div>
        <div class="muted small">SSE auto-reconnects and sends a 20-event backlog.</div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="log" id="log"></div>
    </section>

    <!-- HEALTH + EVENTS -->
    <section class="card" style="grid-column:1 / -1">
      <div class="grid2">
        <div>
          <div class="muted small" style="margin-bottom:8px">LAST HEALTH SNAPSHOT</div>
          <dl id="healthDl">
            <dt>service</dt><dd>-</dd>
            <dt>uptimeSec</dt><dd>-</dd>
            <dt>allowTiers</dt><dd>-</dd>
            <dt>catalog.total</dt><dd>-</dd>
            <dt>catalog.byTier</dt><dd>-</dd>
            <dt>now</dt><dd>-</dd>
          </dl>
        </div>
        <div>
          <div class="muted small" style="margin-bottom:8px">EVENTS SNAPSHOT</div>
          <dl id="eventsDl">
            <dt>buffered</dt><dd>-</dd>
            <dt>byType24h</dt><dd>-</dd>
            <dt>topPaths24h</dt><dd>-</dd>
            <dt>since</dt><dd>-</dd>
          </dl>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  const $  = (s)=>document.querySelector(s);
  const logEl = $("#log");
  const sseNote = $("#sseNote");
  const healthDl = $("#healthDl");
  const eventsDl = $("#eventsDl");

  // ---- Local storage helpers ----
  const DEFAULT_BASE = (location.origin + "/api");
  const LS = { base:"apiBase", adminKey:"adminKey", adminHeader:"adminHeader", source:"leadSource" };
  function getBase(){ return (localStorage.getItem(LS.base) || DEFAULT_BASE).trim().replace(/\/+$/,""); }
  function setBase(v){ const val=(v||"").trim().replace(/\/+$/,""); localStorage.setItem(LS.base,val); $("#base").value=val; }
  function getKey(){ return (localStorage.getItem(LS.adminKey) || "").trim(); }
  function setKey(v){ localStorage.setItem(LS.adminKey,(v||"").trim()); $("#adminKey").value=(v||"").trim(); }
  function getHeader(){ return (localStorage.getItem(LS.adminHeader) || "x-admin-key").trim(); }
  function setHeader(v){ localStorage.setItem(LS.adminHeader,(v||"x-admin-key").trim()); $("#adminHeader").value=getHeader(); $("#hdrLabel").textContent=getHeader(); }
  function getSource(){ return (localStorage.getItem(LS.source) || "web"); }
  function setSource(v){ localStorage.setItem(LS.source,v||"web"); $("#source").value=getSource(); }

  // Init inputs
  $("#base").value = getBase();
  $("#adminKey").value = getKey();
  $("#adminHeader").value = getHeader();
  $("#hdrLabel").textContent = getHeader();
  $("#source").value = getSource();

  // ---- UI utils ----
  function say(s){
    const t = `[${new Date().toTimeString().slice(0,8)}] ${s}\n`;
    logEl.textContent += t;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function adminHeaders(){
    const h = {"Content-Type":"application/json"};
    const k = getKey();
    const n = getHeader();
    if (k) h[n] = k;
    return h;
  }
  async function hit(method, path, body, withKey=false){
    const url = getBase() + path;
    const init = { method, headers: withKey ? adminHeaders() : { "Content-Type":"application/json" } };
    if (body) init.body = JSON.stringify(body);
    try {
      const r = await fetch(url, init);
      const txt = await r.text();
      try { return { ok:r.ok, status:r.status, data: JSON.parse(txt), url }; }
      catch { return { ok:r.ok, status:r.status, data: txt, url }; }
    } catch(e){ return { ok:false, status:0, data:String(e), url }; }
  }
  function setHealth(h){
    const map = {
      service: h?.service, uptimeSec: h?.uptimeSec, allowTiers: h?.env?.allowTiers ?? h?.allowTiers,
      "catalog.total": h?.catalog?.total, "catalog.byTier": JSON.stringify(h?.catalog?.byTier ?? {}),
      now: h?.now
    };
    healthDl.innerHTML = Object.entries(map).map(([k,v])=>`<dt>${k}</dt><dd>${v==null?'-':String(v)}</dd>`).join("");
  }
  function setEvents(e){
    const map = {
      buffered: e?.total ?? e?.buffered ?? "-",
      byType24h: e?.byType24h ? JSON.stringify(e.byType24h) : "-",
      topPaths24h: e?.topPaths24h ? JSON.stringify(e.topPaths24h.slice(0,5)) : "-",
      since: e?.sinceIso || "-"
    };
    eventsDl.innerHTML = Object.entries(map).map(([k,v])=>`<dt>${k}</dt><dd>${v==null?'-':String(v)}</dd>`).join("");
  }

  // ---- SSE ----
  let es = null;
  let lastTs = 0;
  function streamUrl(){ return `${getBase()}/events/stream?since=${lastTs||0}`; }
  function startStream(){
    try { stopStream(); } catch {}
    const url = streamUrl();
    es = new EventSource(url, { withCredentials:false });
    sseNote.textContent = "connecting…";
    es.addEventListener("ping", ()=>{ sseNote.textContent = "connected"; });
    es.addEventListener("event", (ev)=>{
      try{
        const data = JSON.parse(ev.data);
        lastTs = Math.max(lastTs, Number(data.ts||0));
        say(`EVENT ${data.type || "-"} :: ${data.path || ""} :: ${data.user || ""}`);
      }catch{}
    });
    es.onerror = ()=>{ sseNote.textContent = "reconnecting…"; };
    es.onopen = ()=>{ sseNote.textContent = "connected"; };
  }
  function stopStream(){ if (es) try{es.close();}catch{} es=null; sseNote.textContent="stopped"; }

  // ---- Find buyers wiring (web-first, exact band) ----
  const SIZE_TO_TIER = { small:"C", medium:"B", large:"A", s:"C", m:"B", l:"A" };

  function buildWebUrl(){
    const host = ($("#host").value||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
    const city = ($("#city").value||"").trim();
    const size = ($("#sizePref").value||"small").toLowerCase();
    const band = ($("#band").value||"WARM").toUpperCase();
    const limit = Math.max(1, Number($("#limit").value||24)) || 24;
    const u = new URL(`${getBase()}/web/find`);
    if (host) u.searchParams.set("host", host);
    if (city) u.searchParams.set("city", city);
    u.searchParams.set("size", size);
    u.searchParams.set("limit", String(limit));
    // server may ignore this today; we filter exact on client anyway
    u.searchParams.set("band", band);
    return u.toString();
  }

  function buildCatalogUrl(){
    const host = ($("#host").value||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
    const city = ($("#city").value||"").trim();
    const size = ($("#sizePref").value||"small").toLowerCase();
    const band = ($("#band").value||"WARM").toUpperCase();
    const preferTier = SIZE_TO_TIER[size] || "C";
    const tiers = preferTier; // hard filter to chosen size
    const u = new URL(`${getBase()}/leads/find-buyers`);
    if (host) u.searchParams.set("host", host);
    if (city) u.searchParams.set("city", city);
    u.searchParams.set("tiers", tiers);
    u.searchParams.set("preferTier", preferTier);
    u.searchParams.set("minBand", band); // route is "min"; we’ll exact-filter client-side
    return u.toString();
  }

  async function findBuyers(){
    const source = ($("#source").value||"web");
    const url = source === "web" ? buildWebUrl() : buildCatalogUrl();
    const r = await fetch(url, { headers: adminHeaders() });
    let data=null,status=0,ok=false;
    try{ const rr = await r.json(); data=rr; status=r.status; ok=r.ok; } catch{ status=r.status; ok=r.ok; }

    const wantBand = ($("#band").value||"WARM").toUpperCase();
    // Exact band on client (works for both routes)
    if (ok && data && Array.isArray(data.items)) {
      data.items = data.items.filter(x => String(x?.band||"").toUpperCase() === wantBand);
      // Re-tally summary to reflect exact filter
      if (data.summary) {
        data.summary.returned = data.items.length;
        data.summary.hot  = data.items.filter(i=>i.band==="HOT").length;
        data.summary.warm = data.items.filter(i=>i.band==="WARM").length;
        data.summary.cool = data.items.filter(i=>i.band==="COOL").length;
        data.summary.exactBand = wantBand;
        data.summary.source = source;
      }
    }

    say(`Find buyers [${source}] -> ${status}`);
    if (ok && data) say(JSON.stringify(data,null,2));
    else if (!ok) say("Find buyers failed.");
  }

  // ---- Actions ----
  $("#save").onclick    = ()=>{ setBase($("#base").value); say("API base saved."); };
  $("#test").onclick    = async()=>{ const r=await hit("GET","/ping"); say(`Test: /ping -> ${r.status}`); };

  $("#adminHeader").onchange = ()=> setHeader($("#adminHeader").value);
  $("#source").onchange = ()=> setSource($("#source").value);

  $("#saveKey").onclick = ()=>{ setHeader($("#adminHeader").value); setKey($("#adminKey").value); say("Admin header+key saved locally."); };
  $("#clearKey").onclick= ()=>{ setKey(""); say("Admin key cleared."); };

  $("#btnPing").onclick   = async()=>{ const r=await hit("GET","/ping"); say(`Ping -> ${r.status}`); };
  $("#btnHealth").onclick = async()=>{ const r=await hit("GET","/health"); say(`Health -> ${r.status}`); if(r.ok&&r.data) setHealth(r.data); };
  $("#btnReload").onclick = async()=>{ const r=await hit("POST","/catalog/reload",{}, true); say(`Reload -> ${r.status}`); if(!r.ok&&r.data) say(JSON.stringify(r.data,null,2)); };

  $("#find").onclick = findBuyers;

  $("#applyPrefs").onclick = async ()=>{
    const host = ($("#host").value||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
    if(!host){ say("Prefs: set Host first"); return; }
    const demo = {
      host, city:"San Diego",
      general:{ mids:true, near:true, ecommerce:false, retail:true, wholesale:true },
      likeTags:["film","labels","food","beverage"],
      preferSmallMid:true,
      sizeWeight:{ micro:1.2, small:1.0, mid:0.6, large:-1.2 },
      signalWeight:{ local:1.6, ecommerce:0.1, retail:0.35, wholesale:0.35 },
      inboundOptIn:true
    };
    const r = await hit("POST","/prefs/upsert", demo, true);
    say(`Prefs upsert -> ${r.status}`);
    if (!r.ok && r.data) say(JSON.stringify(r.data,null,2));
  };

  $("#evStats").onclick  = async()=>{ const r=await hit("GET","/events/stats", null, true); say(`Events: stats -> ${r.status}`); if(r.ok){ setEvents(r.data); say(JSON.stringify(r.data,null,2)); } };
  $("#evRecent").onclick = async()=>{ const r=await hit("GET","/events/recent?limit=50", null, true); say(`Events: recent(50) -> ${r.status}`); if(r.ok) say(JSON.stringify(r.data,null,2)); };
  $("#evStart").onclick  = ()=>{ startStream(); say("SSE: start"); };
  $("#evStop").onclick   = ()=>{ stopStream(); say("SSE: stop"); };
  $("#evTest2").onclick  = async()=>{ const r=await hit("POST","/events/ingest",{type:"test_event",user:"admin",data:{hello:"world"}}, true); say(`Events: ingest -> ${r.status}`); };
  $("#evExport").onclick = ()=>{ window.open(getBase()+"/audit/export.csv?limit=2000","_blank"); };

  // initial health + events poll + stream
  (async ()=>{
    const h = await hit("GET","/health");
    if (h.ok) { setHealth(h.data); say(`Health -> ${h.status}`); }
    const e = await hit("GET","/events/stats", null, true);
    if (e.ok) setEvents(e.data);
    startStream();
  })();
})();
</script>
</body>
</html>