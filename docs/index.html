<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly ‚Äî Find real packaging buyers</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel-2:#0e141c;
    --muted:#8aa0b2; --text:#e9f1f7; --brand:#8ae3ff;
    --cta:#6de1ff; --ctaText:#082433; --chip:#1a2433;
    --chipActive:#103247; --accent:#38e08f; --divider:#1b2531; --ring:#24435f;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  .hero{min-height:100vh;display:grid;place-items:center;padding:4rem 1rem;background: radial-gradient(1200px 600px at 50% -200px, #102132 0, transparent 70%); position:relative; z-index:0}
  .hero-inner{max-width:920px;text-align:center}
  h1{font-size:clamp(32px,6vw,56px);margin:0 0 12px}
  p.lead{color:var(--muted);margin:0 0 28px}
  .btn{display:inline-flex;align-items:center;gap:.6rem;padding:12px 18px;border-radius:12px;background:var(--cta);color:var(--ctaText);font-weight:700;border:none;cursor:pointer; position:relative; z-index:2}
  .btn.sec{background:#152333;color:#cfe0ee}
  .btn:active{transform:translateY(1px)}
  .pill{padding:6px 10px;border-radius:999px;background:#0d1a26;color:#8fb0c6;font-size:12px;display:inline-block}
  .modal{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.show{display:flex}
  .card{width:min(980px,92vw);background:var(--panel);border:1px solid var(--divider);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;background:linear-gradient(180deg,#0f1622,#0e1520);border-bottom:1px solid var(--divider)}
  .steps{display:flex;gap:8px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#2a3444}
  .dot.on{background:#5bd0ff}
  .api-badge{font-size:12px;padding:4px 8px;border-radius:10px;border:1px solid var(--divider);color:#a8c3d8}
  .api-badge.ok{color:#0f0}
  .api-badge.err{color:#ff8}
  .card-bd{padding:18px}
  .card-ft{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px;border-top:1px solid var(--divider)}
  .scroll{max-height:70vh;overflow:auto;padding:6px 6px}
  .field{margin:10px 0}
  label{display:block;font-size:13px;color:#9abbcc;margin:0 0 6px}
  input[type=text],input[type=email],input[type=tel]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:#e9f1f7;outline:none}
  input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}
  .summary{display:flex;gap:12px;background:#0e1622;border:1px solid var(--divider);padding:12px 14px;border-radius:14px;margin:0 0 14px;align-items:flex-start}
  .fav{width:24px;height:24px;border-radius:6px;display:grid;place-items:center;overflow:hidden;flex:0 0 auto;background:#fff;border:1px solid #cfd8e3}
  .fav img{width:24px;height:24px;filter:saturate(1.05) contrast(1.05)}
  .one-line{line-height:1.8}
  .token{display:inline-block;border-radius:8px;padding:2px 6px;margin:0 2px}
  .sentence{--bgx:#0f1926}
  .sentence .token[data-editable=true]{background:transparent;border-bottom:1px dashed #3a5572}
  .sentence.editing .token[data-editable=true]{background:var(--bgx);border:1px solid #2b425a}
  .sentence .token:focus{outline:2px solid var(--ring)}
  .edit-actions{display:flex;gap:8px;margin-top:6px}
  .big-edit{padding:6px 10px;border-radius:10px;background:#172839;border:1px solid #274059;color:#d8e8f7;font-weight:600;cursor:pointer}
  .big-edit.primary{background:var(--cta);border:none;color:#06293a}
  .group{background:#0f1724;border:1px solid var(--divider);border-radius:14px;padding:14px;margin:14px 0}
  .group h4{margin:0 0 8px}
  .muted-hint{font-size:12px;color:#99b2c8;margin-left:8px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipActive);color:#eaf7ff;border-color:#1b4862}
  .slider-row{display:grid;grid-template-columns:1fr 280px;gap:16px;align-items:center;margin:10px 0}
  .slider-row input[type=range]{width:100%}
  .x{background:transparent;color:#9fb3c6;border:none;font-size:18px;cursor:pointer}
  .gear{display:none}
  @media (max-width:800px){.slider-row{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <h1>Find real packaging buyers.</h1>
      <p class="lead">Laser-targeted leads, tuned to your strengths.</p>
      <button id="cta" type="button" class="btn"><span>‚ú®</span> Get qualified leads free</button>
    </div>
  </div>
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="card" role="document">
      <div class="card-hd">
        <div class="steps" aria-label="Steps">
          <span class="dot on" data-step-dot="0"></span>
          <span class="dot" data-step-dot="1"></span>
          <span class="dot" data-step-dot="2"></span>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <span id="apiBadge" class="api-badge">API: resolving‚Ä¶</span>
          <button id="close" class="x" aria-label="Close">‚úï</button>
        </div>
      </div>
      <div class="card-bd">
        <div class="scroll">
          <section class="step" id="step1">
            <div class="pill">Get set up in 60 seconds</div>
            <h2 style="margin:10px 0 14px;">Pick your side</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div id="opt-supplier" class="chip active">üôå I sell packaging (Supplier)</div>
                <div id="opt-buyer" class="chip">üõí I buy packaging (Buyer)</div>
              </div>
            </div>
          </section>
          <section class="step" id="step2" hidden>
            <div class="pill">Step 2 of 3</div>
            <h2 style="margin:10px 0 14px;">Tell us who you are</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                <div>
                  <div class="field">
                    <label>Your name</label>
                    <input id="name" type="text" autocomplete="name" placeholder="e.g., Sam Carter">
                  </div>
                  <div class="field">
                    <label>Phone (required for alerts) *</label>
                    <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+1 555 123 4567"/>
                    <div style="color:#9ab0c0;font-size:12px">Country code helps us personalize geography (e.g., ‚Äú+1‚Äù for U.S.).</div>
                  </div>
                </div>
                <div>
                  <div class="field">
                    <label>Business email *</label>
                    <input id="email" type="email" autocomplete="email" placeholder="you@yourcompany.com" required/>
                  </div>
                  <div class="field">
                    <label>Website / Domain (auto from email)</label>
                    <input id="host" type="text" inputmode="url" placeholder="yourcompany.com"/>
                    <div style="color:#9ab0c0;font-size:12px">Auto-filled from your email as you type. You can edit.</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="group" style="display:flex;align-items:center;justify-content:space-between">
              <div id="apiStatus" style="color:#9ab0c0">API: resolving‚Ä¶</div>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input id="skipVerify" type="checkbox" checked> I‚Äôm just testing (skip verification)
              </label>
            </div>
          </section>
          <section class="step" id="step3" hidden>
            <div class="pill">Step 3 of 3</div>
            <div class="summary">
              <div class="fav"><img id="fav" alt="" width="24" height="24" referrerpolicy="no-referrer"></div>
              <div style="flex:1">
                <div id="sentence" class="one-line sentence" aria-live="polite"></div>
                <div class="edit-actions">
                  <button id="editLine" class="big-edit" type="button">Edit</button>
                  <button id="doneLine" class="big-edit primary" type="button" hidden>Done</button>
                  <a id="refresh" href="#" class="big-edit" style="background:#142133;border-color:#25384b;color:#a9c3d8">Refresh from website</a>
                  <span id="status" class="muted-hint"></span>
                </div>
              </div>
            </div>
            <button id="advToggle" class="btn sec" type="button" style="padding:8px 12px;border-radius:999px;margin-bottom:8px">
              <span id="advLbl">Show advanced ‚ñæ</span>
            </button>
            <div id="advanced" hidden>
              <div class="group" id="grp-priorities">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <h4 style="margin:0">Buyer priorities ‚Äî <span style="font-weight:600">top 10% buyers</span></h4>
                  <div class="muted-hint">We weight hot leads by these (0‚Äì10).</div>
                </div>
                <div id="metricsBox"></div>
              </div>
              <div class="group" id="grp-sectors">
                <h4 style="margin:0 0 8px">Sector-specific priorities</h4>
                <div id="sectorBuckets"></div>
              </div>
              <div class="group" id="grp-ops">
                <h4 style="margin:0 0 8px">Buyer operations</h4>
                <div id="opsChips" class="chips"></div>
                <div id="opsSliders"></div>
                <div class="muted-hint">Click to add; each selected operation gets its own importance slider.</div>
              </div>
              <div class="group" id="grp-targeting">
                <h4 style="margin:0 0 8px">Buyer targeting</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                  <div>
                    <label>Find buyers near‚Ä¶</label>
                    <input id="city" type="text" placeholder="e.g., HQ city">
                    <div id="cityChips" class="chips" style="margin-top:6px"></div>
                    <div style="color:#9ab0c0;font-size:12px">We‚Äôll boost leads near this city.</div>
                  </div>
                  <div>
                    <label>Buyers in these sectors</label>
                    <input id="sectors" type="text" placeholder="e.g., food, beverage, logistics">
                    <div id="sectorChips" class="chips" style="margin-top:6px"></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
        <div class="card-ft">
          <button id="back" class="btn sec" type="button">Back</button>
          <button id="next" class="btn" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>
<script>
(()=>{
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const modal   = $("#modal");
  const openBtn = $("#cta");
  const closeBtn= $("#close");
  const backBtn = $("#back");
  const nextBtn = $("#next");
  const dots    = $$("[data-step-dot]");
  const apiBadge= $("#apiBadge");
  const apiStatus=$("#apiStatus");
  const optSupplier = $("#opt-supplier");
  const optBuyer    = $("#opt-buyer");
  const emailEl = $("#email");
  const hostEl  = $("#host");
  const favImg  = $("#fav");
  const sentence= $("#sentence");
  const adv     = $("#advanced");
  const advLbl  = $("#advLbl");
  const editBtn = $("#editLine");
  const doneBtn = $("#doneLine");
  const refreshA= $("#refresh");
  const state = {
    step:0, role:"supplier",
    line:{host:"yourcompany.com",verb:"supplies",products:"packaging",audience:"brands",region:"the U.S.",contacts:"Operations, Procurement"}
  };
  const normHost=h=>(h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*/,"");
  const domainFromEmail=e=>{const m=(e||"").toLowerCase().match(/@([a-z0-9.-]+)/);return m?m[1]:""};
  function setFavicon(host){const h=normHost(host);favImg.src = h?("https://icons.duckduckgo.com/ip3/"+encodeURIComponent(h)+".ico"):"";}
  function show(step){
    state.step=step;
    ["#step1","#step2","#step3"].forEach((id,i)=>{const el=$(id);if(el){el.hidden=i!==step; if(dots[i]) dots[i].classList.toggle("on", i===step);}});
    backBtn.style.visibility= step===0? "hidden":"visible";
    nextBtn.textContent = step===2? "Finish":"Next";
  }
  function open(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); show(0); }
  function close(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); }
  function renderSentence(){
    const L=state.line;
    const parts=[L.host,"‚Äî",L.verb,L.products,"for",L.audience,"in",L.region,".","Best contacts:",L.contacts];
    sentence.innerHTML="";
    for(const t of parts){ const s=document.createElement("span"); s.className="token"; s.textContent=t; sentence.appendChild(s); sentence.appendChild(document.createTextNode(" ")); }
  }
  function setRole(r){ state.role=r; optSupplier.classList.toggle("active", r==="supplier"); optBuyer.classList.toggle("active", r==="buyer"); }
  optSupplier?.addEventListener("click",()=>setRole("supplier"));
  optBuyer?.addEventListener("click",()=>setRole("buyer"));
  openBtn?.addEventListener("click", open);
  closeBtn?.addEventListener("click", close);
  backBtn?.addEventListener("click", ()=> show(Math.max(0, state.step-1)));
  nextBtn?.addEventListener("click", ()=>{
    if (state.step===0){ show(1); return; }
    if (state.step===1){
      const hostCandidate = normHost(hostEl.value || domainFromEmail(emailEl.value));
      if (!emailEl.value || !hostCandidate){ alert("Enter business email and website/domain to continue."); return; }
      state.line.host = hostCandidate; setFavicon(hostCandidate); renderSentence(); show(2); return;
    }
    if (state.step===2){ alert("Finish will be enabled after Part-2 is appended."); }
  });
  document.getElementById("advToggle")?.addEventListener("click",(e)=>{
    e.preventDefault();
    const opened = adv.hasAttribute("hidden");
    if (opened){ adv.removeAttribute("hidden"); advLbl.textContent="Hide advanced ‚ñ≤"; }
    else { adv.setAttribute("hidden",""); advLbl.textContent="Show advanced ‚ñæ"; }
  });
  function syncDomain(){ const d=domainFromEmail(emailEl.value); if (d) hostEl.value=d; }
  emailEl?.addEventListener("input",syncDomain);
  emailEl?.addEventListener("change",syncDomain);
  setTimeout(syncDomain,120);
  (function bootLite(){
    const txt="API: offline (awaiting Part-2)";
    if (apiBadge){ apiBadge.textContent=txt; apiBadge.classList.remove("ok"); apiBadge.classList.add("err"); }
    if (apiStatus){ apiStatus.textContent=txt; }
    setRole("supplier");
    renderSentence();
  })();
  window.Galactly = { refreshFromWebsite:()=>{}, seedTargeting:()=>{}, applyServerPersona:()=>{}, apiDetect:async()=>({ok:false}) };
  // pad 01
/* -------------------- PART 2 (append below pad lines, before the final `})();`) -------------------- */

  // ===== storage helpers =====
  const getS = (k,d="")=>{try{const v=localStorage.getItem(k);return v===null?d:v}catch{return d}};
  const setS = (k,v)=>{try{localStorage.setItem(k,v)}catch{}};

  // ===== elements we didn't bind in Part 1 =====
  const metricsBox        = document.getElementById("metricsBox");
  const sectorBucketsRoot = document.getElementById("sectorBuckets");
  const opsChips          = document.getElementById("opsChips");
  const opsSliders        = document.getElementById("opsSliders");
  const cityEl            = document.getElementById("city");
  const sectorsEl         = document.getElementById("sectors");
  const cityChips         = document.getElementById("cityChips");
  const sectorChips       = document.getElementById("sectorChips");
  const statusEl          = document.getElementById("status");

  // extend state
  state.metrics = [];
  state.opsSelected = new Map();
  state.productTags = [];
  state.sectorHints = [];
  state.sectorMetrics = new Map(); // sector -> [{label,value,hint}]
  state.mutedSectors = new Set();
  state.apiOnline = false;
  state.hq = "";

  // ===== API discovery / classify =====
  async function apiDetect(){
    const candidates = [];
    if (typeof window.API_BASE==="string") candidates.push(String(window.API_BASE));
    const saved = getS("apiBase","");
    if (saved) candidates.push(saved);
    candidates.push(location.origin+"/api", location.origin);

    async function check(base){
      base = (base||"").replace(/\/+$/,"");
      const paths = /\/api$/.test(base) ? [base+"/ping", base+"/health"] : [base+"/api/ping", base+"/api/health"];
      for (const p of paths){
        try{ const r = await fetch(p,{credentials:"omit"}); if (r.ok) return base; }catch{}
      }
      return null;
    }

    for (const c of candidates){
      const ok = await check(c);
      if (ok){
        setS("apiBase", ok);
        const txt="API: online";
        if (apiBadge){ apiBadge.textContent=txt; apiBadge.classList.add("ok"); apiBadge.classList.remove("err"); }
        if (apiStatus){ apiStatus.textContent=txt; }
        state.apiOnline = true;
        return {ok:true, base:ok};
      }
    }
    const fb = (candidates[0]||location.origin+"/api").replace(/\/+$/,"");
    setS("apiBase", fb);
    const txt="API: offline";
    if (apiBadge){ apiBadge.textContent=txt; apiBadge.classList.remove("ok"); apiBadge.classList.add("err"); }
    if (apiStatus){ apiStatus.textContent=txt; }
    state.apiOnline = false;
    return {ok:false, base:fb};
  }

  function classifyURL(base){
    const b=(base||getS("apiBase","")).replace(/\/+$/,"");
    return /\/api$/.test(b) ? (b+"/classify") : (b+"/api/classify");
  }

  async function classify(host, email){
    const api = await apiDetect();
    const u1 = classifyURL(api.base) + "?host="+encodeURIComponent(host)+"&email="+encodeURIComponent(email||"");
    try{
      const r = await fetch(u1,{credentials:"omit"});
      if (!r.ok) throw new Error(String(r.status));
      return await r.json();
    }catch(_){
      const u2 = /\/api\/classify$/.test(u1) ? u1.replace(/\/api\/classify$/,"/classify") : u1.replace(/\/classify$/,"/api/classify");
      const r2 = await fetch(u2,{credentials:"omit"});
      if (!r2.ok) throw new Error(String(r2.status));
      return await r2.json();
    }
  }

  // ===== helper: chip =====
  function addChip(text, box, onToggle){
    const s=document.createElement("span");
    s.className="chip";
    s.textContent=text;
    s.addEventListener("click",()=>{
      const on = !s.classList.contains("active");
      s.classList.toggle("active", on);
      onToggle && onToggle(on, text, s);
    });
    box.appendChild(s);
    return s;
  }

  // ===== metric hints (measurable) =====
  const HINT = {
    "High-speed line compatibility":"0=manual/slow only ¬∑ 10=proven at ‚â•500+ units/min (or ‚â•30 cases/min)",
    "Retail-ready print consistency":"0=frequent color drift/misregister ¬∑ 10=ŒîE<2 and tight register at volume",
    "Condensation tolerance":"0=package fails with light sweat ¬∑ 10=survives heavy condensation (coolers/retort)",
    "Case integrity for glass/plastic":"0=frequent breakage/deformation ¬∑ 10=spec holds at peak load/transport",
    "Pallet stability for bottlers":"0=shifts/collapses ¬∑ 10=stable to ISTA 3A/3E or in-house equivalent",
    "Damage reduction targets in transit":"0=no target ¬∑ 10=meets ‚â§0.5% damage KPI",
    "Automation line uptime impact":"0=frequent jams/changeover issues ¬∑ 10=near-zero stops from packaging",
    "Unit cost at target MOQ":"0=not competitive ¬∑ 10=meets/better than target at MOQ",
    "Sustainability targets (PCR %, recyclability)":"0=not required ¬∑ 10=mandatory PCR%/recyclability label",
    "Vendor-managed inventory flexibility":"0=none ¬∑ 10=VMI with safety stock & kanban"
  };

  // ===== render global metrics =====
  function renderMetrics(labels){
    metricsBox.innerHTML="";
    state.metrics = (labels||[]).slice(0,16).map(l=>{
      const label = typeof l==="string" ? l : (l.label||"Metric");
      const hint  = (typeof l==="object" && l.hint) || HINT[label] || "";
      return {label, value:7, hint};
    });

    for (const m of state.metrics){
      const row=document.createElement("div"); row.className="slider-row";
      const lab=document.createElement("div");
      lab.textContent=m.label;
      if (m.hint){ const hintEl=document.createElement("div"); hintEl.className="muted-hint"; hintEl.textContent=m.hint; lab.appendChild(document.createElement("br")); lab.appendChild(hintEl); }
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=m.value;
      input.addEventListener("input",()=>{ m.value=Number(input.value); });
      row.appendChild(lab); row.appendChild(input);
      metricsBox.appendChild(row);
    }
  }

  // ===== sector catalog with measurable defaults =====
  const SECTOR_METRICS = {
    beverage: [
      {label:"High-speed line compatibility",hint:HINT["High-speed line compatibility"]},
      {label:"Retail-ready print consistency",hint:HINT["Retail-ready print consistency"]},
      {label:"Condensation tolerance",hint:HINT["Condensation tolerance"]},
      {label:"Pallet stability for bottlers",hint:HINT["Pallet stability for bottlers"]},
      {label:"Case integrity for glass/plastic",hint:HINT["Case integrity for glass/plastic"]},
      {label:"Damage reduction targets in transit",hint:HINT["Damage reduction targets in transit"]}
    ],
    food: [
      {label:"Food-contact compliance (FDA/EC)",hint:"0=no requirement ¬∑ 10=strict compliance + COA every lot"},
      {label:"Moisture barrier requirements",hint:"0=none ¬∑ 10=mvtr ‚â§ spec across environments"},
      {label:"Oxygen barrier requirements",hint:"0=none ¬∑ 10=otr ‚â§ spec at temp/humidity"},
      {label:"Lot traceability & COA",hint:"0=not needed ¬∑ 10=lot-level docs mandatory"},
      {label:"Tamper evidence needs",hint:"0=none ¬∑ 10=regulated sealing bands/labels"}
    ],
    logistics: [
      {label:"E-com fulfillment compatibility",hint:"0=carton-only ¬∑ 10=works in pick/pack, sorter, parcel"},
      {label:"3PL integration & ASN/labels",hint:"0=manual ¬∑ 10=GS1/ASN/SSCC-ready"},
      {label:"Damage reduction in parcel",hint:"0=n/a ¬∑ 10=meets ISTA 6A/3A goals"},
      {label:"Cube/weight optimization",hint:"0=ignored ¬∑ 10=downweight/rightsized"}
    ],
    cosmetics: [
      {label:"Premium print/finish expectations",hint:"0=basic CMYK ¬∑ 10=foil/spot UV/emboss at scale"},
      {label:"Color consistency delta-E",hint:"0=ŒîE>6 ¬∑ 10=ŒîE‚â§2"},
      {label:"Unboxing experience",hint:"0=plain ¬∑ 10=designed tactile experience"}
    ],
    pharma: [
      {label:"GxP documentation",hint:"0=minimal ¬∑ 10=full SOP/validation pack"},
      {label:"Serialisation/lot coding",hint:"0=none ¬∑ 10=DSCSA/EU FMD ready"},
      {label:"Tamper-evidence compliance",hint:"0=not required ¬∑ 10=regulated seals"}
    ],
    industrial: [
      {label:"Heavy-load stability",hint:"0=fails often ¬∑ 10=passes in-house drop/tilt"},
      {label:"Puncture/tear resistance",hint:"0=low ¬∑ 10=meets ASTM D-1709/D-1922"}
    ],
    apparel: [
      {label:"Parcel-rate optimization",hint:"0=ignored ¬∑ 10=poly/box right-sized"},
      {label:"Return-friendly design",hint:"0=none ¬∑ 10=easy reseal + clear label"}
    ],
    electronics: [
      {label:"ESD protection requirements",hint:"0=not needed ¬∑ 10=ANSI/ESD S541-compliant"},
      {label:"Shock/vibration protection",hint:"0=none ¬∑ 10=ISTA 2/3 compliance"}
    ],
    supplements: [
      {label:"Tamper bands/seals",hint:"0=none ¬∑ 10=band+induction+evidence"},
      {label:"Nutrition label compliance",hint:"0=basic ¬∑ 10=full 21 CFR compliant"}
    ],
    automotive: [
      {label:"Barcode/label compliance",hint:"0=none ¬∑ 10=AIAG/ODette spec"},
      {label:"Export durability",hint:"0=local only ¬∑ 10=export-ready packaging"}
    ],
    pet: [
      {label:"Odor/grease barrier",hint:"0=none ¬∑ 10=needed (PVDC/EVOH/etc.)"},
      {label:"Strong zipper/closure",hint:"0=optional ¬∑ 10=mandatory retentivity"}
    ]
  };

  // sector render with mute + auto
  function renderSectorBuckets(sectors){
    sectorBucketsRoot.innerHTML="";
    state.sectorMetrics = new Map();
    const uniq = Array.from(new Set((sectors||[]).map(s=>String(s).toLowerCase()))).slice(0,12);
    if (!uniq.length) return;

    for (const sec of uniq){
      const defaults = (SECTOR_METRICS[sec]||[
        {label:"Core quality consistency",hint:"0=variable ¬∑ 10=SPC within control limits"},
        {label:"On-time delivery reliability",hint:"0=<80% OTD ¬∑ 10=>=98% OTD"},
        {label:"Changeover/setup agility",hint:"0=slow ¬∑ 10=fast changeovers"}
      ]).map(m=>({label:m.label, value:7, hint:m.hint||""}));

      state.sectorMetrics.set(sec, defaults);

      // wrapper
      const wrap = document.createElement("div"); wrap.className="group";
      const head = document.createElement("div"); head.style.display="flex"; head.style.justifyContent="space-between"; head.style.alignItems="center";
      const title = document.createElement("h4"); title.style.margin="0"; title.textContent = sec.charAt(0).toUpperCase()+sec.slice(1)+" ‚Äî hot-priority metrics";
      const controls = document.createElement("div"); controls.style.display="flex"; controls.style.gap="8px"; controls.style.alignItems="center";

      // mute chip
      const mute = document.createElement("span"); mute.className="chip"; mute.textContent="Mute sector";
      mute.addEventListener("click",()=>{
        const on = !mute.classList.contains("active");
        mute.classList.toggle("active", on);
        if (on) state.mutedSectors.add(sec); else state.mutedSectors.delete(sec);
      });

      // auto decide
      const autoLbl = document.createElement("label"); autoLbl.className="muted-hint"; autoLbl.style.cursor="pointer";
      const auto = document.createElement("input"); auto.type="checkbox"; auto.style.marginRight="6px";
      autoLbl.appendChild(auto); autoLbl.appendChild(document.createTextNode("Let AI decide"));
      controls.appendChild(mute); controls.appendChild(autoLbl);

      head.appendChild(title); head.appendChild(controls);
      wrap.appendChild(head);

      // metrics sliders
      for (const m of defaults){
        const row=document.createElement("div"); row.className="slider-row";
        const lab=document.createElement("div"); lab.textContent=m.label;
        if (m.hint){ const hint=document.createElement("div"); hint.className="muted-hint"; hint.textContent=m.hint; lab.appendChild(document.createElement("br")); lab.appendChild(hint); }
        const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=m.value;
        input.addEventListener("input",()=>{ m.value=Number(input.value); });
        row.appendChild(lab); row.appendChild(input);
        wrap.appendChild(row);
      }

      // stash auto state on element for export
      wrap.dataset.sector = sec;
      wrap.dataset.auto = "false";
      auto.addEventListener("change",()=>{ wrap.dataset.auto = auto.checked ? "true":"false"; });
      sectorBucketsRoot.appendChild(wrap);
    }
  }

  // ===== operations =====
  function renderOpsPool(list){
    opsChips.innerHTML=""; opsSliders.innerHTML=""; state.opsSelected = new Map();
    const ensure = (label)=>{
      if (state.opsSelected.has(label)) return;
      const wrap=document.createElement("div"); wrap.className="slider-row"; wrap.dataset.label=label;
      const lab=document.createElement("div"); lab.textContent=label;
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value="7";
      input.addEventListener("input",()=> state.opsSelected.set(label, Number(input.value)));
      wrap.appendChild(lab); wrap.appendChild(input); opsSliders.appendChild(wrap);
      state.opsSelected.set(label, 7);
    };
    const remove = (label)=>{
      const el=opsSliders.querySelector('[data-label="'+CSS.escape(label)+'"]');
      if (el) el.remove(); state.opsSelected.delete(label);
    };
    (list||[]).forEach(l=> addChip(l, opsChips, (on,text)=> on? ensure(text):remove(text)));
  }

  // ===== targeting seeds (prefilled) =====
  function guessHQFromHost(host){
    const h=(host||"").toLowerCase();
    if (/new.?jersey|nj-?/.test(h)) return "New Jersey";
    if (/new.?york|nyc|ny-?/.test(h)) return "New York";
    if (/los.?angeles|la|ca-?/.test(h)) return "Los Angeles";
    if (/chicago|il-?/.test(h)) return "Chicago";
    if (/dallas|tx-?/.test(h)) return "Dallas";
    if (/atlanta|ga-?/.test(h)) return "Atlanta";
    if (/miami|fl-?/.test(h)) return "Miami";
    return "New Jersey";
  }

  function seedTargeting(){
    // cities
    const hq = state.hq || guessHQFromHost(state.line.host);
    const cityList=[hq,"Chicago","Los Angeles","New York","Dallas","Atlanta","Miami"];
    cityChips.innerHTML="";
    Array.from(new Set(cityList)).forEach(c=>{
      const chip=addChip(c, cityChips, (on,text)=>{
        if (on) cityEl.value=text;
        else if (cityEl.value===text) cityEl.value="";
      });
      if (c===hq){ chip.classList.add("active"); cityEl.value=c; }
    });

    // sectors
    const list = (state.sectorHints && state.sectorHints.length)
      ? state.sectorHints
      : ["food","beverage","logistics","electronics","automotive","industrial","apparel","pharma","cosmetics","household"];
    sectorChips.innerHTML="";
    Array.from(new Set(list)).slice(0,12).forEach(s=>{
      const chip=addChip(s, sectorChips, (on)=>{
        const picked = Array.from(sectorChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim());
        sectorsEl.value = picked.join(", ");
      });
      chip.classList.add("active");
    });
    sectorsEl.value = Array.from(sectorChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim()).join(", ");
  }

  // ===== persona apply =====
  function applyServerPersona(data, host){
    const prods = (data.productTags||[]).slice(0,5).join(", ") || "packaging";
    const segs  = (data.sectorHints||[]).slice(0,3).join(", ") || "brands";
    const contacts = /ops|operation|procure|plant|warehouse|supply|logistics/i.test(((data.summary||"")+" "+(data.productTags||[]).join(",")).toLowerCase())
      ? "Operations, Procurement" : "Procurement, Marketing";
    state.line = { host, verb:"supplies", products:prods, audience:segs, region:"the U.S.", contacts };
    sentence.innerHTML="";
    const parts=[state.line.host,"‚Äî",state.line.verb,state.line.products,"for",state.line.audience,"in",state.line.region,".","Best contacts:",state.line.contacts];
    for (const t of parts){ const s=document.createElement("span"); s.className="token"; s.textContent=t; sentence.appendChild(s); sentence.appendChild(document.createTextNode(" ")); }

    // hot metrics (global)
    const baseHot = (data.hotMetrics && data.hotMetrics.length)
      ? data.hotMetrics
      : [
          "Automation line uptime impact",
          "Damage reduction targets in transit",
          "Sustainability targets (PCR %, recyclability)",
          "Unit cost at target MOQ",
          "Vendor-managed inventory flexibility"
        ];
    renderMetrics(baseHot);

    // sectors
    state.sectorHints = (data.sectorHints||[]).slice(0,12);
    renderSectorBuckets(state.sectorHints);

    // ops
    const opsList = (data.opsPool && data.opsPool.length)
      ? data.opsPool
      : ["Hand pallet wrapping","Automated pallet wrapper","E-commerce fulfillment","Warehouse pick/pack","3PL / distribution","Co-packing"];
    renderOpsPool(opsList);

    // tags + targeting
    state.productTags = data.productTags||[];
    state.hq = data.hqCity || "";
    seedTargeting();
  }

  async function refreshFromWebsite(){
    const host = normHost(hostEl.value || domainFromEmail(emailEl.value));
    if (!host) return;
    statusEl.textContent="";
    try{
      state.line.host = host; setFavicon(host);
      const data = await classify(host, emailEl.value||"");
      applyServerPersona(data, host);
      statusEl.textContent = data.cached ? "(cached)" : "";
    }catch(err){
      statusEl.textContent = " (offline)";
      renderMetrics([
        "Automation line uptime impact",
        "Damage reduction targets in transit",
        "Sustainability targets (PCR %, recyclability)",
        "Unit cost at target MOQ"
      ]);
      renderSectorBuckets(state.sectorHints||[]);
      renderOpsPool(["E-commerce fulfillment","Warehouse pick/pack","3PL / distribution","Co-packing"]);
      seedTargeting();
    }
  }

  // wire edit/done + refresh
  editBtn.addEventListener("click",()=>{
    sentence.classList.add("editing");
    editBtn.hidden=true; doneBtn.hidden=false;
    sentence.querySelectorAll(".token").forEach((el,i)=>{
      if ([1,8,9,10].includes(i)) return; // lock punctuation / "Best contacts:"
      if (!/‚Äî|\.|Best contacts:/.test(el.textContent)) { el.dataset.editable="true"; el.contentEditable="true"; }
    });
  });
  doneBtn.addEventListener("click",()=>{
    const vals = Array.from(sentence.querySelectorAll(".token")).map(s=>s.textContent.trim());
    // recompute from sequence
    state.line = {
      host: vals[0]||state.line.host,
      verb: vals[2]||state.line.verb,
      products: vals[3]||state.line.products,
      audience: vals[5]||state.line.audience,
      region: vals[7]||state.line.region,
      contacts: vals[11]||state.line.contacts
    };
    sentence.classList.remove("editing");
    sentence.querySelectorAll(".token").forEach(el=>{ el.removeAttribute("contenteditable"); el.removeAttribute("data-editable"); });
    editBtn.hidden=false; doneBtn.hidden=true;
  });
  refreshA.addEventListener("click",(e)=>{ e.preventDefault(); refreshFromWebsite(); });

  // replace Next handler to enable Finish
  (function replaceNext(){
    const old = nextBtn;
    const fresh = old.cloneNode(true);
    old.parentNode.replaceChild(fresh, old);

    fresh.addEventListener("click", async ()=>{
      if (state.step===0){ show(1); return; }

      if (state.step===1){
        if (!emailEl.value || !document.getElementById("phone").value){
          alert("Business email and phone are required."); return;
        }
        const hc = normHost(hostEl.value || domainFromEmail(emailEl.value));
        if (!hc){ alert("Please provide your website/domain."); return; }
        hostEl.value = hc; state.line.host = hc; setFavicon(hc); renderSentence();
        await refreshFromWebsite();
        show(2); return;
      }

      if (state.step===2){
        if (state.opsSelected.size===0){
          alert("Pick at least one buyer operation (and set its importance).");
          return;
        }

        // collect sector metrics with auto/mute flags
        const sectorsPacked = [];
        sectorBucketsRoot.querySelectorAll(".group").forEach(secEl=>{
          const sector = secEl.dataset.sector;
          const auto = secEl.dataset.auto==="true";
          if (state.mutedSectors.has(sector)){
            sectorsPacked.push({sector, muted:true, auto:false, metrics:[]});
          }else{
            const arr = state.sectorMetrics.get(sector)||[];
            sectorsPacked.push({sector, muted:false, auto, metrics:arr});
          }
        });

        const persona = {
          host: normHost(state.line.host),
          role: state.role,
          line: state.line,
          productTags: state.productTags,
          sectorHints: state.sectorHints,
          metrics: state.metrics,
          sectorMetrics: sectorsPacked,
          operations: Array.from(state.opsSelected.entries()).map(([label,value])=>({label,value})),
          targeting: {
            city: (cityEl.value||"").trim(),
            sectors: (sectorsEl.value||"").trim(),
            citiesPicked: Array.from(cityChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim()),
            sectorsPicked: Array.from(sectorChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim())
          }
        };

        setS("bf.persona", JSON.stringify(persona));
        setS("fp.persona", JSON.stringify(persona));
        setS("fp.supplier.host", persona.host);
        setS("fp.pref.city", persona.targeting.city || (persona.targeting.citiesPicked[0]||""));
        setS("fp.pref.tagPrefer", (persona.productTags||[]).join("\n"));
        setS("fp.pref.segPrefer", (persona.sectorHints||[]).join("\n"));
        setS("fp.autoImport","1");

        location.href = "free-panel.html";
      }
    });
  })();

  // full boot
  (async function bootFull(){
    await apiDetect();
    const d=domainFromEmail(emailEl.value); if (d){ hostEl.value=d; setFavicon(d); }
    seedTargeting();
  })();

  // expose
  window.Galactly = {
    state,
    addChip,
    renderMetrics,
    renderSectorBuckets,
    renderOpsPool,
    seedTargeting,
    refreshFromWebsite,
    applyServerPersona,
    apiDetect
  };

/* -------------------- END PART 2 -------------------- */
})();
</script>
</body>
</html>