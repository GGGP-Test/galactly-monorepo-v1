<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly ‚Äî Find real packaging buyers</title>
<link rel="preconnect" href="https://icons.duckduckgo.com">
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel-2:#0e141c;
    --muted:#8aa0b2; --text:#e9f1f7; --brand:#8ae3ff;
    --cta:#6de1ff; --ctaText:#082433; --chip:#1a2433;
    --chipActive:#103247; --accent:#38e08f; --divider:#1b2531; --ring:#24435f;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  .hero{min-height:100vh;display:grid;place-items:center;padding:4rem 1rem;background: radial-gradient(1200px 600px at 50% -200px, #102132 0, transparent 70%); position:relative}
  .hero-inner{max-width:920px;text-align:center}
  h1{font-size:clamp(32px,6vw,56px);margin:0 0 12px}
  p.lead{color:var(--muted);margin:0 0 28px}
  .btn{display:inline-flex;align-items:center;gap:.6rem;padding:12px 18px;border-radius:12px;background:var(--cta);color:var(--ctaText);font-weight:700;border:none;cursor:pointer}
  .btn.sec{background:#152333;color:#cfe0ee}
  .btn:active{transform:translateY(1px)}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.show{display:flex}
  .card{width:min(980px,92vw);background:var(--panel);border:1px solid var(--divider);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;background:linear-gradient(180deg,#0f1622,#0e1520);border-bottom:1px solid var(--divider)}
  .steps{display:flex;gap:8px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#2a3444}
  .dot.on{background:#5bd0ff}
  .card-bd{padding:18px}
  .card-ft{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px;border-top:1px solid var(--divider)}
  .scroll{max-height:70vh;overflow:auto;padding:6px 6px}

  /* inputs */
  .field{margin:10px 0}
  label{display:block;font-size:13px;color:#9abbcc;margin:0 0 6px}
  input[type=text],input[type=email],input[type=tel]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:var(--text);outline:none}
  input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}

  /* summary */
  .summary{display:flex;gap:12px;background:#0e1622;border:1px solid var(--divider);padding:12px 14px;border-radius:14px;margin:0 0 14px;align-items:flex-start}
  .fav{width:24px;height:24px;border-radius:6px;display:grid;place-items:center;overflow:hidden;flex:0 0 auto;background:#fff;border:1px solid #cfd8e3}
  .fav img{width:24px;height:24px;filter:saturate(1.05) contrast(1.05)}
  .one{font-weight:700}
  .one-line{line-height:1.8}
  .token{display:inline-block;border-radius:8px;padding:2px 6px;margin:0 2px}
  .sentence .token[data-editable="true"]{border-bottom:1px dashed #3a5572}
  .sentence.editing .token[data-editable="true"]{background:#0f1926;border:1px solid #2b425a}
  .sentence .token:focus{outline:2px solid var(--ring)}
  .big-edit{padding:6px 10px;border-radius:10px;background:#172839;border:1px solid #274059;color:#d8e8f7;font-weight:600;cursor:pointer}
  .big-edit.primary{background:var(--cta);border:none;color:#06293a}

  /* groups */
  .group{background:#0f1724;border:1px solid var(--divider);border-radius:14px;padding:14px;margin:14px 0}
  .group h4{margin:0 0 8px}
  .muted-hint{font-size:12px;color:#99b2c8;margin-left:8px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipActive);color:#eaf7ff;border-color:#1b4862}
  .hint{font-size:12px;color:#8aa0b2;margin-top:6px}

  /* sliders */
  .slider-row{display:grid;grid-template-columns:1fr 280px;gap:16px;align-items:center;margin:10px 0}
  .slider-row input[type=range]{width:100%}

  .pill{padding:6px 10px;border-radius:999px;background:#0d1a26;color:#8fb0c6;font-size:12px;display:inline-block}
  .x{background:transparent;color:#9fb3c6;border:none;font-size:18px;cursor:pointer}
  .gear{background:transparent;border:none;color:#99b4c7;cursor:pointer}
  @media (max-width:800px){.slider-row{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <h1>Find real packaging buyers.</h1>
      <p class="lead">Laser-targeted leads, tuned to your strengths.</p>
      <button id="cta" type="button" class="btn"><span>‚ú®</span> Get qualified leads free</button>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="card" role="document">
      <div class="card-hd">
        <div class="steps" aria-label="Steps">
          <span class="dot on" data-step-dot="0"></span>
          <span class="dot" data-step-dot="1"></span>
          <span class="dot" data-step-dot="2"></span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="gear" class="gear" title="Set API base">‚öôÔ∏è</button>
          <button id="close" class="x" aria-label="Close">‚úï</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="scroll">

          <!-- STEP 1 -->
          <section class="step" id="step1">
            <div class="pill">Get set up in 60 seconds</div>
            <h2 style="margin:10px 0 14px;">Pick your side</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div id="opt-supplier" class="chip active">üôå I sell packaging (Supplier)</div>
                <div id="opt-buyer" class="chip">üõí I buy packaging (Buyer)</div>
              </div>
            </div>
          </section>

          <!-- STEP 2 -->
          <section class="step" id="step2" hidden>
            <div class="pill">Step 2 of 3</div>
            <h2 style="margin:10px 0 14px;">Tell us who you are</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                <div>
                  <div class="field">
                    <label>Your name</label>
                    <input id="name" type="text" autocomplete="name" placeholder="e.g., Sam Carter">
                  </div>
                  <div class="field">
                    <label>Phone (for alerts) *</label>
                    <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+1 555 123 4567"/>
                  </div>
                </div>
                <div>
                  <div class="field">
                    <label>Business email *</label>
                    <input id="email" type="email" autocomplete="email" placeholder="you@yourcompany.com" required/>
                  </div>
                  <div class="field">
                    <label>Website / Domain (auto from email)</label>
                    <input id="host" type="text" inputmode="url" placeholder="yourcompany.com"/>
                    <div class="hint">Auto-filled from your email as you type. You can edit.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="group" style="display:flex;align-items:center;justify-content:space-between">
              <div class="hint">Testing mode: verification skipped.</div>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input id="skipVerify" type="checkbox" checked> I‚Äôm just testing (skip verification)
              </label>
            </div>
          </section>

          <!-- STEP 3 -->
          <section class="step" id="step3" hidden>
            <div class="pill">Step 3 of 3</div>

            <!-- sentence editor -->
            <div class="summary">
              <div class="fav"><img id="fav" alt="" width="24" height="24" referrerpolicy="no-referrer"></div>
              <div style="flex:1">
                <div id="sentence" class="one one-line sentence" aria-live="polite"></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                  <button id="editLine" class="big-edit" type="button">Edit</button>
                  <button id="doneLine" class="big-edit primary" type="button" hidden>Done</button>
                  <a id="refresh" href="#" class="big-edit" style="background:#142133;border-color:#25384b;color:#a9c3d8">Refresh from website</a>
                  <span id="status" class="muted-hint"></span>
                </div>
              </div>
            </div>

            <!-- HOT 10% -->
            <div class="group">
              <h4 style="margin:0">Buyer priorities ‚Äî <em>for your top 10% buyers</em></h4>
              <div class="hint">Tell us what your very best buyers care about most. We‚Äôll use this to rank hot leads higher. (0‚Äì10)</div>
              <div id="metricsBox"></div>
            </div>

            <!-- OPERATIONS -->
            <div class="group">
              <h4 style="margin:0">Buyer operations (optional)</h4>
              <div class="hint">Pick the operations your top buyers run. Click to select; use the slider to set importance.</div>
              <div id="opsChips" class="chips"></div>
              <div id="opsSliders"></div>
            </div>

            <!-- CERTS / COMPLIANCE -->
            <div class="group">
              <h4 style="margin:0">Certifications & compliance (optional)</h4>
              <div class="hint">If these matter to your hot buyers, select and weight them.</div>
              <div id="certChips" class="chips"></div>
              <div id="certSliders"></div>
            </div>

            <!-- TARGETING -->
            <div class="group">
              <h4 style="margin:0 0 8px">Targeting</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div>
                  <label>Boost leads near‚Ä¶</label>
                  <input id="city" type="text" placeholder="e.g., Newark, NJ">
                  <div id="cityChips" class="chips" style="margin-top:6px"></div>
                  <div class="hint">Tip: set your HQ or strongest market (we‚Äôll expand radially).</div>
                </div>
                <div>
                  <label>Sectors (suggested)</label>
                  <input id="sectors" type="text" placeholder="e.g., food, beverage, cosmetics">
                  <div id="sectorChips" class="chips" style="margin-top:6px"></div>
                  <div class="hint">We show suggestions only when evidence is strong. You can add your own.</div>
                </div>
              </div>
            </div>

          </section>
        </div>

        <div class="card-ft">
          <button id="back" class="btn sec" type="button">Back</button>
          <button id="next" class="btn" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  /* -------------------- storage helpers -------------------- */
  function getStored(k, d=""){ try{ const v = localStorage.getItem(k); return v===null? d : v; }catch{ return d; } }
  function setStored(k,v){ try{ localStorage.setItem(k, v); }catch{} }

  /* -------------------- API base + fallback -------------------- */
  const API_BASE = {
    get(){
      if (window.API_BASE && typeof window.API_BASE==="string") return window.API_BASE.replace(/\/+$/,"");
      return (getStored("apiBase","")||"").replace(/\/+$/,"");
    },
    set(v){ if(v) setStored("apiBase", v.replace(/\/+$/,"")); }
  };
  async function apiFetch(path, opts={}){
    const base=(API_BASE.get()||"").replace(/\/+$/,"");
    const tries=[`${base}${path}`, `${base}/api${path}`];
    let lastErr="request failed";
    for(const url of tries){
      try{ const r=await fetch(url, opts); if(r.ok) return r; lastErr=await r.text().catch(()=>r.statusText);}catch(e){lastErr=e.message;}
    }
    throw new Error(lastErr);
  }

  /* -------------------- elements -------------------- */
  const modal = document.getElementById("modal");
  const openBtn = document.getElementById("cta");
  const closeBtn = document.getElementById("close");
  const backBtn = document.getElementById("back");
  const nextBtn = document.getElementById("next");
  const dots=[...document.querySelectorAll("[data-step-dot]")];

  const emailEl=document.getElementById("email");
  const hostEl=document.getElementById("host");
  const phoneEl=document.getElementById("phone");

  const favImg=document.getElementById("fav");
  const sentence=document.getElementById("sentence");
  const editBtn=document.getElementById("editLine");
  const doneBtn=document.getElementById("doneLine");
  const refreshA=document.getElementById("refresh");
  const statusEl=document.getElementById("status");

  const metricsBox=document.getElementById("metricsBox");
  const opsChips=document.getElementById("opsChips");
  const opsSliders=document.getElementById("opsSliders");
  const certChips=document.getElementById("certChips");
  const certSliders=document.getElementById("certSliders");
  const cityEl=document.getElementById("city");
  const sectorsEl=document.getElementById("sectors");
  const cityChips=document.getElementById("cityChips");
  const sectorChips=document.getElementById("sectorChips");

  /* -------------------- quick gear -------------------- */
  document.getElementById("gear").addEventListener("click",()=>{
    const cur = API_BASE.get() || "https://YOUR-NORTHFLANK.code.run/api";
    const v = prompt("API base (root or /api). Example:\nhttps://YOUR-NORTHFLANK.code.run/api", cur);
    if(!v) return; API_BASE.set(v); alert("Saved. Using:\n"+API_BASE.get());
  });

  /* -------------------- state -------------------- */
  const state={
    step:0, role:"supplier",
    line:{ host:"yourcompany.com", verb:"supplies", products:"packaging", audience:"businesses", region:"the U.S.", contacts:"Operations, Procurement" },
    hotMetrics:[], ops:[], certs:[], productTags:[], sectorHints:[], touched:false
  };

  /* -------------------- util -------------------- */
  function show(step){
    state.step=step;
    ["#step1","#step2","#step3"].forEach((id,i)=>{ const el=document.querySelector(id); if(!el) return; el.hidden=i!==step; dots[i].classList.toggle("on", i===step); });
    backBtn.style.visibility = step===0?"hidden":"visible";
    nextBtn.textContent = step===2? "Finish":"Next";
  }
  function open(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); show(0); }
  function close(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); }
  function normHost(h){ return (h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,""); }
  function domainFromEmail(e){ const m=(e||"").toLowerCase().match(/@([a-z0-9.-]+)/); return m? m[1]:""; }
  function setFavicon(host){ const h=normHost(host); favImg.src = h? "https://icons.duckduckgo.com/ip3/"+encodeURIComponent(h)+".ico":""; }

  /* -------------------- sentence -------------------- */
  function renderSentence(editing=false){
    const L=state.line;
    const tpl=[
      {k:"host", txt:L.host, lock:true},
      {txt:"‚Äî", lock:true},
      {k:"verb", txt:L.verb},
      {k:"products", txt:L.products},
      {txt:"for", lock:true},
      {k:"audience", txt:L.audience},
      {txt:"in", lock:true},
      {k:"region", txt:L.region},
      {txt:".", lock:true},
      {txt:"Best contacts:", lock:true},
      {k:"contacts", txt:L.contacts}
    ];
    sentence.classList.toggle("editing", editing);
    sentence.innerHTML="";
    for(const part of tpl){
      const span=document.createElement("span"); span.className="token"; span.dataset.lock=part.lock?"true":"false";
      if(!part.lock){ span.dataset.editable="true"; span.contentEditable=editing; span.addEventListener("input",()=>{ state.line[part.k]=span.textContent.trim(); state.touched=true; }); }
      span.textContent=part.txt; sentence.appendChild(span); sentence.appendChild(document.createTextNode(" "));
    }
  }
  editBtn.addEventListener("click",()=>{ renderSentence(true); editBtn.hidden=true; doneBtn.hidden=false; });
  doneBtn.addEventListener("click",()=>{ renderSentence(false); editBtn.hidden=false; doneBtn.hidden=true; });

  /* -------------------- chips & sliders -------------------- */
  function chip(box, text, pickedSet){
    const s=document.createElement("span"); s.className="chip"; s.textContent=text;
    s.addEventListener("click",()=>{ s.classList.toggle("active");
      if(pickedSet){ if(s.classList.contains("active")) pickedSet.add(text); else pickedSet.delete(text); state.touched=true; }
    });
    box.appendChild(s); return s;
  }
  function sliderRow(box,label,val=7,onchange){
    const row=document.createElement("div"); row.className="slider-row";
    const lab=document.createElement("div"); lab.textContent=label;
    const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=val;
    input.addEventListener("input",()=>{ onchange(Number(input.value)); state.touched=true; });
    row.appendChild(lab); row.appendChild(input); box.appendChild(row);
    return input;
  }

  /* -------------------- HOT METRICS -------------------- */
  const METRIC_LIBRARY=[
    "Hand-wrap compatibility",
    "Machine-wrap / automation fit",
    "Fast turnaround (‚â§ 2 weeks)",
    "Lowest unit cost",
    "MOQ flexibility / short runs",
    "Sustainability / recyclable / PCR",
    "Food-safe barrier / FDA",
    "CR / tamper evidence",
    "Cold-chain / thermal protection",
    "Print & finish quality",
    "Protection / rugged / ESD",
    "Vendor-managed inventory",
    "Custom sizing / engineering",
    "Speed-to-market support"
  ];
  function renderHotMetrics(seed){
    const labels = seed && seed.length ? seed : METRIC_LIBRARY;
    metricsBox.innerHTML=""; state.hotMetrics=[];
    labels.forEach(l=>{
      const init = /machine|automation/i.test(l) ? 9 :
                   /hand/i.test(l) ? 8 :
                   /unit cost/i.test(l) ? 7 :
                   /fast|turnaround|speed/i.test(l) ? 8 : 6;
      const m={label:l, value:init}; state.hotMetrics.push(m);
      sliderRow(metricsBox,l,init,(v)=>m.value=v);
    });
  }

  /* -------------------- OPS & CERTS -------------------- */
  const OPS_LIBRARY=[
    "Hand pallet wrapping",
    "Automated pallet wrapper",
    "E-commerce fulfillment",
    "Wholesale / distribution",
    "Dock-to-stock / cross-dock",
    "Cold chain logistics"
  ];
  const CERT_LIBRARY=[
    "FDA / food contact",
    "ISO 9001",
    "REACH / RoHS",
    "Child-resistant / CR",
    "Made in USA preference"
  ];
  const pickedOps=new Set(), pickedCerts=new Set();
  function renderOpsAndCerts(){
    opsChips.innerHTML=""; opsSliders.innerHTML=""; certChips.innerHTML=""; certSliders.innerHTML="";
    OPS_LIBRARY.forEach(o=>{
      const s=chip(opsChips,o,pickedOps);
      s.addEventListener("click",()=>{ if(s.classList.contains("active")) sliderRow(opsSliders,o,7,(v)=>{ state.ops=state.ops.map(x=>x.label===o? {...x,value:v}:x); });
        if(!s.classList.contains("active")){ state.ops=state.ops.filter(x=>x.label!==o); opsSliders.innerHTML=""; pickedOps.forEach(x=>{ sliderRow(opsSliders,x,7,(v)=>{ state.ops=state.ops.map(m=>m.label===x? {...m,value:v}:m); }); }); }
        else { state.ops.push({label:o,value:7}); }
      });
    });
    CERT_LIBRARY.forEach(c=>{
      const s=chip(certChips,c,pickedCerts);
      s.addEventListener("click",()=>{ if(s.classList.contains("active")) sliderRow(certSliders,c,6,(v)=>{ state.certs=state.certs.map(x=>x.label===c? {...x,value:v}:x); });
        if(!s.classList.contains("active")){ state.certs=state.certs.filter(x=>x.label!==c); certSliders.innerHTML=""; pickedCerts.forEach(x=>{ sliderRow(certSliders,x,6,(v)=>{ state.certs=state.certs.map(m=>m.label===x? {...m,value:v}:m); }); }); }
        else { state.certs.push({label:c,value:6}); }
      });
    });
  }

  /* -------------------- seed chips -------------------- */
  function seedCityChips(){ ["Newark, NJ","New York","Philadelphia","Boston","Chicago","Los Angeles"].forEach(c=>chip(cityChips,c)); }
  function seedSectorChips(suggests){ sectorChips.innerHTML=""; (suggests||[]).forEach(s=>chip(sectorChips,s)); }

  /* -------------------- classify -------------------- */
  async function classify(host,email){
    const q = `?host=${encodeURIComponent(host)}&email=${encodeURIComponent(email||"")}`;
    try{
      const r = await apiFetch('/classify'+q,{credentials:'omit'});
      return await r.json();
    }catch(e){ return { ok:false, error:String(e) }; }
  }

  function deriveFromSignals(data, host){
    // product tags
    state.productTags = (data.productTags||[]).slice(0,12);

    // sectors: never claim a narrow sector from one flimsy hint
    const hints = (data.sectorHints||[]).filter(Boolean);
    if (hints.length>=2){ state.sectorHints = hints.slice(0,6); }
    else { state.sectorHints = []; } // show as suggestions only

    // derive hot metrics emphasis from text
    const text = ((data.summary||"")+" "+(data.evidence||[]).join(" ")+" "+state.productTags.join(" ")).toLowerCase();
    const seed = new Set();
    if(/machine|automated|wrapper|palletizer|automation/.test(text)) seed.add("Machine-wrap / automation fit");
    if(/hand wrap|hand\-?stretch/.test(text)) seed.add("Hand-wrap compatibility");
    if(/food|fda|barrier|oxygen|moisture|foil/.test(text)) seed.add("Food-safe barrier / FDA");
    if(/cold chain|thermal|insulated|temperature/.test(text)) seed.add("Cold-chain / thermal protection");
    if(/sustain|recycl|pcr|eco|green/.test(text)) seed.add("Sustainability / recyclable / PCR");
    if(/moq|short run|prototype|sample/.test(text)) seed.add("MOQ flexibility / short runs");
    if(/tamper|child/.test(text)) seed.add("CR / tamper evidence");
    if(/inventory|kanban|stock/.test(text)) seed.add("Vendor-managed inventory");
    if(/print|finish|coating|foil stamp|emboss/.test(text)) seed.add("Print & finish quality");
    // always include these two as baseline knobs
    seed.add("Fast turnaround (‚â§ 2 weeks)"); seed.add("Lowest unit cost");

    renderHotMetrics([...seed]);
    renderOpsAndCerts();

    // sentence defaults: never hardcode a narrow sector; keep ‚Äúbusinesses‚Äù
    state.line = { host, verb:"supplies", products: state.productTags.slice(0,3).join(", ") || "packaging", audience:"businesses", region:"the U.S.", contacts:"Operations, Procurement" };
    renderSentence(false);

    // suggest sectors as chips (unselected)
    const suggest = hints.length ? hints.slice(0,6) : ["food","beverage","cosmetics","electronics","apparel","logistics"];
    seedSectorChips(suggest);
  }

  async function refreshFromWebsite(){
    const host=normHost(hostEl.value); if(!host) return;
    setFavicon(host); statusEl.textContent="";
    try{
      const data = await classify(host, emailEl.value||"");
      if(data && (data.ok || data.host)){ deriveFromSignals(data, host); statusEl.textContent = data.cached ? "(cached)" : ""; }
      else { renderHotMetrics(); renderOpsAndCerts(); renderSentence(false); statusEl.textContent="(offline)"; }
    }catch(err){ renderHotMetrics(); renderOpsAndCerts(); statusEl.textContent="(network error)"; }
  }

  /* -------------------- nav -------------------- */
  function savePersonaAndGo(){
    const host = normHost(state.line.host);
    const selectedSectors = Array.from(sectorChips.querySelectorAll('.chip.active')).map(x=>x.textContent.trim());
    const persona={
      host, role:state.role,
      oneLine: `${host} ‚Äî ${state.line.verb} ${state.line.products} for ${state.line.audience} in ${state.line.region}. Best contacts: ${state.line.contacts}`,
      productTags: state.productTags,
      sectorHints: selectedSectors,
      buyerPriorities: state.hotMetrics,
      operations: state.ops,
      certifications: state.certs,
      targeting: { boostCities: Array.from(cityChips.querySelectorAll('.chip.active')).map(x=>x.textContent.trim()).concat((cityEl.value||"").trim()? [cityEl.value.trim()] : []) }
    };
    setStored('bf.persona', JSON.stringify(persona));
    setStored('fp.autoImport','1');
    setStored('fp.supplier.host', host); // legacy hints for panel
    location.href='free-panel.html';
  }

  /* -------------------- listeners -------------------- */
  openBtn.addEventListener("click",open);
  closeBtn.addEventListener("click",close);
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") close(); });
  document.addEventListener("click",(e)=>{ if(e.target===modal) close(); });

  backBtn.addEventListener("click",()=> show(Math.max(0,state.step-1)));
  nextBtn.addEventListener("click", async ()=>{
    if(state.step===0){ show(1); return; }
    if(state.step===1){
      if(!emailEl.value || !phoneEl.value){ alert("Business email and phone are required."); return; }
      const hostCandidate = normHost(hostEl.value || domainFromEmail(emailEl.value));
      if(!hostCandidate){ alert("Please provide your website/domain."); return; }
      hostEl.value=hostCandidate; await refreshFromWebsite(); show(2); return;
    }
    if(state.step===2){ savePersonaAndGo(); }
  });

  /* -------------------- init -------------------- */
  function syncDomain(){ const d=domainFromEmail(emailEl.value); if(d) hostEl.value=d; }
  emailEl.addEventListener("input",syncDomain); emailEl.addEventListener("change",syncDomain); setTimeout(syncDomain,120);
  renderSentence(false); renderHotMetrics(); renderOpsAndCerts(); seedCityChips(); show(0);
})();
</script>
</body>
</html>