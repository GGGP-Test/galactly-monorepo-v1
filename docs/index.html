<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Galactly — Find real packaging buyers</title>
  <style>
    :root{
      --bg:#0e1217; --card:#121821; --muted:#8aa0b5; --text:#e9f1f7;
      --primary:#72d2ff; --accent:#38e17b; --chip:#1a2432; --chip-border:#243142;
      --slider:#90a4b8; --slider-track:#273244; --danger:#ff6b6b;
      --btn:#7fe3ff; --btn-text:#06202a;
    }
    html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .hero{
      max-width:1100px;margin:64px auto;padding:24px 20px;text-align:center;
    }
    h1{font-weight:800;font-size:40px;letter-spacing:-.02em;margin:0 0 16px}
    p.sub{color:var(--muted);margin:0 0 28px}
    .cta{background:var(--btn);color:var(--btn-text);border:0;border-radius:14px;padding:14px 22px;font-weight:700;cursor:pointer}
    /* modal */
    .overlay{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:24px}
    .overlay.show{display:flex}
    .modal{width:min(920px,100%);background:var(--card);border-radius:16px;box-shadow:0 18px 60px #000a;border:1px solid #1a2736;position:relative}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #1a2736}
    .modal-title{font-weight:800}
    .modal-body{padding:18px}
    .close{background:transparent;border:0;color:var(--muted);font-size:22px;cursor:pointer}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 380px}
    .card{background:#0f1520;border:1px solid #1a2736;border-radius:12px;padding:14px}
    .company-line{display:flex;align-items:center;gap:12px;justify-content:center;background:#0f1622;border:1px solid #1a2736;border-radius:12px;padding:16px;min-height:80px}
    .mini{color:var(--muted);font-size:13px}
    a.link{color:var(--primary);text-decoration:none}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip{border:1px solid var(--chip-border);background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chip.selected{outline:2px solid var(--accent);outline-offset:0}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .field input{background:#0d131d;color:var(--text);border:1px solid #1a2736;border-radius:10px;padding:10px 12px}
    .help{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .slider-row{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;margin:8px 0}
    input[type=range]{accent-color:var(--slider);width:100%}
    .btn-row{display:flex;justify-content:flex-end;gap:10px;margin-top:18px}
    .btn{background:var(--btn);color:var(--btn-text);border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#233043;color:#cfe7ff}
    .pill{background:#123042;color:#9cd6ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .toolbar{display:flex;align-items:center;gap:10px}
    .gear{color:var(--muted);font-size:18px;cursor:pointer}
    .error{color:var(--danger)}
    .center{display:flex;justify-content:center}
  </style>
</head>
<body>

  <div class="hero">
    <h1>Find real packaging buyers</h1>
    <p class="sub">Laser-targeted leads, tuned to your strengths. Start free.</p>
    <button class="cta" id="openCta">Get qualified leads free</button>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="toolbar">
          <div class="modal-title">Get set up in 60 seconds</div>
          <span id="envBadge" class="pill" style="display:none"></span>
        </div>
        <div class="toolbar">
          <a id="setApi" class="gear" title="Set API base">⚙️</a>
          <button class="close" id="closeBtn" aria-label="Close">×</button>
        </div>
      </div>
      <div class="modal-body">
        <!-- Step 3 only (you already tried the first two); we render summary + advanced -->
        <div class="card" id="summaryCard">
          <div class="company-line" id="companyLine">
            <img id="favicon" src="" alt="" width="28" height="28" style="border-radius:6px;display:none">
            <div id="oneLiner">your-company <b>— fetching summary…</b></div>
          </div>
          <div class="center mini" style="margin-top:8px;">
            <a href="#" class="link" id="refreshLink">Refresh from website</a>
            <span class="mini" id="fetchMsg" style="margin-left:8px;"></span>
          </div>

          <div class="center" style="margin:14px 0;">
            <button class="btn secondary" id="advToggle"><span id="advLabel">Show</span> advanced ▾</button>
          </div>

          <div id="advanced" style="display:none">
            <div class="mini center" style="margin-bottom:8px;">Optional: refine ranking and add product-specific details.</div>
            <div class="grid">
              <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                  <b>General tuning</b>
                  <label class="mini"><input type="checkbox" id="aiGeneral"> Let AI decide</label>
                </div>
                <div id="sliders"></div>
              </div>
              <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                  <b>Product signals (from your site)</b>
                  <label class="mini"><input type="checkbox" id="aiProduct"> Let AI decide</label>
                </div>
                <div class="mini">Tap to select. We’ll use these as focus tags.</div>
                <div class="chips" id="productChips"></div>
              </div>
            </div>

            <div class="card" style="margin-top:14px">
              <b>Buyer targeting</b>
              <div class="row">
                <div class="col">
                  <div class="field">
                    <label>Find buyers near…</label>
                    <input id="cityInput" placeholder="e.g., Chicago" autocomplete="address-level2">
                    <div class="chips" id="cityChips"></div>
                    <div class="help">We’ll boost leads near this city.</div>
                  </div>
                </div>
                <div class="col">
                  <div class="field">
                    <label>Buyers in these sectors</label>
                    <input id="sectorInput" placeholder="e.g., food, beverage, cosmetics" autocomplete="off">
                    <div class="chips" id="sectorChips"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn secondary" id="backBtn">Back</button>
              <button class="btn" id="nextBtn">Next</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/* --------------------- API base resolver --------------------- */
async function resolveApiBase(){
  const qs = new URLSearchParams(location.search);
  const fromQS = qs.get("api");
  if(fromQS){
    localStorage.setItem("apiBase", fromQS);
  }
  const candidates = [
    localStorage.getItem("apiBase") || "",
    (typeof window.API_BASE === "string" ? window.API_BASE : ""),
    location.origin // works only if page is hosted with API
  ].filter(Boolean);

  for(const base of candidates){
    try{
      const r = await fetch(base.replace(/\/$/,"") + "/healthz", {mode:"cors"});
      const t = await r.text().catch(()=> "");
      if(r.ok && /ok/i.test(t)){
        return base.replace(/\/$/,"");
      }
    }catch(_){}
  }
  throw new Error("NO_API_BASE");
}

function setApiBaseInteractively(){
  const v = prompt("Enter API base URL (your Northflank service URL).\nExample: https://animated-cellar--xxxxx.code.run");
  if(v && /^https?:\/\//i.test(v)){
    localStorage.setItem("apiBase", v.replace(/\/$/,""));
    location.reload();
  }
}
/* --------------------- UI wiring --------------------- */
const $ = (s)=>document.querySelector(s);
const overlay = $("#overlay");
$("#openCta").onclick = ()=>{ overlay.classList.add("show"); initStep3(); };
$("#closeBtn").onclick = ()=> overlay.classList.remove("show");
$("#advToggle").onclick = ()=>{
  const adv = $("#advanced");
  adv.style.display = adv.style.display === "none" ? "block" : "none";
  $("#advLabel").textContent = adv.style.display === "none" ? "Show" : "Hide";
};
$("#setApi").onclick = setApiBaseInteractively;

function chip(label, selected=false, onToggle=()=>{}){
  const el = document.createElement("button");
  el.type = "button";
  el.className = "chip" + (selected?" selected":"");
  el.textContent = label;
  el.onclick = ()=>{
    el.classList.toggle("selected");
    onToggle(el.classList.contains("selected"));
  };
  return el;
}
function sliderRow(label, val=5, min=0, max=10){
  const row = document.createElement("div");
  row.className = "slider-row";
  const name = document.createElement("div"); name.textContent = label;
  const input = document.createElement("input"); input.type="range"; input.min=min; input.max=max; input.value=val;
  const out = document.createElement("div"); out.textContent = val;
  input.oninput = ()=> out.textContent = input.value;
  row.append(name, input, out);
  return row;
}
/* --------------------- Step 3: fetch summary --------------------- */
let API_BASE = ""; // resolved at runtime
let currentHost = "";
let currentEmail = "";
// Pull from prior step (if you used the earlier steps these will be set in localStorage)
(function seedFromStorage(){
  const saved = JSON.parse(localStorage.getItem("onboard")||"{}");
  if(saved.website) currentHost = saved.website.replace(/^https?:\/\//,"").replace(/\/.*$/,"");
  if(saved.email) currentEmail = saved.email;
})();

async function fetchFavicon(host){
  const url = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&size=64&url=https://${encodeURIComponent(host)}`;
  try{
    const img = $("#favicon");
    img.src = url;
    img.style.display = "block";
  }catch(_){}
}

function showOneLiner(text, host){
  $("#oneLiner").innerHTML = `<b>${host || "your-company"}</b> — ${text}`;
}

async function callSummary(host, email){
  const u = new URL(API_BASE + "/api/classify/summary");
  u.searchParams.set("host", host);
  if(email) u.searchParams.set("email", email);
  const r = await fetch(u, {mode:"cors"});
  if(r.status === 404){
    // fallback to /api/classify
    const u2 = new URL(API_BASE + "/api/classify");
    u2.searchParams.set("host", host);
    if(email) u2.searchParams.set("email", email);
    const r2 = await fetch(u2, {mode:"cors"});
    const j2 = await r2.json();
    return { ok: !!j2.ok, summary: "", tags: [], sectors: [], cities: [], raw:j2, cached:j2.cached };
  }
  const j = await r.json();
  return j;
}

async function initStep3(){
  $("#fetchMsg").textContent = "";
  $("#productChips").innerHTML = "";
  $("#sectorChips").innerHTML = "";
  $("#cityChips").innerHTML = "";
  $("#sliders").innerHTML = "";
  $("#advanced").style.display = "none";
  $("#advLabel").textContent = "Show";

  try{
    API_BASE = await resolveApiBase();
    $("#envBadge").style.display = "inline-block";
    $("#envBadge").textContent = new URL(API_BASE).host;
  }catch(e){
    $("#fetchMsg").innerHTML = `<span class="error">Set API (click the gear).</span>`;
    showOneLiner("unable to connect — API base is not set.", currentHost||"your-company");
    return;
  }

  // if user came straight here, ask minimal host/email
  if(!currentHost){
    const h = prompt("Your website domain (e.g., peakpackaging.com):","");
    if(!h){ showOneLiner("please enter your website (click refresh).", "your-company"); return; }
    currentHost = String(h).trim().toLowerCase().replace(/^https?:\/\//,"").replace(/\/.*$/,"");
  }
  fetchFavicon(currentHost);
  showOneLiner("fetching summary…", currentHost);

  async function doFetch(){
    $("#fetchMsg").textContent = "";
    try{
      const data = await callSummary(currentHost, currentEmail);
      if(!data || data.ok === false){
        $("#fetchMsg").innerHTML = `<span class="error">Network error while reading your site.</span>`;
        showOneLiner("network error while reading your site.", currentHost);
        return;
      }
      const summary = data.summary || "sells packaging to brands.";
      showOneLiner(summary, currentHost);

      // Product tags
      const tags = (data.tags || []).slice(0, 14);
      const prodWrap = $("#productChips");
      tags.forEach(t => prodWrap.append(chip(t, true)));

      // Sectors chips
      const sectors = (data.sectors || ["food","beverage","cosmetics","electronics","apparel"]).slice(0,10);
      const sectWrap = $("#sectorChips");
      sectors.forEach(t => sectWrap.append(chip(t)));

      // City chips
      const cities = (data.cities || ["Chicago","New York","Los Angeles","Dallas","Atlanta","Miami"]).slice(0,10);
      const cityWrap = $("#cityChips");
      cities.forEach(c => cityWrap.append(chip(c)));

      // Sliders
      const s = $("#sliders");
      const sliderList = [
        "Prioritize nearby buyers",
        "Prefer e-commerce sites",
        "Prefer retail brands",
        "Prefer wholesalers / distributors",
        "Prefer mid-size companies",
        "De-prioritize giant enterprises"
      ];
      sliderList.forEach((name,i)=> s.append(sliderRow(name, (data.tuning && data.tuning[i]) || [6,7,5,6,6,7][i])));

    }catch(err){
      console.error(err);
      $("#fetchMsg").innerHTML = `<span class="error">Network error while reading your site.</span>`;
      showOneLiner("network error while reading your site.", currentHost);
    }
  }

  $("#refreshLink").onclick = (e)=>{ e.preventDefault(); doFetch(); };
  $("#nextBtn").onclick = ()=> alert("Next → free panel (hook up once ready).");
  $("#backBtn").onclick = ()=> overlay.classList.remove("show");

  await doFetch();
}

// handy if you want to pre-seed from step 2 later:
window.seedOnboard = (email, website)=>{
  localStorage.setItem("onboard", JSON.stringify({email, website}));
};
</script>
</body>
</html>