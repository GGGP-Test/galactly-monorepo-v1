<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly ‚Äî Find real packaging buyers</title>

<!--
  index.html (v2 hot-lead model)
  - Auto API detection (no user input)
  - /api/classify fallback logic
  - One-liner = warm lead
  - ‚ÄúShow advanced‚Äù = hot-lead controls (top 10% buyers)
  - No demo sliders; dynamic metrics from classify()
  - Operations not optional
-->

<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel-2:#0e141c;
    --muted:#8aa0b2; --text:#e9f1f7; --brand:#8ae3ff;
    --cta:#6de1ff; --ctaText:#082433; --chip:#1a2433;
    --chipActive:#103247; --accent:#38e08f; --divider:#1b2531; --ring:#24435f;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  .hero{min-height:100vh;display:grid;place-items:center;padding:4rem 1rem;background: radial-gradient(1200px 600px at 50% -200px, #102132 0, transparent 70%); position:relative; z-index:0}
  .hero-inner{max-width:920px;text-align:center}
  h1{font-size:clamp(32px,6vw,56px);margin:0 0 12px}
  p.lead{color:var(--muted);margin:0 0 28px}
  .btn{display:inline-flex;align-items:center;gap:.6rem;padding:12px 18px;border-radius:12px;background:var(--cta);color:var(--ctaText);font-weight:700;border:none;cursor:pointer; position:relative; z-index:2}
  .btn.sec{background:#152333;color:#cfe0ee}
  .btn:active{transform:translateY(1px)}
  .pill{padding:6px 10px;border-radius:999px;background:#0d1a26;color:#8fb0c6;font-size:12px;display:inline-block}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .modal.show{display:flex}
  .card{width:min(980px,92vw);background:var(--panel);border:1px solid var(--divider);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
  .card-hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;background:linear-gradient(180deg,#0f1622,#0e1520);border-bottom:1px solid var(--divider)}
  .steps{display:flex;gap:8px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#2a3444}
  .dot.on{background:#5bd0ff}
  .api-badge{font-size:12px;padding:4px 8px;border-radius:10px;border:1px solid var(--divider);color:#a8c3d8}
  .api-badge.ok{color:#0f0}
  .api-badge.err{color:#ff8}

  .card-bd{padding:18px}
  .card-ft{display:flex;justify-content:flex-end;gap:10px;padding:14px 18px;border-top:1px solid var(--divider)}
  .scroll{max-height:70vh;overflow:auto;padding:6px 6px}

  /* inputs */
  .field{margin:10px 0}
  label{display:block;font-size:13px;color:#9abbcc;margin:0 0 6px}
  input[type=text],input[type=email],input[type=tel]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:#var(--text);outline:none}
  input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}

  /* summary (sentence) */
  .summary{display:flex;gap:12px;background:#0e1622;border:1px solid var(--divider);padding:12px 14px;border-radius:14px;margin:0 0 14px;align-items:flex-start}
  .fav{width:24px;height:24px;border-radius:6px;display:grid;place-items:center;overflow:hidden;flex:0 0 auto;background:#fff;border:1px solid #cfd8e3}
  .fav img{width:24px;height:24px;filter:saturate(1.05) contrast(1.05)}
  .one{font-weight:700}
  .one-line{line-height:1.8}
  .token{display:inline-block;border-radius:8px;padding:2px 6px;margin:0 2px}
  .token[data-lock="true"]{background:transparent;color:#dfeaf5;border:0}
  .sentence{--bgx:#0f1926}
  .sentence .token[data-editable="true"]{background:transparent;border-bottom:1px dashed #3a5572}
  .sentence.editing .token[data-editable="true"]{background:var(--bgx);border:1px solid #2b425a}
  .sentence .token:focus{outline:2px solid var(--ring)}
  .edit-actions{display:flex;gap:8px;margin-top:6px}
  .big-edit{padding:6px 10px;border-radius:10px;background:#172839;border:1px solid #274059;color:#d8e8f7;font-weight:600;cursor:pointer}
  .big-edit.primary{background:var(--cta);border:none;color:#06293a}

  /* groups */
  .group{background:#0f1724;border:1px solid var(--divider);border-radius:14px;padding:14px;margin:14px 0}
  .group h4{margin:0 0 8px}
  .muted-hint{font-size:12px;color:#99b2c8;margin-left:8px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipActive);color:#eaf7ff;border-color:#1b4862}

  /* sliders */
  .slider-row{display:grid;grid-template-columns:1fr 280px;gap:16px;align-items:center;margin:10px 0}
  .slider-row input[type=range]{width:100%}

  .x{background:transparent;color:#9fb3c6;border:none;font-size:18px;cursor:pointer}
  .gear{display:none}
  @media (max-width:800px){.slider-row{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <h1>Find real packaging buyers.</h1>
      <p class="lead">Laser-targeted leads, tuned to your strengths.</p>
      <button id="cta" type="button" class="btn"><span>‚ú®</span> Get qualified leads free</button>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="card" role="document">
      <div class="card-hd">
        <div class="steps" aria-label="Steps">
          <span class="dot on" data-step-dot="0"></span>
          <span class="dot" data-step-dot="1"></span>
          <span class="dot" data-step-dot="2"></span>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <span id="apiBadge" class="api-badge">API: resolving‚Ä¶</span>
          <button id="close" class="x" aria-label="Close">‚úï</button>
        </div>
      </div>

      <div class="card-bd">
        <div class="scroll">

          <!-- STEP 1 -->
          <section class="step" id="step1">
            <div class="pill">Get set up in 60 seconds</div>
            <h2 style="margin:10px 0 14px;">Pick your side</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div id="opt-supplier" class="chip active">üôå I sell packaging (Supplier)</div>
                <div id="opt-buyer" class="chip">üõí I buy packaging (Buyer)</div>
              </div>
            </div>
          </section>

          <!-- STEP 2 -->
          <section class="step" id="step2" hidden>
            <div class="pill">Step 2 of 3</div>
            <h2 style="margin:10px 0 14px;">Tell us who you are</h2>
            <div class="group">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
                <div>
                  <div class="field">
                    <label>Your name</label>
                    <input id="name" type="text" autocomplete="name" placeholder="e.g., Sam Carter">
                  </div>
                  <div class="field">
                    <label>Phone (required for alerts) *</label>
                    <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="+1 555 123 4567"/>
                    <div style="color:#9ab0c0;font-size:12px">Country code helps us personalize geography (e.g., ‚Äú+1‚Äù for U.S.).</div>
                  </div>
                </div>
                <div>
                  <div class="field">
                    <label>Business email *</label>
                    <input id="email" type="email" autocomplete="email" placeholder="you@yourcompany.com" required/>
                  </div>
                  <div class="field">
                    <label>Website / Domain (auto from email)</label>
                    <input id="host" type="text" inputmode="url" placeholder="yourcompany.com"/>
                    <div style="color:#9ab0c0;font-size:12px">Auto-filled from your email as you type. You can edit.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="group" style="display:flex;align-items:center;justify-content:space-between">
              <div id="apiStatus" style="color:#9ab0c0">API: resolving‚Ä¶</div>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input id="skipVerify" type="checkbox" checked> I‚Äôm just testing (skip verification)
              </label>
            </div>
          </section>

          <!-- STEP 3 -->
          <section class="step" id="step3" hidden>
            <div class="pill">Step 3 of 3</div>

            <!-- one-liner (warm lead) -->
            <div class="summary">
              <div class="fav"><img id="fav" alt="" width="24" height="24" referrerpolicy="no-referrer"></div>
              <div style="flex:1">
                <div id="sentence" class="one one-line sentence" aria-live="polite"></div>
                <div class="edit-actions">
                  <button id="editLine" class="big-edit" type="button">Edit</button>
                  <button id="doneLine" class="big-edit primary" type="button" hidden>Done</button>
                  <a id="refresh" href="#" class="big-edit" style="background:#142133;border-color:#25384b;color:#a9c3d8">Refresh from website</a>
                  <span id="status" class="muted-hint"></span>
                </div>
              </div>
            </div>

            <!-- Advanced (hot leads) collapsed by default -->
            <button id="advToggle" class="btn sec" type="button" style="padding:8px 12px;border-radius:999px;margin-bottom:8px">
              <span id="advLbl">Show advanced ‚ñæ</span>
            </button>

            <div id="advanced" hidden>
              <!-- Buyer priorities -->
              <div class="group" id="grp-priorities">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <h4 style="margin:0">Buyer priorities ‚Äî <span style="font-weight:600">for your top 10% buyers</span></h4>
                  <div class="muted-hint">We weight hot leads by these (0‚Äì10).</div>
                </div>
                <div id="metricsBox"></div>
              </div>

              <!-- Operations (not optional) -->
              <div class="group" id="grp-ops">
                <h4 style="margin:0 0 8px">Buyer operations</h4>
                <div id="opsChips" class="chips"></div>
                <div id="opsSliders"></div>
                <div class="muted-hint">Click to add; each selected operation gets its own importance slider.</div>
              </div>

              <!-- Targeting -->
              <div class="group" id="grp-targeting">
                <h4 style="margin:0 0 8px">Buyer targeting</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                  <div>
                    <label>Find buyers near‚Ä¶</label>
                    <input id="city" type="text" placeholder="e.g., New Jersey">
                    <div id="cityChips" class="chips" style="margin-top:6px"></div>
                    <div style="color:#9ab0c0;font-size:12px">We‚Äôll boost leads near this city.</div>
                  </div>
                  <div>
                    <label>Buyers in these sectors</label>
                    <input id="sectors" type="text" placeholder="e.g., food, beverage, logistics">
                    <div id="sectorChips" class="chips" style="margin-top:6px"></div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="card-ft">
          <button id="back" class="btn sec" type="button">Back</button>
          <button id="next" class="btn" type="button">Next</button>
        </div>
      </div>
    </div>
  </div>

<script>
(()=>{
  // ---------- safe storage ----------
  const getS = (k,d="")=>{try{const v=localStorage.getItem(k);return v===null?d:v}catch{return d}};
  const setS = (k,v)=>{try{localStorage.setItem(k,v)}catch{}};

  // ---------- API discovery (no user input) ----------
  const api = {
    base: "",
    async detect(){
      const hints = [];
      if (typeof window.API_BASE==="string") hints.push(window.API_BASE);
      const saved = getS("apiBase","");
      if (saved) hints.push(saved);
      const rel = location.origin + "/api";
      hints.push(rel);
      hints.push(location.origin);
      for (const h of hints){
        const b = (h||"").replace(/\/+$/,"");
        try{
          const r = await fetch(b + "/ping?t="+Date.now(), {credentials:"omit"});
          if (r.ok){ this.base=b; return {ok:true,base:b}; }
        }catch{}
      }
      this.base = hints[0] ? (hints[0].replace(/\/+$/,"")) : rel;
      return {ok:false,base:this.base};
    },
    classifyURL(){
      const b=this.base||"";
      return /\/api$/.test(b) ? (b+"/classify") : (b+"/api/classify");
    }
  };

  // ---------- Elements ----------
  const modal=document.getElementById("modal");
  const openBtn=document.getElementById("cta");
  const closeBtn=document.getElementById("close");
  const backBtn=document.getElementById("back");
  const nextBtn=document.getElementById("next");
  const dots=[...document.querySelectorAll("[data-step-dot]")];
  const apiBadge=document.getElementById("apiBadge");
  const apiStatus=document.getElementById("apiStatus");

  const optSupplier = document.getElementById("opt-supplier");
  const optBuyer    = document.getElementById("opt-buyer");

  const emailEl=document.getElementById("email");
  const hostEl =document.getElementById("host");
  const phoneEl=document.getElementById("phone");

  const favImg=document.getElementById("fav");
  const sentence=document.getElementById("sentence");
  const editBtn=document.getElementById("editLine");
  const doneBtn=document.getElementById("doneLine");
  const refreshA=document.getElementById("refresh");
  const statusEl=document.getElementById("status");

  const adv=document.getElementById("advanced");
  const advToggle=document.getElementById("advToggle");
  const advLbl=document.getElementById("advLbl");

  const metricsBox=document.getElementById("metricsBox");
  const opsChips=document.getElementById("opsChips");
  const opsSliders=document.getElementById("opsSliders");
  const cityEl=document.getElementById("city");
  const sectorsEl=document.getElementById("sectors");
  const cityChips=document.getElementById("cityChips");
  const sectorChips=document.getElementById("sectorChips");

  // ---------- State ----------
  const state={
    step:0, role:"supplier",
    apiOnline:false,
    line:{host:"yourcompany.com",verb:"supplies",products:"packaging",audience:"brands",region:"the U.S.",contacts:"Operations, Procurement"},
    metrics:[],              // [{label, value}]
    opsPool:[],              // chip list
    opsSelected:new Map(),   // label => value
    sectorHints:[],
    productTags:[]
  };

  // ---------- utils ----------
  const normHost=h=>(h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,"");
  const domainFromEmail=e=>{const m=(e||"").toLowerCase().match(/@([a-z0-9.-]+)/);return m?m[1]:""};
  function setFavicon(host){const h=normHost(host);favImg.src = h?("https://icons.duckduckgo.com/ip3/"+encodeURIComponent(h)+".ico"):"";}

  function show(step){
    state.step=step;
    ["#step1","#step2","#step3"].forEach((id,i)=>{const el=document.querySelector(id);if(el){el.hidden=i!==step; dots[i].classList.toggle("on", i===step);}});
    backBtn.style.visibility= step===0? "hidden":"visible";
    nextBtn.textContent = step===2? "Finish":"Next";
  }
  function open(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); show(0); }
  function close(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); }

  // sentence render/edit
  function renderSentence(editing=false){
    const L=state.line;
    const tpl=[
      {k:"host", txt:L.host, lock:true},
      {txt:"‚Äî", lock:true},
      {k:"verb", txt:L.verb},
      {k:"products", txt:L.products},
      {txt:"for", lock:true},
      {k:"audience", txt:L.audience},
      {txt:"in", lock:true},
      {k:"region", txt:L.region},
      {txt:".", lock:true},
      {txt:"Best contacts:", lock:true},
      {k:"contacts", txt:L.contacts}
    ];
    sentence.classList.toggle("editing", editing);
    sentence.innerHTML="";
    for (const part of tpl){
      const span=document.createElement("span");
      span.className="token";
      span.dataset.lock = part.lock?"true":"false";
      if (!part.lock){
        span.dataset.editable="true";
        span.contentEditable = editing;
        span.addEventListener("input",()=>{ state.line[part.k]=span.textContent.trim(); });
      }
      span.textContent=part.txt;
      sentence.appendChild(span);
      sentence.appendChild(document.createTextNode(" "));
    }
  }

  editBtn.addEventListener("click",()=>{renderSentence(true);editBtn.hidden=true;doneBtn.hidden=false;});
  doneBtn.addEventListener("click",()=>{renderSentence(false);editBtn.hidden=false;doneBtn.hidden=true;});

  // adv toggle (start collapsed)
  advToggle.addEventListener("click",(e)=>{
    e.preventDefault();
    const open = adv.hasAttribute("hidden");
    if (open){ adv.removeAttribute("hidden"); advLbl.textContent="Hide advanced ‚ñ≤"; }
    else { adv.setAttribute("hidden",""); advLbl.textContent="Show advanced ‚ñæ"; }
  });

  // role
  function setRole(r){ state.role=r; optSupplier.classList.toggle("active", r==="supplier"); optBuyer.classList.toggle("active", r==="buyer"); }
  optSupplier.addEventListener("click",()=>setRole("supplier"));
  optBuyer.addEventListener("click",()=>setRole("buyer"));

  // email ‚Üí domain
  function syncDomain(){ const d=domainFromEmail(emailEl.value); if (d) hostEl.value=d; }
  emailEl.addEventListener("input",syncDomain);
  emailEl.addEventListener("change",syncDomain);
  setTimeout(syncDomain,120);

  // chips helper
  function addChip(text, box, onToggle){
    const s=document.createElement("span"); s.className="chip"; s.textContent=text;
    s.addEventListener("click",()=>{ s.classList.toggle("active"); onToggle && onToggle(s.classList.contains("active"), text, s); });
    box.appendChild(s);
  }

  // metrics render (AI-suggested labels)
  function renderMetrics(labels){
    metricsBox.innerHTML="";
    state.metrics = (labels||[]).slice(0,16).map(l=>({label:l, value:7}));
    for (const m of state.metrics){
      const row=document.createElement("div"); row.className="slider-row";
      const lab=document.createElement("div"); lab.textContent=m.label;
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=m.value;
      input.addEventListener("input",()=>{ m.value=Number(input.value); });
      row.appendChild(lab); row.appendChild(input);
      metricsBox.appendChild(row);
    }
  }

  // operations pool ‚Üí chips + slider on select
  function renderOpsPool(list){
    opsChips.innerHTML=""; opsSliders.innerHTML=""; state.opsSelected = new Map(); // clear selection to avoid leakage
    const ensureSlider = (label)=>{
      if (state.opsSelected.has(label)) return;
      const wrap=document.createElement("div"); wrap.className="slider-row"; wrap.dataset.label=label;
      const lab=document.createElement("div"); lab.textContent=label;
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value="7";
      input.addEventListener("input",()=>state.opsSelected.set(label, Number(input.value)));
      wrap.appendChild(lab); wrap.appendChild(input); opsSliders.appendChild(wrap);
      state.opsSelected.set(label, 7);
    };
    const removeSlider = (label)=>{
      const el=opsSliders.querySelector('[data-label="'+CSS.escape(label)+'"]');
      if (el) el.remove(); state.opsSelected.delete(label);
    };
    list.forEach(l=> addChip(l, opsChips, (on,text)=> on? ensureSlider(text):removeSlider(text)));
  }

  // heuristics ‚Üí labels from server data
  function deriveHotMetrics(data){
    const text = ((data.summary||"")+" "+(data.productTags||[]).join(" ")+" "+(data.evidence||[]).join(" ")).toLowerCase();
    const out=new Set();

    if (/stretch|shrink|pallet|film|wrap/.test(text)){
      out.add("Hand pallet wrapping");
      out.add("Automated pallet wrapper readiness");
      out.add("Load stability / puncture resistance");
      out.add("Gauge optimization vs break risk");
      out.add("Weekly pallet throughput");
      out.add("COF / cling requirements");
    }

    if (/e-?com|fulfill|3pl|distribution|warehouse/i.test(text)){
      out.add("E-commerce fulfillment compatibility");
      out.add("3PL / distribution integration");
      out.add("Warehouse pick/pack flow");
      out.add("Cold-chain handling (if needed)");
    }

    if (/food|beverage|fda|barrier|oxygen|moisture|foil/.test(text)){
      out.add("Food-contact compliance (FDA/EC)");
      out.add("Moisture / oxygen barrier needs");
      out.add("Lot traceability & COA");
    }

    out.add("Automation line uptime impact");
    out.add("Damage reduction targets in transit");
    out.add("Vendor-managed inventory flexibility");
    out.add("Sustainability targets (PCR %, recyclability)");
    out.add("Unit cost at target MOQ");

    return [...out];
  }

  function deriveOperations(data){
    const ops=new Set([
      "Hand pallet wrapping",
      "Automated pallet wrapper",
      "E-commerce fulfillment",
      "Warehouse pick/pack",
      "3PL / distribution",
      "Cold-chain handling",
      "Co-packing"
    ]);
    const txt=((data.summary||"")+" "+(data.evidence||[]).join(" ")).toLowerCase();
    if (!/cold/.test(txt)) ops.delete("Cold-chain handling");
    return [...ops];
  }

  // classify fetch with robust base
  async function classify(host, email){
    const url = api.classifyURL() + "?host="+encodeURIComponent(host)+"&email="+encodeURIComponent(email||"");
    try{
      const r = await fetch(url, {credentials:"omit"});
      if (!r.ok){ throw new Error(String(r.status)+" "+(await r.text().catch(()=>r.statusText))); }
      return await r.json();
    }catch(e){
      const b=api.base.replace(/\/+$/,"");
      const alt = /\/api$/.test(b) ? (b.replace(/\/api$/,"")+"/api/classify") : (b+"/classify");
      const r2= await fetch(alt+"?host="+encodeURIComponent(host)+"&email="+encodeURIComponent(email||""), {credentials:"omit"});
      if (!r2.ok) throw new Error(String(r2.status)+" "+(await r2.text().catch(()=>r2.statusText)));
      return await r2.json();
    }
  }

  // reset UI/state when host changes to prevent leakage
  let _lastHostKey = "";
  function resetForHost(host){
    const key = normHost(host);
    if (key === _lastHostKey) return;
    _lastHostKey = key;
    metricsBox.innerHTML=""; state.metrics=[];
    opsChips.innerHTML=""; opsSliders.innerHTML=""; state.opsSelected = new Map();
    sectorChips.innerHTML=""; cityChips.innerHTML="";
  }

  function applyServerPersona(data, host){
    const prods = (data.productTags||[]).slice(0,5).join(", ") || "packaging";
    const segs  = (data.sectorHints||[]).slice(0,3).join(", ") || "brands";
    const contacts = /ops|operation|procure|plant|warehouse|supply|logistics/i.test(((data.summary||"")+" "+(data.productTags||[]).join(",")).toLowerCase())
      ? "Operations, Procurement" : "Procurement, Marketing";
    state.line = { host, verb:"supplies", products:prods, audience:segs, region:"the U.S.", contacts };
    state.productTags = data.productTags||[];
    state.sectorHints = data.sectorHints||[];
    renderSentence(false);

    const labels = deriveHotMetrics(data);
    renderMetrics(labels);

    const opsList = deriveOperations(data);
    renderOpsPool(opsList);

    sectorChips.innerHTML="";
    (data.sectorHints||["food","beverage","logistics"]).slice(0,8).forEach(s=>addChip(s, sectorChips));
  }
    async function refreshFromWebsite(){
    const host = normHost(hostEl.value || domainFromEmail(emailEl.value));
    if (!host) return;

    resetForHost(host);
    setFavicon(host);
    statusEl.textContent = "";

    try{
      // seed line with host so the one-liner never looks empty
      state.line.host = host;
      renderSentence(false);

      const data = await classify(host, emailEl.value||"");
      applyServerPersona(data, host);
      statusEl.textContent = data.cached ? "(cached)" : "";
    }catch(err){
      console.warn("classify failed:", err);
      statusEl.textContent = " (offline)";
      // conservative defaults so UI is still usable
      renderMetrics([
        "Automation line uptime impact",
        "Damage reduction targets in transit",
        "Sustainability targets (PCR %, recyclability)",
        "Unit cost at target MOQ"
      ]);
      renderOpsPool([
        "E-commerce fulfillment",
        "Warehouse pick/pack",
        "3PL / distribution",
        "Co-packing"
      ]);
    }
  }

  refreshA.addEventListener("click",(e)=>{ e.preventDefault(); refreshFromWebsite(); });

  // ---------- nav ----------
  openBtn.addEventListener("click", open);
  closeBtn.addEventListener("click", close);

  backBtn.addEventListener("click", ()=> show(Math.max(0, state.step-1)));

  nextBtn.addEventListener("click", async ()=>{
    if (state.step===0){
      show(1);
      return;
    }

    if (state.step===1){
      if (!emailEl.value || !phoneEl.value){
        alert("Business email and phone are required.");
        return;
      }
      const hostCandidate = normHost(hostEl.value || domainFromEmail(emailEl.value));
      if (!hostCandidate){
        alert("Please provide your website/domain.");
        return;
      }
      hostEl.value = hostCandidate;
      await refreshFromWebsite();
      show(2);
      return;
    }

    if (state.step===2){
      if (state.opsSelected.size===0){
        alert("Pick at least one buyer operation (and set its importance).");
        return;
      }

      const host = normHost(state.line.host);
      const persona = {
        host,
        role: state.role,
        line: state.line,
        productTags: state.productTags,
        sectorHints: state.sectorHints,
        metrics: state.metrics, // [{label,value}]
        operations: Array.from(state.opsSelected.entries()).map(([label,value])=>({label,value})),
        targeting: {
          city: (cityEl.value||"").trim(),
          sectors: (sectorsEl.value||"").trim(),
          citiesPicked: Array.from(cityChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim()),
          sectorsPicked: Array.from(sectorChips.querySelectorAll(".chip.active")).map(x=>x.textContent.trim())
        }
      };

      // persist for the free panel
      setS("bf.persona", JSON.stringify(persona));
      setS("fp.persona", JSON.stringify(persona));

      // legacy seeds the panel already understands
      setS("fp.supplier.host", host);
      setS("fp.pref.city", persona.targeting.city);
      setS("fp.pref.tagPrefer", (persona.productTags||[]).join("\n"));
      setS("fp.pref.segPrefer", (persona.sectorHints||[]).join("\n"));
      setS("fp.autoImport","1");

      // go
      location.href = "free-panel.html";
    }
  });

  // Enter-to-advance / Escape-to-close
  modal.addEventListener("keydown",(e)=>{
    if (e.key==="Escape"){ e.preventDefault(); close(); return; }
    if (e.key==="Enter"){
      const tag=(e.target&&e.target.tagName)||"";
      if (tag==="INPUT" || tag==="TEXTAREA" || tag==="A" || tag==="BUTTON") return;
      e.preventDefault(); nextBtn.click();
    }
  });

  // ---------- targeting seeds ----------
  function seedTargeting(){
    const cityList=["New Jersey","Chicago","Los Angeles","New York","Dallas","Atlanta","Miami"];
    cityChips.innerHTML="";
    cityList.forEach(c=>addChip(c, cityChips));

    const sectorList=["food","beverage","logistics","electronics","automotive","industrial","apparel","pharma","cosmetics","household"];
    sectorChips.innerHTML="";
    sectorList.forEach(s=>addChip(s, sectorChips));
  }

  // ---------- boot ----------
  async function boot(){
    // discover API
    const res = await api.detect();
    state.apiOnline = !!res.ok;
    setS("apiBase", api.base);
    const badgeTxt = state.apiOnline ? "API: online" : "API: offline";
    apiBadge.textContent = badgeTxt;
    apiBadge.classList.toggle("ok", state.apiOnline);
    apiBadge.classList.toggle("err", !state.apiOnline);
    if (apiStatus) apiStatus.textContent = badgeTxt;

    // base UI
    setRole("supplier");
    renderSentence(false);
    seedTargeting();

    // if browser already filled email, backfill host
    const d=domainFromEmail(emailEl.value); if (d) hostEl.value=d;
  }

  // start
  boot();

  // expose manual hook for debugging
  window.__refreshFromWebsite = refreshFromWebsite;

})();</script>
</body>
</html>