<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leads Console — Free Panel (V3)</title>
<!-- silence favicon 404 -->
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0e1520; --panel:#121a26; --muted:#8aa0b3; --text:#e6eef7; --accent:#3aa3ff;
    --ok:#2ecc71; --warn:#f1c40f; --bad:#ff5c5c; --pill:#1b2636; --border:#223046;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  .page{
    max-width:1200px; margin:0 auto; padding:16px;
    display:grid; grid-template-columns: 380px 1fr; gap:16px;
  }
  @media (max-width: 980px){ .page{grid-template-columns:1fr} }

  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:10px;
    padding:14px; box-shadow:0 0 0 1px #00000022 inset;
  }
  h1{font-size:18px; margin:0 0 10px 0}
  label{display:block; color:var(--muted); margin:10px 0 6px}
  input, select, textarea, button{
    width:100%; border-radius:8px; border:1px solid var(--border);
    background:#0c131d; color:var(--text); padding:10px 12px;
  }
  input::placeholder, textarea::placeholder{color:#6c8093}
  button{
    background:var(--pill); cursor:pointer; transition:background .15s, border-color .15s;
  }
  button:hover{background:#223146}
  .row{display:grid; grid-template-columns: 1fr auto; gap:8px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px}
  .btn-primary{background:var(--accent); border-color:#1e72c2}
  .pill{display:inline-block; background:var(--pill); padding:4px 8px; border-radius:999px; color:#b9c9d9; font-size:12px; margin-right:6px}
  .muted{color:var(--muted)}
  .split{display:flex; gap:8px}
  .split > *{flex:1}
  .right{ text-align:right }

  table{width:100%; border-collapse:collapse}
  thead th{
    position:sticky; top:0; background:var(--panel); z-index:1;
    text-align:left; padding:10px; font-weight:600; border-bottom:1px solid var(--border);
  }
  tbody td{padding:10px; border-bottom:1px solid var(--border); vertical-align:top}
  tbody tr:hover{background:#0f1724}
  .temp-warm{color:#ffd479}
  .temp-hot{color:#ff8a5b}

  .log{height:140px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; resize:vertical}
  .mini{font-size:12px}

  .toolbar{display:flex; gap:8px}
  .toolbar > *{flex:1}

  .bad{color:var(--bad)}
  .ok{color:var(--ok)}

  /* modal */
  .modal-back{
    position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center;
  }
  .modal{ width:min(920px, calc(100vw - 40px)); max-height:80vh; background:#0e1520; border:1px solid var(--border); border-radius:10px; overflow:hidden; box-shadow:0 8px 40px #000c }
  .modal header{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#111a29; border-bottom:1px solid var(--border)}
  .modal header h3{margin:0; font-size:14px}
  .modal header button{width:auto; padding:6px 10px}
  .modal pre{margin:0; padding:12px; overflow:auto; max-height:calc(80vh - 46px); color:#cfe1f7}
</style>
</head>
<body>
  <div class="page">
    <!-- LEFT: controls -->
    <div class="card" id="panel">
      <h1>Leads Console — Free Panel (V3)</h1>

      <label>API base</label>
      <div class="row">
        <input id="base" placeholder="https://p01--your-app.code.run" />
        <button id="apply" class="btn-primary" style="width:110px">Apply</button>
      </div>

      <div class="grid-3">
        <button id="health" title="GET /healthz">Health</button>
        <button id="probe"  title="Find viable root + paths">Probe</button>
        <button id="clear"  title="Clear results">Clear list</button>
      </div>

      <label>API key <span class="muted mini">(optional for read; required for write)</span></label>
      <div class="row">
        <input id="key" placeholder="paste key" />
        <button id="saveKey" style="width:110px">Save</button>
      </div>

      <div style="margin-top:10px">
        <span id="healthBadge" class="pill muted">health: unknown</span>
        <span id="routesBadge" class="pill muted">routes: (tap Probe)</span>
        <span id="rootBadge" class="pill muted">root: (auto)</span>
        <span id="lastBadge" class="pill muted">last OK: —</span>
      </div>

      <hr style="border:none; border-top:1px solid var(--border); margin:14px 0">

      <label>Action</label>
      <select id="action">
        <option value="find-buyers" selected>Find buyers (one per click)</option>
        <option value="find-one">Find one (strict)</option>
      </select>

      <label>Supplier host</label>
      <input id="host" placeholder="example.com" />

      <div class="grid-2">
        <select id="region">
          <option value="US/CA">US/CA</option>
          <option value="US/NY">US/NY</option>
          <option value="US/TX">US/TX</option>
          <option value="US/FL">US/FL</option>
        </select>
        <select id="radius">
          <option>25 mi</option><option selected>50 mi</option><option>100 mi</option><option>250 mi</option>
        </select>
      </div>

      <label>Path for action <span class="muted mini">(relative to API root)</span></label>
      <div class="grid-3">
        <input id="path" placeholder="/leads/find-buyers" />
        <select id="method">
          <option value="GET">GET</option>
          <option value="POST">POST</option>
        </select>
        <select id="fallbacks" title="Fallback strategy">
          <option value="none">No fallbacks</option>
          <option value="auto" selected>Auto-probe</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px">
        <div></div>
        <button id="find" class="btn-primary" style="width:140px">Find buyers</button>
      </div>

      <label style="margin-top:12px">HTTP log</label>
      <textarea id="log" class="log" readonly></textarea>

      <div class="toolbar" style="margin-top:10px">
        <button id="dlHot">Download CSV (hot)</button>
        <button id="dlWarm">Download CSV (warm)</button>
      </div>
    </div>

    <!-- RIGHT: results -->
    <div class="card">
      <div class="split" style="align-items:center; margin-bottom:6px">
        <div class="muted mini" id="count">0 items</div>
        <div class="right mini muted" id="hint"></div>
      </div>
      <div style="max-height:72vh; overflow:auto; border:1px solid var(--border); border-radius:8px">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Host</th>
              <th style="width:120px">Platform</th>
              <th>Title</th>
              <th style="width:170px">Created</th>
              <th style="width:70px">Temp</th>
              <th>Why (human-readable)</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JSON modal -->
  <div id="mb" class="modal-back" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3 id="mh">Result</h3>
        <button id="mc">Close</button>
      </header>
      <pre id="mp"></pre>
    </div>
  </div>

<script>
(function(){
  const UI = {
    base: qs('#base'), apply: qs('#apply'),
    health: qs('#health'), probe: qs('#probe'), clear: qs('#clear'),
    key: qs('#key'), saveKey: qs('#saveKey'),
    healthBadge: qs('#healthBadge'), routesBadge: qs('#routesBadge'),
    rootBadge: qs('#rootBadge'), lastBadge: qs('#lastBadge'),
    action: qs('#action'), host: qs('#host'), region: qs('#region'), radius: qs('#radius'),
    path: qs('#path'), method: qs('#method'), fallbacks: qs('#fallbacks'),
    find: qs('#find'),
    log: qs('#log'),
    rows: qs('#rows'), count: qs('#count'), hint: qs('#hint'),
    dlHot: qs('#dlHot'), dlWarm: qs('#dlWarm'),
    mb: qs('#mb'), mh: qs('#mh'), mp: qs('#mp'), mc: qs('#mc')
  };

  const S = {
    base: '', root: '', key: '',
    items: [],
    raw: [],
    routes: [],
    findTriedOnce: false
  };

  const store = {
    get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
  };

  // ---------- boot ----------
  (function boot(){
    S.base = store.get('base',''); UI.base.value = S.base;
    S.root = store.get('root',''); updateRootBadge();
    S.key = store.get('key',''); UI.key.value = S.key || '';
    UI.host.value = store.get('host','peekpackaging.com');
    UI.region.value = store.get('region','US/CA');
    UI.radius.value = store.get('radius','50 mi');
    UI.action.value = store.get('action','find-buyers');
    UI.path.value = store.get('path', defaultPathFor(UI.action.value));
    UI.method.value = store.get('method','GET');
    UI.fallbacks.value = store.get('fallbacks','auto');
    UI.find.textContent = labelForAction(UI.action.value);
    render();
  })();

  // ---------- helpers ----------
  function qs(s,x=document){ return x.querySelector(s) }
  function now(){ return new Date().toTimeString().slice(0,8) }
  function log(line){
    UI.log.value += (UI.log.value ? '\n' : '') + `[${now()}] ${line}`;
    UI.log.scrollTop = UI.log.scrollHeight;
  }
  function setPill(el, txt, cls=''){ el.textContent = txt; el.className = 'pill ' + (cls||'') }
  function updateRootBadge(){ setPill(UI.rootBadge, `root: ${S.root||'(auto)'}`) }
  function withParams(url, params){
    const u = new URL(url);
    for(const [k,v] of Object.entries(params||{})) if(v!==undefined && v!=='') u.searchParams.set(k, v);
    return u.toString();
  }
  function parseRoutes(r){ return Array.isArray(r?.routes) ? r.routes.map(String) : [] }
  function firstMatch(routes, want){
    for(const rx of want){ const hit = routes.find(r=>rx.test(r)); if (hit) return hit }
    return null;
  }
  function defaultPathFor(action){
    return action==='find-one' ? '/buyers/find-one' : '/leads/find-buyers';
  }
  function labelForAction(action){
    return action==='find-one' ? 'Find one' : 'Find buyers';
  }

  async function call(method, path, data){
    const base = S.base?.trim();
    const root = (S.root||'').trim();
    if(!base){ toast('Set API base first', true); throw new Error('no base') }

    const isAbs = /^https?:\/\//i.test(path);
    let url = isAbs ? path : base.replace(/\/+$/,'') + (root? `/${root.replace(/^\/+/,'')}`:'') + '/' + path.replace(/^\/+/,'');
    const init = { method, headers: { 'accept':'application/json'} };

    if (S.key) init.headers['x-api-key'] = S.key;

    if (method === 'GET') url = withParams(url, data);
    else { init.headers['content-type']='application/json'; init.body = JSON.stringify(data||{}); }

    let res, json, ok=false;
    try {
      res = await fetch(url, init);
      const ct = res.headers.get('content-type')||'';
      json = ct.includes('application/json') ? await res.json() : await res.text();
      ok = res.ok;
    } catch(err){
      log(`${res?res.status:'ERR'}  — ${method} ${path}  (${err.message})`);
      throw err;
    }

    log(`${res.status}  — ${method} ${path}${method==='GET' ? ' ' + new URL(url).search : ''}`);
    if (res.status===200 && path.match(/routes$/)){
      const sample = JSON.stringify({ ok: json.ok, routes: (json.routes||[]).slice(0,8) });
      log(`routes sample: ${sample}`);
    }
    return { ok, status: (res && res.status)||0, data: json };
  }

  function toast(msg, bad){
    UI.hint.textContent = msg;
    UI.hint.className = bad ? 'bad mini right' : 'mini muted right';
    log((bad?'✖️ ':'• ') + msg);
  }

  // ---------- health + probe ----------
  async function health(){
    const r = await call('GET','/healthz');
    setPill(UI.healthBadge, `health: ${r.status} — GET /healthz`, r.ok?'ok':'');
    return r.ok;
  }

  async function probe(){
    toast('starting probe for correct root/path…');
    const roots = ['', 'api', 'api/v1'];
    let foundRoot = null, routes = [];

    for(const rt of roots){
      S.root = rt; updateRootBadge();
      const rr = await call('GET', '/routes');
      if (rr.ok && Array.isArray(rr.data?.routes)) {
        foundRoot = rt; routes = parseRoutes(rr.data); break;
      }
    }
    if (!foundRoot){
      setPill(UI.routesBadge, 'routes: (not found)', 'bad'); updateRootBadge();
      toast('probe finished — no routes endpoint', true);
      return false;
    }

    S.root = foundRoot; store.set('root', S.root); updateRootBadge();
    S.routes = routes;
    setPill(UI.routesBadge, `routes: ${routes.length}`, 'ok');

    // try guess path for current action
    const action = UI.action.value;
    const wants = action==='find-one'
      ? [/\/buyers\/find-one$/, /\/leads\/find-one$/, /\/find-one$/]
      : [/\/buyers\/find-buyers$/, /\/leads\/find-buyers$/, /\/find-buyers$/];

    const hit = firstMatch(routes, wants);
    if (hit){
      const rel = hit.replace(new RegExp(`^${S.root||''}`), '');
      UI.path.value = rel.startsWith('/') ? rel : '/' + rel;
      store.set('path', UI.path.value);
      toast(`path guessed → ${UI.path.value}`);
    } else {
      toast('could not guess path from routes', true);
    }
    return true;
  }

  // ---------- find ----------
  async function findOnce(){
    const method = UI.method.value;
    const host = UI.host.value.trim();
    const region = UI.region.value;
    const radius = UI.radius.value;
    const path = UI.path.value.trim() || defaultPathFor(UI.action.value);

    store.set('host',host); store.set('region',region);
    store.set('radius',radius); store.set('path',path); store.set('method',method);

    const r = await call(method, path, { host, region, radius });
    if (!r.ok){
      if (r.status===404) toast('404 — starting probe for correct root/path…'); else toast(`HTTP ${r.status}`, true);
      return r;
    }

    // Normalize results
    let items = [];
    if (Array.isArray(r.data?.items)) items = r.data.items;
    else if (r.data?.item) items = [r.data.item];
    else if (r.data && (r.data.host || r.data.title)) items = [r.data];

    if (items.length){
      for(const it of items){
        S.raw.push(it);
        S.items.push(sanitizeItem(it));
      }
      render();
      setPill(UI.lastBadge, `last OK: ${method} ${path} @ ${(S.root||'root')}`);
    } else {
      toast('no items returned');
    }
    return r;
  }

  function sanitizeItem(x={}){
    const first = Array.isArray(x.matches)? x.matches[0] : x;
    return {
      host: x.host || first?.host || '',
      platform: x.platform || 'web',
      title: x.title || first?.title || 'Buyer lead',
      created: x.created || new Date().toISOString(),
      temp: x.temp || 'warm',
      whyText: x.whyText || `Compat shim matched (${UI.region.value}, ${UI.radius.value})`
    };
  }

  async function find(){
    S.findTriedOnce = false;
    let r = await findOnce();
    if (r.ok) return;

    if (UI.fallbacks.value!=='auto' || r.status!==404) return;

    if (!S.findTriedOnce){
      S.findTriedOnce = true;
      const okProbe = await probe();
      if (!okProbe) return;

      const action = UI.action.value;
      const alts = [];
      const existsInRoutes = (p)=> S.routes.some(r=> r.endsWith(p.replace(/^\/+/,'')));

      const want = action==='find-one'
        ? ['/buyers/find-one','/leads/find-one','/find-one']
        : ['/buyers/find-buyers','/leads/find-buyers','/find-buyers'];

      for(const p of want) if (existsInRoutes(p)) alts.push(p);
      if (!alts.includes(UI.path.value.trim())) alts.unshift(UI.path.value.trim());

      for(const p of alts){
        UI.path.value = p; store.set('path', p);
        r = await findOnce();
        if (r.ok) return;
      }

      UI.method.value = (UI.method.value==='GET' ? 'POST' : 'GET');
      store.set('method', UI.method.value);
      r = await findOnce();
      if (r.ok) return;
    }
  }

  // ---------- render ----------
  function render(){
    UI.rows.innerHTML = '';
    S.items.forEach((x,i)=>{
      const tr = document.createElement('tr');
      tr.dataset.index = String(i);
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${esc(x.host)}</td>
        <td>${esc(x.platform||'web')}</td>
        <td>${esc(x.title||'')}</td>
        <td class="mini">${esc(x.created||'')}</td>
        <td class="${x.temp==='hot'?'temp-hot':'temp-warm'}">${esc(x.temp||'')}</td>
        <td class="mini">${esc(x.whyText||'')}</td>
      `;
      UI.rows.appendChild(tr);
    });
    UI.count.textContent = `${S.items.length} item${S.items.length===1?'':'s'}`;
  }
  function esc(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

  // ---------- CSV ----------
  function toCSV(items){
    const cols = ['host','platform','title','created','temp','whyText'];
    const head = cols.join(',');
    const escv = v=> `"${String(v??'').replace(/"/g,'""')}"`;
    const rows = items.map(it=> cols.map(c=>escv(it[c])).join(','));
    return [head, ...rows].join('\r\n');
  }
  function download(name, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
    a.download = name; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
  }

  // ---------- modal ----------
  function showModal(title, obj){
    UI.mh.textContent = title;
    UI.mp.textContent = JSON.stringify(obj, null, 2);
    UI.mb.style.display = 'flex';
  }
  function hideModal(){ UI.mb.style.display = 'none' }

  // ---------- events ----------
  UI.apply.onclick = ()=>{
    S.base = UI.base.value.trim();
    store.set('base', S.base);
    toast('Base set');
  };
  UI.saveKey.onclick = ()=>{
    S.key = UI.key.value.trim();
    store.set('key', S.key||'');
    toast(S.key ? 'API key saved' : 'API key cleared');
  };
  UI.health.onclick = health;
  UI.probe.onclick = probe;
  UI.clear.onclick = ()=>{ S.items=[]; S.raw=[]; render(); toast('List cleared') };
  UI.find.onclick = find;

  UI.dlHot.onclick = ()=> download('buyers-hot.csv', toCSV(S.items.filter(x=>x.temp==='hot')));
  UI.dlWarm.onclick = ()=> download('buyers-warm.csv', toCSV(S.items));

  UI.action.onchange = ()=>{
    const a = UI.action.value;
    store.set('action', a);
    UI.find.textContent = labelForAction(a);
    if (!UI.path.value || UI.path.value === '/leads/find-buyers' || UI.path.value === '/buyers/find-one'){
      UI.path.value = defaultPathFor(a);
      store.set('path', UI.path.value);
    }
  };

  // row click → JSON modal
  UI.rows.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr'); if (!tr) return;
    const i = Number(tr.dataset.index);
    if (!Number.isFinite(i)) return;
    showModal(`Result #${i+1} — ${S.items[i]?.host||''}`, S.raw[i] ?? S.items[i]);
  });
  UI.mc.onclick = hideModal;
  UI.mb.addEventListener('click', (e)=>{ if (e.target===UI.mb) hideModal() });
  window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') hideModal() });

})();
</script>
</body>
</html>