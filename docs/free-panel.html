<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --text:#e5e7eb;
      --chip:#1f2937; --chipBadge:#374151; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --btn:#2563eb; --btnHover:#1d4ed8; --line:#1f2937;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
      --radius:10px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-size:18px;margin:0 0 10px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{display:flex;gap:8px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:0 0 auto}
    .fill{flex:1 1 auto}
    input,select,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #223;outline:none;border-radius:8px;padding:10px}
    input.small{padding:8px}
    button{background:var(--btn);border:none;color:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#374151}
    button.warn{background:var(--warn);color:#111}
    button.err{background:var(--err)}
    button:hover{background:var(--btnHover)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .pill .badge{padding:2px 6px;border-radius:999px;background:var(--chipBadge);font-weight:600}
    .pill.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25)}
    .pill.warn{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.25)}
    .pill.err{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25)}
    .temp{padding:2px 8px;border-radius:999px;font-weight:700}
    .hot{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .warm{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .muted{color:var(--muted)}
    .list{max-height:62vh;overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{position:sticky;top:0;background:rgba(17,24,39,.95);backdrop-filter:saturate(140%) blur(6px);text-align:left;z-index:1}
    tr:hover td{background:rgba(255,255,255,.02)}
    .why{display:flex;flex-wrap:wrap;gap:6px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .note{font-size:12px;margin-top:4px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .notice{padding:10px 12px;border-radius:8px;background:#0b1220;border:1px dashed #223}
    .error{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4)}
    .success{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.4)}
    .link{color:#93c5fd;text-decoration:none}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .panel{max-width:720px;width:100%;background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
    .modal .panel .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
    .modal .panel .bd{padding:14px}
    .x{cursor:pointer;font-weight:700;color:#9ca3af}
    .icons{display:flex;gap:10px;align-items:center}
    .tip{display:none;position:absolute;background:#0b1220;color:#e5e7eb;border:1px solid #223;border-radius:8px;padding:8px;max-width:280px;font-size:12px;box-shadow:var(--shadow)}
    .icon{cursor:pointer}
    .hint{font-size:12px;color:#9ca3af}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leads Console — Free Panel (V2)</h1>

    <div class="grid">
      <!-- LEFT: Saved (kept) leads -->
      <div class="card">
        <div class="head row">
          <div class="row fill">
            <input id="baseUrl" class="fill" placeholder="Base URL (e.g. https://p01--animated-cellar--xxxxx.code.run)" />
            <button id="apply">Apply</button>
          </div>
          <div class="row fill">
            <input id="apiKey" class="fill" placeholder="API key (optional for read; required for write)" />
            <button id="saveKey" class="secondary">Save</button>
            <button id="onlyUSCA" class="secondary">US/CA only</button>
          </div>
        </div>
        <div class="body row">
          <button id="refreshSaved" class="secondary">Refresh Saved</button>
          <div class="muted mono">Saved = what you locked</div>
          <div class="fill"></div>
          <div class="muted mono">API: <span id="apiPath">/api/v1/leads</span></div>
        </div>
        <div class="list">
          <table id="leads">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th>Host</th>
                <th style="width:120px">Platform</th>
                <th>Title</th>
                <th style="width:120px">Created</th>
                <th style="width:80px">Temp</th>
                <th style="width:28%">Why (human-readable)</th>
              </tr>
            </thead>
            <tbody id="leadRows"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Action + Persona -->
      <div class="card">
        <div class="head"><div class="row"><div class="pill"><span class="badge">Action</span> Find buyers (from supplier)</div></div></div>
        <div class="body">
          <div class="row">
            <input id="supplier" class="fill" placeholder="supplier domain e.g. stretchandshrink.com" />
          </div>
          <div class="row">
            <select id="region" style="width:160px">
              <option value="us">US</option>
              <option value="ca">CA</option>
              <option value="usca" selected>US/CA</option>
            </select>
            <select id="radius" style="width:120px">
              <option value="25">25 mi</option>
              <option value="50" selected>50 mi</option>
              <option value="100">100 mi</option>
              <option value="250">250 mi</option>
            </select>
            <button id="find" style="min-width:120px">Find buyers</button>
          </div>
          <div id="findMsg" class="note muted"></div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Supplier persona</span> (human-editable)</div></div></div>
        <div class="body">
          <div class="split">
            <div>
              <label class="muted">Product/offer</label>
              <input id="p_offer" placeholder="e.g. Stretch film & pallet protection" />
            </div>
            <div>
              <label class="muted">Solves</label>
              <input id="p_solves" placeholder="e.g. Keeps pallets secure for storage/transport" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="p_titles" class="fill" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing Manager, COO" />
            <button id="personaSave" class="secondary">Save persona (local)</button>
          </div>
          <div class="note muted">We’ll use this persona to infer intent automatically. You can tweak wording anytime.</div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Downloads</span> CSV</div></div></div>
        <div class="body row">
          <button id="dlSaved" class="secondary">Download CSV (saved)</button>
        </div>
      </div>
    </div>

    <div id="toast" class="notice" style="margin-top:16px;display:none"></div>
  </div>

  <!-- Lead modal (single-lead per click) -->
  <div id="leadModal" class="modal">
    <div class="panel">
      <div class="hd">
        <div class="row">
          <div class="pill"><span class="badge">Lead</span> <span id="m_host" class="mono"></span></div>
          <div class="pill"><span class="badge">Temp</span> <span id="m_temp" class="temp warm">warm</span></div>
        </div>
        <div class="icons">
          <span id="m_watch" class="muted mono">… suppliers viewing</span>
          <span id="m_comp" class="muted mono">… competing</span>
          <span class="x" id="m_close">✕</span>
        </div>
      </div>
      <div class="bd">
        <div class="why" id="m_why"></div>
        <div class="notice hint" style="margin-top:10px" id="m_whyText"></div>

        <div class="row" style="margin-top:12px; position:relative">
          <button id="m_keep">Lock & keep</button>
          <span class="icon" id="tip_keep">⚠️</span>
          <div class="tip" id="tip_keep_msg">Locking keeps this lead on your list and reduces its visibility to others on our platform.</div>

          <button class="secondary" id="m_more">Deepen results</button>
          <span class="icon" id="tip_more">⚠️</span>
          <div class="tip" id="tip_more_msg">Deepen results = we pull extra public signals (news, jobs, meta) and add more “why” evidence.</div>

          <div class="fill"></div>
          <button class="warn" id="m_next">Find another</button>
        </div>

        <div class="note muted" style="margin-top:10px" id="m_msg"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- tiny helpers ----------
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    const sleep = ms=>new Promise(r=>setTimeout(r,ms));
    const nowISO = ()=>new Date().toISOString();

    function toast(msg, ok=false, err=false){
      const el = $('#toast');
      el.textContent = msg;
      el.className = 'notice ' + (ok?'success':(err?'error':''));
      el.style.display = 'block';
      setTimeout(()=>el.style.display='none', 2500);
    }

    function api(path){
      const base = (S.baseUrl || '').replace(/\/+$/,'');
      return base + path;
    }

    async function call(method, path, body){
      const headers = {'Content-Type':'application/json'};
      if (S.apiKey) headers['x-api-key'] = S.apiKey;
      const r = await fetch(api(path), {method, headers, body: body?JSON.stringify(body):undefined});
      const text = await r.text();
      let data; try{ data = JSON.parse(text) }catch{ data = text }
      return { ok:r.ok, status:r.status, data };
    }

    // ---------- state ----------
    const S = {
      baseUrl: localStorage.getItem('baseUrl') || '',
      apiKey:  localStorage.getItem('apiKey')  || '',
      onlyUSCA: JSON.parse(localStorage.getItem('onlyUSCA')||'true'),
      persona: JSON.parse(localStorage.getItem('persona')||'{"offer":"","solves":"","titles":""}'),

      // UI-state
      saved: JSON.parse(localStorage.getItem('savedLeads')||'[]'), // persisted so typing doesn't clear
      modalLead: null,
      watchTimer: null
    };

    // ---------- UI refs ----------
    const UI = {
      baseUrl: $('#baseUrl'), apiKey: $('#apiKey'), onlyUSCA: $('#onlyUSCA'),
      refreshSaved: $('#refreshSaved'), leadRows: $('#leadRows'),
      region: $('#region'), radius: $('#radius'), supplier: $('#supplier'),
      find: $('#find'), findMsg: $('#findMsg'), toast: $('#toast'),
      p_offer: $('#p_offer'), p_solves: $('#p_solves'), p_titles: $('#p_titles'),
      personaSave: $('#personaSave'), saveKey: $('#saveKey'), apply: $('#apply'),
      dlSaved: $('#dlSaved'),

      modal: $('#leadModal'),
      m_close: $('#m_close'), m_host: $('#m_host'), m_temp: $('#m_temp'),
      m_why: $('#m_why'), m_whyText: $('#m_whyText'),
      m_keep: $('#m_keep'), m_more: $('#m_more'), m_next: $('#m_next'),
      m_msg: $('#m_msg'), m_watch: $('#m_watch'), m_comp: $('#m_comp'),
      tip_keep: $('#tip_keep'), tip_keep_msg: $('#tip_keep_msg'),
      tip_more: $('#tip_more'), tip_more_msg: $('#tip_more_msg')
    };

    // ---------- init ----------
    UI.baseUrl.value = S.baseUrl;
    UI.apiKey.value = S.apiKey;
    UI.onlyUSCA.classList.toggle('warn', !S.onlyUSCA);
    UI.onlyUSCA.textContent = S.onlyUSCA ? 'US/CA only' : 'All regions';
    UI.p_offer.value  = S.persona.offer || '';
    UI.p_solves.value = S.persona.solves || '';
    UI.p_titles.value = S.persona.titles || '';

    // ---------- render ----------
    function nlWhy(why){
      const chips = [];
      if (!why) return chips;
      const add = (obj, fallback)=> {
        if (!obj) return;
        const s = Number.isFinite(obj.score) ? Number(obj.score).toFixed(2) : (obj.score??'');
        chips.push(`<span class="pill">${obj.label || fallback} <span class="badge">${s}</span> <span class="muted">${obj.detail||''}</span></span>`);
      };
      add(why.meta,{label:'Domain quality'});
      add(why.platform,{label:'Platform fit'});
      add(why.signal,{label:'Intent keywords'});
      add(why.context,{label:'Context'});
      return chips;
    }

    function toTableItem(c, i){
      return {
        id: i+1,
        host: c.host || c.domain || '',
        platform: c.source || 'news',
        title: c.title || c.reason || '',
        created: c.created || nowISO(),
        temperature: c.temperature || (typeof c.score==='number' && c.score>=0.65 ? 'hot':'warm'),
        why: c.why || null,
        whyText: c.whyText || c.reason || ''
      };
    }

    function renderSaved(){
      UI.leadRows.innerHTML = '';
      S.saved.forEach((it, i)=>{
        const row = toTableItem(it, i);
        const host = (row.host||'').replace(/^https?:\/\//,'');
        const href = host ? `https://${host}` : '#';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${row.id}</td>
          <td><a class="link mono" href="${href}" target="_blank">${host}</a></td>
          <td>${row.platform||'unknown'}</td>
          <td class="mono">${row.title||''}</td>
          <td>${row.created||''}</td>
          <td><span class="temp ${row.temperature||'warm'}">${row.temperature||'warm'}</span></td>
          <td><div class="why">${nlWhy(row.why).join('')}</div><div class="note muted">${row.whyText||''}</div></td>
        `;
        UI.leadRows.appendChild(tr);
      });
    }

    function saveSaved(){
      localStorage.setItem('savedLeads', JSON.stringify(S.saved));
      renderSaved();
    }

    // ---------- watchers polling ----------
    async function refreshWatchers(host){
      if (!host) return;
      const qp = new URLSearchParams({ host });
      const r = await call('GET', `/api/v1/metrics/watchers?${qp}`);
      if (!r.ok) return;
      const w = r.data?.watchers ?? 1;
      const c = r.data?.competing ?? Math.max(1, Math.floor(w/5));
      UI.m_watch.textContent = `${w} suppliers viewing`;
      UI.m_comp.textContent  = `${c} competing`;
    }

    function startWatchers(host){
      stopWatchers();
      refreshWatchers(host);
      S.watchTimer = setInterval(()=>refreshWatchers(host), 5000);
    }
    function stopWatchers(){
      if (S.watchTimer){ clearInterval(S.watchTimer); S.watchTimer=null; }
    }

    // ---------- modal ----------
    function openModal(lead){
      S.modalLead = lead;
      const host = (lead.host||lead.domain||'').replace(/^https?:\/\//,'');
      UI.m_host.textContent = host || '(unknown)';
      const temp = lead.temperature || (typeof lead.score==='number' && lead.score>=0.65 ? 'hot':'warm');
      UI.m_temp.textContent = temp;
      UI.m_temp.className = 'temp ' + temp;
      UI.m_why.innerHTML = nlWhy(lead.why||{}).join('');
      UI.m_whyText.textContent = lead.whyText || '';
      UI.m_msg.textContent = '';
      UI.modal.style.display = 'flex';
      startWatchers(host);
    }

    function closeModal(){
      UI.modal.style.display = 'none';
      stopWatchers();
      S.modalLead = null;
    }

    // tooltips (simple position near icon)
    function showTip(iconEl, tipEl){
      const r = iconEl.getBoundingClientRect();
      tipEl.style.left = (r.left + window.scrollX + 16) + 'px';
      tipEl.style.top  = (r.top + window.scrollY + 16) + 'px';
      tipEl.style.display = 'block';
      setTimeout(()=>tipEl.style.display='none', 2800);
    }

    // ---------- CSV ----------
    function csv(items){
      const cols = ['host','platform','title','created','temperature','whyText'];
      const head = cols.join(',');
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      const rows = items.map(it=>{
        const row = toTableItem(it,0);
        return cols.map(c=>esc(row[c])).join(',');
      });
      return [head, ...rows].join('\r\n');
    }
    function download(name, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
      a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }

    // ---------- events ----------
    UI.apply.onclick = ()=>{ S.baseUrl = UI.baseUrl.value.trim(); localStorage.setItem('baseUrl', S.baseUrl); toast('Base URL applied', true); };
    UI.saveKey.onclick = ()=>{ S.apiKey = UI.apiKey.value.trim(); localStorage.setItem('apiKey', S.apiKey); toast('API key saved', true); };
    UI.onlyUSCA.onclick = ()=>{ S.onlyUSCA=!S.onlyUSCA; localStorage.setItem('onlyUSCA', JSON.stringify(S.onlyUSCA)); UI.onlyUSCA.classList.toggle('warn', !S.onlyUSCA); UI.onlyUSCA.textContent = S.onlyUSCA ? 'US/CA only' : 'All regions'; };
    UI.refreshSaved.onclick = ()=>renderSaved();
    UI.dlSaved.onclick = ()=> download('leads_saved.csv', csv(S.saved));

    UI.personaSave.onclick = ()=>{
      S.persona = { offer:UI.p_offer.value.trim(), solves:UI.p_solves.value.trim(), titles:UI.p_titles.value.trim() };
      localStorage.setItem('persona', JSON.stringify(S.persona));
      toast('Persona saved locally', true);
    };

    UI.find.onclick = async ()=>{
      const supplier = UI.supplier.value.trim().toLowerCase();
      if (!supplier){ toast('Enter a supplier domain', false, true); return; }
      const body = {
        supplier,
        region: UI.region.value,
        radiusMi: Number(UI.radius.value||'50')||50,
        persona: {
          offer: UI.p_offer.value.trim(),
          solves: UI.p_solves.value.trim(),
          titles: UI.p_titles.value.trim()
        },
        onlyUSCA: S.onlyUSCA
      };
      UI.find.disabled = true;
      UI.findMsg.textContent = 'Finding buyers…';
      const r = await call('POST','/api/v1/leads/find-buyers', body);
      UI.find.disabled = false;

      if (!r.ok){
        // rate-limit 429 shows nice countdown
        if (r.status === 429){
          const ms = r.data?.retryAfterMs ?? 10_000;
          const t0 = Date.now();
          const tick = ()=>{
            const left = Math.max(0, ms - (Date.now()-t0));
            UI.findMsg.innerHTML = `<div class="notice error mono">Slow down. Try again in ${Math.ceil(left/1000)}s.</div>`;
            if (left>0) setTimeout(tick, 200);
          };
          tick();
        } else {
          UI.findMsg.innerHTML = `<div class="notice error mono">HTTP ${r.status} — ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}</div>`;
        }
        return;
      }

      const list = Array.isArray(r.data?.candidates) ? r.data.candidates : [];
      if (!list.length){
        UI.findMsg.innerHTML = `<div class="notice error mono">No candidates found. Try widening radius or switching region.</div>`;
        return;
      }
      // pick ONE for modal
      const lead = list[0];
      UI.findMsg.innerHTML = `<div class="notice success mono">Found 1 candidate. Check the popup to lock or get another.</div>`;
      openModal(lead);
    };

    // modal actions
    UI.m_close.onclick = ()=>closeModal();

    UI.m_keep.onclick = async ()=>{
      if (!S.modalLead) return;
      const host = (S.modalLead.host||S.modalLead.domain||'').replace(/^https?:\/\//,'');
      await call('POST','/api/v1/metrics/claim', { host, supplier: UI.supplier.value.trim().toLowerCase() });
      S.saved.push({ ...S.modalLead, created: nowISO() });
      saveSaved();
      toast('Locked & saved', true);
      closeModal();
    };

    UI.m_more.onclick = async ()=>{
      if (!S.modalLead) return;
      // Ask backend to enrich (soft stub: same endpoint as watchers adds reasons)
      const host = (S.modalLead.host||S.modalLead.domain||'').replace(/^https?:\/\//,'');
      const r = await call('GET', `/api/v1/metrics/deepen?host=${encodeURIComponent(host)}`);
      if (r.ok && r.data?.why){
        S.modalLead.why = { ...(S.modalLead.why||{}), ...r.data.why };
        S.modalLead.whyText = r.data.whyText || S.modalLead.whyText;
        UI.m_why.innerHTML = nlWhy(S.modalLead.why).join('');
        UI.m_whyText.textContent = S.modalLead.whyText || '';
        UI.m_msg.textContent = 'Added more evidence.';
      }else{
        UI.m_msg.textContent = 'Nothing more to add right now.';
      }
    };

    UI.m_next.onclick = async ()=>{
      // request another with the same inputs
      UI.m_msg.textContent = 'Fetching another…';
      const body = {
        supplier: UI.supplier.value.trim().toLowerCase(),
        region: UI.region.value,
        radiusMi: Number(UI.radius.value||'50')||50,
        persona: { offer:UI.p_offer.value.trim(), solves:UI.p_solves.value.trim(), titles:UI.p_titles.value.trim() },
        onlyUSCA: S.onlyUSCA
      };
      const r = await call('POST','/api/v1/leads/find-buyers', body);
      if (!r.ok){ UI.m_msg.textContent = `HTTP ${r.status}`; return; }
      const list = Array.isArray(r.data?.candidates) ? r.data.candidates : [];
      if (!list.length){ UI.m_msg.textContent = 'No more right now.'; return; }
      const lead = list[0];
      openModal(lead);
    };

    // tooltips
    UI.tip_keep.onclick = ()=> showTip(UI.tip_keep, UI.tip_keep_msg);
    UI.tip_more.onclick = ()=> showTip(UI.tip_more, UI.tip_more_msg);

    // default render
    renderSaved();
  </script>
</body>
</html>