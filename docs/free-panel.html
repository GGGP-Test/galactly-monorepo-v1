<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Leads Console</title>
<style>
  :root { --bg:#0e1420; --panel:#121a2a; --muted:#8aa0c3; --text:#e7eefc; --chip:#1e2a41; --ok:#1f8842; --warn:#8a6a00; --hot:#b84848; --btn:#2a66ff; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:16px;align-items:flex-start}
  .card{background:var(--panel);border:1px solid #2a3854;border-radius:10px;padding:14px}
  .w-2{flex:2} .w-1{flex:1} .w-3{flex:3}
  input,select,button,textarea{background:#0a1220;border:1px solid #2a3854;border-radius:8px;color:var(--text);padding:8px 10px}
  button{cursor:pointer} button.primary{background:var(--btn);border-color:#3a73ff}
  .table{width:100%;border-collapse:collapse} .table th,.table td{padding:8px;border-bottom:1px solid #24344f}
  .muted{color:var(--muted)} .chips{display:flex;flex-wrap:wrap;gap:8px} .chip{background:var(--chip);border-radius:100px;padding:4px 10px}
  .temp.hot{background:var(--hot)} .temp.warm{background:#6a5e2a}
  .pill{display:inline-block;border-radius:999px;padding:2px 8px;background:#1d2b45}
  .mb8{margin-bottom:8px} .mb12{margin-bottom:12px} .mb16{margin-bottom:16px}
  .stack{display:flex;flex-direction:column;gap:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <h2>Leads Console</h2>

  <div class="row mb16">
    <div class="card w-3">
      <div class="grid2">
        <label>Base URL
          <input id="base" value="" placeholder="https://…code.run">
        </label>
        <label>API key
          <input id="apikey" value="">
        </label>
      </div>
      <div class="mb12">
        <button class="primary" onclick="saveCfg()">Save</button>
        <span class="muted">Tip: host this file from the same domain as the API to avoid CORS.</span>
      </div>
    </div>

    <div class="card w-2">
      <div class="stack">
        <div>Select a supplier to find buyers</div>
        <input id="supplier" placeholder="stretchandshrink.com"/>
        <div class="grid2">
          <select id="region">
            <option value="us/ca">US/CA</option>
            <option value="us">US only</option>
            <option value="ca">Canada only</option>
          </select>
          <select id="radius">
            <option>25</option><option selected>50</option><option>100</option><option>250</option>
          </select>
        </div>
        <button class="primary" onclick="findBuyers()">Find buyers</button>
        <div id="findMsg" class="muted"></div>
      </div>
    </div>

    <div class="card w-3" id="personaCard">
      <div class="stack">
        <div><b>Supplier persona</b> (human-editable)</div>
        <div class="grid2">
          <label>Product/offer <input id="p_product" placeholder="e.g., Stretch film & pallet protection"></label>
          <label>Solves <input id="p_solves" placeholder="e.g., Keeps pallets secure for transport"></label>
        </div>
        <label>Buyer titles (comma-separated)
          <input id="p_buyers" placeholder="Warehouse Manager, Purchasing Manager, COO">
        </label>
        <div>
          <button onclick="loadPersona()" class="">Reload</button>
          <button onclick="savePersona()" class="primary">Save persona</button>
          <span id="personaMsg" class="muted"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card w-3">
      <div class="mb8">
        <button onclick="loadHot()">Refresh Hot</button>
        <button onclick="loadWarm()">Refresh Warm</button>
        <span class="muted">API: <code>/api/v1/leads</code></span>
      </div>
      <table class="table" id="list">
        <thead><tr><th>ID</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card w-2" id="details">
      <div class="muted">Select a lead…</div>
    </div>
  </div>
</div>

<script>
/* ------------ config ------------ */
const $ = (id)=>document.getElementById(id);
function cfg(){ return { base: $('base').value.trim().replace(/\/$/,''), key: $('apikey').value.trim() }; }
function saveCfg(){ localStorage.setItem('pl.base',$('base').value); localStorage.setItem('pl.key',$('apikey').value); loadPersona(); }
(function init(){
  $('base').value = localStorage.getItem('pl.base') || '';
  $('apikey').value = localStorage.getItem('pl.key') || '';
  $('supplier').value = localStorage.getItem('pl.supplier') || 'stretchandshrink.com';
  loadWarm();
  loadPersona();
})();

/* ------------ fetch helpers ------------ */
async function jget(path){
  const {base} = cfg();
  const r = await fetch(base + path);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function jpost(path, body, needKey=true){
  const {base,key} = cfg();
  const r = await fetch(base + path, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', ...(needKey?{'x-api-key':key}:{}) },
    body: JSON.stringify(body || {})
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function jpatch(path, body){
  const {base,key} = cfg();
  const r = await fetch(base + path, {
    method: 'PATCH',
    headers: { 'Content-Type':'application/json', 'x-api-key':key },
    body: JSON.stringify(body || {})
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ------------ lists ------------ */
function renderList(items){
  const tb = $('list').querySelector('tbody');
  tb.innerHTML = '';
  for(const l of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.id}</td><td>${l.host}</td><td>${l.platform}</td><td>${l.title}</td><td>${new Date(l.created_at).toLocaleString()}</td><td><span class="pill temp ${l.temperature}">${l.temperature}</span></td>`;
    tr.onclick = ()=>showLead(l);
    tb.appendChild(tr);
  }
}
async function loadHot(){ const r = await jget('/api/v1/leads/hot'); renderList(r.items); }
async function loadWarm(){ const r = await jget('/api/v1/leads/warm'); renderList(r.items); }

/* ------------ lead details ------------ */
function showLead(l){
  const box = $('details');
  const chips = (l.why||[]).map(w=>`<span class="chip"><b>${w.label}</b>${w.score!=null?` ${w.score}`:""}${w.detail?` — ${w.detail}`:""}</span>`).join(' ');
  box.innerHTML = `
    <div class="mb8"><b>ID ${l.id}</b> — ${l.host}</div>
    <div class="mb8">Title: ${l.title}</div>
    <div class="mb8">Created: ${new Date(l.created_at).toLocaleString()}</div>
    <div class="mb12 chips">${chips}</div>
    <div class="stack">
      <label>Add note
        <input id="note_${l.id}" placeholder="e.g., First call done; decision next week">
      </label>
      <div>
        <button onclick="addNote(${l.id})">Add</button>
        <select id="stage_${l.id}">
          <option value="new">new</option><option value="qualified">qualified</option><option value="won">won</option><option value="lost">lost</option>
        </select>
        <button onclick="saveStage(${l.id})" class="primary">Save stage</button>
      </div>
    </div>
  `;
}
async function saveStage(id){ const st = $('stage_'+id).value; await jpatch('/api/v1/leads/'+id+'/stage',{stage:st}); }
async function addNote(id){
  const el = $('note_'+id); const text = el.value.trim(); if(!text) return;
  await jpost('/api/v1/leads/'+id+'/notes',{text}); el.value='';
}

/* ------------ buyers ------------ */
async function findBuyers(){
  const supplier = $('supplier').value.trim();
  localStorage.setItem('pl.supplier', supplier);
  const region = $('region').value;
  const radiusMi = Number($('radius').value);
  $('findMsg').textContent = 'Working…';
  try {
    const r = await jpost('/api/v1/leads/find-buyers', { supplier, region, radiusMi });
    $('findMsg').textContent = `Created ${r.created} lead(s). Refresh lists to view.`;
    await loadWarm();
  } catch(e){ $('findMsg').textContent = String(e); }
}

/* ------------ persona (editable) ------------ */
async function loadPersona(){
  const supplier = $('supplier').value.trim();
  if(!supplier) return;
  try {
    const r = await jget(`/api/v1/leads/persona?supplier=${encodeURIComponent(supplier)}`);
    $('p_product').value = r.persona.product || '';
    $('p_solves').value  = r.persona.solves || '';
    $('p_buyers').value  = (r.persona.idealBuyers||[]).join(', ');
    $('personaMsg').textContent = `Loaded (${r.source}).`;
  } catch(e){
    $('personaMsg').textContent = 'Not found; a default will be created after you save.';
  }
}
async function savePersona(){
  const supplier = $('supplier').value.trim();
  const updates = {
    product: $('p_product').value.trim(),
    solves:  $('p_solves').value.trim(),
    idealBuyers: $('p_buyers').value.split(',').map(s=>s.trim()).filter(Boolean)
  };
  try {
    const r = await jpost('/api/v1/leads/persona', { supplier, ...updates });
    $('personaMsg').textContent = 'Saved (user).';
  } catch(e){ $('personaMsg').textContent = String(e); }
}
</script>
</body>
</html>
