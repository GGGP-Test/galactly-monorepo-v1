<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Live Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--ink:#e8ecf1;--mut:#a9b2c7;--bg:#0b0e13;--card:#111725;--line:#1f2a3b;--pri:#86f7d6;--pri2:#57a4ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:400 14px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:40;background:rgba(10,13,18,.7);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .bar{max-width:1180px;margin:auto;padding:10px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:8px;font-weight:800}
    .brand .ok{display:inline-block;border:1px solid #2a3b55;border-radius:999px;padding:3px 8px;font-weight:600;color:var(--mut)}
    .api{display:flex;gap:6px;align-items:center;color:var(--mut)}
    .api input{width:420px;max-width:52vw;background:#0f141f;border:1px solid #22324a;color:var(--ink);padding:6px 8px;border-radius:10px}
    .api button{background:#162236;border:1px solid #274061;color:#dfe6f3;padding:6px 10px;border-radius:10px;cursor:pointer}

    .wrap{max-width:1180px;margin:16px auto;padding:0 14px}
    .notice{margin:10px 0 16px;padding:10px 12px;border:1px solid #243149;border-radius:12px;background:#0f1522;color:#cfe4ff}
    .notice small{opacity:.8}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .head{display:flex;align-items:center;gap:8px}
    .pill{border:1px solid #2a3b55;border-radius:999px;padding:2px 8px;font-size:12px;color:#c7d2e8}
    .ttl{font-weight:800;margin:2px 0 0}
    .why{opacity:.9}
    .hold{margin-top:8px}
    .hold button{width:100%;background:linear-gradient(90deg,#ffffff,#e9f0ff);color:#0b0c12;font-weight:800;border:0;padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:0 8px 24px rgba(120,160,255,.18)}
    .hold button:active{transform:translateY(1px)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .sheet{width:min(720px,94vw);background:#0f1521;border:1px solid #243149;border-radius:16px;padding:16px}
    .sheet h3{margin:0 0 6px}
    .rows{display:grid;grid-template-columns:1fr;gap:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px dashed #2a3b55;border-radius:12px;padding:6px 9px;font-size:12px;color:#d3def5}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{background:#162236;border:1px solid #274061;color:#e8ecf1;padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn--own{background:linear-gradient(90deg,#86f7d6,#57a4ff);color:#031320;border:0}
    .mut{color:var(--mut)}

    /* Onboarding (fallback) */
    .ob{display:none;margin:10px 0;padding:12px;border:1px solid #2a3b55;border-radius:12px;background:#0f1522}
    .ob.show{display:block}
    .ob input{width:100%;background:#0f141f;border:1px solid #22324a;color:var(--ink);padding:8px 10px;border-radius:10px;margin:6px 0}
    .ob .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .ob .go{margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">Galactly <span class="ok" id="ok">connecting…</span></div>
      <div class="api"><span>API:</span>
        <input id="apiBase" placeholder="https://…"/>
        <button id="saveApi">Save</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div id="profileNotice" class="notice" style="display:none"></div>

    <div id="ob" class="ob">
      <div style="font-weight:800;margin-bottom:6px">Tell us who you want</div>
      <label>Vendor site (we derive ICP)
        <input id="obVendor" placeholder="yourcompany.com (optional)"/>
      </label>
      <div class="row">
        <label>Seed buyers
          <input id="obBuyers" placeholder="comma domains, e.g. liquiddeath.com, soylent.com"/>
        </label>
        <label>Industries
          <input id="obIndustries" placeholder="e.g. beverage, confectionery"/>
        </label>
      </div>
      <div class="row">
        <label>Regions
          <input id="obRegions" placeholder="e.g. US, CA"/>
        </label>
        <div></div>
      </div>
      <button class="btn go" id="obGo">Find now</button>
    </div>

    <div id="feed" class="grid" aria-live="polite"></div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Lead details">
    <div class="sheet">
      <div class="mut" id="mSource"></div>
      <h3 id="mTitle">Lead</h3>
      <div id="mWhy" class="why"></div>
      <div class="chips" id="mChips"></div>
      <div class="actions">
        <button class="btn" id="mClaim">Reserve 2m</button>
        <button class="btn btn--own" id="mOwn">Own</button>
        <a class="mut" id="mVerify" href="#" target="_blank" rel="noopener">Verify (optional)</a>
        <span class="mut" id="mTimer"></span>
        <span style="flex:1"></span>
        <button class="btn" id="mClose">Close</button>
      </div>
    </div>
  </div>

  <script src="./api-base.js"></script>
  <script>
    // ---------- API base + session ----------
    const uidKey='gal_uid';
    let UID=localStorage.getItem(uidKey); if(!UID){ UID='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey, UID); }
    const apiInput=document.getElementById('apiBase');
    apiInput.value=window.API_BASE||localStorage.getItem('apiBase')||'';
    document.getElementById('saveApi').onclick=()=>{ window.__setApiBase?.(apiInput.value); location.reload(); };
    const OK=document.getElementById('ok');

    async function jget(path){ const r=await fetch(path.startsWith('/api/')? path:('/api'+path), { headers:{'x-galactly-user':UID} }); return r.json(); }
    async function jpost(path, body){ const r=await fetch(path, { method:'POST', headers:{'content-type':'application/json','x-galactly-user':UID}, body:JSON.stringify(body||{}) }); return r.json(); }

    // ---------- Onboarding profile (auto-read) ----------
    const OB_KEY='gal_onboard_v1';
    function parseQP(){ const q=new URLSearchParams(location.search); const o={};
      if(q.get('vendor')) o.vendorDomain=q.get('vendor');
      if(q.get('buyers')) o.buyers=q.get('buyers').split(',').map(s=>s.trim()).filter(Boolean);
      if(q.get('industries')) o.industries=q.get('industries').split(',').map(s=>s.trim()).filter(Boolean);
      if(q.get('regions')) o.regions=q.get('regions').split(',').map(s=>s.trim()).filter(Boolean);
      return o; }
    function readProfile(){ const qp=parseQP(); if(Object.keys(qp).length){ localStorage.setItem(OB_KEY, JSON.stringify(qp)); return qp; }
      try{ return JSON.parse(localStorage.getItem(OB_KEY)||'{}'); }catch{ return {}; } }
    function saveProfile(p){ localStorage.setItem(OB_KEY, JSON.stringify(p||{})); }

    async function ensureGate(){ try{ await jpost('/api/v1/gate', { region: (profile.regions||[])[0]||null, email:null, alerts:false }); }catch(e){} }

    // ---------- Feed ----------
    const FEED=document.getElementById('feed');
    let LEADS=[], ACTIVE=null, TIMER=null;

    function niceHost(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{return '';}}
    function confident(heat){ if(!Number.isFinite(heat)) return '—'; const n=Math.max(0,Math.min(99,heat|0)); return n+"/100"; }

    function card(lead){
      const d=document.createElement('div'); d.className='card';
      const host=niceHost(lead.source_url);
      const platform=(lead.platform||'').replace('_free','').replace('_',' ');
      const why=(lead.snippet||'').slice(0,160);
      d.innerHTML = `
        <div class="head">
          <span class="pill">${platform||'signal'}</span>
          <span class="pill">Conf: ${confident(lead.heat)}</span>
          ${lead.cat?`<span class="pill">${lead.cat}</span>`:''}
        </div>
        <div class="ttl">${escapeHtml(lead.title||host||'Untitled')}</div>
        <div class="why">${escapeHtml(why)}</div>
        <div class="hold"><button data-act="reveal">Press & hold to reveal</button></div>
      `;

      // long-press
      const btn=d.querySelector('[data-act=reveal]');
      let to=null, tStart=0;
      const start=()=>{ if(to) return; tStart=Date.now(); to=setTimeout(()=>{ to=null; openModal(lead); }, 1100); };
      const cancel=()=>{ if(!to) return; clearTimeout(to); to=null; if(Date.now()-tStart<1100){ /* tap ignored */ } };
      btn.addEventListener('mousedown', start); btn.addEventListener('touchstart', start, {passive:true});
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev, cancel));
      return d;
    }

    function render(){ FEED.innerHTML=''; LEADS.forEach(L=>FEED.appendChild(card(L))); }

    async function refresh(){
      try{
        const d=await jget('/api/v1/leads'); if(!d?.ok) throw new Error('bad');
        LEADS=d.leads||[]; render(); OK.textContent='ok';
        setTimeout(refresh, (d.nextRefreshSec||15)*1000);
      }catch(e){ OK.textContent='retrying…'; setTimeout(refresh, 5000); }
    }

    // ---------- Modal (details) ----------
    const MOD=document.getElementById('modal');
    const MT=document.getElementById('mTitle');
    const MS=document.getElementById('mSource');
    const MW=document.getElementById('mWhy');
    const MC=document.getElementById('mChips');
    const MV=document.getElementById('mVerify');
    const MBclaim=document.getElementById('mClaim');
    const MBown=document.getElementById('mOwn');
    const MClose=document.getElementById('mClose');
    const MTmr=document.getElementById('mTimer');

    function chipsFor(lead){
      const out=[];
      if(lead.kw && lead.kw.length) out.push(...lead.kw.slice(0,4));
      if(lead.cat) out.push(lead.cat);
      if(lead.platform && /adlib/.test(lead.platform)) out.push('ad spender');
      return out;
    }

    async function claim(lead){ const r=await jpost('/api/v1/claim', { leadId: lead.id }); if(r?.ok){ lead._windowId=r.windowId; lead._exp=Date.now()+(r.reservedForSec||120)*1000; tick(lead); } }
    async function own(lead){ if(!lead._windowId) return; const r=await jpost('/api/v1/own', { windowId: lead._windowId }); if(r?.ok){ closeModal(); refresh(); } }

    function tick(lead){ if(TIMER) cancelAnimationFrame(TIMER); const t=()=>{ if(!lead._exp){ MTmr.textContent=''; return; } const s=Math.max(0, Math.ceil((lead._exp-Date.now())/1000)); MTmr.textContent = s?`reserved ${s}s`:'ready'; if(s) TIMER=requestAnimationFrame(t); }; t(); }

    function openModal(lead){ ACTIVE=lead; MOD.classList.add('show');
      MS.textContent = `${(lead.platform||'signal')} • ${niceHost(lead.source_url)}`;
      MT.textContent = lead.title || niceHost(lead.source_url) || 'Lead';
      MW.textContent = (lead.snippet||'').slice(0,260);
      MC.innerHTML=''; chipsFor(lead).forEach(c=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=c; MC.appendChild(s); });
      MV.style.display = lead.source_url ? 'inline-block' : 'none'; MV.href = lead.source_url || '#';
      MBclaim.onclick=()=>claim(lead); MBown.onclick=()=>own(lead); tick(lead);
    }
    function closeModal(){ MOD.classList.remove('show'); ACTIVE=null; if(TIMER) cancelAnimationFrame(TIMER); TIMER=null; }
    MClose.onclick=closeModal; MOD.addEventListener('click', (e)=>{ if(e.target===MOD) closeModal(); });

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ---------- Boot (auto-onboard) ----------
    const profBox=document.getElementById('profileNotice');
    const obWrap=document.getElementById('ob');
    const obVendor=document.getElementById('obVendor');
    const obBuyers=document.getElementById('obBuyers');
    const obIndustries=document.getElementById('obIndustries');
    const obRegions=document.getElementById('obRegions');
    const obGo=document.getElementById('obGo');

    let profile = readProfile();

    function showProfile(p){ const buyers=(p.buyers||[]).slice(0,3).join(', ')+( (p.buyers||[]).length>3? '…':'' );
      const parts=[]; if(p.vendorDomain) parts.push(`<b>Vendor</b> ${escapeHtml(p.vendorDomain)}`);
      if(p.industries?.length) parts.push(`<b>Industries</b> ${escapeHtml(p.industries.join(', '))}`);
      if(p.regions?.length) parts.push(`<b>Regions</b> ${escapeHtml(p.regions.join(', '))}`);
      if(p.buyers?.length) parts.push(`<b>Seed</b> ${escapeHtml(buyers)}`);
      profBox.innerHTML = parts.length? `Using your profile → ${parts.join(' • ')} <span class="mut">(edit below)</span>` : '';
      profBox.style.display = parts.length? 'block':'none';
    }

    async function runFindNow(p){ if(!p) return; showProfile(p); OK.textContent='searching…'; await ensureGate(); try{ await jpost('/api/v1/find-now', p); }catch(e){} OK.textContent='ok'; }

    // If nothing stored, show inline onboarding; else run immediately
    if(!Object.keys(profile).length){ obWrap.classList.add('show'); }
    else{ runFindNow(profile); }

    obGo.onclick = async()=>{
      const p={}; const v=obVendor.value.trim(); if(v) p.vendorDomain=v;
      const B=obBuyers.value.split(',').map(s=>s.trim()).filter(Boolean); if(B.length) p.buyers=B;
      const I=obIndustries.value.split(',').map(s=>s.trim()).filter(Boolean); if(I.length) p.industries=I;
      const R=obRegions.value.split(',').map(s=>s.trim()).filter(Boolean); if(R.length) p.regions=R;
      saveProfile(p); profile=p; obWrap.classList.remove('show'); await runFindNow(profile); refresh();
    };

    // Start polling feed
    refresh();
  </script>
</body>
</html>
