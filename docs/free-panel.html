<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly ‚Ä¢ Free Panel (Dev Free)</title>
  <script src="./config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#eaf0ff; --mut:#a6b2c9; --line:#223047; --panel:#0b121d; --card:#0f1624; --pill:#0f1726; --ok:#89ffd9; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font:500 14px Inter,system-ui; color:var(--ink);
      background: radial-gradient(1200px 700px at 70% -10%, rgba(70,110,180,.22), transparent 40%), #070b12;}
    .wrap{max-width:1300px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:8px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--pill);color:#cfe0ff}
    .badge .dot{width:8px;height:8px;border-radius:50%;background:#39bfa2;box-shadow:0 0 10px rgba(57,191,162,.7)}
    .kv{color:#cfe0ff;opacity:.85}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr;}}
    .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    .live{height:520px;display:flex;flex-direction:column}
    .live-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .live-canvas{flex:1;border:1px solid var(--line);border-radius:14px;background:radial-gradient(320px 220px at 50% 40%, rgba(220,236,255,.06), transparent 60%), #0a111b;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .neutron{width:280px;height:280px;border-radius:50%;background:radial-gradient(circle at 50% 50%, #fff, #9fb6ff 45%, rgba(159,182,255,.06) 46%, transparent 48%), radial-gradient(circle, rgba(200,230,255,.25) 30%, transparent 31%); box-shadow:0 0 40px rgba(180,210,255,.18) inset;position:relative}
    .neutron:before,.neutron:after{content:"";position:absolute;inset:-2px;border-radius:50%;border:1px dashed rgba(200,220,255,.15);animation:spin 28s linear infinite}
    .neutron:after{inset:-24px;animation-duration:44s;opacity:.7}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-pill{position:absolute;left:12px;bottom:12px;background:rgba(7,12,20,.75);border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#cfe0ff;backdrop-filter:blur(6px)}
    .h{font:700 14px/1.1 Inter;letter-spacing:.02em}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    .lbl{width:120px;color:#cfe0ff;opacity:.85}
    .input{flex:1;background:var(--card);border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px 12px}
    .btn{border-radius:12px;padding:10px 14px;border:1px solid var(--line);background:var(--pill);color:var(--ink);font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#fff,#e6f0ff);color:#0a0e15;border-color:transparent}
    .small{font-size:12px;opacity:.85}
    hr.sep{height:1px;border:0;background:linear-gradient(90deg,transparent,#25314a,transparent);margin:10px 0}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;padding-top:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(10,16,28,.85)}
    .lock{font-size:12px;color:#97a8c7}
    .debug{font-size:11px;color:#9ab2d9;opacity:.9;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="badge"><span class="dot"></span><span id="presenceTxt">0 online</span></div>
    <div class="kv" id="quotaTopRight">‚Äî searches left ‚Ä¢ ‚Äî reveals left</div>
  </div>

  <div class="grid">
    <div class="box live">
      <div class="live-head">
        <div class="h">Live results</div>
        <div class="kv" id="quotaTopLeft">‚Äî searches left ‚Ä¢ ‚Äî reveals left</div>
      </div>
      <div class="live-canvas">
        <div class="neutron" aria-hidden="true"></div>
        <div class="status-pill" id="enginePill"><span style="color:#89ffd9">‚óè</span> engine: ready</div>
      </div>
      <div class="debug" id="dbg"></div>
    </div>

    <div class="box">
      <div class="h" style="margin-bottom:4px">Train your AI</div>
      <div class="row"><div class="lbl">Website</div><input id="f_site" class="input" placeholder="yourcompany.com"></div>
      <div class="row"><div class="lbl">Regions</div><input id="f_regions" class="input" placeholder="US, CA"></div>
      <div class="row"><div class="lbl">Industries</div><input id="f_inds" class="input" placeholder="beverage, confectionery"></div>
      <div class="row"><div class="lbl">Seed buyers</div><input id="f_buyers" class="input" placeholder="brand1.com, brand2.com"></div>
      <div class="row"><div class="lbl">Ideal customers</div><input id="f_desc" class="input" placeholder="materials, order sizes, channels, exclusions"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn primary" id="btnFind">Find now</button>
      </div>
      <hr class="sep">
      <div class="h" style="margin-bottom:6px">Signals Preview (report)</div>
      <div class="kpis">
        <div class="chip">Free <span class="lock" id="freeCount">0/0</span></div>
        <div class="chip">Pro <span class="lock" id="proCount">0/0</span> <span class="lock">üîí</span></div>
      </div>
      <div class="small" id="previewLine" style="margin-top:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const uidKey='gal_uid';
  let UID = localStorage.getItem(uidKey);
  if(!UID){ UID = 'u-' + Math.random().toString(36).slice(2,12); localStorage.setItem(uidKey, UID); }

  function normalizeHost(v){ let s=(v||window.API_DEFAULT||location.origin).toString().trim(); s=s.replace(/\/api\/v1\/?$/,'').replace(/\/$/,''); return s; }
  const HOST = normalizeHost(localStorage.getItem('apiBase') || window.API_DEFAULT);
  localStorage.setItem('apiBase', HOST);
  const API_BASE = HOST + '/api/v1';

  async function api(path, opt){
    const o = opt || {};
    const headers = new Headers(o.headers || {});
    headers.set('x-galactly-user', UID);
    headers.set('x-dev-unlim','true');          // dev free
    const url = API_BASE + (path.startsWith('/')? path : ('/'+path));
    const res = await fetch(url, { ...o, headers, mode:'cors' });   // ‚Üê NO credentials
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  window.__API__ = { HOST, API_BASE, UID, api };
  document.getElementById('dbg').textContent = `[api] ${HOST}  uid=${UID}  DEV=free`;
})();

async function loadPresence(){ try{ const j=await __API__.api('/presence/online'); document.getElementById('presenceTxt').textContent=(j.total||0)+' online'; }catch{} }
setInterval(loadPresence, 8000); loadPresence();

let STATUS=null;
function renderQuotas(){
  const L=document.getElementById('quotaTopLeft'), R=document.getElementById('quotaTopRight');
  if(!STATUS){ L.textContent='‚Äî searches left ‚Ä¢ ‚Äî reveals left'; R.textContent=L.textContent; return; }
  const s=STATUS.devUnlimited?'‚àû':(STATUS.quota?.findsLeft??0);
  const r=STATUS.devUnlimited?'‚àû':(STATUS.quota?.revealsLeft??0);
  const txt=`${s} searches left ‚Ä¢ ${r} reveals left`; L.textContent=txt; R.textContent=txt;
}
async function loadStatus(){ try{ STATUS=await __API__.api('/status'); }catch{ STATUS=null; } renderQuotas(); }
setInterval(loadStatus, 10000); loadStatus();

function val(id){ return (document.getElementById(id).value||'').trim(); }

document.getElementById('btnSave').onclick = async ()=>{
  try{
    await __API__.api('/vault',{ method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({
      website: val('f_site'), industries: val('f_inds'), regions: val('f_regions'),
      buyers: val('f_buyers'), notes: val('f_desc')
    })});
  }catch(e){}
};

document.getElementById('btnFind').onclick = async ()=>{
  try{
    fetch(__API__.API_BASE + '/presence/beat',{ method:'POST', headers:{'content-type':'application/json','x-galactly-user': __API__.UID }, body: JSON.stringify({ role:'supplier' }) });
    await __API__.api('/find-now',{ method:'POST', headers:{'content-type':'application/json'} });
    loadStatus(); startSSE();
  }catch(e){ alert('Unexpected error.'); }
};

/* SSE */
let es;
function startSSE(){
  try{ if(es) es.close(); }catch{}
  const url = __API__.API_BASE + '/progress.sse';
  es = new EventSource(url);
  es.onmessage = (ev)=>{
    try{
      const d = JSON.parse(ev.data);
      if(d.type==='step'){
        document.getElementById('freeCount').textContent = `${d.freeDone}/${d.freeTotal}`;
        document.getElementById('proCount').textContent  = `${d.proDone}/${d.proTotal} üîí`;
        document.getElementById('previewLine').textContent =
          `${d.category}: ${d.probe} ‚Üí ${d.filter} ‚Üí ${d.evidence} ‚Üí ${d.conclusion}`;
      }
      if(d.type==='halt'){ es && es.close(); }
    }catch{}
  };
  es.onerror = ()=>{ try{ es.close(); }catch{} };
}
startSSE();
</script>
</body>
</html>
