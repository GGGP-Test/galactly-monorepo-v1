<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads Console — Free Panel (V3)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --ok:#10b981; --err:#ef4444; }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; display:flex; gap:18px; }
    .col{ flex:1 1 50%; background:var(--panel); border:1px solid #1f2937; border-radius:10px; padding:16px; }
    h1{ font-size:18px; margin:0 0 12px; }
    label{ font-size:12px; color:var(--muted); display:block; margin:12px 0 6px; }
    input, select{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:var(--text); }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    button{ padding:10px 14px; border:0; border-radius:8px; background:#1f2937; color:var(--text); cursor:pointer; }
    button.primary{ background:var(--accent); color:#081018; font-weight:600; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .help{ font-size:12px; color:var(--muted); margin-top:6px; }
    .msg{ margin-top:10px; font-size:12px; padding:8px 10px; border-radius:8px; border:1px solid #263244; }
    .msg.ok{ border-color: #064e3b; color:#a7f3d0; }
    .msg.err{ border-color:#3f1d1d; color:#fecaca; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{ border-bottom:1px solid #1f2937; text-align:left; padding:10px 8px; font-size:13px; vertical-align:top; }
    th{ color:#cbd5e1; font-weight:600; background:#0b1322; position:sticky; top:0; }
    .toolbar{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pill{ padding:6px 10px; border:1px solid #1f2937; background:#0b1220; border-radius:999px; font-size:12px; color:#cbd5e1; }
    .right{ text-align:right; }
    .tiny{ font-size:11px; color:#9ca3af; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left panel: controls -->
    <div class="col">
      <h1>Leads Console — Free Panel (V3)</h1>

      <label>API base</label>
      <div class="row">
        <input id="apiBase" placeholder="https://your-app.code.run" />
        <button id="apply" class="primary">Apply</button>
      </div>

      <label>API key (optional for read; required for write)</label>
      <div class="row">
        <input id="apiKey" placeholder="x-api-key value (optional)" />
        <button id="saveKey">Save</button>
      </div>

      <div class="toolbar">
        <button id="refreshHot">Refresh Hot</button>
        <button id="refreshWarm">Refresh Warm</button>
        <span class="pill">API root: <code>/api/v1</code></span>
      </div>

      <div class="msg" id="status" style="display:none;"></div>

      <hr style="border:0;border-top:1px solid #1f2937;margin:14px 0" />

      <label>Action</label>
      <div class="row">
        <span class="pill">Find buyers (one per click)</span>
      </div>

      <label>Supplier host</label>
      <input id="supplierHost" placeholder="e.g. peekpackaging.com" />

      <div class="row">
        <select id="country">
          <option value="US/CA">US/CA</option>
          <option value="US">US</option>
          <option value="CA">CA</option>
          <option value="">Any</option>
        </select>
        <select id="radiusMi">
          <option value="25">25 mi</option>
          <option value="50" selected>50 mi</option>
          <option value="100">100 mi</option>
          <option value="200">200 mi</option>
        </select>
        <button id="find" class="primary">Find buyers</button>
      </div>

      <div class="msg" id="findMsg" style="display:none;"></div>

      <label>Supplier persona (used to infer intent)</label>
      <input id="p_offer" placeholder="Product/offer (e.g. Stretch film & pallet protection)" />
      <input id="p_solves" placeholder="Solves (e.g. Keeps pallets secure for storage/transport)" />
      <input id="p_titles" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing" />
      <div class="row">
        <button id="personaSave">Save persona (local)</button>
        <button id="dlHot">Download CSV (hot)</button>
        <button id="dlWarm">Download CSV (warm)</button>
      </div>
      <p class="tiny">Editing persona won’t clear your list.</p>
    </div>

    <!-- Right panel: results -->
    <div class="col">
      <div class="toolbar" style="justify-content:space-between">
        <span class="pill">Results</span>
        <span class="tiny" id="resultCount">0 items</span>
      </div>
      <div id="tableWrap" style="max-height:60vh; overflow:auto; margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Host</th>
              <th>Platform</th>
              <th>Title</th>
              <th>Created</th>
              <th>Temp</th>
              <th>Why (human-readable)</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ---------- helpers ----------
      const $ = id => document.getElementById(id);
      const show = (el, yes=true) => { el.style.display = yes ? '' : 'none'; };
      const toast = (msg, ok=false) => {
        const el = $('status'); if (!el) return;
        el.classList.remove('ok','err');
        el.classList.add(ok?'ok':'err');
        el.textContent = msg;
        show(el, true);
      };
      const setFindMsg = (msg, ok=false) => {
        const el = $('findMsg'); if (!el) return;
        el.classList.remove('ok','err');
        el.classList.add(ok?'ok':'err');
        el.textContent = msg;
        show(el, !!msg);
      };

      const S = {
        root: '/api/v1',
        items: [],
        persona: {}
      };

      const base = () => ($('apiBase').value || '').trim().replace(/\/+$/,'');
      const key  = () => ($('apiKey').value || '').trim();

      function saveLocal(){
        localStorage.setItem('base', base());
        localStorage.setItem('apiKey', key());
        localStorage.setItem('persona', JSON.stringify(S.persona || {}));
      }
      function loadLocal(){
        const b = localStorage.getItem('base'); if (b) $('apiBase').value = b;
        const k = localStorage.getItem('apiKey'); if (k) $('apiKey').value = k;
        try { S.persona = JSON.parse(localStorage.getItem('persona')||'{}'); } catch { S.persona = {}; }
        $('p_offer').value = S.persona.offer || '';
        $('p_solves').value = S.persona.solves || '';
        $('p_titles').value = S.persona.titles || '';
      }

      async function http(method, path, {query=null, body=null}={}){
        const b = base();
        if (!b) return { ok:false, status:0, data:{ ok:false, error:'No API base set' } };
        const url = new URL(b + (path.startsWith('/')?path:'/'+path));
        if (query) Object.entries(query).forEach(([k,v]) => v!=null && v!=='' && url.searchParams.set(k,String(v)));
        const headers = { 'Accept':'application/json' };
        if (body!=null) headers['Content-Type']='application/json';
        if (key()) headers['x-api-key']=key();
        let res;
        try { res = await fetch(url.toString(), { method, headers, body: body!=null?JSON.stringify(body):undefined }); }
        catch(e){ return { ok:false, status:0, data:{ ok:false, error:String(e) } }; }
        const txt = await res.text(); let data;
        try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
        return { ok:res.ok, status:res.status, data, url: url.toString(), method };
      }

      function normalizeItem(x){
        return {
          host: x?.host || x?.domain || x?.source || '',
          platform: x?.platform || x?.type || '',
          title: x?.title || x?.name || '',
          created: x?.created || x?.createdAt || x?.ts || '',
          temp: x?.temp || x?.temperature || x?.score || '',
          why: x?.why || x?.whyText || x?.reason || x?.summary || ''
        };
      }

      function renderList(){
        const tb = $('listBody'); tb.innerHTML='';
        (S.items||[]).forEach((it, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${it.host||''}</td>
            <td>${it.platform||''}</td>
            <td>${it.title||''}</td>
            <td>${it.created||''}</td>
            <td>${it.temp||''}</td>
            <td>${it.why||''}</td>
          `;
          tb.appendChild(tr);
        });
        $('resultCount').textContent = `${S.items.length} item${S.items.length===1?'':'s'}`;
      }

      function toCSV(items){
        const cols = ['host','platform','title','created','temp','why'];
        const esc = v => `${String(v??'').replaceAll('"','""')}`;
        const head = cols.join(',');
        const rows = (items||[]).map(r => cols.map(c => `"${esc(r[c])}"`).join(','));
        return [head, ...rows].join('\r\n');
      }
      function download(name, text){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([text], {type:'text/csv'}));
        a.download = name; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
      }

      // ---------- endpoint auto-discovery ----------
      async function tryFindBuyers({host, country, radius}){
        // Try GET endpoints first, then POST if needed
        const candidates = [
          // GETs
          { m:'GET', p:`${S.root}/leads/find-buyers`, q:true },
          { m:'GET', p:`${S.root}/leads/find`, q:true },
          { m:'GET', p:`${S.root}/buyers/find`, q:true },
          { m:'GET', p:`${S.root}/find-buyers`, q:true },
          { m:'GET', p:`/leads/find-buyers`, q:true },
          { m:'GET', p:`/buyers/find`, q:true },
          { m:'GET', p:`/find-buyers`, q:true },
          // POSTs (body payload)
          { m:'POST', p:`${S.root}/leads/find-buyers`, q:false },
          { m:'POST', p:`${S.root}/buyers/find`, q:false },
          { m:'POST', p:`${S.root}/find-buyers`, q:false },
          { m:'POST', p:`/leads/find-buyers`, q:false },
          { m:'POST', p:`/buyers/find`, q:false },
          { m:'POST', p:`/find-buyers`, q:false },
        ];

        let last = null;
        for (const c of candidates){
          const args = c.q
            ? { query: { host, country, radius } }
            : { body: { host, country, radius } };
          const r = await http(c.m, c.p, args);
          console.debug('find-buyers try:', r.method, r.url, r.status);
          last = r;
          if (r.ok && r.data) return r;
          // Stop early on auth problems so user sees the message
          if (r.status === 401 || r.status === 403) return r;
          // On 404/405/415 keep trying
        }
        return last;
      }

      // ---------- actions ----------
      async function onFind(){
        setFindMsg('');
        const host = ($('supplierHost').value || '').trim();
        const country = $('country').value;
        const radius = $('radiusMi').value;
        if (!host) { setFindMsg('Enter supplier host'); return; }

        const btn = $('find'); btn.disabled = true;
        const r = await tryFindBuyers({ host, country, radius });
        btn.disabled = false;

        if (!r || !r.ok){
          const detail = typeof r?.data === 'string' ? r.data : JSON.stringify(r?.data);
          setFindMsg(`HTTP ${r?.status ?? 0} — ${detail || 'not found'}`);
          return;
        }

        const items = (r.data && r.data.items) || [];
        const seen = new Set((S.items||[]).map(it => `${it.host}::${it.title}`));
        items.forEach(raw => {
          const it = normalizeItem(raw);
          const k = `${it.host}::${it.title}`;
          if (!seen.has(k)) { seen.add(k); S.items.unshift(it); }
        });
        renderList();
        setFindMsg(`Loaded ${items.length} new item(s).`, true);
      }

      // ---------- bindings ----------
      function bind(){
        loadLocal();

        $('apply').onclick = () => {
          const b = base();
          if (b) toast(`Base set: ${b}`, true); else toast('Base cleared');
          saveLocal();
        };
        $('saveKey').onclick = () => {
          if (key()) toast('API key saved', true); else toast('API key cleared');
          saveLocal();
        };
        $('personaSave').onclick = () => {
          S.persona = {
            offer: $('p_offer').value.trim(),
            solves: $('p_solves').value.trim(),
            titles: $('p_titles').value.trim()
          };
          saveLocal();
          toast('Persona saved locally', true);
        };

        $('find').onclick = (e) => { e.preventDefault(); onFind(); };

        $('dlHot').onclick  = () => download('leads_hot.csv',  toCSV(S.items.filter(x => (x.temp||'').toString().toLowerCase()==='hot')));
        $('dlWarm').onclick = () => download('leads_warm.csv', toCSV(S.items.filter(x => (x.temp||'').toString().toLowerCase().includes('warm'))));

        // optional quick test buttons (not wired to backend here)
        $('refreshHot').onclick  = () => toast('Hot refresh is view-only in free panel');
        $('refreshWarm').onclick = () => toast('Warm refresh is view-only in free panel');

        // URL overrides (?base=&key=&host=)
        try{
          const u = new URL(location.href);
          const b = u.searchParams.get('base'); if (b) { $('apiBase').value = b; }
          const k = u.searchParams.get('key');  if (k) { $('apiKey').value  = k; }
          const h = u.searchParams.get('host'); if (h) { $('supplierHost').value = h; }
          if (b || k) saveLocal();
        }catch{}

        renderList();
      }

      document.addEventListener('DOMContentLoaded', bind);
    })();
  </script>
</body>
</html>