<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Free Panel</title>
  <style>
    :root{--bg:#0c1016;--panel:#0f1520;--mut:#a9b3c8;--line:rgba(255,255,255,.08);--ink:#e7edf7;--ink2:#c9d2e3;--good:#86f7d6;--warn:#ffd782;--hot:#7fb3ff}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 700px at 85% -10%, rgba(80,140,255,.08), rgba(0,0,0,0) 60%),linear-gradient(180deg,#0b0f15,#061018);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between;backdrop-filter:blur(8px)}
    .micro{font-size:12px;color:var(--mut)}
    .wrap{max-width:1240px;margin:0 auto;padding:18px;display:grid;grid-template-columns:minmax(480px,58%) 1fr;gap:18px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card h3{font:700 14px/1.2 Inter;margin:0 0 10px;color:var(--ink2)}
    .pad{padding:16px}

    /* Left column: Live results */
    .live{display:flex;flex-direction:column;min-height:72vh}
    .liveTop{position:relative;min-height:180px;border-bottom:1px dashed var(--line);display:flex;align-items:center;justify-content:center;overflow:hidden}
    canvas#star{position:absolute;inset:0;width:100%;height:100%;display:block}
    .liveTop .label{position:absolute;left:14px;bottom:10px;color:var(--mut);font-size:12px}
    .results{flex:1;overflow:auto;max-height:calc(100vh - 290px);padding:12px}
    .lead{border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;background:rgba(255,255,255,.02)}
    .lead h4{margin:0 0 6px;font:700 14px Inter}
    .lead .meta{font-size:12px;color:var(--mut)}
    .row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--ink2)}
    .hold{user-select:none}
    .ctaMin{display:inline-flex;gap:8px}

    /* Right column */
    .rightGrid{display:grid;grid-template-rows:auto 1fr;gap:18px;min-height:72vh}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .formGrid textarea{grid-column:1/-1;min-height:96px}
    input,textarea{width:100%;background:#0b121c;border:1px solid #172130;color:var(--ink);border-radius:12px;padding:10px;font:500 14px Inter}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#e9f0ff;color:#0b0e12;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.sec{background:rgba(255,255,255,.06);color:var(--ink)}

    /* Why modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{max-width:640px;width:100%;background:#0f1520;border:1px solid var(--line);border-radius:16px}
    .modal .pad{padding:18px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table td{padding:8px;border-bottom:1px dashed var(--line);vertical-align:top}
    .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-right:6px;color:#b9c5db}
    .num{font-weight:800;color:#fff}
  </style>
</head>
<body>
  <header>
    <div><strong>Galactly</strong> <span class="micro" id="status">connecting…</span></div>
    <div class="micro">API: <input id="apiBase" size="48" style="background:#0b121c;border:1px solid #182334;color:var(--ink);border-radius:10px;padding:6px 8px"/> <button id="saveApi" class="btn sec">Save</button></div>
  </header>

  <div class="wrap">
    <!-- Left column: Live results + neutron star while waiting -->
    <section class="card live">
      <div class="liveTop">
        <canvas id="star"></canvas>
        <div class="label micro" id="engineState">Lead Engine • idle</div>
      </div>
      <div class="pad"><h3>Live results</h3></div>
      <div id="results" class="results"></div>
    </section>

    <!-- Right column: (1) Customize your AI  (2) Signals preview -->
    <section class="rightGrid">
      <div class="card pad">
        <h3>Customize your AI</h3>
        <div class="formGrid">
          <input id="inVendor" placeholder="Vendor site (optional) e.g. yourcompany.com"/>
          <input id="inSeeds"  placeholder="Seed buyers (comma separated domains)"/>
          <input id="inIndustries" placeholder="Industries e.g. beverage, confectionery"/>
          <input id="inRegions" placeholder="Regions e.g. US, CA"/>
          <textarea id="inBrief" placeholder="Describe your ideal customers in plain words. Products, pack types, order sizes, retailer channels, and exclusions."></textarea>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="btnFind" class="btn">Find now</button>
          <span class="micro">Tip: hold to reveal. 2 deep reveals/day on free.</span>
        </div>
      </div>

      <div class="card pad" style="overflow:auto;max-height:52vh">
        <h3>Signals preview</h3>
        <div class="micro" id="previewState">idle</div>
        <div id="previewLog" class="micro" style="white-space:pre-wrap;line-height:1.55;margin-top:8px"></div>
      </div>
    </section>
  </div>

  <!-- Why modal -->
  <div id="whyOverlay" class="overlay">
    <div class="modal">
      <div class="pad">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <h3 style="margin:0">Why this lead</h3>
          <button id="closeWhy" class="btn sec">Close</button>
        </div>
        <div id="whySummary" class="micro" style="margin-bottom:8px"></div>
        <table class="table" id="whyTable"></table>
        <div id="whyProof" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

<script>
// ----------------- API base + session -----------------
const uidKey='galactly_uid';
let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
const apiInput=document.getElementById('apiBase');
const urlQ=new URLSearchParams(location.search);
apiInput.value=(urlQ.get('api')||localStorage.getItem('apiBase')||'').trim();
document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('apiBase', apiInput.value.trim()); location.reload(); };
const API=(p)=> (apiInput.value||localStorage.getItem('apiBase')||'').replace(/\/$/,'') + p;

// ------------- Prefill from onboarding (query or localStorage) -------------
const inVendor=document.getElementById('inVendor');
const inSeeds=document.getElementById('inSeeds');
const inIndustries=document.getElementById('inIndustries');
const inRegions=document.getElementById('inRegions');
const inBrief=document.getElementById('inBrief');
if(urlQ.get('vendor')) inVendor.value=urlQ.get('vendor'); else inVendor.value=localStorage.getItem('on_vendor')||'';
if(urlQ.get('buyers')) inSeeds.value=urlQ.get('buyers'); else inSeeds.value=localStorage.getItem('on_buyers')||'';
if(urlQ.get('industries')) inIndustries.value=urlQ.get('industries'); else inIndustries.value=localStorage.getItem('on_inds')||'';
if(urlQ.get('regions')) inRegions.value=urlQ.get('regions'); else inRegions.value=localStorage.getItem('on_regs')||'';
if(localStorage.getItem('on_brief')) inBrief.value=localStorage.getItem('on_brief');

// ------------- Neutron star (minimal, efficient) -------------
const star=document.getElementById('star'); const DPR=Math.min(2,window.devicePixelRatio||1); let sctx; let t0=0; let beamA=0;
function resizeStar(){ const r=star.getBoundingClientRect(); star.width=r.width*DPR; star.height=r.height*DPR; sctx=star.getContext('2d'); sctx.setTransform(DPR,0,0,DPR,0,0); }
function drawStar(ts){ if(!sctx) return; const w=star.width/DPR,h=star.height/DPR; sctx.clearRect(0,0,w,h);
  const cx=w*0.42, cy=h*0.55; const r=40; // core
  // subtle gradient field
  const g=sctx.createRadialGradient(cx,cy,0,cx,cy,220); g.addColorStop(0,'rgba(255,255,255,.08)'); g.addColorStop(1,'rgba(255,255,255,0)'); sctx.fillStyle=g; sctx.beginPath(); sctx.arc(cx,cy,220,0,Math.PI*2); sctx.fill();
  // core glow
  const pul=1+0.08*Math.sin(ts*0.0013); const gr=sctx.createRadialGradient(cx,cy,0,cx,cy,r*2.6); gr.addColorStop(0,'rgba(255,255,255,.9)'); gr.addColorStop(1,'rgba(255,255,255,0)'); sctx.globalCompositeOperation='lighter'; sctx.beginPath(); sctx.arc(cx,cy,r*pul*2.2,0,Math.PI*2); sctx.fillStyle=gr; sctx.fill(); sctx.globalCompositeOperation='source-over';
  // rings
  sctx.strokeStyle='rgba(255,255,255,.20)'; [r, r+22].forEach(R=>{ sctx.beginPath(); sctx.arc(cx,cy,R,0,Math.PI*2); sctx.stroke(); });
  // slow beams
  beamA += 0.0025; const A=[beamA, beamA+Math.PI/1.7];
  A.forEach((a,i)=>{ const len=180; const x=cx+Math.cos(a)*len, y=cy+Math.sin(a)*len; const lg=sctx.createLinearGradient(cx,cy,x,y); const hue=i? 'rgba(127,179,255,.95)':'rgba(134,247,214,.95)'; lg.addColorStop(0,'rgba(255,255,255,.0)'); lg.addColorStop(.15,'rgba(255,255,255,.85)'); lg.addColorStop(.7,hue); lg.addColorStop(1,'rgba(255,255,255,0)'); sctx.lineWidth=2; sctx.strokeStyle=lg; sctx.beginPath(); sctx.moveTo(cx,cy); sctx.lineTo(x,y); sctx.stroke(); });
}
new ResizeObserver(resizeStar).observe(star); requestAnimationFrame(function raf(ts){ drawStar(ts); requestAnimationFrame(raf); });

// ----------------- Live results feed -----------------
const resultsEl=document.getElementById('results');
let lastData=null; let engineBusy=false; let previewTimer=null;
function setStatus(s){ document.getElementById('status').textContent=s; }
function setEngineState(s){ document.getElementById('engineState').textContent='Lead Engine • '+s; }

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function hostOf(u){ try{ return new URL(u).hostname; }catch{return '';}}

function estimateSpend(lead){
  // try to parse creatives count from snippet, e.g., "~23 creatives"
  const sn=(lead.snippet||'');
  const m=sn.match(/~\s*(\d+)\s+creatives/i); if(!m) return null;
  const n=Number(m[1]); if(!n||!Number.isFinite(n)) return null;
  const url=(lead.source_url||'');
  let platform='other';
  if(/facebook\.com\/ads\/library/i.test(url)) platform='meta';
  else if(/adstransparency\.google\.com/i.test(url)||/google\.com\/search\?q=site:adstransparency/i.test(url)) platform='google';
  else if(/tiktok\.com/i.test(url)) platform='tiktok';
  const CPM={ meta:180, google:140, tiktok:130, linkedin:220, other:150 }; // $/creative/mo heuristic
  const regCount=(inRegions.value||'').split(',').map(s=>s.trim()).filter(Boolean).length||1;
  const regionF=1 + 0.2 * Math.max(0, regCount-1);
  const est = Math.round((n * (CPM[platform]||CPM.other) * regionF)/50)*50; // nearest $50
  return { est, creatives:n, platform };
}

function leadCard(lead){
  const d=document.createElement('div'); d.className='lead';
  const host=hostOf(lead.source_url);
  d.innerHTML=`<div class="meta">${escapeHtml(lead.platform||'source')} • ${escapeHtml(host)}</div>
    <h4>${escapeHtml(lead.title||'Untitled')}</h4>
    <div class="micro">${escapeHtml(lead.snippet||'')}</div>
    <div class="row">
      <span class="pill hold">Press & hold to reveal</span>
      <button class="btn sec" data-a="why">Why this?</button>
    </div>`;
  // hold-to-reveal friction
  let holdT=null, held=false; const holdEl=d.querySelector('.hold');
  function clearHold(){ if(holdT){ clearTimeout(holdT); holdT=null; holdEl.textContent='Press & hold to reveal'; }}
  d.addEventListener('pointerdown',()=>{ held=false; holdEl.textContent='…'; holdT=setTimeout(()=>{ held=true; holdEl.textContent='Revealed ✔'; }, 1500); });
  ['pointerup','pointerleave'].forEach(ev=> d.addEventListener(ev, clearHold));
  d.querySelector('[data-a=why]').onclick=()=>openWhy(lead);
  return d;
}

function render(){ resultsEl.innerHTML=''; if(!lastData) return; for(const L of lastData.leads){ resultsEl.appendChild(leadCard(L)); } }

async function fetchLeads(){
  try{
    const r=await fetch(API('/api/v1/leads'), { headers: {'x-galactly-user':uid} });
    const data=await r.json(); if(data?.ok){ lastData=data; render(); setStatus('ok'); } else { setStatus('error'); }
    setTimeout(fetchLeads, (data?.nextRefreshSec||15)*1000);
  }catch(e){ setStatus('error'); setTimeout(fetchLeads, 5000); }
}
fetchLeads();

// ----------------- Find now + preview (slow drip) -----------------
function previewLog(line){ const box=document.getElementById('previewLog'); box.textContent += (box.textContent?'\n':'') + line; box.scrollTop = box.scrollHeight; }
function resetPreview(){ document.getElementById('previewLog').textContent=''; document.getElementById('previewState').textContent='starting…'; if(previewTimer) clearInterval(previewTimer); }

async function findNow(){
  const payload={ vendorsite:inVendor.value.trim(), vendorDomain:inVendor.value.trim(), buyers:(inSeeds.value||'').split(',').map(s=>s.trim()).filter(Boolean), industries:(inIndustries.value||'').split(',').map(s=>s.trim()).filter(Boolean), regions:(inRegions.value||'').split(',').map(s=>s.trim()).filter(Boolean) };
  localStorage.setItem('on_vendor', inVendor.value.trim()); localStorage.setItem('on_buyers', inSeeds.value.trim()); localStorage.setItem('on_inds', inIndustries.value.trim()); localStorage.setItem('on_regs', inRegions.value.trim()); localStorage.setItem('on_brief', inBrief.value.trim());
  resetPreview(); engineBusy=true; setEngineState('scanning…');
  // Slow-drip preview for ~30s regardless of API speed
  const steps=[
    'Normalize inputs',
    'Scan paid-reach libraries',
    'Scan vendor intake pages',
    'Scan product/pack pages',
    'Insert leads → score queue',
  ];
  let i=0; previewTimer=setInterval(()=>{ if(i<steps.length){ previewLog('• ' + steps[i]); i++; } else { previewLog('• …continuing background checks'); } }, 6000);
  try{
    await fetch(API('/api/v1/find-now'), { method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body: JSON.stringify({ buyers: payload.buyers, industries: payload.industries, regions: payload.regions, vendorDomain: payload.vendorDomain }) });
  }catch(e){}
  // stop after ~30s
  setTimeout(()=>{ if(previewTimer) clearInterval(previewTimer); document.getElementById('previewState').textContent='complete (free mode)'; engineBusy=false; setEngineState('idle'); }, 30000);
}

const btnFind=document.getElementById('btnFind');
btnFind.onclick=()=>{ btnFind.textContent = (inVendor.value||inSeeds.value)?'Save & run':'Find now'; findNow(); };

// ----------------- Why this modal -----------------
const whyEl=document.getElementById('whyOverlay'); document.getElementById('closeWhy').onclick=()=>whyEl.style.display='none';
function openWhy(lead){
  const sumEl=document.getElementById('whySummary'); const tbl=document.getElementById('whyTable'); const proof=document.getElementById('whyProof');
  tbl.innerHTML=''; proof.innerHTML='';
  const rows=[];
  // 1) Paid reach (ad spend est.)
  const est=estimateSpend(lead);
  if(est){ rows.push(['Paid reach','<span class="num">$'+est.est.toLocaleString()+'</span> / mo on '+est.platform.toUpperCase()+', ~'+est.creatives+' creatives']); }
  // 2) Category hints
  if((lead.platform||'').includes('brandintake')) rows.push(['Supplier/Procurement','Has vendor intake • prospects likely purchasing supplies → packaging need.']);
  if((lead.platform||'').includes('pdp')||lead.cat==='product') rows.push(['Product movement','SKU/pack page or restock indicates sales velocity → pack replenishment.']);
  if((lead.platform||'').includes('adlib')) rows.push(['Acquisition motion','Active paid reach to acquire customers → likely ongoing packaging usage.']);
  // 3) Generic chips
  rows.push(['Confidence', (lead.heat?('<span class="num">'+lead.heat+'%</span>'): '—') + ' Based on recency, platform quality and fit.']);

  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML='<td class="micro" style="width:34%">'+r[0]+'</td><td>'+r[1]+'</td>'; tbl.appendChild(tr); });
  sumEl.textContent = hostOf(lead.source_url) + ' • '+ (lead.title||'');
  proof.innerHTML = '<div style="margin-top:8px" class="micro">Proof: <a href="'+lead.source_url+'" target="_blank" rel="noopener">open source link</a></div>';
  whyEl.style.display='flex';
}
</script>
</body>
</html>
