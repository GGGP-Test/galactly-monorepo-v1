<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Free Panel</title>
  <style>
    :root{
      --bg:#0b0e13;--card:#101722;--line:#1c2533;--text:#e8ecf1;--muted:#a7b0bf;--brand:#74b4ff;--good:#3fd97b;--warm:#ffb454;--hot:#ff6a6a;
      --accent:#2a3b55;--accent-2:#172032;--glass:rgba(15,19,27,.7);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(0deg,rgba(11,14,19,.2),rgba(11,14,19,.9));backdrop-filter:saturate(140%) blur(6px)}
    h1{font-size:16px;margin:0;display:flex;gap:8px;align-items:center}
    .pill{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}

    .onboard-tip{margin:6px 0 14px 0;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px;position:relative;overflow:hidden}
    .meta{color:var(--muted);font-size:12px}
    .title{font-weight:600}
    .bar{height:6px;background:var(--accent-2);border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--good),var(--warm),var(--hot));width:0%}
    .actions{display:flex;align-items:center;gap:8px;margin-top:2px}
    .btn{appearance:none;border:1px solid var(--accent);background:var(--accent-2);color:var(--text);border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .ghost{border-color:var(--line);background:transparent}

    .hold-veil{position:absolute;inset:0;background:linear-gradient(180deg,rgba(13,18,27,.2),rgba(13,18,27,.85));display:flex;align-items:center;justify-content:center;gap:10px}
    .ring{--d:42px;width:var(--d);height:var(--d);border-radius:50%;border:3px solid var(--line);border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px}
    .modal.on{display:flex;background:rgba(5,8,12,.66);backdrop-filter:blur(6px)}
    .sheet{width:min(720px,96vw);max-height:88vh;overflow:auto;background:#0f1622;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 80px rgba(0,0,0,.45)}
    .sheet header{position:sticky;top:0;background:#0f1622;border-bottom:1px solid var(--line);padding:12px 16px}
    .sheet .body{padding:16px}
    .x{float:right;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:18px}

    .tabs{display:flex;gap:8px;margin:6px 0 12px 0}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:var(--accent-2)}
    .tab.on{border-color:var(--brand);box-shadow:inset 0 0 0 1px var(--brand)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type=text],textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b1320;color:var(--text)}
    textarea{min-height:96px}

    .gauge{display:flex;align-items:center;gap:10px}
    .gauge i{display:block;height:10px;border-radius:8px;background:linear-gradient(90deg,var(--good),var(--warm),var(--hot));width:160px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px;margin:10px 0}
    .kv .k{color:var(--muted)}

    .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:var(--glass);border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none}
    .toast.on{display:block}
  </style>
</head>
<body>
  <header>
    <h1>Galactly <span class="pill" id="pill">connecting…</span></h1>
    <div class="meta">
      <span style="opacity:.8">API:</span>
      <input id="apiBase" style="width:360px"/>
      <button class="btn ghost" id="saveApi">Save</button>
    </div>
  </header>

  <div class="wrap">
    <div id="quota" class="onboard-tip"></div>
    <div id="feed" class="grid"></div>
  </div>

  <!-- Onboarding modal -->
  <div class="modal" id="onb">
    <div class="sheet">
      <header>
        <strong>Quick onboarding</strong>
        <button class="x" id="xOnb">✕</button>
      </header>
      <div class="body">
        <p class="onboard-tip">Pick one path. We’ll fetch a tiny set of high-signal buyers and show up to <strong>2 full reveals/day</strong> on the free plan.</p>
        <div class="tabs">
          <button class="tab on" data-tab="auto">Auto (enter your website)</button>
          <button class="tab" data-tab="manual">Manual (choose ICP)</button>
        </div>
        <div id="tab-auto">
          <div class="row">
            <div style="flex:2">
              <label>Your website</label>
              <input type="text" id="vendorDomain" placeholder="acme-packaging.com"/>
            </div>
            <div style="flex:1">
              <label>Region</label>
              <select id="regionAuto">
                <option>US</option>
                <option>CA</option>
                <option>EU</option>
                <option>UK</option>
                <option>AU</option>
              </select>
            </div>
          </div>
          <button class="btn" id="goAuto">Find buyers now</button>
        </div>
        <div id="tab-manual" style="display:none">
          <div class="row">
            <div style="flex:2">
              <label>Example buyers (domains, comma separated)</label>
              <input type="text" id="buyers" placeholder="liquiddeath.com, soylent.com"/>
            </div>
            <div style="flex:1">
              <label>Industries (comma separated)</label>
              <input type="text" id="industries" placeholder="beverage, candy, supplements"/>
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Regions (comma separated)</label>
              <input type="text" id="regions" placeholder="US, CA"/>
            </div>
          </div>
          <button class="btn" id="goManual">Find buyers now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail modal (opens after hold-to-reveal) -->
  <div class="modal" id="detail">
    <div class="sheet">
      <header>
        <strong id="dTitle">Lead details</strong>
        <button class="x" id="xDetail">✕</button>
      </header>
      <div class="body" id="dBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ---------- API base helper ----------
  const DEFAULT_BASE = localStorage.getItem('api_base') || 'https://p01--animated-cellar--vz4ftkwrzdfs.code.run';
  const apiInput = document.getElementById('apiBase');
  apiInput.value = DEFAULT_BASE;
  document.getElementById('saveApi').onclick = ()=>{ localStorage.setItem('api_base', apiInput.value.trim()); tip('Saved API base'); setTimeout(()=>location.reload(), 450); };
  const API = (p)=> (localStorage.getItem('api_base') || DEFAULT_BASE).replace(/\/$/,'') + p;

  // ---------- identity ----------
  const uidKey='galactly_uid';
  let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }

  // ---------- daily reveal quota ----------
  const DAILY_FREE = Number(localStorage.getItem('FREE_DAILY')||'2'); // can change via feature flags
  function keyForToday(){ const d=new Date(); return reveal_${d.getUTCFullYear()}-${d.getUTCMonth()+1}-${d.getUTCDate()}; }
  function getReveals(){ const k=keyForToday(); return Number(localStorage.getItem(k)||'0'); }
  function addReveal(){ const k=keyForToday(); const v=getReveals()+1; localStorage.setItem(k, String(v)); return v; }
  function leftToday(){ return Math.
    max(0, DAILY_FREE - getReveals()); }

  function tip(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('on'); setTimeout(()=>t.classList.remove('on'), 1400); }

  // ---------- fetch helpers ----------
  async function get(path){ const r=await fetch(API(path), { headers:{'x-galactly-user':uid} }); if(!r.ok) throw new Error(r.status+''); return r.json(); }
  async function post(path, body){ const r=await fetch(API(path), { method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body: JSON.stringify(body||{}) }); if(!r.ok) throw new Error(r.status+''); return r.json(); }
  async function event(type, meta){ try{ await post('/api/v1/events', { type, ...meta }); } catch(e){} }

  // ---------- onboarding ----------
  const onb = document.getElementById('onb');
  const tabs = [...document.querySelectorAll('.tab')];
  tabs.forEach(btn=> btn.onclick = ()=>{
    tabs.forEach(b=>b.classList.remove('on')); btn.classList.add('on');
    const t = btn.dataset.tab; document.getElementById('tab-auto').style.display = t==='auto'? 'block':'none'; document.getElementById('tab-manual').style.display = t==='manual'? 'block':'none';
  });
  document.getElementById('xOnb').onclick = ()=> onb.classList.remove('on');
  document.getElementById('goAuto').onclick = async ()=>{
    const vendorDomain = document.getElementById('vendorDomain').value.trim();
    const region = document.getElementById('regionAuto').value;
    if(!vendorDomain){ tip('Enter your website'); return; }
    try{
      const r = await post('/api/v1/find-now', { vendorDomain, regions:[region] });
      tip(`Checked ${r.checked||0}, created ${r.created||0}`);
      onb.classList.remove('on');
      fetchLeads(true);
    }catch(e){ tip('Failed to run finder'); }
  };
  document.getElementById('goManual').onclick = async ()=>{
    const buyers = document.getElementById('buyers').value.split(',').map(s=>s.trim()).filter(Boolean);
    const industries = document.getElementById('industries').value.split(',').map(s=>s.trim()).filter(Boolean);
    const regions = document.getElementById('regions').value.split(',').map(s=>s.trim()).filter(Boolean);
    if(!buyers.length && !industries.length){ tip('Add buyers or industries'); return; }
    try{
      const r = await post('/api/v1/find-now', { buyers, industries, regions });
      tip(`Checked ${r.checked||0}, created ${r.created||0}`);
      onb.classList.remove('on');
      fetchLeads(true);
    }catch(e){ tip('Failed to run finder'); }
  };

  // ---------- feed ----------
  const feed = document.getElementById('feed');
  const pill = document.getElementById('pill');
  const quota = document.getElementById('quota');
  let cache = { leads:[], nextRefreshSec: 20 };

  function hostOf(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch(e){ return ''; } }
  function brandFrom(lead){ const t=(lead.title||'').trim(); if(t) return t.replace(/\s+\|.+$/,'').slice(0,120); const h=hostOf(lead.source_url); return h||'Untitled'; }

  function card(lead){
    const el = document.createElement('div'); el.className='card';
    const heat = Number(lead.heat||0); const pct = Math.max(0, Math.min(100, heat));

    // Visuals
    el.innerHTML = `
      <div class="meta">${(lead.platform||'source').toUpperCase()} • ${hostOf(lead.source_url)}</div>
      <div class="title">${escapeHtml(brandFrom(lead))}</div>
      <div class="bar"><i style="width:${pct}%"></i></div>
      <div class="actions">
        <button class="btn" data-act="hold">Press & Hold to reveal</button>
        <span class="meta" style="margin-left:auto">heat ${heat}</span>
      </div>
    `;

    // Hold-to-reveal behavior with quota
    const btn = el.querySelector('[data-act=hold]');
    let t, held=false; const HOLD_MS = 1000;
    const start = ()=>{
      if(leftToday()<=0){ tip('Free reveals used up today'); return; }
      btn.textContent='Hold…'; btn.disabled=true; held=false;
      t=setTimeout(async ()=>{ held=true; await reveal(lead); btn.textContent='Press & Hold to reveal'; btn.
        disabled=false; }, HOLD_MS);
    };
    const cancel = ()=>{ clearTimeout(t); if(!held){ btn.textContent='Press & Hold to reveal'; btn.disabled=false; } };
    btn.addEventListener('mousedown', start);
    btn.addEventListener('touchstart', start);
    ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> btn.addEventListener(ev, cancel));

    return el;
  }

  async function reveal(lead){
    const used = addReveal(); quotaText(); await event('reveal', { leadId: lead.id, type:'reveal', meta:{ source: lead.platform } });
    openDetail(lead);
  }

  function render(){
    feed.innerHTML='';
    quotaText();
    const items = cache.leads.slice(0, 2); // hard-limit for free
    for(const L of items){ feed.appendChild(card(L)); }
  }
  function quotaText(){ quota.innerHTML = Free reveals left today: <strong>${leftToday()}</strong> / ${DAILY_FREE}; }

  async function fetchLeads(force=false){
    try{
      pill.textContent='loading…';
      const data = await get('/api/v1/leads');
      cache = data; render(); pill.textContent='ok';
      if(!force) setTimeout(fetchLeads, (data.nextRefreshSec||20)*1000);
    }catch(e){ pill.textContent='error'; setTimeout(fetchLeads, 6000); }
  }

  // ---------- detail modal ----------
  const detail = document.getElementById('detail');
  const dBody = document.getElementById('dBody');
  document.getElementById('xDetail').onclick = ()=> detail.classList.remove('on');

  function openDetail(lead){
    document.getElementById('dTitle').textContent = brandFrom(lead);
    const host = hostOf(lead.source_url);
    const conf = Number(lead.heat||0);
    const confLabel = conf>=80? 'On fire' : conf>=65? 'Hot' : conf>=50? 'Warm' : 'Cold';

    // Minimal reasons — avoids raw URLs on the card; offers proof links inside
    const proofBtn = (lead.platform||'').toLowerCase().includes('ad')
      ? <button class="btn" data-act="proof">Open proof</button>
      : <button class="btn" data-act="open">Open page</button>;

    dBody.innerHTML = `
      <div class="gauge"><strong>Confidence:</strong> <i></i> <span>${conf} — ${confLabel}</span></div>
      <div class="kv">
        <div class="k">Domain</div><div>${escapeHtml(host)}</div>
        <div class="k">Source</div><div>${escapeHtml(lead.platform||'source')}</div>
        <div class="k">Why this showed up</div><div>${escapeHtml((lead.snippet||'').slice(0,220))}</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">${proofBtn}
        <button class="btn" data-act="claim">Claim</button>
      </div>
    `;

    detail.classList.add('on');

    // wire buttons
    const openProof = ()=>{ window.open(lead.source_url,'_blank','noopener'); event('click',{ leadId: lead.id, type:'click', meta:{url:lead.source_url}}); };
    const claim = async ()=>{
      try{ const r = await post('/api/v1/claim', { leadId: lead.id }); if(r?.ok){ tip('Reserved for 2 min'); detail.classList.remove('on'); } }
      catch(e){ tip('Claim failed'); }
    };
    const bProof = dBody.querySelector('[data-act=proof]'); if(bProof) bProof.onclick = openProof;
    const bOpen = dBody.querySelector('[data-act=open]'); if(bOpen) bOpen.onclick = openProof;
    dBody.querySelector('[data-act=claim]').onclick = claim;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // ---------- boot ----------
  (async function boot(){
    // status ping (optional)
    try{ const st = await get('/api/v1/status'); document.getElementById('pill').textContent = 'ok'; } catch(e){ }
    // show onboarding on first visit or when no reveals yet and no leads cached
    const first = !localStorage.getItem('onb_done');
    if(first) { document.getElementById('onb').classList.add('on'); localStorage.setItem('onb_done','1'); }
    fetchLeads(true);
  })();
</script>
</body>
</html>
