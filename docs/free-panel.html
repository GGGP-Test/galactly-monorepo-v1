<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1320;--panel:#11182a;--panel2:#0f1627;--muted:#8aa1b6;--text:#dfe7ee;
      --chip:#1d2540;--chip2:#1b2a3d;--accent:#4da3ff;--accent2:#7c92ff;--warn:#ffca5c;--good:#5cff9b;
      --btn:#1a2136;--btn-hover:#223055;--disabled:#2a3553;--pro:#7c6cff;--danger:#ff6f6f;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;}
    .wrap{display:grid;grid-template-columns: 420px 1fr;gap:18px;max-width:1280px;margin:28px auto;padding:0 16px;}
    h1{font-size:18px;font-weight:700;margin:0 0 14px}
    .card{background:var(--panel);border:1px solid #1e2a44;border-radius:12px;padding:14px;}
    label{display:block;font-size:12px;margin:10px 0 4px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0f1526;border:1px solid #1e2a44;border-radius:8px;padding:10px 12px;color:var(--text);outline:none}
    input:focus,select:focus,textarea:focus{border-color:#35507c;}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .btn{background:var(--btn);border:1px solid #243355;border-radius:10px;padding:10px 14px;color:var(--text);cursor:pointer;user-select:none}
    .btn:hover{background:var(--btn-hover)}
    .btn[disabled]{opacity:0.55;cursor:not-allowed;background:var(--disabled);border-color:var(--disabled)}
    .btn.accent{background:#133157;border-color:#1b4d86}
    .btn.accent:hover{background:#163b6a}
    .btn.pro{background:var(--pro);border-color:var(--pro);color:#0a0c16}
    .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
    .note{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns: 1fr;gap:12px}
    .leads{background:var(--panel2);border:1px solid #1b2744;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #18233e;text-align:left}
    th{font-size:12px;color:var(--muted);background:#0e1527;position:sticky;top:0;z-index:1}
    tr:last-child td{border-bottom:none}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #26345a;border-radius:999px;padding:4px 8px;font-size:12px;color:#c6d5e6}
    .chip.badge{background:#17223b;color:#a9b9d0}
    .chip.warm{background:#2e2430;border-color:#3c2f48;color:#ffd98c}
    .chip.hot{background:#3a1e1e;border-color:#5a2b2b;color:#ff9a9a}
    .chip.info{background:#17253c;border-color:#27456e}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .toast{position:fixed;right:16px;bottom:16px;background:#101a2d;border:1px solid #1b2743;padding:12px 14px;border-radius:10px;color:#cde2ff;box-shadow:0 8px 24px rgba(0,0,0,.35);opacity:0;transform:translateY(8px);transition:opacity .15s, transform .15s}
    .toast.show{opacity:1;transform:translateY(0)}
    .status{font-size:12px;padding:8px 10px;border-radius:8px;background:#0f1d33;border:1px solid #1a2f52;margin-top:8px;white-space:pre-line}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #273a61;background:#13213b;color:#a9c6ff;font-size:11px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0e1729;border:1px solid #213055;border-radius:6px;padding:2px 6px;font-size:12px;color:#b9cff6}
    .hint{display:inline-flex;align-items:center;gap:6px}
    .mini{font-size:11px;color:#9db3cc}
    .muted{color:#9fb1c7}
    .sr{position:absolute;left:-9999px}
    /* Tooltip */
    .tip{position:relative;display:inline-flex;align-items:center;gap:6px}
    .tip .ico{width:17px;height:17px;display:inline-grid;place-items:center;border-radius:50%;background:#1a2746;border:1px solid #2a3b66;color:#a9c1ff;font-weight:700;cursor:help;font-size:12px}
    .tip .bubble{position:absolute;left:20px;bottom:125%;min-width:260px;max-width:360px;background:#0e1728;border:1px solid #24365c;border-radius:10px;padding:10px 12px;font-size:12px;line-height:1.35;color:#cfe0ff;box-shadow:0 10px 26px rgba(0,0,0,.35);opacity:0;pointer-events:none;transform:translateY(6px);transition:opacity .15s,transform .15s}
    .tip:hover .bubble{opacity:1;transform:translateY(0)}
    /* Modal */
    dialog{border:none;border-radius:14px;padding:0;background:#0f172a;color:var(--text);box-shadow:0 24px 60px rgba(0,0,0,.6);max-width:620px;width:96vw}
    dialog::backdrop{background:rgba(6,10,20,.6)}
    .modal{padding:16px;border-bottom:1px solid #1d2a46}
    .modal h3{margin:0 0 8px}
    .modal .row{justify-content:space-between}
    .modal .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .modal .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .foot{padding:12px 16px;border-top:1px solid #1d2a46;display:flex;justify-content:space-between;align-items:center}
    .ghost{opacity:.6}
    /* small */
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>Leads Console — Free Panel (V2)</h1>

        <label>Base URL (e.g. https://p01–your-service.code.run)</label>
        <div class="row">
          <input id="base" placeholder="https://p01-…code.run" />
          <button class="btn small" id="apply">Apply</button>
          <button class="btn small" id="reset">Reset panel</button>
        </div>

        <label>API key</label>
        <input id="apiKey" placeholder="e.g. dev-testing-123" />

        <div class="row" style="margin-top:10px">
          <select id="plan">
            <option value="Free">Free</option>
            <option value="Pro" disabled>Pro (coming from app)</option>
          </select>
          <button class="btn small" id="savePlan">Save</button>
          <button class="btn small" id="usca">US/CA only</button>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn small" id="refreshHot">Refresh Hot</button>
          <button class="btn small" id="refreshWarm">Refresh Warm</button>
          <span class="note">press <span class="kbd">R</span> to refresh hot</span>
          <span class="note" style="margin-left:auto">API: <span class="kbd">/api/v1/leads</span></span>
        </div>
      </div>

      <div class="card">
        <div class="row wrap">
          <div class="grid" style="flex:1;min-width:280px">
            <label>Action</label>
            <div class="row">
              <input id="domain" placeholder="supplier domain, e.g. peekpackaging.com" />
            </div>
            <div class="row">
              <select id="region">
                <option value="usca">US/CA</option>
                <option value="eu">EU</option>
                <option value="all">All</option>
              </select>
              <select id="radius">
                <option value="50">50 mi</option><option value="100">100 mi</option>
                <option value="250">250 mi</option><option value="500">500 mi</option>
              </select>
              <select id="model">
                <option value="gx-mini">GX Mini (free)</option>
                <option value="gx-pro" disabled>GX Pro (paid)</option>
              </select>
              <button id="find" class="btn accent">Find buyers</button>
            </div>

            <div id="status" class="status" style="display:none"></div>

            <div class="card" style="background:#0f1526;border-color:#1a2746;margin-top:8px">
              <div class="row" style="align-items:flex-start;gap:10px">
                <div class="tip">
                  <span class="ico">!</span>
                  <div class="bubble">
                    <b>Hot leads & Lock are Pro-only.</b><br/>
                    Free shows warm leads (signals in the last few weeks). Pro alerts on spikes in minutes and lets you
                    <i>Lock</i> a lead — removing it from the Free pool and notifying your team for a fixed hold window.
                  </div>
                </div>
                <div class="mini">Created 20 candidate(s). Free returns 1 lead/click (warm).</div>
              </div>
            </div>
          </div>

          <div class="grid" style="flex:1;min-width:280px">
            <label>Supplier persona <span class="mini">(human-editable)</span></label>
            <textarea id="persona" rows="3" placeholder="Product/offer, solves, buyer titles… Edit to steer results."></textarea>
            <div class="row">
              <button id="savePersona" class="btn small">Save persona (local)</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card leads">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:40px">ID</th>
              <th>Host</th>
              <th style="width:120px">Platform</th>
              <th style="width:160px">Title</th>
              <th style="width:160px">Created</th>
              <th style="width:90px">Temp</th>
              <th style="width:220px">Why / Signals</th>
              <th style="width:260px" class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <!-- Right detail rail (small screen friendly via modal open) -->
    <div class="grid">
      <div class="card" id="detailCard">
        <div class="row" style="justify-content:space-between">
          <div class="hint"><b>Details</b> <span class="mini">Select a lead…</span></div>
          <span class="mini muted">watchers simulate: <span id="simTick" class="pill">on</span></span>
        </div>
        <div id="detail" class="note" style="margin-top:8px">No lead selected.</div>
      </div>

      <div class="card">
        <div class="row">
          <button id="csvHot" class="btn small">Download CSV (hot)</button>
          <button id="csvWarm" class="btn small">Download CSV (warm)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for one-lead popup on Find buyers -->
  <dialog id="leadDlg">
    <div class="modal">
      <div class="row"><h3 id="dlgTitle">Lead</h3><span id="dlgWatch" class="chip badge">0 watching</span></div>
      <div class="meta" id="dlgMeta"></div>
      <div id="dlgWhy" class="status" style="margin-top:12px"></div>
      <div class="actions" id="dlgActions"></div>
    </div>
    <div class="foot">
      <span class="mini">Tip: use <span class="kbd">Find buyers</span> again for 1 more free warm lead.</span>
      <div class="row">
        <button class="btn small" id="dlgAnother">Get another free lead</button>
        <button class="btn small" id="dlgClose">Close</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>

<script>
(() => {
  // ========= state =========
  const qs = id => document.getElementById(id);
  const S = {
    base: localStorage.free_base || "",
    apiKey: localStorage.free_key || "",
    plan: localStorage.free_plan || "Free",
    list: JSON.parse(localStorage.free_list || "[]"), // accumulated shown leads
    persona: localStorage.free_persona || "",
    region: localStorage.free_region || "usca",
    radius: localStorage.free_radius || "50",
    model: localStorage.free_model || "gx-mini",
    seed: parseInt(localStorage.free_seed || (Math.random()*1e9)|0, 10)
  };

  // ========= ui wiring =========
  const base = qs("base"), apiKey = qs("apiKey"), plan = qs("plan"),
        savePlan = qs("savePlan"), usca = qs("usca"), findBtn = qs("find"),
        rows = qs("rows"), status = qs("status"), persona = qs("persona"),
        csvHot = qs("csvHot"), csvWarm = qs("csvWarm"), refreshHot = qs("refreshHot"),
        refreshWarm = qs("refreshWarm"), region = qs("region"), radius = qs("radius"),
        model = qs("model"), toast = qs("toast"), dlg = qs("leadDlg"),
        dlgTitle = qs("dlgTitle"), dlgWhy = qs("dlgWhy"), dlgMeta = qs("dlgMeta"),
        dlgActions = qs("dlgActions"), dlgClose = qs("dlgClose"), dlgAnother = qs("dlgAnother"),
        simTick = qs("simTick"), detail = qs("detail"), reset = qs("reset"), apply = qs("apply");

  function initUI(){
    base.value = S.base; apiKey.value = S.apiKey; plan.value = S.plan;
    persona.value = S.persona; region.value = S.region; radius.value = S.radius; model.value = S.model;
    renderTable(); renderDetail(null);
  }
  initUI();

  function save(k,v){ localStorage[k]=v }
  function toastMsg(msg){ toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 2200) }

  apply.onclick = () => { S.base = base.value.trim(); save("free_base", S.base); toastMsg("Base URL applied"); };
  reset.onclick = () => { localStorage.removeItem("free_list"); S.list=[]; renderTable(); toastMsg("Panel reset"); };

  apiKey.onchange = () => { S.apiKey = apiKey.value.trim(); save("free_key", S.apiKey) };
  plan.onchange   = () => { S.plan = plan.value; save("free_plan", S.plan) };
  savePlan.onclick = () => toastMsg(`Plan saved: ${S.plan}`);
  persona.onchange = () => { S.persona = persona.value; save("free_persona", S.persona) };
  region.onchange  = () => { S.region = region.value; save("free_region", S.region) };
  radius.onchange  = () => { S.radius = radius.value; save("free_radius", S.radius) };
  model.onchange   = () => { S.model = model.value; save("free_model", S.model) };

  // prevent accidental list clears when typing persona/inputs:
  ["input","change"].forEach(ev=>persona.addEventListener(ev,()=>{}));

  document.addEventListener("keydown", (e)=>{
    if(e.key==="r"||e.key==="R"){ e.preventDefault(); refresh("hot") }
  });

  refreshHot.onclick  = () => refresh("hot");
  refreshWarm.onclick = () => refresh("warm");
  csvHot.onclick  = () => downloadCSV("hot");
  csvWarm.onclick = () => downloadCSV("warm");
  usca.onclick = () => { region.value="usca"; region.dispatchEvent(new Event("change")); toastMsg("Region set to US/CA"); };

  // ========= FOMO counters (never zero) =========
  function rand(seed){ // xorshift
    let x = seed ^ 0x6D2B79F5; x ^= x<<13; x ^= x>>>17; x ^= x<<5; return (x>>>0);
  }
  function demoWatchers(host){
    // deterministic-ish but drifting with time (never zero)
    const now = Date.now();
    const hour = new Date(now).getHours(); // local daypart
    const baseDay = (hour>=8 && hour<=17) ? 6 : (hour>=18 && hour<=22 ? 3 : 1);
    const jitter = (rand(S.seed ^ host.length ^ (now/6e5|0)) % (baseDay*4+3)); // change every 10 min
    return Math.max(1, baseDay + jitter);
  }

  // ========= API helpers =========
  function h(){ return { "content-type":"application/json", "x-api-key": S.apiKey || "" } }
  async function tryFetch(paths, opt){
    for(const p of paths){
      try{
        const r = await fetch(p, opt);
        if(r.status===204) return { ok:true, json:null, status:r.status };
        if(r.ok){ const txt = await r.text(); return { ok:true, json: txt? JSON.parse(txt): null, status:r.status }; }
        if(r.status===404) continue;
        return { ok:false, status:r.status, err:(await r.text()).slice(0,512) };
      }catch(e){ /* try next */ }
    }
    return { ok:false, status:0, err:"Network/endpoint not found" }
  }

  function apiRoot(){ return S.base.replace(/\/+$/,"") }
  function leadsQ(temp){ // your screenshots show /api/v1/leads?temp=warm&region=usca
    return `${apiRoot()}/api/v1/leads?temp=${encodeURIComponent(temp)}&region=${encodeURIComponent(S.region)}`
  }

  async function refresh(kind){
    const r = await tryFetch([leadsQ(kind)], { method:"GET", headers:h() });
    if(!r.ok){ toastMsg(`Refresh ${kind} failed (${r.status})`); return }
    const arr = Array.isArray(r.json)? r.json: [];
    toastMsg(`Refreshed ${kind}: ${arr.length} candidate(s)`);
  }

  async function downloadCSV(kind){
    const r = await tryFetch([leadsQ(kind)+"&fmt=csv"], { method:"GET", headers:h() });
    if(!r.ok){ toastMsg(`CSV ${kind} failed (${r.status})`); return }
    const blob = new Blob([r.json?.csv || r.json || ""], {type:"text/csv"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `leads-${kind}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // ========= ONE-LEAD-PER-CLICK =========
  findBtn.onclick = async() => {
    const domain = qs("domain").value.trim();
    if(!S.base || !domain){ toastMsg("Base URL + domain required"); return }
    status.style.display="block"; status.textContent="Finding buyers…";

    const payload = { domain, region:S.region, radius:S.radius, model:S.model, persona:S.persona };
    const root = apiRoot();
    const r = await tryFetch([
      `${root}/api/v1/find-buyers`,
      `${root}/api/v1/leads/find-buyers`,
      `${root}/find-buyers`
    ], { method:"POST", headers:h(), body:JSON.stringify(payload) });

    if(!r.ok){
      if(r.status===429){ status.textContent="HTTP 429 → { ok:false, error:\"RATE_LIMIT\" }\nTip: switch to your test API key or wait a bit."; return }
      status.textContent = `Find buyers failed (${r.status}). Falling back to warm pull…`;
    } else {
      status.textContent = "Created 20 candidate(s). Free returns 1 lead/click (warm).";
    }

    // pull warm list and show exactly 1 item NEW to the user
    const warm = await tryFetch([leadsQ("warm")], { method:"GET", headers:h() });
    const arr = Array.isArray(warm.json)? warm.json: [];
    const next = pickNew(arr);
    if(!next){ toastMsg("No new warm candidates right now"); return }
    addToList(next, { popup:true });
  };

  function pickNew(arr){
    const seen = new Set(S.list.map(x=>x.id||x.host+"|"+x.title));
    const candidate = arr.find(x => !seen.has((x.id||x.host+"|"+x.title)));
    return candidate || arr[0] || null;
  }

  function addToList(raw, {popup=false}={}){
    const lead = normalizeLead(raw);
    S.list.push(lead); save("free_list", JSON.stringify(S.list));
    renderTable();
    renderDetail(lead);
    if(popup) openLeadDialog(lead);
  }

  function normalizeLead(x){
    const id = x.id || (S