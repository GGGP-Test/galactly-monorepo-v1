<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V3)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111a2e; --muted:#9aa5b1; --text:#e5e7eb; --chip:#1f2a44; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px;box-sizing:border-box;height:100%;}
    .card{background:var(--panel);border-radius:10px;padding:14px;box-shadow:0 0 0 1px #1c2541 inset;}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0;}
    label{display:block;margin:8px 0 4px 2px;color:var(--muted);}
    input[type=text],select{width:100%;padding:9px 10px;border-radius:8px;border:1px solid #2a3558;background:#0b1224;color:var(--text);}
    button{padding:9px 12px;border:0;border-radius:8px;background:#1d4ed8;color:#fff;cursor:pointer}
    button.secondary{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .status{min-height:20px;margin-top:6px}
    .status.ok{color:#86efac}
    .status.err{color:#fca5a5}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a44;vertical-align:top}
    th{color:#93a3b8;text-align:left;position:sticky;top:0;background:var(--panel)}
    .chip{background:var(--chip);border-radius:999px;padding:3px 8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3 style="margin:2px 0 10px">Leads Console — Free Panel (V3)</h3>

      <label for="base">API base</label>
      <div class="row">
        <input id="base" type="text" placeholder="https://p01-…code.run" />
        <button id="apply">Apply</button>
      </div>

      <label for="apikey">API key (optional for read; required for write)</label>
      <div class="row">
        <input id="apikey" type="text" class="mono" placeholder="paste key…" />
        <button id="saveKey" class="secondary">Save</button>
      </div>

      <div class="row toolbar">
        <button id="refreshHot" class="secondary">Refresh Hot</button>
        <button id="refreshWarm" class="secondary">Refresh Warm</button>
        <span class="muted">API root: <span class="mono" id="apiRoot">/api/v1</span></span>
      </div>

      <hr style="border:0;border-top:1px solid #1f2a44;margin:12px 0" />

      <div class="card" style="background:#0f162c">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">Action</div>
          <div class="chip">Find buyers (one per click)</div>
        </div>

        <label for="supplierHost">Supplier host</label>
        <input id="supplierHost" type="text" placeholder="e.g. peekpackaging.com" />

        <div class="row">
          <select id="country">
            <option value="US/CA">US/CA</option>
            <option value="US">US</option>
            <option value="CA">CA</option>
            <option value="EU">EU</option>
          </select>
          <select id="radiusMi">
            <option value="25">25 mi</option>
            <option value="50" selected>50 mi</option>
            <option value="100">100 mi</option>
            <option value="250">250 mi</option>
          </select>
          <button id="find">Find buyers</button>
        </div>

        <div id="findMsg" class="status"></div>
      </div>

      <label>Supplier persona <span class="muted">(used to infer intent)</span></label>
      <input id="p_offer"  type="text" placeholder="Product/offer (e.g. Stretch film & pallet protection)" />
      <input id="p_solves" type="text" placeholder="Solves (e.g. Keeps pallets secure for storage/transport)" />
      <input id="p_titles" type="text" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing" />
      <div class="row">
        <button id="personaSave" class="secondary">Save persona (local)</button>
      </div>

      <div class="row toolbar">
        <button id="csvHot"  class="secondary">Download CSV (hot)</button>
        <button id="csvWarm" class="secondary">Download CSV (warm)</button>
      </div>

      <div id="status" class="status muted"></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why (human-readable)</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>

<script>
  // ---- tiny state
  const S = { base:'', apiKey:'', items:[], persona:null, root:'/api/v1' };

  // ---- helpers
  const $ = (id) => document.getElementById(id);
  const setVal = (id, v) => { const el = $(id); if (el) el.value = v; };
  const on = (id, ev, fn) => { const el = $(id); if (el) el.addEventListener(ev, fn); };

  function toast(msg, ok=false) {
    const el = $('#status'); if (!el) return console[ok?'log':'warn'](msg);
    el.textContent = msg; el.classList.remove('ok','err'); el.classList.add(ok?'ok':'err');
  }
  function setFindMsg(msg, ok=false) {
    const el = $('#findMsg'); if (!el) return;
    el.textContent = msg; el.classList.remove('ok','err'); if (msg) el.classList.add(ok?'ok':'err');
  }
  function setBase(v) {
    S.base = (v||'').trim().replace(/\/+$/,'');
    const root = $('#apiRoot'); if (root) root.textContent = S.root;
  }

  // Robust fetch that auto-reads Base + Key from inputs if missing
  async function call(method, path, body=null, query=null) {
    // Prefer state, but fall back to input boxes so Apply/Save are optional
    let base = S.base || ($('#base')?.value || '').trim();
    if (base && !S.base) { setBase(base); localStorage.setItem('base', base); }
    if (!base) return { ok:false, status:0, data:{ ok:false, error:'no base set' } };

    let key = S.apiKey || ($('#apikey')?.value || '').trim();
    if (key && !S.apiKey) { S.apiKey = key; localStorage.setItem('apiKey', key); }

    const url = new URL(base + (path.startsWith('/') ? path : ('/'+path)));
    if (query) Object.entries(query).forEach(([k,v]) => v!=null && v!=='' && url.searchParams.set(k,String(v)));

    const headers = { 'Accept':'application/json' };
    if (body!=null) headers['Content-Type'] = 'application/json';
    if (key) headers['x-api-key'] = key;

    let res;
    try { res = await fetch(url.toString(), { method, headers, body: body!=null ? JSON.stringify(body) : undefined }); }
    catch (e) { return { ok:false, status:0, data:{ ok:false, error:String(e) } }; }

    const text = await res.text();
    let data = null; try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    return { ok: res.ok, status: res.status, data };
  }

  // ---- CSV utils
  function toCSV(items){
    const cols = ['host','platform','title','created','temp','why'];
    const head = cols.join(',');
    const esc = v => {
      const s = String(v ?? '').replace(/"/g,'""').replace(/\r?\n/g,' ');
      return /[",]/.test(s) ? `"${s}"` : s;
    };
    const rows = (items||[]).map(it => cols.map(c => esc(it[c])).join(','));
    return [head, ...rows].join('\r\n');
  }
  function download(name, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], { type:'text/csv;charset=utf-8;' }));
    a.download = name; a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 0);
  }

  // ---- rendering
  function renderList() {
    const tbody = $('#listBody'); if (!tbody) return;
    tbody.innerHTML = '';
    (S.items||[]).forEach((it, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${it.host ?? ''}</td>
        <td>${it.platform ?? ''}</td>
        <td>${it.title ?? ''}</td>
        <td>${it.created ?? ''}</td>
        <td>${it.temp ?? ''}</td>
        <td>${it.why ?? ''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ---- actions
  function normalizeItem(raw){
    if (!raw || typeof raw !== 'object') return {};
    return {
      host: raw.host || raw.source || raw.domain || '',
      platform: raw.platform || raw.type || '',
      title: raw.title || raw.name || '',
      created: raw.created || raw.createdAt || raw.ts || '',
      temp: raw.temp || raw.temperature || '',
      why: raw.why || raw.whyText || raw.reason || ''
    };
  }
  const fmtErr = (d)=> typeof d==='string' ? d : JSON.stringify(d||{});

  async function findOne(){
    setFindMsg('');
    const host    = ($('#supplierHost')?.value || '').trim();
    const country = ($('#country')?.value || '').trim();
    const radius  = ($('#radiusMi')?.value || '').trim();
    if (!host) return setFindMsg('Enter supplier host');

    const btn = $('#find'); if (btn) btn.disabled = true;
    const r = await call('GET', `/api/v1/leads/find-buyers`, null, { host, country, radius });
    if (btn) btn.disabled = false;

    if (!r.ok) return setFindMsg(`HTTP ${r.status} — ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}`);

    const items = (r.data && r.data.items) || [];
    const seen = new Set((S.items||[]).map(x => `${x.host}::${x.title}`));
    items.forEach(it => {
      const item = normalizeItem(it);
      const key = `${item.host}::${item.title}`;
      if (!seen.has(key)) { seen.add(key); S.items.unshift(item); }
    });
    renderList();
    setFindMsg(`Found ${items.length} candidate(s).`, true);
  }

  async function refreshHot(){
    toast('Loading hot…');
    const r = await call('GET', `/api/v1/leads`, null, { temp:'hot' });
    if (!r.ok) return toast(`Failed (hot) HTTP ${r.status} — ${fmtErr(r.data)}`);
    S.items = ((r.data && r.data.items) || []).map(normalizeItem);
    renderList(); toast(`Loaded ${S.items.length} hot`, true);
  }
  async function refreshWarm(){
    toast('Loading warm…');
    const r = await call('GET', `/api/v1/leads`, null, { temp:'warm' });
    if (!r.ok) return toast(`Failed (warm) HTTP ${r.status} — ${fmtErr(r.data)}`);
    S.items = ((r.data && r.data.items) || []).map(normalizeItem);
    renderList(); toast(`Loaded ${S.items.length} warm`, true);
  }

  // ---- init & bindings
  function bind(){
    try {
      const savedBase = localStorage.getItem('base');
      const savedKey  = localStorage.getItem('apiKey');
      const savedPersona = localStorage.getItem('persona');

      if (savedBase) { setVal('base', savedBase); setBase(savedBase); }
      if (savedKey)  { setVal('apikey', savedKey); S.apiKey = savedKey; }

      if (savedPersona) {
        try { S.persona = JSON.parse(savedPersona); } catch {}
        if (S.persona) {
          setVal('p_offer',  S.persona.offer  || '');
          setVal('p_solves', S.persona.solves || '');
          setVal('p_titles', S.persona.titles || '');
        }
      }

      on('apply', 'click', () => {
        const v = $('#base')?.value || '';
        setBase(v);
        localStorage.setItem('base', S.base || '');
        toast(S.base ? `Base set: ${S.base}` : 'Base cleared', !!S.base);
      });
      on('saveKey', 'click', () => {
        S.apiKey = ($('#apikey')?.value || '').trim();
        if (S.apiKey) localStorage.setItem('apiKey', S.apiKey);
        else localStorage.removeItem('apiKey');
        toast(S.apiKey ? 'API key saved' : 'API key cleared', !!S.apiKey);
      });

      on('find','click', (e)=>{ e.preventDefault(); findOne(); });
      on('refreshHot','click', (e)=>{ e.preventDefault(); refreshHot(); });
      on('refreshWarm','click', (e)=>{ e.preventDefault(); refreshWarm(); });
      on('personaSave','click', ()=>{
        const persona = {
          offer:  $('#p_offer')?.value || '',
          solves: $('#p_solves')?.value || '',
          titles: $('#p_titles')?.value || ''
        };
        localStorage.setItem('persona', JSON.stringify(persona));
        S.persona = persona;
        toast('Persona saved locally', true);
      });

      on('csvHot','click',  ()=> download('hot.csv',  toCSV(S.items||[])));
      on('csvWarm','click', ()=> download('warm.csv', toCSV((S.items||[]).filter(x => (x.temp||'').toLowerCase()==='warm'))));

      // optional ?base=&key= in URL
      try {
        const u = new URL(location.href);
        const b = u.searchParams.get('base'); const k = u.searchParams.get('key');
        if (b) { setVal('base', b); setBase(b); localStorage.setItem('base', S.base); }
        if (k) { setVal('apikey', k); S.apiKey = k; localStorage.setItem('apiKey', k); }
      } catch {}

      renderList();
    } catch (e) {
      console.error('init failed', e);
      toast('Init failed — check console', false);
    }
  }
  document.addEventListener('DOMContentLoaded', bind);
</script>
</body>
</html>