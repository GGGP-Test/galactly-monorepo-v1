<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Free Panel — Buyers Finder</title>
<style>
  :root{
    --bg:#0b111d; --panel:#121a2a; --panel2:#0e1624; --muted:#1b2940;
    --text:#e7eefc; --sub:#9fb0cf; --accent:#6ea8fe; --ok:#2fb170; --warn:#ffb02e;
    --chip:#1b243b; --chipOn:#0f2a49; --ring:#2b4e7b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{display:flex;min-height:100vh}
  /* left rail */
  .left{width:340px;max-width:100%;padding:14px;border-right:1px solid var(--muted);background:linear-gradient(180deg,var(--panel),#0b1322)}
  h2{margin:10px 0 8px;font-size:15px}
  label{display:block;font-size:12px;color:var(--sub);margin:6px 0 4px}
  input,select{width:100%;background:#0a1222;border:1px solid var(--muted);color:var(--text);border-radius:8px;padding:10px 12px;outline:none}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#1a2540;border:1px solid var(--muted);color:var(--text);padding:9px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#0a1222}
  .btn.ghost{background:transparent}
  .section{padding:10px;border:1px solid var(--muted);border-radius:12px;background:rgba(255,255,255,.02)}
  .row{display:flex;gap:8px}.row>*{flex:1}
  .small{font-size:12px;color:var(--sub)}
  /* right */
  .right{flex:1;min-width:0;padding:14px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--muted);border-radius:12px;background:var(--panel2)}
  .idpill{display:flex;align-items:center;gap:10px}
  .ico{width:22px;height:22px;border-radius:7px;display:grid;place-items:center;overflow:hidden;
       padding:2px;background:radial-gradient(24px 24px at 50% 50%,#1b2a41 0,#0c1322 70%);
       filter:brightness(1.15) contrast(1.08)}
  .ico img{width:100%;height:100%}
  .pill{font-size:12px;color:#cfe1ff;background:#152237;border:1px solid var(--muted);padding:5px 8px;border-radius:999px}
  .group{margin-top:10px;border:1px solid var(--muted);border-radius:12px;background:rgba(255,255,255,.02)}
  .ghd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;user-select:none}
  .ghd h3{margin:0;font-size:13px;color:#cfe1ff}
  .gbody{padding:10px 12px;border-top:1px solid var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #223252;color:#cfe1ff}
  .chip.on{background:var(--chipOn);border-color:#24507f}
  .muted{color:var(--sub)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:1100px){.two{grid-template-columns:1fr}}
  .slider-row{display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:center;margin:8px 0}
  .slider-row input[type=range]{width:100%}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
  .table th{font-size:12px;color:var(--sub);text-align:left;padding:0 10px}
  .table td{background:#0c1426;padding:12px 10px;border:1px solid #17264a}
  .table tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  .table tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  pre.log{background:#0a0f1d;border:1px solid #17264a;border-radius:12px;padding:10px;max-height:220px;overflow:auto;color:#9cb3ff}
</style>
</head>
<body>
<div class="wrap">

  <!-- LEFT RAIL -->
  <div class="left">
    <h2>Connection</h2>
    <div class="section">
      <label>API Base (must end with <span class="mono">/api</span>)</label>
      <input id="apiBase" placeholder="https://your-host.tld/api"/>
      <div class="row" style="margin-top:6px">
        <input id="apiKey" placeholder="x-api-key (optional)"/>
        <button class="btn" id="btnSaveConn">Save</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnPing">Ping</button>
        <button class="btn ghost" id="btnClearLog">Clear Log</button>
      </div>
      <div class="small">Saved in <span class="mono">localStorage</span>.</div>
    </div>

    <h2 style="margin-top:12px">Supplier</h2>
    <div class="section">
      <label>Supplier host (domain only)</label>
      <input id="supplierHost" placeholder="example.com"/>
      <div class="row">
        <div>
          <label>City (boost leads near)</label>
          <input id="supplierCity" placeholder="e.g., los angeles"/>
        </div>
        <div>
          <label>Limit</label>
          <select id="limit"><option>6</option><option selected>12</option><option>20</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnFind" disabled>Find Buyers</button>
        <button class="btn" id="btnReclass">Re-classify</button>
      </div>
    </div>

    <h2 style="margin-top:12px">Preference Profile</h2>
    <div class="section">
      <div class="row">
        <input id="profileId" placeholder="auto on Apply"/>
        <button class="btn" id="btnLoadProfile">Load</button>
      </div>
      <div class="small" style="margin-top:8px">Persona Preview will auto-import from setup.</div>
    </div>
  </div>

  <!-- RIGHT PANE -->
  <div class="right">
    <div class="topbar">
      <div class="idpill">
        <div class="ico"><img id="fav" alt=""></div>
        <div>
          <div style="font-weight:700" id="hostLbl">yourcompany.com</div>
          <div class="small muted" id="personaHint">no persona yet</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnImport">Import</button>
        <button class="btn" id="btnPersona">Persona</button>
        <button class="btn" id="btnApply" style="background:#2fb170;color:#061611;border:none">Apply profile</button>
      </div>
    </div>

    <!-- Collapsibles -->
    <div class="group" data-coll>
      <div class="ghd"><h3>General preferences</h3><span class="small muted">from setup</span></div>
      <div class="gbody">
        <div id="prefChips" class="chips"></div>
      </div>
    </div>

    <div class="group" data-coll>
      <div class="ghd"><h3>Product signals (from your site)</h3><span class="small muted">chips</span></div>
      <div class="gbody"><div id="tagChips" class="chips"></div></div>
    </div>

    <div class="group" data-coll>
      <div class="ghd"><h3>Buyer priorities (dynamic)</h3><span class="small muted">Tell us how much buyers care.</span></div>
      <div class="gbody" id="metricBox"></div>
    </div>

    <div class="two">
      <div class="group" data-coll>
        <div class="ghd"><h3>Buyer targeting — City</h3><span class="small muted">boost near</span></div>
        <div class="gbody">
          <input id="city" placeholder="e.g., Chicago" />
          <div id="cityChips" class="chips" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="group" data-coll>
        <div class="ghd"><h3>Buyer targeting — Sectors</h3><span class="small muted">e.g., food, beverage</span></div>
        <div class="gbody">
          <input id="sectors" placeholder="e.g., food, beverage, cosmetics"/>
          <div id="sectorChips" class="chips" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- Results + Log -->
    <div class="two" style="margin-top:10px">
      <div>
        <h2>Results</h2>
        <table class="table">
          <thead><tr><th style="width:70px">Score</th><th style="width:80px">Temp</th><th>Buyer</th><th>Why</th><th style="width:110px">Action</th></tr></thead>
          <tbody id="resultsBody"><tr><td colspan="5" class="small muted">No items</td></tr></tbody>
        </table>
      </div>
      <div>
        <h2>HTTP Log</h2>
        <pre class="log mono" id="httpLog"></pre>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ------ DOM helpers ------
  const $=s=>document.querySelector(s);
  const $$=s=>[...document.querySelectorAll(s)];
  const logEl=$('#httpLog');
  function ts(){return new Date().toISOString().replace('T',' ').replace('Z','');}
  function log(line){logEl.textContent+=`[${ts()}] ${line}\n`;logEl.scrollTop=logEl.scrollHeight;}
  const LS={
    get(k,d=''){try{const v=localStorage.getItem(k);return v==null?d:v}catch{return d}},
    set(k,v){try{localStorage.setItem(k,v)}catch{}},
    del(k){try{localStorage.removeItem(k)}catch{}}
  };

  // ------ UI refs ------
  const S={
    apiBase:$('#apiBase'), apiKey:$('#apiKey'),
    btnSaveConn:$('#btnSaveConn'), btnPing:$('#btnPing'), btnClearLog:$('#btnClearLog'),
    supplierHost:$('#supplierHost'), supplierCity:$('#supplierCity'), limit:$('#limit'),
    btnFind:$('#btnFind'), btnReclass:$('#btnReclass'),
    btnImport:$('#btnImport'), btnApply:$('#btnApply'), btnPersona:$('#btnPersona'),
    hostLbl:$('#hostLbl'), fav:$('#fav'), personaHint:$('#personaHint'),
    prefChips:$('#prefChips'), tagChips:$('#tagChips'),
    metricBox:$('#metricBox'), resultsBody:$('#resultsBody'),
    city:$('#city'), sectors:$('#sectors'), cityChips:$('#cityChips'), sectorChips:'#sectorChips',
    profileId:$('#profileId'), btnLoadProfile:$('#btnLoadProfile')
  };

  // ------ Collapsibles ------
  $$('.group[data-coll]').forEach(g=>{
    const head=g.querySelector('.ghd'); const body=g.querySelector('.gbody'); let open=false;
    const set=()=>{body.style.display=open?'block':'none';};
    head.addEventListener('click',()=>{open=!open;set();}); set(); // start collapsed
  });

  // ------ Connection + fetch ------
  function base(){return (S.apiBase.value||'').trim().replace(/\/+$/,'');}
  function fullUrl(p){ if(!p.startsWith('/')) p='/'+p; const b=base(); return b?p:b+p;}
  async function fetchJSON(method,path,body){
    const url=fullUrl(path); const headers={'content-type':'application/json'};
    const k=(S.apiKey.value||'').trim(); if(k) headers['x-api-key']=k;
    log(`${method} ${url}`);
    const t0=performance.now(); let resp,data;
    try{
      resp=await fetch(url,{method,headers,body:body?JSON.stringify(body):undefined,redirect:'follow'});
      const ct=(resp.headers.get('content-type')||''); data=ct.includes('json')?await resp.json():{raw:await resp.text()};
      log(`↳ ${resp.status} ${resp.statusText} (${Math.round(performance.now()-t0)} ms)`);
      if(!resp.ok){log(`↳ body: ${JSON.stringify(data).slice(0,400)}`); throw new Error(data&&data.error?data.error:`HTTP ${resp.status}`);}
      return data;
    }catch(e){ log(`↳ error: ${e.message||e}`); throw e; }
  }

  // ------ Persona state ------
  const STATE={
    host:'', favicon:'', persona:null,
    prefs:[], tags:[], metrics:[], // metrics: [{label,value}]
    cities:[], sectors:[]
  };

  const CANON_METRICS=[
    'Line automation / fulfillment',
    'Fast turnaround (≤ 2 weeks)',
    'Lowest unit cost'
  ];

  function setFavicon(host){
    const h=(host||'').trim().toLowerCase().replace(/^https?:\/\//,'').replace(/^www\./,'').replace(/\/.*$/,'');
    if(!h){ S.fav.removeAttribute('src'); return; }
    S.fav.src='https://icons.duckduckgo.com/ip3/'+encodeURIComponent(h)+'.ico';
    S.fav.onerror=()=>{ S.fav.removeAttribute('src'); };
  }

  // ------ Renderers ------
  function chipEl(txt,on=false){const s=document.createElement('span'); s.className='chip'+(on?' on':''); s.textContent=txt; return s;}
  function renderChips(list,box){ box.innerHTML=''; (list||[]).forEach(x=>box.appendChild(chipEl(x,true))); }
  function renderMetrics(arr){
    S.metricBox.innerHTML='';
    const byLabel=new Map((arr||[]).map(m=>[m.label, m.value]));
    const merged=CANON_METRICS.map(l=>({label:l, value: byLabel.has(l)? Number(byLabel.get(l)) : 8}));
    STATE.metrics=merged;
    for(const m of merged){
      const row=document.createElement('div'); row.className='slider-row';
      const lab=document.createElement('div'); lab.textContent=m.label;
      const input=document.createElement('input'); input.type='range'; input.min='0'; input.max='10'; input.value=String(m.value);
      input.addEventListener('input',()=>{ m.value=Number(input.value); });
      row.appendChild(lab); row.appendChild(input); S.metricBox.appendChild(row);
    }
  }
  function renderPersonaHints(){
    S.hostLbl.textContent = STATE.host || 'yourcompany.com';
    S.personaHint.textContent = STATE.persona ? 'persona (imported)' : 'no persona yet';
    setFavicon(STATE.host);
  }

  // ------ Import from setup (auto) ------
  function readSetupBlob(){
    // Try several keys so it works with older index builds.
    const keys=['bf.setup','gal.setup','galactly.setup','setup'];
    for(const k of keys){
      try{ const v=sessionStorage.getItem(k) || localStorage.getItem(k); if(v){ const o=JSON.parse(v); if(o && typeof o==='object') return o; } }catch{}
    }
    // Also try URL hash passthrough (?host=...)
    try{
      const h=new URLSearchParams(location.hash.slice(1));
      const host=h.get('host'); if(host){ return {host}; }
    }catch{}
    return null;
  }

  function applySetupBlob(b){
    if(!b) return false;
    STATE.host = (b.host||'').trim();
    STATE.prefs = (b.general||b.prefs||[]).slice(0,20);
    STATE.tags  = (b.productTags||b.tags||[]).slice(0,20);
    // metrics: array of {label,value} or [ {label,score} ]
    let m = Array.isArray(b.metrics)? b.metrics : [];
    m = m.map(x=>({label:String(x.label||x.name||''), value:Number(x.value??x.score??8)})).filter(x=>x.label);
    STATE.metrics = m;
    STATE.cities  = (b.cities||b.cityHints||[]).slice(0,10);
    STATE.sectors = (b.sectors||b.sectorHints||[]).slice(0,10);
    renderPersonaHints();
    renderChips(STATE.prefs, S.prefChips);
    renderChips(STATE.tags,  S.tagChips);
    renderMetrics(STATE.metrics);
    S.city.value = (STATE.cities[0]||'');
    // city & sector chips
    const cc=$('#cityChips'); cc.innerHTML=''; ['Chicago','Los Angeles','New York','Dallas','Atlanta','Miami'].forEach(c=>cc.appendChild(chipEl(c)));
    const sc=$('#sectorChips'); sc.innerHTML=''; (STATE.sectors.length?STATE.sectors:['food','beverage','cosmetics','electronics']).forEach(s=>sc.appendChild(chipEl(s)));
    return true;
  }

  function autoImport(){
    const blob=readSetupBlob();
    if(blob){ applySetupBlob(blob); S.personaHint.textContent='persona (imported)'; }
  }

  // ------ Load/save UI state ------
  function restore(){
    S.apiBase.value = LS.get('fp.apiBase','');
    S.apiKey.value  = LS.get('fp.apiKey','');
    S.supplierHost.value = LS.get('fp.supplier.host','');
    S.supplierCity.value = LS.get('fp.supplier.city','');
    S.limit.value  = LS.get('fp.supplier.limit','12') || '12';
    S.btnFind.disabled = !((S.supplierHost.value||'').trim());
  }
  function persistBasics(){
    LS.set('fp.apiBase',S.apiBase.value||''); LS.set('fp.apiKey',S.apiKey.value||'');
    LS.set('fp.supplier.host',S.supplierHost.value||''); LS.set('fp.supplier.city',S.supplierCity.value||'');
    LS.set('fp.supplier.limit',S.limit.value||'12');
  }

  // ------ Actions ------
  S.btnSaveConn.addEventListener('click',()=>{persistBasics(); log('saved connection');});
  S.btnPing.addEventListener('click',async()=>{ try{ const r=await fetchJSON('GET','/healthz'); log('healthz: '+JSON.stringify(r)); }catch(e){} });
  S.btnClearLog.addEventListener('click',()=>{ logEl.textContent=''; });

  S.supplierHost.addEventListener('input',()=>{ S.btnFind.disabled = !((S.supplierHost.value||'').trim()); });

  S.btnFind.addEventListener('click', async ()=>{
    const host=(S.supplierHost.value||'').trim().toLowerCase(); if(!host){ alert('Enter supplier host'); return; }
    const city=(S.supplierCity.value||'').trim();
    const p=new URLSearchParams({ host, city, limit:String(S.limit.value||12) });
    try{
      const base=await fetchJSON('GET','/api/leads/find-buyers?'+p.toString());
      const items=(base.items||[]);
      const body=S.resultsBody; body.innerHTML='';
      if(!items.length){ const td=document.createElement('td'); td.colSpan=5; td.className='small muted'; td.textContent='No items'; const tr=document.createElement('tr'); tr.appendChild(td); body.appendChild(tr); return; }
      for(const it of items){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${Math.round(it.score||0)}</td>
          <td><span class="pill">${(it.temp||'cool').toUpperCase()}</span></td>
          <td><div style="font-weight:600">${it.host||''}</div><div class="small muted">${it.title||it.name||''}</div></td>
          <td class="small">${(it.why||'').replace(/\s·\s/g,' • ')}</td>
          <td><button class="btn">Lock</button></td>`;
        body.appendChild(tr);
      }
    }catch(e){}
  });

  S.btnReclass.addEventListener('click', async ()=>{
    const h=(S.supplierHost.value||'').trim(); if(!h){ alert('Enter supplier host'); return; }
    try{
      const q='?host='+encodeURIComponent(h);
      const r=await fetchJSON('GET','/classify'+q);
      alert('Re-classified: '+(r&&r.ok?'ok':'check log'));
    }catch(e){}
  });

  S.btnImport.addEventListener('click',()=>{ const ok=applySetupBlob(readSetupBlob()); if(!ok) alert('Nothing to import yet. Finish step 3 first.'); });

  S.btnApply.addEventListener('click', async ()=>{
    const body={
      id:(S.profileId.value||'').trim()||undefined,
      city:(S.city.value||S.supplierCity.value||'').trim()||undefined,
      hotCues:[], warmCues:[],
      preferTags:STATE.tags, preferSegments:STATE.sectors,
      avoidTags:[], avoidSegments:[],
      excludeGiants: STATE.prefs.some(p=>/giant/i.test(p)),
      // Send priorities as stable labels
      priorities: STATE.metrics.map(m=>({label:m.label, value:Number(m.value)||0}))
    };
    try{
      const r=await fetchJSON('POST','/api/prefs/upsert',body);
      const id = r.id || (r.profile && r.profile.id) || '';
      if(id){ S.profileId.value=id; LS.set('fp.profileId',id); }
      alert('Profile applied'+(id?` (id=${id})`:'')+'.');
    }catch(e){}
  });

  S.btnPersona.addEventListener('click',()=>{ alert('Persona preview is already embedded here. Use Import if you want to re-pull from setup.'); });

  // ------ Boot ------
  restore();
  renderPersonaHints();
  autoImport();        // <-- no more blank panel after finishing step 3
})();
</script>
</body>
</html>