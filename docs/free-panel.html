<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Free Panel — Buyers Finder</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#10172a; --panel2:#0d1424; --muted:#2a3552;
    --line:#1a2340; --text:#e9eefb; --sub:#aab6d6; --acc:#6ea8fe;
    --ok:#2fb170; --warn:#ffb02e; --hot:#ff4769; --chip:#1b2441;
    --chip2:#0e1a2e; --ring:#2a4dff66;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--acc);text-decoration:none}
  .wrap{display:flex;min-height:100vh}
  .left{width:420px;max-width:100%;padding:16px;border-right:1px solid var(--line);background:linear-gradient(180deg,var(--panel),#0a1122)}
  .right{flex:1;min-width:0;padding:16px}
  h2{margin:10px 0 8px;font-size:16px}
  h3{margin:14px 0 8px;font-size:14px;color:var(--sub)}
  label{display:block;font-size:12px;color:var(--sub);margin:6px 0 4px}
  input,select,textarea{
    width:100%;background:#0b1326;border:1px solid var(--line);color:var(--text);
    border-radius:10px;padding:10px 12px;outline:none
  }
  input:focus,textarea:focus{border-color:#3b63ff44;box-shadow:0 0 0 4px var(--ring)}
  textarea{min-height:68px;resize:vertical}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#17244a;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;user-select:none}
  .btn:hover{background:#203064}
  .btn.primary{background:var(--acc);border-color:transparent;color:#081225}
  .btn.good{background:var(--ok);border-color:transparent;color:#03140c}
  .btn.ghost{background:transparent}
  .btn.small{padding:6px 8px;border-radius:8px;font-size:12px}
  .section{padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,0.02)}
  .small{font-size:12px;color:var(--sub)}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ff;font-size:12px;border:1px solid var(--line)}
  .chip.pick{cursor:pointer}
  .chip.on{background:#20345c}
  .pill{padding:6px 10px;border-radius:999px;background:#0e1b2e;color:#9fb1d6;font-size:12px;display:inline-block}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:12px;color:var(--sub);text-align:left;padding:0 10px}
  .table td{background:#0d1330;padding:12px 10px;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .table tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:8px;border-bottom-left-radius:8px}
  .table tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:8px;border-bottom-right-radius:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  pre.log{background:#0a0f22;border:1px solid var(--line);border-radius:12px;padding:10px;max-height:220px;overflow:auto;color:#9cb3ff}
  .split{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  @media (max-width:1100px){.split{grid-template-columns:1fr}}
  /* Persona header */
  .bar{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#0f1630,#0c1428)}
  .favwrap{width:28px;height:28px;border-radius:8px;background:#e8eefc;display:grid;place-items:center;overflow:hidden;border:1px solid #c9d4f8}
  .favwrap img{width:18px;height:18px;display:block}
  .host{font-weight:700}
  .bar .spacer{flex:1}
  /* Collapsible persona tray */
  .tray{margin-top:10px;border:1px dashed var(--line);border-radius:12px;background:var(--panel2);padding:10px;display:none}
  .tray.show{display:block}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  .slider-row{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:center;margin:8px 0}
  .slider-row input[type=range]{width:100%}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: connection + supplier -->
  <div class="left">
    <h2>Connection</h2>
    <div class="section">
      <label>API Base (must end with <span class="mono">/api</span>)</label>
      <input id="apiBase" placeholder="https://your-host.tld/api" />
      <div class="row" style="margin-top:6px">
        <div>
          <label>x-api-key (optional)</label>
          <input id="apiKey" placeholder="leave blank if none" />
        </div>
        <div style="align-self:flex-end"><button class="btn" id="btnSaveConn">Save</button></div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnPing">Ping</button>
        <button class="btn ghost" id="btnClearLog">Clear Log</button>
      </div>
      <div class="small">Tip: if this HTML is served by the same host as the API, you can leave API Base blank (relative).</div>
    </div>

    <h2 style="margin-top:14px">Supplier</h2>
    <div class="section">
      <label>Supplier host (domain only)</label>
      <input id="supplierHost" placeholder="example.com" />
      <div class="row">
        <div>
          <label>City (boost leads near)</label>
          <input id="supplierCity" placeholder="e.g., los angeles" />
        </div>
        <div>
          <label>Limit</label>
          <select id="limit"><option>6</option><option selected>12</option><option>20</option><option>30</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnFind" disabled>Find Buyers</button>
        <button class="btn" id="btnReclass">Re-classify</button>
      </div>
      <div class="small" id="hintProfile"></div>
    </div>

    <h2 style="margin-top:14px">Preference Profile</h2>
    <div class="section">
      <div class="row">
        <div>
          <label>Profile ID</label>
          <input id="profileId" placeholder="auto on Apply" />
        </div>
        <div style="align-self:flex-end"><button class="btn" id="btnLoadProfile">Load</button></div>
      </div>
      <h3 style="margin-top:8px">Persona Preview</h3>
      <div class="small">Click <b>Import</b> (top bar) to pull persona from setup, or <b>Re-classify</b> to analyze the website again.</div>
      <div id="personaMini" class="small" style="margin-top:6px;opacity:.85"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn good" id="btnApplyProfile">Apply profile</button>
        <button class="btn ghost" id="btnForgetProfile">Forget ID</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: persona + results + log -->
  <div class="right">
    <div class="bar" id="personaBar">
      <span class="favwrap"><img id="fav" alt="" referrerpolicy="no-referrer"></span>
      <span class="host mono" id="barHost">yourcompany.com</span>
      <span class="pill" id="personaBadge">no persona yet</span>
      <span class="spacer"></span>
      <button class="btn small" id="btnImport">Import</button>
      <button class="btn small" id="btnPersona">Persona</button>
    </div>

    <div class="tray" id="personaTray">
      <div class="grid2">
        <div class="section">
          <h3>General preferences</h3>
          <div id="prefChips" class="chips"></div>
        </div>
        <div class="section">
          <h3>Product signals (from your site)</h3>
          <div id="tagChips" class="chips"></div>
        </div>
      </div>

      <div class="section" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Buyer priorities (dynamic)</h3>
          <div class="small">Tell us how much buyers care.</div>
        </div>
        <div id="metricsBox"></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="section">
          <h3>Buyer targeting — City</h3>
          <input id="cityInput" placeholder="e.g., Chicago"/>
          <div id="cityChips" class="chips" style="margin-top:6px"></div>
        </div>
        <div class="section">
          <h3>Buyer targeting — Sectors</h3>
          <input id="sectorInput" placeholder="e.g., food, beverage, cosmetics"/>
          <div id="sectorChips" class="chips" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <h2>Results</h2>
        <table class="table">
          <thead>
            <tr>
              <th style="width:70px">Score</th>
              <th style="width:90px">Temp</th>
              <th>Buyer</th>
              <th>Why</th>
              <th style="width:120px">Action</th>
            </tr>
          </thead>
          <tbody id="resultsBody"><tr><td colspan="5" class="small" style="opacity:.8">No items</td></tr></tbody>
        </table>
      </div>
      <div>
        <h2>HTTP Log</h2>
        <pre class="log mono" id="httpLog"></pre>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const logEl = $('#httpLog');

  // ---------- Local storage helpers ----------
  const LS = {
    get(k,d=''){ try{ const v=localStorage.getItem(k); return v==null?d:v; }catch{ return d; } },
    set(k,v){ try{ localStorage.setItem(k, v); }catch{} },
    del(k){ try{ localStorage.removeItem(k); }catch{} }
  };

  // Shared keys (stable across pages)
  const K = {
    apiBase:'bf.v1.apiBase', apiKey:'bf.v1.apiKey',
    persona:'bf.v1.persona', lastHost:'bf.v1.lastHost',
    profileId:'bf.v1.profileId',
  };

  // ---------- Elements ----------
  const S = {
    // conn
    apiBase: $('#apiBase'), apiKey: $('#apiKey'),
    btnSaveConn: $('#btnSaveConn'), btnPing: $('#btnPing'), btnClearLog: $('#btnClearLog'),

    // supplier
    supplierHost: $('#supplierHost'), supplierCity: $('#supplierCity'), limit: $('#limit'),
    btnFind: $('#btnFind'), btnReclass: $('#btnReclass'),

    // profile
    profileId: $('#profileId'), btnLoadProfile: $('#btnLoadProfile'),
    btnApplyProfile: $('#btnApplyProfile'), btnForgetProfile: $('#btnForgetProfile'),
    hintProfile: $('#hintProfile'), personaMini: $('#personaMini'),

    // persona bar/tray
    barHost: $('#barHost'), fav: $('#fav'), personaBadge: $('#personaBadge'),
    btnImport: $('#btnImport'), btnPersona: $('#btnPersona'), personaTray: $('#personaTray'),

    // persona widgets
    prefChips: $('#prefChips'), tagChips: $('#tagChips'),
    metricsBox: $('#metricsBox'),
    cityInput: $('#cityInput'), sectorInput: $('#sectorInput'),
    cityChips: $('#cityChips'), sectorChips: $('#sectorChips'),

    // results
    resultsBody: $('#resultsBody')
  };

  // ---------- State ----------
  const state = {
    persona:null, // {host, productTags, sectorHints, summary, ...}
    metrics:[],   // [{label,value}]
    generalPrefs:new Set(['Prefer mid-size companies','De-prioritize giant enterprises']), // sane defaults
    cityPicks:new Set(), sectorPicks:new Set()
  };

  // ---------- Utils ----------
  function normHost(h){ return (h||'').trim().toLowerCase().replace(/^https?:\/\//,'').replace(/^www\./,'').replace(/\/.*$/,''); }
  function fullUrl(path){
    const base = (S.apiBase.value||'').trim().replace(/\/+$/,'');
    if (!base) return path;
    if (path.startsWith('http')) return path;
    return base + path;
  }
  function log(line){ logEl.textContent += `[${new Date().toISOString().replace('T',' ').replace('Z','')}] ${line}\n`; logEl.scrollTop=logEl.scrollHeight; }
  function badge(temp){
    const t=(temp||'').toLowerCase();
    if (t==='hot') return '<span class="chip" style="background:rgba(255,71,105,.14);color:#ff9fb0">HOT</span>';
    if (t==='warm') return '<span class="chip" style="background:rgba(255,200,87,.16);color:#ffe2a8">WARM</span>';
    return '<span class="chip" style="background:rgba(110,198,255,.16);color:#cfeaff">COOL</span>';
  }
  function setFav(host){
    const h=normHost(host); S.fav.src=''; if(!h){ return; }
    S.fav.src = 'https://icons.duckduckgo.com/ip3/'+encodeURIComponent(h)+'.ico';
  }

  async function fetchJSON(method, path, body){
    const url = fullUrl(path);
    const headers = {'content-type':'application/json'};
    const k=(S.apiKey.value||'').trim(); if(k) headers['x-api-key']=k;
    const init = { method, headers, redirect:'follow' };
    if (body) init.body = JSON.stringify(body);

    log(`${method} ${url}`);
    const t0 = performance.now();
    let resp, data, ok=false;
    try{
      resp=await fetch(url, init);
      const ct=resp.headers.get('content-type')||'';
      data = ct.includes('application/json') ? await resp.json() : { raw: await resp.text() };
      ok = resp.ok;
      log(`↳ ${resp.status} ${resp.statusText} (${Math.round(performance.now()-t0)} ms)`);
    }catch(e){ log(`↳ network error: ${e.message||e}`); throw e; }
    if(!ok){ log(`↳ body: ${JSON.stringify(data)}`); const er=new Error(data && data.error ? data.error : `HTTP ${resp.status}`); er.status=resp.status; er.data=data; throw er; }
    return data;
  }

  function chips(box, items, selectable=false, set=null){
    box.innerHTML='';
    (items||[]).forEach(t=>{
      const s=document.createElement('span'); s.className='chip'+(selectable?' pick':''); s.textContent=t;
      if(selectable && set){ s.addEventListener('click',()=>{ s.classList.toggle('on'); if(s.classList.contains('on')) set.add(t); else set.delete(t); }); }
      box.appendChild(s);
    });
  }

  function renderMetrics(labels){
    S.metricsBox.innerHTML='';
    state.metrics = (labels||[]).slice(0,20).map(l=>({label:l,value:8}));
    for(const m of state.metrics){
      const row=document.createElement('div'); row.className='slider-row';
      const lab=document.createElement('div'); lab.textContent=m.label;
      const input=document.createElement('input'); input.type='range'; input.min='0'; input.max='10'; input.value=String(m.value);
      input.addEventListener('input',()=>{ m.value=Number(input.value); });
      row.appendChild(lab); row.appendChild(input);
      S.metricsBox.appendChild(row);
    }
  }

  function deriveMetrics(p){
    const text = ((p.summary||'')+' '+(p.productTags||[]).join(' ')+' '+(p.evidence||[]).join(' ')).toLowerCase();
    const map = [
      [/lead|turnaround|rush|2 ?weeks|quick ship|fast/i, 'Fast turnaround (≤ 2 weeks)'],
      [/moq|minimum order|short run|prototype|sample/i, 'Low MOQs / short runs'],
      [/eco|sustain|recycl|compost|bio|green|post[- ]consumer/i, 'Eco materials / recyclable'],
      [/made in usa|domestic|local/i, 'Made in USA'],
      [/design|die[- ]?line|structur|render|artwork/i, 'Design & structural support'],
      [/cost|price|budget|unit cost|lowest/i, 'Lowest unit cost'],
      [/premium|lux|branding|unboxing/i, 'Premium brand presentation'],
      [/anti[- ]?static|esd|protect|fragile|cushion/i, 'Protection / anti-static options'],
      [/barrier|foil|oxygen|moisture|vapou?r/i, 'Food-safe / barrier'],
      [/tamper|child[- ]?resist|security/i, 'Tamper / CR compliance'],
      [/automation|pallet|fulfillment|co[- ]?pack/i, 'Line automation / fulfillment'],
      [/print|flexo|litho|digital|spot uv|emboss|foil/i, 'Print & finish quality'],
      [/inventory|warehous|kanban|safety stock/i, 'Vendor-managed inventory'],
      [/custom size|engineer|die/i, 'Custom sizing / engineering'],
      [/kitting|insert|assembly|contract pack/i, 'Kitting / co-packing'],
      [/regulatory|fda|prop ?65|reach|rohs/i, 'Regulatory compliance'],
      [/cold chain|insulat|thermal/i, 'Cold-chain / thermal'],
      [/reusab|returns|reverse logistics/i, 'Reusability / returns'],
      [/speed to market|launch|pilot/i, 'Speed-to-market support']
    ];
    const set = new Set();
    for (const [re,label] of map){ if(re.test(text)) set.add(label); }
    ['Fast turnaround (≤ 2 weeks)','Lowest unit cost'].forEach(x=>set.add(x));
    return [...set];
  }

  function renderPersona(p){
    if(!p){ S.personaBadge.textContent='no persona yet'; return; }
    const h = p.host || normHost(S.supplierHost.value);
    S.barHost.textContent = h || '(unknown)';
    setFav(h);

    S.personaBadge.textContent = p.cached ? 'persona (cached)' : 'persona';
    // Product tags
    chips(S.tagChips, (p.productTags||[]).slice(0,14));
    // Prefs (chips are illustrative here; your scoring uses sliders/filters)
    const prefs = ['Prefer mid-size companies','De-prioritize giant enterprises','Prioritize nearby buyers','Prefer e-commerce sites','Prefer wholesalers / distributors','Prefer retail brands'];
    chips(S.prefChips, prefs);
    // Metrics (dynamic)
    renderMetrics( deriveMetrics(p) );
    // Targeting seeds
    chips(S.cityChips, ['Chicago','Los Angeles','New York','Dallas','Atlanta','Miami'], true, state.cityPicks);
    chips(S.sectorChips, (p.sectorHints&&p.sectorHints.length?p.sectorHints:['food','beverage','cosmetics','electronics']).slice(0,8), true, state.sectorPicks);

    S.personaMini.textContent = (p.productTags&&p.productTags.length) ? `tags: ${p.productTags.slice(0,8).join(', ')}` : '(no tags)';
    S.personaTray.classList.add('show');
  }

  function saveConn(){ LS.set(K.apiBase,S.apiBase.value||''); LS.set(K.apiKey,S.apiKey.value||''); log('saved connection'); }

  async function ping(){ try{ const r=await fetchJSON('GET','/healthz'); log('healthz: '+JSON.stringify(r)); }catch(e){} }

  async function classify(host){
    host = normHost(host);
    if(!host){ alert('Enter supplier host'); return null; }
    LS.set(K.lastHost, host);
    S.barHost.textContent = host;
    try{
      // try /classify and /api/classify (handles mis-specified bases)
      const tries = ['/classify','/api/classify'];
      for (const path of tries){
        try{
          const r = await fetchJSON('GET', `${path}?host=${encodeURIComponent(host)}&email=`);
          if (r && r.ok){ return r; }
        }catch(e){ /* try next */ }
      }
      return null;
    }catch(e){ return null; }
  }

  async function reclassifyAndRender(){
    const host = (S.supplierHost.value||'').trim() || LS.get(K.lastHost,'');
    if(!host){ alert('Enter supplier host'); return; }
    const data = await classify(host);
    if (data && data.ok){
      state.persona = { ...data, host: normHost(host) };
      LS.set(K.persona, JSON.stringify(state.persona));
      renderPersona(state.persona);
    }else{
      alert('Classify failed (check API base). See HTTP Log.');
    }
  }

  function importFromStorage(){
    const fallbacks=[K.persona,'bf.persona','persona','setup.persona','galactly.persona'];
    let raw='';
    for(const k of fallbacks){ raw = LS.get(k,''); if(raw){ try{ state.persona=JSON.parse(raw); LS.set(K.persona,raw); break; }catch{} } }
    if(state.persona){ renderPersona(state.persona); S.personaBadge.textContent='persona (imported)'; }
    else alert('No saved persona found to import.');
  }

  async function applyProfile(){
    const p = state.persona;
    if(!p){ alert('No persona loaded. Click Import or Re-classify first.'); return; }
    const body = {
      id:(S.profileId.value||'').trim()||undefined,
      city:(S.supplierCity.value||'').trim()||undefined,
      excludeGiants:true,
      hotCues:['grand opening','new launch','pre-order'],
      warmCues:['wholesale','private label','co-pack'],
      mustHave:[],
      preferSegments:[...state.sectorPicks],
      preferTags:(p.productTags||[]).slice(0,12),
      avoidSegments:[], avoidTags:[]
    };
    try{
      const r = await fetchJSON('POST','/api/prefs/upsert', body);
      const id = r.id || (r.profile && r.profile.id) || '';
      if (id){ S.profileId.value=id; LS.set(K.profileId,id); S.hintProfile.textContent='Profile saved. ID='+id; }
    }catch(e){}
  }

  async function loadProfile(){
    const id=(S.profileId.value||'').trim();
    if(!id){ alert('Enter a profile ID'); return; }
    try{
      const r = await fetchJSON('GET', `/api/prefs/${encodeURIComponent(id)}`);
      if (r && r.profile){ S.hintProfile.textContent='Loaded profile.'; LS.set(K.profileId,id); }
    }catch(e){}
  }

  function renderRows(items){
    S.resultsBody.innerHTML='';
    if (!items || !items.length){
      const tr=document.createElement('tr'), td=document.createElement('td');
      td.colSpan=5; td.textContent='No items'; td.className='small'; td.style.opacity=.8; tr.appendChild(td); S.resultsBody.appendChild(tr); return;
    }
    for (const it of items){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${Math.round(it.score||0)}</td>
        <td>${badge(it.temp)}</td>
        <td>
          <div class="mono" style="font-weight:600">${it.host||''}</div>
          <div class="small" style="opacity:.85">${it.title||it.name||''}</div>
        </td>
        <td><div class="small">${(it.why||'').replace(/\s·\s/g,' • ')}</div></td>
        <td><button class="btn small" data-lock="${encodeURIComponent(it.host||'')}">Lock</button></td>
      `;
      S.resultsBody.appendChild(tr);
    }
  }

  async function findBuyers(){
    const host=(S.supplierHost.value||'').trim() || LS.get(K.lastHost,'');
    if(!host){ alert('Enter supplier host'); return; }
    const city=(S.supplierCity.value||'').trim();
    const limit=String(S.limit.value||'12');
    const params=new URLSearchParams({ host:normHost(host), limit });
    if(city) params.set('city',city);
    const pid=(S.profileId.value||LS.get(K.profileId,'')); if(pid) params.set('profileId',pid);

    S.btnFind.disabled=true; S.btnFind.textContent='Searching…';
    try{
      const base = await fetchJSON('GET', `/api/leads/find-buyers?${params.toString()}`);
      renderRows(base.items||[]);
    }catch(e){ renderRows([]); }
    finally{ S.btnFind.disabled=false; S.btnFind.textContent='Find Buyers'; }
  }

  // ---------- Events ----------
  function hook(){
    S.btnSaveConn.addEventListener('click', saveConn);
    S.btnPing.addEventListener('click', ping);
    S.btnClearLog.addEventListener('click', ()=>{ logEl.textContent=''; });

    S.btnFind.addEventListener('click', findBuyers);
    S.btnReclass.addEventListener('click', reclassifyAndRender);

    S.btnImport.addEventListener('click', importFromStorage);
    S.btnPersona.addEventListener('click', ()=>{ S.personaTray.classList.toggle('show'); });

    S.btnApplyProfile.addEventListener('click', applyProfile);
    S.btnForgetProfile.addEventListener('click', ()=>{ LS.del(K.profileId); S.profileId.value=''; S.hintProfile.textContent=''; });
    S.btnLoadProfile.addEventListener('click', loadProfile);

    // gate find btn
    const gate=()=>{ S.btnFind.disabled = !((S.supplierHost.value||LS.get(K.lastHost,'')).trim()); };
    S.supplierHost.addEventListener('input',gate); gate();

    // results lock click
    $('#resultsBody').addEventListener('click',(e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const enc=b.getAttribute('data-lock'); if(!enc) return;
      const host=decodeURIComponent(enc);
      fetchJSON('POST','/api/leads/lock',{ host, title:'Locked by user', temp:'warm' })
        .then(()=>{ b.textContent='Locked ✓'; b.classList.add('good'); b.disabled=true; })
        .catch(()=>{});
    });
  }

  // ---------- Boot ----------
  function boot(){
    S.apiBase.value = LS.get(K.apiBase,''); S.apiKey.value = LS.get(K.apiKey,'');
    S.profileId.value = LS.get(K.profileId,'');
    const lastHost = LS.get(K.lastHost,'');
    S.supplierHost.value = lastHost;
    S.barHost.textContent = lastHost || 'yourcompany.com';
    if(lastHost) setFav(lastHost);

    // Auto-import persona if present; otherwise auto-reclassify (best-effort)
    const raw = LS.get(K.persona,'');
    if(raw){ try{ state.persona=JSON.parse(raw); renderPersona(state.persona); S.personaBadge.textContent='persona (imported)'; }catch{} }
    else if (lastHost){ reclassifyAndRender(); }

    hook(); log('ready');
  }

  boot();
})();
</script>
</body>
</html>