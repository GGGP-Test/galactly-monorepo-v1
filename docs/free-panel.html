<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Leads Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b0e12; --card:#121720; --muted:#9aa4b2; --chip:#1a2130; --green:#1f7a4c; --pill:#212a3a; --hot:#a33; --warm:#a36; }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#e6edf3}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  .row{display:flex;gap:16px}
  .card{background:var(--card);border:1px solid #1e2633;border-radius:10px;padding:14px}
  .title{font-weight:700;margin-bottom:8px}
  .input{background:#0e141c;border:1px solid #243044;border-radius:8px;color:#e6edf3;height:36px;padding:0 10px}
  .btn{height:36px;padding:0 12px;border-radius:8px;border:1px solid #2a3750;background:#132033;color:#e6edf3;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#244463}
  .btn.good{background:#1e3f31}
  .btn.warn{background:#3c2222}
  .grid{width:100%;border-collapse:collapse}
  .grid th,.grid td{padding:8px;border-bottom:1px solid #1e2633;font-size:13px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--pill);font-size:12px}
  .pill.hot{background:#3a1a1a}
  .pill.warm{background:#2f1e35}
  .why-row{margin:6px 0;padding:8px;border-radius:6px;background:#0f141e}
  .why-label{font-weight:600}
  .why-score{opacity:.8;border-bottom:1px dotted #666;cursor:help}
  .chip{display:inline-block;padding:3px 8px;border-radius:999px;background:#1a2333;margin-right:6px;font-size:12px}
  .muted{color:var(--muted);font-size:12px}
  .bar{margin-top:8px;padding:10px;border-radius:8px;background:#132033}
  .ok{background:#0f2d22}
  .err{background:#331a1a}
  #left{flex:1}
  #right{width:380px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title" style="font-size:20px;margin-bottom:10px">Leads Console</div>

  <div class="card" style="margin-bottom:12px">
    <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
      <div style="min-width:340px;display:flex;gap:8px;flex:1">
        <input id="base" class="input" placeholder="https://p01--your-service.code.run" />
        <button id="apply" class="btn primary">Apply</button>
        <span class="muted">Tip: host this file from the same domain as the API to avoid CORS.</span>
      </div>
      <div style="min-width:340px;display:flex;gap:8px">
        <input id="apikey" class="input" placeholder="API key (for write)" />
        <button id="savekey" class="btn">Save</button>
        <button id="clearkey" class="btn">Clear</button>
        <button id="usca" class="btn">US/CA only</button>
      </div>
    </div>
  </div>

  <div class="row">
    <div id="left" class="card">
      <div class="row" style="gap:8px;align-items:center;margin-bottom:8px">
        <button id="hotBtn" class="btn">Refresh Hot</button>
        <button id="warmBtn" class="btn">Refresh Warm</button>
        <div class="muted">press <b>R</b> to refresh hot</div>
        <div class="muted" id="apiLabel" style="margin-left:auto">API: /api/v1/leads</div>
      </div>
      <table class="grid" id="grid">
        <thead>
          <tr>
            <th style="width:60px">ID</th>
            <th>Host</th>
            <th>Platform</th>
            <th>Title</th>
            <th>Created</th>
            <th>Temp</th>
            <th>Why</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div id="right" class="card">
      <div id="details" class="muted">Select a lead...</div>

      <div style="margin-top:14px;border-top:1px solid #1e2633;padding-top:10px">
        <div class="title" style="margin-bottom:8px">Find buyers (from supplier)</div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="supplier" class="input" placeholder="stretchandshrink.com" style="flex:1" />
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <select id="region" class="input" style="width:120px">
            <option value="us">us</option>
            <option value="ca">ca</option>
          </select>
          <select id="radius" class="input" style="width:120px">
            <option value="25">25 mi</option>
            <option value="50" selected>50 mi</option>
            <option value="100">100 mi</option>
            <option value="250">250 mi</option>
          </select>
          <button id="find" class="btn good">Find buyers</button>
        </div>
        <div id="findMsg" class="bar muted">No keywords needed. We’ll infer persona and start near your city/HQ (still US/CA only).</div>

        <div style="margin-top:12px">
          <div class="title" style="margin-bottom:6px">Download CSV</div>
          <button id="csvHot" class="btn">Download CSV (hot)</button>
          <button id="csvWarm" class="btn">Download CSV (warm)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (q)=>document.querySelector(q);
  const base = $("#base");
  const apiKey = $("#apikey");
  const apiLabel = $("#apiLabel");
  const rowsT = $("#rows");
  const details = $("#details");
  const findMsg = $("#findMsg");

  function save(k,v){ try{ localStorage.setItem(k,v) }catch{} }
  function load(k,d){ try{ return localStorage.getItem(k) || d }catch{ return d } }

  // state
  let BASE = load("lead_base", "");
  let KEY  = load("lead_key", "");
  let USCA_ONLY = true;

  function setBase(url){
    BASE = url.replace(/\/+$/,"");
    apiLabel.textContent = "API: /api/v1/leads";
    save("lead_base", BASE);
  }
  function setKey(k){
    KEY = k;
    save("lead_key", KEY);
  }

  base.value = BASE || "https://p01--animated-cellar--vz4ftkwrzdfs.code.run";
  apiKey.value = KEY;

  $("#apply").onclick = ()=> setBase(base.value.trim());
  $("#savekey").onclick = ()=> setKey(apiKey.value.trim());
  $("#clearkey").onclick = ()=> { apiKey.value=""; setKey("") };

  $("#usca").onclick = ()=>{
    USCA_ONLY = !USCA_ONLY;
    $("#usca").textContent = USCA_ONLY ? "US/CA only" : "All regions";
  };

  document.addEventListener("keydown", (e)=>{
    if(e.key.toLowerCase()==="r") loadHot();
  });

  $("#hotBtn").onclick = loadHot;
  $("#warmBtn").onclick = loadWarm;

  $("#csvHot").onclick = ()=> window.open(`${BASE}/api/v1/leads/hot.csv`, "_blank");
  $("#csvWarm").onclick = ()=> window.open(`${BASE}/api/v1/leads/warm.csv`, "_blank");

  $("#find").onclick = async ()=>{
    const supplier = $("#supplier").value.trim();
    const region = $("#region").value;
    const radius = $("#radius").value;
    findMsg.className = "bar";
    findMsg.textContent = "Finding…";
    try{
      const r = await fetch(`${BASE}/api/v1/leads/find`, {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          ...(KEY ? {"x-api-key": KEY} : {})
        },
        body: JSON.stringify({ supplier, region, radiusMi: Number(radius), uscaOnly: USCA_ONLY })
      });
      if(!r.ok){
        const t = await r.text();
        findMsg.className = "bar err";
        findMsg.textContent = `HTTP ${r.status} — ${t.slice(0,120)}`;
        return;
      }
      const j = await r.json();
      findMsg.className = "bar ok";
      findMsg.textContent = `Loaded ${j.hot || 0} hot & ${j.warm || 0} warm lead(s).`;
      // refresh warm (most results will be warm)
      loadWarm();
    }catch(err){
      findMsg.className = "bar err";
      findMsg.textContent = "Failed to fetch";
    }
  };

  function fmtDate(iso){
    try{ const d = new Date(iso); return d.toLocaleString() }catch{ return iso }
  }

  function explainWhy(why){
    if(!why || !why.length) return "<div class='muted'>No evidence yet.</div>";
    return why.map(w=>`
      <div class="why-row">
        <div class="why-label">${w.label}</div>
        <div class="why-text">${w.text}${(w.score!=null)?` — <span class="why-score" title="0 to 1">${Number(w.score).toFixed(2)}</span>`:""}</div>
      </div>
    `).join("");
  }

  function renderPersona(p){
    if(!p) return "";
    const chips = (p.roles||[]).map(r=>`<span class="chip">${r}</span>`).join(" ");
    return `
      <div style="margin-top:6px">
        <div style="font-weight:700">${p.title}</div>
        <div class="muted" style="margin:6px 0">${p.summary}</div>
        <div>${chips}</div>
      </div>`;
  }

  function onSelect(lead){
    details.innerHTML = `
      <div class="muted">ID ${lead.id}</div>
      <div><b>Host</b> ${lead.host}</div>
      <div><b>Platform</b> ${lead.platform||"unknown"}</div>
      <div><b>Created</b> ${fmtDate(lead.created_at)}</div>
      <div style="margin:6px 0"><span class="pill ${lead.temperature}">${lead.temperature}</span></div>
      <h4 style="margin:10px 0 4px 0">Why we think this is a fit</h4>
      ${explainWhy(lead.why)}
      <h4 style="margin:10px 0 4px 0">Who to contact</h4>
      ${renderPersona(lead.persona)}
    `;
  }

  function render(list){
    rowsT.innerHTML = "";
    for(const lead of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${lead.id}</td>
        <td><a href="https://${lead.host}" target="_blank" rel="noopener">${lead.host}</a></td>
        <td>${lead.platform || "unknown"}</td>
        <td>${lead.title}</td>
        <td>${fmtDate(lead.created_at)}</td>
        <td><span class="pill ${lead.temperature}">${lead.temperature}</span></td>
        <td>${(lead.why && lead.why.length)? lead.why.map(w=>w.label).slice(0,3).join(", "): "<span class='muted'>—</span>"}</td>
      `;
      tr.onclick = ()=> onSelect(lead);
      rowsT.appendChild(tr);
    }
  }

  async function loadHot(){
    try{
      const r = await fetch(`${BASE}/api/v1/leads/hot?limit=200`);
      const j = await r.json();
      render(j.items||[]);
      if((j.items||[])[0]) onSelect(j.items[0]);
    }catch{
      rowsT.innerHTML = `<tr><td colspan="7" class="muted">Error: Failed to fetch</td></tr>`;
    }
  }
  async function loadWarm(){
    try{
      const r = await fetch(`${BASE}/api/v1/leads/warm?limit=200`);
      const j = await r.json();
      render(j.items||[]);
      if((j.items||[])[0]) onSelect(j.items[0]);
    }catch{
      rowsT.innerHTML = `<tr><td colspan="7" class="muted">Error: Failed to fetch</td></tr>`;
    }
  }

  // initial
  setBase(base.value.trim());
  loadWarm();
})();
</script>
</body>
</html>
