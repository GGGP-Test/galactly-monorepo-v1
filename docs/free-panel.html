<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0e1621; --panel:#121c29; --panel2:#0f1a28; --text:#dbe7ff; --muted:#96a2b8;
      --accent:#5aa9ff; --accent2:#7bd389; --warn:#ffd166; --bad:#ff6b6b; --chip:#1a2636;
      --line:#243147;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg); color:var(--text); font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    a{color:var(--accent)}
    .wrap{
      max-width:1300px; margin:0 auto; padding:16px;
      display:grid; grid-template-columns: 420px 1fr; gap:16px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
    }
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel2) 100%);
      border:1px solid var(--line); border-radius:12px; padding:14px;
      box-shadow: 0 10px 24px #00000040 inset, 0 2px 18px #00000020;
    }
    h1{font-size:18px; margin:0 0 12px 0}
    .row{display:flex; gap:8px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input,select,button,textarea{
      background:#0c1522; color:var(--text); border:1px solid var(--line); border-radius:8px;
      padding:10px 12px; outline:none; transition:.15s border-color,.15s background;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    button{
      background:#0c1522; cursor:pointer;
    }
    .btn{background:var(--accent); border-color:#4496ee; color:#05101f}
    .btn.secondary{background:#17263a; color:var(--text)}
    .btn.ghost{background:#0c1522; color:var(--text)}
    .btn.good{background:var(--accent2); border-color:#54c37a; color:#06210f}
    .btn.warn{background:var(--warn); border-color:#e9c35e; color:#211c06}
    .btn.bad{background:#ff6b6b; border-color:#e25b5b; color:#220606}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    .grid3{display:grid; grid-template-columns: 1fr 120px 140px; gap:8px}
    .grid4{display:grid; grid-template-columns: 1fr 110px 110px 1fr; gap:8px}
    @media (max-width: 420px){ .grid2,.grid3,.grid4{grid-template-columns:1fr;}}
    .tags{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 0}
    .tag{
      padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--muted);
      border:1px solid var(--line); font-size:12px
    }
    .tag.ok{color:#97e2a7; border-color:#2b6b41}
    .tag.warn{color:#f2cf7a; border-color:#7a6429}
    .tag.bad{color:#ff9b9b; border-color:#7a2b2b}
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{font-weight:600; text-align:left; color:#9fb3d1; padding:10px; border-bottom:1px solid var(--line)}
    tbody td{padding:10px; border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#0f1c2c}
    .pill{padding:4px 8px; border-radius:999px; font-size:12px; display:inline-block}
    .pill.warm{background:#3b3321; color:#ffd166; border:1px solid #6e5a1b}
    .muted{color:var(--muted)}
    pre.log{
      height:160px; overflow:auto; background:#0b1320; border-radius:8px; padding:10px;
      border:1px solid var(--line); margin:8px 0 0; white-space:pre-wrap; word-break:break-word;
    }
    .sticky-right{
      position:sticky; top:10px; align-self:start;
      max-height: calc(100vh - 20px); overflow:auto;
    }
    .right h2{margin:0 0 10px 0; font-size:16px}
    .mt8{margin-top:8px} .mt12{margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Left controls -->
    <div class="card">
      <h1>Leads Console — Free Panel (V3)</h1>

      <div class="col">
        <label>API base</label>
        <div class="row">
          <input id="base" placeholder="https://p01--your-service.code.run" style="flex:1" />
          <button id="apply" class="btn">Apply</button>
        </div>
        <div class="row mt8">
          <button id="health" class="btn secondary" title="GET /healthz">Health</button>
          <button id="probe" class="btn secondary" title="Try common /routes endpoints">Probe</button>
          <button id="clearList" class="btn ghost">Clear list</button>
        </div>
        <div id="tags" class="tags"></div>
      </div>

      <div class="col mt12">
        <label>API key (optional for read; required for write)</label>
        <div class="row">
          <input id="apiKey" placeholder="paste key" style="flex:1" />
          <button id="saveKey" class="btn secondary">Save</button>
        </div>
      </div>

      <div class="col mt12">
        <label>Quick regions</label>
        <div class="row wrap" id="quickRegions">
          <button data-r="US/CA" class="btn ghost">US/CA</button>
          <button data-r="US/NY" class="btn ghost">US/NY</button>
          <button data-r="US/TX" class="btn ghost">US/TX</button>
          <button data-r="US/WA" class="btn ghost">US/WA</button>
          <button data-r="US/IL" class="btn ghost">US/IL</button>
        </div>
      </div>

      <div class="col mt12">
        <label>Action</label>
        <select id="action">
          <option value="find-buyers">Find buyers (one per click)</option>
          <option value="find-one">Find one (strict)</option>
        </select>
      </div>

      <div class="col mt8">
        <div class="grid3">
          <div class="col">
            <label>Supplier host</label>
            <input id="host" placeholder="peekpackaging.com" />
          </div>
          <div class="col">
            <label>Region</label>
            <select id="region">
              <option>US/CA</option><option>US/NY</option><option>US/TX</option><option>US/WA</option><option>US/IL</option>
            </select>
          </div>
          <div class="col">
            <label>Radius</label>
            <select id="radius">
              <option>25 mi</option><option selected>50 mi</option><option>100 mi</option>
            </select>
          </div>
        </div>
      </div>

      <div class="col mt8">
        <label>Path for action (relative to API root)</label>
        <div class="grid4">
          <input id="path" value="/leads/find-buyers" />
          <select id="method">
            <option>GET</option>
            <option>POST</option>
          </select>
          <select id="fallbacks" title="If 404: try common combos automatically">
            <option value="none">No fallbacks</option>
            <option value="auto" selected>Auto-probe on 404</option>
            <option value="strong">Auto-probe (strong)</option>
          </select>
          <div class="row" style="justify-content:flex-end">
            <button id="find" class="btn">Find buyers</button>
          </div>
        </div>
      </div>

      <div class="row mt8">
        <button id="download" class="btn secondary">Download CSV</button>
      </div>

      <div class="col mt8">
        <label>HTTP log</label>
        <pre id="httpLog" class="log" spellcheck="false"></pre>
      </div>
    </div>

    <!-- Right results -->
    <div class="card sticky-right right">
      <h2>Results</h2>
      <div class="muted" id="count">0 items</div>
      <div class="mt8" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why (human-readable)</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ---------- tiny helpers ----------
    const $ = s => document.querySelector(s);
    const el = id => document.getElementById(id);
    const UI = {
      base: el('base'), apply: el('apply'), health: el('health'), probe: el('probe'),
      apiKey: el('apiKey'), saveKey: el('saveKey'),
      action: el('action'), host: el('host'), region: el('region'), radius: el('radius'),
      path: el('path'), method: el('method'), fallbacks: el('fallbacks'),
      find: el('find'), download: el('download'),
      clearList: el('clearList'), tags: el('tags'),
      httpLog: el('httpLog'), list: el('list'), count: el('count'),
      quickRegions: el('quickRegions')
    };

    const S = {
      base: '', root: '', key: '', items: [],
      routes: [], // from /routes probe
    };

    const LS = {
      get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    function toast(msg, ok){
      const line = (new Date()).toTimeString().slice(0,8) + '  ' + msg;
      UI.httpLog.textContent += (UI.httpLog.textContent ? '\n' : '') + line;
      UI.httpLog.scrollTop = UI.httpLog.scrollHeight;
      console[(ok?'log':'warn')](msg);
    }

    function setTags(tags){
      UI.tags.innerHTML = '';
      tags.slice(-6).forEach(t=>{
        const span = document.createElement('span');
        span.className = 'tag ' + (t.kind||'');
        span.textContent = t.text;
        UI.tags.appendChild(span);
      });
    }

    function sanitizeBase(raw){
      if (!raw) return '';
      let s = String(raw).trim();
      // strip accidental quotes
      s = s.replace(/^["']|["']$/g, '');
      // allow users to paste with trailing slash; we'll remove it
      s = s.replace(/\/+$/,'');
      return s;
    }

    // Build request URL
    function buildUrl(path, params){
      const base = sanitizeBase(S.base);
      const root = S.root ? ('/' + S.root.replace(/^\/+|\/+$/g,'')) : '';
      const rel = '/' + String(path||'').replace(/^\/+/,'');
      const u = new URL(base + root + rel);
      if (params) Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
      return u.toString();
    }

    async function call(method, path, body, params){
      const url = buildUrl(path, params);
      toast(method.padEnd(4,' ') + ' — ' + url.replace(sanitizeBase(S.base),'') );
      const res = await fetch(url, {
        method,
        headers: {
          'content-type': 'application/json',
          ...(S.key ? {'x-api-key': S.key} : {})
        },
        body: method === 'GET' ? undefined : JSON.stringify(body ?? {})
      });
      let data=null; try{ data = await res.json() }catch{}
      return {ok: res.ok, status: res.status, data, url};
    }

    // ---------- API helpers ----------
    async function health(){
      try{
        const r = await call('GET','/healthz');
        const tags = [
          {text:`base: ${sanitizeBase(S.base)}`},
          {text:`health: ${r.status} @ (root)`, kind: r.ok?'ok':'bad'}
        ];
        setTags(tags);
        return r.ok;
      }catch(e){
        setTags([{text:`base: ${sanitizeBase(S.base)}`},{text:'health: error', kind:'bad'}]);
        toast('health: error', false);
        return false;
      }
    }

    const ROUTE_PROBES = [
      '/routes', '/_routes', '/endpoints',
      '/openapi.json','/swagger.json',
      '/api/routes','/api/_routes','/api/endpoints','/api/openapi.json','/api/swagger.json'
    ];

    async function probeRoutes(){
      const found = [];
      for (const p of ROUTE_PROBES){
        try{
          const r = await call('GET', p);
          if (r.ok){
            if (Array.isArray(r.data?.routes)) found.push(...r.data.routes);
            else if (typeof r.data === 'object' && r.data){
              // try to sniff routes from openapi/swagger minimal
              if (r.data.paths) found.push(...Object.keys(r.data.paths));
            }
          }
        }catch{}
      }
      S.routes = [...new Set(found)];
      const sample = S.routes.filter(x=>/buyers|leads|find/.test(x)).slice(0,6).join(', ');
      setTags([
        {text:`base: ${sanitizeBase(S.base)}`},
        {text:`routes: ${S.routes.length ? 'ok' : 'unknown'}`, kind: S.routes.length?'ok':'warn'},
        ...(sample ? [{text:`sample: ${sample}`}]:[])
      ]);
      return S.routes;
    }

    async function findBuyers(){
      const host = UI.host.value.trim();
      if (!host) return toast('Host is required', false);
      const region = UI.region.value;
      const radius = UI.radius.value;
      const params = { host, region, radius };

      // the "declared" path + method first
      const declared = { method: UI.method.value, path: UI.path.value };

      // fallback matrix if 404
      const fallbackWanted = UI.fallbacks.value !== 'none';
      const strong = UI.fallbacks.value === 'strong';
      const PATHS = ['/leads/find-buyers','/buyers/find-buyers','/leads/find','/buyers/find','/find-buyers','/find'];
      const METHODS = declared.method === 'GET' ? ['GET','POST'] : ['POST','GET'];

      // Try declared first
      let tried = [{...declared}];
      let last = await call(declared.method, declared.path, declared.method==='GET'?null:params, declared.method==='GET'?params:null);
      if (last.ok) return consumeFindResult(last);

      if (last.status !== 404 || !fallbackWanted){
        toast(`✖ ${declared.method} ${declared.path} — ${last.status}`, false);
        return;
      }

      // Try fallbacks
      toast('404 — starting auto-probe for correct root/path…', false);
      for (const m of METHODS){
        for (const p of PATHS){
          // skip the exact one we already tried
          if (m===declared.method && p===declared.path) continue;
          tried.push({method:m, path:p});
          last = await call(m, p, m==='GET'?null:params, m==='GET'?params:null);
          if (last.ok){
            toast(`✓ OK using ${m} ${p}`, true);
            UI.method.value = m;
            UI.path.value = p;
            return consumeFindResult(last);
          }
          if (!strong && last.status !== 404){
            // stop probing on non-404 unless "strong"
            break;
          }
        }
      }
      toast('✖ Probe finished — nothing returned 2xx', false);
    }

    function consumeFindResult(r){
      // expect either {ok:true, items:[...]} OR a single item
      const data = r.data || {};
      const arr = Array.isArray(data.items) ? data.items
                : (data.item ? [data.item] : (Array.isArray(data) ? data : [data]));
      const first = normalizeRow(arr[0] || {});
      const item = {
        host: first.host || UI.host.value.trim(),
        platform: first.platform || 'web',
        title: first.title || `Buyer lead for ${UI.host.value.trim()}`,
        created: new Date().toISOString(),
        temp: 'warm',
        whyText: first.whyText || `Compat shim matched (${UI.region.value}, ${UI.radius.value})`,
      };
      S.items = S.items || [];
      S.items.push(item);
      LS.set('items', S.items);
      renderList();
      toast('✓ OK', true);
    }

    function normalizeRow(x){
      const o = {};
      for (const [k,v] of Object.entries(x||{})){
        o[String(k).toLowerCase()] = v;
      }
      return o;
    }

    // ---------- CSV ----------
    function toCSV(items){
      const cols = ['host','platform','title','created','temp','whyText'];
      const head = cols.join(',');
      const esc = v => `${String(v??'').replace(/"/g,'""')}`;
      const rows = (items||[]).map(it => cols.map(c=>`"${esc(it[c])}"`).join(','));
      return [head, ...rows].join('\r\n');
    }
    function download(name,text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/csv;charset=utf-8'}));
      a.download = name;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // ---------- render ----------
    function renderList(){
      const items = S.items || [];
      UI.count.textContent = `${items.length} item${items.length===1?'':'s'}`;
      UI.list.innerHTML = items.map((it,i)=>`
        <tr data-i="${i}">
          <td>${i+1}</td>
          <td>${it.host||''}</td>
          <td>${it.platform||''}</td>
          <td>${it.title||''}</td>
          <td class="muted">${it.created||''}</td>
          <td>${it.temp ? `<span class="pill ${it.temp}">${it.temp}</span>`:''}</td>
          <td class="muted">${it.whyText||''}</td>
        </tr>
      `).join('');
      // row click -> modal-ish alert with JSON
      [...UI.list.querySelectorAll('tr')].forEach(tr=>{
        tr.onclick = ()=>{
          const i = +tr.dataset.i;
          alert(JSON.stringify(items[i], null, 2));
        };
      });
    }

    // ---------- wire UI ----------
    function bind(){
      UI.apply.onclick = async ()=>{
        S.base = sanitizeBase(UI.base.value);
        LS.set('base', S.base);
        setTags([{text:`base: ${S.base}`}]);
        toast('Base set', true);
      };
      UI.health.onclick = health;
      UI.probe.onclick = probeRoutes;

      UI.saveKey.onclick = ()=>{
        S.key = UI.apiKey.value.trim();
        if (!S.key){ localStorage.removeItem('apiKey'); toast('API key cleared', true); return; }
        LS.set('apiKey', S.key);
        toast('API key saved', true);
      };

      UI.quickRegions.addEventListener('click', e=>{
        const btn = e.target.closest('button[data-r]');
        if (!btn) return;
        UI.region.value = btn.dataset.r;
      });

      UI.find.onclick = findBuyers;

      UI.download.onclick = ()=>{
        const csv = toCSV(S.items||[]);
        download('buyers.csv', csv);
      };

      UI.clearList.onclick = ()=>{
        S.items = [];
        LS.set('items', S.items);
        renderList();
      };
    }

    // ---------- boot ----------
    (function init(){
      // Load state
      S.base = LS.get('base','');
      S.key = LS.get('apiKey','');
      S.items = LS.get('items',[]);
      UI.base.value = S.base;
      UI.apiKey.value = S.key;
      renderList();
      setTags(S.base ? [{text:`base: ${S.base}`}] : []);
      bind();
      // Do not auto-run anything — explicit only
    })();
  </script>
</body>
</html>