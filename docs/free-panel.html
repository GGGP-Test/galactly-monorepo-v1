<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Leads Console — Free Panel (V3)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#3b82f6;--ok:#22c55e}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
.wrap{max-width:1440px;margin:0 auto;padding:18px;display:grid;grid-template-columns:420px 1fr;gap:18px}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:14px}
h2{margin:0 0 10px}
label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px}
input,select,button,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #1f2937;border-radius:8px;padding:10px 12px;outline:none}
button{cursor:pointer}
.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.row{display:flex;gap:8px;align-items:center}
.cols2{display:grid;grid-template-columns:1fr 140px;gap:8px}
.cols3{display:grid;grid-template-columns:1fr 120px 120px;gap:8px}
.small{font-size:12px}.muted{color:var(--muted)}.ok{color:var(--ok)}
.msg{white-space:pre-wrap;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:10px;max-height:200px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}
.grid{overflow:auto;max-height:68vh}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1f2937;vertical-align:top}
th{text-align:left;color:var(--muted);font-weight:600}
thead th{position:sticky;top:0;background:var(--panel)}
.chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #334155;background:#0b1220;border-radius:999px;padding:6px 10px;font-size:12px}
.right{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Leads Console — Free Panel (V3)</h2>

    <label>API base</label>
    <div class="row">
      <input id="base" placeholder="https://p01-…code.run" />
      <button id="apply" class="primary" style="width:120px">Apply</button>
    </div>

    <label>API root (prefix added to paths)</label>
    <div class="row">
      <input id="root" value="/api/v1" />
      <button id="health" style="width:120px">Health</button>
      <button id="probe" style="width:120px">Probe</button>
    </div>
    <div class="chip">Root used: <code id="rootLbl" class="muted">/api/v1</code></div>

    <label>API key (optional for read; required for write)</label>
    <div class="row">
      <input id="apiKey" placeholder="x-api-key / bearer…" />
      <button id="saveKey" style="width:120px">Save</button>
    </div>

    <div class="row">
      <button id="refreshHot" style="width:120px">Refresh Hot</button>
      <button id="refreshWarm" style="width:120px">Refresh Warm</button>
    </div>

    <hr style="border:none;border-top:1px solid #1f2937;margin:12px 0" />

    <label>Action</label>
    <div class="chip">Find buyers (one per click)</div>

    <label style="margin-top:10px">Supplier host</label>
    <input id="host" placeholder="peekpackaging.com" />

    <label style="margin-top:8px">Region / Radius</label>
    <div class="cols3">
      <select id="region">
        <option value="US/CA" selected>US/CA</option><option>US</option><option>CA</option><option>EU</option><option>ALL</option>
      </select>
      <select id="radius">
        <option value="25">25 mi</option><option value="50" selected>50 mi</option><option value="100">100 mi</option><option value="250">250 mi</option>
      </select>
      <button id="find" class="primary">Find buyers</button>
    </div>

    <label style="margin-top:12px">Find Buyers path (relative to API root)</label>
    <div class="cols3">
      <input id="path" value="/leads/find-buyers" />
      <select id="method"><option>GET</option><option selected>POST</option></select>
      <span class="chip">Auto-probe on 404</span>
    </div>

    <div id="msg" class="msg" style="margin-top:10px;min-height:64px">Ready.</div>

    <label style="margin-top:12px">Supplier persona (used to infer intent)</label>
    <input id="p_offer" placeholder="Product/offer" />
    <input id="p_solves" placeholder="Solves (benefit)" />
    <input id="p_titles" placeholder="Buyer titles (comma-separated)" />

    <div class="right" style="margin-top:8px">
      <button id="savePersona">Save persona (local)</button>
    </div>

    <div class="right" style="margin-top:8px">
      <button id="dlHot">Download CSV (hot)</button>
      <button id="dlWarm">Download CSV (warm)</button>
    </div>

    <div class="small muted" style="margin-top:6px">Editing persona won’t clear your list.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="chip">Results</div>
      <div class="muted small"><span id="count">0</span> items</div>
    </div>
    <div class="grid">
      <table>
        <thead>
          <tr><th>#</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why (human-readable)</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const UI={
  base:$('base'), root:$('root'), rootLbl:$('rootLbl'), apply:$('apply'),
  apiKey:$('apiKey'), saveKey:$('saveKey'),
  refreshHot:$('refreshHot'), refreshWarm:$('refreshWarm'),
  host:$('host'), region:$('region'), radius:$('radius'),
  path:$('path'), method:$('method'),
  find:$('find'), msg:$('msg'), count:$('count'),
  rows:$('rows'),
  p_offer:$('p_offer'), p_solves:$('p_solves'), p_titles:$('p_titles'),
  savePersona:$('savePersona'), dlHot:$('dlHot'), dlWarm:$('dlWarm'),
  health:$('health'), probe:$('probe')
};
const S={ base:'', root:'/api/v1', key:'', items:[], persona:{offer:'',solves:'',titles:''} };

function toast(t,good){ UI.msg.textContent=String(t); if(good){ UI.msg.style.borderColor='#166534'; } }
function saveLocal(){
  localStorage.setItem('fp.base',S.base);
  localStorage.setItem('fp.root',S.root);
  localStorage.setItem('fp.key',S.key||'');
  localStorage.setItem('fp.path',UI.path.value||'');
  localStorage.setItem('fp.method',UI.method.value||'POST');
  localStorage.setItem('fp.host',UI.host.value||'');
  localStorage.setItem('fp.region',UI.region.value||'US/CA');
  localStorage.setItem('fp.radius',UI.radius.value||'50');
  localStorage.setItem('fp.persona',JSON.stringify(S.persona||{}));
}
function loadLocal(){
  S.base=localStorage.getItem('fp.base')||'';
  S.root=localStorage.getItem('fp.root')||'/api/v1';
  S.key=localStorage.getItem('fp.key')||'';
  UI.path.value=localStorage.getItem('fp.path')||'/leads/find-buyers';
  UI.method.value=localStorage.getItem('fp.method')||'POST';
  UI.host.value=localStorage.getItem('fp.host')||'';
  UI.region.value=localStorage.getItem('fp.region')||'US/CA';
  UI.radius.value=localStorage.getItem('fp.radius')||'50';
  try{ S.persona=JSON.parse(localStorage.getItem('fp.persona')||'{}')||{} }catch{ S.persona={} }
  UI.base.value=S.base; UI.root.value=S.root; UI.rootLbl.textContent=S.root||'(none)'; UI.apiKey.value=S.key;
  UI.p_offer.value=S.persona.offer||''; UI.p_solves.value=S.persona.solves||''; UI.p_titles.value=S.persona.titles||'';
}
function buildURL(base,root,path,qs){
  const b=(base||'').replace(/\/+$/,'');
  const r=(root||'').replace(/\/+$/,'');
  const p=(''+path).replace(/^\/+/,'');
  const u=new URL(b+(r?'/'+r:'')+'/'+p);
  if(qs) Object.entries(qs).forEach(([k,v])=>{ if(v!==undefined&&v!==null&&String(v).length) u.searchParams.set(k,String(v)); });
  return u.toString();
}
async function req(method, base, root, path, query, body){
  const url = buildURL(base, root, path, method==='GET'?query:undefined);
  const headers = {'content-type':'application/json'};
  if(S.key){
    Object.assign(headers,{
      'x-api-key':S.key, 'x-apikey':S.key, 'api-key':S.key,
      'authorization':'Bearer '+S.key
    });
  }
  let res, data;
  try{
    res = await fetch(url,{method,headers,body:method==='GET'?undefined:JSON.stringify(body??query??{})});
    try{ data = await res.json(); }catch{ data = { ok:res.ok, status:res.status }; }
  }catch(e){ return { ok:false, status:0, url, data:{ ok:false, error:String(e) } }; }
  const ok = res.ok && (data.ok!==false);
  return { ok, status:res.status, url, data };
}
function renderList(){
  UI.rows.innerHTML='';
  (S.items||[]).forEach((x,i)=>{
    const tr=document.createElement('tr');
    const why=x.why||x.whyText||x.reason||'';
    tr.innerHTML=`
      <td class="muted">${i+1}</td>
      <td>${x.host||x.domain||''}</td>
      <td>${x.platform||x.platforms||''}</td>
      <td>${x.title||x.name||''}</td>
      <td class="muted small">${x.created||x.ts||''}</td>
      <td><span class="chip">${x.temp||x.temperature||''}</span></td>
      <td class="small">${typeof why==='string'?why:JSON.stringify(why)}</td>`;
    UI.rows.appendChild(tr);
  });
  UI.count.textContent=String((S.items||[]).length);
}
function toCSV(items){
  const cols=['host','platform','title','created','temp','why'];
  const head=cols.join(',');
  const esc=v=>`"${String(v??'').replace(/"/g,'""').replace(/\n/g,' ')}"`;
  const rows=(items||[]).map(it=>cols.map(c=>{
    const v=(c==='why')?(it.why||it.whyText||it.reason||''):it[c];
    return esc(v);
  }).join(','));
  return [head,...rows].join('\r\n');
}
function download(name,text){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'}));
  a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
}

function personaBlock(){
  const titles=(UI.p_titles.value||'').split(',').map(s=>s.trim()).filter(Boolean);
  return { offer:UI.p_offer.value||'', solves:UI.p_solves.value||'', titles };
}
function queryVariants(host){
  const base={ host, region:UI.region.value, radius:Number(UI.radius.value)||50, persona:personaBlock() };
  return [
    base,
    {...base, supplier:host},           // supplier
    {...base, domain:host},             // domain
    {...base, website:host},            // website
    { ...base, q:host },                // q
    { ...base, op:'find-buyers' }       // op-style
  ];
}

const PROBE_PATHS=[
  '/leads/find-buyers','/leads/find-one','/leads/find',
  '/buyers/find-buyers','/buyers/find-one','/buyers/find',
  '/find-buyers','/find-one','/find',
  '/leads','/buyers'
];
const PROBE_METHODS=['POST','GET'];
const PROBE_ROOTS = root => Array.from(new Set([root,'/api/v1','/api','/v1','']));

async function probeAll(){
  const base=(UI.base.value||'').trim();
  const startRoot=(UI.root.value||'').trim();
  const host=(UI.host.value||'').trim().toLowerCase();
  if(!base){ toast('Enter API base'); return; }
  if(!host){ toast('Enter supplier host'); return; }

  const attempts=[];

  for(const r of PROBE_ROOTS(startRoot)){
    for(const path of PROBE_PATHS){
      for(const method of PROBE_METHODS){
        for(const q of queryVariants(host)){
          const r1 = await req(method, base, r, path, q, q);
          attempts.push(`${r1.status} ${method} ${r1.url}`);
          if([200,201,202,204,400,401,405].includes(r1.status) && r1.status!==404){
            UI.root.value=r; S.root=r; UI.rootLbl.textContent=r||'(none)';
            UI.path.value=path; UI.method.value=method; saveLocal();
            toast(`Route discovered:\n${method} ${r}${path}\nRetrying…`, true);
            // Try to fetch items immediately
            const again = await req(method, base, r, path, q, q);
            let items = again.data?.items || again.data?.data || (Array.isArray(again.data)?again.data:[]);
            if(!items?.length && again.data?.item) items=[again.data.item];
            if(items?.length){ S.items=items.concat(S.items||[]); renderList(); toast(`OK — added ${items.length} item(s).`, true); return; }
            toast(`Matched route but no items yet.\n${again.status} ${again.url}`);
            return;
          }
        }
      }
    }
  }
  toast('Probe attempts (none matched):\n'+attempts.slice(-80).join('\n'));
}

async function findOne(){
  S.base=(UI.base.value||'').trim(); S.root=(UI.root.value||'').trim();
  UI.rootLbl.textContent=S.root||'(none)';
  S.persona=personaBlock(); saveLocal();

  const host=(UI.host.value||'').trim().toLowerCase();
  if(!host){ toast('Enter supplier host'); return; }

  const q=queryVariants(host)[0];                 // default shape
  const path=(UI.path.value||'/leads/find-buyers').trim();
  const method=UI.method.value||'POST';

  const r1 = await req(method, S.base, S.root, path, q, q);
  if(r1.ok){
    let items = r1.data.items || r1.data.data || (Array.isArray(r1.data)?r1.data:[]);
    if(!items.length && r1.data.item) items=[r1.data.item];
    if(items.length){ S.items=items.concat(S.items||[]); renderList(); toast(`OK — added ${items.length} item(s).`, true); return; }
  }
  // Force probe on 404 (or when ok=false without items)
  if(r1.status===404 || !r1.ok){
    toast('404 — starting probe for correct root/path…');
    await probeAll();
    return;
  }
  toast(`${r1.status} ${method} ${r1.url}\n${JSON.stringify(r1.data)}`);
}

async function pingHealth(){
  S.base=(UI.base.value||'').trim();
  const roots = PROBE_ROOTS((UI.root.value||'').trim());
  const tries=[];
  for(const r of roots){
    const res = await req('GET', S.base, r, '/healthz', null, null);
    tries.push(`${res.status} GET ${res.url}`);
    if(res.ok){ UI.root.value=r; S.root=r; UI.rootLbl.textContent=r||'(none)'; saveLocal(); toast(`Health OK @ ${res.url}`, true); return; }
  }
  toast('Health checks:\n'+tries.join('\n'));
}

function bind(){
  UI.apply.onclick=()=>{ S.base=(UI.base.value||'').trim(); S.root=(UI.root.value||'').trim(); UI.rootLbl.textContent=S.root||'(none)'; saveLocal(); toast('Base/root applied',true); };
  UI.health.onclick=pingHealth;
  UI.probe.onclick=probeAll;
  UI.saveKey.onclick=()=>{ S.key=(UI.apiKey.value||'').trim(); saveLocal(); toast('API key saved',true); };
  UI.refreshHot.onclick=()=>{ S.items=[]; renderList(); toast('Hot list cleared',true); };
  UI.refreshWarm.onclick=()=>toast('Warm refreshed',true);
  UI.savePersona.onclick=()=>{ S.persona=personaBlock(); saveLocal(); toast('Persona saved (local)',true); };
  UI.find.onclick=findOne;
  UI.dlHot.onclick=()=>download('hot.csv', toCSV(S.items||[]));
  UI.dlWarm.onclick=()=>download('warm.csv', toCSV(S.items||[]));
}
function init(){ loadLocal(); bind(); renderList(); }
init();
</script>
</body>
</html>