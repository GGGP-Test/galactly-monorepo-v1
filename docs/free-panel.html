<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Free Panel</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#0f1420;--card:#121a2a;--ink:#e7ecf7;--mut:#9db0cf;--accent:#5aa1ff;--warm:#e3b341;--hot:#ff5a5a;--ok:#38c98b;--dim:#1a2438}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--ink)}
    .page{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #1d2943;border-radius:10px;padding:14px;margin:12px 0}
    label{font-size:12px;color:var(--mut);display:block;margin-bottom:6px}
    input,select,button,textarea{border-radius:8px;border:1px solid #24406a;background:#101728;color:var(--ink)}
    input,select{height:36px;padding:0 10px}
    button{height:36px;padding:0 12px;cursor:pointer}
    button.primary{background:var(--accent);border-color:#2c6ad4;color:#fff}
    button.warm{background:var(--warm);border-color:#a68021;color:#1a1207}
    button.hot{background:var(--hot);border-color:#c23c3c;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-block;background:var(--dim);padding:6px 10px;border-radius:999px;font-size:12px;margin-right:8px}
    .ready-dot{width:9px;height:9px;border-radius:50%;display:inline-block;vertical-align:middle;background:#9b9b9b;margin-left:8px}
    .ready-dot.on{background:var(--ok)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1d2943;font-size:14px}
    textarea{width:100%;min-height:120px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="page">
    <h1>
      Free Panel <span class="badge" id="status-text">booting…</span><span class="ready-dot" id="ready-dot"></span>
    </h1>

    <div class="card">
      <div class="row">
        <div style="min-width:280px;flex:1">
          <label for="api">API base</label>
          <input id="api" placeholder="https://p01-animated-cellar-…code.run"/>
        </div>
        <div><label>&nbsp;</label><button id="apply" class="primary">Apply</button></div>
        <div class="row" style="margin-left:auto">
          <label>&nbsp;</label>
          <button id="btn-health">Health</button>
          <button id="btn-clear">Clear list</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="min-width:260px;flex:1">
          <label for="supplier-host">Supplier host</label>
          <input id="supplier-host" placeholder="peekpackaging.com"/>
        </div>
        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="US/CA" selected>US/CA</option>
            <option value="US">US</option>
            <option value="CA">CA</option>
          </select>
        </div>
        <div>
          <label for="radius">Radius</label>
          <select id="radius">
            <option>25 mi</option><option selected>50 mi</option><option>100 mi</option><option>200 mi</option>
          </select>
        </div>
        <div><label>&nbsp;</label><button id="btn-find" class="primary">Find buyer</button></div>
      </div>
    </div>

    <div class="card">
      <label>Latest candidate</label>
      <div style="margin-bottom:10px">
        <span class="badge" id="b-host">—</span>
        <span class="badge" id="b-title">—</span>
        <span class="badge" id="b-when">—</span>
        <span class="badge" id="b-temp">—</span>
        <span class="badge" id="b-why">—</span>
      </div>
      <div class="row">
        <button id="btn-lock-warm" class="warm">Lock (Warm)</button>
        <button id="btn-lock-hot" class="hot">Lock (Hot)</button>
      </div>
    </div>

    <div class="card">
      <label for="http-log">HTTP log</label>
      <textarea id="http-log" spellcheck="false"></textarea>
    </div>

    <div class="card">
      <label>Results</label>
      <table class="table">
        <thead><tr><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why</th></tr></thead>
        <tbody id="results"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ----------------- helpers (NO regex)
    const $ = (s)=>document.querySelector(s);
    const now = ()=>new Date().toISOString();
    const logEl = $("#http-log");
    function log(line){ const ts=now().slice(11,19); logEl.value = ts+"  "+line+"\\n"+logEl.value; }

    function join(base, path){
      if(!base) return path;
      let b = base.trim();
      if(b.endsWith("/")) b = b.slice(0,-1);
      return b + path;
    }
    function normalizeHost(input){
      let s = (input||"").trim();
      if(!s) return "";
      // ensure it has a scheme so URL() parses
      const low = s.toLowerCase();
      if(!(low.startsWith("http://") || low.startsWith("https://"))) s = "http://" + s;
      try{
        const u = new URL(s);
        let h = (u.hostname||"").toLowerCase();
        if(h.startsWith("www.")) h = h.slice(4);
        return h;
      }catch{
        // fallback: lowercase & drop leading www.
        let h = (input||"").trim().toLowerCase();
        if(h.startsWith("www.")) h = h.slice(4);
        return h;
      }
    }
    function badge(id, v){ const el=$(id); if(el){ el.textContent=v||"—"; el.title=v||""; } }
    function renderLatest(c){
      badge("#b-host",c?.host); badge("#b-title",c?.title); badge("#b-when",c?.created);
      badge("#b-temp",c?.temp); badge("#b-why",c?.why);
    }
    function addRow(c){
      const tb=$("#results"); const tr=document.createElement("tr");
      [c.host,c.platform||"web",c.title,c.created,c.temp,c.why].forEach(t=>{
        const td=document.createElement("td"); td.textContent=t||""; tr.appendChild(td);
      });
      tb.prepend(tr);
    }

    let latest = null;
    function setLatest(c){ latest=c; renderLatest(c||{}); }

    function base(){ return ($("#api").value || localStorage.getItem("apiBase") || "").trim(); }

    // ----------------- actions
    async function findBuyer(){
      const b = base(); if(!b){ alert("Set API base then Apply."); return; }
      const supplier = normalizeHost($("#supplier-host").value);
      const region = $("#region").value || "US/CA";
      const radius = $("#radius").value || "50 mi";
      const url = join(b, "/api/leads/find-buyers?host="+encodeURIComponent(supplier)+"&region="+encodeURIComponent(region)+"&radius="+encodeURIComponent(radius));

      const t0 = performance.now();
      let r; try { r = await fetch(url); } catch(e){ log("GET  "+url+"  ERR"); setLatest(null); return; }
      const ms = Math.round(performance.now()-t0);
      if(!r.ok){ log("GET  "+url+"  "+r.status+" "+r.statusText+" ("+ms+"ms)"); setLatest(null); return; }

      let d=null; try{ d = await r.json(); }catch{ log("GET  "+url+"  200 OK (bad JSON) ("+ms+"ms)"); setLatest(null); return; }

      const c = {
        host: (d && d.host) || "", title: (d && d.title) || "",
        platform: (d && d.platform) || "web", created: (d && d.created) || now(),
        temp: (d && d.temp) || "warm", why: (d && d.why) || "", supplier_host: supplier
      };

      if(!c.host || !c.title){ log("GET  "+url+"  200 OK ("+ms+"ms)"); setLatest(null); log("✗ no candidate from API"); return; }
      if(c.host === supplier){ log("GET  "+url+"  200 OK ("+ms+"ms)"); setLatest(null); log("✗ API returned supplier itself"); return; }

      setLatest(c); addRow(c); log("GET  "+url+"  200 OK ("+ms+"ms)");
    }

    async function lock(tempWanted){
      if(!latest){ log("✗ no candidate yet"); return; }
      const b = base(); if(!b){ alert("Set API base then Apply."); return; }
      const url = join(b, "/api/leads/lock");
      const body = {...latest, temp: tempWanted || latest.temp || "warm"};

      const t0 = performance.now();
      let r; try{
        r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      }catch(e){ log("POST "+url+"  ERR"); return; }
      const ms = Math.round(performance.now()-t0);
      log("POST "+url+"  "+r.status+" "+r.statusText+" ("+ms+"ms)");
    }

    // ----------------- boot (no IIFE crashes; wait for DOM)
    document.addEventListener("DOMContentLoaded", () => {
      try{
        $("#apply").addEventListener("click", ()=>{ localStorage.setItem("apiBase", ($("#api").value||"").trim()); log("✓ Base restored"); });
        $("#btn-health").addEventListener("click", async ()=>{
          const b=base(); if(!b){ alert("Set API base."); return; }
          const url = join(b, "/healthz");
          const t0=performance.now();
          try{ const r=await fetch(url); log("GET  "+url+"  "+r.status+" "+r.statusText+" ("+Math.round(performance.now()-t0)+"ms)"); }
          catch{ log("GET  "+url+"  ERR"); }
        });
        $("#btn-clear").addEventListener("click", ()=>{ $("#results").innerHTML=""; log("• cleared list"); });
        $("#btn-find").addEventListener("click", findBuyer);
        $("#btn-lock-warm").addEventListener("click", ()=>lock("warm"));
        $("#btn-lock-hot").addEventListener("click", ()=>lock("hot"));

        const saved = localStorage.getItem("apiBase") || "";
        if(saved) $("#api").value = saved;

        $("#status-text").textContent = "client ready";
        $("#ready-dot").classList.add("on");
        log("• client ready");
        window.__fpReady = true;
      }catch(err){
        console.error("boot error", err);
        $("#status-text").textContent = "boot error (see console)";
      }
    });
  </script>
</body>
</html>