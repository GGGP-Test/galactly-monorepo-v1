<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Live results</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--ink:#eaf0f7;--mut:#9aa7bd;--line:rgba(255,255,255,.08);--bg:#0b0e13;--panel:#0f141d;--pill:#132031;--hi:#86f7d6;--hi2:#57a4ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 85% -10%, rgba(120,160,255,.10), rgba(0,0,0,0) 60%),radial-gradient(900px 500px at 15% 110%, rgba(120,200,255,.07), rgba(0,0,0,0) 60%),linear-gradient(180deg,#0b0e13,#06080d 55%);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid var(--line);backdrop-filter:blur(8px) saturate(1.05);background:rgba(6,9,15,.55)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand svg{width:22px;height:22px}
    .brand b{font:800 16px Montserrat,Inter}
    .pill{background:var(--pill);border:1px solid var(--line);padding:6px 10px;border-radius:18px;font-size:12px;color:var(--mut)}

    .page{height:calc(100vh - 58px);display:grid;grid-template-columns:1.2fr 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
    @media (max-width:1050px){.page{grid-template-columns:1fr;grid-auto-rows:minmax(340px,auto);height:auto;overflow:auto}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.28);display:flex;flex-direction:column;min-height:0}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font:700 13px Inter;color:#cfe0ff;letter-spacing:.2px}
    .card .body{padding:12px;display:flex;flex-direction:column;gap:12px;min-height:0}

    /* LEFT COLUMN: live results */
    .neutron{position:relative;height:220px;border-radius:12px;background:radial-gradient(120% 100% at 50% 40%, rgba(255,255,255,.06), rgba(255,255,255,.01));border:1px solid var(--line);overflow:hidden}
    canvas#neutron{position:absolute;inset:0;width:100%;height:100%;display:block}
    .engineStatus{position:absolute;left:10px;bottom:8px;font-size:12px;color:var(--mut)}

    .feed{flex:1;min-height:0;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:8px}
    .lead{position:relative;background:#0f1724;border:1px solid #1a2740;border-radius:12px;padding:10px;margin:8px 4px;display:flex;flex-direction:column;gap:6px}
    .lead h4{margin:0;font:700 14px Inter;color:#e9f0ff}
    .lead .meta{font-size:12px;color:var(--mut)}
    .revealMask{position:absolute;inset:0;border-radius:12px;background:linear-gradient(180deg, rgba(7,11,18,.66), rgba(7,11,18,.66));display:flex;align-items:center;justify-content:center;gap:8px;color:#cfe0ff;font-weight:700;letter-spacing:.2px;user-select:none}
    .revealMask .hold{opacity:.9;border:1px solid var(--line);padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.04)}
    .btnRow{display:flex;gap:8px}
    .btn{background:#182338;border:1px solid #243555;color:#e8efff;border-radius:10px;padding:6px 10px;font-weight:700;font-size:12px;cursor:pointer}
    .btn.secondary{background:#121a29;color:#cfe0ff}

    /* RIGHT COLUMN */
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .formGrid .row{grid-column:1/-1}
    input,textarea{width:100%;background:#0d1422;border:1px solid #1b2942;color:#e9f0ff;border-radius:12px;padding:10px 12px;font:600 13px Inter;outline:none}
    textarea{min-height:88px;resize:vertical}
    .cta{display:flex;gap:10px;align-items:center}
    .hint{font-size:12px;color:var(--mut)}
    .help{margin-left:auto;border:1px solid var(--line);border-radius:10px;padding:4px 8px;color:#cfe0ff;background:#121a23;cursor:default}

    .signals{flex:1;min-height:200px;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:10px}
    .sigRow{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
    .sigRow:last-child{border-bottom:none}
    .dot{width:8px;height:8px;border-radius:50%;background:#7dd3fc;box-shadow:0 0 8px #7dd3fc88}
    .bar{height:6px;background:#132035;border-radius:6px;overflow:hidden;flex:1}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--hi), var(--hi2))}
    .off{opacity:.55}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <svg viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#86f7d6"/><stop offset="1" stop-color="#57a4ff"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="#000" stroke="#fff" stroke-opacity=".12" stroke-width="1.5"/><path d="M12 36c8 8 18 12 28 12 4 0 8-1 12-2" stroke="url(#g)" stroke-width="3" fill="none"/><circle cx="20" cy="20" r="5" fill="url(#g)"/></svg>
      <b>Galactly</b>
      <span id="status" class="pill">connecting…</span>
    </div>
    <div class="pill" title="Change API base in api-base.js or via ?api=">API ready</div>
  </header>

  <main class="page">
    <!-- LEFT: Live results (single column pane) -->
    <section class="card" id="leftCol">
      <h3>Live results</h3>
      <div class="body" style="gap:12px">
        <div class="neutron"><canvas id="neutron"></canvas><div class="engineStatus" id="engineStatus">Lead Engine • idle</div></div>
        <div id="feed" class="feed" aria-live="polite"></div>
      </div>
    </section>

    <!-- RIGHT: Customize + Signals (stacked) -->
    <section class="card" id="rightCol">
      <h3>Customize your AI</h3>
      <div class="body">
        <div class="formGrid">
          <div class="row"><input id="vSite" placeholder="Vendor site e.g. yourcompany.com (optional)"></div>
          <input id="buyers" placeholder="Seed buyers (comma‑separated domains)">
          <input id="industries" placeholder="Industries e.g. beverage, confectionery">
          <input id="regions" placeholder="Regions e.g. US, CA">
          <div class="row"><textarea id="brief" placeholder="Describe ideal customers in plain words. Products, pack types, order sizes, retailer channels, exclusions."></textarea></div>
        </div>
        <div class="cta">
          <button id="runBtn" class="btn">Find now</button>
          <span class="hint">Tip: long‑press a card to reveal. 2 deep reveals/day on free.</span>
          <span class="help" title="Be direct: list products, pack formats (bottle, can, sachet), order sizes, certifications, retailer channels, regions, exclusions.">?</span>
        </div>
      </div>
      <h3>Signals preview <span id="sigState" class="off">idle</span></h3>
      <div class="body" style="padding-top:8px">
        <div id="signals" class="signals"></div>
      </div>
    </section>
  </main>

  <script src="./api-base.js"></script>
  <script>
    // --------- Session + API helpers ---------
    const uidKey='galactly_uid';
    let UID=localStorage.getItem(uidKey); if(!UID){ UID='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,UID); }
    async function api(path, opts){
      const r=await fetch(path, { ...opts, headers:{ 'content-type':'application/json', 'x-galactly-user': UID, ...(opts&&opts.headers||{}) } });
      return r.json();
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    // --------- Prefill from onboarding (if present) ---------
    (function prefill(){
      const get=(k)=>localStorage.getItem(k)||'';
      const vSite=document.getElementById('vSite');
      const buyers=document.getElementById('buyers');
      const industries=document.getElementById('industries');
      const regions=document.getElementById('regions');
      const brief=document.getElementById('brief');
      const vals={
        v: get('onboard_vendor')||get('vendorDomain')||'',
        b: get('onboard_buyers')||get('buyersCsv')||'',
        i: get('onboard_industries')||get('industriesCsv')||'',
        r: get('onboard_regions')||get('regionsCsv')||'',
        t: get('onboard_notes')||get('brief')||''
      };
      if(vals.v) vSite.value=vals.v;
      if(vals.b) buyers.value=vals.b;
      if(vals.i) industries.value=vals.i;
      if(vals.r) regions.value=vals.r;
      if(vals.t) brief.value=vals.t;
      // Button label logic
      document.getElementById('runBtn').textContent = (vals.v||vals.b||vals.i||vals.r||vals.t) ? 'Save & run' : 'Find now';
    })();

    // --------- Signals preview model ---------
    const SIGNAL_SET=[
      {cat:'Demand',    name:"Retail lift & repeats",             weight:0.9},
      {cat:'Demand',    name:"Paid reach (blended)",               weight:0.8},
      {cat:'Demand',    name:"Search surge (CSE pulses)",         weight:0.7},
      {cat:'Procure',   name:"Supplier intake surface",            weight:0.9},
      {cat:'Procure',   name:"Compliance & docs footprint",        weight:0.6},
      {cat:'Product',   name:"Case‑of‑N & pack dims",              weight:0.8},
      {cat:'Product',   name:"Restock cadence (site/blog)",        weight:0.7},
      {cat:'Quality',   name:"Returns chatter (sentiment)",        weight:0.5},
      {cat:'Channels',  name:"Wholesale/retail placement",         weight:0.7},
      {cat:'Ops',       name:"Ship lanes & lead times",            weight:0.6},
      {cat:'Ops',       name:"Seasonal windows (promo)",           weight:0.6},
      {cat:'Finance',   name:"Unit economics sanity",              weight:0.5}
    ];

    const sigHost=document.getElementById('signals');
    function renderSignals(){ sigHost.innerHTML=''; SIGNAL_SET.forEach((s,i)=>{
      const row=document.createElement('div'); row.className='sigRow';
      row.innerHTML=`<span class="dot"></span><strong style="min-width:88px;opacity:.8">${s.cat}</strong><span style="flex:1">${s.name}</span><div class="bar"><i style="width:${Math.round(s.weight*12)}%"></i></div>`;
      sigHost.appendChild(row);
    }); }
    renderSignals();

    async function slowPreview(total=24){
      // Walk through signals slowly, never finishing 100% on free
      document.getElementById('sigState').textContent='running…';
      document.getElementById('sigState').classList.remove('off');
      const bars=[...sigHost.querySelectorAll('.bar>i')];
      let step=0; const maxTicks=Math.min(total, 28);
      while(step<maxTicks){
        const idx=step % bars.length; const b=bars[idx];
        const cur=parseFloat(b.style.width)||0; const next=Math.min(100, cur + 6 + Math.random()*10);
        b.style.width = next + '%';
        step++; await sleep(900+Math.random()*600);
      }
      document.getElementById('sigState').textContent='paused (free cap)';
      document.getElementById('sigState').classList.add('off');
    }

    // --------- Neutron star (lightweight) ---------
    const cvs=document.getElementById('neutron'); const DPR=Math.min(2, devicePixelRatio||1); let ctx=null, t0=0;
    function sizeNeutron(){ const r=cvs.getBoundingClientRect(); cvs.width=r.width*DPR; cvs.height=r.height*DPR; ctx=cvs.getContext('2d'); ctx.setTransform(DPR,0,0,DPR,0,0); }
    window.addEventListener('resize', sizeNeutron); sizeNeutron();
    function drawNeutron(ts){ if(!ctx) return; const t=(ts-(t0||ts))/1000; if(!t0) t0=ts; const w=cvs.clientWidth, h=cvs.clientHeight; ctx.clearRect(0,0,w,h);
      const cx=w*0.46, cy=h*0.54; const core=18 + 2*Math.sin(ts*0.003);
      // halo
      let g=ctx.createRadialGradient(cx,cy,0,cx,cy,110); g.addColorStop(0,'rgba(255,255,255,.08)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,110,0,Math.PI*2); ctx.fill();
      // rings
      ctx.strokeStyle='rgba(255,255,255,.18)'; for(let i=0;i<2;i++){ ctx.beginPath(); ctx.arc(cx,cy,core+22*i,0,Math.PI*2); ctx.stroke(); }
      // core
      g=ctx.createRadialGradient(cx,cy,0,cx,cy,core*2.2); g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.globalCompositeOperation='lighter'; ctx.beginPath(); ctx.arc(cx,cy,core*2.2,0,Math.PI*2); ctx.fillStyle=g; ctx.fill(); ctx.globalCompositeOperation='source-over';
      // beams (two subtle rotating)
      const ang = ts*0.0007; const len=Math.min(w,h)*0.5; const w1=2.2;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang);
      for(const rot of [0, Math.PI]){
        ctx.rotate(rot);
        const grad=ctx.createLinearGradient(0,0,len,0); grad.addColorStop(0,'rgba(134,247,214,0.9)'); grad.addColorStop(1,'rgba(134,247,214,0.0)');
        ctx.strokeStyle=grad; ctx.lineWidth=w1; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len,0); ctx.stroke();
        const grad2=ctx.createLinearGradient(0,0,len,0); grad2.addColorStop(0,'rgba(87,164,255,0.8)'); grad2.addColorStop(1,'rgba(87,164,255,0.0)');
        ctx.strokeStyle=grad2; ctx.lineWidth=w1; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len*0.65,0); ctx.stroke();
      }
      ctx.restore();
      requestAnimationFrame(drawNeutron);
    }
    requestAnimationFrame(drawNeutron);

    // --------- Live feed logic ---------
    const feed=document.getElementById('feed'); const statusEl=document.getElementById('status'); const engineEl=document.getElementById('engineStatus');
    let cards=[]; function domLead(L){
      const el=document.createElement('div'); el.className='lead';
      const host=(()=>{ try{return new URL(L.source_url).hostname.replace(/^www\./,'');}catch{return ''} })();
      el.innerHTML=`<div class="meta">${(L.platform||'source').replace('_',' ')} • ${host||'domain'}</div>
        <h4>${escapeHtml(L.title||'Candidate')}</h4>
        <div class="meta">confidence <strong>${Math.max(50, Math.min(92, L.heat||68))}%</strong> • ${L.cat||'demand'}</div>
        <div class="btnRow"><button class="btn" data-a="own">Own</button><button class="btn secondary" data-a="why">Why this?</button></div>`;
      // hold‑to‑reveal mask
      const mask=document.createElement('div'); mask.className='revealMask'; mask.innerHTML='<span class="hold">Press & hold to reveal</span>'; el.appendChild(mask);
      let timer=null, held=false; const holdMs=1100;
      el.addEventListener('pointerdown',()=>{ if(held) return; timer=setTimeout(async()=>{ held=true; mask.remove(); await claim(L); }, holdMs); });
      ['pointerup','pointerleave','pointercancel'].forEach(evt=> el.addEventListener(evt,()=>{ if(timer){ clearTimeout(timer); timer=null; }}));
      el.querySelector('[data-a=own]').onclick=()=>own(L);
      el.querySelector('[data-a=why]').onclick=()=>showWhy(L);
      return el;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    async function claim(L){ try{ const r=await api('/api/v1/claim',{ method:'POST', body:JSON.stringify({leadId:L.id})}); if(r?.ok){ L._windowId=r.windowId; L._exp=Date.now()+(r.reservedForSec||120)*1000; } }catch(e){} }
    async function own(L){ if(!L._windowId) return; const r=await api('/api/v1/own',{ method:'POST', body:JSON.stringify({windowId:L._windowId})}); if(r?.ok){ L._owned=true; }}
    function showWhy(L){ alert('Why this: strong external demand + recent product activity + procurement surface. Upgrade for full breakdown.'); }

    async function pullLeads(){
      try{
        const r=await api('/api/v1/leads', { headers:{} });
        if(!r?.ok) throw new Error('bad');
        statusEl.textContent='ok'; engineEl.textContent='Lead Engine • adding…';
        // Clear and stream in slowly to feel real‑time
        feed.innerHTML='';
        const arr = r.leads || [];
        for(let i=0;i<arr.length;i++){
          const L = arr[i];
          const el = domLead(L); feed.appendChild(el);
          await sleep(600 + Math.random()*500);
        }
        engineEl.textContent='Lead Engine • ready';
      }catch(e){ statusEl.textContent='retrying…'; setTimeout(pullLeads, 3000); }
    }

    // Kick a run when user hits Find now / Save & run
    document.getElementById('runBtn').addEventListener('click', async ()=>{
      const body = {
        vendorDomain: document.getElementById('vSite').value.trim() || undefined,
        buyers: csv(document.getElementById('buyers').value),
        industries: csv(document.getElementById('industries').value),
        regions: csv(document.getElementById('regions').value),
        brief: document.getElementById('brief').value.trim() || undefined
      };
      // Persist for future sessions
      try{ if(body.vendorDomain) localStorage.setItem('onboard_vendor', body.vendorDomain);
        localStorage.setItem('onboard_buyers', (body.buyers||[]).join(', '));
        localStorage.setItem('onboard_industries', (body.industries||[]).join(', '));
        localStorage.setItem('onboard_regions', (body.regions||[]).join(', '));
        if(body.brief) localStorage.setItem('onboard_notes', body.brief);
      }catch{}

      // Show running state + slow signals preview
      engineEl.textContent='Lead Engine • normalizing…';
      slowPreview(24);

      try{ await api('/api/v1/find-now',{ method:'POST', body:JSON.stringify(body) }); }
      catch(e){}
      await sleep(1200); // give backend a moment
      pullLeads();
    });

    function csv(s){ return (s||'').split(',').map(x=>x.trim()).filter(Boolean); }

    // Initial auto‑run if we came from onboarding with values
    (function autoKick(){
      const any = ['onboard_vendor','onboard_buyers','onboard_industries','onboard_regions','onboard_notes'].some(k=>localStorage.getItem(k));
      if(any){ document.getElementById('runBtn').click(); }
    })();

    // First leads fetch (in case user skips run)
    pullLeads();
  </script>
</body>
</html>
