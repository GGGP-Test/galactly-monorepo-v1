<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Free Panel â€” Buyers Finder</title>
<style>
  :root {
    --bg:#0f1220; --panel:#151a2e; --muted:#222846; --text:#e9ecf8; --sub:#aeb6d9;
    --acc:#6ea8fe; --ok:#2fb170; --warn:#ffb02e; --hot:#ff4769; --warm:#ffc857; --cool:#6ec6ff;
    --chip:#2a315a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--acc);text-decoration:none}
  .wrap{display:flex;min-height:100vh}
  .left{width:420px;max-width:100%;padding:16px;border-right:1px solid var(--muted);background:linear-gradient(180deg,var(--panel),#10142a)}
  .right{flex:1;min-width:0;padding:16px}
  h2{margin:12px 0 8px;font-size:16px}
  h3{margin:16px 0 8px;font-size:14px;color:var(--sub)}
  label{display:block;font-size:12px;color:var(--sub);margin:6px 0 4px}
  input,select,textarea{
    width:100%;background:#0d1124;border:1px solid var(--muted);color:var(--text);
    border-radius:8px;padding:10px 12px;outline:none
  }
  textarea{min-height:68px;resize:vertical}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .btn{
    display:inline-flex;align-items:center;gap:8px;background:#1e264a;border:1px solid var(--muted);
    color:var(--text);padding:10px 12px;border-radius:8px;cursor:pointer;user-select:none
  }
  .btn:hover{background:#263062}
  .btn.primary{background:var(--acc);border-color:transparent;color:#0b1024}
  .btn.good{background:var(--ok);border-color:transparent;color:#03120b}
  .btn.warn{background:var(--warn);border-color:transparent;color:#231500}
  .btn.ghost{background:transparent}
  .section{padding:12px;border:1px solid var(--muted);border-radius:12px;background:rgba(255,255,255,0.02)}
  .small{font-size:12px;color:var(--sub)}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{padding:3px 8px;border-radius:999px;background:var(--chip);color:#cdd6ff;font-size:12px}
  .tag-hot{background:rgba(255,71,105,.14);color:#ff9fb0}
  .tag-warm{background:rgba(255,200,87,.16);color:#ffe2a8}
  .tag-cool{background:rgba(110,198,255,.16);color:#bfe6ff}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:12px;color:var(--sub);text-align:left;padding:0 10px}
  .table td{background:#0e1430;padding:12px 10px;border-top:1px solid #1a2144;border-bottom:1px solid #1a2144}
  .table tr td:first-child{border-left:1px solid #1a2144;border-top-left-radius:8px;border-bottom-left-radius:8px}
  .table tr td:last-child{border-right:1px solid #1a2144;border-top-right-radius:8px;border-bottom-right-radius:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  pre.log{background:#0a0e22;border:1px solid #1a2144;border-radius:12px;padding:10px;max-height:220px;overflow:auto;color:#9cb3ff}
  .hint{color:#8fa3ff}
  .split{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
  @media (max-width:1100px){.split{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h2>Connection</h2>
    <div class="section">
      <label>API Base (your server root)</label>
      <input id="apiBase" placeholder="https://your-domain.tld" />
      <div class="row">
        <div>
          <label>x-api-key (optional)</label>
          <input id="apiKey" placeholder="leave blank if none" />
        </div>
        <div style="align-self:flex-end"><button class="btn" id="btnSaveConn">Save</button></div>
      </div>
      <div class="small">Tip: if this HTML is served by the same host as the API, you can leave API Base blank.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnPing">Ping</button>
        <button class="btn ghost" id="btnClearLog">Clear Log</button>
      </div>
    </div>

    <h2 style="margin-top:14px">Supplier</h2>
    <div class="section">
      <label>Supplier Host (their domain, no http)</label>
      <input id="supplierHost" placeholder="example.com" />
      <div class="row">
        <div>
          <label>City (used everywhere)</label>
          <input id="supplierCity" placeholder="e.g., los angeles" />
        </div>
        <div>
          <label>Min Tier</label>
          <select id="minTier">
            <option value="C">Tier C first</option>
            <option value="B">Tier B+</option>
            <option value="A">No filter (A/B/C)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Limit</label>
          <select id="limit"><option>6</option><option selected>12</option><option>20</option><option>30</option></select>
        </div>
        <div>
          <label>Fallback discovery term</label>
          <input id="discoverTerm" placeholder="e.g., coffee shop" />
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="useFallback" checked />
            Also use Google Places if no buyers found
          </label>
        </div>
        <div style="align-self:flex-end">
          <button class="btn primary" id="btnFind" disabled>Find Buyers</button>
        </div>
      </div>
      <div class="small hint" id="activeProfileHint"></div>
    </div>

    <h2 style="margin-top:14px">Preference Profile (optional)</h2>
    <div class="section">
      <div class="row">
        <div>
          <label>Profile ID</label>
          <input id="profileId" placeholder="auto if blank" />
        </div>
        <div style="align-self:flex-end"><button class="btn" id="btnLoadProfile">Load</button></div>
      </div>

      <div class="row">
        <div>
          <label>City default (used only if Supplier city is blank)</label>
          <input id="prefCity" placeholder="e.g., los angeles" />
        </div>
        <div>
          <label>Exclude Giants (Tier A)</label>
          <select id="prefExcludeGiants"><option value="false">No</option><option value="true">Yes</option></select>
        </div>
      </div>

      <h3>Hot cues (one per line)</h3>
      <textarea id="prefHot" placeholder="grand opening&#10;new launch&#10;pre-order"></textarea>

      <h3>Warm cues (one per line)</h3>
      <textarea id="prefWarm" placeholder="wholesale&#10;private label&#10;co-pack"></textarea>

      <h3>Must-have (optional, one must appear for HOT)</h3>
      <textarea id="prefMust" placeholder="(optional) e.g., preorder"></textarea>

      <div class="row">
        <div>
          <h3>Prefer Segments</h3>
          <textarea id="prefSegPrefer" placeholder="beverage&#10;bakery&#10;beauty"></textarea>
        </div>
        <div>
          <h3>Prefer Tags</h3>
          <textarea id="prefTagPrefer" placeholder="label&#10;carton&#10;shipper"></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <h3>Avoid Segments</h3>
          <textarea id="prefSegAvoid" placeholder="automotive"></textarea>
        </div>
        <div>
          <h3>Avoid Tags</h3>
          <textarea id="prefTagAvoid" placeholder="drum"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn good" id="btnSaveProfile">Save / Update Profile</button>
        <button class="btn ghost" id="btnForgetProfile">Forget ID</button>
      </div>
      <div class="small">We store profile ID & API settings in <span class="mono">localStorage</span> only.</div>
    </div>

  </div>

  <div class="right">
    <div class="split">
      <div>
        <h2>Results</h2>
        <table class="table" id="resultsTable">
          <thead>
            <tr>
              <th style="width:70px">Score</th>
              <th style="width:90px">Temp</th>
              <th>Buyer</th>
              <th>Why</th>
              <th style="width:120px">Action</th>
            </tr>
          </thead>
          <tbody id="resultsBody"><!-- rows injected --></tbody>
        </table>
      </div>
      <div>
        <h2>HTTP Log</h2>
        <pre class="log mono" id="httpLog"></pre>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const logEl = $('#httpLog');

  const S = {
    apiBase: $('#apiBase'), apiKey: $('#apiKey'),
    btnSaveConn: $('#btnSaveConn'), btnPing: $('#btnPing'), btnClearLog: $('#btnClearLog'),

    supplierHost: $('#supplierHost'), supplierCity: $('#supplierCity'),
    minTier: $('#minTier'), limit: $('#limit'),
    discoverTerm: $('#discoverTerm'), useFallback: $('#useFallback'),
    btnFind: $('#btnFind'),

    profileId: $('#profileId'), prefCity: $('#prefCity'),
    prefExcludeGiants: $('#prefExcludeGiants'),
    prefHot: $('#prefHot'), prefWarm: $('#prefWarm'), prefMust: $('#prefMust'),
    prefSegPrefer: $('#prefSegPrefer'), prefTagPrefer: $('#prefTagPrefer'),
    prefSegAvoid: $('#prefSegAvoid'), prefTagAvoid: $('#prefTagAvoid'),
    btnSaveProfile: $('#btnSaveProfile'), btnLoadProfile: $('#btnLoadProfile'),
    btnForgetProfile: $('#btnForgetProfile'),

    activeProfileHint: $('#activeProfileHint'),
    resultsBody: $('#resultsBody'),
  };

  const LS = {
    get k(){ return {
      apiBase:'fp.apiBase', apiKey:'fp.apiKey',
      profileId:'fp.profileId',
      prefCity:'fp.pref.city', prefExcludeGiants:'fp.pref.excludeGiants',
      prefHot:'fp.pref.hot', prefWarm:'fp.pref.warm', prefMust:'fp.pref.must',
      prefSegPrefer:'fp.pref.segPrefer', prefTagPrefer:'fp.pref.tagPrefer',
      prefSegAvoid:'fp.pref.segAvoid', prefTagAvoid:'fp.pref.tagAvoid',
      supplierHost:'fp.supplier.host', supplierCity:'fp.supplier.city',
      minTier:'fp.supplier.minTier', limit:'fp.supplier.limit',
      discoverTerm:'fp.discover.term', useFallback:'fp.discover.use'
    }},
    save(k,v){ localStorage.setItem(k, v ?? ''); },
    load(k,d=''){ const v = localStorage.getItem(k); return v==null?d:v; },
    del(k){ localStorage.removeItem(k); }
  };

  function ts(){ return new Date().toISOString().replace('T',' ').replace('Z',''); }
  function log(line){ logEl.textContent += `[${ts()}] ${line}\n`; logEl.scrollTop = logEl.scrollHeight; }

  function fullUrl(p){
    const base = (S.apiBase.value||'').trim().replace(/\/+$/,'');
    if (!base) return p;
    if (p.startsWith('http')) return p;
    return base + p;
  }

  async function fetchJSON(method, path, body){
    const url = fullUrl(path);
    const headers = {'content-type':'application/json'};
    const k = (S.apiKey.value||'').trim(); if (k) headers['x-api-key'] = k;
    const init = { method, headers, redirect:'follow' };
    if (body) init.body = JSON.stringify(body);

    log(`${method} ${url}`);
    const t0 = performance.now();
    let resp, data, ok=false;
    try{
      resp = await fetch(url, init);
      const ct = resp.headers.get('content-type')||'';
      data = ct.includes('application/json') ? await resp.json() : { raw: await resp.text() };
      ok = resp.ok;
      log(`â†³ ${resp.status} ${resp.statusText} (${Math.round(performance.now()-t0)} ms)`);
    }catch(e){
      log(`â†³ network error: ${e && e.message ? e.message : e}`);
      throw e;
    }
    if (!ok){
      log(`â†³ body: ${JSON.stringify(data)}`);
      const err = new Error((data && data.error) ? data.error : `HTTP ${resp.status}`);
      err.status = resp.status; err.data = data; throw err;
    }
    return data;
  }

  function splitLines(s){ return (s||'').split(/[\n,;]+/).map(x=>x.trim().toLowerCase()).filter(Boolean); }

  function setActiveProfileHint(){
    const pid = (S.profileId.value||'').trim();
    S.activeProfileHint.textContent = pid
      ? `Using profileId=${pid} when searching (unless you clear it).`
      : `No profile set. You can still search; defaults apply.`;
  }

  function badge(temp){
    const t=(temp||'').toLowerCase();
    if (t==='hot') return '<span class="chip tag-hot">HOT</span>';
    if (t==='warm') return '<span class="chip tag-warm">WARM</span>';
    return '<span class="chip tag-cool">COOL</span>';
  }

  function renderRows(items){
    S.resultsBody.innerHTML='';
    if (!items || !items.length){
      const tr=document.createElement('tr'), td=document.createElement('td');
      td.colSpan=5; td.textContent='No items'; tr.appendChild(td); S.resultsBody.appendChild(tr); return;
    }
    for (const it of items){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${Math.round(it.score||0)}</td>
        <td>${badge(it.temp)}</td>
        <td>
          <div class="mono" style="font-weight:600">${it.host||''}</div>
          <div class="small" style="opacity:.85">${it.title||it.name||''}</div>
        </td>
        <td><div class="small">${(it.why||'').replace(/\sÂ·\s/g,' â€¢ ')}</div></td>
        <td><button class="btn" data-lock="${encodeURIComponent(it.host||'')}">Lock</button></td>
      `;
      S.resultsBody.appendChild(tr);
    }
  }

  function saveConn(){ LS.save(LS.k.apiBase,S.apiBase.value||''); LS.save(LS.k.apiKey,S.apiKey.value||''); log('saved connection'); }
  async function ping(){ try{ const r=await fetchJSON('GET','/healthz'); log(`healthz: ${JSON.stringify(r)}`);}catch(e){} }

  async function saveProfile(){
    const body = {
      id:(S.profileId.value||'').trim()||undefined,
      city:(S.prefCity.value||'').trim()||undefined,
      excludeGiants:S.prefExcludeGiants.value==='true',
      hotCues:splitLines(S.prefHot.value), warmCues:splitLines(S.prefWarm.value),
      mustHave:splitLines(S.prefMust.value),
      preferSegments:splitLines(S.prefSegPrefer.value), preferTags:splitLines(S.prefTagPrefer.value),
      avoidSegments:splitLines(S.prefSegAvoid.value), avoidTags:splitLines(S.prefTagAvoid.value),
    };
    try{
      const r = await fetchJSON('POST','/api/prefs/upsert', body);
      const id = r.id || (r.profile && r.profile.id) || '';
      if (id){ S.profileId.value=id; LS.save(LS.k.profileId,id); log(`profile saved id=${id}`); setActiveProfileHint(); }
      // persist fields
      LS.save(LS.k.prefCity,S.prefCity.value||''); LS.save(LS.k.prefExcludeGiants,S.prefExcludeGiants.value||'false');
      LS.save(LS.k.prefHot,S.prefHot.value||''); LS.save(LS.k.prefWarm,S.prefWarm.value||''); LS.save(LS.k.prefMust,S.prefMust.value||'');
      LS.save(LS.k.prefSegPrefer,S.prefSegPrefer.value||''); LS.save(LS.k.prefTagPrefer,S.prefTagPrefer.value||'');
      LS.save(LS.k.prefSegAvoid,S.prefSegAvoid.value||''); LS.save(LS.k.prefTagAvoid,S.prefTagAvoid.value||'');
    }catch(e){}
  }

  async function loadProfile(){
    const id=(S.profileId.value||'').trim(); if(!id){ log('no profile id'); return; }
    try{
      const r = await fetchJSON('GET', `/api/prefs/${encodeURIComponent(id)}`);
      const p = r.profile||{};
      S.prefCity.value = p.city || '';
      S.prefExcludeGiants.value = String(!!p.excludeGiants);
      S.prefHot.value = (p.hotCues||[]).join('\n'); S.prefWarm.value = (p.warmCues||[]).join('\n');
      S.prefMust.value = (p.mustHave||[]).join('\n');
      S.prefSegPrefer.value = (p.preferSegments||[]).join('\n'); S.prefTagPrefer.value = (p.preferTags||[]).join('\n');
      S.prefSegAvoid.value = (p.avoidSegments||[]).join('\n'); S.prefTagAvoid.value = (p.avoidTags||[]).join('\n');
      saveProfile(); setActiveProfileHint(); log(`profile loaded id=${id}`);
    }catch(e){}
  }

  async function onLockHost(host, btn){
    try{ await fetchJSON('POST','/api/leads/lock',{ host, title:'Locked by user', temp:'warm' });
      btn.textContent='Locked âœ“'; btn.classList.add('good'); btn.disabled=true;
    }catch(e){}
  }

  async function findBuyers(){
    const host=(S.supplierHost.value||'').trim().toLowerCase();
    if(!host){ alert('Enter supplier host'); return; }
    LS.save(LS.k.supplierHost,host);

    const city=(S.supplierCity.value||'').trim() || (S.prefCity.value||'').trim();
    LS.save(LS.k.supplierCity,city);
    LS.save(LS.k.minTier,S.minTier.value);
    LS.save(LS.k.limit,S.limit.value);
    LS.save(LS.k.discoverTerm,S.discoverTerm.value||'');
    LS.save(LS.k.useFallback,String(S.useFallback.checked));

    const params=new URLSearchParams();
    params.set('host',host);
    if(city) params.set('city',city);
    params.set('minTier',S.minTier.value);
    params.set('limit',String(S.limit.value));
    const pid=(S.profileId.value||'').trim(); if(pid) params.set('profileId',pid);

    S.btnFind.disabled=true; S.btnFind.textContent='Searchingâ€¦';
    try{
      // 1) primary: leads
      const base = await fetchJSON('GET', `/api/leads/find-buyers?${params.toString()}`);
      if ((base.items||[]).length>0){ renderRows(base.items); return; }

      // 2) optional fallback: places
      if (!S.useFallback.checked){ renderRows([]); return; }
      const term=(S.discoverTerm.value||'coffee shop').trim();
      const limit=Number(S.limit.value)||12;

      const p2 = new URLSearchParams({ q:term, city, limit:String(limit) });
      const alt = await fetchJSON('GET', `/api/places/search?${p2.toString()}`);
      if (alt && alt.ok && (alt.items||[]).length){
        const mapped = (alt.items||[]).map(it => ({
          host: it.host, title: it.name||'Potential buyer',
          temp: 'cool', score: 0,
          why: `discovered via Places â€¢ q="${term}" â€¢ ${city||'anywhere'}`
        }));
        renderRows(mapped);
      }else{
        const err = alt && alt.error ? alt.error : 'no-results';
        if (err==='daily-quota-exceeded') log('Places guardrail: free daily quota exceeded');
        renderRows([]);
      }
    }catch(e){ renderRows([]); }
    finally{ S.btnFind.disabled=false; S.btnFind.textContent='Find Buyers'; }
  }

  function hookEvents(){
    S.btnSaveConn.addEventListener('click', saveConn);
    S.btnPing.addEventListener('click', ping);
    S.btnClearLog.addEventListener('click', ()=>{ logEl.textContent=''; });

    S.btnSaveProfile.addEventListener('click', saveProfile);
    S.btnLoadProfile.addEventListener('click', loadProfile);
    S.btnForgetProfile.addEventListener('click', ()=>{ LS.del(LS.k.profileId); S.profileId.value=''; setActiveProfileHint(); log('forgot profile id'); });

    S.btnFind.addEventListener('click', findBuyers);
    S.resultsBody.addEventListener('click', (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const enc=b.getAttribute('data-lock'); if(!enc) return;
      const host=decodeURIComponent(enc); onLockHost(host,b);
    });

    // gate Find button on required field
    const gate=()=>{ S.btnFind.disabled = !((S.supplierHost.value||'').trim()); };
    S.supplierHost.addEventListener('input',gate); gate();
  }

  function restore(){
    S.apiBase.value = LS.load(LS.k.apiBase,''); S.apiKey.value = LS.load(LS.k.apiKey,'');

    S.profileId.value = LS.load(LS.k.profileId,''); S.prefCity.value = LS.load(LS.k.prefCity,'');
    S.prefExcludeGiants.value = LS.load(LS.k.prefExcludeGiants,'false');
    S.prefHot.value = LS.load(LS.k.prefHot,''); S.prefWarm.value = LS.load(LS.k.prefWarm,''); S.prefMust.value = LS.load(LS.k.prefMust,'');
    S.prefSegPrefer.value = LS.load(LS.k.prefSegPrefer,''); S.prefTagPrefer.value = LS.load(LS.k.prefTagPrefer,'');
    S.prefSegAvoid.value = LS.load(LS.k.prefSegAvoid,''); S.prefTagAvoid.value = LS.load(LS.k.prefTagAvoid,'');

    S.supplierHost.value = LS.load(LS.k.supplierHost,''); S.supplierCity.value = LS.load(LS.k.supplierCity,'');
    S.minTier.value = LS.load(LS.k.minTier,'C') || 'C'; S.limit.value = LS.load(LS.k.limit,'12') || '12';
    S.discoverTerm.value = LS.load(LS.k.discoverTerm,'coffee shop'); S.useFallback.checked = LS.load(LS.k.useFallback,'true')==='true';

    setActiveProfileHint();
  }

  // Boot
  hookEvents(); restore(); log('ready');
})();
</script>
</body>
</html>