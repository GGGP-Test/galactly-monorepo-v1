<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Live Feed (Minimal)</title>
  <style>
    :root{
      --bg:#0b0e13; --panel:#0f1420; --line:#1d2635; --ink:#e8ecf1; --mut:#9aa7bd;
      --accent:#86f7d6; --accent2:#57a4ff; --warn:#ffb454; --ok:#76e2b3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;}
    header{position:sticky;top:0;z-index:40;background:rgba(10,13,20,.7);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--mut);}
    .api{display:flex;gap:8px;align-items:center}
    .api input{width:380px;max-width:54vw;background:#0d1220;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:10px}
    .api button{background:#111a2b;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer}

    main{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
    @media (max-width:1000px){ main{grid-template-columns:1fr} }

    /* Left: one‑column feed */
    #feedCol{display:flex;flex-direction:column;gap:10px}
    .card{position:relative;background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;}
    .card .top{display:flex;align-items:center;justify-content:space-between}
    .host{color:var(--mut);font-size:12px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--mut)}
    .title{font-weight:700;margin-top:6px}
    .snippet{opacity:.85;margin-top:4px;max-height:52px;overflow:hidden}
    .btnrow{display:flex;gap:8px;margin-top:8px}
    .btn{background:#121a2a;border:1px solid var(--line);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    /* Hold‑to‑reveal mask */
    .mask{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(0deg, rgba(9,12,18,.92), rgba(9,12,18,.86));border-radius:14px;border:1px solid var(--line);color:#c9d3e9;opacity:.96}
    .mask .hint{display:flex;gap:8px;align-items:center}
    .meter{height:4px;background:#0d1422;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:8px}
    .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}

    /* Right: AI Working panel */
    #engine{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;min-height:420px}
    .h{display:flex;justify-content:space-between;align-items:center}
    .sub{color:var(--mut);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .row input{flex:1;min-width:220px;background:#0d1220;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px}
    .row button{background:#162036;border:1px solid var(--line);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .steps{margin:10px 0;border-top:1px dashed var(--line);padding-top:10px}
    .step{display:flex;align-items:flex-start;gap:8px;margin:6px 0}
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid var(--line);background:#0d1422;margin-top:4px}
    .step.done .dot{background:var(--ok);border-color:transparent}
    .step.run .dot{background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .log{max-height:180px;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
    .log .li{font-size:12px;color:#cbd6eb;padding:4px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
    .bar{height:8px;background:#0d1422;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin:10px 0}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .kv{display:flex;gap:12px;flex-wrap:wrap}
    .kv .k{font-size:12px;color:var(--mut)} .kv .v{font-weight:700}
  </style>
</head>
<body>
<header>
  <div class="brand">Galactly <span id="status" class="pill">connecting…</span></div>
  <div class="api">
    <label>API: <input id="apiBase" placeholder="https://<your-northflank>.app"/></label>
    <button id="saveApi">Save</button>
  </div>
</header>

<main>
  <!-- LEFT: Single-column feed -->
  <aside id="feedCol">
    <!-- cards injected here -->
  </aside>

  <!-- RIGHT: Engine (onboarding + working) -->
  <section id="engine">
    <div class="h"><strong>Lead Engine</strong><span class="sub" id="engState">idle</span></div>
    <div class="row">
      <input id="inVendor" placeholder="Vendor site (optional) e.g. yourcompany.com"/>
      <input id="inBuyers" placeholder="Seed buyers (comma separated domains)"/>
    </div>
    <div class="row">
      <input id="inIndustries" placeholder="Industries e.g. beverage, confectionery"/>
      <input id="inRegions" placeholder="Regions e.g. US, CA"/>
      <button id="btnRun">Find now</button>
    </div>

    <div class="steps" id="steps">
      <div class="step" data-k="prep"><i class="dot"></i><div>
        <div><strong>Normalize inputs</strong> <span class="sub">vendor, seeds, industry & region bias</span></div>
      </div></div>
      <div class="step" data-k="ads"><i class="dot"></i><div>
        <div><strong>Check ad libraries</strong> <span class="sub">Meta & Google transparency</span></div>
      </div></div>
      <div class="step" data-k="intake"><i class="dot"></i><div>
        <div><strong>Scan vendor pages</strong> <span class="sub">Supplier / procurement / vendor forms</span></div>
      </div></div>
      <div class="step" data-k="pdp"><i class="dot"></i><div>
        <div><strong>Products & packs</strong> <span class="sub">case‑of‑N, dimensions, restock</span></div>
      </div></div>
      <div class="step" data-k="insert"><i class="dot"></i><div>
        <div><strong>Insert leads</strong> <span class="sub">dedupe + score + queue</span></div>
      </div></div>
    </div>

    <div class="kv"><div class="k">Metrics</div><div class="v" id="mCount">0 / 1126</div></div>
    <div class="bar"><i id="mBar"></i></div>
    <div class="kv">
      <div class="k">Checked</div><div class="v" id="mChecked">0</div>
      <div class="k">Created</div><div class="v" id="mCreated">0</div>
      <div class="k">Run time</div><div class="v" id="mTook">—</div>
    </div>
    <div class="log" id="log"></div>
  </section>
</main>

<script>
// ---------- API base + session ----------
(function(){
  const DEF = (localStorage.getItem('api_base') || '').trim() || 'https://p01--animated-cellar--vz4ftkwrzdfs.code.run';
  const el = document.getElementById('apiBase'); el.value = DEF; 
  document.getElementById('saveApi').onclick = () => { localStorage.setItem('api_base', el.value.trim()); location.reload(); };
  window.API_BASE = DEF.replace(/\/+$/, '');
})();
const uidKey='galactly_uid'; let UID=localStorage.getItem(uidKey); if(!UID){ UID='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,UID); }

function api(path){ return window.API_BASE + path; }
async function GET(path){ const r=await fetch(api(path), { headers:{'x-galactly-user':UID} }); return r.json(); }
async function POST(path, body){ const r=await fetch(api(path), { method:'POST', headers:{'content-type':'application/json','x-galactly-user':UID}, body:JSON.stringify(body||{}) }); return r.json(); }

// ---------- FEED (single column) ----------
const feedEl = document.getElementById('feedCol');
let FEED = [];
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
function hostFrom(u){ try{ return new URL(u).hostname; } catch { return ''; } }

function renderFeed(){
  feedEl.innerHTML='';
  for(const L of FEED){ feedEl.appendChild(card(L)); }
}

function card(lead){
  const d=document.createElement('div'); d.className='card';
  d.innerHTML = `
    <div class="top">
      <div class="host">${escapeHtml(hostFrom(lead.source_url))}</div>
      <div class="chips">
        <span class="chip">${escapeHtml(lead.platform||'signal')}</span>
        <span class="chip">Conf <b>${lead.heat??'—'}</b></span>
      </div>
    </div>
    <div class="title">${escapeHtml(lead.title||'Untitled')}</div>
    <div class="snippet">${escapeHtml(lead.snippet||'')}</div>
    <div class="btnrow">
      <button class="btn own">Own</button>
      <button class="btn why">Why this?</button>
    </div>
    <div class="mask">
      <div>
        <div class="hint">Press & hold to reveal</div>
        <div class="meter"><i></i></div>
      </div>
    </div>`;

  // long press logic
  const mask = d.querySelector('.mask');
  const bar = d.querySelector('.meter>i');
  let t0=0, tid=null, revealed=false;
  const HOLD_MS = 1500;
  function start(){ if(revealed) return; t0 = Date.now(); mask.classList.add('hold'); bar.style.width='0%'; tid = setInterval(()=>{
      const p = Math.min(1, (Date.now()-t0)/HOLD_MS); bar.style.width=(p*100).toFixed(0)+'%';
      if(p>=1){ clear(); reveal(); }
    }, 16);
  }
  function clear(){ if(tid){ clearInterval(tid); tid=null; } mask.classList.remove('hold'); bar.style.width='0%'; }
  function reveal(){ revealed=true; mask.remove(); }
  mask.addEventListener('mousedown', start); mask.addEventListener('touchstart', start);
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=> mask.addEventListener(ev, clear));

  // actions
  d.querySelector('.own').onclick = async () => {
    const claim = await POST('/api/v1/claim', { leadId: lead.id });
    if(claim?.ok && claim.windowId){ await POST('/api/v1/own', { windowId: claim.windowId }); fetchLeads(0); }
  };
  d.querySelector('.why').onclick = () => openWhy(lead);

  return d;
}

function openWhy(lead){
  const modal = document.createElement('div');
  Object.assign(modal.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.55)',backdropFilter:'blur(4px)',display:'grid',placeItems:'center',zIndex:100});
  const box = document.createElement('div');
  Object.assign(box.style,{width:'min(720px,92vw)',background:'var(--panel)',border:'1px solid var(--line)',borderRadius:'14px',padding:'16px'});
  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Why this lead</strong>
      <button class="btn x">Close</button>
    </div>
    <div class="chips" style="margin-top:10px">
      <span class="chip">Platform: ${escapeHtml(lead.platform||'?')}</span>
      <span class="chip">Confidence: ${escapeHtml(String(lead.heat??'—'))}</span>
    </div>
    <div style="margin-top:10px">${escapeHtml(lead.title||'Untitled')}</div>
    <div class="sub" style="margin-top:6px">${escapeHtml(lead.snippet||'')}</div>
    <div style="margin-top:12px" class="kv">
      <div class="k">Intent</div><div class="v">${(lead.kw||[]).slice(0,3).join(', ')||'—'}</div>
    </div>
    <div class="row" style="margin-top:12px">
      ${lead.source_url?`<button class="btn open">Open proof</button>`:''}
      <button class="btn own">Own</button>
    </div>
  `;
  modal.appendChild(box); document.body.appendChild(modal);
  box.querySelector('.x').onclick = ()=> modal.remove();
  if(lead.source_url){ box.querySelector('.open').onclick = ()=> window.open(lead.source_url,'_blank','noopener'); }
  box.querySelector('.own').onclick = async ()=>{ const claim = await POST('/api/v1/claim',{leadId:lead.id}); if(claim?.ok && claim.windowId){ await POST('/api/v1/own',{windowId:claim.windowId}); modal.remove(); fetchLeads(0);} };
}

async function fetchLeads(delay){ if(delay>0) await new Promise(r=>setTimeout(r,delay));
  try{
    const data = await GET('/api/v1/leads');
    if(!data?.ok) throw new Error('bad response');
    FEED = data.leads || [];
    renderFeed();
    document.getElementById('status').textContent='ok';
    setTimeout(()=>fetchLeads(data.nextRefreshSec?data.nextRefreshSec*1000:15000), data.nextRefreshSec?data.nextRefreshSec*1000:15000);
  }catch(e){ document.getElementById('status').textContent='error'; setTimeout(fetchLeads, 5000); }
}

// ---------- ENGINE (onboarding + working) ----------
const inVendor = document.getElementById('inVendor');
const inBuyers = document.getElementById('inBuyers');
const inIndustries = document.getElementById('inIndustries');
const inRegions = document.getElementById('inRegions');
const btnRun = document.getElementById('btnRun');
const engState = document.getElementById('engState');
const steps = document.getElementById('steps');
const mBar = document.getElementById('mBar');
const mCount = document.getElementById('mCount');
const mChecked = document.getElementById('mChecked');
const mCreated = document.getElementById('mCreated');
const mTook = document.getElementById('mTook');
const logEl = document.getElementById('log');

// hydrate from localStorage
(function(){ try{
  const s = JSON.parse(localStorage.getItem('onboard_v1')||'{}');
  inVendor.value = s.vendorDomain||''; inBuyers.value = (s.buyers||[]).join(', ');
  inIndustries.value = (s.industries||[]).join(', '); inRegions.value = (s.regions||[]).join(', ');
} catch{} })();

function saveOnboard(){ const payload = collect(); localStorage.setItem('onboard_v1', JSON.stringify(payload)); return payload; }
function collect(){
  const buyers = inBuyers.value.split(',').map(s=>s.trim()).filter(Boolean);
  const industries = inIndustries.value.split(',').map(s=>s.trim()).filter(Boolean);
  const regions = inRegions.value.split(',').map(s=>s.trim()).filter(Boolean);
  const vendorDomain = inVendor.value.trim()||undefined;
  return { buyers, industries, regions, vendorDomain };
}

btnRun.onclick = () => runFindNow();

function setStep(key, state){ const el = steps.querySelector(`[data-k="${key}"]`); if(!el) return; el.classList.remove('run','done'); if(state) el.classList.add(state); }
function pushLog(text){ const li=document.createElement('div'); li.className='li'; li.textContent=text; logEl.prepend(li); while(logEl.children.length>16) logEl.lastChild.remove(); }

async function runFindNow(){
  const payload = saveOnboard();
  // UI prep
  engState.textContent='running…';
  ['prep','ads','intake','pdp','insert'].forEach(k=> setStep(k,null));
  setStep('prep','run'); pushLog('Normalizing inputs…');
  let metrics=0; const METRIC_MAX=1126; mBar.style.width='0%'; mCount.textContent=`0 / ${METRIC_MAX}`;
  let meter = setInterval(()=>{ metrics=Math.min(METRIC_MAX, metrics + Math.ceil(Math.random()*7)); mBar.style.width=(metrics/METRIC_MAX*100).toFixed(1)+'%'; mCount.textContent=`${metrics} / ${METRIC_MAX}`; }, 50);

  // staged visuals
  setTimeout(()=>{ setStep('prep','done'); setStep('ads','run'); pushLog('Querying ad libraries for spend signals…'); }, 600);
  setTimeout(()=>{ setStep('ads','done'); setStep('intake','run'); pushLog('Scanning supplier / procurement pages…'); }, 2200);
  setTimeout(()=>{ setStep('intake','done'); setStep('pdp','run'); pushLog('Checking product pages for case‑of‑N & restock…'); }, 4200);

  const t0 = Date.now();
  let result = { ok:false };
  try{ result = await POST('/api/v1/find-now', payload); } catch(e){ pushLog('Find‑now failed.'); }

  setStep('pdp','done'); setStep('insert','run'); pushLog('Inserting leads & scoring…');
  const took = Date.now()-t0; mTook.textContent = (took/1000).toFixed(1)+'s';
  clearInterval(meter); mBar.style.width='100%'; mCount.textContent=`${METRIC_MAX} / ${METRIC_MAX}`;

  if(result && result.ok){ mChecked.textContent = String(result.checked||0); mCreated.textContent = String(result.created||0); engState.textContent='done'; pushLog(`Created ${result.created||0} new leads from ${result.checked||0} domains.`); }
  else { engState.textContent='error'; pushLog('Engine error. Check backend logs.'); }

  setStep('insert','done');
  // immediate refresh of feed, then let poller continue
  fetchLeads(0);
}

// auto-run on first load if we have onboard data but feed is empty
(async function init(){ fetchLeads(0); const s = JSON.parse(localStorage.getItem('onboard_v1')||'{}'); if((s.buyers&&s.buyers.length) || s.vendorDomain){ runFindNow(); } })();
</script>
</body>
</html>
