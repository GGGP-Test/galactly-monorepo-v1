<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Galactly — Free Panel</title>
<style>
  :root{--bg:#0a0d14;--card:#0e1421;--line:#1e2838;--ink:#e8ecf1;--mut:#a6b0c2;--acc:#86f7d6;--acc2:#57a4ff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0e18,#06070c);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow:hidden}
  header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--line);backdrop-filter:blur(8px) saturate(1.1);background:rgba(5,7,12,.55)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;opacity:.85}
  .layout{height:calc(100vh - 60px);display:grid;grid-template-columns:58% 42%;gap:0}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}}

  /* left column */
  .left{position:relative;border-right:1px solid var(--line);display:flex;flex-direction:column}
  .loader{position:relative;flex:0 0 220px;padding:14px;border-bottom:1px solid var(--line);display:flex;gap:16px}
  .loader .viz{position:relative;flex:0 0 240px;border:1px solid var(--line);border-radius:14px;background:radial-gradient(120% 140% at 60% 40%,rgba(255,255,255,.05),rgba(255,255,255,.01));overflow:hidden}
  #star{position:absolute;inset:0;display:block;width:100%;height:100%}
  .loader .info{flex:1;display:flex;flex-direction:column;gap:10px}
  .bar{height:8px;background:#0b0f18;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--acc),var(--acc2))}
  .mini{display:flex;gap:8px;flex-wrap:wrap}
  .mini .chip{border:1px dashed var(--line);border-radius:999px;padding:4px 8px;font-size:12px;opacity:.9}

  .results{flex:1;overflow:auto;padding:10px}
  .lead{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:0 0 10px 0;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .lead h4{margin:0;font:700 14px/1.3 Inter,system-ui}
  .lead p{margin:2px 0 0 0;color:var(--mut);font-size:12px}
  .lead .heat{height:6px;background:#0b0f18;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:6px}
  .lead .heat>i{display:block;height:100%;width:40%}
  .lead .act{display:flex;gap:8px}
  .btn{background:#111827;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .ghost{background:transparent}

  /* right column */
  .right{position:relative;display:flex;flex-direction:column;overflow:hidden}
  .pane{padding:14px;border-bottom:1px solid var(--line)}
  .pane h3{margin:0 0 10px;font:800 14px/1.2 Inter,system-ui;letter-spacing:.3px}
  .pane .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){.formgrid{grid-template-columns:1fr}}
  label{display:flex;flex-direction:column;font-size:12px;opacity:.9}
  input,textarea{background:#0b0f1c;border:1px solid var(--line);color:#fff;border-radius:10px;padding:9px;margin-top:6px}
  textarea{min-height:82px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .scroll{flex:1;overflow:auto;padding:14px}
  .logline{font-size:12px;color:var(--mut);padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
  .ok{color:#9fe0b5}
  .warn{color:#ffd08a}
  .lock{opacity:.6}

  /* hold-to-reveal overlay */
  .reveal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center}
  .reveal.on{display:flex}
  .reveal .sheet{width:min(820px,92vw);max-height:84vh;overflow:auto;background:#0d1220;border:1px solid var(--line);border-radius:16px;padding:14px}
  .sheet h4{margin:0 0 8px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:8px 0}
  .why li{margin:6px 0}
</style>
</head>
<body>
<header>
  <div><strong>Galactly</strong> <span class="pill" id="status">warming…</span></div>
  <div style="display:flex;align-items:center;gap:8px">
    <label style="font-size:12px">API <input id="apiBase" size="36" style="margin-left:6px"/></label>
    <button class="btn" id="saveApi">Save</button>
  </div>
</header>
<div class="layout">
  <!-- Left: Live results (single column) -->
  <section class="left">
    <div class="loader">
      <div class="viz"><canvas id="star"></canvas></div>
      <div class="info">
        <div style="font-weight:800">Live results</div>
        <div class="bar"><i id="bar"></i></div>
        <div class="mini">
          <div class="chip" id="chip-checked">Checked: 0</div>
          <div class="chip" id="chip-created">New leads: 0</div>
          <div class="chip" id="chip-advertisers">Advertisers: 0</div>
        </div>
        <div style="font-size:12px;color:var(--mut)">We’re analyzing your inputs and streaming in results. This can take ~30–60s.</div>
      </div>
    </div>
    <div id="results" class="results"></div>
  </section>

  <!-- Right: Customize + Metrics -->
  <section class="right">
    <div class="pane">
      <h3>Customize your AI</h3>
      <div class="card">
        <div class="formgrid">
          <label>Vendor site (yours)
            <input id="vnd" placeholder="acme-packaging.com"/>
          </label>
          <label>Industries
            <input id="ind" placeholder="beverage, food"/>
          </label>
          <label>Regions
            <input id="reg" placeholder="US, CA"/>
          </label>
          <label>Example buyers
            <textarea id="buy" placeholder="liquiddeath.com\nsoylent.com"></textarea>
          </label>
          <label>Guidance to AI (natural language)
            <textarea id="guide" placeholder="We prefer beverage DTC brands in US/CA; MOQ 10k, flexibles + labels." ></textarea>
          </label>
        </div>
        <div class="actions">
          <button class="btn" id="runBtn">Find now</button>
          <button class="btn ghost" id="clearBtn">Clear</button>
        </div>
      </div>
    </div>
    <div class="scroll" id="metricsPane">
      <h3 style="margin:0 0 8px">Signal engine (preview)</h3>
      <div id="log"></div>
    </div>
  </section>
</div>

<!-- Hold-to-reveal modal -->
<div id="reveal" class="reveal"><div class="sheet">
  <h4 id="rv-title">Lead</h4>
  <div class="kv"><div>Domain</div><div id="rv-domain">—</div></div>
  <div class="kv"><div>Platform</div><div id="rv-platform">—</div></div>
  <div class="kv"><div>Confidence</div><div id="rv-heat">—</div></div>
  <div class="kv"><div>Why this</div><div>
    <ul id="rv-why" class="why"></ul>
  </div></div>
  <div class="kv"><div>Actions</div><div>
    <button class="btn" id="rv-open">Open proof</button>
    <button class="btn" id="rv-claim">Claim</button>
    <button class="btn" id="rv-own">Own</button>
    <button class="btn ghost" id="rv-close">Close</button>
  </div></div>
</div></div>

<script src="./api-base.js"></script>
<script>
// ---------- API + session helpers ----------
const uidKey='galactly_uid';
let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
const apiInput=document.getElementById('apiBase');
apiInput.value = localStorage.getItem('apiBase')  (window.API_BASE  '');
document.getElementById('saveApi').onclick=()=>{ window.__setApiBase(apiInput.value); location.reload(); };
const API=(p)=> (window.API_BASE||'').replace(/\/$/,'') + p;

function qsGetAll(){ const q=new URLSearchParams(location.search); return Object.fromEntries(q.entries()); }
function prefillFromOnboard(){
  const q=qsGetAll(); let data=null;
  if(Object.keys(q).length){ data={ vendorDomain:q.vendorDomain||'', industries:(q.industries||'').split(',').filter(Boolean), regions:(q.regions||'').split(',').filter(Boolean), buyers:(q.buyers||'').split(',').filter(Boolean) } }if(!data){ try{ data = JSON.parse(sessionStorage.getItem('galactly_onboard')||'null'); }catch{ data=null; }
  }
  if(!data) return null;
  // fill inputs
  document.getElementById('vnd').value = data.vendorDomain||'';
  document.getElementById('ind').value = (data.industries||[]).join(', ');
  document.getElementById('reg').value = (data.regions||[]).join(', ');
  document.getElementById('buy').value = (data.buyers||[]).join('\n');
  return data;
}

// ---------- Neutron star (lightweight canvas) ----------
(function(){
  const c=document.getElementById('star'); if(!c) return; const ctx=c.getContext('2d'); let W=0,H=0, t=0;
  function resize(){ const r=c.parentElement.getBoundingClientRect(); W=r.width; H=r.height; c.width=W*2; c.height=H*2; c.style.width=W+'px'; c.style.height=H+'px'; ctx.setTransform(2,0,0,2,0,0);} window.addEventListener('resize',resize); resize();
  function ring(x,y,r,alpha){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,'+alpha+')'; ctx.lineWidth=1.2; ctx.stroke(); }
  function loop(ts){ t=ts/1000; ctx.clearRect(0,0,W,H); const x=W/2,y=H/2; const base=Math.min(W,H)*0.35; // glow
    const g=ctx.createRadialGradient(x,y,0,x,y,base*2.2); g.addColorStop(0,'rgba(134,247,214,.25)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,base*2.2,0,Math.PI*2); ctx.fill();
    // core pulse
    const p=1+0.10*Math.sin(t*1.6); ring(x,y,base*0.62*p,0.22); ring(x,y,base*0.95,0.12);
    // spokes
    const spokes=24; ctx.save(); ctx.translate(x,y); ctx.rotate(t*0.5);
    for(let i=0;i<spokes;i++){ ctx.rotate((Math.PI*2)/spokes); const L=base*(0.65+0.25*Math.sin(t*1.1+i)); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(L,0); ctx.strokeStyle='rgba(134,247,214,.22)'; ctx.lineWidth=1.2; ctx.stroke(); }
    ctx.restore();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();

// ---------- Metrics preview (slow, partial) ----------
const steps=[
  ['Demand sweep','Detecting outward demand acceleration'],
  ['Retail velocity','Estimating sell‑through cadence'],
  ['Catalog delta','New SKUs / flavors / sizes'],
  ['Procurement door','Supplier / vendor access points'],
  ['Promo cycles','Discount / BOGO cadence'],
  ['Seasonal pulse','Event & holiday lift'],
  ['Geo reach','Where demand clusters'],
  ['Ops signals','Restock & back‑in‑stock hints'],
  ['Wholesale drift','Case packs / pallets'],
  ['Sustainability','Claims matching (PCR, compostable, etc.)'],
  ['Freight drag','Dim weight & pack density'],
  ['Material fit','Corrugated vs flex vs rigid fit'],
  ['Art changes','New dielines / label swaps'],
  ['3P sellers','Marketplace spillover'],
  ['Price moves','Promo windows & elasticity'],
  ['Shelf adds','Retailer adds / new doors'],
  ['Ops intent','Job posts matching packaging ops'],
  ['Audit ready','Risk & compliance breadcrumbs']
];
let stepIx=0; const logEl=document.getElementById('log');
function pushLog(text, cls){ const d=document.createElement('div'); d.className='logline '+(cls||''); d.textContent=text; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function runPreview(){
  pushLog('Starting preview • running 18/1126 checks…','warn');
  const int=setInterval(()=>{
    if(stepIx>=steps.length){ clearInterval(int); pushLog('Upgrade to run all 1,126 checks + AI reasoning.','lock'); return; }
    const [k,v]=steps[stepIx++]; pushLog(`✔ ${k} — ${v}`,'ok');
  }, 1800);
}
runPreview();

// ---------- Live feed + hold‑to‑reveal ----------
const state={ seen:new Set(), leads:[], lastRun:null };
const elResults=document.getElementById('results');
function host(u){ try{ return new URL(u).hostname; }catch{return ''} }
function heatWidth(h){ const v=Math.max(0,Math.min(95, Number(h||0))); return (v/95*100).toFixed(1)+'%'; }
function mkLeadCard(L){
  const d=document.createElement('div'); d.className='lead'; d.dataset.id=L.id;
  const h=host(L.source_url);
  d.innerHTML=`<div><h4>${escapeHtml(L.title||h||'Potential buyer')}</h4>
    <p>${escapeHtml((L.cat||'').toUpperCase())} • ${escapeHtml((L.platform||'signal'))} • ${escapeHtml(h)}</p>
    <div class="heat"><i style="background:linear-gradient(90deg,var(--acc),var(--acc2));width:${heatWidth(L.heat)}"></i></div></div>
    <div class="act"><button class="btn" data-own>Own</button></div>`;
  // press & hold
  let pressT=null; const openReveal=()=>showReveal(L);
  d.addEventListener('mousedown',()=>{ pressT=setTimeout(openReveal,600); });
  d.addEventListener('mouseup',()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } });
  d.addEventListener('mouseleave',()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } });
  d.addEventListener('touchstart',()=>{ pressT=setTimeout(openReveal,700); },{passive:true});
  d.addEventListener('touchend',()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } },{passive:true});
  d.querySelector('[data-own]').onclick=()=> ownLead(L);
  return d;
}
function render(){ elResults.innerHTML=''; for(const L of state.leads){ elResults.appendChild(mkLeadCard(L)); } }
function upsertLeads(newList){
  let added=0;
  for(const L of newList){ if(state.seen.has(L.id)) continue; state.seen.add(L.id); state.leads.push(L); added++; }
  if(added){ render(); }
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

async function post(path, body){
  const r=await fetch(API(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body||{})});
  return r.json();
}
async function fetchLeads(){
  try{
    const r=await fetch(API('/api/v1/leads'), { headers:{'x-galactly-user':uid} });
    const data=await r.json(); if(data?.ok && Array.isArray(data.leads)){ upsertLeads(data.leads); document.getElementById('status').textContent='live'; }
  }catch(e){ document.getElementById('status').textContent='retry…'; }
}
async function ownLead(L){
  try{
    const claim=await post('/api/v1/claim',{leadId:L.id});
    if(claim?.ok && claim.windowId){ await post('/api/v1/own',{windowId:claim.windowId}); }
  }catch{}
}

// ---------- Run find-now (auto from onboarding) ----------
async function runFindNow(payload){
  try{
    const r=await post('/api/v1/find-now', payload);
    // Update loader chips & slow progress
    document.getElementById('chip-checked').textContent = 'Checked: '+(r.checked||0);
    document.getElementById('chip-created').textContent = 'New leads: '+(r.created||0);
    document.getElementById('chip-advertisers').textContent = 'Advertisers: '+(r.advertisers||0);
    slowBarTo(80, 1200);
  }catch{}
}

function slowBarTo(pct, ms){ const bar=document.getElementById('bar'); const start=performance.now(); const init=Number(bar.style.width.replace('%',''))||0; const target=Math.max(init, Math.min(100,pct));
  function step(t){ const k=Math.min(1,(t-start)/ms); const v=init+(target-init)*k; bar.style.width=v+'%'; if(k<1) requestAnimationFrame(step); }
  requestAnimationFrame(step);
}

// kickoff
const seed=prefillFromOnboard();
if(seed){
  // If user came from onboarding, change CTA to Save
  document.getElementById('runBtn').textContent='Save & Run';
  // build payload
  const payload={ vendors:seed.vendorDomain? [seed.vendorDomain]:[], vendorDomain:seed.vendorDomain||undefined, industries:seed.industries||[], regions:seed.regions||[], buyers:seed.buyers||[] };
  runFindNow(payload);
}

// poll loop (kept independent; panel shows loader until first lead lands)
fetchLeads(); setInterval(fetchLeads, 8000);

// Customize form actions
function readForm(){
  const vendorDomain=document.getElementById('vnd').value.trim();
  const industries=document.getElementById('ind').value.split(',').map(s=>s.trim()).filter(Boolean);
  const regions=document.getElementById('reg').value.split(',').map(s=>s.trim()).filter(Boolean);
  const buyers=document.getElementById('buy').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const guide=document.getElementById('guide').value.trim();
  return { vendorDomain, industries, regions, buyers, guide };
}

document.getElementById('runBtn').onclick=()=>{ const v=readForm(); sessionStorage.setItem('galactly_onboard', JSON.stringify(v)); runFindNow(v); };
document.getElementById('clearBtn').onclick=()=>{ ['vnd','ind','reg','buy','guide'].forEach(id=>document.getElementById(id).value=''); };

// ---------- Reveal modal population ----------
const R={ root:document.getElementById('reveal'), title:document.getElementById('rv-title'), domain:document.getElementById('rv-domain'), platform:document.getElementById('rv-platform'), heat:document.getElementById('rv-heat'), why:document.getElementById('rv-why'), open:document.getElementById('rv-open'), claim:document.getElementById('rv-claim'), own:document.getElementById('rv-own'), close:document.getElementById('rv-close') };
function showReveal(L){
  R.title.textContent=L.title||'Lead'; R.domain.textContent=host(L.source_url); R.platform.textContent=L.platform||'signal'; R.heat.textContent=(L.heat||'—')+ ' / 95';
  // Why‑this bullets (no raw links on card)
  const why=[];
  if((L.platform||'').includes('adlib')) why.push('Active paid reach → real demand → packaging replenishment likely');
  if((L.platform||'').includes('pdp')) why.push('New SKU/pack or case size hints → near‑term packaging need');
  if((L.platform||'').includes('brandintake')) why.push('Supplier/Procurement page live → intake path is open');
  if((L.kw||[]).includes('restock')) why.push('Recent restock signal → reorder window likely open');
  if(!why.length) why.push('Composite buyer signal matched your ICP');
  R.why.innerHTML=''; for(const w of why){ const li=document.createElement('li'); li.textContent=w; R.why.appendChild(li);}  
  R.open.onclick=()=>{ if(L.source_url) window.open(L.source_url,'_blank','noopener'); };
  R.claim.onclick=async()=>{ try{ const r=await post('/api/v1/claim',{leadId:L.id}); if(r?.ok) alert('Reserved for 2 minutes'); }catch{} };
  R.own.onclick=async()=>{ try{ const c=await post('/api/v1/claim',{leadId:L.id}); if(c?.windowId){ await post('/api/v1/own',{windowId:c.windowId}); alert('Owned'); } }catch{} };
  R.close.onclick=()=> R.root.classList.remove('on');
  R.root.classList.add('on');
}
</script>
</body>
</html>
