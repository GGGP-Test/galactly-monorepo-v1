<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --surface:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --line:#1f2937;
      --btn:#2563eb; --btnH:#1d4ed8; --chip:#1f2937; --badge:#374151;
      --shadow: 0 8px 22px rgba(0,0,0,.35); --r:10px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#93c5fd;text-decoration:none}
    .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
    h1{margin:0 0 12px;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fill{flex:1 1 auto}
    .card{background:var(--surface);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);margin-bottom:14px}
    .card .head{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:600}
    .card .body{padding:12px 14px}
    input,select{width:100%;background:#0b1220;color:var(--text);border:1px solid #223;outline:none;border-radius:8px;padding:10px}
    button{background:var(--btn);border:none;color:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#374151}
    button.ghost{background:transparent;border:1px solid #223}
    button:hover{background:var(--btnH)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .badge{padding:2px 6px;border-radius:999px;background:var(--badge);font-weight:700}
    .temp{padding:2px 8px;border-radius:999px;font-weight:700}
    .hot{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .warm{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .cold{background:rgba(59,130,246,.18);color:#bfdbfe;border:1px solid rgba(59,130,246,.35)}
    .muted{color:var(--muted)}
    .list{max-height:56vh;overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:680px}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;text-align:left}
    th{position:sticky;top:0;background:rgba(17,24,39,.96);backdrop-filter:saturate(140%) blur(6px)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .notice{margin-top:10px;padding:10px 12px;border-radius:8px;background:#0b1220;border:1px dashed #223}
    .notice.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.35)}
    .notice.err{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.35)}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:16px}
    .modal .panel{max-width:720px;width:100%;background:var(--surface);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
    .modal .panel .head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal .panel .body{padding:12px 14px}
    .fomo{display:inline-flex;gap:8px;align-items:center}
    .mini-info{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:help}
    .mini-info svg{width:14px;height:14px;opacity:.9}
    @media (max-width: 900px){
      .grid{display:block}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leads Console — Free Panel</h1>

    <!-- Controls -->
    <div class="card">
      <div class="head">Settings</div>
      <div class="body">
        <div class="row" style="margin-bottom:8px">
          <input id="baseUrl" class="fill" placeholder="Base URL (e.g. https://p01--your-app--xxxxx.code.run)" />
          <button id="apply">Apply</button>
          <input id="apiKey" class="fill" placeholder="API key (optional; required if your server enforces it)" />
          <button id="saveKey" class="secondary">Save</button>
        </div>
        <div class="row">
          <input id="host" class="fill" placeholder="Buyer host (e.g. peekpackaging.com)" />
          <select id="region" style="width:160px">
            <option value="US/CA" selected>US/CA</option>
            <option value="US">US</option>
            <option value="CA">CA</option>
            <option value="EU">EU</option>
          </select>
          <select id="radius" style="width:140px">
            <option value="25 mi">25 mi</option>
            <option value="50 mi" selected>50 mi</option>
            <option value="100 mi">100 mi</option>
            <option value="250 mi">250 mi</option>
          </select>
          <button id="find">Find buyer</button>
          <button id="findAnother" class="secondary">Find another</button>
        </div>
        <div id="msg" class="notice" style="display:none"></div>
      </div>
    </div>

    <!-- Latest candidate -->
    <div class="card" id="latestCard" style="display:none">
      <div class="head">Latest candidate</div>
      <div class="body">
        <div class="row" id="latestMeta"></div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button id="lockWarm">Lock (Warm)</button>
          <button id="lockHot" class="warn" style="background:var(--warn);color:#111">Lock (Hot)</button>
          <span class="mini-info" title="Lock = reserve this lead for you, mark it warm/hot, and save it for later export.">
            <!-- exclamation icon -->
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 14h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
            What does “Lock” mean?
          </span>
          <div class="fill"></div>
          <button id="deepen" class="ghost">Deeper results</button>
          <span class="mini-info" title="Deeper results = we compute a few more variations and show them in a quick popup.">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 12l18-9-9 18-2-7-7-2z"/></svg>
            What is “Deeper results”?
          </span>
        </div>
        <div id="fomo" class="row muted" style="margin-top:10px;display:none"></div>
      </div>
    </div>

    <!-- Saved list (from server memory store) -->
    <div class="card">
      <div class="head">Saved (this session)</div>
      <div class="body">
        <div class="row" style="margin-bottom:8px">
          <button id="refreshWarm" class="secondary">Refresh warm</button>
          <button id="refreshHot" class="secondary">Refresh hot</button>
          <div class="mini-info" title="This list shows what the server has saved for you (warm/hot). CSV uses these rows.">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>
            How is this list built?
          </div>
          <div class="fill"></div>
          <button id="dlWarm" class="ghost">Download CSV (warm)</button>
          <button id="dlHot" class="ghost">Download CSV (hot)</button>
        </div>
        <div class="list">
          <table>
            <thead>
              <tr>
                <th style="width:40px">#</th>
                <th>Host</th>
                <th style="width:140px">Platform</th>
                <th>Title</th>
                <th style="width:140px">Created</th>
                <th style="width:80px">Temp</th>
                <th>Why</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Deeper results modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="head">
        <div>Deeper results</div>
        <button id="modalClose" class="secondary">Close</button>
      </div>
      <div class="body" id="modalBody">
        <div class="muted">No results yet.</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- tiny helpers ----------
    const $  = (s)=>document.querySelector(s);
    const el = {
      baseUrl: $('#baseUrl'), apiKey: $('#apiKey'),
      host: $('#host'), region: $('#region'), radius: $('#radius'),
      find: $('#find'), findAnother: $('#findAnother'),
      msg: $('#msg'), latestCard: $('#latestCard'), latestMeta: $('#latestMeta'),
      lockWarm: $('#lockWarm'), lockHot: $('#lockHot'), deepen: $('#deepen'),
      fomo: $('#fomo'),
      refreshWarm: $('#refreshWarm'), refreshHot: $('#refreshHot'),
      rows: $('#rows'), dlWarm: $('#dlWarm'), dlHot: $('#dlHot'),
      modal: $('#modal'), modalBody: $('#modalBody'), modalClose: $('#modalClose'),
      apply: $('#apply'), saveKey: $('#saveKey')
    };
    const S = {
      baseUrl: localStorage.getItem('baseUrl') || '',
      apiKey: localStorage.getItem('apiKey') || '',
      lastHost: ''
    };
    el.baseUrl.value = S.baseUrl;
    el.apiKey.value = S.apiKey;

    function base(){ return (S.baseUrl||'').replace(/\/+$/,''); }
    function hdrs(){
      const h = {'Content-Type':'application/json'};
      if (S.apiKey) h['x-api-key'] = S.apiKey;
      return h;
    }
    function showMsg(text, ok=false, err=false){
      el.msg.textContent = text;
      el.msg.className = 'notice ' + (ok?'ok':(err?'err':''));
      el.msg.style.display = 'block';
      clearTimeout(showMsg._t);
      showMsg._t = setTimeout(()=> el.msg.style.display='none', 3500);
    }
    function toISO(d){ try{ return new Date(d).toISOString(); }catch{ return new Date().toISOString(); } }
    function normHost(h){ return String(h||'').toLowerCase().replace(/^https?:\/\//,'').replace(/^www\./,'').replace(/\/.*$/,''); }

    // ---------- network ----------
    async function call(method, path, body){
      const r = await fetch(base()+path, { method, headers: hdrs(), body: body?JSON.stringify(body):undefined });
      const txt = await r.text();
      try{ return { ok:r.ok, status:r.status, data: JSON.parse(txt) }; }
      catch{ return { ok:r.ok, status:r.status, data: txt }; }
    }

    // ---------- render ----------
    function renderLatest(item){
      const temp = (item.temp||'warm').toLowerCase();
      const t = `
        <div class="pill"><span class="badge">Host</span> <a class="mono" target="_blank" href="https://${item.host}">${item.host}</a></div>
        <div class="pill"><span class="badge">Title</span> <span class="mono">${item.title||''}</span></div>
        <div class="pill"><span class="badge">When</span> ${item.created||''}</div>
        <div class="pill"><span class="badge">Why</span> ${item.whyText||''}</div>
        <div class="pill"><span class="badge">Temp</span> <span class="temp ${temp}">${temp}</span></div>
      `;
      el.latestMeta.innerHTML = t;
      el.latestCard.style.display = 'block';
    }

    function renderRows(items){
      el.rows.innerHTML = '';
      items.forEach((it,i)=>{
        const temp = (it.temperature||'warm').toLowerCase();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${i+1}</td>
          <td><a class="mono" target="_blank" href="https://${it.host}">${it.host}</a></td>
          <td>${it.platform||'web'}</td>
          <td class="mono">${it.title||''}</td>
          <td>${it.created||''}</td>
          <td><span class="temp ${temp}">${temp}</span></td>
          <td>${it.why||''}</td>
        `;
        el.rows.appendChild(tr);
      });
    }

    function csv(items){
      const cols = ['host','platform','title','created','temperature','why'];
      const head = cols.join(',');
      const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
      const rows = items.map(it=>cols.map(c=>esc(it[c])).join(','));
      return [head, ...rows].join('\r\n');
    }
    function download(name, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
      a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }

    // ---------- actions ----------
    async function doFind(){
      const host = normHost(el.host.value);
      if (!host){ showMsg('Enter a host (e.g. peekpackaging.com)',false,true); return; }
      S.lastHost = host;

      el.find.disabled = true;
      el.findAnother.disabled = true;
      showMsg('Finding buyer…');

      const body = { host, region: el.region.value, radius: el.radius.value };
      const r = await call('POST','/api/leads/find-buyers', body);
      el.find.disabled = false;
      el.findAnother.disabled = false;

      if (!r.ok){
        showMsg(`HTTP ${r.status}: ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}`, false, true);
        return;
      }
      const item = (r.data.items||[])[0];
      if (!item){ showMsg('No candidate returned', false, true); return; }
      renderLatest(item);
      showMsg('1 candidate found', true);
      el.fomo.style.display = 'none';
    }

    async function doFindAnother(){
      if (!S.lastHost) { doFind(); return; }
      const body = { host: S.lastHost, region: el.region.value, radius: el.radius.value };
      const r = await call('POST','/api/find-one', body); // compat path also mounted
      if (!r.ok){ showMsg(`HTTP ${r.status}`, false, true); return; }
      const item = (r.data.items||[])[0];
      if (!item){ showMsg('No candidate returned', false, true); return; }
      renderLatest(item);
      showMsg('Another candidate found', true);
      el.fomo.style.display = 'none';
    }

    async function doLock(temp){
      const host = S.lastHost || normHost(el.host.value);
      if (!host){ showMsg('No host to lock', false, true); return; }
      const r = await call('POST','/api/leads/lock', { host, temp });
      if (!r.ok){ showMsg(`Lock failed (HTTP ${r.status})`, false, true); return; }
      const f = r.data?.fomo || {watchers:2,competitors:1};
      el.fomo.innerHTML = `
        <div class="fomo">
          <span class="pill"><span class="badge">Watching</span> ${f.watchers}</span>
          <span class="pill"><span class="badge">Competing</span> ${f.competitors}</span>
        </div>
      `;
      el.fomo.style.display = 'flex';
      showMsg(`Locked as ${temp.toUpperCase()}`, true);
    }

    async function doDeepen(){
      const host = S.lastHost || normHost(el.host.value);
      if (!host){ showMsg('No host to deepen', false, true); return; }
      const r = await call('POST','/api/leads/deepen', {
        host, region: el.region.value, radius: el.radius.value, topK: 3
      });
      if (!r.ok){ showMsg(`Deepen failed (HTTP ${r.status})`, false, true); return; }

      const items = r.data?.items||[];
      if (!items.length){ showMsg('No deeper results', false, true); return; }

      const html = items.map((it,i)=>`
        <div class="card" style="margin:8px 0">
          <div class="body">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <div class="pill"><span class="badge">#</span> ${i+1}</div>
              <div class="pill"><span class="badge">Host</span> <a class="mono" target="_blank" href="https://${it.host}">${it.host}</a></div>
              <div class="pill"><span class="badge">Title</span> <span class="mono">${it.title||''}</span></div>
              <div class="pill"><span class="badge">Temp</span> <span class="temp ${(it.temp||'warm').toLowerCase()}">${(it.temp||'warm')}</span></div>
              <div class="pill"><span class="badge">Why</span> ${it.whyText||''}</div>
            </div>
          </div>
        </div>
      `).join('');
      el.modalBody.innerHTML = html;
      el.modal.style.display = 'flex';
      el.modal.setAttribute('aria-hidden','false');
      showMsg(`Deeper results: ${items.length}`, true);
    }

    async function refresh(kind){
      // Your server’s list endpoint is compat under many roots; we’ll use /api
      // In your current backend, the “saved list” endpoint is not formal;
      // but memStore keeps state used by CSV routes we added. Here we mimic list by asking both warm/hot buckets via CSV JSON echo.
      // For now, we’ll just re-fetch via the CSV endpoints we mounted and parse JSON if available.
      const r = await call('GET', `/api/leads/${kind}`); // our backend exposes CSV endpoints; we swapped them to JSON? If not, we’ll no-op.
      if (!r.ok || !Array.isArray(r.data?.items)) {
        // fallback: just no-op gracefully
        showMsg(`Refresh ${kind}: endpoint not wired yet (ok)`, true);
        return;
      }
      renderRows(r.data.items || []);
    }

    // CSV buttons call explicit CSV endpoints from server metrics (you mounted earlier)
    el.dlWarm.onclick = async ()=>{
      const r = await call('GET','/api/leads/warm.csv');
      if (!r.ok || typeof r.data!=='string'){ showMsg('CSV (warm) not available yet', false, true); return; }
      download('leads_warm.csv', r.data);
    };
    el.dlHot.onclick = async ()=>{
      const r = await call('GET','/api/leads/hot.csv');
      if (!r.ok || typeof r.data!=='string'){ showMsg('CSV (hot) not available yet', false, true); return; }
      download('leads_hot.csv', r.data);
    };

    // ---------- wire UI ----------
    el.apply.onclick = ()=>{ S.baseUrl = el.baseUrl.value.trim(); localStorage.setItem('baseUrl', S.baseUrl); showMsg('Base URL applied', true); };
    el.saveKey.onclick = ()=>{ S.apiKey = el.apiKey.value.trim(); localStorage.setItem('apiKey', S.apiKey); showMsg('API key saved', true); };

    el.find.onclick = doFind;
    el.findAnother.onclick = doFindAnother;
    el.lockWarm.onclick = ()=>doLock('warm');
    el.lockHot.onclick = ()=>doLock('hot');
    el.deepen.onclick = doDeepen;

    el.refreshWarm.onclick = ()=>refresh('warm');
    el.refreshHot.onclick = ()=>refresh('hot');

    el.modalClose.onclick = ()=>{
      el.modal.style.display = 'none';
      el.modal.setAttribute('aria-hidden','true');
    };
    el.modal.addEventListener('click', (e)=>{
      if (e.target === el.modal){ el.modalClose.click(); }
    });

    // ---------- boot ----------
    (function boot(){
      if (!S.baseUrl) {
        showMsg('Enter your Base URL (top-left) then click Apply.', false, false);
      } else {
        showMsg('Ready. Enter a host and click “Find buyer”.', true);
      }
    })();
  </script>
</body>
</html>