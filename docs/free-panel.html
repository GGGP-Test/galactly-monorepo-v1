<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly ‚Äî Free Lead Panel</title>
<style>
  :root{--bg:#0b0e13;--card:#111725;--ink:#e8ecf1;--muted:#9cb0c9;--line:#1e2430;--btn:#1e2a3b;--btn2:#26344c;--accent:#7ac2ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
  .wrap{max-width:1120px;margin:0 auto;padding:18px}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{background:var(--btn);border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:8px 10px}
  button:hover{filter:brightness(1.12);cursor:pointer}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));margin-top:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
  .meta{color:var(--muted);font-size:12px}
  a{color:var(--accent)}
  .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-right:6px;color:var(--muted);font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .primary{background:var(--btn2)}
  .section{margin:12px 0}
  .hint{font-size:12px;color:var(--muted)}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .sheet{max-width:560px;width:100%;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .sheet h3{margin:0 0 8px}
  .sheet .meta{margin-bottom:8px}
  .sheet .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
<header>
  <div><strong>Galactly</strong> <span class="pill" id="status">connecting‚Ä¶</span></div>
  <div class="row">
    <label>API <input id="apiBase" size="42"/></label>
    <button id="saveApi">Save</button>
  </div>
</header>

<div class="wrap">
  <!-- Onboarding -->
  <div class="card">
    <div class="row">
      <label>Vendor site
        <input id="vendorDomain" placeholder="yourcompany.com (optional)"/>
      </label>
      <label>Seed buyers
        <input id="buyers" size="38" placeholder="comma-separated domains, e.g. liquiddeath.com, soylent.com"/>
      </label>
    </div>
    <div class="row">
      <label>Industries
        <input id="industries" placeholder="e.g. beverage, confectionery"/>
      </label>
      <label>Regions
        <input id="regions" placeholder="e.g. US, CA"/>
      </label>
      <button id="runFind" class="primary">Find now</button>
      <span id="findNote" class="hint"></span>
    </div>
    <div class="hint">Tip: you can enter either <em>Vendor site</em> (we derive ICP) or explicit <em>Seed buyers</em> (comma-separated), optionally with industries/regions.</div>
  </div>

  <!-- Feed -->
  <div id="feed" class="grid"></div>
</div>

<!-- Modal (Why This / Confirm) -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet">
    <h3 id="mTitle">Why this lead?</h3>
    <div class="meta" id="mSrc"></div>
    <div id="mBody"></div>
    <div class="actions">
      <button id="mClose">Close</button>
      <button id="mConfirm" class="primary">Confirm proof</button>
    </div>
  </div>
</div>

<script>
  // ---------- API base picker ----------
  const uidKey='galactly_uid';
  let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
  const apiInput=document.getElementById('apiBase');
  const savedApi=localStorage.getItem('api_base')||'';
  apiInput.value=savedApi || 'https://p01--animated-cellar--vz4ftkwrzdfs.code.run';
  document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('api_base', apiInput.value.trim()); location.reload(); };
  const API=(p)=> (localStorage.getItem('api_base')||apiInput.value).replace(/\/$/,'') + p;

  // ---------- helpers ----------
  function esc(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  async function post(path, body){
    const r=await fetch(API(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body)});
    if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
  }
  async function events(type, lead, meta){ try{ await post('/api/v1/events',{type,leadId:lead.id,meta:meta||{}});}catch(e){} }

  // ---------- modal ----------
  const modal=document.getElementById('modal');
  const mTitle=document.getElementById('mTitle');
  const mSrc=document.getElementById('mSrc');
  const mBody=document.getElementById('mBody');
  const mClose=document.getElementById('mClose');
  const mConfirm=document.getElementById('mConfirm');
  let modalLead=null;

  function openModal(lead, whyLines){
    modalLead=lead;
    mTitle.textContent = lead.title || 'Why this lead?';
    const host = (()=>{ try{return new URL(lead.source_url).hostname;}catch{return '';}})();
    mSrc.textContent = `${lead.platform || 'source'} ‚Ä¢ ${host}`;
    mBody.innerHTML = `<ul>${whyLines.map(l=>`<li>${esc(l)}</li>`).join('')}</ul>`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    modalLead=null;
  }
  mClose.onclick=closeModal;
  modal.onclick=(e)=>{ if(e.target===modal) closeModal(); };
  mConfirm.onclick=async()=>{
    if(!modalLead) return;
    await events('confirm_ad', modalLead, { url: modalLead.source_url, platform: modalLead.platform||'adlib_free' });
    closeModal();
    // soft UI nudge
    alert('Saved. We‚Äôll prioritize similar proofs for you.');
  };

  // ---------- find-now ----------
  const vendorDomainEl = document.getElementById('vendorDomain');
  const buyersEl = document.getElementById('buyers');
  const industriesEl = document.getElementById('industries');
  const regionsEl = document.getElementById('regions');
  const runBtn = document.getElementById('runFind');
  const findNote = document.getElementById('findNote');

  runBtn.onclick = async () => {
    findNote.textContent = 'Running‚Ä¶';
    try{
      const buyers = buyersEl.value.split(',').map(s=>s.trim()).filter(Boolean);
      const industries = industriesEl.value.split(',').map(s=>s.trim()).filter(Boolean);
      const regions = regionsEl.value.split(',').map(s=>s.trim()).filter(Boolean);
      const vendorDomain = vendorDomainEl.value.trim() || undefined;
      const body = { buyers, industries, regions, vendorDomain };
      const r = await post('/api/v1/find-now', body);
      findNote.textContent = `checked ${r.checked}, created ${r.created}`;
      await fetchLeads(true);
    }catch(e){
      findNote.textContent = 'Error';
    }
  };

  // ---------- feed ----------
  const elFeed=document.getElementById('feed');
  let lastData=null;
  function card(lead){
    const d=document.createElement('div'); d.className='card';
    const host=(()=>{ try{return new URL(lead.source_url).hostname;}catch{return ''; }})();
    const tags=(lead.kw||[]).slice(0,3).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
    d.innerHTML=`
      <div class="meta">${esc(lead.platform||'source')} ‚Ä¢ ${esc(host)}</div>
      <div><strong>${esc(lead.title||'Untitled')}</strong></div>
      <div>${esc(lead.snippet||'')}</div>
      <div>${tags}</div>
      <div class="btns">
        <button data-a="open" class="primary">Open proof</button>
        <button data-a="why">Why this?</button>
        <button data-a="like">üëç</button>
        <button data-a="dis">üëé</button>
        <button data-a="mute">Mute</button>
        <button data-a="claim">Claim</button>
        <button data-a="own">Own</button>
      </div>
    `;
    const whyLines = buildWhy(lead);
    d.querySelector('[data-a=open]').onclick=()=>{ events('click', lead, {url:lead.source_url}); window.open(lead.source_url,'_blank','noopener'); };
    d.querySelector('[data-a=why]').onclick=()=> openModal(lead, whyLines);
    d.querySelector('[data-a=like]').onclick=()=> events('like', lead);
    d.querySelector('[data-a=dis]').onclick=()=> events('dislike', lead);
    d.querySelector('[data-a=mute]').onclick=()=>{ let h=''; try{h=new URL(lead.source_url).hostname;}catch{} events('mute_domain', lead, {domain:h}); };
    d.querySelector('[data-a=claim]').onclick=()=> claimLead(lead);
    d.querySelector('[data-a=own]').onclick=()=> ownLead(lead);
    return d;
  }

  function buildWhy(lead){
    const p=(lead.platform||'').toLowerCase();
    const host=(()=>{ try{return new URL(lead.source_url).hostname;}catch{return lead.source_url;}})();
    const base = [
      p.includes('adlib') ? `Ad transparency lookup for ${host}` :
      p.includes('brandintake') ? `Supplier / Procurement page discovered on ${host}` :
      p.includes('pdp') ? `Product page shows pack/case/dimensions on ${host}` :
      `Recent activity detected on ${host}`,
      `Freshness heuristic: newer links are ranked higher`,
      `Click "Confirm proof" if this looks like an active buyer for you`
    ];
    return base;
  }

  async function claimLead(lead){
    const r=await post('/api/v1/claim',{leadId:lead.id});
    if(r?.ok){ alert('Reserved for 2 minutes. Click Own to keep it.'); }
  }
  async function ownLead(lead){
    const win=prompt('Enter claim window id (dev demo ‚Äî normally kept in memory):');
    if(!win) return;
    const r=await post('/api/v1/own',{windowId:win});
    if(r?.ok){ alert('Owned'); }
  }

  function render(){
    if(!lastData) return;
    elFeed.innerHTML='';
    // diversify: interleave platforms so we don‚Äôt show same source back-to-back
    const byPlat = {};
    for(const L of lastData.leads){
      const p=(L.platform||'other').toLowerCase();
      (byPlat[p]=byPlat[p]||[]).push(L);
    }
    const order = Object.keys(byPlat).sort(); // stable
    let added=0;
    while(added<lastData.leads.length){
      let progressed=false;
      for(const k of order){
        const arr=byPlat[k]; if(!arr || !arr.length) continue;
        elFeed.appendChild(card(arr.shift())); added++; progressed=true;
      }
      if(!progressed) break; // no more
    }
  }

  async function fetchLeads(force){
    try{
      const r=await fetch(API('/api/v1/leads'), { headers: {'x-galactly-user':uid} });
      const data=await r.json(); lastData=data;
      if(!data?.ok) throw new Error('bad response');
      render();
      document.getElementById('status').textContent='ok';
      if(!force) setTimeout(fetchLeads, (data.nextRefreshSec||15)*1000);
    }catch(e){ document.getElementById('status').textContent='error'; setTimeout(fetchLeads, 5000); }
  }
  fetchLeads(false);
</script>
</body>
</html>
