<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly — Free panel</title>
<link rel="preconnect" href="https://icons.duckduckgo.com">
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel-2:#0e141c; --card:#0f1724;
    --text:#e9f1f7; --muted:#90a7ba; --muted2:#a9bfd1; --divider:#1b2531; --ring:#24435f;
    --chip:#1a2433; --chipActive:#103247;
    --cta:#6de1ff; --ctaText:#082433;
    --ok:#38e08f; --warn:#ffd166; --bad:#ff6b6b;
    --hot:#38e08f; --warm:#ffd166; --cool:#8aa0b2;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  a{color:inherit}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;max-width:1200px;margin:24px auto;padding:0 18px}
  @media (max-width:940px){ .wrap{grid-template-columns:1fr} }

  .card{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:14px}
  .left-advanced{display:none}
  .h{font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin:0 0 8px}
  label{font-size:13px;color:var(--muted2);display:block;margin-bottom:6px}
  input[type=text],input[type=url]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:var(--text);outline:none}
  input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}
  .row{display:flex;gap:8px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 14px;border-radius:12px;border:1px solid var(--divider);background:#152333;color:#cfe0ee;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--cta);border:none;color:var(--ctaText);font-weight:700}
  .btn.badge{padding:6px 10px;font-weight:700}
  .btn.ghost{background:transparent}
  .muted{color:var(--muted)}
  .log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a121b;border:1px solid var(--divider);border-radius:10px;padding:8px;height:120px;overflow:auto;color:#a5bed1}

  /* top bar */
  .top{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:10px 12px;display:flex;align-items:center;gap:10px}
  .fav{width:24px;height:24px;border-radius:6px;overflow:hidden;display:grid;place-items:center;background:#fff;border:1px solid #cfd8e3}
  .fav img{width:24px;height:24px;image-rendering:auto}
  .name{font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0d1a26;color:#8fb0c6;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .pill.good{color:#0d3b23;background:#08301a;border:1px solid #174b2c}
  .sep{flex:1}
  .ghost-gear{background:transparent;border:none;color:#9bb3c6;cursor:pointer}

  /* filters row */
  .filters{display:flex;align-items:center;gap:8px;margin:10px 0 4px}
  .filter-chip{padding:6px 10px;border-radius:999px;border:1px solid var(--divider);background:#122032;cursor:pointer;font-size:13px}
  .filter-chip.on{background:#103247;border-color:#1b4862}
  .filter-chip.hot.on{box-shadow:0 0 0 2px var(--hot) inset}
  .filter-chip.warm.on{box-shadow:0 0 0 2px var(--warm) inset}
  .filter-chip.cool.on{box-shadow:0 0 0 2px var(--cool) inset}

  /* table */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#90a7ba;text-align:left;padding:0 10px}
  tbody td{background:var(--panel-2);border:1px solid var(--divider);padding:12px 10px;vertical-align:top}
  tbody td:first-child{border-radius:12px 0 0 12px}
  tbody td:last-child{border-radius:0 12px 12px 0}
  .score{font-weight:800}
  .band{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--divider);font-weight:700}
  .band.hot{color:var(--hot);border-color:#1d3b2e}
  .band.warm{color:var(--warm);border-color:#483a13}
  .band.cool{color:var(--cool);border-color:#273341}
  .why{max-width:520px}
  .why .chip{display:inline-block;margin:3px 6px 0 0;padding:4px 8px;border-radius:999px;background:#0f1a27;border:1px solid #1f2f41;font-size:12px;color:#cfe0ee}
  .action .btn{padding:6px 10px}

  /* drawer (profile) */
  .drawer{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .drawer.show{display:flex}
  .sheet{
    width:min(980px,92vw); max-height:92vh;
    background:var(--card); border:1px solid var(--divider); border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45);
    overflow:hidden; display:flex;flex-direction:column;
  }
  .sheet-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg,#0f1622,#0e1520);border-bottom:1px solid var(--divider)}
  .sheet-bd{padding:14px;overflow:auto;flex:1}
  .sheet-ft{padding:12px 14px;border-top:1px solid var(--divider);display:flex;justify-content:flex-end;gap:8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipActive);color:#eaf7ff;border-color:#1b4862}
  .slider-row{display:grid;grid-template-columns:1fr 240px;gap:14px;align-items:center;margin:10px 0}
  .one-line{background:#0e1622;border:1px solid var(--divider);border-radius:12px;padding:12px}
  .edit-note{font-size:12px;color:#8fb0c6;cursor:pointer}
  .x{background:transparent;color:#9bb3c6;border:none;font-size:18px;cursor:pointer}
  .gear{background:transparent;border:none;color:#99b4c7;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: connection & log (hidden by default; toggle with gear) -->
  <aside id="leftCol" class="card left-advanced" aria-hidden="true">
    <div class="h">Connection</div>
    <label>API base (root or /api)</label>
    <div class="row">
      <input id="apiBase" type="text" placeholder="https://YOUR-HOST.code.run or …/api">
      <button id="saveApi" class="btn">Save</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="ping" class="btn">Ping</button>
      <button id="clearLog" class="btn">Clear Log</button>
    </div>

    <div class="h" style="margin-top:16px">HTTP Log</div>
    <pre id="httpLog" class="log" aria-live="polite"></pre>
  </aside>

  <!-- RIGHT: main panel -->
  <main>
    <div class="top">
      <span class="fav"><img id="fav" alt="" width="24" height="24" referrerpolicy="no-referrer"></span>
      <span class="name" id="company">yourcompany.com</span>
      <span id="personaPill" class="pill">no profile yet</span>
      <span class="sep"></span>
      <button id="advToggle" class="ghost-gear" title="Advanced (API & logs)">⚙️</button>
      <button id="profileBtn" class="btn">Profile</button>
      <button id="applyAndFindBtn" class="btn">Apply</button>
      <button id="findBtn" class="btn primary">★ Find buyers</button>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="muted" style="margin-bottom:8px">
        Tip: click <b>Profile</b> to review/edit preferences. You can filter by band or export results to CSV.
        <span id="status" style="margin-left:8px"></span>
      </div>

      <div class="filters" aria-label="Band filters">
        <span class="muted" style="margin-right:2px">Show:</span>
        <button class="filter-chip hot on" data-band="HOT">HOT</button>
        <button class="filter-chip warm on" data-band="WARM">WARM</button>
        <button class="filter-chip cool on" data-band="COOL">COOL</button>
        <span class="sep"></span>
        <button id="exportCsv" class="btn badge">Export CSV</button>
      </div>

      <table>
        <thead>
          <tr><th style="width:90px">Score</th><th style="width:110px">Band</th><th>Buyer</th><th>Why</th><th style="width:150px">Action</th></tr>
        </thead>
        <tbody id="rows">
          <!-- results -->
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- PROFILE DRAWER -->
<div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="sheet" role="document">
    <div class="sheet-hd">
      <div class="row">
        <span class="fav"><img id="fav2" alt="" width="24" height="24" referrerpolicy="no-referrer"></span>
        <strong id="company2">yourcompany.com</strong>
      </div>
      <div class="row">
        <button id="gear" class="gear" title="Advanced">⚙️</button>
        <button id="close" class="x" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="sheet-bd">
      <!-- one-liner -->
      <div class="one-line" id="oneLineBox">
        <div id="oneLine">yourcompany.com — supplies packaging for brands in the U.S. Best contacts: Operations, Procurement</div>
        <div class="edit-note" id="editToggle">click to toggle edit</div>
      </div>

      <div class="grid">
        <!-- general preferences -->
        <div class="card" style="padding:12px">
          <div class="h">General preferences</div>
          <div id="genChips" class="chips"></div>
        </div>

        <!-- product signals -->
        <div class="card" style="padding:12px">
          <div class="h">Product signals (from your site)</div>
          <input id="prodInput" type="text" placeholder="add tag and press Enter">
          <div id="prodChips" class="chips"></div>
        </div>
      </div>

      <!-- dynamic buyer priorities -->
      <div class="card" style="padding:12px;margin-top:14px">
        <div class="h">Buyer priorities (dynamic)</div>
        <div id="metricBox"></div>
      </div>

      <!-- targeting -->
      <div class="grid" style="margin-top:14px">
        <div class="card" style="padding:12px">
          <div class="h">Buyer targeting — City</div>
          <input id="cityInput" type="text" placeholder="add city and press Enter">
          <div id="cityChips" class="chips"></div>
          <div class="muted" style="margin-top:6px">boost near</div>
        </div>
        <div class="card" style="padding:12px">
          <div class="h">Buyer targeting — Sectors</div>
          <input id="sectorInput" type="text" placeholder="add sector and press Enter">
          <div id="sectorChips" class="chips"></div>
        </div>
      </div>
    </div>
    <div class="sheet-ft">
      <button id="saveLocal" class="btn">Save locally</button>
      <button id="applyBtn2" class="btn primary">Apply to API</button>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- constants ---------- */
  const HOT_MIN = 80, WARM_MIN = 55;

  /* ---------- storage helpers ---------- */
  function getStored(k, d=""){ try{ const v=localStorage.getItem(k); return v===null? d: v; }catch{ return d; } }
  function setStored(k,v){ try{ localStorage.setItem(k,v); }catch{} }
  function delStored(k){ try{ localStorage.removeItem(k); }catch{} }

  /* ---------- API base (defaults to same-origin /api) ---------- */
  function normalizeApiBase(input){
    let b=(input||"").trim().replace(/\/+$/,"");
    const m=b.match(/^(.*?)(?:\/api(?:\/.*)?)$/i);
    if(m) b = m[1];
    return b ? (b + "/api") : (window.location.origin + "/api");
  }
  const API = {
    get(){ const raw=getStored("apiBase","") || (window.API_BASE||""); return normalizeApiBase(raw); },
    set(v){ setStored("apiBase", v); },
    withKey(init={}){
      const k=getStored("xApiKey","");
      const h=Object.assign({"Content-Type":"application/json"}, init.headers||{});
      if (k) h["x-api-key"]=k;
      return Object.assign({}, init, {headers:h});
    }
  };

  /* ---------- http log ---------- */
  const httpLog = document.getElementById("httpLog");
  function logHttp(line){
    if (!httpLog) return;
    const now = new Date().toISOString().slice(11,19);
    httpLog.textContent = `[${now}] ${line}\n` + (httpLog.textContent||"");
  }
  async function fetchJSON(url, init){
    let r, text;
    try{ r = await fetch(url, API.withKey(init)); }
    catch(e){ logHttp(`ERR ${url} — ${e.message}`); throw e; }
    text = await r.text();
    if (!r.ok){ logHttp(`${r.status} ${url} — ${text.slice(0,160)}`); throw new Error(text||r.statusText); }
    logHttp(`${r.status} ${url}`);
    try{ return JSON.parse(text); }catch{ return text; }
  }

  /* ---------- elements ---------- */
  const leftCol = document.getElementById("leftCol");
  const advToggle = document.getElementById("advToggle");
  const apiBaseInput = document.getElementById("apiBase");
  const saveApiBtn = document.getElementById("saveApi");
  const pingBtn = document.getElementById("ping");
  const clearLogBtn = document.getElementById("clearLog");

  const rows = document.getElementById("rows");
  const profileBtn = document.getElementById("profileBtn");
  const findBtn = document.getElementById("findBtn");
  const applyAndFindBtn = document.getElementById("applyAndFindBtn");
  const exportCsvBtn = document.getElementById("exportCsv");
  const statusEl = document.getElementById("status");

  const drawer = document.getElementById("drawer");
  const closeX = document.getElementById("close");
  const gearBtn = document.getElementById("gear");

  const fav = document.getElementById("fav");
  const fav2 = document.getElementById("fav2");
  const company = document.getElementById("company");
  const company2 = document.getElementById("company2");
  const pill = document.getElementById("personaPill");

  const oneLine = document.getElementById("oneLine");
  const editToggle = document.getElementById("editToggle");
  const genChips = document.getElementById("genChips");
  const prodInput = document.getElementById("prodInput");
  const prodChips = document.getElementById("prodChips");
  const metricBox = document.getElementById("metricBox");
  const cityInput = document.getElementById("cityInput");
  const cityChips = document.getElementById("cityChips");
  const sectorInput = document.getElementById("sectorInput");
  const sectorChips = document.getElementById("sectorChips");
  const saveLocalBtn = document.getElementById("saveLocal");

  /* ---------- utils ---------- */
  function normHost(h){ return (h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,""); }
  function setFav(el, host){
    const h = normHost(host); if(!h){ el.removeAttribute("src"); return; }
    const chain = [
      `https://icons.duckduckgo.com/ip3/${encodeURIComponent(h)}.ico`,
      `https://www.google.com/s2/favicons?domain=${encodeURIComponent(h)}&sz=64`,
      `https://${h}/favicon.ico`
    ];
    let i = 0;
    function tryNext(){
      if (i >= chain.length){ el.removeAttribute("src"); return; }
      el.onerror = tryNext;
      el.src = chain[i++];
    }
    tryNext();
  }
  function openDrawer(){ drawer.classList.add("show"); drawer.setAttribute("aria-hidden","false"); }
  function closeDrawer(){ drawer.classList.remove("show"); drawer.setAttribute("aria-hidden","true"); }

  function chip(label, box, active=false){
    const s=document.createElement("span"); s.className="chip"; s.textContent=label;
    if (active) s.classList.add("active");
    s.addEventListener("click",()=>s.classList.toggle("active"));
    box.appendChild(s); return s;
  }
  function addOnEnter(input, box){
    input.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const v=input.value.trim(); if(!v) return;
        chip(v, box, true); input.value="";
      }
    });
  }
  function getActiveChips(box){ return Array.from(box.querySelectorAll(".chip.active")).map(x=>x.textContent.trim()); }

  function renderMetrics(metrics){
    metricBox.innerHTML="";
    const keep = (metrics||[]).slice(0,3);
    keep.forEach(m=>{
      const row=document.createElement("div"); row.className="slider-row";
      const lab=document.createElement("div"); lab.textContent=m.label || String(m);
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=Number(m.value ?? 8);
      input.addEventListener("input",()=>{ m.value = Number(input.value); });
      row.appendChild(lab); row.appendChild(input);
      metricBox.appendChild(row);
    });
  }
  function defaultMetrics(){
    return [
      {label:"Line automation / fulfillment", value:8},
      {label:"Fast turnaround (≤ 2 weeks)", value:7},
      {label:"Lowest unit cost", value:8}
    ];
  }

  function classifyScore(score){
    const s = Number(score||0);
    if (s >= HOT_MIN) return "HOT";
    if (s >= WARM_MIN) return "WARM";
    return "COOL";
  }

  /* ---------- persona render/collect ---------- */
  const state = { persona:null, results:[], activeBands:new Set(["HOT","WARM","COOL"]) };

  function renderPersona(p){
    state.persona = p || {};
    const host = p.host || p.line?.host || "yourcompany.com";
    company.textContent = host; company2.textContent = host;
    setFav(fav, host); setFav(fav2, host);
    pill.textContent = p && Object.keys(p).length ? "persona ready" : "no profile yet";
    pill.classList.toggle("good", !!p && Object.keys(p).length>0);

    // one-liner
    if (p.line && p.line.host){
      const L = p.line;
      oneLine.textContent = `${L.host} — ${L.verb||"supplies"} ${L.products||"packaging"} for ${L.audience||"brands"} in ${L.region||"the U.S."}. Best contacts: ${L.contacts||"Operations, Procurement"}`;
    }else if (p.lineText){ oneLine.textContent = p.lineText; }

    // general
    genChips.innerHTML="";
    const gen = p.general || {};
    [
      ["Prefer mid-size companies", !!gen.mids],
      ["De-prioritize giant enterprises", !!gen.avoidBig],
      ["Prioritize nearby buyers", !!gen.near],
      ["Prefer e-commerce sites", !!gen.ecom],
      ["Prefer wholesalers / distributors", !!gen.wholesale],
      ["Prefer retail brands", !!gen.retail]
    ].forEach(([lab, on])=> chip(lab, genChips, on));

    // products
    prodChips.innerHTML="";
    (p.productTags||[]).forEach(t=> chip(t, prodChips, true));

    // metrics
    renderMetrics((Array.isArray(p.metrics)&&p.metrics.length) ? p.metrics : defaultMetrics());

    // targeting
    cityChips.innerHTML=""; (p.targeting?.cities?.length ? p.targeting.cities : (p.targeting?.city? [p.targeting.city] : [])).forEach(c=>chip(c,cityChips,true));
    sectorChips.innerHTML=""; (p.sectorHints||[]).forEach(s=>chip(s,sectorChips,true));
  }

  function collectPersona(){
    const host = company.textContent.trim();
    const p = state.persona || {};
    const lineText = oneLine.textContent.trim();
    return {
      host,
      line: p.line || {host, verb:"supplies", products:"packaging", audience:"brands", region:"the U.S.", contacts:"Operations, Procurement"},
      lineText,
      productTags: getActiveChips(prodChips),
      sectorHints: getActiveChips(sectorChips),
      general: {
        mids: genChips.textContent.includes("Prefer mid-size"),
        avoidBig: genChips.textContent.includes("De-prioritize"),
        near: genChips.textContent.includes("Prioritize nearby"),
        ecom: genChips.textContent.includes("Prefer e-commerce"),
        wholesale: genChips.textContent.includes("Prefer wholesalers"),
        retail: genChips.textContent.includes("Prefer retail")
      },
      metrics: (state.persona?.metrics?.length ? state.persona.metrics : defaultMetrics()),
      targeting: { cities: getActiveChips(cityChips), city: getActiveChips(cityChips)[0]||"" }
    };
  }

  /* ---------- apply & find ---------- */
  async function applyPrefs(){
    const base = API.get();
    const payload = collectPersona();
    try{
      await fetchJSON(base + "/prefs/upsert", {method:"POST", body: JSON.stringify(payload)});
      pill.textContent = "profile applied"; pill.classList.add("good");
    }catch(e){
      logHttp("Apply failed (offline?): " + (e.message||e));
      pill.textContent = "saved locally (offline)"; pill.classList.add("good");
    }
  }

  function reasonsToChips(cell, reasons){
    cell.textContent = "";
    const list = Array.isArray(reasons) ? reasons : String(reasons||"-").split(/[,•]+/);
    for (const r of list.slice(0,12)){
      const s = document.createElement("span");
      s.className = "chip"; s.textContent = String(r).trim();
      cell.appendChild(s);
    }
    cell.title = "Click to copy reasons";
    cell.style.cursor = "copy";
    cell.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(list.join(", "));
        const old = cell.title; cell.title = "Copied!";
        setTimeout(()=> cell.title = old, 1000);
      }catch{}
    });
  }

  function bandBadge(band){
    const span = document.createElement("span");
    span.className = "band " + band.toLowerCase();
    span.textContent = band;
    return span;
  }

  function renderRows(items){
    rows.innerHTML = "";
    const active = state.activeBands;
    const visible = items.filter(it => active.has((it.band||classifyScore(it.score)).toUpperCase()));
    for (const it of visible){
      const tr = document.createElement("tr");

      // Score
      const tdScore = document.createElement("td");
      tdScore.className = "score";
      tdScore.textContent = (it.score ?? "-");
      tr.appendChild(tdScore);

      // Band
      const tdBand = document.createElement("td");
      const band = (it.band || classifyScore(it.score)).toUpperCase();
      tdBand.appendChild(bandBadge(band));
      tr.appendChild(tdBand);

      // Buyer name
      const tdBuyer = document.createElement("td");
      tdBuyer.textContent = it.name || it.company || it.host || "-";
      tr.appendChild(tdBuyer);

      // Why / reasons
      const tdWhy = document.createElement("td");
      tdWhy.className = "why";
      reasonsToChips(tdWhy, it.reasons || it.why || it.reason || []);
      tr.appendChild(tdWhy);

      // Action
      const tdAct = document.createElement("td");
      tdAct.className = "action";
      const open = document.createElement("button");
      open.className = "btn";
      open.textContent = "Open";
      open.addEventListener("click",()=> window.open(it.url || ("https://" + (it.host||"")), "_blank"));
      tdAct.appendChild(open);
      tr.appendChild(tdAct);

      rows.appendChild(tr);
    }
    statusEl.textContent = `Showing ${visible.length}${visible.length !== items.length ? " of "+items.length : ""}`;
  }

  function toCSV(items){
    const head = ["score","band","name","host","url","reasons"];
    const lines = [head.join(",")];
    for (const it of items){
      const band = (it.band || classifyScore(it.score)).toUpperCase();
      const name = (it.name || it.company || "").replace(/"/g,'""');
      const host = (it.host || "").replace(/"/g,'""');
      const url = (it.url || ("https://" + host)).replace(/"/g,'""');
      const reasons = Array.isArray(it.reasons) ? it.reasons.join(" | ") : (it.why || "");
      const row = [it.score||"", band, `"${name}"`, `"${host}"`, `"${url}"`, `"${reasons.replace(/"/g,'""')}"`];
      lines.push(row.join(","));
    }
    return lines.join("\n");
  }

  function offlineMockLeads(p, n){
    const tags = (p.productTags||["packaging"]).slice(0,2).join(", ");
    const sects = (p.sectorHints||["brands"]).slice(0,2).join(", ");
    const city = p.targeting?.city || (p.targeting?.cities?.[0]) || "";
    const names = ["Acme Brands","Nimbus Co","Vertex Retail","Kestrel Foods","Aurora Labs","Peak Logistics","BlueFox Cosmetics","NorthStar Pharma"];
    return Array.from({length:n}).map((_,i)=>({
      score: 78 - (i*5)%24,
      band: undefined,
      name: names[i%names.length],
      why: `Matches ${tags}${sects? " • Sectors: "+sects:""}${city? " • Near "+city:""}`,
      host: `buyer${i+1}.example.com`,
      url: "https://example.com"
    }));
  }

  async function findBuyers(){
    rows.innerHTML="";
    statusEl.textContent = "Finding…";
    const base = API.get();
    const p = collectPersona();
    const q = new URLSearchParams({
      host: p.host || company.textContent.trim(),
      limit: String(24),
      city: p.targeting.city||"",
      sectors: (p.sectorHints||[]).join(","),
      tags: (p.productTags||[]).join(",")
    }).toString();

    const paths = ["/leads/find-buyers", "/buyers/find", "/buyers/search", "/find"];
    let data=null;
    for (const path of paths){
      try{
        data = await fetchJSON(base + path + "?" + q, {method:"GET"});
        if (data) break;
      }catch(e){ /* try next */ }
    }

    const list = data
      ? (Array.isArray(data)? data : (data.items||data.results||[]))
      : offlineMockLeads(p, 12);

    state.results = list;
    renderRows(list);
  }

  /* ---------- events ---------- */
  document.getElementById("advToggle").addEventListener("click",()=>{
    const show = leftCol.style.display !== "block";
    leftCol.style.display = show ? "block" : "none";
    leftCol.setAttribute("aria-hidden", show ? "false" : "true");
  });
  saveApiBtn?.addEventListener("click",()=>{
    const normalized = normalizeApiBase(apiBaseInput.value);
    API.set(apiBaseInput.value); // keep original; normalize when reading
    logHttp("API base set to " + normalized.replace(/\/api$/,''));
  });
  pingBtn?.addEventListener("click", async ()=>{
    try{ const base = API.get(); await fetchJSON(base + "/ping", {method:"GET"}); }catch(e){}
  });
  clearLogBtn?.addEventListener("click", ()=> { if (httpLog) httpLog.textContent=""; });

  profileBtn.addEventListener("click", openDrawer);
  closeX.addEventListener("click", closeDrawer);
  drawer.addEventListener("click", (e)=>{ if (e.target === drawer) closeDrawer(); });
  window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeDrawer(); });

  document.getElementById("applyBtn2").addEventListener("click", async ()=>{
    await applyPrefs();
  });
  applyAndFindBtn.addEventListener("click", async ()=>{
    await applyPrefs();
    await findBuyers();
  });
  findBtn.addEventListener("click", findBuyers);
  editToggle.addEventListener("click", ()=> {
    const ed = oneLine.isContentEditable;
    oneLine.contentEditable = !ed;
    oneLine.style.outline = ed? "none" : "2px solid var(--ring)";
  });
  saveLocalBtn.addEventListener("click", ()=> {
    const p = collectPersona();
    setStored("fp.persona", JSON.stringify(p));
    pill.textContent = "saved locally";
    logHttp("persona saved locally");
  });
  exportCsvBtn.addEventListener("click", ()=>{
    const csv = toCSV(state.results || []);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "buyers.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Band filters
  Array.from(document.querySelectorAll(".filter-chip")).forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const band = btn.getAttribute("data-band");
      btn.classList.toggle("on");
      if (btn.classList.contains("on")) state.activeBands.add(band);
      else state.activeBands.delete(band);
      renderRows(state.results||[]);
    });
  });

  addOnEnter(prodInput, prodChips);
  addOnEnter(cityInput, cityChips);
  addOnEnter(sectorInput, sectorChips);

  /* ---------- hydrate persona (API first, then Step 3, then blank) ---------- */
  async function hydratePersona(){
    const host = getStored("fp.supplier.host","yourcompany.com");
    company.textContent = host; company2.textContent = host; setFav(fav, host); setFav(fav2, host);
    const base = API.get();

    // 1) Try API persona
    try{
      const got = await fetchJSON(base + "/prefs/get?host=" + encodeURIComponent(host), {method:"GET"});
      if (got && (got.host || got.lineText || got.productTags)){
        renderPersona(got);
        pill.textContent = "persona (from API)"; pill.classList.add("good");
        return;
      }
    }catch(e){ /* ok offline */ }

    // 2) Step 3 persona
    let p = null; try{ p = JSON.parse(getStored("fp.persona","")); }catch{}
    if (p){ renderPersona(p); pill.textContent="persona (local)"; pill.classList.add("good"); }
    else { renderPersona({ host, productTags:[], sectorHints:[], metrics: defaultMetrics(), targeting:{cities:[]} }); }

    // Auto-apply once if Step 3 flagged it
    if (getStored("fp.autoImport","") === "1" && p){
      try{ await applyPrefs(); }catch{} finally{ delStored("fp.autoImport"); }
    }
  }

  /* ---------- boot ---------- */
  (async function init(){
    if (apiBaseInput) apiBaseInput.value = (getStored("apiBase","") || "").replace(/\/+$/,"");
    await hydratePersona();
  })();
})();
</script>
</body>
</html>