<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Free Panel</title>
  <style>
    :root{--bg:#0b0e13;--fg:#e8ecf1;--sub:#a6b3c4;--card:#101624;--stroke:#1f2a3b;--ok:#34d399;--warn:#fbbf24;--bad:#f87171;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    header{padding:14px 18px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:10px}
    header .brand{font-weight:800}
    header .pill{margin-left:auto;color:var(--sub);font-size:12px}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .meta{font-size:12px;color:var(--sub);display:flex;justify-content:space-between}
    .title{font-weight:700}
    .bar{height:8px;border-radius:999px;background:#0b1220;border:1px solid #243048;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#1f7ae0,#34d399)}
    .cta{display:flex;gap:8px}
    button{background:#162135;border:1px solid #263247;color:var(--fg);border-radius:10px;padding:9px 12px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .hold{user-select:none;-webkit-user-select:none;background:#0f172a;border:1px dashed #334155;border-radius:12px;padding:10px;text-align:center;color:#d1eaff}
    .hint{font-size:12px;color:var(--sub)}

    /* Reveal modal */
    .modal{position:fixed;inset:0;background:rgba(7,10,14,.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .sheet{width:min(760px,100%);background:#0e1520;border:1px solid var(--stroke);border-radius:16px;overflow:hidden}
    .sheet header{display:flex;gap:10px;align-items:center;padding:12px 16px;background:#0c1320;border-bottom:1px solid var(--stroke)}
    .sheet .body{padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .k{font-size:12px;color:#9fb3c8}
    .v{font-weight:700}
    .why{margin:6px 0 0 18px;color:#cfe2ff}
  </style>
  <script defer src="api-base.js"></script>
</head>
<body>
  <header>
    <div class="brand">Galactly — Free Panel</div>
    <div class="pill">API: <span id="apiTxt">…</span></div>
  </header>
  <div class="wrap">
    <p class="hint">Tip: press & hold a card to reveal details. Free plan allows <span id="capTxt"></span> deep reveals per day.</p>
    <div id="feed" class="grid"></div>
  </div>

  <!-- Reveal Modal -->
  <div id="reveal" class="modal">
    <div class="sheet">
      <header>
        <div style="font-weight:800" id="rv-title">Lead</div>
        <div style="margin-left:auto"><button id="rv-close">Close</button></div>
      </header>
      <div class="body">
        <div class="row">
          <div><span class="k">Confidence</span><div class="bar" style="width:220px"><i id="rv-heat" style="width:0%"></i></div></div>
          <div><span class="k">Source</span> <span class="v" id="rv-src">—</span></div>
        </div>
        <div class="row"><div><span class="k">Why this lead</span><ul id="rv-why" class="why"></ul></div></div>
        <div class="row">
          <button id="rv-proof">Open proof link</button>
          <button id="rv-claim" class="">Claim & Own</button>
        </div>
        <p class="hint" id="rv-note"></p>
      </div>
    </div>
  </div>

<script>
  const FREE_DAILY_REVEALS = 2; // tweakable
  const uidKey='galactly_uid'; let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
  const apiTxt=document.getElementById('apiTxt'); apiTxt.textContent=(window.API_BASE||'').replace(/^https?:\/\//,'');
  document.getElementById('capTxt').textContent = FREE_DAILY_REVEALS;

  const LKEY = () => 'reveals_'+new Date().toISOString().slice(0,10);
  function revealsUsed(){ return Number(localStorage.getItem(LKEY())||'0'); }
  function addReveal(){ const k=LKEY(); localStorage.setItem(k, String(revealsUsed()+1)); }
  function capReached(){ return revealsUsed() >= FREE_DAILY_REVEALS; }

  const feedEl=document.getElementById('feed');
  let leads=[];

  // Round-robin interleave by platform to avoid back-to-back sameness
  function interleaveByPlatform(arr){
    const buckets={}; arr.forEach(o=>{ const p=(o.platform||'misc').toLowerCase(); (buckets[p]||(buckets[p]=[])).push(o); });
    const keys=Object.keys(buckets).sort(); const out=[]; let added=true;
    while(added){ added=false; for(const k of keys){ const b=buckets[k]; if(b && b.length){ out.push(b.shift()); added=true; } } }
    return out;
  }

  function brandFrom(lead){
    const t=(lead.title||'').trim();
    if(t && t.length>3) return t.length>68? t.slice(0,65)+'…' : t;
    try { const h=new URL(lead.source_url).hostname; return h.replace(/^www\./,''); } catch { return '—'; }
  }

  function platformLabel(p){ p=(p||'').toLowerCase(); if(p.includes('pdp')) return 'Product'; if(p.includes('brandintake')) return 'Procurement'; if(p.includes('adlib')) return 'Ads'; return 'Signal'; }

  function card(lead){
    const d=document.createElement('div'); d.className='card';
    const heat = Math.max(0, Math.min(100, Number(lead.heat||0)));
    d.innerHTML = `
      <div class="meta"><span>${platformLabel(lead.platform)}</span><span class="hint">created ${new Date(lead.created_at||Date.now()).toLocaleString()}</span></div>
      <div class="title">${escapeHtml(brandFrom(lead))}</div>
      <div class="bar"><i style="width:${heat}%"></i></div>
      <div class="hold" data-action="reveal">Press & hold to reveal</div>
      <div class="cta"><button data-action="own">Claim & Own</button></div>
    `;

    // Hold-to-reveal
    const hold = d.querySelector('[data-action=reveal]');
    let t0=null, timer=null;
    const start=(ev)=>{ ev.preventDefault(); if(capReached()){ hold.textContent='Daily reveal cap reached — upgrade to unlock'; return; } t0=Date.now(); hold.textContent='Keep holding…'; timer=setTimeout(()=>{ reveal(lead); addReveal(); hold.textContent='Revealed ✓'; }, 800); };
    const cancel=()=>{ if(timer){ clearTimeout(timer); timer=null; hold.textContent='Press & hold to reveal'; } };
    ['pointerdown','touchstart','mousedown'].forEach(e=>hold.addEventListener(e,start,{passive:false}));
    ['pointerup','pointerleave','touchend','touchcancel','mouseup','mouseleave'].forEach(e=>hold.addEventListener(e,cancel));

    // Claim & own (one button)
    d.querySelector('[data-action=own]').onclick=()=> claimAndOwn(lead);
    return d;
  }

  async function claimAndOwn(lead){
    try{
      const r1 = await fetch('/api/v1/claim',{method:'POST',headers:{'content-type':'application/json','x-galactly-user':uid},body:JSON.stringify({leadId:lead.id})}).then(r=>r.json());
      if(!r1?.ok) return alert('Not available');
      const r2 = await fetch('/api/v1/own',{method:'POST',headers:{'content-type':'application/json','x-galactly-user':uid},body:JSON.stringify({windowId:r1.windowId})}).then(r=>r.json());
      if(r2?.ok) alert('Owned ✓');
    }catch(e){ console.error(e); }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  async function load(){
    try{
      const data = await fetch('/api/v1/leads', { headers:{'x-galactly-user':uid} }).then(r=>r.json());
      let arr = Array.isArray(data?.leads)?data.leads:[];
      // de-duplicate by source_url just in case
      const seen=new Set(); arr = arr.filter(x=>{ if(seen.has(x.source_url)) return false; seen.add(x.source_url); return true; });
      arr = interleaveByPlatform(arr).slice(0,12);
      leads = arr;
      feedEl.innerHTML='';
      for(const L of arr) feedEl.appendChild(card(L));
    }catch(e){ feedEl.innerHTML='<div class="hint">Failed to load. Check API base.</div>'; }
  }

  // Reveal modal population
  const modal = document.getElementById('reveal');
  const rvTitle = document.getElementById('rv-title');
  const rvWhy = document.getElementById('rv-why');
  const rvHeat = document.getElementById('rv-heat');
  const rvSrc = document.getElementById('rv-src');
  const rvNote = document.getElementById('rv-note');
  const rvProofBtn = document.getElementById('rv-proof');
  const rvClose = document.getElementById('rv-close');
  rvClose.onclick=()=>modal.classList.remove('open');

  function inferWhy(lead){
    const txt = `${(lead.title||'')} ${(lead.snippet||'')}`.toLowerCase();
    const why = [];
    if((lead.platform||'').includes('adlib')) why.push('Active ad presence (verify via proof link)');
    if((lead.platform||'').includes('brandintake')) why.push('Supplier / procurement entrypoint on site');
    if((lead.platform||'').includes('pdp')) why.push('Product detail signals (case/pack/dimensions/restock)');
    if(/rfq|rfi|vendor|supplier|procure/.test(txt)) why.push('Explicit sourcing/registration language');
    if(/case|pack|carton|labels|corrugated/.test(txt)) why.push('Pack size or material hint');
    return why.length? why : ['Relevant demand signal on site'];
  }

  function reveal(lead){
    rvTitle.textContent = brandFrom(lead);
    rvHeat.style.width = Math.max(0,Math.min(100, Number(lead.heat||0)))+'%';
    rvSrc.textContent = platformLabel(lead.platform);
    rvWhy.innerHTML = '';
    for(const r of inferWhy(lead)){
      const li=document.createElement('li'); li.textContent=r; rvWhy.appendChild(li);
    }
    rvNote.textContent = capReached()? 'Daily cap reached. Upgrade to unlock more reveals.' : '';

    // proof button (kept out of card for minimal UI)
    rvProofBtn.onclick = ()=>{
      try{ window.open(lead.source_url,'_blank','noopener'); }catch(e){}
      // optional feedback ping
      fetch('/api/v1/events',{method:'POST',headers:{'content-type':'application/json','x-galactly-user':uid},body:JSON.stringify({type:'confirm_ad',leadId:lead.id,meta:{url:lead.source_url,platform:lead.platform}})}).catch(()=>{});
    };

    modal.classList.add('open');
  }

  // poll
  load();
  setInterval(load, 15000);
</script>
</body>
</html>
