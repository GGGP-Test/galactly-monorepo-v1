<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Leads Console — Free Panel (V3)</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--ok:#10b981;--err:#ef4444}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:flex;gap:18px}
    .col{flex:1 1 50%;background:var(--panel);border:1px solid #1f2937;border-radius:10px;padding:16px}
    h1{font-size:18px;margin:0 0 12px}
    label{font-size:12px;color:var(--muted);display:block;margin:12px 0 6px}
    input,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    button{padding:10px 14px;border:0;border-radius:8px;background:#1f2937;color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);color:#081018;font-weight:600}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{padding:6px 10px;border:1px solid #1f2937;background:#0b1220;border-radius:999px;font-size:12px;color:#cbd5e1}
    .tiny{font-size:11px;color:#9ca3af}
    .msg{margin-top:10px;font-size:12px;padding:8px 10px;border-radius:8px;border:1px solid #263244}
    .msg.ok{border-color:#064e3b;color:#a7f3d0}.msg.err{border-color:#3f1d1d;color:#fecaca}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #1f2937;text-align:left;padding:10px 8px;font-size:13px;vertical-align:top}
    th{color:#cbd5e1;font-weight:600;background:#0b1322;position:sticky;top:0}
    #debug{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px;max-height:180px;overflow:auto;margin-top:8px;font-size:12px;color:#cbd5e1}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Controls -->
    <div class="col">
      <h1>Leads Console — Free Panel (V3)</h1>

      <label>API base</label>
      <div class="row">
        <input id="apiBase" placeholder="https://your-app.code.run"/>
        <button id="apply" class="primary">Apply</button>
      </div>

      <label>API key (optional for read; required for write)</label>
      <div class="row">
        <input id="apiKey" placeholder="x-api-key value (optional)"/>
        <button id="saveKey">Save</button>
      </div>

      <div class="toolbar">
        <button id="refreshHot">Refresh Hot</button>
        <button id="refreshWarm">Refresh Warm</button>
        <span class="pill">API root: <code>/api/v1</code></span>
      </div>

      <div id="status" class="msg" style="display:none"></div>

      <hr style="border:0;border-top:1px solid #1f2937;margin:14px 0"/>

      <label>Action</label>
      <div class="pill">Find buyers (one per click)</div>

      <label>Supplier host</label>
      <input id="supplierHost" placeholder="e.g. peekpackaging.com"/>

      <div class="row">
        <select id="country">
          <option value="US/CA">US/CA</option>
          <option value="US">US</option>
          <option value="CA">CA</option>
          <option value="">Any</option>
        </select>
        <select id="radiusMi">
          <option value="25">25 mi</option>
          <option value="50" selected>50 mi</option>
          <option value="100">100 mi</option>
          <option value="200">200 mi</option>
        </select>
      </div>

      <label>Find Buyers path (relative to API root)</label>
      <div class="row">
        <input id="findPath" value="/leads/find-buyers" />
        <select id="findVerb" style="max-width:140px">
          <option value="AUTO" selected>AUTO</option>
          <option value="GET">GET</option>
          <option value="POST">POST</option>
        </select>
        <button id="find" class="primary">Find buyers</button>
      </div>
      <div class="row" style="margin-top:6px">
        <label style="display:flex;align-items:center;gap:8px">
          <input id="useFallbacks" type="checkbox" checked style="width:auto"/> Try fallbacks if 404
        </label>
      </div>

      <div id="findMsg" class="msg" style="display:none"></div>
      <div id="debug" hidden></div>

      <label style="margin-top:14px">Supplier persona (used to infer intent)</label>
      <input id="p_offer"  placeholder="Product/offer (e.g. Stretch film & pallet protection)"/>
      <input id="p_solves" placeholder="Solves (e.g. Keeps pallets secure for storage/transport)"/>
      <input id="p_titles" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing"/>
      <div class="row">
        <button id="personaSave">Save persona (local)</button>
        <button id="dlHot">Download CSV (hot)</button>
        <button id="dlWarm">Download CSV (warm)</button>
      </div>
      <p class="tiny">Editing persona won’t clear your list.</p>
    </div>

    <!-- Results -->
    <div class="col">
      <div class="toolbar" style="justify-content:space-between">
        <span class="pill">Results</span>
        <span class="tiny" id="resultCount">0 items</span>
      </div>
      <div id="tableWrap" style="max-height:60vh;overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Host</th><th>Platform</th><th>Title</th>
              <th>Created</th><th>Temp</th><th>Why (human-readable)</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const show = (el, on=true)=>{ el.style.display = on ? '' : 'none'; };
    const toast = (msg, ok=false)=>{ const el=$('status'); el.classList.remove('ok','err'); el.classList.add(ok?'ok':'err'); el.textContent=msg; show(el,true); };
    const setFindMsg = (msg, ok=false)=>{ const el=$('findMsg'); el.classList.remove('ok','err'); el.classList.add(ok?'ok':'err'); el.textContent=msg; show(el, !!msg); };
    const log = (s)=>{ const d=$('debug'); d.hidden=false; d.textContent += s + "\n"; d.scrollTop = d.scrollHeight; };

    const S = { root:'/api/v1', items:[], persona:{} };
    const base = ()=> ($('apiBase').value||'').trim().replace(/\/+$/,'');
    const key  = ()=> ($('apiKey').value||'').trim();

    function saveLocal(){
      localStorage.setItem('base', base());
      localStorage.setItem('apiKey', key());
      localStorage.setItem('persona', JSON.stringify(S.persona||{}));
      localStorage.setItem('findPath', $('findPath').value||'');
      localStorage.setItem('findVerb', $('findVerb').value||'AUTO');
      localStorage.setItem('useFallbacks', $('useFallbacks').checked?'1':'0');
    }
    function loadLocal(){
      const b=localStorage.getItem('base'); if(b) $('apiBase').value=b;
      const k=localStorage.getItem('apiKey'); if(k) $('apiKey').value=k;
      const fp=localStorage.getItem('findPath'); if(fp) $('findPath').value=fp;
      const fv=localStorage.getItem('findVerb'); if(fv) $('findVerb').value=fv;
      $('useFallbacks').checked = localStorage.getItem('useFallbacks')!=='0';
      try{ S.persona = JSON.parse(localStorage.getItem('persona')||'{}'); }catch{ S.persona={}; }
      $('p_offer').value=S.persona.offer||''; $('p_solves').value=S.persona.solves||''; $('p_titles').value=S.persona.titles||'';
    }

    async function http(method, path, {query=null, body=null}={}){
      const b=base();
      if(!b) return { ok:false, status:0, data:{ ok:false, error:'No API base set' }, url:path, method };
      const full = path.startsWith('http') ? path : b + (path.startsWith('/')?path:'/'+path);
      const url = new URL(full);
      if(query) Object.entries(query).forEach(([k,v])=> v!=null && v!=='' && url.searchParams.set(k, String(v)));
      const headers={ 'Accept':'application/json' };
      if(body!=null) headers['Content-Type']='application/json';
      if(key()) headers['x-api-key']=key();
      let res, txt;
      try{ res=await fetch(url.toString(), { method, headers, body: body!=null?JSON.stringify(body):undefined }); }
      catch(e){ return { ok:false, status:0, data:{ ok:false, error:String(e) }, url:url.toString(), method }; }
      try{ txt = await res.text(); }catch{ txt=''; }
      let data; try{ data = txt ? JSON.parse(txt) : null; } catch{ data = txt; }
      return { ok:res.ok, status:res.status, data, url:url.toString(), method, headers: Object.fromEntries(res.headers.entries()||[]) };
    }

    function normalizeItem(x){
      return {
        host: x?.host || x?.domain || x?.source || '',
        platform: x?.platform || x?.type || '',
        title: x?.title || x?.name || '',
        created: x?.created || x?.createdAt || x?.ts || '',
        temp: x?.temp || x?.temperature || x?.score || '',
        why: x?.why || x?.whyText || x?.reason || x?.summary || ''
      };
    }
    function renderList(){
      const tb=$('listBody'); tb.innerHTML='';
      (S.items||[]).forEach((it,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td><td>${it.host||''}</td><td>${it.platform||''}</td>
          <td>${it.title||''}</td><td>${it.created||''}</td>
          <td>${it.temp||''}</td><td>${it.why||''}</td>`;
        tb.appendChild(tr);
      });
      $('resultCount').textContent = `${S.items.length} item${S.items.length===1?'':'s'}`;
    }
    function toCSV(items){
      const cols=['host','platform','title','created','temp','why'];
      const esc=v=>`${String(v??'').replaceAll('"','""')}`;
      const head=cols.join(',');
      const rows=(items||[]).map(r=>cols.map(c=>`"${esc(r[c])}"`).join(','));
      return [head,...rows].join('\r\n');
    }
    function download(name,text){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([text],{type:'text/csv'}));
      a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
    }

    function buildCandidates(pathPref, verbPref, useFallbacks, params){
      const P = [];
      const q = { host: params.host, country: params.country, radius: params.radius };
      const b = { host: params.host, country: params.country, radius: params.radius };

      const add = (m,p,qmode)=>
        P.push({ m, p, qmode, args: qmode==='query' ? { query:q } : { body:b } });

      const want = (m)=> verbPref==='AUTO' || verbPref===m;

      // user-specified first
      const clean = (pathPref||'/leads/find-buyers').replace(/^\s*/,'').replace(/\s*$/,'');
      if (want('GET'))  add('GET',  S.root + (clean.startsWith('/')?clean:'/'.concat(clean)), 'query');
      if (want('POST')) add('POST', S.root + (clean.startsWith('/')?clean:'/'.concat(clean)), 'body');

      if (!useFallbacks) return P;

      // smart fallbacks
      const guesses = [
        '/leads/find-buyers','/leads/find','/buyers/find','/find-buyers','/leads',
        '/buyers','/find','/leads/one','/leads/find-one','/buyers/find-one'
      ];
      for (const g of guesses){
        if (want('GET'))  add('GET',  S.root + g, 'query');
        if (want('POST')) add('POST', S.root + g, 'body');
        // also try without /api/v1 in case server is mounted at root
        if (want('GET'))  add('GET',  g, 'query');
        if (want('POST')) add('POST', g, 'body');
      }
      return P;
    }

    async function onFind(){
      $('debug').hidden=true; $('debug').textContent='';
      setFindMsg('');
      const host=($('supplierHost').value||'').trim();
      if(!host) return setFindMsg('Enter supplier host');
      const country=$('country').value;
      const radius=$('radiusMi').value;
      const pathPref=$('findPath').value;
      const verbPref=$('findVerb').value;
      const useFallbacks=$('useFallbacks').checked;

      const btn=$('find'); btn.disabled=true;

      const candidates = buildCandidates(pathPref, verbPref, useFallbacks, {host,country,radius});
      let last=null;
      for (const c of candidates){
        log(`→ ${c.m} ${c.p}`);
        const r = await http(c.m, c.p, c.args);
        last = r;
        log(`  ← ${r.status} ${r.ok?'OK':'ERR'}  ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}`);
        if (r.ok && r.data){
          const items = (r.data && r.data.items) || [];
          const seen = new Set((S.items||[]).map(x=>`${x.host}::${x.title}`));
          items.forEach(raw=>{
            const it=normalizeItem(raw);
            const k=`${it.host}::${it.title}`;
            if(!seen.has(k)){ seen.add(k); S.items.unshift(it); }
          });
          renderList();
          setFindMsg(`Loaded ${items.length} new item(s).`, true);
          btn.disabled=false;
          return;
        }
        if (r.status===401 || r.status===403){ break; } // don't spam after auth issues
      }
      btn.disabled=false;
      const text = typeof last?.data==='string' ? last.data : JSON.stringify(last?.data);
      setFindMsg(`HTTP ${last?.status ?? 0} — ${text || 'not found'}`);
    }

    function bind(){
      loadLocal();

      $('apply').onclick=()=>{ const b=base(); toast(b?`Base set: ${b}`:'Base cleared', !!b); saveLocal(); };
      $('saveKey').onclick=()=>{ toast(key()? 'API key saved':'API key cleared', !!key()); saveLocal(); };
      $('personaSave').onclick=()=>{ S.persona={ offer:$('p_offer').value.trim(), solves:$('p_solves').value.trim(), titles:$('p_titles').value.trim() }; saveLocal(); toast('Persona saved locally', true); };
      $('dlHot').onclick = ()=> download('leads_hot.csv',  toCSV(S.items.filter(x=>String(x.temp||'').toLowerCase()==='hot')));
      $('dlWarm').onclick= ()=> download('leads_warm.csv', toCSV(S.items.filter(x=>String(x.temp||'').toLowerCase().includes('warm'))));
      $('refreshHot').onclick = ()=> toast('Hot refresh is view-only in free panel');
      $('refreshWarm').onclick= ()=> toast('Warm refresh is view-only in free panel');

      $('find').onclick=(e)=>{ e.preventDefault(); onFind(); };

      // Query-string overrides
      try{
        const u=new URL(location.href);
        const b=u.searchParams.get('base'); if(b){ $('apiBase').value=b; }
        const k=u.searchParams.get('key'); if(k){ $('apiKey').value=k; }
        const h=u.searchParams.get('host'); if(h){ $('supplierHost').value=h; }
        const p=u.searchParams.get('path'); if(p){ $('findPath').value=p; }
        const m=u.searchParams.get('verb'); if(m){ $('findVerb').value=(m.toUpperCase()); }
        if (b||k||p||m) saveLocal();
      }catch{}

      renderList();
    }
    document.addEventListener('DOMContentLoaded', bind);
  })();
  </script>
</body>
</html>