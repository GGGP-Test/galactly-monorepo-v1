<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Free Panel</title>
  <style>
    :root{
      --bg:#0b0e13; --panel:#0f1420; --ink:#e8ecf1; --mut:#a8b1c4; --line:#1e2430; --hl:#86f7d6; --hl2:#57a4ff;
      --ok:#77e39e; --warn:#ffd166; --bad:#ff7b7b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1100px 700px at 85% -10%,rgba(120,160,255,.10),transparent 60%),
                       radial-gradient(800px 500px at 15% 110%,rgba(120,200,255,.06),transparent 60%),
                       linear-gradient(180deg,#0b0e13,#0a0d15 55%);
         color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;}
    header{position:sticky;top:0;z-index:40;backdrop-filter:blur(10px) saturate(1.05);background:rgba(10,14,22,.55);border-bottom:1px solid var(--line);}
    .nav{max-width:1240px;margin:auto;padding:10px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:8px;color:#fff;text-decoration:none}
    .brand svg{width:22px;height:22px}
    .brand b{font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;opacity:.9}
    .api{margin-left:auto;display:flex;align-items:center;gap:8px}
    .api input{width:380px;max-width:45vw;background:#0e1320;border:1px solid var(--line);border-radius:10px;color:#dbe3f4;padding:8px 10px}
    .api button{background:linear-gradient(90deg,#fff,#e9f0ff);color:#0b0c12;border:none;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}

    /* layout */
    .wrap{height:calc(100vh - 54px);max-width:1240px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1.35fr .9fr;gap:16px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr;grid-auto-rows:minmax(280px,auto)}}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);display:flex;flex-direction:column;min-height:220px}
    .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-weight:800;letter-spacing:.2px}
    .panel .body{flex:1;min-height:0;padding:14px;overflow:auto}

    /* LEFT column (Live results + neutron) */
    .live{position:relative;overflow:hidden}
    .live .body{padding:0}
    .neutron{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    canvas#neutron{width:100%;height:100%;display:block;opacity:.9}
    .list{position:relative;z-index:2;padding:14px;display:flex;flex-direction:column;gap:12px}
    .card{background:#0f1726;border:1px solid #202b3e;border-radius:14px;padding:12px 12px 10px}
    .cardHeader{display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--hl),var(--hl2))}
    .host{opacity:.8;font-size:12px}
    .title{font-weight:800;margin-top:6px}
    .hint{opacity:.6;font-size:12px;margin-top:4px}
    .row{display:flex;gap:8px;margin-top:10px}
    .btn{border:1px solid #273246;background:#121a2a;color:#e6ecff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .pill2{margin-left:auto;border:1px dashed #34415a;border-radius:999px;padding:4px 8px;font-size:12px;opacity:.8}
    .veil{position:absolute;inset:0;background:linear-gradient(180deg,rgba(8,10,17,.92),rgba(8,10,17,.82));display:grid;place-items:center;border-radius:14px}
    .veil span{opacity:.85}

    /* RIGHT column */
    .stack{display:flex;flex-direction:column;gap:16px;height:100%}
    .formRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .formRow3{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .formRow+.formRow, .formRow3+.formRow3{margin-top:10px}
    input,textarea{width:100%;background:#0e1320;border:1px solid var(--line);border-radius:12px;color:#dbe3f4;padding:10px 12px}
    textarea{min-height:96px;resize:vertical}
    .actions{display:flex;gap:10px;align-items:center;margin-top:12px}
    .primary{background:linear-gradient(90deg,#ffffff,#e9f0ff);color:#0b0c12;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .mut{opacity:.8}
    .help{margin-left:6px;opacity:.75;cursor:pointer;border:1px solid var(--line);padding:2px 6px;border-radius:10px}

    /* metrics */
    .metricLine{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px dashed #243047}
    .metricLine:last-child{border-bottom:none}
    .dot2{width:8px;height:8px;border-radius:50%;background:#2b9dff}
    .cat{font-weight:700;opacity:.9}
    .meter{margin:8px 0 10px;height:6px;background:#0c1322;border:1px solid #1f2a36;border-radius:999px;overflow:hidden}
    .meter>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--hl),var(--hl2))}
    .small{opacity:.7;font-size:12px}
    .lock{margin-top:12px;padding:10px;border:1px dashed #2b3750;border-radius:12px;opacity:.9}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="./index.html"><svg viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#86f7d6"/><stop offset="1" stop-color="#57a4ff"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="black" stroke="white" stroke-opacity=".15" stroke-width="2"/><path d="M12 36c8 8 18 12 28 12 4 0 8-1 12-2" stroke="url(#g)" stroke-width="4" fill="none"/><circle cx="20" cy="20" r="6" fill="url(#g)"/></svg><b>Galactly</b></a>
      <span id="status" class="pill">connecting…</span>
      <div class="api">
        <label>API:</label>
        <input id="apiBase" placeholder="https://…"/>
        <button id="saveApi">Save</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: one section: Live results -->
    <section class="panel live" id="livePanel">
      <h3>Live results</h3>
      <div class="body">
        <div class="neutron"><canvas id="neutron"></canvas></div>
        <div id="cards" class="list" style="display:none"></div>
      </div>
    </section>

    <!-- RIGHT: one column with two stacked sections -->
    <div class="stack">
      <section class="panel" id="customPanel">
        <h3>Customize your AI</h3>
        <div class="body">
          <div class="formRow">
            <input id="vendor" placeholder="Vendor site e.g. yourcompany.com (optional)"/>
            <input id="seeds" placeholder="Seed buyers (comma separated domains)"/>
          </div>
          <div class="formRow3" style="margin-top:10px">
            <input id="industries" placeholder="Industries e.g. beverage, confectionery"/>
            <input id="regions" placeholder="Regions e.g. US, CA"/>
          </div>
          <textarea id="desc" style="margin-top:10px" placeholder="Describe ideal customers in plain words. Products, pack types, order sizes, retailer channels, and exclusions."></textarea>
          <div class="actions">
            <button id="runBtn" class="primary">Find now</button>
            <span class="small mut">Tip: hold to reveal. 2 deep reveals/day on free.</span>
            <span id="how" class="help" title="How to teach the AI: Be concrete. Example → ‘Gummy vitamin brands in US & CA selling 30–60 count, bottle or pouch, DTC + Amazon; exclude private label.’">?</span>
          </div>
        </div>
      </section>

      <section class="panel" id="metricsPanel">
        <h3>Signals preview <span id="mState" class="small" style="margin-left:6px;opacity:.8">idle</span></h3>
        <div class="body">
          <div class="meter"><i id="mBar"></i></div>
          <div id="metrics"></div>
          <div id="mLock" class="lock" style="display:none">This is a partial run. Upgrade to unlock timing AI, audience overlay, supplier graph, and 1,000+ checks per query.</div>
        </div>
      </section>
    </div>
  </div>

<script>
(function initApiBase(){
  const DEFAULT = (window.API_BASE)|| (localStorage.getItem('apiBase') || 'https://p01--animated-cellar--vz4ftkwrzdfs.code.run');
  const q = new URLSearchParams(location.search);
  const override = q.get('api');
  let base = override || DEFAULT;
  if(base && !/^https?:\/\//i.test(base)) base = 'https://' + base;
  base = base.replace(/\/$/,'');
  window.API_BASE = base;
  try{ localStorage.setItem('apiBase', base); }catch{}
  const input = document.getElementById('apiBase'); input.value = base;
  document.getElementById('saveApi').onclick = ()=>{ const v=(input.value||'').trim().replace(/\/$/,''); window.API_BASE=v; try{localStorage.setItem('apiBase',v)}catch{}; location.reload(); };
})();

const uidKey = 'gal_uid';
let UID = localStorage.getItem(uidKey); if(!UID){ UID='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,UID); }

const $ = (sel)=>document.querySelector(sel);
const statusEl = $('#status');
const listEl = $('#cards');
const neutron = $('#neutron');

// ---------- Live neutron star (low CPU) ----------
(function neutronStar(){
  const cvs = neutron, ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio||1);
  let w=0,h=0,t=0; let raf = null;
  function resize(){ const r=cvs.getBoundingClientRect(); w=r.width; h=r.height; cvs.width=w*DPR; cvs.height=h*DPR; ctx.setTransform(DPR,0,0,DPR,0,0); }
  function ring(cx,cy,r,alpha){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,'+alpha+')'; ctx.lineWidth=1.2; ctx.stroke(); }
  function loop(ts){ raf=requestAnimationFrame(loop); t=ts/1000; ctx.clearRect(0,0,w,h); const cx=w*0.5, cy=h*0.52;
    const coreR = Math.min(w,h)*0.06; // core
    // glow
    const g = ctx.createRadialGradient(cx,cy,0,cx,cy,coreR*5);
    g.addColorStop(0,'rgba(255,255,255,.95)'); g.addColorStop(0.15,'rgba(255,255,255,.25)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,coreR*5,0,Math.PI*2); ctx.fill();
    // rings
    ring(cx,cy,coreR*1.4,0.24); ring(cx,cy,coreR*2.2,0.16); ring(cx,cy,coreR*3.2,0.10);
    // slow beams (two jets)
    const a = t*0.6, len=Math.min(w,h)*0.35;
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(a);
    beam(0,-len,0, len, 0.85); ctx.rotate(Math.PI/2.2); beam(0,-len*0.8,0,len*0.8,0.55); ctx.restore();
    function beam(x1,y1,x2,y2,alpha){ const grd=ctx.createLinearGradient(x1,y1,x2,y2); grd.addColorStop(0,'rgba(134,247,214,'+alpha+')'); grd.addColorStop(1,'rgba(87,164,255,'+alpha+')'); ctx.strokeStyle=grd; ctx.lineWidth=3; ctx.globalCompositeOperation='lighter'; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); ctx.globalCompositeOperation='source-over'; }
  }
  new ResizeObserver(resize).observe(neutron); resize(); requestAnimationFrame(loop);
})();

// ---------- Prefill from onboarding ----------
(function prefill(){
  const V = localStorage.getItem('onboard_vendor') || '';
  const S = localStorage.getItem('onboard_seed') || '';
  const I = localStorage.getItem('onboard_industries') || '';
  const R = localStorage.getItem('onboard_regions') || '';
  const D = localStorage.getItem('onboard_desc') || '';
  if(V) $('#vendor').value = V;
  if(S) $('#seeds').value = S;
  if(I) $('#industries').value = I;
  if(R) $('#regions').value = R;
  if(D) $('#desc').value = D;
  if(V || S || I || R || D){ $('#runBtn').textContent = 'Save & run'; setTimeout(()=>runFind(true), 600); }
})();

// ---------- Fetch helpers ----------
async function apiGet(path){ const r = await fetch(window.API_BASE+path, { headers:{'x-galactly-user':UID} }); return r.json(); }
async function apiPost(path, body){
  const r = await fetch(window.API_BASE+path, { method:'POST', headers:{'content-type':'application/json','x-galactly-user':UID}, body: JSON.stringify(body||{}) });
  return r.json();
}

// ---------- Leads stream (progressive) ----------
let streamTimer=null; let enqueue=[]; let seenUrls=new Set();
function startStream(leads){ enqueue = leads.slice(); tickStream(); }
function tickStream(){ if(streamTimer) clearTimeout(streamTimer); const next = enqueue.shift(); if(next){ addCard(next); streamTimer=setTimeout(tickStream, 1200); } else { /* idle */ } }

function fmtHost(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{return 'source';} }
function addCard(L){
  if(seenUrls.has(L.source_url)) return; seenUrls.add(L.source_url);
  // Hide neutron once first card lands
  if(listEl.style.display==='none'){ listEl.style.display='flex'; }
  const d = document.createElement('div'); d.className='card';
  d.innerHTML = `<div class="cardHeader"><span class="dot"></span><div class="host">${fmtHost(L.source_url)} • ${L.platform||'source'}</div><span class="pill2">Conf ${Math.max(55,Math.min(92, Number(L.heat||68)))}%</span></div>
                 <div class="title">${esc(L.title||'Untitled')}</div>
                 <div class="hint">Press & hold to reveal details</div>`;
  // veil for hold-to-reveal
  const veil = document.createElement('div'); veil.className='veil'; veil.innerHTML = '<span>Press & hold to reveal…</span>';
  d.appendChild(veil);

  // actions row (minimal)
  const row = document.createElement('div'); row.className='row';
  const own = btn('Own'); const why = btn('Why this?'); row.appendChild(own); row.appendChild(why); d.appendChild(row);

  // long press logic
  let t0=null, holding=false, holdTimer=null; const HOLD_MS=1200;
  function pointerDown(e){ if(holding) return; holding=true; t0=Date.now(); holdTimer=setTimeout(()=>reveal(), HOLD_MS); document.addEventListener('pointerup', pointerUp, {once:true}); }
  function pointerUp(){ clearTimeout(holdTimer); holding=false; }
  function reveal(){ veil.remove(); d.querySelector('.hint').textContent='';
    const details=document.createElement('div'); details.className='small'; details.style.marginTop='8px';
    const proof = L.source_url?`<a href="#" data-a="proof">Open proof</a>`:'';
    details.innerHTML = `${esc(L.snippet||'')} ${proof?('· '+proof):''}`;
    d.insertBefore(details,row);
    if(proof){ details.querySelector('[data-a=proof]').onclick=(ev)=>{ev.preventDefault(); window.open(L.source_url,'_blank','noopener'); }; }
    // event
    apiPost('/api/v1/events', { leadId:L.id, type:'hold_reveal', meta:{ms:Date.now()-t0} }).catch(()=>{});
  }
  d.addEventListener('pointerdown', pointerDown);

  // own flow (claim then own)
  own.onclick = async()=>{
    const r = await apiPost('/api/v1/claim',{leadId:L.id}); if(r?.ok){ own.textContent='Confirm own'; own.disabled=false; let w=r.windowId; own.onclick=async()=>{ const r2=await apiPost('/api/v1/own',{windowId:w}); if(r2?.ok){ own.textContent='Owned'; own.disabled=true; } }; }
  };
  // why modal (tiny)
  why.onclick=()=>{
    const m=document.createElement('div'); m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:50';
    m.innerHTML=`<div style="width:min(520px,92vw);background:#0f1420;border:1px solid #202a3a;border-radius:14px;padding:14px">
      <div style="font-weight:800;margin-bottom:6px">Why this lead</div>
      <div class="small">AI score blends recency, channel strength, product signals and procurement traces. Timed to likely buyer cycles. <em>Proof link available after hold.</em></div>
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <span class="pill">Demand Engine</span><span class="pill">Product Signals</span><span class="pill">Procurement</span>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button class="btn" id="closeM">Close</button></div>
    </div>`; document.body.appendChild(m); m.querySelector('#closeM').onclick=()=>m.remove();
  };

  listEl.prepend(d);
}
function btn(txt){ const b=document.createElement('button'); b.className='btn'; b.textContent=txt; return b; }
function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

// ---------- Run find-now & refresh leads ----------
const runBtn = document.getElementById('runBtn');
runBtn.addEventListener('click', ()=>runFind());
async function runFind(auto=false){
  statusEl.textContent='working…';
  const vendor = $('#vendor').value.trim();
  const seeds = $('#seeds').value.trim();
  const industries = $('#industries').value.trim();
  const regions = $('#regions').value.trim();
  const desc = $('#desc').value.trim();
  // persist for future
  try{ localStorage.setItem('onboard_vendor', vendor); localStorage.setItem('onboard_seed', seeds); localStorage.setItem('onboard_industries', industries); localStorage.setItem('onboard_regions', regions); localStorage.setItem('onboard_desc', desc); }catch{}

  // kick the preview engine (slow, partial)
  startMetrics();

  // call backend (free path)
  const payload = { vendorDomain: vendor||undefined, buyers: splitCSV(seeds), industries: splitCSV(industries), regions: splitCSV(regions) };
  try{ await apiPost('/api/v1/find-now', payload); }catch{}
  // pull fresh leads
  setTimeout(refreshLeads, 800);
}
function splitCSV(s){ if(!s) return []; return s.split(',').map(x=>x.trim()).filter(Boolean); }

async function refreshLeads(){
  try{
    const data = await apiGet('/api/v1/leads'); if(!data?.ok) throw 0; statusEl.textContent='ok';
    // stage cards
    const leads = (data.leads||[]).filter(L=>L.platform!=='demo');
    if(leads.length){ startStream(leads.slice(0, 10)); // keep it tight visually
                      document.querySelector('.neutron').style.opacity = 0.25; }
    else { document.querySelector('.neutron').style.opacity = 0.9; }
    // schedule next poll
    const next = Math.max(10, Number(data.nextRefreshSec||15));
    setTimeout(refreshLeads, next*1000);
  }catch(e){ statusEl.textContent='error'; setTimeout(refreshLeads, 5000); }
}
refreshLeads();

// ---------- Metrics preview (slow, partial, anonymized) ----------
const METRIC_STEPS = (function(){
  const cat = (c,n)=>({cat:c, name:n});
  return [
    cat('Demand Engine','Active channel health'),
    cat('Demand Engine','Audience surge check'),
    cat('Demand Engine','Offer & hook sweep'),
    cat('Product Signals','New SKU pulse'),
    cat('Product Signals','Bundle / case-of-N patterns'),
    cat('Product Signals','Price-move watch'),
    cat('Procurement','Vendor-intake doorways'),
    cat('Procurement','Bid/tender phrasing'),
    cat('Vendor Flow','Supplier form freshness'),
    cat('Vendor Flow','Payment & terms hints'),
    cat('Ops Footprint','Hiring & capacity tells'),
    cat('Ops Footprint','Fulfillment strain markers'),
    cat('Seasonality','Calendar & retail windows'),
    cat('Seasonality','Geo demand alignment'),
    cat('Social/PR','Launch chatter & PR rate'),
    cat('Social/PR','Retailer shelf buzz'),
    cat('Timing AI','Contact hour propensity'),
    cat('Timing AI','Follow-up decay curve'),
    cat('Supplier Graph','Co-supplier overlap'),
    cat('Supplier Graph','Switching risk flags'),
    cat('Compliance','Certs & MSDS mentions'),
    cat('Compliance','Recall adjacency scan'),
    cat('Finance','Funding / runway hints'),
    cat('Finance','Shipping & landed cost stress'),
    cat('Channels','Marketplace cadence'),
    cat('Channels','Wholesale vs DTC mix'),
    cat('Intent','Urgency language score'),
    cat('Intent','Quantity & size cues'),
    cat('Trust','Review velocity'),
    cat('Trust','Return/defect mentions')
  ];
})();
let mIdx=0, mTimer=null; const mBar=$('#mBar'), mList=$('#metrics'), mState=$('#mState'), mLock=$('#mLock');
function startMetrics(){ clearInterval(mTimer); mIdx=0; mList.innerHTML=''; mLock.style.display='none'; mState.textContent='running…';
  const maxRun = 22 + Math.floor(Math.random()*4); // partial on free
  mTimer = setInterval(()=>{
    if(mIdx>=maxRun){ clearInterval(mTimer); mState.textContent='partial'; mLock.style.display='block'; return; }
    const step = METRIC_STEPS[mIdx % METRIC_STEPS.length];
    const row = document.createElement('div'); row.className='metricLine';
    row.innerHTML = `<span class="dot2"></span><span class="cat">${step.cat}</span><span>${step.name}</span>`;
    mList.appendChild(row); mList.scrollTop = mList.scrollHeight;
    mIdx++; const p = Math.min(100, Math.round(mIdx/1126*100)); mBar.style.width = (10+p)+'%';
  }, 1300); // slow, teachy
}

</script>
</body>
</html>

