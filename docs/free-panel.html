<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly â€” Free Panel</title>
<link rel="preconnect" href="https://icons.duckduckgo.com">
<style>
:root{
  --bg:#0b0f14; --panel:#111826; --panel2:#0e1520; --card:#101724;
  --muted:#8aa0b2; --text:#e9f1f7; --brand:#8ae3ff; --ring:#24435f;
  --accent:#38e08f; --danger:#ff7b7b; --divider:#1b2531;
  --cta:#6de1ff; --ctaText:#082433; --chip:#172435; --chipOn:#103247;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
a{color:var(--brand);text-decoration:none}
button{cursor:pointer}

.app{display:grid;grid-template-columns:300px 1fr;gap:16px;min-height:100vh;padding:16px}
.left{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:12px}
.right{display:flex;flex-direction:column;gap:12px}

.header{display:flex;align-items:center;gap:12px;background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:10px 12px}
.hostchip{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:12px;background:var(--card);border:1px solid var(--divider)}
.hostchip img{width:20px;height:20px;border-radius:4px;background:#0d1a26}
.hostname{font-weight:700}
.hsp{flex:1}
.count{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--divider);border-radius:10px;padding:6px 8px}
select, input[type=text]{background:#0d1520;color:var(--text);border:1px solid var(--divider);border-radius:10px;padding:8px 10px;outline:none}
select:focus, input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}

.btn{display:inline-flex;align-items:center;gap:.6rem;padding:10px 14px;border-radius:12px;border:1px solid var(--divider);background:#152333;color:#d5e7f5;font-weight:700}
.btn.ghost{background:#152333}
.btn.primary{background:var(--cta);color:var(--ctaText);border:none}
.btn.success{background:var(--accent);color:#062a18;border:none}
.btn:active{transform:translateY(1px)}

.card{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:12px}
.card h4{margin:0 0 8px}
.help{color:var(--muted);font-size:12px}

.row{display:flex;gap:12px;align-items:center}
.stack{display:flex;flex-direction:column;gap:10px}

.table{background:var(--panel);border:1px solid var(--divider);border-radius:14px;overflow:hidden}
thead tr{background:#0e1624}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--divider);text-align:left}
tbody tr:hover{background:#0b1422}

.log{background:var(--panel);border:1px solid var(--divider);border-radius:14px;min-height:120px;padding:8px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px;overflow:auto;white-space:pre-wrap}

.kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.inputrow{display:flex;gap:6px;align-items:center}
.small{font-size:12px;color:var(--muted)}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:var(--chip);border:1px solid var(--divider);color:#cfe0ee;border-radius:999px;padding:6px 10px}
.chip.on{background:var(--chipOn);color:#eaf7ff;border-color:#1b4862}
.tagbox{display:flex;gap:8px;flex-wrap:wrap}
.tagbox input{min-width:180px}

.slider{display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:center}
input[type=range]{width:100%}

/* Profile drawer (preferences) */
.drawer{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:stretch;justify-content:flex-end;z-index:20}
.drawer.show{display:flex}
.sheet{width:min(780px,96vw);height:100%;background:var(--panel);border-left:1px solid var(--divider);box-shadow:0 30px 80px rgba(0,0,0,.45);display:flex;flex-direction:column}
.sheet-hd{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--divider);background:linear-gradient(180deg,#0f1622,#0e1520)}
.sheet-bd{padding:12px;overflow:auto;display:flex;flex-direction:column;gap:12px}
.sheet-ft{display:flex;gap:10px;justify-content:flex-end;padding:12px;border-top:1px solid var(--divider)}

.summary{display:flex;gap:10px;background:#0e1622;border:1px solid var(--divider);padding:10px;border-radius:12px}
.summary .one{font-weight:700}
.token{display:inline-block;padding:2px 6px;border-radius:8px}
.token[contenteditable="true"]{border-bottom:1px dashed #3a5572}
.token:focus{outline:2px solid var(--ring)}

.badge{background:#0d1a26;border:1px solid var(--divider);padding:4px 8px;border-radius:8px;font-size:12px;color:#b8cfe0}
hr{border:0;height:1px;background:var(--divider);margin:8px 0}
@media (max-width:980px){.app{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">

  <!-- LEFT: connection + count (kept minimal) -->
  <aside class="left">
    <div class="card">
      <h4>Connection</h4>
      <div class="stack">
        <label class="small">API Base (must end with <code>/api</code>)</label>
        <div class="inputrow">
          <input id="apiBase" type="text" placeholder="https://your-host.tld/api">
          <button id="saveApi" class="btn">Save</button>
        </div>

        <label class="small">x-api-key (optional)</label>
        <div class="inputrow">
          <input id="apiKey" type="text" placeholder="leave blank if none">
          <button id="saveKey" class="btn">Save</button>
        </div>

        <div class="row">
          <button id="ping" class="btn">Ping</button>
          <button id="clearLog" class="btn ghost">Clear Log</button>
        </div>
        <div class="help">Saved in <span class="badge">localStorage</span>.</div>
      </div>
    </div>

    <div class="card">
      <h4>How many leads</h4>
      <div class="stack">
        <label class="small">Count</label>
        <select id="leadCount">
          <option>3</option><option>6</option><option selected>12</option><option>20</option>
        </select>
        <div class="help">Used by <span class="badge">Find buyers</span>. The supplier host is locked to your profile to keep the panel minimal.</div>
      </div>
    </div>

    <div class="card">
      <h4>HTTP Log</h4>
      <div id="log" class="log"></div>
    </div>
  </aside>

  <!-- RIGHT: header + results -->
  <main class="right">

    <!-- compact header -->
    <div class="header">
      <div class="hostchip" title="Your company profile">
        <img id="fav" alt="">
        <div class="hostname" id="hostLbl">yourcompany.com</div>
        <span id="personaBadge" class="badge">no profile yet</span>
      </div>

      <div class="count">
        <label class="small" style="margin-right:6px">Count</label>
        <select id="leadCountTop">
          <option>3</option><option>6</option><option selected>12</option><option>20</option>
        </select>
      </div>

      <span class="hsp"></span>

      <button id="openProfile" class="btn">Profile</button>
      <button id="applyProfile" class="btn success" title="Save profile to API">Apply</button>
      <button id="findBtn" class="btn primary" title="Get todayâ€™s leads">ðŸ’¥ Find buyers</button>
    </div>

    <!-- persona hint (collapsed; nothing heavy here) -->
    <div class="card" id="personaHint" style="display:none">
      <span class="small">Tip: click <b>Profile</b> to view or edit preferences. All preferences are hidden here to keep this panel focused on your leads.</span>
    </div>

    <!-- results table -->
    <div class="table">
      <table>
        <thead>
          <tr>
            <th>Score</th><th>Temp</th><th>Buyer</th><th>Why</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="results"><tr><td colspan="5" class="small" style="color:var(--muted);padding:16px">No items</td></tr></tbody>
      </table>
    </div>

  </main>
</div>

<!-- PROFILE DRAWER -->
<div class="drawer" id="drawer" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="Profile">
    <div class="sheet-hd">
      <img id="fav2" alt="" width="20" height="20" style="border-radius:4px;background:#0d1a26">
      <div id="hostLbl2" style="font-weight:700">yourcompany.com</div>
      <span class="badge" id="cachedTag" style="margin-left:8px;display:none">(cached)</span>
      <span class="hsp"></span>
      <button id="reclass" class="btn">Re-classify</button>
      <button id="closeDrawer" class="btn ghost">Close</button>
    </div>

    <div class="sheet-bd">

      <!-- One-liner / sentence editor -->
      <div class="summary">
        <div class="one" id="oneLine"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h4>General preferences</h4>
          <span class="small">click to toggle</span>
        </div>
        <div id="generalChips" class="chips"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h4>Product signals (from your site)</h4>
          <span class="small">type + Enter to add</span>
        </div>
        <div class="tagbox" id="productBox">
          <input id="productInput" type="text" placeholder="add tag and press Enter">
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h4>Buyer priorities (dynamic)</h4>
          <span class="small">Tell us how much buyers care</span>
        </div>
        <div id="metricSliders" class="stack"></div>
      </div>

      <div class="card">
        <h4>Buyer targeting</h4>
        <div class="row" style="gap:20px">
          <div style="flex:1">
            <div class="small">City â€” boost near</div>
            <div class="tagbox" id="cityBox">
              <input id="cityInput" type="text" placeholder="add city and press Enter">
            </div>
          </div>
          <div style="flex:1">
            <div class="small">Sectors</div>
            <div class="tagbox" id="sectorBox">
              <input id="sectorInput" type="text" placeholder="e.g., food, beverage, cosmetics">
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="sheet-ft">
      <button id="saveLocal" class="btn">Save locally</button>
      <button id="applyProfile2" class="btn success">Apply to API</button>
    </div>
  </div>
</div>

<script>
(()=>{

// ---------- tiny utils ----------
const $ = sel => document.querySelector(sel);
const logEl = $('#log');
function log(msg){ const ts=new Date().toISOString().replace('T',' ').slice(0,19); logEl.textContent += `[${ts}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; }
function getStored(k, d){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): d; }catch{ return d; } }
function setStored(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
function saveText(k, v){ try{ localStorage.setItem(k, v); }catch{} }
function getText(k){ try{ return localStorage.getItem(k)||"" }catch{ return "" } }

function normHost(h){ return (h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,""); }
function faviconFor(host){ return host? `https://icons.duckduckgo.com/ip3/${encodeURIComponent(host)}.ico` : ""; }

// ------------- persisted settings -------------
const SETTINGS_KEY = "gg:panel:settings";
const settings = getStored(SETTINGS_KEY, {
  apiBase: getText("apiBase") || "",     // reuse any older key
  apiKey:  getText("xApiKey") || "",
  leadCount: Number(getText("leadCount")||12)
});

// ------------- profile / persona -------------
const PROFILE_KEY = "gg:profile";
const SETUP_KEYS = ["gg:setup","galactly:setup","onboard:step3"]; // auto-import sources

let profile = getStored(PROFILE_KEY, null); // canonical shape below
const emptyProfile = (host = "yourcompany.com")=>({
  host, cached:false,
  line:{ host, verb:"supplies", products:"packaging", audience:"brands", region:"the U.S.", contacts:"Operations, Procurement" },
  productTags:[],
  general:["Prefer mid-size companies","De-prioritize giant enterprises","Prioritize nearby buyers","Prefer e-commerce sites","Prefer wholesalers / distributors","Prefer retail brands"],
  metrics:[ // three by default
    {label:"Line automation / fulfillment", value:8},
    {label:"Fast turnaround (â‰¤ 2 weeks)", value:8},
    {label:"Lowest unit cost", value:8}
  ],
  cities:["Chicago","Los Angeles","New York","Dallas","Atlanta","Miami"],
  sectors:["food","beverage","cosmetics","electronics"]
});

// merge helper
function ensureShape(p){
  const base = emptyProfile(p?.host||"yourcompany.com");
  return {
    ...base,
    ...p,
    line:{...base.line, ...(p?.line||{})},
    productTags:[...(p?.productTags||[])],
    general:(p?.general && p.general.length)? [...p.general] : base.general,
    metrics:(p?.metrics && p.metrics.length)? p.metrics.map(m=>({label:m.label, value:Number(m.value||8)})) : base.metrics,
    cities:[...(p?.cities||base.cities)],
    sectors:[...(p?.sectors||base.sectors)],
  };
}

// auto-import from any setup key (created by index.html step 3)
function tryImportFromSetup(){
  for (const k of SETUP_KEYS){
    const raw = getStored(k, null);
    if (!raw) continue;
    // Accept either full profile shape or the step3 "state" you used before
    const host = normHost(raw?.host || raw?.line?.host || raw?.supplierHost || raw?.domain || raw?.companyHost);
    if (!host) continue;
    const p = ensureShape({
      host,
      cached: !!raw.cached,
      line: raw.line || {host, verb:"supplies", products:(raw.products||"packaging"), audience:(raw.audience||"brands"), region:(raw.region||"the U.S."), contacts:(raw.contacts||"Operations, Procurement")},
      productTags: raw.productTags || [],
      general: raw.general || raw.generalPrefs || [],
      metrics: (raw.metrics || raw.buyerPriorities || []).map(x=> typeof x==="string"? {label:x, value:8}: x),
      cities: raw.cities || raw.cityBoost || [],
      sectors: raw.sectors || raw.sectorHints || [],
    });
    setStored(PROFILE_KEY, p);
    profile = p;
    log(`imported profile from ${k}`);
    return true;
  }
  return false;
}

// initial import if no profile saved
if (!profile){ if (!tryImportFromSetup()){ profile = emptyProfile(); } else { /* imported */ } }

// ---------- bind settings UI ----------
const apiBaseEl = $("#apiBase"); const apiKeyEl=$("#apiKey");
const leadCountEl = $("#leadCount"); const leadCountTop = $("#leadCountTop");
apiBaseEl.value = settings.apiBase; apiKeyEl.value = settings.apiKey;
leadCountEl.value = String(settings.leadCount||12);
leadCountTop.value = String(settings.leadCount||12);

$("#saveApi").addEventListener("click", ()=>{ settings.apiBase = apiBaseEl.value.trim(); saveText("apiBase", settings.apiBase); setStored(SETTINGS_KEY, settings); log(`API base set to ${settings.apiBase}`); });
$("#saveKey").addEventListener("click", ()=>{ settings.apiKey = apiKeyEl.value.trim(); saveText("xApiKey", settings.apiKey); setStored(SETTINGS_KEY, settings); log(`x-api-key saved (${settings.apiKey? "â€¢â€¢â€¢": "blank"})`); });
leadCountEl.addEventListener("change", e=>{ settings.leadCount = Number(e.target.value); saveText("leadCount", String(settings.leadCount)); setStored(SETTINGS_KEY, settings); leadCountTop.value = e.target.value; });
leadCountTop.addEventListener("change", e=>{ settings.leadCount = Number(e.target.value); saveText("leadCount", String(settings.leadCount)); setStored(SETTINGS_KEY, settings); leadCountEl.value = e.target.value; });

// ---------- header host chip ----------
function renderHost(){
  const h = profile?.host || "yourcompany.com";
  $("#hostLbl").textContent = h;
  $("#hostLbl2").textContent = h;
  $("#fav").src = faviconFor(h);
  $("#fav2").src = faviconFor(h);
  $("#personaBadge").textContent = profile && profile.productTags ? "persona (imported)" : "no profile yet";
  $("#cachedTag").style.display = profile?.cached ? "" : "none";
}
renderHost();

// ---------- results ----------
function clearResults(){ $("#results").innerHTML = `<tr><td colspan="5" class="small" style="color:var(--muted);padding:16px">No items</td></tr>`; }
clearResults();

// ---------- HTTP helpers ----------
function apiURL(path, q=null){
  const base=(settings.apiBase||"").replace(/\/+$/,"");
  const url = base? `${base}${path}` : path; // allow relative if same host serves API
  if (!q) return url;
  const u=new URL(url, location.origin);
  for (const [k,v] of Object.entries(q)){ if(v!==undefined && v!==null) u.searchParams.set(k,String(v)); }
  return u.toString();
}
async function fetchJSON(url, opts={}){
  const headers = Object.assign({'content-type':'application/json'}, opts.headers||{});
  if (settings.apiKey) headers['x-api-key']=settings.apiKey;
  const r = await fetch(url, {...opts, headers});
  let bodyTxt=""; try{ bodyTxt = await r.text(); }catch{}
  let json=null; try{ json = JSON.parse(bodyTxt); }catch{}
  return {ok:r.ok,status:r.status,body:json,raw:bodyTxt};
}

// ---------- drawer (Profile) ----------
const drawer = $("#drawer");
$("#openProfile").addEventListener("click", ()=>{ openDrawer(); });
$("#closeDrawer").addEventListener("click", ()=>{ closeDrawer(); });
function openDrawer(){ drawer.classList.add("show"); drawer.setAttribute("aria-hidden","false"); renderProfile(); }
function closeDrawer(){ drawer.classList.remove("show"); drawer.setAttribute("aria-hidden","true"); }

function renderOneLiner(){
  const L = profile.line;
  const el = $("#oneLine");
  el.innerHTML = "";
  const parts = [
    ["host", L.host, true], ["sep"," â€” ",true],
    ["verb", L.verb,false], ["products",` ${L.products}`,false],
    ["txt"," for ",true], ["audience", L.audience,false],
    ["txt"," in ",true], ["region", L.region,false],
    ["txt",". ",true], ["txt","Best contacts: ",true], ["contacts",L.contacts,false]
  ];
  for (const [k,txt,lock] of parts){
    const span=document.createElement("span");
    span.className="token"; span.textContent=txt;
    if (!lock && k!=="txt"){ span.contentEditable="true"; span.addEventListener("input",()=>{ profile.line[k]=span.textContent.trim(); persistLocal(); }); }
    el.appendChild(span);
    el.appendChild(document.createTextNode(" "));
  }
}

function renderChips(){
  const box=$("#generalChips"); box.innerHTML="";
  const all = [
    "Prefer mid-size companies","De-prioritize giant enterprises","Prioritize nearby buyers",
    "Prefer e-commerce sites","Prefer wholesalers / distributors","Prefer retail brands"
  ];
  const set=new Set(profile.general||[]);
  for(const label of all){
    const sp=document.createElement("span"); sp.className="chip"+(set.has(label)?" on":""); sp.textContent=label;
    sp.addEventListener("click",()=>{ if(sp.classList.toggle("on")) set.add(label); else set.delete(label); profile.general=[...set]; persistLocal(); });
    box.appendChild(sp);
  }
}

function renderTags(containerId, inputId, list){
  const box=$(containerId); box.innerHTML="";
  for (const t of list){ const sp=document.createElement("span"); sp.className="chip on"; sp.textContent=t; box.appendChild(sp); }
  const input=$(inputId);
  input.value=""; input.onkeydown=(e)=>{
    if (e.key==="Enter"){
      e.preventDefault();
      const v=input.value.trim(); if(!v) return;
      list.push(v); renderTags(containerId,inputId,list); persistLocal();
    }
  };
}

function renderMetrics(){
  const box=$("#metricSliders"); box.innerHTML="";
  if (!profile.metrics || !profile.metrics.length){
    profile.metrics = emptyProfile(profile.host).metrics;
  }
  for (const m of profile.metrics){
    const row=document.createElement("div"); row.className="slider";
    const lab=document.createElement("div"); lab.textContent=m.label;
    const rng=document.createElement("input"); rng.type="range"; rng.min="0"; rng.max="10"; rng.value=String(m.value||8);
    rng.addEventListener("input",()=>{ m.value=Number(rng.value); persistLocal(); });
    row.appendChild(lab); row.appendChild(rng); box.appendChild(row);
  }
}

function renderProfile(){
  profile = ensureShape(profile);
  renderHost();
  renderOneLiner();
  renderChips();
  renderTags("#productBox","#productInput",profile.productTags);
  renderMetrics();
  renderTags("#cityBox","#cityInput",profile.cities);
  renderTags("#sectorBox","#sectorInput",profile.sectors);
}

function persistLocal(){ setStored(PROFILE_KEY, profile); }

// Re-classify (analyze site) -> updates product tags / sectors / line; keeps your manual edits
$("#reclass").addEventListener("click", async ()=>{
  const base=(settings.apiBase||"").replace(/\/+$/,"");
  if (!base){ alert("Set API Base (must end with /api)"); return; }
  const url = apiURL("/classify",{host:profile.host});
  log(`GET ${url}`);
  const r = await fetchJSON(url, {method:"GET"});
  if (!r.ok){ log(`  ${r.status} ${r.raw.slice(0,120)}`); alert("Classify failed"); return; }
  const data = r.body||{};
  // Merge in
  profile.cached = !!data.cached;
  profile.productTags = Array.from(new Set([...(profile.productTags||[]), ...((data.productTags||[]).slice(0,12))]));
  profile.sectors = Array.from(new Set([...(profile.sectors||[]), ...((data.sectorHints||[]).slice(0,8))]));
  if (data.summary || data.productTags){
    const contacts = /industrial|corrugat|pallet|film|shrink|automation/i.test(((data.summary||"")+" "+(data.productTags||[]).join(",")))
      ? "Operations, Procurement" : "Procurement, Marketing";
    profile.line = { ...profile.line, products:(data.productTags||[]).slice(0,3).join(", ") || profile.line.products, audience:(data.sectorHints||[]).slice(0,2).join(", ") || profile.line.audience, contacts };
  }
  persistLocal(); renderProfile(); log("  ok: true (merged)");
});

// Save locally / Apply
$("#saveLocal").addEventListener("click", ()=>{ persistLocal(); alert("Saved locally."); });
function doApply(){ return upsertProfile().then(ok=>{ if(ok){ alert("Applied profile to API."); } }); }
$("#applyProfile").addEventListener("click", doApply);
$("#applyProfile2").addEventListener("click", doApply);

async function upsertProfile(){
  const base=(settings.apiBase||"").replace(/\/+$/,"");
  if (!base){ alert("Set API Base (must end with /api)"); return false; }
  const url = apiURL("/prefs/upsert");
  log(`POST ${url}`);
  const r = await fetchJSON(url,{method:"POST", body:JSON.stringify({profile})});
  if (!r.ok){ log(`  ${r.status} ${r.raw.slice(0,200)}`); return false; }
  log(`  ${r.status} saved`);
  return true;
}

// ---------- Find buyers (hero) ----------
$("#findBtn").addEventListener("click", async ()=>{
  persistLocal(); // ensure saved host
  clearResults();
  const base=(settings.apiBase||"").replace(/\/+$/,"");
  if (!base){ alert("Set API Base (must end with /api)"); return; }
  const limit = settings.leadCount||12;
  const url = apiURL("/leads/find-buyers",{host:profile.host, limit});
  log(`GET ${url}`);
  const r = await fetchJSON(url,{method:"GET"});
  if (!r.ok){ log(`  ${r.status} ${r.raw.slice(0,200)}`); $("#results").innerHTML=`<tr><td colspan="5" class="small" style="color:#f8b">${r.status} â€” failed</td></tr>`; return; }
  const rows = r.body?.items || [];
  if (!rows.length){ $("#results").innerHTML=`<tr><td colspan="5" class="small" style="color:var(--muted)">No items</td></tr>`; return; }
  const tb=$("#results"); tb.innerHTML="";
  for (const it of rows){
    const tr=document.createElement("tr");
    const td=(t)=>{ const x=document.createElement("td"); x.textContent=t; return x; };
    tr.appendChild(td(it.score ?? ""));
    tr.appendChild(td(it.temp ?? ""));
    tr.appendChild(td(it.buyer ?? ""));
    tr.appendChild(td(it.why ?? ""));
    const act=document.createElement("td");
    const a=document.createElement("a"); a.href=it.url||"#"; a.target="_blank"; a.textContent="Open";
    act.appendChild(a); tr.appendChild(act);
    tb.appendChild(tr);
  }
  log(`  ok: ${rows.length} items`);
});

// ---------- persona hint & initial state ----------
document.addEventListener("DOMContentLoaded", ()=>{
  // Show hint once
  $("#personaHint").style.display = "block";
});

// ---------- keep lead count in sync ----------
function syncCountPickers(){ leadCountEl.value = String(settings.leadCount||12); leadCountTop.value = String(settings.leadCount||12); }
syncCountPickers();

// ---------- initial save to canonical key & render ----------
profile = ensureShape(profile);
persistLocal();
renderHost();

})();</script>
</body>
</html>