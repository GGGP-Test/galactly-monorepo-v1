<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V3)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111a2e; --muted:#9aa5b1; --text:#e5e7eb; --chip:#1f2a44; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px;box-sizing:border-box;height:100%;}
    .card{background:var(--panel);border-radius:10px;padding:14px;box-shadow:0 0 0 1px #1c2541 inset;}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0;}
    label{display:block;margin:8px 0 4px 2px;color:var(--muted);}
    input[type=text],select{width:100%;padding:9px 10px;border-radius:8px;border:1px solid #2a3558;background:#0b1224;color:var(--text);}
    button{padding:9px 12px;border:0;border-radius:8px;background:#1d4ed8;color:#fff;cursor:pointer}
    button.secondary{background:#334155}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .status{min-height:20px;margin-top:6px}
    .status.ok{color:#86efac}
    .status.err{color:#fca5a5}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a44;vertical-align:top}
    th{color:#93a3b8;text-align:left;position:sticky;top:0;background:var(--panel)}
    .chip{background:var(--chip);border-radius:999px;padding:3px 8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3 style="margin:2px 0 10px">Leads Console — Free Panel (V3)</h3>

      <label for="base">API base</label>
      <div class="row">
        <input id="base" type="text" placeholder="https://p01-…code.run" />
        <button id="apply">Apply</button>
      </div>

      <label for="apikey">API key (optional for read; required for write)</label>
      <div class="row">
        <input id="apikey" type="text" class="mono" placeholder="paste key…" />
        <button id="saveKey" class="secondary">Save</button>
      </div>

      <div class="row toolbar">
        <button id="refreshHot" class="secondary">Refresh Hot</button>
        <button id="refreshWarm" class="secondary">Refresh Warm</button>
        <span class="muted">API root: <span class="mono" id="apiRoot">/api/v1</span></span>
      </div>

      <hr style="border:0;border-top:1px solid #1f2a44;margin:12px 0" />

      <div class="card" style="background:#0f162c">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="muted">Action</div>
          <div class="chip">Find buyers (one per click)</div>
        </div>

        <label for="supplierHost">Supplier host</label>
        <input id="supplierHost" type="text" placeholder="e.g. peekpackaging.com" />

        <div class="row">
          <select id="country">
            <option value="US/CA">US/CA</option>
            <option value="US">US</option>
            <option value="CA">CA</option>
            <option value="EU">EU</option>
          </select>
          <select id="radiusMi">
            <option value="25">25 mi</option>
            <option value="50" selected>50 mi</option>
            <option value="100">100 mi</option>
            <option value="250">250 mi</option>
          </select>
          <button id="find">Find buyers</button>
        </div>

        <div id="findMsg" class="status"></div>
      </div>

      <label>Supplier persona <span class="muted">(used to infer intent)</span></label>
      <input id="p_offer"  type="text" placeholder="Product/offer (e.g. Stretch film & pallet protection)" />
      <input id="p_solves" type="text" placeholder="Solves (e.g. Keeps pallets secure for storage/transport)" />
      <input id="p_titles" type="text" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing" />
      <div class="row">
        <button id="personaSave" class="secondary">Save persona (local)</button>
      </div>

      <div class="row toolbar">
        <button id="csvHot"  class="secondary">Download CSV (hot)</button>
        <button id="csvWarm" class="secondary">Download CSV (warm)</button>
      </div>

      <div id="status" class="status muted"></div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why (human-readable)</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  // ---------- tiny utilities ----------
  const $ = (id) => document.getElementById(id);
  const firstEl = (ids) => ids.map($).find(Boolean) || null;
  const setVal = (id, v) => { const el = $(id); if (el) el.value = v; };

  // try many id variants so this works with any markup you have
  const els = {
    base:      () => firstEl(['base','apiBase','api_base','apiBaseUrl','api']),
    apikey:    () => firstEl(['apikey','apiKey','key','api_key']),
    apply:     () => firstEl(['apply','btnApply','setBase']),
    saveKey:   () => firstEl(['saveKey','btnSaveKey','save']),
    find:      () => firstEl(['find','findBtn','findbuyers','find-buyers','btnFind']),
    host:      () => firstEl(['supplierHost','host','supplier','supplier_host']),
    country:   () => firstEl(['country','countrySelect','region']),
    radius:    () => firstEl(['radiusMi','radius','distance']),
    listBody:  () => firstEl(['listBody','tbody','resultsBody']),
    findMsg:   () => firstEl(['findMsg','actionMsg','msg']),
    status:    () => firstEl(['status','toast','topMsg']),
  };

  const S = { root:'/api/v1', items:[] };

  const toast = (msg, ok=false) => {
    const el = els.status(); if (!el) return console[ok?'log':'warn'](msg);
    el.textContent = msg; el.classList.remove('ok','err'); el.classList.add(ok?'ok':'err');
  };
  const setFindMsg = (msg, ok=false) => {
    const el = els.findMsg(); if (!el) return;
    el.textContent = msg; el.classList.remove('ok','err'); if (msg) el.classList.add(ok?'ok':'err');
  };

  const readBase = () => (els.base()?.value || '').trim().replace(/\/+$/,'');
  const readKey  = () => (els.apikey()?.value || '').trim();

  async function call(method, path, body=null, query=null){
    const base = readBase();
    const key  = readKey();
    if (!base) return { ok:false, status:0, data:{ ok:false, error:'no base set' } };

    const url = new URL(base + (path.startsWith('/') ? path : ('/'+path)));
    if (query) Object.entries(query).forEach(([k,v]) => (v!=null && v!=='') && url.searchParams.set(k,String(v)));

    const headers = { 'Accept':'application/json' };
    if (body!=null) headers['Content-Type']='application/json';
    if (key) headers['x-api-key']=key;

    let res; try { res = await fetch(url.toString(), { method, headers, body: body!=null ? JSON.stringify(body) : undefined }); }
    catch(e){ return { ok:false, status:0, data:{ ok:false, error:String(e) } }; }

    const txt = await res.text(); let data; try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    return { ok:res.ok, status:res.status, data };
  }

  // ---------- render ----------
  function normalizeItem(raw){
    return {
      host: raw?.host || raw?.source || raw?.domain || '',
      platform: raw?.platform || raw?.type || '',
      title: raw?.title || raw?.name || '',
      created: raw?.created || raw?.createdAt || raw?.ts || '',
      temp: raw?.temp || raw?.temperature || '',
      why: raw?.why || raw?.whyText || raw?.reason || ''
    };
  }
  function renderList(){
    const tb = els.listBody(); if (!tb) return;
    tb.innerHTML='';
    (S.items||[]).forEach((it,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${it.host||''}</td>
        <td>${it.platform||''}</td>
        <td>${it.title||''}</td>
        <td>${it.created||''}</td>
        <td>${it.temp||''}</td>
        <td>${it.why||''}</td>`;
      tb.appendChild(tr);
    });
  }

  // ---------- actions ----------
  async function findOne(){
    setFindMsg('');
    const host = (els.host()?.value || '').trim();
    const country = (els.country()?.value || '').trim();
    const radius = (els.radius()?.value || '').trim();
    if (!host) return setFindMsg('Enter supplier host');

    const btn = els.find(); if (btn) btn.disabled = true;
    const r = await call('GET', `${S.root}/leads/find-buyers`, null, { host, country, radius });
    if (btn) btn.disabled = false;

    if (!r.ok) return setFindMsg(`HTTP ${r.status} — ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}`);
    const items = (r.data && r.data.items) || [];
    const seen = new Set((S.items||[]).map(x => `${x.host}::${x.title}`));
    items.forEach(it => {
      const item = normalizeItem(it);
      const key = `${item.host}::${item.title}`;
      if (!seen.has(key)) { seen.add(key); S.items.unshift(item); }
    });
    renderList();
    setFindMsg(`Found ${items.length} candidate(s).`, true);
  }

  // ---------- bindings ----------
  function bind(){
    // hydrate from localStorage if present
    const savedBase = localStorage.getItem('base');
    const savedKey  = localStorage.getItem('apiKey');
    if (savedBase) { const b=els.base(); if (b) b.value = savedBase; }
    if (savedKey)  { const k=els.apikey(); if (k) k.value = savedKey; }

    // Apply / Save (still optional)
    const apply = els.apply();
    if (apply) apply.addEventListener('click', () => {
      const v = readBase();
      if (v) { localStorage.setItem('base', v); toast(`Base set: ${v}`, true); }
      else   { localStorage.removeItem('base');  toast('Base cleared'); }
    });
    const saveKey = els.saveKey();
    if (saveKey) saveKey.addEventListener('click', () => {
      const v = readKey();
      if (v) { localStorage.setItem('apiKey', v); toast('API key saved', true); }
      else   { localStorage.removeItem('apiKey');  toast('API key cleared'); }
    });

    // Find buyers (main action)
    const findBtn = els.find();
    if (findBtn) findBtn.addEventListener('click', (e)=>{ e.preventDefault(); findOne(); });

    // auto-apply ?base=&key= from URL
    try {
      const u = new URL(location.href);
      const b = u.searchParams.get('base'); const k = u.searchParams.get('key');
      if (b) { if (els.base()) els.base().value = b; localStorage.setItem('base', b); }
      if (k) { if (els.apikey()) els.apikey().value = k; localStorage.setItem('apiKey', k); }
    } catch {}

    renderList();
  }

  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
</body>
</html>