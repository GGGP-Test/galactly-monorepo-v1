<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly — Free panel</title>
<link rel="preconnect" href="https://icons.duckduckgo.com">
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel-2:#0e141c; --card:#0f1724;
    --text:#e9f1f7; --muted:#90a7ba; --muted2:#a9bfd1;
    --divider:#1b2531; --ring:#24435f;
    --chip:#1a2433; --chipActive:#103247;
    --cta:#6de1ff; --ctaText:#082433; --cta2:#0e2538;
    --ok:#38e08f; --warn:#ffd166; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  a{color:inherit}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;max-width:1200px;margin:24px auto;padding:0 18px}
  /* left column */
  .card{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:14px}
  .h{font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin:0 0 8px}
  label{font-size:13px;color:var(--muted2);display:block;margin-bottom:6px}
  input[type=text],input[type=url]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:var(--text);outline:none}
  input:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66}
  .row{display:flex;gap:8px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 14px;border-radius:12px;border:1px solid var(--divider);background:#152333;color:#cfe0ee;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--cta);border:none;color:var(--ctaText);font-weight:700}
  .btn.badge{padding:6px 10px;font-weight:700}
  .btn.ghost{background:transparent}
  .muted{color:var(--muted)}
  .log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0a121b;border:1px solid var(--divider);border-radius:10px;padding:8px;height:120px;overflow:auto;color:#a5bed1}

  /* top bar */
  .top{background:var(--panel);border:1px solid var(--divider);border-radius:14px;padding:10px 12px;display:flex;align-items:center;gap:10px}
  .fav{width:24px;height:24px;border-radius:6px;overflow:hidden;display:grid;place-items:center;background:#fff;border:1px solid #cfd8e3}
  .fav img{width:24px;height:24px;filter:saturate(1.05) contrast(1.05)}
  .name{font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0d1a26;color:#8fb0c6;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .pill.good{color:#0d3b23;background:#08301a;border:1px solid #174b2c}
  .sep{flex:1}
  select{background:#0d1520;border:1px solid var(--divider);color:var(--text);border-radius:10px;padding:8px 10px}

  /* table */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#90a7ba;text-align:left;padding:0 10px}
  tbody td{background:var(--panel-2);border:1px solid var(--divider);padding:12px 10px}
  tbody td:first-child{border-radius:12px 0 0 12px}
  tbody td:last-child{border-radius:0 12px 12px 0}
  .score{font-weight:800}
  .action .btn{padding:6px 10px}

  /* drawer (profile) */
  .drawer{position:fixed;inset:0;background:rgba(5,10,16,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .drawer.show{display:flex}
  .sheet{width:min(980px,92vw);background:var(--card);border:1px solid var(--divider);border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.45);overflow:hidden}
  .sheet-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg,#0f1622,#0e1520);border-bottom:1px solid var(--divider)}
  .sheet-bd{padding:14px}
  .sheet-ft{padding:12px 14px;border-top:1px solid var(--divider);display:flex;justify-content:flex-end;gap:8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipActive);color:#eaf7ff;border-color:#1b4862}
  .slider-row{display:grid;grid-template-columns:1fr 240px;gap:14px;align-items:center;margin:10px 0}
  .one-line{background:#0e1622;border:1px solid var(--divider);border-radius:12px;padding:12px}
  .edit-note{font-size:12px;color:var(--muted);cursor:pointer}
  .x{background:transparent;color:#9fb3c6;border:none;font-size:18px;cursor:pointer}
  .gear{background:transparent;border:none;color:#99b4c7;cursor:pointer}
  @media (max-width:940px){.wrap{grid-template-columns:1fr} .grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: connection & log -->
  <aside class="card">
    <div class="h">Connection</div>
    <label>API base (root or /api)</label>
    <div class="row">
      <input id="apiBase" type="text" placeholder="https://YOUR-NORTHFLANK.code.run or …/api">
      <button id="saveApi" class="btn">Save</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="ping" class="btn">Ping</button>
      <button id="clearLog" class="btn">Clear Log</button>
    </div>

    <div class="h" style="margin-top:16px">How many leads</div>
    <select id="count">
      <option>3</option><option selected>12</option><option>25</option><option>50</option>
    </select>
    <div class="muted" style="margin-top:8px">Used by <b>Find buyers</b>. The supplier host is locked to your profile to keep the panel minimal.</div>

    <div class="h" style="margin-top:16px">HTTP Log</div>
    <pre id="httpLog" class="log"></pre>
  </aside>

  <!-- RIGHT: main panel -->
  <main>
    <div class="top">
      <span class="fav"><img id="fav" alt="" width="24" height="24" referrerpolicy="no-referrer"></span>
      <span class="name" id="company">yourcompany.com</span>
      <span id="personaPill" class="pill">no profile yet</span>
      <span class="sep"></span>
      <label class="muted">Count</label>
      <select id="countTop">
        <option>3</option><option selected>12</option><option>25</option><option>50</option>
      </select>
      <button id="profileBtn" class="btn">Profile</button>
      <button id="applyBtn" class="btn">Apply</button>
      <span class="pill">daily limit 3</span>
      <button id="findBtn" class="btn primary">★ Find buyers</button>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="muted" style="margin-bottom:8px">Tip: click <b>Profile</b> to view or edit preferences. All preferences are hidden here to keep this panel focused on your leads.</div>
      <table>
        <thead>
          <tr><th style="width:90px">Score</th><th style="width:90px">Band</th><th>Buyer</th><th>Why</th><th style="width:150px">Action</th></tr>
        </thead>
        <tbody id="rows">
          <!-- results -->
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- PROFILE DRAWER -->
<div id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="sheet" role="document">
    <div class="sheet-hd">
      <div class="row">
        <span class="fav"><img id="fav2" alt="" width="24" height="24" referrerpolicy="no-referrer"></span>
        <strong id="company2">yourcompany.com</strong>
      </div>
      <div class="row">
        <button id="gear" class="gear" title="Set API base">⚙️</button>
        <button id="close" class="x" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="sheet-bd">
      <!-- one-liner -->
      <div class="one-line" id="oneLineBox">
        <div id="oneLine">yourcompany.com — supplies packaging for brands in the U.S. Best contacts: Operations, Procurement</div>
        <div class="edit-note" id="editToggle">click to toggle edit</div>
      </div>

      <div class="grid">
        <!-- general preferences -->
        <div class="card" style="padding:12px">
          <div class="h">General preferences</div>
          <div id="genChips" class="chips"></div>
          <label style="margin-top:10px">
            <input type="checkbox" id="inboundOptIn"> List my company for inbound opportunities
          </label>
          <div class="muted" id="inboundHint" style="font-size:12px;margin-top:4px">If enabled, buyers searching in the marketplace can discover your company.</div>
        </div>

        <!-- product signals -->
        <div class="card" style="padding:12px">
          <div class="h">Product signals (from your site)</div>
          <input id="prodInput" type="text" placeholder="add tag and press Enter">
          <div id="prodChips" class="chips"></div>
        </div>
      </div>

      <!-- dynamic buyer priorities (exactly three by default, or from persona.metrics) -->
      <div class="card" style="padding:12px;margin-top:14px">
        <div class="h">Buyer priorities (dynamic)</div>
        <div id="metricBox"></div>
      </div>

      <!-- targeting -->
      <div class="grid" style="margin-top:14px">
        <div class="card" style="padding:12px">
          <div class="h">Buyer targeting — City</div>
          <input id="cityInput" type="text" placeholder="add city and press Enter">
          <div id="cityChips" class="chips"></div>
          <div class="muted" style="margin-top:6px">boost near</div>
        </div>
        <div class="card" style="padding:12px">
          <div class="h">Buyer targeting — Sectors</div>
          <input id="sectorInput" type="text" placeholder="add sector and press Enter">
          <div id="sectorChips" class="chips"></div>
        </div>
      </div>
    </div>
    <div class="sheet-ft">
      <button id="saveLocal" class="btn">Save locally</button>
      <button id="applyBtn2" class="btn primary">Apply to API</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- storage helpers ----------
  function getStored(k, d=""){ try{ const v=localStorage.getItem(k); return v===null? d: v; }catch{ return d; } }
  function setStored(k,v){ try{ localStorage.setItem(k,v); }catch{} }
  function delStored(k){ try{ localStorage.removeItem(k); }catch{} }

  // ---------- API base normalization (always ends with /api) ----------
  function normalizeApiBase(input){
    let b=(input||"").trim().replace(/\/+$/,"");
    const m=b.match(/^(.*?)(?:\/api(?:\/.*)?)$/i);
    if(m) b = m[1];
    return b ? (b + "/api") : "";
  }
  const API = {
    get(){ const fromLS=getStored("apiBase",""); const fromWin=window.API_BASE||""; const raw=fromLS||fromWin; return normalizeApiBase(raw); },
    set(v){ setStored("apiBase", v); },
    withKey(init={}){
      const k=getStored("xApiKey","");
      const h=Object.assign({"Content-Type":"application/json"}, init.headers||{});
      if (k) h["x-api-key"]=k;
      return Object.assign({}, init, {headers:h});
    }
  };

  // ---------- http log ----------
  const httpLog = document.getElementById("httpLog");
  function logHttp(line){
    const now = new Date().toISOString().slice(11,19);
    httpLog.textContent = `[${now}] ${line}\n` + httpLog.textContent;
  }

  // ---------- elements ----------
  const apiBaseInput = document.getElementById("apiBase");
  const saveApiBtn = document.getElementById("saveApi");
  const pingBtn = document.getElementById("ping");
  const clearLogBtn = document.getElementById("clearLog");

  const countLeft = document.getElementById("count");
  const countTop  = document.getElementById("countTop");
  const rows = document.getElementById("rows");

  const profileBtn = document.getElementById("profileBtn");
  const applyBtn = document.getElementById("applyBtn");
  const applyBtn2 = document.getElementById("applyBtn2");
  const findBtn = document.getElementById("findBtn");

  const drawer = document.getElementById("drawer");
  const closeX = document.getElementById("close");
  const gearBtn = document.getElementById("gear");

  const fav = document.getElementById("fav");
  const fav2 = document.getElementById("fav2");
  const company = document.getElementById("company");
  const company2 = document.getElementById("company2");
  const pill = document.getElementById("personaPill");

  const oneLine = document.getElementById("oneLine");
  const editToggle = document.getElementById("editToggle");
  const genChips = document.getElementById("genChips");
  const prodInput = document.getElementById("prodInput");
  const prodChips = document.getElementById("prodChips");
  const metricBox = document.getElementById("metricBox");
  const cityInput = document.getElementById("cityInput");
  const cityChips = document.getElementById("cityChips");
  const sectorInput = document.getElementById("sectorInput");
  const sectorChips = document.getElementById("sectorChips");
  const saveLocalBtn = document.getElementById("saveLocal");
  const inboundOptIn = document.getElementById("inboundOptIn");
  const inboundHint = document.getElementById("inboundHint");

  // ---------- state ----------
  const state = {
    persona:null,
    metrics:[],
    host:""
  };

  // ---------- utils ----------
  function normHost(h){ return (h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,""); }
  function setFavicon(el, host){
    const h = normHost(host); if(!h) return el.removeAttribute("src");
    el.src = "https://icons.duckduckgo.com/ip3/"+encodeURIComponent(h)+".ico";
  }
  function openDrawer(){ drawer.classList.add("show"); drawer.setAttribute("aria-hidden","false"); }
  function closeDrawer(){ drawer.classList.remove("show"); drawer.setAttribute("aria-hidden","true"); }

  function chip(label, box, active=false){
    const s=document.createElement("span"); s.className="chip"; s.textContent=label;
    if (active) s.classList.add("active");
    s.addEventListener("click",()=>s.classList.toggle("active"));
    box.appendChild(s);
    return s;
  }
  function addOnEnter(input, box){
    input.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const v=input.value.trim(); if(!v) return;
        chip(v, box, true);
        input.value="";
      }
    });
  }
  function getActiveChips(box){ return Array.from(box.querySelectorAll(".chip.active")).map(x=>x.textContent.trim()); }

  function renderMetrics(metrics){
    metricBox.innerHTML="";
    state.metrics = metrics.slice(0,3); // UI = 3 sliders
    for (const m of state.metrics){
      const row=document.createElement("div"); row.className="slider-row";
      const lab=document.createElement("div"); lab.textContent=m.label || String(m);
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=Number(m.value ?? 8);
      input.addEventListener("input",()=>{ m.value = Number(input.value); });
      row.appendChild(lab); row.appendChild(input);
      metricBox.appendChild(row);
    }
  }

  function defaultMetrics(){
    return [
      {label:"Line automation / fulfillment", value:8},
      {label:"Fast turnaround (≤ 2 weeks)", value:7},
      {label:"Lowest unit cost", value:8}
    ];
  }

  // ---------- prefs <-> persona mapping helpers ----------
  function personaFromPrefs(host, prefs){
    const p = {
      host,
      productTags: Array.isArray(prefs?.categoriesAllow) ? prefs.categoriesAllow : [],
      sectorHints: [], // your server doesn't persist sectors yet; user can add
      general: {
        mids: !!prefs?.preferSmallMid,
        avoidBig: (prefs?.sizeWeight?.large ?? -1.2) < 0,
        near: (prefs?.signalWeight?.local ?? 0) > 0.9,
        ecom: (prefs?.signalWeight?.ecommerce ?? 0) > 0.2,
        wholesale: (prefs?.signalWeight?.wholesale ?? 0) > 0.1,
        retail: (prefs?.signalWeight?.retail ?? 0) > 0.1
      },
      metrics: defaultMetrics(),
      targeting: { city: prefs?.city || "" }
    };
    return p;
  }

  // ---------- applying & fetching ----------
  async function fetchJSON(url, init){
    let r;
    try{ r = await fetch(url, API.withKey(init)); }
    catch(e){ logHttp(`ERR ${url} — ${e.message}`); throw e; }
    const text = await r.text();
    logHttp(`${r.status} ${url}`);
    if (!r.ok){ throw new Error(text || r.statusText); }
    try{ return JSON.parse(text); }catch{ return text; }
  }

  async function fetchPrefs(host){
    const base = API.get(); if(!base) return null;
    try{
      const d = await fetchJSON(base + "/prefs/" + encodeURIComponent(host), {method:"GET"});
      return d?.prefs ? d.prefs : null;
    }catch{ return null; }
  }

  async function fetchInboundStatus(host){
    const base = API.get(); if(!base) return null;
    try{
      const d = await fetchJSON(base + "/inbound/status?host=" + encodeURIComponent(host), {method:"GET"});
      return !!d?.listed;
    }catch{
      // endpoint might not exist; hide the checkbox hint gracefully
      inboundHint.textContent = "Listing endpoint not available on this deployment.";
      return null;
    }
  }

  async function applyInbound(host, optIn){
    const base = API.get(); if(!base) return;
    try{
      await fetchJSON(base + "/inbound/opt-in", {
        method:"POST",
        body: JSON.stringify({ host, optIn: !!optIn })
      });
      logHttp(`inbound ${optIn? "opt-in" : "opt-out"} saved`);
    }catch(e){
      logHttp("inbound save failed: " + e.message);
    }
  }

  function collectPersona(){
    const host = company.textContent.trim();
    const p = state.persona || {};
    const lineText = oneLine.textContent.trim();
    return {
      host,
      line: p.line || {host, verb:"supplies", products:"packaging", audience:"brands", region:"the U.S.", contacts:"Operations, Procurement"},
      lineText,
      productTags: getActiveChips(prodChips),
      sectorHints: getActiveChips(sectorChips),
      general: {
        mids: genChips.textContent.includes("Prefer mid-size"),
        avoidBig: genChips.textContent.includes("De-prioritize"),
        near: genChips.textContent.includes("Prioritize nearby"),
        ecom: genChips.textContent.includes("Prefer e-commerce"),
        wholesale: genChips.textContent.includes("Prefer wholesalers"),
        retail: genChips.textContent.includes("Prefer retail")
      },
      metrics: state.metrics,
      targeting: { city: getActiveChips(cityChips)[0]||"", sectors: getActiveChips(sectorChips).join(", ") }
    };
  }

  async function applyPrefs(){
    const base = API.get(); if(!base){ alert("Set API base first."); return; }
    const payload = collectPersona();
    await fetchJSON(base + "/prefs/upsert", {method:"POST", body: JSON.stringify(payload)});
    // persist host for future sessions
    setStored("fp.supplier.host", payload.host);
    pill.textContent = "profile applied"; pill.classList.add("good");

    // Inbound flag (best-effort)
    const opt = inboundOptIn.checked;
    applyInbound(payload.host, opt);
  }

  async function ping(){
    const base = API.get(); if(!base){ alert("Set API base first."); return; }
    await fetchJSON(base + "/ping", {method:"GET"});
  }

  async function findBuyers(){
    const base = API.get(); if(!base){ alert("Set API base first."); return; }
    const count = Number(countTop.value||countLeft.value||12);
    const p = collectPersona();
    rows.innerHTML="";

    const q = new URLSearchParams({
      host: p.host || company.textContent.trim(),
      limit: String(count),
      city: p.targeting.city || ""
    }).toString();

    // canonical path matches routes/leads.ts
    const paths = ["/leads/find-buyers","/buyers/find","/buyers/search","/find"];
    let data=null, errLast=null;
    for (const path of paths){
      try{
        data = await fetchJSON(base + path + "?" + q, {method:"GET"});
        if (data) break;
      }catch(e){ errLast=e; }
    }
    if (!data){ logHttp("No buyers: " + (errLast? errLast.message : "unknown")); rows.innerHTML = ""; return; }

    const list = Array.isArray(data)? data : (data.items||data.results||[]);
    if (!Array.isArray(list) || !list.length){ rows.innerHTML=""; return; }

    for (const it of list){
      const who = it.name || it.company || it.host || "-";
      const why = Array.isArray(it.reasons) ? it.reasons.join(" • ") : (it.why || it.reason || "-");
      const band = it.band || it.temp || "-";
      const score = (typeof it.score==="number") ? it.score : "-";

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td class="score">${score}</td>
        <td>${band}</td>
        <td>${who}</td>
        <td>${why}</td>
        <td class="action"><button class="btn">Open</button></td>`;
      rows.appendChild(tr);
      tr.querySelector(".btn").addEventListener("click",()=> {
        const href = it.url || ("https://" + (it.host||""));
        if (href) window.open(href, "_blank");
      });
    }
  }

  // ---------- events ----------
  saveApiBtn.addEventListener("click",()=>{
    const normalized = normalizeApiBase(apiBaseInput.value);
    if (!normalized){ alert("Please enter your site root or /api URL."); return; }
    API.set(apiBaseInput.value); // store raw; we normalize on read
    logHttp("API base set to " + normalized.replace(/\/api$/,''));
  });
  gearBtn.addEventListener("click",()=> saveApiBtn.click());
  pingBtn.addEventListener("click", ping);
  clearLogBtn.addEventListener("click", ()=> httpLog.textContent="");
  profileBtn.addEventListener("click", openDrawer);
  closeX.addEventListener("click", closeDrawer);
  applyBtn.addEventListener("click", applyPrefs);
  applyBtn2.addEventListener("click", applyPrefs);
  findBtn.addEventListener("click", findBuyers);
  editToggle.addEventListener("click", ()=> {
    const ed = oneLine.isContentEditable;
    oneLine.contentEditable = !ed;
    oneLine.style.outline = ed? "none" : "2px solid var(--ring)";
  });
  inboundOptIn.addEventListener("change", ()=> {
    const host = company.textContent.trim();
    applyInbound(host, inboundOptIn.checked);
  });
  saveLocalBtn.addEventListener("click", ()=> {
    const p = collectPersona();
    setStored("fp.persona", JSON.stringify(p));
    pill.textContent = "saved locally";
    logHttp("persona saved locally");
  });

  addOnEnter(prodInput, prodChips);
  addOnEnter(cityInput, cityChips);
  addOnEnter(sectorInput, sectorChips);

  // keep count selectors in sync
  function syncCount(e){
    const v = e.target.value;
    countLeft.value = v; countTop.value = v;
  }
  countLeft.addEventListener("change", syncCount);
  countTop.addEventListener("change", syncCount);

  // ---------- boot ----------
  (async function init(){
    apiBaseInput.value = (getStored("apiBase","") || "").replace(/\/+$/,"");

    // Resolve host preference
    let host = getStored("fp.supplier.host","").trim();
    if (!host){
      try{
        const pLS = JSON.parse(getStored("fp.persona","") || getStored("bf.persona","") || "{}");
        if (pLS && pLS.host) host = pLS.host;
      }catch{}
    }
    if (!host) host = "yourcompany.com";
    state.host = normHost(host);
    company.textContent = state.host;
    company2.textContent = state.host;
    setFavicon(fav, state.host);
    setFavicon(fav2, state.host);

    // Import prefs from API if available, else from local persona
    let persona = null;
    const prefs = await fetchPrefs(state.host);
    if (prefs){
      persona = personaFromPrefs(state.host, prefs);
      pill.textContent = "profile (server)"; pill.classList.add("good");
    }else{
      try{ persona = JSON.parse(getStored("fp.persona","") || "{}"); }catch{}
      if (persona && persona.host){
        pill.textContent = "profile (local)"; pill.classList.add("good");
      }else{
        persona = {
          host: state.host,
          productTags:["boxes","mailers","pallets"],
          sectorHints:["food","beverage","cosmetics"],
          general:{mids:true,avoidBig:true,near:true,ecom:true,wholesale:false,retail:false},
          metrics: defaultMetrics(),
          line:{host:state.host,verb:"supplies",products:"packaging",audience:"brands",region:"the U.S.",contacts:"Operations, Procurement"},
          targeting:{city:"Chicago"}
        };
        pill.textContent = "no profile yet";
      }
    }
    renderPersona(persona);

    // Try to hydrate inbound listing state (optional endpoint)
    const listed = await fetchInboundStatus(state.host);
    if (listed !== null) inboundOptIn.checked = !!listed;
  })();

  // ---------- render persona ----------
  function renderPersona(p){
    state.persona = p;
    const host = p.host || "yourcompany.com";
    company.textContent = host; company2.textContent = host;
    setFavicon(fav, host); setFavicon(fav2, host);

    // one-liner
    if (p.line && p.line.host){
      oneLine.textContent = `${p.line.host} — ${p.line.verb} ${p.line.products} for ${p.line.audience} in ${p.line.region}. Best contacts: ${p.line.contacts}`;
    }else if (p.lineText){ oneLine.textContent = p.lineText; }

    // general chips
    genChips.innerHTML="";
    const gen = p.general || {};
    [
      ["Prefer mid-size companies", !!gen.mids],
      ["De-prioritize giant enterprises", !!gen.avoidBig],
      ["Prioritize nearby buyers", !!gen.near],
      ["Prefer e-commerce sites", !!gen.ecom],
      ["Prefer wholesalers / distributors", !!gen.wholesale],
      ["Prefer retail brands", !!gen.retail]
    ].forEach(([lab, on])=> chip(lab, genChips, on));

    // products
    prodChips.innerHTML="";
    (p.productTags||[]).forEach(t=> chip(t, prodChips, true));

    // metrics (3 sliders)
    const m = Array.isArray(p.metrics)&&p.metrics.length ? p.metrics : defaultMetrics();
    renderMetrics(m);

    // targeting
    cityChips.innerHTML=""; (p.targeting?.city? [p.targeting.city] : []).forEach(c=>chip(c,cityChips,true));
    sectorChips.innerHTML=""; (p.sectorHints||[]).forEach(s=>chip(s,sectorChips,true));
  }
})();
</script>
</body>
</html>