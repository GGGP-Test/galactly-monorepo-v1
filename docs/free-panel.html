<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Galactly ‚Äî Live Feed</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b0e13;color:#e8ecf1;margin:0}
header{padding:16px 20px;border-bottom:1px solid #1e2430;display:flex;justify-content:space-between;align-items:center}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.card{background:#111725;border:1px solid #1f2a3b;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
.meta{opacity:.7;font-size:12px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
button{background:#1e2a3b;border:1px solid #2a3b55;color:#e8ecf1;padding:6px 10px;border-radius:10px;cursor:pointer}
button:hover{filter:brightness(1.12)}
a{color:#9ad}
.pill{display:inline-block;border:1px solid #2a3b55;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;opacity:.8}
</style>
</head>
<body>
<header>
<div><strong>Galactly</strong> <span class="pill" id="status">connecting‚Ä¶</span></div>
<div><label>API:
<input id="apiBase" size="48"/></label>
<button id="saveApi">Save</button>
</div>
</header>
<div class="wrap">
<div id="feed" class="grid"></div>
</div>


<script>
const uidKey='galactly_uid';
let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
const apiInput=document.getElementById('apiBase');
const saved=localStorage.getItem('api_base')||'';
apiInput.value=saved||'https://<YOUR-NF-ROUTE>.northflank.app';
document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('api_base', apiInput.value.trim()); location.reload(); };
const API=(p)=> (localStorage.getItem('api_base')||apiInput.value).replace(/\/$/,'') + p;


async function post(path, body){
const r=await fetch(API(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body)});
return r.json();
}
async function events(type, lead, meta){ if(!lead||!lead.id) return; try{ await post('/api/v1/events',{type,leadId:lead.id,meta:meta||{}});}catch(e){} }
function openLead(lead){ events('click', lead, {url:lead.source_url}); window.open(lead.source_url,'_blank','noopener'); }
function likeLead(lead){ events('like', lead); }
function dislikeLead(lead){ events('dislike', lead); }
function muteLead(lead){ let host=''; try{host=new URL(lead.source_url).hostname;}catch(e){} events('mute_domain', lead, {domain:host}); }


async function claimLead(lead){
const r=await post('/api/v1/claim',{leadId:lead.id});
if(r?.ok){ lead._windowId=r.windowId; lead._exp=Date.now()+(r.reservedForSec||120)*1000; render(); }
}
async function ownLead(lead){ if(!lead._windowId) return; const r=await post('/api/v1/own',{windowId:lead._windowId}); if(r?.ok){ events('own',lead); lead._owned=true; render(); } }
function remain(lead){ if(!lead._exp) return ''; const s=Math.max(0,Math.ceil((lead._exp-Date.now())/1000)); return s+'s'; }
  

const elFeed=document.getElementById('feed');
function card(lead){
const d=document.createElement('div'); d.className='card';
let host=''; try{host=new URL(lead.source_url).hostname;}catch(e){}
d.innerHTML=`<div class="meta">${lead.platform||'source'} ‚Ä¢ ${host}</div>
<div><strong>${escapeHtml(lead.title||'Untitled')}</strong></div>
<div>${escapeHtml(lead.snippet||'')}</div>
<div class="btns">
<button data-a="open">Open</button>
<button data-a="like">üëç</button>
<button data-a="dis">üëé</button>
<button data-a="mute">Mute</button>
<button data-a="claim">Claim</button>
<button data-a="own">Own</button>
<span class="meta" data-a="left"></span>
</div>`;
d.querySelector('[data-a=open]').onclick=()=>openLead(lead);
d.querySelector('[data-a=like]').onclick=()=>likeLead(lead);
d.querySelector('[data-a=dis]').onclick=()=>dislikeLead(lead);
d.querySelector('[data-a=mute]').onclick=()=>muteLead(lead);
d.querySelector('[data-a=claim]').onclick=()=>claimLead(lead);
d.querySelector('[data-a=own]').onclick=()=>ownLead(lead);
const left=d.querySelector('[data-a=left]');
if(lead._windowId&&!lead._owned){ const t=remain(lead); left.textContent=t?('reserved '+t):''; }
if(lead._owned){ left.textContent='owned'; }
return d;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }


let lastData=null; function render(){ if(!lastData) return; elFeed.innerHTML=''; for(const L of lastData.leads){ elFeed.appendChild(card(L)); } }
  

async function fetchLeads(){
try{
const r=await fetch(API('/api/v1/leads'), { headers: {'x-galactly-user':uid} });
const data=await r.json(); lastData=data;
if(!data?.ok){ throw new Error('bad response'); }
render();
document.getElementById('status').textContent='ok';
setTimeout(fetchLeads, (data.nextRefreshSec||15)*1000);
}catch(e){ document.getElementById('status').textContent='error'; setTimeout(fetchLeads, 5000); }
}
fetchLeads();
</script>
</body>
</html>
