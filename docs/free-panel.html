<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads Console</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--text); background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:var(--bg); z-index:1; }
    header .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    input, select, button, textarea { background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:8px; padding:8px 10px; outline:none; }
    input::placeholder, textarea::placeholder { color:var(--muted); }
    button { background:#0b1220; cursor:pointer; }
    button.primary { background:var(--accent); border-color:transparent; color:white; }
    button.ghost { background:transparent; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    main { display:grid; gap:16px; grid-template-columns: 2fr 1.3fr 1.2fr; padding:16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:12px; min-height:420px; }
    .card h3 { margin:4px 0 10px; font-size:15px; color:#cbd5e1; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px 6px; border-top:1px solid #1f2937; font-size:13px; }
    tr:hover { background:#0b1220; }
    tr.sel { outline:1px solid var(--accent); background:#0b1220; }
    code.k { background:#0b1220; border:1px solid #1f2937; padding:2px 6px; border-radius:6px; }
    small.muted { color:var(--muted); }
    .why { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .why .chip { display:inline-flex; gap:6px; align-items:center; background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:4px 8px; font-size:12px; width:max-content; }
    .grid { display:grid; gap:8px; }
    .grid.cols2 { grid-template-columns:1fr 1fr; }
    .grid.cols3 { grid-template-columns:1fr 1fr 1fr; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .tip { color:var(--muted); font-size:12px; }
    .status { padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #1f2937; width:max-content; }
    .status.hot { color:#ef4444; border-color:#ef4444; }
    .status.warm { color:#f59e0b; border-color:#f59e0b; }
    .status.cold { color:#60a5fa; border-color:#60a5fa; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .error { color:#fecaca; background:#450a0a; border:1px solid #7f1d1d; padding:6px 8px; border-radius:8px; }
    .ok { color:#dcfce7; background:#052e1a; border:1px solid #14532d; padding:6px 8px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <div class="row" style="gap:10px">
      <strong>Leads Console</strong>
      <span class="tip">Base URL</span>
      <input id="baseUrl" size="46" placeholder="https://…code.run" />
      <button id="applyBase" class="ghost">Apply</button>
      <small class="tip">Tip: host this file from the same domain as the API to avoid CORS.</small>
    </div>
    <div class="right">
      <span class="tip">API key</span>
      <input id="apiKey" size="46" placeholder="x-api-key…" />
      <button id="saveKey" class="primary">Save</button>
      <button id="clearKey" class="ghost">Clear</button>
    </div>
  </header>

  <main>
    <!-- Hot/Warm -->
    <section class="card" id="hotWarmCard">
      <div class="row" style="justify-content:space-between">
        <h3>Hot / Warm</h3>
        <span class="tip">press <code class="k">R</code> to refresh hot</span>
      </div>
      <div class="row" style="margin-bottom:8px">
        <button id="btnHot" class="primary">Refresh Hot</button>
        <button id="btnWarm">Refresh Warm</button>
        <div id="listMsg" class="tip"></div>
      </div>
      <div style="overflow:auto; max-height:64vh; border:1px solid #1f2937; border-radius:10px;">
        <table id="tbl">
          <thead>
            <tr><th>ID</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Details -->
    <section class="card">
      <h3>Details</h3>
      <div id="details"><small class="muted">Select a lead…</small></div>
    </section>

    <!-- Ingest / CSV -->
    <section class="card">
      <h3>Ingest (single)</h3>
      <div class="grid">
        <input id="ingCat" placeholder="cat e.g. product" />
        <input id="ingKw"  placeholder="kw (comma-separated) e.g. packaging,rfp" />
        <input id="ingPlatform" placeholder="platform e.g. shopify" />
        <input id="ingUrl" placeholder="source_url https://…" />
        <input id="ingTitle" placeholder="title e.g. RFP: mailers" />
        <button id="btnIngest" class="primary">Ingest</button>
        <div id="ingMsg" class="tip"></div>
      </div>

      <h3 style="margin-top:18px">Download CSV</h3>
      <div class="row">
        <button id="csvHot">Download CSV (hot)</button>
        <button id="csvWarm">Download CSV (warm)</button>
      </div>
      <div id="csvMsg" class="tip" style="margin-top:6px"></div>
    </section>
  </main>

  <script>
    // ---- storage + config ----
    const S = {
      get baseUrl(){ return localStorage.getItem('baseUrl') || inferDefaultBase(); },
      set baseUrl(v){ localStorage.setItem('baseUrl', v); },
      get apiKey(){ return localStorage.getItem('apiKey') || ''; },
      set apiKey(v){ localStorage.setItem('apiKey', v); },
    };
    function inferDefaultBase() {
      // If opened from same origin as API, location.origin works. If opened from file://, leave empty.
      return (location.origin && location.origin !== 'null') ? location.origin : '';
    }

    // ---- DOM helpers ----
    const $ = sel => document.querySelector(sel);
    const tbody   = $('#tbody');
    const details = $('#details');
    const listMsg = $('#listMsg');
    const ingMsg  = $('#ingMsg');
    const csvMsg  = $('#csvMsg');

    // ---- network helper ----
    async function jget(path, opts = {}) {
      const base = $('#baseUrl').value.trim();
      if (!base) throw new Error('Base URL is empty. Set it at the top.');
      const url = base.replace(/\/+$/,'') + path;
      const headers = { ...(opts.headers||{}), 'Accept':'application/json' };
      if (opts.auth && S.apiKey) headers['x-api-key'] = S.apiKey;
      const res = await fetch(url, { ...opts, headers });
      const ct = res.headers.get('content-type') || '';
      const isJson = ct.includes('application/json');
      if (!res.ok) {
        const body = isJson ? await res.json().catch(()=>({})) : await res.text();
        const err  = isJson ? (body.error || JSON.stringify(body)) : body;
        throw new Error(`${res.status} ${res.statusText} — ${err}`);
      }
      return isJson ? res.json() : res.text();
    }

    // ---- list rendering ----
    let rows = [];
    function renderList(items) {
      rows = items || [];
      tbody.innerHTML = '';
      for (const it of rows) {
        const tr = document.createElement('tr');
        tr.dataset.id = it.id;
        tr.innerHTML = `
          <td class="mono">${it.id}</td>
          <td>${it.host||''}</td>
          <td>${it.platform||''}</td>
          <td>${it.title||''}</td>
          <td>${new Date(it.created_at).toLocaleString()}</td>
          <td><span class="status ${it.temperature||''}">${it.temperature||''}</span></td>
          <td><small class="muted">${(it.why||[]).map(w=>w.label).join(', ')}</small></td>`;
        tr.addEventListener('click', () => selectRow(tr, it.id));
        tbody.appendChild(tr);
      }
    }

    async function load(kind='hot') {
      try {
        listMsg.textContent = 'Loading…';
        const data = await jget(`/api/v1/leads/${kind}?limit=50`);
        renderList(data.items||[]);
        listMsg.textContent = `Loaded ${rows.length} ${kind} lead(s).`;
      } catch (e) {
        listMsg.textContent = `Error: ${e.message}`;
      }
    }

    // ---- details panel ----
    function renderDetails(model) {
      const L = model.lead || model;
      const why = model.why || L.why || [];
      details.innerHTML = `
        <div class="grid">
          <div><div class="tip">ID</div><div class="mono">${L.id}</div></div>
          <div><div class="tip">Host</div><div>${L.host||''}</div></div>
          <div><div class="tip">Platform</div><div>${L.platform||''}</div></div>
          <div><div class="tip">Created</div><div>${new Date(L.created_at).toLocaleString()}</div></div>
          <div><div class="tip">Title</div><div>${L.title||''}</div></div>
          <div><div class="tip">Temp</div><div><span class="status ${model.temperature||''}">${model.temperature||''}</span></div></div>
        </div>
        <div class="why">
          ${why.map(w => `<div class="chip"><strong>${w.label}</strong><span class="tip">(${w.kind})</span><span class="mono">${w.score}</span></div>`).join('')}
        </div>

        <hr style="border:none;border-top:1px solid #1f2937;margin:12px 0" />

        <div class="grid cols2">
          <div>
            <div class="tip" style="margin-bottom:6px">Set stage</div>
            <div class="row">
              <select id="stageSel">
                <option value="new">new</option>
                <option value="qualified">qualified</option>
                <option value="contacted">contacted</option>
                <option value="proposal">proposal</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
              <button id="btnStage" class="primary">Save</button>
            </div>
          </div>

          <div>
            <div class="tip" style="margin-bottom:6px">Add note</div>
            <div class="row" style="gap:6px">
              <input id="noteText" placeholder="e.g. First call done; decision next week" style="flex:1" />
              <button id="btnNote">Add</button>
            </div>
          </div>
        </div>

        <div id="detailMsg" style="margin-top:8px" class="tip"></div>
      `;

      $('#btnStage').onclick = async () => {
        const stage = $('#stageSel').value;
        await doStage(L.id, stage);
      };
      $('#btnNote').onclick = async () => {
        const note = $('#noteText').value.trim();
        if (!note) return msg('#detailMsg','Note cannot be empty','error');
        await doNote(L.id, note);
        $('#noteText').value = '';
      };
    }

    async function selectRow(tr, id) {
      for (const r of tbody.querySelectorAll('tr')) r.classList.remove('sel');
      tr.classList.add('sel');
      try {
        const data = await jget(`/api/v1/leads/${id}`);
        renderDetails(data);
      } catch (e) {
        msg('#detailMsg', e.message, 'error');
      }
    }

    function msg(sel, text, kind='tip') {
      const el = document.querySelector(sel);
      if (!el) return;
      el.className = kind === 'error' ? 'error' : (kind === 'ok' ? 'ok':'tip');
      el.textContent = text;
    }

    // ---- stage + notes (auth) ----
    async function doStage(id, stage) {
      try {
        await jget(`/api/v1/leads/${id}/stage`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ stage }),
          auth: true
        });
        msg('#detailMsg','Stage saved.','ok');
      } catch (e) {
        msg('#detailMsg', e.message, 'error');
      }
    }
    async function doNote(id, note) {
      try {
        await jget(`/api/v1/leads/${id}/notes`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ note }),
          auth: true
        });
        msg('#detailMsg','Note added.','ok');
      } catch (e) {
        msg('#detailMsg', e.message, 'error');
      }
    }

    // ---- ingest (auth) ----
    async function ingestOne() {
      const cat = $('#ingCat').value.trim();
      const kw  = $('#ingKw').value.trim();
      const platform = $('#ingPlatform').value.trim();
      const source_url = $('#ingUrl').value.trim();
      const title = $('#ingTitle').value.trim();
      if (!cat || !platform || !source_url || !title) {
        msg('#ingMsg','cat, platform, source_url, title are required','error'); return;
      }
      const payload = { cat, kw: kw ? kw.split(',').map(s=>s.trim()).filter(Boolean):[], platform, source_url, title };
      try {
        const data = await jget(`/api/v1/leads/ingest`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload),
          auth: true
        });
        msg('#ingMsg',`Ingested id=${data.lead?.id || 'ok'}`,'ok');
      } catch (e) {
        msg('#ingMsg', e.message, 'error');
      }
    }

    // ---- csv ----
    function downloadCsv(kind) {
      const base = $('#baseUrl').value.trim();
      const url = `${base.replace(/\/+$/,'')}/api/v1/leads/export.csv?temperature=${encodeURIComponent(kind)}&limit=50`;
      // Let browser do the file navigation. (Auth not required.)
      const a = document.createElement('a');
      a.href = url;
      a.download = `leads_${kind}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      msg('#csvMsg', `Requested CSV (${kind}).`);
    }

    // ---- bootstrap ----
    function init() {
      $('#baseUrl').value = S.baseUrl;
      $('#apiKey').value  = S.apiKey;

      $('#applyBase').onclick = () => {
        S.baseUrl = $('#baseUrl').value.trim();
        msg('#listMsg', `Base URL set to ${S.baseUrl || '(empty)'}`);
      };

      $('#saveKey').onclick = () => { S.apiKey = $('#apiKey').value.trim(); msg('#listMsg','API key saved.'); };
      $('#clearKey').onclick = () => { S.apiKey = ''; $('#apiKey').value=''; msg('#listMsg','API key cleared.'); };

      $('#btnHot').onclick = () => load('hot');
      $('#btnWarm').onclick = () => load('warm');
      $('#btnIngest').onclick = ingestOne;
      $('#csvHot').onclick = ()=>downloadCsv('hot');
      $('#csvWarm').onclick = ()=>downloadCsv('warm');

      // keyboard shortcut: R → refresh hot
      window.addEventListener('keydown', e => { if (e.key.toLowerCase()==='r') load('hot'); });

      // initial load if base is present
      if ($('#baseUrl').value) load('hot');
    }
    init();
  </script>
</body>
</html>
