<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --chip:#1f2937; --chipBadge:#374151; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --btn:#2563eb; --btnHover:#1d4ed8; --line:#1f2937; --shadow:0 8px 24px rgba(0,0,0,.25);
      --radius:10px; --tooltip:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-size:18px;margin:0 0 10px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{display:flex;gap:8px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fill{flex:1 1 auto}
    input,select,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #223;outline:none;border-radius:8px;padding:10px}
    button{background:var(--btn);border:none;color:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#374151}
    button.warn{background:var(--warn);color:#111}
    button:hover{background:var(--btnHover)}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .list{max-height:62vh;overflow:auto;border-top:1px solid var(--line)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .pill .badge{padding:2px 6px;border-radius:999px;background:var(--chipBadge);font-weight:600}
    .temp{padding:2px 8px;border-radius:999px;font-weight:700}
    .hot{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .warm{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{position:sticky;top:0;background:rgba(17,24,39,.95);backdrop-filter:saturate(140%) blur(6px);text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .why{display:flex;flex-wrap:wrap;gap:6px}
    .notice{padding:10px 12px;border-radius:8px;background:#0b1220;border:1px dashed #223}
    .error{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4)}
    .success{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.4)}
    .link{color:#93c5fd;text-decoration:none}

    /* modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{max-width:680px;width:100%;background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
    .modal .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .modal .body{padding:14px}
    .close{cursor:pointer;padding:4px 8px;border-radius:8px;background:#374151}

    /* tiny tooltip */
    .tip{display:inline-flex;align-items:center;gap:4px}
    .tip i{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:#253047;color:#c7d2fe;font-style:normal;font-size:12px;cursor:help;position:relative}
    .tip i:hover::after{
      content: attr(data-tip);
      position:absolute;left:50%;transform:translateX(-50%);bottom:22px;
      white-space:nowrap;background:var(--tooltip);border:1px solid #223;color:var(--text);
      padding:6px 8px;border-radius:8px;font-size:12px;z-index:60
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leads Console — Free Panel (V3)</h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="head row">
          <div class="row fill">
            <input id="baseUrl" class="fill" placeholder="Base URL (e.g. https://p01--…code.run)" />
            <button id="apply">Apply</button>
          </div>
          <div class="row fill">
            <input id="apiKey" class="fill" placeholder="API key (required for write ops)" />
            <button id="saveKey" class="secondary">Save</button>
          </div>
        </div>
        <div class="body row">
          <button id="refreshHot" class="secondary">Refresh Hot</button>
          <button id="refreshWarm" class="secondary">Refresh Warm</button>
          <div class="fill"></div>
          <div class="muted mono">API root: <span id="apiPath">auto</span></div>
        </div>
        <div class="list">
          <table id="leads">
            <thead>
              <tr>
                <th style="width:60px">#</th>
                <th>Host</th>
                <th style="width:120px">Platform</th>
                <th>Title</th>
                <th style="width:120px">Created</th>
                <th style="width:80px">Temp</th>
                <th style="width:28%">Why</th>
              </tr>
            </thead>
            <tbody id="leadRows"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head"><div class="row"><div class="pill"><span class="badge">Action</span> Find buyers (one per click)</div></div></div>
        <div class="body">
          <div class="row">
            <input id="supplier" class="fill" placeholder="supplier domain e.g. stretchandshrink.com" />
          </div>
          <div class="row">
            <select id="region" style="width:160px">
              <option value="us">US</option>
              <option value="ca">CA</option>
              <option value="usca" selected>US/CA</option>
            </select>
            <select id="radius" style="width:120px">
              <option value="25">25 mi</option>
              <option value="50" selected>50 mi</option>
              <option value="100">100 mi</option>
              <option value="250">250 mi</option>
            </select>
            <button id="find" style="min-width:140px">Find buyers</button>
          </div>
          <div id="findMsg" class="notice muted" style="margin-top:8px"></div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Supplier persona</span> (used to infer intent)</div></div></div>
        <div class="body">
          <div class="row">
            <input id="p_offer" class="fill" placeholder="Product/offer (e.g. Stretch film & pallet protection)" />
          </div>
          <div class="row" style="margin-top:8px">
            <input id="p_solves" class="fill" placeholder="Solves (e.g. Keeps pallets secure for storage/transport)" />
          </div>
          <div class="row" style="margin-top:8px">
            <input id="p_titles" class="fill" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing Manager, COO" />
            <button id="personaSave" class="secondary">Save persona (local)</button>
          </div>
          <div class="note muted" style="margin-top:6px">Editing persona won’t clear your list.</div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Downloads</span> CSV</div></div></div>
        <div class="body row">
          <button id="dlHot" class="secondary">Download CSV (hot)</button>
          <button id="dlWarm" class="secondary">Download CSV (warm)</button>
        </div>
      </div>
    </div>

    <div id="toast" class="notice" style="margin-top:16px;display:none"></div>
  </div>

  <!-- modal -->
  <div id="modalMask" class="modalMask">
    <div class="modal">
      <div class="head">
        <div class="row">
          <div class="pill"><span class="badge">Lead</span> Preview</div>
        </div>
        <div class="close" id="modalClose">✕</div>
      </div>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const $  = s => document.querySelector(s);

    // --- state
    const S = {
      baseUrl: localStorage.getItem('baseUrl') || '',
      apiKey:  localStorage.getItem('apiKey')  || '',
      persona: JSON.parse(localStorage.getItem('persona')||'{"offer":"","solves":"","titles":""}'),
      items:   JSON.parse(localStorage.getItem('items')||'[]'),
      apiPrefix: localStorage.getItem('apiPrefix') || 'auto'  // 'auto' | '/api/v1' | ''
    };

    // --- bindings
    const UI = {
      baseUrl: $('#baseUrl'), apiKey: $('#apiKey'), apply: $('#apply'), saveKey: $('#saveKey'),
      supplier: $('#supplier'), region: $('#region'), radius: $('#radius'), find: $('#find'),
      findMsg: $('#findMsg'), leadRows: $('#leadRows'), apiPath: $('#apiPath'),
      p_offer: $('#p_offer'), p_solves: $('#p_solves'), p_titles: $('#p_titles'), personaSave: $('#personaSave'),
      refreshHot: $('#refreshHot'), refreshWarm: $('#refreshWarm'), dlHot: $('#dlHot'), dlWarm: $('#dlWarm'),
      toast: $('#toast'), modalMask: $('#modalMask'), modalBody: $('#modalBody'), modalClose: $('#modalClose')
    };

    UI.baseUrl.value = S.baseUrl; UI.apiKey.value = S.apiKey;
    UI.p_offer.value  = S.persona.offer || '';
    UI.p_solves.value = S.persona.solves || '';
    UI.p_titles.value = S.persona.titles || '';
    UI.apiPath.textContent = S.apiPrefix === 'auto' ? 'auto' : (S.apiPrefix || '(none)');

    function toast(msg, ok=false, err=false){
      UI.toast.textContent = msg;
      UI.toast.className = 'notice ' + (ok?'success':(err?'error':''));
      UI.toast.style.display = 'block';
      setTimeout(()=>UI.toast.style.display='none', 2500);
    }
    function base(){ return (S.baseUrl || '').replace(/\/+$/,''); }

    // --- universal API caller with automatic /api/v1 fallback
    async function call(method, logicalPath, body){
      const ensure = s => s.startsWith('/') ? s : '/'+s;
      const tryPrefixes = S.apiPrefix==='auto' ? ['/api/v1',''] : [S.apiPrefix];

      let last = null;
      for (const pref of tryPrefixes){
        const url = base() + ensure(pref) + ensure(logicalPath);
        const headers = {'Content-Type':'application/json'};
        if (S.apiKey) headers['x-api-key'] = S.apiKey;
        const res  = await fetch(url, {method, headers, body: body?JSON.stringify(body):undefined});
        const text = await res.text();
        let data = null; try{ data = JSON.parse(text) }catch{ data = text }
        last = { ok:res.ok, status:res.status, data, headers:res.headers, url };
        // if not 404, we consider this the correct prefix
        if (res.status !== 404){
          if (S.apiPrefix==='auto'){
            S.apiPrefix = pref;
            localStorage.setItem('apiPrefix', S.apiPrefix);
            UI.apiPath.textContent = S.apiPrefix || '(none)';
          }
          return last;
        }
      }
      // still 404 across prefixes
      return last;
    }

    // --- list rendering
    function nlWhy(why){
      const chips = [];
      if (!why) return chips;
      if (why.signal){
        const v = why.signal; chips.push(`<span class="pill">${v.label||'Signal'} <span class="badge">${v.score??''}</span> <span class="muted">${v.detail||''}</span></span>`);
      }
      if (why.context){
        const v = why.context; chips.push(`<span class="pill">${v.label||'Context'} <span class="muted">${v.detail||''}</span></span>`);
      }
      return chips;
    }
    function renderList(){
      UI.leadRows.innerHTML = '';
      (S.items||[]).forEach((it,i)=>{
        const host = (it.host||'').replace(/^https?:\/\//,'');
        const href = host ? `https://${host}` : '#';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${i+1}</td>
          <td><a class="link mono" href="${href}" target="_blank">${host}</a></td>
          <td>${it.platform||'unknown'}</td>
          <td class="mono">${it.title||''}</td>
          <td>${new Date(it.created).toLocaleString()||''}</td>
          <td><span class="temp ${it.temperature||'warm'}">${it.temperature||'warm'}</span></td>
          <td><div class="why">${nlWhy(it.why).join('')}</div><div class="muted">${it.whyText||''}</div></td>
        `;
        tr.onclick = ()=>openModal(it);
        UI.leadRows.appendChild(tr);
      });
      localStorage.setItem('items', JSON.stringify(S.items||[]));
    }

    // --- modal & actions
    function fomoFloor(host, apiCount){ if (apiCount>0) return apiCount; let h=0; for (let i=0;i<host.length;i++) h=(h*31 + host.charCodeAt(i))>>>0; const hour=new Date().getHours(); const base=(hour>=22||hour<=6)?1:2; return base + (h % 3); }

    async function openModal(it){
      let watchers = 0, competitors = 0;
      try{
        const r = await call('GET', `metrics/watchers?host=${encodeURIComponent(it.host)}`);
        if (r.ok){
          watchers = Number(r.data?.counts?.watchers||0);
          competitors = Number(r.data?.counts?.competitors||0);
        }
      }catch{}
      const fomo = fomoFloor(it.host, watchers+competitors);

      UI.modalBody.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div class="pill"><span class="badge">Host</span> <a class="link mono" href="https://${it.host}" target="_blank">${it.host}</a></div>
          <div class="pill"><span class="badge">Temp</span> <span class="temp ${it.temperature}">${it.temperature}</span></div>
        </div>
        <div style="margin-top:10px">
          <div class="pill"><span class="badge">Why</span> Human-readable evidence</div>
          <div class="why" style="margin-top:8px">${nlWhy(it.why).join('')}</div>
          ${it.whyText ? `<div class="notice" style="margin-top:8px">${it.whyText}</div>`:''}
        </div>
        <div style="margin-top:12px" class="row">
          <button id="btnLock">Save & Lock</button>
          <span class="tip"><i data-tip="Locks this lead to you in the free panel and improves your future ranking. Others can still see it on free plan.">!</i></span>
          <button id="btnDeepen" class="secondary">Deepen results</button>
          <span class="tip"><i data-tip="Runs extra checks (news/RSS/keywords) and enriches the Why. Pro plan unlocks deeper signals.">!</i></span>
          <div class="fill"></div>
          <div class="muted">Others viewing now: <b>${fomo}</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnAnother" class="warn">Find another</button>
        </div>
      `;
      $('#btnLock').onclick = async ()=>{
        const r = await call('POST','metrics/claim',{ host: it.host, title: it.title, platform: it.platform, why: it.why, temperature: it.temperature });
        toast(r.ok ? 'Saved & locked to you' : `Failed to lock (HTTP ${r.status})`, r.ok, !r.ok);
      };
      $('#btnDeepen').onclick = async ()=>{
        const r = await call('GET', `metrics/deepen?host=${encodeURIComponent(it.host)}`);
        toast(r.ok ? 'Enriched (if data available)' : `No extra data yet (HTTP ${r.status})`, r.ok, !r.ok);
      };
      $('#btnAnother').onclick = async ()=>{ UI.modalMask.style.display='none'; await findOne(); };

      UI.modalMask.style.display = 'flex';
    }
    UI.modalClose.onclick = ()=> UI.modalMask.style.display='none';
    UI.modalMask.onclick = (e)=>{ if (e.target===UI.modalMask) UI.modalMask.style.display='none'; };

    // --- find one lead (auto prefix)
    async function findOne(){
      const supplier = UI.supplier.value.trim().toLowerCase();
      if (!supplier){ toast('Enter a supplier domain', false, true); return; }
      const body = {
        supplier,
        region: UI.region.value,
        radiusMi: Number(UI.radius.value||'50')||50,
        persona: {
          offer: UI.p_offer.value.trim(),
          solves: UI.p_solves.value.trim(),
          titles: UI.p_titles.value.trim()
        }
      };
      UI.find.disabled = true;
      UI.findMsg.textContent = 'Finding buyers…';

      const r = await call('POST','leads/find-buyers', body);
      UI.find.disabled = false;

      if (r.status === 401){ UI.findMsg.innerHTML = `<div class="notice error mono">401 — API key required</div>`; return; }
      if (r.status === 429){ UI.findMsg.innerHTML = `<div class="notice error mono">Too many tries — wait ~10s</div>`; return; }
      if (!r.ok){ UI.findMsg.innerHTML = `<div class="notice error mono">HTTP ${r.status} — ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}<div class="muted" style="margin-top:4px">${r.url}</div></div>`; return; }

      const all = Array.isArray(r.data?.candidates) ? r.data.candidates : [];
      if (!all.length){ UI.findMsg.innerHTML = `<div class="notice mono">No candidates found. Try widening radius or switching region.</div>`; return; }

      const already = new Set((S.items||[]).map(x=>x.host));
      const first = all.find(c=>!already.has(c.host)) || all[0];

      const item = {
        host: first.host || first.domain || '',
        platform: first.source || 'news',
        title: first.title || first.reason || '',
        created: new Date().toISOString(),
        temperature: first.temperature || (typeof first.score==='number' && first.score>=0.65 ? 'hot':'warm'),
        why: first.why || {
          signal: { label: first.score>=0.65 ? 'Opening/launch signal' : 'Expansion signal', score: Number((first.score||0).toFixed?first.score.toFixed(2):first.score||0), detail: first.title||'' },
          context: { label: (first.source||'').startsWith('rss') ? 'News (RSS)' : 'News (Google)', detail: first.source||'' }
        },
        whyText: first.whyText || first.title || ''
      };

      S.items = S.items || [];
      S.items.push(item);
      localStorage.setItem('items', JSON.stringify(S.items));
      renderList();
      UI.findMsg.innerHTML = `<div class="notice success mono">1 candidate ready — preview opened.</div>`;
      openModal(item);
    }

// --- CSV utils
function toCSV(items){
  const cols = ['host','platform','title','created','temp','why'];
  const head = cols.join(',');
  const esc = v => String(v ?? '')
    .replace(/"/g,'""')
    .replace(/\r?\n|\r/g,' ')
    .trim();

  const rows = (items || []).map(it =>
    cols.map(c => {
      if (c === 'why')  return `"${esc(it.whyText || it.why || '')}"`;
      if (c === 'temp') return `"${esc(it.temp || it.temperature || '')}"`;
      return `"${esc(it[c])}"`;
    }).join(',')
  );

  return [head, ...rows].join('\r\n');
}

function download(name, text){
  const a = document.createElement('a');
  const url = URL.createObjectURL(new Blob([text], { type: 'text/plain;charset=utf-8' }));
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 0);
}

// --- events
UI.apply.onclick = () => {
  const base = (UI.base?.value || '').trim().replace(/\/+$/,'');
  S.base = base;
  localStorage.setItem('base', base);
  toast?.('Base URL applied', true);
};

UI.saveKey.onclick = () => {
  const k = (UI.apiKey?.value || '').trim();
  S.apiKey = k;
  localStorage.setItem('apiKey', k);
  toast?.('API key saved locally', true);
};

UI.personaSave.onclick = () => {
  S.persona = {
    offer:  UI.p_offer?.value?.trim() || '',
    solves: UI.p_solves?.value?.trim() || '',
    titles: UI.p_titles?.value?.trim() || ''
  };
  localStorage.setItem('persona', JSON.stringify(S.persona));
  toast?.('Persona saved locally', true);
};

UI.find.onclick = findOne;

UI.refreshHot.onclick = async () => {
  const r = await call('GET', 'leads?temp=hot');
  if (!r?.ok) return toast?.(`Failed to load hot leads: ${r?.error||'unknown'}`);
  const seen = new Set((S.items||[]).map(x => x.id ?? x.host));
  (r.data?.items || []).forEach(x => { if (!seen.has(x.id ?? x.host)) (S.items ||= []).push(x); });
  renderList();
  toast?.(`Loaded ${(r.data?.items||[]).length} hot lead(s)`);
};

UI.refreshWarm.onclick = async () => {
  const r = await call('GET', 'leads?temp=warm');
  if (!r?.ok) return toast?.(`Failed to load warm leads: ${r?.error||'unknown'}`);
  const seen = new Set((S.items||[]).map(x => x.id ?? x.host));
  (r.data?.items || []).forEach(x => { if (!seen.has(x.id ?? x.host)) (S.items ||= []).push(x); });
  renderList();
  toast?.(`Loaded ${(r.data?.items||[]).length} warm lead(s)`);
};

UI.dlCSV  && (UI.dlCSV.onclick  = () => download('leads.csv',  toCSV(S.items||[])));
UI.dlJSON && (UI.dlJSON.onclick = () => download('leads.json', JSON.stringify(S.items||[], null, 2)));

window.addEventListener('beforeunload', () => {
  if (S.items) localStorage.setItem('items', JSON.stringify(S.items));
});