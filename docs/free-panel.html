<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly â€” Free Panel</title>
<script src="./config.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#eaf0ff; --mut:#a6b2c9; --line:#223047; --panel:#0b121d; --card:#0f1624; --pill:#0f1726; }
  *{box-sizing:border-box} body{margin:0;background:#070b12;color:var(--ink);font:500 14px Inter,system-ui}
  .wrap{max-width:1300px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .h{font:800 14px/1.1 Inter;margin-bottom:6px}
  .live-canvas{height:520px;border:1px solid var(--line);border-radius:14px;position:relative;background:radial-gradient(320px 220px at 50% 40%, rgba(220,236,255,.06), transparent 60%), #0a111b;overflow:hidden}
  .neutron{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:280px;height:280px;border-radius:50%;
    background:radial-gradient(circle at 50% 50%, #fff, #9fb6ff 45%, rgba(159,182,255,.06) 46%, transparent 48%),
               radial-gradient(circle, rgba(200,230,255,.25) 30%, transparent 31%);
    box-shadow:0 0 40px rgba(180,210,255,.18) inset}
  .feed{position:absolute;inset:10px;display:flex;flex-direction:column;gap:8px;justify-content:flex-end;pointer-events:none}
  .lead{pointer-events:auto;background:rgba(10,16,28,.86);border:1px solid #2a3955;border-radius:12px;padding:8px 10px;max-width:360px}
  .lead .t{font-weight:700}
  .lead .s{font-size:12px;color:#c8d7f1;opacity:.88}
  .lead .m{font-size:12px;color:#9fb3d7}
  .lead .tag{display:inline-flex;border:1px solid #314565;border-radius:999px;padding:2px 8px;font-size:11px;margin-left:auto;color:#d8e6ff}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .lbl{width:110px;opacity:.85}
  .input{flex:1;background:var(--card);border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px 12px}
  .btn{border-radius:12px;padding:10px 14px;border:1px solid var(--line);background:var(--pill);color:var(--ink);font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#fff,#e6f0ff);color:#0a0e15;border-color:transparent}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(10,16,28,.85)}
  .pv{display:flex;gap:8px;align-items:center;background:rgba(14,20,32,.8);border:1px solid #2b3956;border-radius:10px;padding:6px 8px;margin-top:6px}
  .pv .dot{width:6px;height:6px;border-radius:50%;background:#9fc2ff;box-shadow:0 0 10px rgba(159,194,255,.6)}
  .kv{font-size:12px;opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="box">
      <div class="h">Live results</div>
      <div class="kv" id="quotaL">â€” searches left â€¢ â€” reveals left</div>
      <div class="live-canvas">
        <div class="neutron"></div>
        <div class="feed" id="feed"></div>
      </div>
    </div>

    <div class="box">
      <div class="h">Train your AI</div>
      <div class="row"><div class="lbl">Website</div><input id="f_site" class="input" placeholder="yourcompany.com"></div>
      <div class="row"><div class="lbl">Regions</div><input id="f_regions" class="input" placeholder="US, CA"></div>
      <div class="row"><div class="lbl">Industries</div><input id="f_inds" class="input" placeholder="beverage, confectionery"></div>
      <div class="row"><div class="lbl">Seed buyers</div><input id="f_buyers" class="input" placeholder="brand1.com, brand2.com"></div>
      <div class="row"><div class="lbl">Ideal customers</div><input id="f_desc" class="input" placeholder="materials, order sizes, channels, exclusions"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn primary" id="btnFind">Find now</button>
      </div>
      <div class="kpis">
        <div class="chip">Free <span id="freeCount">0/0</span></div>
        <div class="chip">Pro <span id="proCount">0/0</span> ðŸ”’</div>
      </div>
      <div id="pv"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const uidKey='gal_uid';
  let UID = localStorage.getItem(uidKey);
  if(!UID){ UID='u-'+Math.random().toString(36).slice(2,12); localStorage.setItem(uidKey,UID); }

  function base(){ const def=(window.API_DEFAULT||location.origin).toString().replace(/\/$/,''); return localStorage.getItem('apiBase')||def; }
  const HOST = base().replace(/\/api\/v1$/,''); localStorage.setItem('apiBase', HOST);
  const API = HOST + '/api/v1';
  window.__API__ = { UID, API, HOST };

  async function api(p, opt){
    const o=opt||{}; const h=new Headers(o.headers||{});
    h.set('x-galactly-user', UID); h.set('x-dev-unlim','true');
    const r=await fetch(API + p, { ...o, headers:h, mode:'cors' }); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
  }

  async function status(){
    try{ const j=await api('/status'); const s=j.devUnlimited?'âˆž':(j.quota?.findsLeft??0); const r=j.devUnlimited?'âˆž':(j.quota?.revealsLeft??0);
      document.getElementById('quotaL').textContent = `${s} searches left â€¢ ${r} reveals left`;
    }catch{}
  }
  status(); setInterval(status, 10000);

  document.getElementById('btnSave').onclick = async ()=>{
    try{
      await api('/vault',{ method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({
        website: val('f_site'), regions: val('f_regions'), industries: val('f_inds'), buyers: val('f_buyers'), notes: val('f_desc')
      })});
    }catch{}
  };

  document.getElementById('btnFind').onclick = async ()=>{
    stopSSE();
    try{
      const r = await api('/find-now',{ method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({
        website: val('f_site'), regions: val('f_regions'), industries: val('f_inds'), buyers: val('f_buyers'), notes: val('f_desc')
      })});
      if(r && r.jobId){ startSSE(r.jobId); }
    }catch(e){ alert('Unexpected error.'); }
  };

  function val(id){ return (document.getElementById(id).value||'').trim(); }
})();

/* Preview + live rendering */
const pvBuf=[]; const pvWrap=document.getElementById('pv'); const feed=document.getElementById('feed');
function pushPreview(line){ if(!line) return; pvBuf.push({line,ts:Date.now()}); while(pvBuf.length>6) pvBuf.shift();
  pvWrap.innerHTML = pvBuf.map(p=>`<div class="pv"><span class="dot"></span><span>${esc(p.line)}</span></div>`).join('');
}
const live=[]; const liveMax=12;
function pushLead(ld){ live.push(ld); while(live.length>liveMax) live.shift();
  feed.innerHTML = live.map(x=>`
    <div class="lead">
      <div class="t">${esc(x.title)}</div>
      <div class="s">${esc(x.detail)}</div>
      <div class="m">${esc(x.site||'')}</div>
      <div class="tag">${esc(x.state||'')} â€¢ ${esc(x.channel||'')}</div>
    </div>`).join('');
}
function esc(s){ return String(s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

let es=null;
function startSSE(jobId){
  stopSSE();
  const url = __API__.API + '/progress.sse?job=' + encodeURIComponent(jobId);
  es = new EventSource(url);
  es.onmessage = ev => {
    try{
      const d = JSON.parse(ev.data);
      if(d.type==='step'){
        document.getElementById('freeCount').textContent=`${d.freeDone}/${d.freeTotal}`;
        document.getElementById('proCount').textContent =`${d.proDone}/${d.proTotal} ðŸ”’`;
      }else if(d.type==='preview'){ pushPreview(d.line); }
      else if(d.type==='lead'){ pushLead(d); }
      else if(d.type==='halt'){ stopSSE(); }
    }catch{}
  };
  es.onerror = ()=> stopSSE();
}
function stopSSE(){ try{ es && es.close(); }catch{} es=null; }
</script>
</body>
</html>
