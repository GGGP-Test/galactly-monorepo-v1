<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leads Console — Free Panel (V2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#6b7280; --text:#e5e7eb;
      --chip:#1f2937; --chipBadge:#374151; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --btn:#2563eb; --btnHover:#1d4ed8; --line:#1f2937; --pro:#a78bfa;
      --shadow: 0 8px 24px rgba(0,0,0,.25); --radius:10px;
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-size:18px;margin:0 0 10px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{display:flex;gap:8px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .body{padding:14px 16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .fill{flex:1 1 auto}
    input,select,textarea{width:100%;background:#0b1220;color:var(--text);border:1px solid #223;outline:none;border-radius:8px;padding:10px}
    button{background:var(--btn);border:none;color:#fff;border-radius:8px;padding:10px 14px;cursor:pointer}
    button.secondary{background:#374151} button.warn{background:var(--warn);color:#111} button.pro{background:var(--pro)}
    button:hover{background:var(--btnHover)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px}
    .pill .badge{padding:2px 6px;border-radius:999px;background:var(--chipBadge);font-weight:600}
    .pill.ok{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25)}
    .pill.warn{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.25)}
    .pill.err{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25)}
    .temp{padding:2px 8px;border-radius:999px;font-weight:700}
    .hot{background:rgba(239,68,68,.18);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
    .warm{background:rgba(245,158,11,.18);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .muted{color:var(--muted)}
    .list{max-height:62vh;overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{position:sticky;top:0;background:rgba(17,24,39,.95);backdrop-filter:saturate(140%) blur(6px);text-align:left}
    tr:hover td{background:rgba(255,255,255,.02)}
    .why{display:flex;flex-wrap:wrap;gap:6px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .note{font-size:12px;margin-top:4px}
    .notice{padding:10px 12px;border-radius:8px;background:#0b1220;border:1px dashed #223;margin-top:8px}
    .error{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4)}
    .success{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.4)}
    .link{color:#93c5fd;text-decoration:none}
    .fomo{display:flex;gap:8px;align-items:center;margin-top:6px}
    .fomo .dot{width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 8px #22c55e}
    .ctaRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .small{font-size:12px}
    .disabled{opacity:.55;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leads Console — Free Panel (V2)</h1>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="head row">
          <div class="row fill">
            <input id="baseUrl" class="fill" placeholder="Base URL (e.g. https://p01--animated-cellar--xxxxx.code.run)" />
            <button id="apply">Apply</button>
            <a id="reset" href="#" class="small muted" style="margin-left:8px">Reset panel</a>
          </div>
        </div>
        <div class="body row">
          <input id="apiKey" class="fill" placeholder="API key (optional for read; required for write)" />
          <select id="plan" style="width:140px">
            <option value="free" selected>Free</option>
            <option value="pro">Pro</option>
          </select>
          <button id="saveKey" class="secondary">Save</button>
          <button id="onlyUSCA" class="secondary">US/CA only</button>
          <div class="muted mono" id="quotaChip"></div>
        </div>

        <div class="body row">
          <button id="refreshHot" class="secondary">Refresh Hot</button>
          <button id="refreshWarm" class="secondary">Refresh Warm</button>
          <div class="muted mono">press <b>R</b> to refresh hot</div>
          <div class="fill"></div>
          <div class="muted mono">API: <span id="apiPath">/api/v1/leads</span></div>
        </div>

        <div class="list">
          <table id="leads">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th>Host</th>
                <th style="width:120px">Platform</th>
                <th>Title</th>
                <th style="width:120px">Created</th>
                <th style="width:80px">Temp</th>
                <th style="width:28%">Why / Signals</th>
              </tr>
            </thead>
            <tbody id="leadRows"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head"><div class="row"><div class="pill"><span class="badge">Details</span> Select a lead…</div></div></div>
        <div class="body" id="details"><div class="muted">No lead selected.</div></div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Action</span> Find buyers (from supplier)</div></div></div>
        <div class="body">
          <div class="row">
            <input id="supplier" class="fill" placeholder="supplier domain e.g. stretchandshrink.com" />
          </div>
          <div class="row">
            <select id="region" style="width:160px">
              <option value="us">US</option><option value="ca">CA</option><option value="usca" selected>US/CA</option>
            </select>
            <select id="radius" style="width:120px">
              <option value="25">25 mi</option><option value="50" selected>50 mi</option><option value="100">100 mi</option><option value="250">250 mi</option>
            </select>
            <select id="model" style="width:180px">
              <option value="gx-mini" selected>GX Mini (free)</option>
              <option value="gpt-4o-mini" disabled>GPT-4o mini (Pro)</option>
              <option value="claude-3-haiku" disabled>Claude 3 Haiku (Pro)</option>
              <option value="llama3.1-70b" disabled>Llama 3.1 70B (Pro)</option>
            </select>
            <button id="find" style="min-width:120px">Find buyers</button>
          </div>
          <div id="findMsg" class="note muted"></div>
          <div id="proTease" class="notice" style="display:none">
            <b>Hot leads & claim/lock are Pro-only.</b> Upgrade to see buyers the moment they spike and lock them for your team.
          </div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Supplier persona</span> (human-editable)</div></div></div>
        <div class="body">
          <div class="row">
            <input id="p_offer" class="fill" placeholder="Product/offer — e.g. Stretch film & pallet protection" />
          </div>
          <div class="row" style="margin-top:8px">
            <input id="p_solves" class="fill" placeholder="Solves — e.g. Keeps pallets secure for storage/transport" />
          </div>
          <div class="row" style="margin-top:8px">
            <input id="p_titles" class="fill" placeholder="Buyer titles (comma-separated), e.g. Warehouse Manager, Purchasing Manager" />
            <button id="personaSave" class="secondary">Save persona (local)</button>
          </div>
        </div>

        <div class="head"><div class="row"><div class="pill"><span class="badge">Downloads</span> CSV</div></div></div>
        <div class="body row">
          <button id="dlHot" class="secondary">Download CSV (hot)</button>
          <button id="dlWarm" class="secondary">Download CSV (warm)</button>
        </div>
      </div>
    </div>

    <div id="toast" class="notice" style="margin-top:16px;display:none"></div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    const UI = {
      baseUrl: $('#baseUrl'), apply: $('#apply'), reset: $('#reset'),
      apiKey: $('#apiKey'), plan: $('#plan'), saveKey: $('#saveKey'), onlyUSCA: $('#onlyUSCA'),
      refreshHot: $('#refreshHot'), refreshWarm: $('#refreshWarm'),
      leadRows: $('#leadRows'), details: $('#details'), find: $('#find'),
      supplier: $('#supplier'), region: $('#region'), radius: $('#radius'), model: $('#model'),
      findMsg: $('#findMsg'), quotaChip: $('#quotaChip'), proTease: $('#proTease'),
      p_offer: $('#p_offer'), p_solves: $('#p_solves'), p_titles: $('#p_titles'), personaSave: $('#personaSave'),
      dlHot: $('#dlHot'), dlWarm: $('#dlWarm'), toast: $('#toast')
    };

    const S = {
      baseUrl: localStorage.getItem('baseUrl') || '',
      apiKey: localStorage.getItem('apiKey') || '',
      plan:    localStorage.getItem('plan')   || 'free',
      onlyUSCA: JSON.parse(localStorage.getItem('onlyUSCA')||'true'),
      persona: JSON.parse(localStorage.getItem('persona')||'{"offer":"","solves":"","titles":""}'),
      lastQuota: null
    };

    // init
    UI.baseUrl.value = S.baseUrl;
    UI.apiKey.value  = S.apiKey;
    UI.plan.value    = S.plan;
    UI.onlyUSCA.classList.toggle('warn', !S.onlyUSCA);
    UI.onlyUSCA.textContent = S.onlyUSCA ? 'US/CA only' : 'All regions';
    UI.p_offer.value  = S.persona.offer || '';
    UI.p_solves.value = S.persona.solves || '';
    UI.p_titles.value = S.persona.titles || '';
    UI.proTease.style.display = (S.plan==='free') ? 'block' : 'none';

    function toast(msg, ok=false, err=false){
      UI.toast.textContent = msg;
      UI.toast.className = 'notice ' + (ok?'success':(err?'error':'')); UI.toast.style.display='block';
      setTimeout(()=>UI.toast.style.display='none', 2500);
    }
    const api = path => (S.baseUrl||'').replace(/\/+$/,'') + path;

    async function call(method, path, body){
      const headers = {'Content-Type':'application/json', 'x-plan': S.plan};
      if (S.apiKey) headers['x-api-key'] = S.apiKey;
      const r = await fetch(api(path), {method, headers, body: body?JSON.stringify(body):undefined});
      const text = await r.text();
      try{ return { ok:r.ok, status:r.status, data: JSON.parse(text) }; }
      catch{ return { ok:r.ok, status:r.status, data: text }; }
    }

    function nlWhy(why){
      const chips = [];
      if (!why) return chips;
      for (const k of ['meta','platform','signal','context']){
        const w = why[k]; if (!w) continue;
        chips.push(`<span class="pill">${w.label||k} <span class="badge">${(w.score??'').toFixed?w.score.toFixed(2):w.score}</span> <span class="muted">${w.detail||''}</span></span>`);
      }
      return chips;
    }

    function renderList(items){
      UI.leadRows.innerHTML = '';
      (items||[]).forEach((it,i)=>{
        const host = (it.host||'').replace(/^https?:\/\//,'');
        const href = host ? `https://${host}` : '#';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${i+1}</td>
          <td><a class="link mono" href="${href}" target="_blank">${host}</a></td>
          <td>${it.platform||'news'}</td>
          <td class="mono">${it.title||''}</td>
          <td>${it.created||''}</td>
          <td><span class="temp ${it.temperature||'warm'}">${it.temperature||'warm'}</span></td>
          <td>
            <div class="why">${nlWhy(it.why).join('')}</div>
            ${it.whyText?`<div class="note muted">${it.whyText||''}</div>`:''}
            ${it.fomo? `<div class="fomo"><span class="dot"></span><span class="small muted">Watching now: <b>${it.fomo.watching}</b> &middot; Seen today: <b>${it.fomo.seenTotal}</b></span></div>`:''}
            <div class="ctaRow">
              <button class="secondary" onclick="window.__nextFreeLead()">Get another free lead</button>
              <button class="pro" title="Pro only" onclick="window.__tease()">Deepen (Pro)</button>
              <button class="pro" title="Pro only" onclick="window.__tease()">Claim / lock (Pro)</button>
            </div>
          </td>`;
        tr.onclick = ()=>renderDetails(it);
        UI.leadRows.appendChild(tr);
      });
    }

    function renderDetails(it){
      const host = (it.host||'').replace(/^https?:\/\//,'');
      const href = host ? `https://${host}` : '#';
      UI.details.innerHTML = `
        <div class="row">
          <div class="pill"><span class="badge">Host</span> <a class="link mono" href="${href}" target="_blank">${host}</a></div>
          <div class="pill"><span class="badge">Temp</span> <span class="temp ${it.temperature||'warm'}">${it.temperature||'warm'}</span></div>
          ${it.fomo? `<div class="pill warn"><span class="badge">FOMO</span> Watching:${it.fomo.watching} · Seen:${it.fomo.seenTotal}</div>`:''}
        </div>
        <div class="notice">${it.whyText || 'Signals available in row.'}</div>
      `;
      UI.supplier.value ||= (it && it.host) || '';
    }

    function toTableItems(cands){
      return (cands||[]).map((c,i)=>({
        id: i+1,
        host: c.host || c.domain || '',
        platform: c.source || 'news',
        title: c.title || c.reason || '',
        created: c.created || '',
        temperature: c.temperature || (typeof c.score==='number' && c.score>=0.65?'hot':'warm'),
        why: c.why || null,
        whyText: c.whyText || c.reason || '',
        fomo: c.fomo || null
      }));
    }

    function setQuota(q){
      if (!q) return;
      S.lastQuota = q;
      const left = (q.limit || 0) - (q.used || 0);
      UI.quotaChip.innerHTML = `Leads today: ${q.used||0} / ${q.limit||0} ${q.mix?`<span class="muted">| warm ${q.mix.warm.used}/${q.mix.warm.limit}</span>`:''}`;
      UI.find.disabled = left<=0;
      UI.find.classList.toggle('disabled', left<=0);
    }

    async function refresh(kind){
      const qp = new URLSearchParams();
      qp.set('temp', kind);
      if (S.onlyUSCA) qp.set('region','usca');
      const r = await call('GET', `/api/v1/leads?${qp}`);
      if (!r.ok){ toast(`HTTP ${r.status} — failed to load ${kind} leads`, false, true); return; }
      renderList(r.data?.items||[]);
      toast(`Loaded ${ (r.data?.items||[]).length } ${kind} lead(s)`, true);
    }

    async function findOne(){
      const supplier = UI.supplier.value.trim().toLowerCase();
      if (!supplier){ toast('Enter a supplier domain', false, true); return; }
      const body = {
        supplier, region: UI.region.value, radiusMi: Number(UI.radius.value||'50')||50,
        persona: { offer:UI.p_offer.value.trim(), solves:UI.p_solves.value.trim(), titles:UI.p_titles.value.trim() },
        onlyUSCA: S.onlyUSCA, llm: UI.model.value
      };
      UI.find.disabled = true; UI.findMsg.textContent = 'Finding buyers…';
      const r = await call('POST','/api/v1/leads/find-buyers', body);
      UI.find.disabled = false;
      if (!r.ok){
        UI.findMsg.innerHTML = `<div class="notice error mono">HTTP ${r.status} — ${typeof r.data==='string'?r.data:JSON.stringify(r.data)}</div>`;
        return;
      }
      if (r.data && r.data.quota) setQuota(r.data.quota);

      if (!r.data.ok){
        const err = r.data.error || 'Unknown';
        UI.findMsg.innerHTML = `<div class="notice error mono">${err==='DAILY_LIMIT'?'Daily limit reached — upgrade for more & hot leads.':err}</div>`;
        return;
      }
      const items = toTableItems(r.data?.candidates||[]);
      UI.findMsg.innerHTML = `<div class="notice success mono">Created ${items.length} candidate(s). Free returns 1 lead/click (warm). ${r.data.quota?`Remaining today: ${(r.data.quota.limit - r.data.quota.used)}`:''}</div>`;
      renderList(items);
    }

    // events & helpers
    UI.apply.onclick = ()=>{ S.baseUrl = UI.baseUrl.value.trim(); localStorage.setItem('baseUrl', S.baseUrl); toast('Base URL applied', true); };
    UI.reset.onclick = (e)=>{ e.preventDefault(); localStorage.clear(); location.reload(); };
    UI.saveKey.onclick = ()=>{ S.apiKey = UI.apiKey.value.trim(); S.plan = UI.plan.value; localStorage.setItem('apiKey', S.apiKey); localStorage.setItem('plan', S.plan); UI.proTease.style.display=(S.plan==='free')?'block':'none'; toast('Saved', true); };
    UI.onlyUSCA.onclick = ()=>{ S.onlyUSCA=!S.onlyUSCA; localStorage.setItem('onlyUSCA', JSON.stringify(S.onlyUSCA)); UI.onlyUSCA.classList.toggle('warn', !S.onlyUSCA); UI.onlyUSCA.textContent = S.onlyUSCA ? 'US/CA only' : 'All regions'; };
    UI.refreshHot.onclick = ()=>refresh('hot');
    UI.refreshWarm.onclick = ()=>refresh('warm');
    document.addEventListener('keydown', e=>{ if (e.key==='r' || e.key==='R') refresh('hot'); });
    UI.personaSave.onclick = ()=>{ S.persona = { offer:UI.p_offer.value.trim(), solves:UI.p_solves.value.trim(), titles:UI.p_titles.value.trim() }; localStorage.setItem('persona', JSON.stringify(S.persona)); toast('Persona saved locally', true); };
    UI.find.onclick = findOne;

    // global helpers for row CTAs
    window.__nextFreeLead = ()=>findOne();
    window.__tease = ()=>toast('Pro feature — upgrade to unlock', false, true);

    // default auto-load
    if (S.baseUrl) refresh('warm');
  </script>
</body>
</html>