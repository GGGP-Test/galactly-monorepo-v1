<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leads Console</title>
<style>
  :root{--bg:#0f172a;--panel:#121a2b;--muted:#9aa4b2;--fg:#e6edf3;--blue:#3b82f6;--green:#10b981;--red:#ef4444;--chip:#1f2937;}
  *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  body{margin:0;background:var(--bg);color:var(--fg)}
  .wrap{max-width:1160px;margin:28px auto;padding:0 16px}
  h1{font-size:18px;margin:0 0 12px 0;font-weight:600}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .input,select,button{background:#0b1220;color:var(--fg);border:1px solid #263247;border-radius:8px;padding:10px 12px;font-size:14px;outline:none}
  .input::placeholder{color:#6b7280}
  button{cursor:pointer}
  .btn{background:var(--blue);border-color:#2c64c2}
  .btn.secondary{background:#1f2937;border-color:#263247}
  .btn.good{background:var(--green);border-color:#0d7a61}
  .btn.bad{background:var(--red);border-color:#b91c1c}
  .grid{display:grid;grid-template-columns:1.2fr .9fr;gap:16px;margin-top:14px}
  .card{background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:12px}
  .split{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{font-size:13px;padding:8px 10px;text-align:left}
  thead tr th{color:#a8b3c2;font-weight:600}
  tbody tr{background:#0b1220}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);font-size:12px}
  .muted{color:var(--muted)}
  .note{font-size:12px;color:#97a4b3}
  .stack{display:flex;flex-direction:column;gap:8px}
  .rowm{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .status{min-height:24px;font-size:12px;margin-top:6px}
  .right{display:flex;justify-content:flex-end}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #263247;padding:1px 6px;border-radius:6px;font-size:12px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .why{display:grid;grid-template-columns: 1fr auto;gap:8px}
  .border{border:1px solid #263247;border-radius:8px;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Leads Console</h1>

  <!-- Top controls -->
  <div class="card">
    <div class="row">
      <div class="grow">
        <div class="row" style="gap:8px">
          <input id="base" class="input grow" placeholder="Base URL e.g. https://p01--animated-cellar--xxxxx.code.run/" />
          <button id="apply" class="btn">Apply</button>
          <span class="note">Tip: host this file from the same domain as the API to avoid CORS.</span>
        </div>
      </div>
      <div class="row" style="gap:8px">
        <input id="apikey" class="input" style="width:380px" placeholder="API key (needed for write actions)" />
        <button id="savekey" class="btn secondary">Save</button>
        <button id="clearkey" class="btn secondary">Clear</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Left column: lists -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btnHot"  class="btn secondary">Refresh Hot</button>
          <button id="btnWarm" class="btn secondary">Refresh Warm</button>
          <span id="listInfo" class="note"></span>
          <span class="note">press <span class="kbd">R</span> to refresh hot</span>
        </div>
        <span class="note">API: <code>/api/v1/leads</code></span>
      </div>
      <div style="margin-top:8px;overflow:auto;max-height:480px">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Host</th><th>Platform</th><th>Title</th><th>Created</th><th>Temp</th><th>Why</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <!-- Right column: details + find buyers -->
    <div class="card stack">
      <div class="stack">
        <div class="row" style="justify-content:space-between">
          <div><strong>Details</strong></div>
          <div id="selInfo" class="note"></div>
        </div>
        <div id="details" class="border">
          <span class="note">Select a lead…</span>
        </div>
      </div>

      <div class="stack">
        <strong>Find buyers (from supplier)</strong>
        <div class="split">
          <input id="supplier" class="input" placeholder="supplier domain e.g. acme-packaging.com (required)"/>
          <input id="kw" class="input" placeholder="keywords (optional) e.g. rfp, packaging"/>
        </div>

        <div class="split">
          <input id="regions" class="input" placeholder="regions (optional) e.g. US, CA, UK"/>
          <input id="industries" class="input" placeholder="industries (optional) e.g. beverage, cosmetics"/>
        </div>

        <div class="split">
          <input id="personas" class="input" placeholder="buyer personas (optional) e.g. procurement, ops"/>
          <input id="limit" class="input" placeholder="limit (default 12)" />
        </div>

        <div class="right">
          <button id="ingest" class="btn good">Find buyers</button>
        </div>
        <div id="ingestStatus" class="status note"></div>
      </div>

      <div class="stack">
        <strong>Download CSV</strong>
        <div class="row" style="gap:8px">
          <button id="csvHot" class="btn secondary">Download CSV (hot)</button>
          <button id="csvWarm" class="btn secondary">Download CSV (warm)</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const rowsEl = $("rows");
  const detailsEl = $("details");
  const listInfo = $("listInfo");
  const ingestStatus = $("ingestStatus");

  // Persist base URL + API key in localStorage
  const LS = {
    base: "packlead.base",
    key:  "packlead.key"
  };

  function normBase(u){
    u = (u||"").trim();
    if(!u) return "";
    if(!u.endsWith("/")) u+="/";
    return u;
  }

  function api(path){ return normBase($("base").value) + path.replace(/^\//,""); }
  function key(){ return $("apikey").value.trim(); }

  // Load persisted
  $("base").value   = localStorage.getItem(LS.base) || "";
  $("apikey").value = localStorage.getItem(LS.key)  || "";

  $("apply").onclick = () => {
    localStorage.setItem(LS.base, normBase($("base").value));
    flash(ingestStatus, "Base URL saved.", "ok");
  };
  $("savekey").onclick = () => { localStorage.setItem(LS.key, key()); flash(ingestStatus, "API key saved.", "ok"); };
  $("clearkey").onclick = () => { localStorage.removeItem(LS.key); $("apikey").value=""; flash(ingestStatus, "API key cleared.", "warn"); };

  // Keyboard R to refresh hot
  window.addEventListener("keydown", (e)=>{ if(e.key==="r"||e.key==="R") loadList("hot"); });

  $("btnHot").onclick  = () => loadList("hot");
  $("btnWarm").onclick = () => loadList("warm");

  $("csvHot").onclick  = () => dlCSV("hot");
  $("csvWarm").onclick = () => dlCSV("warm");

  $("ingest").onclick  = onFind;

  function flash(el, msg, kind){
    el.textContent = msg;
    el.style.color = kind==="ok" ? "#86efac" : kind==="warn" ? "#f59e0b" : "#fda4af";
    setTimeout(()=>{ el.textContent=""; el.style.color=""; }, 2600);
  }

  async function loadList(kind){
    rowsEl.innerHTML = "";
    listInfo.textContent = "Loading…";
    try{
      const res = await fetch(api(`/api/v1/leads/${kind}?limit=50`));
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const items = data.items || [];
      listInfo.textContent = `Loaded ${items.length} ${kind} lead(s).`;
      for(const it of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${it.host}</td>
          <td>${it.platform || "unknown"}</td>
          <td>${escapeHtml(it.title||"")}</td>
          <td>${fmtTime(it.created_at)}</td>
          <td><span class="pill">${it.temperature}</span></td>
          <td>${(it.why||[]).map(w => `<span class="pill">${w.label}</span>`).join(" ")}</td>
        `;
        tr.onclick = ()=>showDetails(it.id);
        rowsEl.appendChild(tr);
      }
    }catch(err){
      listInfo.textContent = `Error: ${err.message||err}`;
    }
  }

  async function showDetails(id){
    $("selInfo").textContent = `ID ${id}`;
    try{
      const res = await fetch(api(`/api/v1/leads/${id}`));
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const lead = data.lead || data.item || data;
      detailsEl.innerHTML = renderDetails(lead);
    }catch(err){
      detailsEl.innerHTML = `<span class="note">Failed: ${escapeHtml(err.message||String(err))}</span>`;
    }
  }

  function renderDetails(lead){
    const why = (lead.why||[]).map(w=>`
      <div class="why"><div class="muted">${escapeHtml(w.label)} <span class="muted">(${escapeHtml(w.kind)})</span></div>
      <div class="muted">${(w.score??"").toFixed? w.score.toFixed(2): w.score}</div></div>
      <div class="note" style="margin-bottom:6px">${escapeHtml(w.detail||"")}</div>
    `).join("");
    return `
      <div class="chips" style="margin-bottom:6px">
        <span class="pill">ID ${lead.id}</span>
        <span class="pill">${escapeHtml(lead.host)}</span>
        <span class="pill">${escapeHtml(lead.platform||"unknown")}</span>
        <span class="pill">${escapeHtml(lead.temperature||"")}</span>
      </div>
      <div class="muted">Created ${fmtTime(lead.created_at)}</div>
      <div style="margin:8px 0"><strong>Title</strong><div>${escapeHtml(lead.title||"")}</div></div>
      <div><strong>Why</strong></div>
      <div class="border">${why || '<span class="note">—</span>'}</div>
    `;
  }

  async function onFind(){
    const supplier = $("supplier").value.trim();
    const keywords = $("kw").value.trim();
    const personas = $("personas").value.trim();
    const regions  = $("regions").value.trim();
    const industries = $("industries").value.trim();
    const limit = Number($("limit").value.trim()) || undefined;
    if(!supplier){ flash(ingestStatus,"Supplier domain is required.","warn"); return; }

    const payload = {
      supplierDomain: supplier,
      keywords: keywords || undefined,
      personas: personas || undefined,
      regions: regions || undefined,
      industries: industries || undefined,
      limit
    };

    try{
      ingestStatus.textContent = "Working…";
      const res = await fetch(api(`/api/v1/leads/find`), {
        method:"POST",
        headers: {
          "Content-Type":"application/json",
          ...(key()? {"x-api-key": key()}: {})
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok){
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      const created = (data.ids || []).length;
      const skipped = data.skipped || 0;
      const errs = data.errors || 0;
      const temp = data.temperature || "";
      flash(ingestStatus, `Created ${created} candidate(s). Skipped ${skipped} duplicate(s). Errors ${errs}. Refresh lists to view.`, "ok");
      // small nudge: if keywords include rfp/rfq, hot list is likely to change
      if((payload.keywords||"").match(/\brfp|rfq|tender\b/i)) loadList("hot"); else loadList("warm");
    }catch(err){
      flash(ingestStatus, `Failed: ${err.message||err}`, "bad");
    }
  }

  function fmtTime(iso){
    if(!iso) return "";
    try{
      const d = new Date(iso);
      return d.toLocaleString();
    }catch{ return iso; }
  }

  function dlCSV(kind){
    const url = api(`/api/v1/leads/export.csv?temperature=${encodeURIComponent(kind)}&limit=100`);
    const a = document.createElement("a");
    a.href = url; a.download = `leads_${kind}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // Initial list
  loadList("hot");
})();
</script>
</body>
</html>
