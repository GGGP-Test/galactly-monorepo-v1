<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Leads Console — Free Panel (V3)</title>
<style>
  :root{
    --bg:#0f1520; --panel:#111927; --muted:#7a8aa0; --fg:#e6edf3; --accent:#4f8cff;
    --ok:#1db954; --warn:#ffcf5a; --bad:#ff6b6b; --chip:#223047;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:0 0 12px 0}
  main{display:grid;grid-template-columns:minmax(340px,460px) 1fr;gap:16px;align-items:start}
  .panel,.results{background:var(--panel);border-radius:8px;padding:14px}
  label{display:block;margin:10px 0 6px;color:var(--muted);font-weight:600}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid #203044;border-radius:8px;background:#0b1220;color:var(--fg);outline:none}
  input:focus,select:focus,textarea:focus{border-color:#2d4766;box-shadow:0 0 0 2px #1b2b42}
  textarea.log{min-height:130px;white-space:pre-wrap;font-family:ui-monospace,Consolas,Monaco,monospace}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:1fr 1fr auto;gap:8px}
  .btn{padding:10px 14px;border-radius:8px;border:1px solid #254163;background:#152234;color:var(--fg);cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:var(--accent);border-color:#4176d6}
  .btn.ghost{background:#0b1220;border-color:#203044}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{background:var(--chip);border-radius:999px;padding:4px 10px;color:#b9c6d7;font-size:12px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #203044;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  th{font-weight:700;color:#a9b7c7}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:900px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Leads Console — Free Panel (V3)</h1>
  <main>
    <!-- LEFT: controls -->
    <section class="panel">
      <label>API base</label>
      <div class="row">
        <input id="base" placeholder="https://p01--your-app.code.run" />
        <button class="btn primary" id="apply">Apply</button>
      </div>

      <div class="grid2" style="margin-top:8px">
        <div>
          <label>API root (prefixed to paths)</label>
          <input id="root" placeholder="(blank for /leads/* at root)" />
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="toolbar">
            <button class="btn ghost" id="health">Health</button>
            <button class="btn ghost" id="probe">Probe</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:8px">
        <div>
          <label>API key (optional for read; required for write)</label>
          <input id="apiKey" placeholder="paste key" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn" id="saveKey">Save</button>
        </div>
      </div>

      <div class="chips" id="chips"></div>

      <hr style="border:0;border-top:1px solid #203044;margin:16px 0" />

      <label>Action</label>
      <div class="muted" style="margin:-4px 0 8px">Find buyers (one per click)</div>

      <label>Supplier host</label>
      <input id="host" placeholder="example.com" />

      <div class="grid2">
        <div>
          <label>Region / Radius</label>
          <div class="grid2">
            <select id="region">
              <option>US/CA</option><option>US/NY</option><option>US/TX</option>
              <option>US/FL</option><option>US/IL</option>
            </select>
            <select id="radius">
              <option>25 mi</option><option selected>50 mi</option><option>100 mi</option>
            </select>
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="find">Find buyers</button>
        </div>
      </div>

      <div class="grid3" style="margin-top:8px">
        <div>
          <label>Find Buyers path (relative to API root)</label>
          <input id="path" value="/leads/find-buyers" />
        </div>
        <div>
          <label>Method</label>
          <select id="method">
            <option selected>GET</option>
            <option>POST</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <select id="fallbackMode" title="When a request returns 404">
            <option value="probe">Auto-probe on 404</option>
            <option value="off" selected>No fallbacks</option>
          </select>
        </div>
      </div>

      <label style="margin-top:12px">HTTP log</label>
      <textarea class="log" id="log" readonly></textarea>

      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="dlHot">Download CSV (hot)</button>
        <button class="btn" id="dlWarm">Download CSV (warm)</button>
        <button class="btn" id="clearList">Clear list</button>
      </div>
    </section>

    <!-- RIGHT: results -->
    <section class="results">
      <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="muted">Results</div>
        <div class="muted" id="count">0 items</div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Host</th>
              <th>Platform</th>
              <th>Title</th>
              <th>Created</th>
              <th>Temp</th>
              <th>Why (human-readable)</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
/* ----------------- state & utils ----------------- */
const UI = {
  base:      document.getElementById('base'),
  root:      document.getElementById('root'),
  apiKey:    document.getElementById('apiKey'),
  apply:     document.getElementById('apply'),
  saveKey:   document.getElementById('saveKey'),
  health:    document.getElementById('health'),
  probe:     document.getElementById('probe'),
  host:      document.getElementById('host'),
  region:    document.getElementById('region'),
  radius:    document.getElementById('radius'),
  path:      document.getElementById('path'),
  method:    document.getElementById('method'),
  fallback:  document.getElementById('fallbackMode'),
  find:      document.getElementById('find'),
  log:       document.getElementById('log'),
  chips:     document.getElementById('chips'),
  count:     document.getElementById('count'),
  rows:      document.getElementById('rows'),
  dlHot:     document.getElementById('dlHot'),
  dlWarm:    document.getElementById('dlWarm'),
  clearList: document.getElementById('clearList'),
};

const S = {
  items: JSON.parse(localStorage.getItem('items')||'[]')
};

function savePrefs(){
  localStorage.setItem('base', UI.base.value.trim());
  localStorage.setItem('root', UI.root.value.trim());
  localStorage.setItem('path', UI.path.value.trim());
  localStorage.setItem('method', UI.method.value);
  localStorage.setItem('apiKey', UI.apiKey.value.trim());
}

function loadPrefs(){
  UI.base.value   = localStorage.getItem('base')   || '';
  UI.root.value   = localStorage.getItem('root')   || '';
  UI.path.value   = localStorage.getItem('path')   || '/leads/find-buyers';
  UI.method.value = localStorage.getItem('method') || 'GET';
  UI.apiKey.value = localStorage.getItem('apiKey') || '';
  renderChips();
  renderList();
}

function logLine(s){ 
  const now = new Date().toISOString().slice(11,19);
  UI.log.value += (UI.log.value ? "\n" : "") + `[${now}] ${s}`;
  UI.log.scrollTop = UI.log.scrollHeight;
}

function chip(txt, cls=''){ 
  const el = document.createElement('span'); 
  el.className = 'chip ' + cls; el.textContent = txt; 
  return el;
}
function renderChips(){
  UI.chips.innerHTML = '';
  UI.chips.append(
    chip(`health: ${S.health||'n/a'}`,(S.health||'').startsWith('200')?'ok':''),
    chip(`routes: ${S.routes||'n/a'}`),
    chip(`last OK: ${S.lastOK||'n/a'}`)
  );
}

/* make absolute URL from base/root/path */
function makeURL(path){
  const base = (UI.base.value||'').replace(/\/+$/,'');
  const root = (UI.root.value||'').replace(/^\/?/,'').replace(/\/+$/,'');
  const p    = (path||'').replace(/^\/+/,'');
  return root ? `${base}/${root}/${p}` : `${base}/${p}`;
}

/* GET/POST helper (adds apiKey header if present) */
async function http(method, url, body){
  const headers = {};
  const key = UI.apiKey.value.trim();
  if (key) headers['x-api-key'] = key;
  if (method === 'POST') headers['content-type'] = 'application/json';
  const r = await fetch(url, { method, headers, body });
  return r;
}

/* CSV utils */
function toCSV(items){
  const cols = ['host','platform','title','created','temp','why'];
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const head = cols.join(',');
  const rows = items.map(it=>cols.map(c=>esc(it[c])).join(','));
  return [head,...rows].join('\r\n');
}
function download(name, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'text/csv'}));
  a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

/* list render */
function renderList(){
  UI.rows.innerHTML = '';
  S.items.forEach((x,i)=>{
    const tr = document.createElement('tr');
    const td = (...t)=>{ const d=document.createElement('td'); d.textContent=t[0]??''; return d; };
    tr.append(td(i+1), td(x.host), td(x.platform||''), td(x.title||''), td(x.created||''), td(x.temp||''), td(x.why||''));
    UI.rows.append(tr);
  });
  UI.count.textContent = `${S.items.length} items`;
}

/* normalize API response into list items */
function normalize(resp, ctx){
  const items = [];
  const push = (h)=>items.push({
    host:h.host||h.domain||h.site||ctx.host||'',
    platform:h.platform||'web',
    title:h.title||h.name||`Buyer lead for ${h.host||ctx.host||''}`,
    created:h.created||new Date().toISOString(),
    temp:h.temp||'warm',
    why:h.why||`Compat shim matched (${ctx.region}, ${ctx.radius})`
  });
  if (Array.isArray(resp?.items)) resp.items.forEach(push);
  else if (resp?.host || resp?.domain) push(resp);
  return items;
}

/* ----------------- feature: health & probe ----------------- */
async function runHealth(){
  try{
    const url = makeURL('healthz');
    const r = await http('GET', url);
    S.health = `${r.status}  — GET /healthz`;
    logLine(S.health);
    if (r.ok) { S.lastOK = 'GET /healthz @ (root)'; renderChips(); }
  }catch(e){ logLine('health error: '+e.message); }
}

async function runRoutesSample(){
  try{
    const r = await http('GET', makeURL('routes'));
    S.routes = `${r.status}  — GET /routes`;
    logLine(S.routes);
    if (r.ok){
      const sample = await r.text();
      logLine(`routes sample: ${sample.slice(0,120)}…`);
      S.lastOK = 'GET /routes @ (root)';
      renderChips();
    }
  }catch(e){ logLine('routes error: '+e.message); }
}

/* probe only when asked */
async function probeRootsOnce(){
  const roots = ['', 'api']; // minimal, quiet
  for (const candidate of roots){
    UI.root.value = candidate;
    const r = await http('GET', makeURL('routes'));
    logLine(`${r.status}  — GET /routes @ ${candidate?'/'+candidate:'(root)'}`);
    if (r.ok){ 
      S.lastOK = r.status+' OK @ '+(candidate?'/'+candidate:'(root)');
      renderChips();
      savePrefs();
      return true;
    }
  }
  return false;
}

/* ----------------- feature: find buyers (one per click) ----------------- */
async function findOne(){
  const host = UI.host.value.trim();
  const region = UI.region.value;
  const radius = UI.radius.value;
  const path = UI.path.value.trim() || '/leads/find-buyers';
  const method = UI.method.value;

  const build = ()=> {
    const url = new URL(makeURL(path));
    if (method === 'GET'){
      url.searchParams.set('host', host);
      url.searchParams.set('region', region);
      url.searchParams.set('radius', radius);
    }
    return url.toString();
  };

  const req = async ()=>{
    const url = build();
    let r = await http(method, url, method==='POST' ? JSON.stringify({host,region,radius}) : undefined);
    if (r.status === 404 && UI.fallback.value === 'probe'){
      logLine('404  — starting probe for correct root/path…');
      const ok = await probeRootsOnce();
      if (ok){ r = await http(method, build(), method==='POST' ? JSON.stringify({host,region,radius}) : undefined); }
    }
    return r;
  };

  const r = await req();
  logLine(`${r.status}  — ${method} ${new URL(build()).pathname}${method==='GET' ? ('?'+new URL(build()).searchParams.toString()) : ''}`);
  if (!r.ok){ logLine(await r.text().catch(()=>'')); return; }

  const data = await r.json().catch(()=>null);
  const items = normalize(data, {host,region,radius});
  if (items.length){
    S.items.push(items[0]);
    localStorage.setItem('items', JSON.stringify(S.items));
    renderList();
  }
}

/* ----------------- wire up ----------------- */
UI.apply.onclick = ()=>{ savePrefs(); logLine('Base applied'); };
UI.saveKey.onclick = ()=>{ savePrefs(); logLine('API key saved'); };
UI.health.onclick = runHealth;
UI.probe.onclick = probeRootsOnce;
UI.find.onclick = findOne;

UI.dlHot.onclick = ()=> download(`buyers-hot-${Date.now()}.csv`, toCSV(S.items));
UI.dlWarm.onclick = ()=> download(`buyers-warm-${Date.now()}.csv`, toCSV(S.items)); // same list here; warm cache would be backend-driven
UI.clearList.onclick = ()=>{ S.items=[]; localStorage.setItem('items','[]'); renderList(); };

loadPrefs();
/* First-run: quick health + routes sample (quiet, single call each) */
(async()=>{ await runHealth(); await runRoutesSample(); })();
</script>
</body>
</html>