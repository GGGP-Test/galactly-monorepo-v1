<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Galactly — Free Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#eaf0ff; --mut:#a6b2c9; --line:#1e2737; --card:#0f1420; --panel:#0b101a; --pill:#10182a;
  --accent:#86f7d6; --accent2:#6fb3ff; --ok:#7fffd4; --bad:#ff8a8a; --warn:#ffd27f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--ink);background:linear-gradient(180deg,#0a0e16,#06080e);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
.wrap{max-width:1280px;margin:0 auto;padding:20px 16px 60px}

/* Layout */
.grid{display:grid;grid-template-columns:1.15fr .95fr;gap:16px}
@media (max-width:1080px){ .grid{grid-template-columns:1fr} }

.card{background:#0f1420;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0b111b,#0a0e15)}
.hdr h3{margin:0;font:800 15px/1 Inter,system-ui}
.dim{font-size:12px;color:#cfe0ff;opacity:.85}

/* Left — Live results */
.live{min-height:480px;display:flex;flex-direction:column}
.live-body{padding:12px;height:520px;overflow:auto}
.live-body::-webkit-scrollbar{width:8px}
.live-body::-webkit-scrollbar-thumb{background:#23314d;border-radius:6px}
.live-list{display:flex;flex-direction:column}

/* Signal card */
.sig-card{border:1px solid #26314a;border-radius:12px;padding:12px;margin:8px 0;background:#0d1421}
.sig-title{font-weight:800;margin-bottom:4px}
.sig-sub{opacity:.92;margin:4px 0 8px}
.sig-buyer a{color:#9ec8ff;text-decoration:none}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.chip{font-size:12px;border:1px solid #2b3853;border-radius:999px;padding:4px 8px;background:#0b1322}
.why{display:none;margin-top:8px;font-size:13px;opacity:.95}
.why-src{display:inline-block;margin-top:6px}
.why-conf{opacity:.8;margin-top:4px}
.sig-card.show-why .why{display:block}
.why-toggle{margin-top:8px;border:1px solid #2b3853;background:#0b1322;color:#cfe0ff;border-radius:8px;padding:6px 10px;cursor:pointer}

/* Right — Train AI + Preview */
.pane{display:flex;flex-direction:column;min-height:520px}
.cfg{padding:12px;display:grid;grid-template-columns:1fr;gap:10px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.label{font-size:12px;opacity:.9;margin:0 0 6px}
.input,textarea{width:100%;background:#0f1420;border:1px solid var(--line);color:#e9eef7;border-radius:10px;padding:10px 12px;font:500 13px Inter,system-ui}
textarea{resize:vertical;min-height:64px}
.actions{display:flex;gap:10px;align-items:center}
.btn{border-radius:12px;padding:10px 14px;font:700 14px Inter; background:var(--pill); border:1px solid var(--line); color:var(--ink); cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#fff,#e6efff);color:#0b111b;border-color:transparent}
.small{font-size:12px;opacity:.85}
.preview{flex:1;border-top:1px solid var(--line);padding:10px 12px}

/* Upgrade banner */
.upgrade{margin:12px 0;border:1px dashed #35507c;background:#0c1527;border-radius:12px;padding:12px}
.upgrade h4{margin:0 0 8px;font:800 14px Inter}
.upgrade ul{margin:8px 0 0 18px;padding:0}
.upgrade li{margin:4px 0}
.upgrade .cta{margin-top:10px}

/* Launch overlay */
.launch{position:fixed;inset:0;background:rgba(6,10,18,.76);display:none;align-items:center;justify-content:center;z-index:50}
.launch.in{display:flex}
.launch-box{width:min(560px,92vw);background:#0f1420;border:1px solid var(--line);border-radius:14px;padding:18px}
.launch h4{margin:0 0 8px;font:800 16px Inter}
.progress{height:6px;border-radius:6px;background:#0b1320;border:1px solid #1f2d46;overflow:hidden}
.progress>div{height:100%;width:0;background:linear-gradient(90deg,#86f7d6,#6fb3ff)}
.steps{font-size:13px;opacity:.95;margin:10px 0 0}
.step{display:flex;align-items:center;gap:8px;margin:6px 0}
.dot{width:8px;height:8px;border-radius:50%;background:#3a4d75}
.step.active .dot{background:#86f7d6;box-shadow:0 0 6px #86f7d6}
.err{color:var(--bad);font-size:12px;margin-top:6px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- LEFT: live results -->
    <section class="card live">
      <div class="hdr">
        <h3>Live results</h3>
        <div class="dim" id="quotaLbl">∞ searches left • ∞ reveals left</div>
      </div>
      <div class="live-body">
        <div id="liveList" class="live-list"></div>
      </div>
    </section>

    <!-- RIGHT: configure + preview -->
    <section class="card pane">
      <div class="hdr">
        <h3>Train your AI</h3>
        <div class="dim" id="quotaHdr">—</div>
      </div>

      <div class="cfg">
        <div>
          <div class="label">Website</div>
          <input id="ai_site" class="input" placeholder="yourcompany.com"/>
        </div>
        <div class="row2">
          <div>
            <div class="label">Regions</div>
            <input id="ai_regions" class="input" placeholder="US, CA"/>
          </div>
          <div>
            <div class="label">Industries</div>
            <input id="ai_inds" class="input" placeholder="beverage, confectionery"/>
          </div>
        </div>
        <div>
          <div class="label">Seed buyers (domains)</div>
          <input id="ai_buyers" class="input" placeholder="brand1.com, brand2.com"/>
        </div>
        <div>
          <div class="label">Describe ideal customers</div>
          <textarea id="ai_notes" class="input" placeholder="materials, order sizes, channels, exclusions"></textarea>
        </div>
        <div class="actions">
          <button id="btn_save" class="btn">Save</button>
          <button id="btn_find" class="btn primary">Find now</button>
          <span class="small" id="cfg_hint">Loaded from onboarding. Tweak & run.</span>
        </div>
        <div class="err" id="cfg_err"></div>
      </div>

      <div class="hdr">
        <h3>Signals Preview (report)</h3>
        <div class="dim" id="ctrLbl">Free 0/0 • Pro 0/0</div>
      </div>
      <div class="preview" id="previewBox">
        <div class="small" id="previewEmpty">Waiting for your first run…</div>
      </div>
    </section>
  </div>
</div>

<!-- Launch overlay -->
<div class="launch" id="launch">
  <div class="launch-box">
    <h4 id="launchTitle">Launching real-time intent search…</h4>
    <div class="progress"><div id="launchBar"></div></div>
    <div class="steps" id="launchSteps">
      <div class="step"><span class="dot"></span>Probing public feeds</div>
      <div class="step"><span class="dot"></span>Reading procurement + RFPs</div>
      <div class="step"><span class="dot"></span>Scanning retailer pages</div>
      <div class="step"><span class="dot"></span>Extracting quantities & materials</div>
      <div class="step"><span class="dot"></span>Cross-checking signals</div>
      <div class="step"><span class="dot"></span>Ranking by fit</div>
    </div>
  </div>
</div>

<!-- optional config.js gets picked up automatically if present -->
<script>
/* ---------- API base helpers ---------- */
function apiBase(){
  // honor config.js if you ship it
  const fromCfg = (window.API_DEFAULT||'').replace(/\/$/,'');
  const stored  = (localStorage.getItem('apiBase')||'').replace(/\/$/,'');
  if (stored) return stored;
  if (fromCfg) return fromCfg;
  // fallback local
  return (location.origin.replace(/\/$/,'')) + '/api/v1';
}
const API = apiBase();

/* ---------- Prefill from onboarding ---------- */
(function prefill(){
  const g = s=>localStorage.getItem(s)||'';
  const site = g('onb_vendor') || g('onb_site') || '';
  const regs = g('onb_regions')||'';
  const inds = g('onb_industries')||'';
  const buys = g('onb_buyers')||'';
  const desc = g('onb_desc')||'';
  if(site) document.getElementById('ai_site').value = site;
  if(regs) document.getElementById('ai_regions').value = regs;
  if(inds) document.getElementById('ai_inds').value = inds;
  if(buys) document.getElementById('ai_buyers').value = buys;
  if(desc) document.getElementById('ai_notes').value = desc;
})();

/* ---------- UX: launch overlay for Free ---------- */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function showLaunch(minMs=7000, maxMs=15000){
  const el = document.getElementById('launch');
  const bar = document.getElementById('launchBar');
  const steps = [...document.querySelectorAll('#launchSteps .step')];
  el.classList.add('in');
  let t=0, dur = Math.floor(minMs + Math.random()*(maxMs-minMs));
  const start=performance.now();
  function tick(){
    const p = Math.min(1, (performance.now()-start)/dur);
    bar.style.width = (p*100)+'%';
    const activeIdx = Math.floor(p*steps.length);
    steps.forEach((s,i)=> s.classList.toggle('active', i<=activeIdx));
    if(p<1) requestAnimationFrame(tick);
  }
  tick();
  await sleep(dur);
  el.classList.remove('in');
}

/* ---------- Preview + Upgrade banner ---------- */
function pushPreviewLine(text){
  const box=document.getElementById('previewBox');
  document.getElementById('previewEmpty')?.remove();
  const line=document.createElement('div');
  line.className='small';
  line.textContent=text;
  box.prepend(line);
  while(box.children.length>24) box.lastElementChild.remove();
}
function showUpgradeBanner(){
  const box=document.getElementById('previewBox');
  const b=document.createElement('div');
  b.className='upgrade';
  b.innerHTML=`
    <h4>Make this run 24/7 — upgrade to Pro</h4>
    <ul>
      <li>Background scans 24/7 — no button press needed</li>
      <li>Alerts only when a lead matches <em>your standards</em></li>
      <li>Higher volume and faster refresh windows</li>
      <li><strong>BYLI™</strong> — upload 2K–100K targets for watchlists</li>
      <li>CRM / ERP actions (Quote, Email, SMS, Call, ERP updates)</li>
    </ul>
    <div class="cta">
      <a class="btn primary" href="/upgrade" target="_blank" rel="noopener">Upgrade to Pro</a>
    </div>`;
  box.prepend(b);
}

/* ---------- Human chips + Why this + Card rendering ---------- */
const REGION_NAMES = {
  AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California", CO:"Colorado",
  CT:"Connecticut", DE:"Delaware", FL:"Florida", GA:"Georgia", HI:"Hawaii", ID:"Idaho",
  IL:"Illinois", IN:"Indiana", IA:"Iowa", KS:"Kansas", KY:"Kentucky", LA:"Louisiana",
  ME:"Maine", MD:"Maryland", MA:"Massachusetts", MI:"Michigan", MN:"Minnesota",
  MS:"Mississippi", MO:"Missouri", MT:"Montana", NE:"Nebraska", NV:"Nevada",
  NH:"New Hampshire", NJ:"New Jersey", NM:"New Mexico", NY:"New York", NC:"North Carolina",
  ND:"North Dakota", OH:"Ohio", OK:"Oklahoma", OR:"Oregon", PA:"Pennsylvania",
  RI:"Rhode Island", SC:"South Carolina", SD:"South Dakota", TN:"Tennessee", TX:"Texas",
  UT:"Utah", VT:"Vermont", VA:"Virginia", WA:"Washington", WV:"West Virginia", WI:"Wisconsin",
  WY:"Wyoming",
  AB:"Alberta", BC:"British Columbia", MB:"Manitoba", NB:"New Brunswick", NL:"Newfoundland & Labrador",
  NS:"Nova Scotia", NT:"Northwest Territories", NU:"Nunavut", ON:"Ontario", PE:"Prince Edward Island",
  QC:"Québec", SK:"Saskatchewan", YT:"Yukon"
};
function channelLabel(ch){
  switch((ch||'').toLowerCase()){
    case 'email': return 'Best channel: Email';
    case 'sms': return 'Best channel: SMS';
    case 'call': return 'Best channel: Call';
    case 'linkedin':
    case 'linkedin_dm': return 'Best channel: LinkedIn DM';
    case 'erp': return 'Log to ERP';
    default: return ch ? `Channel: ${ch}` : '';
  }
}
function mapRawSignal(raw){
  const buyerDomain = raw?.buyerDomain || raw?.companyDomain || raw?.domain || raw?.buyer?.domain || '';
  const buyerName   = raw?.buyerName   || raw?.companyName  || raw?.buyer?.name   || buyerDomain.replace(/^www\./,'');
  const region      = raw?.region      || raw?.state        || raw?.buyer?.region || raw?.buyer?.state || '';
  const materials   = raw?.materials   || raw?.tags         || raw?.intent?.materials || [];
  const qty         = raw?.qty         || raw?.intent?.qty  || '';
  const format      = raw?.format      || raw?.intent?.format || '';
  const urgency     = raw?.urgency     || raw?.intent?.urgency || '';
  const title       = raw?.title       || raw?.intent?.title || 'Packaging request';
  const bestCh      = raw?.bestChannel || raw?.channel      || raw?.recommendedChannel || '';
  const why         = raw?.why         || raw?.explain      || raw?.reason || '';
  const conf        = (raw?.confidence ?? raw?.score ?? 0.75);
  const srcUrl      = raw?.sourceUrl   || raw?.url          || raw?.source?.url || '';
  const ts          = raw?.ts          || raw?.timestamp    || Date.now();

  const parts = [];
  if (materials && materials.length) parts.push(materials.join(' • '));
  if (format)  parts.push(format);
  if (qty)     parts.push(qty);
  if (urgency) parts.push(urgency);

  return {
    id: raw?.id || String(ts) + Math.random().toString(36).slice(2),
    ts,
    buyer: { name: buyerName, domain: buyerDomain, region },
    intent: { title, line: parts.join(' • ') },
    bestChannel: bestCh,
    why: { text: why, confidence: conf },
    sourceUrl: srcUrl
  };
}
function renderSignalCard(raw){
  const s = mapRawSignal(raw);
  const buyerLink = s.buyer.domain ? `https://${s.buyer.domain.replace(/^https?:\/\//,'')}` : '#';
  const regionName = REGION_NAMES[s.buyer.region] || s.buyer.region || '';
  const chLabel = channelLabel(s.bestChannel);

  const whyBlock = s.why.text || s.sourceUrl ? `
    <div class="why">
      ${s.why.text ? `<div class="why-line">${s.why.text}</div>`:''}
      ${s.sourceUrl ? `<a class="why-src" href="${s.sourceUrl}" target="_blank" rel="noopener">View source</a>`:''}
      <div class="why-conf">Confidence: ${Math.round((s.why.confidence||0)*100)}%</div>
    </div>
  ` : '';

  const chips = `
    <div class="chips">
      ${regionName ? `<span class="chip">Location: ${regionName}</span>`:''}
      ${chLabel ? `<span class="chip">${chLabel}</span>`:''}
    </div>
  `;

  const card = document.createElement('div');
  card.className = 'sig-card';
  card.innerHTML = `
    <div class="sig-title">“${s.intent.title}”</div>
    <div class="sig-sub">${s.intent.line || ''}</div>
    <div class="sig-buyer">
      <a href="${buyerLink}" target="_blank" rel="noopener">${s.buyer.domain || s.buyer.name}</a>
    </div>
    ${chips}
    ${whyBlock}
    ${s.why.text || s.sourceUrl ? `<button class="why-toggle">Why this?</button>`:''}
  `;
  const btn = card.querySelector('.why-toggle');
  if (btn){ btn.addEventListener('click', ()=> card.classList.toggle('show-why')); }
  return card;
}
function appendSignal(raw){
  const list=document.getElementById('liveList');
  const card=renderSignalCard(raw);
  list.prepend(card);
  while(list.children.length>100) list.lastElementChild.remove();
}

/* ---------- Run: Find now ---------- */
function uid(){
  const k='galactly_uid';
  let id=localStorage.getItem(k);
  if(!id){ id='u_'+Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
  return id;
}
async function post(path, body){
  const res = await fetch(API+path, {
    method:'POST',
    headers:{'content-type':'application/json','x-galactly-user':uid()},
    body: JSON.stringify(body||{})
  });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}

async function runFind(){
  const site=document.getElementById('ai_site').value.trim();
  const regions=document.getElementById('ai_regions').value.trim();
  const inds=document.getElementById('ai_inds').value.trim();
  const buyers=document.getElementById('ai_buyers').value.trim();
  const notes=document.getElementById('ai_notes').value.trim();
  const err=document.getElementById('cfg_err'); err.style.display='none';
  pushPreviewLine('Submitting your search…');

  try{
    const payload={ website:site, regions, industries:inds, buyers, notes, mode:'free' };
    const j = await post('/find-now', payload);

    // Counters
    document.getElementById('ctrLbl').textContent = `Free ${j.free?.count||0}/${j.free?.total||0} • Pro ${j.pro?.count||0}/${j.pro?.total||0}`;
    if (j.quota){ 
      const qLbl=`${j.quota.findsLeft??'∞'} searches left • ${j.quota.revealsLeft??'∞'} reveals left`;
      document.getElementById('quotaHdr').textContent = qLbl;
      document.getElementById('quotaLbl').textContent = qLbl;
    }

    // Stream live section
    const {signals=[]}= j;
    if(signals.length===0){ pushPreviewLine('No public-ready signals in this window. Try broader regions or add 2–3 seed buyers.'); }
    signals.slice(0,18).forEach(appendSignal);

    // Preview lines (report-ish)
    (j.preview||[]).slice(0,10).forEach(row=> pushPreviewLine(row));

    // Free UX nudge
    showUpgradeBanner();
  }catch(e){
    err.textContent='Unexpected error. Please try again in a minute.'; err.style.display='block';
  }
}

document.getElementById('btn_save').addEventListener('click', ()=>{
  const s=(id)=>document.getElementById(id).value||'';
  localStorage.setItem('onb_site', s('ai_site'));
  localStorage.setItem('onb_regions', s('ai_regions'));
  localStorage.setItem('onb_industries', s('ai_inds'));
  localStorage.setItem('onb_buyers', s('ai_buyers'));
  localStorage.setItem('onb_desc', s('ai_notes'));
  pushPreviewLine('Saved your preferences.');
});

document.getElementById('btn_find').addEventListener('click', async ()=>{
  // Free plan launch experience (7–15s)
  const launch = showLaunch(7000,15000);
  // Run the search in parallel; wait for both to complete
  await Promise.allSettled([launch, runFind()]);
});
</script>
</body>
</html>
