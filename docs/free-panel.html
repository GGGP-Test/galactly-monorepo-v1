<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Galactly — Live feed</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#eaf0ff; --mut:#a6b2c9; --line:#1e2737; --card:#0f1420; --panel:#0b101a; --pill:#10182a;
  --accent:#86f7d6; --accent2:#6fb3ff;
  --mont:Montserrat,Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
  --inter:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;color:var(--ink);background:linear-gradient(180deg,#0a0e16,#06080e 60%);font-family:var(--inter)}
header{height:54px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0b111b,#0a0e15)}
.brand{display:flex;gap:10px;align-items:center;font:800 16px var(--mont)}
.brand svg{width:20px;height:20px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:#0c1322;color:#c9d6f0;font-size:12px}
.badge .dot{width:8px;height:8px;border-radius:50%;background:#43e5b7;box-shadow:0 0 10px rgba(67,229,183,.7)}
.apiChip{margin-left:8px;opacity:.7}
.wrap{max-width:1280px;margin:14px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1.08fr 1fr;gap:16px}
@media (max-width:1100px){ .grid{grid-template-columns:1fr} }
.panel{background:#0b101a;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
.hint{font-size:12px;color:#9fb2d6;opacity:.9}
.scroller{height:calc(100vh - 152px);overflow:auto}

/* neutron box */
.heroBox{position:relative;height:260px;border-bottom:1px solid var(--line);background:radial-gradient(500px 300px at 70% 40%,rgba(110,150,255,.16),rgba(10,14,20,1) 70%)}
#nsCanvas{position:absolute;inset:0;width:100%;height:100%}
.liveTicker{position:absolute;left:12px;bottom:12px;padding:6px 10px;border:1px solid #243048;border-radius:10px;background:rgba(12,18,30,.7);font-size:12px;color:#cfe0ff}
.statusDot{width:7px;height:7px;border-radius:50%;background:#86f7d6;display:inline-block;margin-right:6px;box-shadow:0 0 10px rgba(134,247,214,.6)}

.card{background:#0f1420;border:1px solid var(--line);border-radius:12px;margin:12px;padding:12px}
.mask{filter:blur(2.5px);opacity:.75}
.tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.tag{padding:4px 8px;border:1px solid #2a3552;border-radius:999px;background:#0f1626;color:#cfe0ff;font-size:12px}
.title{font-weight:600}
.actions{display:flex;gap:8px;margin-top:10px}
.btn{padding:8px 10px;border:1px solid #26314a;border-radius:10px;background:#111a2b;color:#eaf0ff;cursor:pointer;font-weight:600}
.btn.small{font-size:12px;padding:6px 8px}
.btn.own{background:linear-gradient(90deg,#fff,#eaf1ff);color:#0b111b;border-color:transparent}
.banner{background:#0f1626;border:1px dashed #314367;margin:10px 12px;padding:10px;border-radius:12px;color:#cfe0ff}
.banner.error{border-color:#6b1d2b;color:#ffd5d5;background:rgba(70,16,24,.4)}
.sep{height:1px;background:linear-gradient(90deg,transparent,#26324c,transparent);margin:10px 0}

.formRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input{width:100%;background:#0f1420;border:1px solid var(--line);color:#e9eef7;border-radius:10px;padding:10px 12px;font:500 13px var(--inter)}
label{font-size:12px;color:#9fb2d6;margin-bottom:6px;display:block}

.section{border-top:1px dashed #223048}
.section:first-child{border-top:0}
.section .titleRow{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.section h3{margin:0;font:700 14px var(--inter);letter-spacing:.02em;color:#dfe9ff}
.rows{padding:0 12px 12px}
.row{display:grid;grid-template-columns:58px 1fr;gap:10px;align-items:flex-start;padding:10px 0;border-top:1px solid rgba(40,60,90,.35)}
.row:first-child{border-top:0}
.lane{font:700 12px var(--inter); padding:4px 8px; border:1px solid #2a3552; border-radius:999px; background:#0f1626; color:#cfe0ff; text-align:center}
.chain{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.step{padding:4px 8px;border:1px solid #2a3552;border-radius:8px;background:#0f1626;color:#cfe0ff;font-size:12px;white-space:nowrap}
.arrow{opacity:.6}
.counts{margin-left:auto;font-size:12px;color:#a9bbda}
.locked{opacity:.78;filter:saturate(.84)}
.upsell{margin:12px;padding:12px;border:1px dashed #38509a;border-radius:12px;background:rgba(20,28,46,.6)}

/* verify modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal.in{display:flex}
.box{width:min(560px,95vw);background:#0b101a;border:1px solid var(--line);border-radius:14px;overflow:hidden}
.box .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
.box h3{margin:0;font:800 14px var(--mont)}
.boxInner{padding:12px}
.err{color:#ffb3b3;font-size:12px;margin-top:6px;display:none}
.ok{color:#a7ffde;font-size:12px;margin-top:6px;display:none}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#86f7d6"/><stop offset="1" stop-color="#57a4ff"/></linearGradient></defs><circle cx="32" cy="32" r="28" stroke="url(#g)" stroke-width="2" fill="none"/><circle cx="20" cy="20" r="6" fill="url(#g)"/></svg>
    <span>Galactly</span>
  </div>
  <div class="badge"><span class="dot"></span><span id="presence">0 online</span><span class="apiChip" id="apiChip"></span></div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="panel">
      <div class="head">
        <div style="font:700 14px var(--inter)">Live results</div>
        <div class="hint" id="statusLine">probing demand → scanning procurement → reading reviews…</div>
      </div>

      <div class="heroBox">
        <canvas id="nsCanvas"></canvas>
        <div class="liveTicker"><span class="statusDot"></span><span id="liveTickerTxt">engine: ready</span></div>
      </div>

      <div id="verifyBanner" class="banner" style="display:none;">
        Verify your company to <strong>unlock free reveals</strong>. Use a business email that matches your website domain.
        <button class="btn small" id="openVerify">Verify now</button>
      </div>
      <div id="apiErr" class="banner error" style="display:none;">Couldn’t reach the API. Open from your API host or append <code>?api=YOUR_API</code>.</div>

      <div class="scroller" id="leadList"></div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="head">
        <div style="font:700 14px var(--inter)">Train your AI</div>
        <div class="hint"><span id="searchesLeft">—</span> searches left • <span id="revealsLeft">—</span> reveals left</div>
      </div>

      <div style="padding:12px">
        <div class="formRow">
          <div>
            <label>Website</label>
            <input id="f_site" class="input" placeholder="yourcompany.com"/>
          </div>
          <div>
            <label>Regions</label>
            <input id="f_regions" class="input" placeholder="US, CA"/>
          </div>
        </div>

        <div class="formRow" style="margin-top:10px">
          <div>
            <label>Industries</label>
            <input id="f_industries" class="input" placeholder="beverage, confectionery"/>
          </div>
          <div>
            <label>Seed buyers (domains)</label>
            <input id="f_buyers" class="input" placeholder="brand1.com, brand2.com"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Describe ideal customers</label>
          <input id="f_desc" class="input" placeholder="materials, order sizes, channels, exclusions"/>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" id="saveAI">Save</button>
          <button class="btn" id="findNow">Find now</button>
        </div>
        <div class="sep"></div>
      </div>

      <div class="head">
        <div style="font:700 14px var(--inter)">Signals Preview (report)</div>
        <div class="hint"><span id="freeCount">Free 0/0</span> • <span id="proCount">Pro 0/0</span></div>
      </div>
      <div class="scroller" id="report"></div>
    </div>
  </div>
</div>

<!-- Verify modal -->
<div class="modal" id="verifyModal">
  <div class="box">
    <div class="head"><h3>Verify your company</h3><button class="btn small" id="vClose">Close</button></div>
    <div class="boxInner">
      <div class="formRow">
        <div>
          <label>Business email</label>
          <input id="v_email" class="input" placeholder="you@yourcompany.com">
        </div>
        <div>
          <label>Company website</label>
          <input id="v_site" class="input" placeholder="yourcompany.com">
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Regions (optional)</label>
        <input id="v_regions" class="input" placeholder="US, CA">
      </div>
      <div class="err" id="v_err"></div>
      <div class="ok" id="v_ok"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="vSave">Verify now</button>
      </div>
      <div class="hint" style="margin-top:10px">Your email domain must match your website (e.g., <em>you@acme.com</em> ↔ <em>acme.com</em>). This unlocks free reveals.</div>
    </div>
  </div>
</div>

<script>
/* ------- API base + sticky user ------- */
(function(){
  const qs=new URLSearchParams(location.search);
  const saved=localStorage.getItem('apiBase');
  const explicit=qs.get('api');
  const isFile = location.protocol==='file:';
  const fallback = 'http://localhost:8080';
  const base = (explicit||saved||(isFile?fallback:(location.origin||fallback))).replace(/\/$/,'');
  localStorage.setItem('apiBase', base);
  document.getElementById('apiChip').textContent = base.replace(/^https?:\/\//,'');
  const _fetch=window.fetch.bind(window);
  const uidKey='galactly_uid'; const uid=localStorage.getItem(uidKey)||('u_'+Math.random().toString(36).slice(2)); localStorage.setItem(uidKey, uid);
  window.fetch=function(input,init){
    let url=(typeof input==='string')?input:input.url; const headers=new Headers((init&&init.headers)||(typeof input!=='string'&&input.headers)||undefined);
    headers.set('x-galactly-user', uid);
    if(url && (url.startsWith('/api/')||url.startsWith('api/')||url.startsWith('/presence/')||url.startsWith('presence/'))){
      url = base + (url.startsWith('/')? '': '/') + url;
    }
    return _fetch(typeof input==='string'?url:new Request(url,{...(init||{}),headers}));
  };
  window.API={ base, uid, url:(p)=> (base + (p.startsWith('/')?p:'/'+p)) };
})();

/* Presence + API reachability */
async function reachAPI(){ try{ const r=await fetch('/api/v1/status'); return r.ok; }catch{return false;} }
(async()=>{ const ok=await reachAPI(); if(!ok) document.getElementById('apiErr').style.display='block'; })();
async function loadPresence(){ try{ const r=await fetch(window.API.url('/presence/online')); const j=await r.json(); document.getElementById('presence').textContent=(j.total||0)+' online'; }catch{} }
setInterval(loadPresence, 10000); loadPresence();

/* Local gate/tier calculation */
const gate={ email:localStorage.getItem('onb_email')||'', site:localStorage.getItem('onb_site')||'' };
function emailDomain(e){ const m=String(e||'').toLowerCase().match(/^[^@]+@([^@]+)$/); return m? m[1].replace(/^www\./,''):''; }
function bareHost(u){ return String(u||'').trim().replace(/^https?:\/\//i,'').replace(/\/.*$/,'').replace(/^www\./,'').toLowerCase(); }
function isDomainMatch(){ const ed=emailDomain(gate.email); const sd=bareHost(gate.site); return !!(ed && sd && (ed===sd || ed.endsWith('.'+sd))); }

/* Status / quotas / prefill */
const state={ plan:'free', findsLeft:null, revealsLeft:null, verified:false, sse:null, sseOpen:false };
async function loadStatusAndPrefill(){
  try{
    const r=await fetch('/api/v1/status'); const j=await r.json();
    state.plan=j.user?.plan||'free';
    state.findsLeft = Number.isFinite(j.quota?.findsLeft)? j.quota.findsLeft : null;
    state.revealsLeft = Number.isFinite(j.quota?.revealsLeft)? j.quota.revealsLeft : null;
    // Prefer server gate flags if present
    const srvMatch = j.gate?.domainMatch;
    if(srvMatch===true || srvMatch===false){ state.verified = srvMatch; }
    else{ state.verified = isDomainMatch(); }

    document.getElementById('searchesLeft').textContent = state.findsLeft===null?'—':state.findsLeft;
    document.getElementById('revealsLeft').textContent   = state.revealsLeft===null?'—':state.revealsLeft;

    // Prefill Train-your-AI
    const site = j.traits?.vendorDomain || localStorage.getItem('onb_site') || '';
    const regions = j.traits?.regions?.join(', ') || localStorage.getItem('onb_regions') || '';
    const inds = j.traits?.industries?.join(', ') || localStorage.getItem('onb_industries') || '';
    const buyers = j.traits?.buyers?.join(', ') || localStorage.getItem('onb_buyers') || '';
    const desc = j.traits?.notes || localStorage.getItem('onb_desc') || '';
    if(site) document.getElementById('f_site').value = site;
    if(regions) document.getElementById('f_regions').value = regions;
    if(inds) document.getElementById('f_industries').value = inds;
    if(buyers) document.getElementById('f_buyers').value = buyers;
    if(desc) document.getElementById('f_desc').value = desc;

    document.getElementById('verifyBanner').style.display = state.verified? 'none':'block';
  }catch{}
}
loadStatusAndPrefill();

/* Neutron star animation */
(function(){
  const c=document.getElementById('nsCanvas'); const ctx=c.getContext && c.getContext('2d'); if(!ctx) return;
  let w=0,h=0,dpr=1,t=0; const spokes=9;
  const pts=Array.from({length:120},()=>({a:Math.random()*Math.PI*2,s:0.05+Math.random()*0.2}));
  function resize(){ dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1)); w=c.clientWidth; h=c.clientHeight; c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); }
  new ResizeObserver(resize).observe(c); resize();
  function frame(){ t+=0.003; ctx.clearRect(0,0,w,h);
    const cx=w*0.72, cy=h*0.57, R=Math.min(w,h)*0.14;
    const g=ctx.createRadialGradient(cx,cy,0,cx,cy,R*3); g.addColorStop(0,'rgba(255,255,255,.55)'); g.addColorStop(1,'rgba(60,90,140,.02)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,R*1.2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(200,230,255,.2)'; ctx.lineWidth=1.2; for(let k=1;k<=3;k++){ ctx.beginPath(); ctx.arc(cx,cy,R*(1+k*0.64),0,Math.PI*2); ctx.stroke(); }
    ctx.strokeStyle='rgba(180,210,255,.35)'; ctx.lineWidth=1.5;
    for(let i=0;i<spokes;i++){ const a=t+i*(Math.PI*2/spokes); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(a)*R*2.3, cy+Math.sin(a)*R*2.3); ctx.stroke(); }
    pts.forEach(p=>{ p.a += 0.001 + p.s*0.0007; const rr=R*(1.8 + Math.sin(t*0.6+p.s)*1.1); const x=cx+Math.cos(p.a)*rr, y=cy+Math.sin(p.a)*rr;
      ctx.fillStyle='rgba(255,255,255,.9)'; ctx.beginPath(); ctx.arc(x,y,0.8,0,Math.PI*2); ctx.fill(); });
    requestAnimationFrame(frame);
  } frame();
})();

/* Lead list + gating */
const leadList=document.getElementById('leadList'); const statusLine=document.getElementById('statusLine');
const q=[]; let drip=null;
function pushLeads(ls){ ls.forEach(l=>q.push(l)); if(!drip){ drip=setInterval(()=>{ if(!q.length){ clearInterval(drip); drip=null; return; } addLeadCard(q.shift()); },1800); } }
function requireVerified(){ if(state.verified) return true; document.getElementById('verifyModal').classList.add('in'); return false; }

function addLeadCard(L){
  const el=document.createElement('div'); el.className='card';
  const masked = !state.verified; // unverified → mask
  const tags=document.createElement('div'); tags.className='tags';
  (L.tags||['demand']).forEach(t=>{const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s);});
  const title=document.createElement('div'); title.className='title'; title.textContent=masked ? '•••• ••••• — lead locked (verify to reveal)' : (L.title||'Potential buyer');
  if(masked) title.classList.add('mask');

  const actions=document.createElement('div'); actions.className='actions';
  const why=document.createElement('button'); why.className='btn'; why.textContent='Why this?';
  const own=document.createElement('button'); own.className='btn own'; own.textContent='Own';
  why.onclick=()=>{ if(!requireVerified()) return; alert('Proof bullets… (stub)'); };
  own.onclick=()=>{ if(!requireVerified()) return; alert('Reserved for you for 2 minutes (stub)'); };

  actions.appendChild(why); actions.appendChild(own);
  el.appendChild(tags); el.appendChild(title); el.appendChild(actions);
  leadList.prepend(el);
}

/* Save AI traits */
document.getElementById('saveAI').onclick=async ()=>{
  const traits={
    vendorDomain:(document.getElementById('f_site').value||'').trim(),
    regions:(document.getElementById('f_regions').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    industries:(document.getElementById('f_industries').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    buyers:(document.getElementById('f_buyers').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    notes:(document.getElementById('f_desc').value||'').trim()||null
  };
  try{ await fetch('/api/v1/vault',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({traits})}); }catch{}
};

/* Find-now → always attempt, set quota only if API says so; start SSE */
document.getElementById('findNow').onclick=async ()=>{
  statusLine.textContent='scanning…';
  try{
    const r=await fetch('/api/v1/find-now',{method:'POST'});
    const j=await r.json().catch(()=>({}));
    if(j && j.ok){
      // refresh quotas if returned
      if(typeof j.findsLeft==='number') { state.findsLeft=j.findsLeft; document.getElementById('searchesLeft').textContent=state.findsLeft; }
      connectSSE(); // start preview stream
      // pull leads & drip
      const lr=await fetch('/api/v1/leads'); const lj=await lr.json(); if(lj.ok){ pushLeads(lj.leads||[]); }
      statusLine.textContent='results incoming…';
    }else{
      statusLine.textContent='Daily search quota reached';
    }
  }catch{ statusLine.textContent='Network error'; }
};

/* SSE (Signals Preview) — start only after Find now */
const report=document.getElementById('report'); const bySection=new Map(); let freeSeen=0, proSeen=0, total=0, halted=false;
function section(cat){ if(bySection.has(cat)) return bySection.get(cat); const wrap=document.createElement('div'); wrap.className='section';
  const head=document.createElement('div'); head.className='titleRow'; const h3=document.createElement('h3'); h3.textContent=cat; const right=document.createElement('div'); right.className='hint';
  head.appendChild(h3); head.appendChild(right); const rows=document.createElement('div'); rows.className='rows'; wrap.appendChild(head); wrap.appendChild(rows); report.appendChild(wrap); const o={wrap,head,right,rows,counts:{free:0,pro:0,total:0}}; bySection.set(cat,o); return o; }
function addRow(cat,lane,chain,counts,locked){ const sec=section(cat); sec.counts.total=counts.total; if(lane==='free') sec.counts.free=counts.done; else sec.counts.pro=counts.done;
  sec.right.textContent=`Free ${sec.counts.free}/${sec.counts.total} • Pro ${sec.counts.pro}/${sec.counts.total}${locked?' 🔒':''}`;
  const row=document.createElement('div'); row.className='row'+(locked?' locked':''); const A=document.createElement('div'); A.className='lane'; A.textContent=lane==='free'?'Free':'Pro';
  const B=document.createElement('div'); B.className='chain'; chain.forEach((t,i)=>{ const s=document.createElement('span'); s.className='step'; s.textContent=t; B.appendChild(s); if(i!==chain.length-1){ const arr=document.createElement('span'); arr.className='arrow'; arr.textContent='→'; B.appendChild(arr); }});
  const cnt=document.createElement('span'); cnt.className='counts'; cnt.textContent=`${counts.done}/${counts.total}`; B.appendChild(cnt); row.appendChild(A); row.appendChild(B); sec.rows.appendChild(row); }
function showUpsell(payload){ if(halted) return; halted=true; const box=document.createElement('div'); box.className='upsell';
  box.innerHTML=`<strong>Free scan paused.</strong> We processed ${payload.freeDone}/${payload.total}. Pro continues with full checks, auto-verification, JSON export, and queue window forecasting.`; const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='Unlock Pro ($39/mo)'; btn.onclick=()=>location.href=payload.checkout||'/checkout/stripe?plan=pro'; box.appendChild(document.createElement('br')); box.appendChild(btn); report.prepend(box); }
function connectSSE(){ if(state.sseOpen) return; const es=new EventSource(API.url('/api/v1/progress.sse')); state.sse=es; state.sseOpen=true;
  es.addEventListener('tick', ev=>{ const j=JSON.parse(ev.data); total=j.total||total; if(j.lane==='free'){ freeSeen=j.done; } else { proSeen=j.done; } addRow(j.category, j.lane, j.chain, {done:j.done,total:j.total}, j.locked===true);
    document.getElementById('freeCount').textContent=`Free ${freeSeen}/${total}`; document.getElementById('proCount').textContent=`Pro ${proSeen}/${total}${j.locked?' 🔒':''}`; });
  es.addEventListener('halt', ev=>showUpsell(JSON.parse(ev.data)));
  es.addEventListener('done', ()=>es.close());
}

/* Verify modal wiring */
const vModal=document.getElementById('verifyModal'); document.getElementById('openVerify').onclick=()=> vModal.classList.add('in');
document.getElementById('vClose').onclick=()=> vModal.classList.remove('in');
document.getElementById('vSave').onclick=async ()=>{
  const email=(document.getElementById('v_email').value||'').trim();
  const site =(document.getElementById('v_site').value||'').trim();
  const regs =(document.getElementById('v_regions').value||'').trim();
  const vErr=document.getElementById('v_err'); const vOk=document.getElementById('v_ok'); vErr.style.display='none'; vOk.style.display='none';
  const ed=emailDomain(email), sd=bareHost(site);
  if(!email||!sd){ vErr.textContent='Please provide business email and company website.'; vErr.style.display='block'; return; }
  if(!(ed && sd && (ed===sd || ed.endsWith('.'+sd)))){ vErr.textContent=`Email domain (${ed||'—'}) must match company site (${sd||'—'}).`; vErr.style.display='block'; return; }

  // Persist locally for gating immediately
  localStorage.setItem('onb_email', email);
  localStorage.setItem('onb_site', sd);
  if(regs) localStorage.setItem('onb_regions', regs);

  // Notify backend (best-effort)
  try{
    await fetch('/api/v1/gate',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({email,region:regs||'',alerts:true})});
    await fetch('/api/v1/vault',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({traits:{vendorDomain:sd,regions:regs?regs.split(',').map(s=>s.trim()):[]}})});
  }catch{}
  vOk.textContent='Verified. Unlocking…'; vOk.style.display='block';
  state.verified=true; document.getElementById('verifyBanner').style.display='none';
  setTimeout(()=> vModal.classList.remove('in'), 600);
};

/* Small helper banner for redirect to signup if someone arrived without any email at all */
(function enforceSignup(){
  const hasAnyEmail = !!(gate.email || emailDomain(localStorage.getItem('last_email')));
  if(!hasAnyEmail){
    const b=document.createElement('div'); b.className='banner'; b.innerHTML='Create your free Vault to save & revisit leads. ';
    const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='Sign up'; btn.onclick=()=> location.href='./index.html?onb=1';
    b.appendChild(btn); document.getElementById('leadList').appendChild(b);
  }
})();
</script>
</body>
</html>
