<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galactly • Free Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0c121a;
      --panel: #0f1621;
      --muted: #9fb2c7;
      --text: #e7f1ff;
      --line: #233244;
      --primary: #86f3ff;
      --pill: #152231;
      --good: #77ffb0;
      --badge: #13283b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: radial-gradient(1200px 700px at 50% 0%, #0c141e 0%, #0c121a 60%, #090f16 100%);
      color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .wrap { max-width: 1220px; margin: 32px auto 90px; padding: 0 20px; display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid var(--line); border-radius: 18px; position: relative; overflow: clip; }
    .head { padding: 14px 16px; border-bottom: 1px solid var(--line); display:flex; align-items:center; justify-content:space-between; }
    h3 { margin: 0; font-size: 16px; letter-spacing:.2px }
    .muted { color: var(--muted); font-size: 13px }
    .canvasBox{ position:relative; height:300px; display:flex; align-items:center; justify-content:center; }
    #neutron { width: 100%; height: 100%; display:block; }
    .engineDot{ position:absolute; left:14px; bottom:14px; display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted) }
    .engineDot .dot{ width:8px; height:8px; border-radius:999px; background:#27ffb1; box-shadow:0 0 12px #27ffb1aa }
    .apibase { position:absolute; right:14px; bottom:14px; font-size:11px; color:#6fa1b8 }
    .body { padding: 12px 14px 16px; }
    .pill { background: var(--pill); border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin:10px 0; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .btn { border:1px solid var(--line); background:#122132; color:var(--text); padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn.primary{ background:#123041; border-color:#1d5165; box-shadow: inset 0 0 0 1px #2a7d93; }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .inputs{ display:grid; grid-template-columns: 1fr 140px; gap:10px; margin-top:10px }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label{ font-size:12px; color:var(--muted); margin-bottom:6px; display:block }
    input, textarea {
      width:100%; background:#0c1520; color:var(--text); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{ min-height:82px; resize:vertical }
    .list{ display:flex; flex-direction:column; gap:10px }
    .card{
      background: #0e1723; border:1px solid var(--line); border-radius:14px; padding:12px 12px 10px; position:relative;
    }
    .title{ font-weight:700; font-size:16px; margin-bottom:6px }
    .line{ font-size:13px; color:var(--muted); margin-bottom:6px }
    .target{ font-size:13px; color:#a6c7dc; margin-bottom:8px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap }
    .tag{ font-size:12px; padding:5px 8px; background:#0c1b2a; border:1px solid #1b3147; border-radius:999px; }
    .link{ color:var(--primary); text-decoration:none }
    .badge { padding:2px 8px; border-radius:999px; background:var(--badge); border:1px solid var(--line); margin-left:10px; font-size:11px; color:#9fd0ea }
    .loaderMask{
      position:fixed; inset:0; background:rgba(6,10,15,.72); backdrop-filter: blur(3px);
      display:none; align-items:center; justify-content:center; z-index:999;
    }
    .loader{ width:460px; max-width:92vw; background:#0f1825; border:1px solid var(--line); border-radius:16px; padding:16px 16px 12px; }
    .loader h4{ margin:0 0 10px 0; }
    .steps{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .step{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted) }
    .dotStep{ width:8px; height:8px; border-radius:999px; background:#28495e; box-shadow:0 0 0 0 transparent; transition:.25s }
    .step.active .dotStep{ background:#79f0ff; box-shadow:0 0 14px #79f0ff; }
    .sticky{text-align:right; margin-top:10px}
    .note { font-size:12px; color:#8cb3c6; margin-top:8px; }
    @media (max-width: 1000px){
      .wrap{ grid-template-columns: 1fr; }
      .inputs{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
  <!-- pulls API_DEFAULT / DEV_UNLIMITED if you committed config.js -->
  <script src="./config.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Live results -->
    <section class="panel" id="livePanel">
      <div class="head">
        <h3>Live results <span class="badge" id="quotaBadge">∞ searches left • ∞ reveals left</span></h3>
      </div>
      <div class="canvasBox">
        <canvas id="neutron"></canvas>
        <div class="engineDot"><span class="dot"></span><span id="engineTxt">engine: ready</span></div>
        <div class="apibase" id="apiBaseTxt"></div>
      </div>
      <div class="body">
        <div class="list" id="liveList"></div>
      </div>
    </section>

    <!-- RIGHT: Train your AI + Preview -->
    <section class="panel">
      <div class="head">
        <h3>Train your AI</h3>
        <span class="muted" id="quotaTop">—</span>
      </div>
      <div class="body">
        <div class="grid2">
          <div>
            <label>Website</label>
            <input id="f_site" placeholder="yourcompany.com" />
          </div>
          <div>
            <label>Regions</label>
            <input id="f_regions" placeholder="US, CA" />
          </div>
          <div>
            <label>Industries</label>
            <input id="f_inds" placeholder="beverage, confectionery" />
          </div>
          <div>
            <label>Seed buyers (domains)</label>
            <input id="f_seeds" placeholder="brand1.com, brand2.com" />
          </div>
          <div style="grid-column:1 / -1">
            <label>Describe ideal customers</label>
            <textarea id="f_notes" placeholder="materials, order sizes, channels, exclusions"></textarea>
          </div>
        </div>
        <div class="sticky">
          <button class="btn" id="btnSave">Save</button>
          <button class="btn primary" id="btnFind">Find now</button>
        </div>

        <div style="margin-top:18px">
          <div class="head" style="border:none; padding:0 0 8px 0">
            <h3>Signals Preview (report)</h3>
            <span class="muted" id="counts">Free 0/0 • Pro 0/0</span>
          </div>
          <div class="list" id="previewList"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- LAUNCHER -->
  <div class="loaderMask" id="launchMask" aria-hidden="true">
    <div class="loader">
      <h4>Launching real-time intent search…</h4>
      <div class="steps" id="launchSteps">
        <div class="step"><span class="dotStep"></span> Probing public feeds</div>
        <div class="step"><span class="dotStep"></span> Reading procurement + RFPs</div>
        <div class="step"><span class="dotStep"></span> Scanning retailer pages</div>
        <div class="step"><span class="dotStep"></span> Extracting quantities & materials</div>
        <div class="step"><span class="dotStep"></span> Cross-checking signals</div>
        <div class="step"><span class="dotStep"></span> Ranking by fit</div>
      </div>
      <div class="note" id="launchNote">Tip: upgrade to keep this running 24/7 in the background.</div>
    </div>
  </div>

  <script>
    // ---------- API base ----------
    const API =
      (window.API_DEFAULT ?? localStorage.getItem('apiBase')) ||
      `${location.origin.replace(/\/$/, '')}/api/v1`;
    document.getElementById('apiBaseTxt').textContent = `[api] ${API}`;

    const uid = (localStorage.getItem('uid') || `u-${Math.random().toString(16).slice(2)}`);
    localStorage.setItem('uid', uid);

    // ---------- helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const elLive = $('#liveList');
    const elPrev = $('#previewList');
    const quotaBadge = $('#quotaBadge');
    const quotaTop = $('#quotaTop');
    const counts = $('#counts');
    const mask = $('#launchMask');
    const steps = Array.from(document.querySelectorAll('#launchSteps .step'));

    function showLaunch(seconds){
      mask.style.display = 'flex';
      let i = 0;
      const total = steps.length;
      steps.forEach(s=>s.classList.remove('active'));
      const tick = () => {
        if (i<total) steps[i].classList.add('active');
        i++;
      };
      tick();
      const per = Math.max(1, Math.floor(seconds*1000/total));
      const t = setInterval(()=>{
        if(i>=total){ clearInterval(t); return; }
        tick();
      }, per);
      return () => { clearInterval(t); mask.style.display='none'; };
    }

    function fmtCount(q){
      if(!q) return '— searches left • — reveals left';
      if (q.findsLeft === Infinity) return '∞ searches left • ∞ reveals left';
      return `${q.findsLeft} searches left • ${q.revealsLeft} reveals left`;
    }

    // ---------- neutron star ----------
    (function neutron(){
      const c = document.getElementById('neutron');
      const ctx = c.getContext('2d');
      let w=0,h=0; const DPR = devicePixelRatio||1;
      function resize(){
        w = c.clientWidth; h = c.clientHeight;
        c.width = Math.floor(w*DPR); c.height = Math.floor(h*DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      window.addEventListener('resize', resize); resize();
      const dots = Array.from({length:180}).map(()=>({
        a: Math.random()*Math.PI*2,
        r: 30 + Math.random()*120,
        s: 0.0007 + Math.random()*0.0015
      }));
      let t0=performance.now();
      function draw(now){
        const dt = now - t0; t0 = now;
        ctx.clearRect(0,0,w,h);
        ctx.save();
        ctx.translate(w/2, h/2);
        // rings
        ctx.strokeStyle='#1e2b3b'; ctx.lineWidth=1;
        for(let r=40;r<=150;r+=22){ ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke(); }
        // core
        const grd = ctx.createRadialGradient(0,0,0,0,0,36);
        grd.addColorStop(0,'#bfeaff'); grd.addColorStop(1,'#7ac8ff0a');
        ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(0,0,36,0,7); ctx.fill();
        // beams
        ctx.globalCompositeOperation='lighter';
        ctx.strokeStyle='#7de9ff22'; ctx.lineWidth=8;
        ctx.beginPath(); ctx.moveTo(-36,0); ctx.lineTo(-180,0); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(36,0); ctx.lineTo(180,0); ctx.stroke();
        // stars
        ctx.fillStyle='#aee9ff';
        dots.forEach(d=>{
          d.a += d.s*dt;
          const x = Math.cos(d.a)*d.r, y=Math.sin(d.a)*d.r;
          ctx.globalAlpha = 0.55;
          ctx.fillRect(x,y,1.8,1.8);
        });
        ctx.restore();
        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    })();

    // ---------- renderers ----------
    function pushPreview(text){
      const item = document.createElement('div');
      item.className = 'pill';
      item.innerHTML = `<span class="muted">${text}</span>`;
      elPrev.prepend(item);
      // keep only 6 rolling lines
      while (elPrev.children.length > 6) elPrev.lastChild.remove();
    }

    function renderLive(leads){
      if(!Array.isArray(leads)) return;
      leads.forEach(lead=>{
        const card = document.createElement('div');
        card.className = 'card';

        // Buyer/source domain (not the seller site)
        const buyer = lead.buyer_domain || lead.domain || lead.source_domain || 'unknown';
        const href  = lead.url || lead.source_url || '#';

        const title = lead.title || lead.need || 'Potential packaging need';
        const specs = lead.specs || lead.details || '';
        const why   = lead.why || lead.reason || '';

        const tags = [];
        if (lead.region) tags.push(`${lead.region} • region`);
        if (lead.channel) tags.push(lead.channel.toUpperCase());
        if (lead.contact) tags.push(lead.contact);
        if (lead.quantity) tags.push(`${lead.quantity}`);

        card.innerHTML = `
          <div class="title">"${title}"</div>
          ${specs ? `<div class="line">${specs}</div>` : ``}
          <div class="target"><a class="link" href="${href}" target="_blank" rel="noopener">${buyer}</a></div>
          ${why ? `<div class="line">${why}</div>` : ``}
          <div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
        `;
        elLive.prepend(card);
        // keep list manageable
        while (elLive.children.length > 24) elLive.lastChild.remove();
      });
    }

    // ---------- API calls ----------
    async function api(path, opt){
      const res = await fetch(`${API}${path}`, {
        credentials: 'omit',
        headers: { 'content-type':'application/json', 'x-galactly-user': uid },
        ...opt
      });
      if (!res.ok) throw new Error(`${res.status} ${path}`);
      return res.json();
    }

    async function refreshStatus(){
      try{
        const s = await api('/status');
        quotaBadge.textContent = fmtCount(s.quota);
        quotaTop.textContent = fmtCount(s.quota);
        if (Array.isArray(s.hints)) s.hints.forEach(pushPreview);
      }catch(e){
        quotaBadge.textContent = '—';
        quotaTop.textContent = '—';
        pushPreview('Status: temporarily unavailable');
      }
    }

    async function setOnline(){
      try{ await api('/presence/online', {method:'GET'}); }catch{}
    }

    function getForm(){
      return {
        website: $('#f_site').value.trim(),
        regions: $('#f_regions').value.trim(),
        industries: $('#f_inds').value.trim(),
        seed_buyers: $('#f_seeds').value.trim(),
        notes: $('#f_notes').value.trim()
      };
    }

    // main Search
    async function runFind(){
      const stop = showLaunch(8 + Math.random()*7); // 7-15s
      const payload = getForm();
      try{
        pushPreview('Submitting your search…');
        const r = await api('/find-now', { method:'POST', body: JSON.stringify(payload) });
        // counts (if provided)
        if (r.counts) counts.textContent = `Free ${r.counts.free} • Pro ${r.counts.pro}`;
        // stream or batch
        if (Array.isArray(r.leads)) renderLive(r.leads);
        if (Array.isArray(r.preview)) r.preview.forEach(pushPreview);
        if (r.message) pushPreview(r.message);
      }catch(e){
        pushPreview(`Search error: ${e.message}`);
        alert('Unexpected error.');
      }finally{
        stop();
        refreshStatus();
      }
    }

    // ---------- wire ----------
    document.getElementById('btnFind').addEventListener('click', runFind);
    document.getElementById('btnSave').addEventListener('click', ()=>{
      const v = getForm();
      localStorage.setItem('train', JSON.stringify(v));
      pushPreview('Saved. Tweak & run.');
    });

    // restore saved training prefs
    (function restore(){
      const v = JSON.parse(localStorage.getItem('train')||'{}');
      if (v.website) $('#f_site').value = v.website;
      if (v.regions) $('#f_regions').value = v.regions;
      if (v.industries) $('#f_inds').value = v.industries;
      if (v.seed_buyers) $('#f_seeds').value = v.seed_buyers;
      if (v.notes) $('#f_notes').value = v.notes;
    })();

    // initial
    setOnline();
    refreshStatus();

    // fail-safe: ALSO accept root endpoints if your backend exposes them
    // (no code here; we just call /api/v1/* properly)
  </script>
</body>
</html>
