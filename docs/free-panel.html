<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Galactly â€” Live panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#eaf0ff; --mut:#a6b2c9; --line:#1e2737; --card:#0f1420; --panel:#0b101a; --pill:#10182a;
  --accent:#86f7d6; --accent2:#6fb3ff; --bad:#ff8a8a; --ok:#9af1da;
}
*{box-sizing:border-box}
body{margin:0; color:var(--ink); background:linear-gradient(180deg,#0a0e16,#06080e 60%); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
header{height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 16px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0b111b,#0a0e15)}
.brand{display:flex; gap:10px; align-items:center; font:700 15px Inter}
.brand svg{width:20px;height:20px}
.badge{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:#c9d6f0; background:#0c1322; font-size:12px}
.badge .dot{width:8px;height:8px;border-radius:50%;background:#43e5b7;box-shadow:0 0 10px rgba(67,229,183,.7);display:inline-block}
.wrap{max-width:1280px; margin:0 auto; padding:16px}
.grid{display:grid; grid-template-columns:1fr 420px; gap:16px}
@media (max-width:1100px){ .grid{grid-template-columns:1fr} }
.card{background:#0f1420; border:1px solid var(--line); border-radius:16px; padding:12px}
.h{font:700 14px/1.2 Inter; color:#dfe8ff; margin:2px 0 10px}
.kv{font-size:12px; color:#c6d5f3; opacity:.95}
.btn{border-radius:12px; padding:10px 14px; font:700 14px Inter; background:var(--pill); border:1px solid var(--line); color:var(--ink); cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#fff,#e6efff); color:#09121b; border-color:transparent}
.input,textarea{width:100%; background:#0f1420; border:1px solid var(--line); color:#e9eef7; border-radius:10px; padding:10px 12px; font:500 13px Inter}
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #26314a; border-radius:999px; background:rgba(10,16,28,.82); color:#cfe0ff; font-size:12px; backdrop-filter: blur(6px); margin-right:8px}
.help{font-size:12px; color:#9fb0d1}
.warn{color:var(--bad)}
.ok{color:var(--ok)}
.banner{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px dashed #2b3954; background:rgba(16,24,40,.35); font-size:13px}
.rightNote{float:right; opacity:.7}
.center{display:flex; align-items:center; justify-content:center}
.canvasWrap{height:360px; border-radius:16px; border:1px solid var(--line); background:radial-gradient(600px 380px at 50% 45%, rgba(120,160,255,.10), rgba(10,14,22,1) 65%)}
.small{font-size:12px}
.counts{font-size:12px; color:#9fb0d1}
.devbar{position:fixed; bottom:10px; right:10px; display:none; gap:8px}
.devbar.in{display:flex}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg viewBox="0 0 64 64" aria-hidden="true"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#86f7d6"/><stop offset="1" stop-color="#57a4ff"/></linearGradient></defs><circle cx="32" cy="32" r="28" stroke="url(#g)" stroke-width="2" fill="none"/><circle cx="20" cy="20" r="6" fill="url(#g)"/></svg>
    Galactly
  </div>
  <span class="badge"><span class="dot"></span><span id="presenceTxt">0 online</span></span>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="h">Live results <span class="rightNote counts" id="quotaNote">â€” searches left â€¢ â€” reveals left</span></div>
      <div class="canvasWrap center"><canvas id="ns" width="600" height="340" aria-hidden="true"></canvas></div>
      <div class="banner small" id="quotaBanner" style="display:none">Daily search quota reached.</div>

      <div class="banner small" id="verifyBanner" style="margin-top:12px">
        Verify your company to <strong>unlock free reveals</strong>. Use a business email that matches your website domain.
        <button class="btn" id="openVerify" style="margin-left:10px">Verify now</button>
      </div>

      <div class="banner small" style="margin-top:12px">
        Create your free Vault to save & revisit leads. <button class="btn" id="openSignup" style="margin-left:10px">Sign up</button>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="h">Train your AI</div>
      <div class="row" style="grid-template-columns: 1fr 160px;">
        <div>
          <div class="small help">Website</div>
          <input class="input" id="f_site" placeholder="yourcompany.com">
        </div>
        <div>
          <div class="small help">Regions</div>
          <input class="input" id="f_regions" placeholder="US, CA">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <div class="small help">Industries</div>
          <input class="input" id="f_industries" placeholder="beverage, confectionery">
        </div>
        <div>
          <div class="small help">Seed buyers (domains)</div>
          <input class="input" id="f_buyers" placeholder="brand1.com, brand2.com">
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="small help">Describe ideal customers</div>
        <textarea class="input" id="f_desc" rows="3" placeholder="materials, order sizes, channels, exclusions"></textarea>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn primary" id="btnFind">Find now</button>
        <div class="small help" id="saveMsg" style="margin-left:8px"></div>
      </div>

      <div class="h" style="margin-top:16px">Signals Preview (report)
        <span class="rightNote counts"><span id="freeCt">Free 0/0</span> â€¢ <span id="proCt">Pro 0/0</span></span>
      </div>
      <div id="preview" class="card" style="background:#0b101a; border-color:#1b273e; height:280px; overflow:auto"></div>
    </div>
  </div>
</div>

<!-- Dev bar -->
<div id="devbar" class="devbar">
  <button class="btn" id="devReset">Dev: reset quota</button>
  <button class="btn" id="devUnlimited">Dev: toggle unlimited</button>
</div>

<!-- API helper -->
<script src="./api-base.js"></script>
<script>
/* ---------- small utils ---------- */
const $ = sel => document.querySelector(sel);
const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
const LS = localStorage;

function csvToArr(v){ return (String(v||'').split(',').map(s=>s.trim()).filter(Boolean)); }
function bareHost(u){ return String(u||'').trim().replace(/^https?:\/\//i,'').replace(/\/.*$/,'').replace(/^www\./i,''); }

/* ---------- presence (use API host!) ---------- */
async function tickPresence() {
  try{
    const r=await fetch(window.API.url('/presence/online'), {cache:'no-store'});
    const j=await r.json();
    $('#presenceTxt').textContent = (j.total||0)+' online';
  }catch{}
}
setInterval(tickPresence, 12000); tickPresence();

/* ---------- neutron star (simple) ---------- */
(function(){
  const c=$('#ns'); if(!c||!c.getContext) return; const ctx=c.getContext('2d');
  let t=0; function frame(){
    const w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
    ctx.strokeStyle='rgba(180,210,255,0.12)'; for(let i=1;i<=4;i++){ ctx.beginPath(); ctx.arc(w/2,h/2,40*i,0,Math.PI*2); ctx.stroke();}
    ctx.strokeStyle='rgba(210,235,255,0.45)'; ctx.beginPath(); ctx.arc(w/2,h/2,35,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(w/2,h/2,24,0,Math.PI*2); ctx.fill();
    ctx.save(); ctx.translate(w/2,h/2); ctx.rotate(t/90); ctx.strokeStyle='rgba(160,200,255,0.25)';
    for(let i=0;i<6;i++){ ctx.rotate(Math.PI/3); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-80); ctx.stroke(); }
    ctx.restore();
    ctx.fillStyle='rgba(255,255,255,0.9)'; for(let i=0;i<80;i++){ const a=i/80*Math.PI*2 + t/220; const r=100+40*Math.sin(i+t/30); const x=w/2+Math.cos(a)*r, y=h/2+Math.sin(a)*r; ctx.fillRect(x,y,1,1); }
    t++; requestAnimationFrame(frame);
  } frame();
})();

/* ---------- prefill Train-your-AI from onboarding ---------- */
(function prefill(){
  const site  = LS.getItem('onb_vendor') || '';
  const regs  = LS.getItem('onb_regions') || '';
  const inds  = LS.getItem('onb_industries') || '';
  const buys  = LS.getItem('onb_buyers') || '';
  const desc  = LS.getItem('onb_desc') || '';
  $('#f_site').value = site;
  $('#f_regions').value = regs;
  $('#f_industries').value = inds || 'beverage, confectionery';
  $('#f_buyers').value = buys;
  $('#f_desc').value = desc;
})();

/* ---------- status & quotas (no-store) ---------- */
let STATE = { findsLeft: 0, revealsLeft: 0, proTotal:1126, freeDone:0, proDone:0 };
async function refreshStatus(){
  const r = await fetch(window.API.url('/api/v1/status'), {cache:'no-store'});
  const j = await r.json();
  const q = j.quota||{};
  STATE.findsLeft = q.findsLeft|0; STATE.revealsLeft = q.revealsLeft|0;
  $('#quotaNote').textContent = `${STATE.findsLeft} searches left â€¢ ${STATE.revealsLeft} reveals left`;
  $('#quotaBanner').style.display = STATE.findsLeft<=0 ? 'block':'none';
  // Show verify banner only when not domainMatch
  $('#verifyBanner').style.display = (j.gate && j.gate.domainMatch) ? 'none' : 'block';
}
refreshStatus();

/* ---------- save & find ---------- */
on($('#btnSave'),'click', async ()=>{
  const traits = {
    vendorDomain: bareHost($('#f_site').value),
    regions: csvToArr($('#f_regions').value),
    industries: csvToArr($('#f_industries').value),
    buyers: csvToArr($('#f_buyers').value),
    notes: $('#f_desc').value||null
  };
  // persist also to localStorage
  LS.setItem('onb_vendor', traits.vendorDomain||'');
  LS.setItem('onb_regions', traits.regions.join(', '));
  LS.setItem('onb_industries', traits.industries.join(', '));
  LS.setItem('onb_buyers', traits.buyers.join(', '));
  LS.setItem('onb_desc', traits.notes||'');
  try{
    await fetch(window.API.url('/api/v1/vault'), {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({traits})});
    $('#saveMsg').textContent='Saved.';
    setTimeout(()=>$('#saveMsg').textContent='', 1500);
  }catch(e){ $('#saveMsg').textContent='Save failed'; }
});

on($('#btnFind'),'click', async ()=>{
  await refreshStatus();
  if(STATE.findsLeft<=0){ $('#quotaBanner').style.display='block'; return; }
  try{
    const r=await fetch(window.API.url('/api/v1/find-now'), {method:'POST', headers:{'content-type':'application/json'}, cache:'no-store', body:'{}'});
    const j=await r.json();
    if(!j.ok){ $('#quotaBanner').style.display='block'; return; }
    await refreshStatus();
    startPreviewSSE();
  }catch(e){}
});

/* ---------- signals preview (SSE) ---------- */
let es=null;
function line(txt){ const el=document.createElement('div'); el.className='pill'; el.textContent=txt; return el; }
function startPreviewSSE(){
  if(es){ es.close(); es=null; }
  $('#preview').innerHTML='';
  es = new EventSource(window.API.url('/api/v1/progress.sse'));
  es.addEventListener('tick', ev=>{
    const t=JSON.parse(ev.data);
    const lanes = t.lane==='free' ? '#freeCt' : '#proCt';
    if(t.lane==='free') $('#freeCt').textContent = `Free ${t.done}/${t.total}`;
    else $('#proCt').textContent = `Pro ${t.done}/${t.total}${t.locked?' ðŸ”’':''}`;
    const div = document.createElement('div'); div.style.margin='6px 0';
    const hd = document.createElement('div'); hd.className='small help'; hd.textContent = `${t.category} â†’ ${t.lane}`;
    div.appendChild(hd);
    const wrap = document.createElement('div'); t.chain.forEach(s=>wrap.appendChild(line(s))); div.appendChild(wrap);
    $('#preview').appendChild(div);
    $('#preview').scrollTop = 1e6;
  });
  es.addEventListener('halt', ev=>{
    const d=JSON.parse(ev.data);
    const ups=document.createElement('div'); ups.className='banner small'; ups.innerHTML = `Free run paused. Unlock full scan & auto-enrichment. <a class="btn" href="/checkout/stripe?plan=pro" style="margin-left:8px">Upgrade</a>`;
    $('#preview').appendChild(ups);
  });
  es.addEventListener('done', ()=>{ /* no-op */ });
}

/* ---------- sign up / verify actions ---------- */
on($('#openSignup'),'click', ()=>{ location.href = './index.html?openOnb=1'; });
on($('#openVerify'),'click', ()=>{ location.href = './index.html?openOnb=1&verify=1'; });

/* ---------- Dev testing (no quota pain) ---------- */
(function dev(){
  const url = new URL(location.href);
  if(url.searchParams.get('debug')==='1') LS.setItem('DEBUG','1');
  if(LS.getItem('DEBUG')==='1'){ $('#devbar').classList.add('in'); }
  on($('#devReset'),'click', async ()=>{
    try{
      const r=await fetch(window.API.url('/api/v1/debug/reset'), {method:'POST'}); 
      if(r.ok){ await refreshStatus(); alert('quota reset'); } else { alert('reset endpoint disabled'); }
    }catch{ alert('reset endpoint disabled'); }
  });
  on($('#devUnlimited'),'click', async ()=>{
    // toggle a client-side flag that server can read from header if you want to implement unlimited per-user
    if(LS.getItem('DEV_UNLIM')==='1'){ LS.removeItem('DEV_UNLIM'); alert('unlimited OFF'); }
    else { LS.setItem('DEV_UNLIM','1'); alert('unlimited ON (requires server support)'); }
  });
})();
</script>
</body>
</html>
