```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly — Free Lead Panel</title>
  <script src="./api-base.js"></script>
  <style>
    body{font-family:System-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b0e13;color:#e8ecf1;margin:0}
    header{padding:16px 20px;border-bottom:1px solid #1e2430;display:flex;gap:16px;align-items:center;justify-content:space-between}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:14px}
    .card{background:#111725;border:1px solid #1f2a3b;border-radius:14px;padding:12px;position:relative}
    .meta{opacity:.75;font-size:12px}
    .title{font-weight:600;margin:6px 0}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .chip{font-size:11px;border:1px solid #2a3b55;border-radius:999px;padding:2px 8px;opacity:.85}
    .btn{background:#1e2a3b;border:1px solid #2a3b55;color:#e8ecf1;padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    #modal{position:fixed;inset:0;background:rgba(5,8,12,.7);display:none;align-items:center;justify-content:center}
    #modal .box{background:#0f1522;border:1px solid #263149;border-radius:16px;max-width:720px;width:92%;padding:16px}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<header>
  <div><strong>Galactly</strong> <span id="status" class="chip">connecting…</span></div>
  <div class="row">
    <input id="api" size="42" placeholder="https://<YOUR-NF>.app"/>
    <button class="btn" id="save">Save API</button>
    <button class="btn" id="refresh">Refresh</button>
  </div>
</header>
<div class="wrap">
  <div id="quota" class="meta" style="margin:6px 2px 12px"></div>
  <div id="feed" class="grid"></div>
</div>

<div id="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <div><div id="m_title" class="title"></div><div id="m_meta" class="meta"></div></div>
      <button class="btn" id="m_close">Close</button>
    </div>
    <div id="m_body" style="margin-top:8px"></div>
  </div>
</div>

<script>
const uidKey='galactly_uid'; let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
const apiInp=document.getElementById('api'); apiInp.value = localStorage.getItem('apiBase')||window.API_BASE||'';
document.getElementById('save').onclick=()=>{ window.__setApiBase(apiInp.value); location.reload(); };

const quotaKey='daily_reveals_v1'; const quotaMax=2; function quota(){ const d=new Date().toISOString().slice(0,10); const raw=localStorage.getItem(quotaKey); let obj=raw?JSON.parse(raw):{day:d,used:0}; if(obj.day!==d){obj={day:d,used:0}; localStorage.setItem(quotaKey,JSON.stringify(obj)); } return obj; }
function incQuota(){ const q=quota(); q.used++; localStorage.setItem(quotaKey,JSON.stringify(q)); renderQuota(); }
function renderQuota(){ const q=quota(); document.getElementById('quota').textContent=`Free plan: ${quotaMax-q.used} deep reveals left today`; }

function api(p){ return (window.API_BASE||'').replace(/\/$/,'') + p; }
async function get(path){ const r=await fetch(api(path), { headers:{'x-galactly-user':uid} }); return r.json(); }
async function post(path, body){ const r=await fetch(api(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body||{})}); return r.json(); }

let RULES=[]; (async()=>{ try{ const r=await get('/api/v1/ifthen'); if(r?.ok) RULES=r.rules||[]; }catch{} })();

let data=null; const feed=document.getElementById('feed');
function chip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; return s; }

function openModal(lead){
  const q=quota(); if(q.used>=quotaMax){ alert('Free daily detail views used. Upgrade to Pro for unlimited.'); return; }
  const box=document.getElementById('modal'); box.style.display='flex';
  document.getElementById('m_title').textContent=lead.title||'Untitled';
  const host = (()=>{ try{return new URL(lead.source_url).hostname;}catch{return '';} })();
  document.getElementById('m_meta').textContent=`${lead.platform||'source'} • ${host}`;

  const why=[]; if((lead.kw||[]).includes('case')) why.push('Case/pack sizing on PDP'); if((lead.kw||[]).includes('procurement')) why.push('Procurement page open'); if((lead.kw||[]).includes('ads')) why.push('Active ads observed');
  const rules = RULES.slice(0,6).map(r=>`<li><strong>${r.name}</strong> — lift +${Math.round(r.lift*100)}% <span class="meta">(${r.when})</span><br/><span class="meta">${r.explain}</span></li>`).join('');

  document.getElementById('m_body').innerHTML = `
    <div class="chips">${why.map(w=>`<span class=chip>${w}</span>`).join('')}</div>
    <p><strong>Confidence:</strong> ${lead.heat||70}/100</p>
    <details open><summary><strong>Why this buyer</strong></summary>
      <ul>${rules}</ul>
    </details>
    <div style="margin-top:8px" class="meta">Tip: Press and hold on cards to preview without spending reveal. Click <em>Reveal details</em> to consume 1 of your daily reveals.</div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="m_open">Open Proof</button>
      <button class="btn" id="m_confirm">Looks right</button>
      <button class="btn" id="m_mute">Mute domain</button>
    </div>`;
  document.getElementById('m_open').onclick=()=>{ try{ window.open(lead.source_url,'_blank','noopener'); }catch{} };
  document.getElementById('m_confirm').onclick=async()=>{ await post('/api/v1/events',{type:'confirm_ad', leadId:lead.id, meta:{ url:lead.source_url, platform:lead.platform }}); incQuota(); closeModal(); };
  document.getElementById('m_mute').onclick=async()=>{ let host=''; try{host=new URL(lead.source_url).hostname;}catch{} await post('/api/v1/events',{type:'mute_domain', leadId:lead.id, meta:{ domain: host }}); closeModal(); fetchLeads(); };
}
function closeModal(){ const box=document.getElementById('modal'); box.style.display='none'; }
 document.getElementById('m_close').onclick=closeModal;
 document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });

function card(lead){
  const d=document.createElement('div'); d.className='card';
  let host=''; try{host=new URL(lead.source_url).hostname;}catch{}
  d.innerHTML = `<div class="meta">${lead.platform||'source'} • ${host}</div>
    <div class="title">${escapeHtml(lead.title||'Untitled')}</div>
    <div class="meta">Heat ${lead.heat||70}/100</div>
    <div class="chips"></div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button class="btn" data-a="reveal">Reveal details</button>
      <button class="btn" data-a="open">Open</button>
    </div>`;
  const chips=d.querySelector('.chips');
  (lead.kw||[]).slice(0,3).forEach(k=> chips.appendChild(chip(k)) );
  d.querySelector('[data-a=reveal]').onclick=()=>openModal(lead);
  d.querySelector('[data-a=open]').onclick=()=>{ window.open(lead.source_url,'_blank','noopener'); };
  // long-press preview (1.5s)
  let t=null; function down(){ t=setTimeout(()=>openModal(lead),1500);} function up(){ if(t) clearTimeout(t); }
  d.addEventListener('mousedown',down); d.addEventListener('touchstart',down); d.addEventListener('mouseup',up); d.addEventListener('mouseleave',up); d.addEventListener('touchend',up);
  return d;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

async function fetchLeads(){
  try{
    const r=await get('/api/v1/leads');
    if(!r?.ok) throw new Error('bad');
    document.getElementById('status').textContent='ok';
    renderQuota();
    data=r; feed.innerHTML='';
    r.leads.forEach(L=> feed.appendChild(card(L)) );
    setTimeout(fetchLeads, (r.nextRefreshSec||20)*1000);
  }catch(e){ document.getElementById('status').textContent='retrying'; setTimeout(fetchLeads, 5000); }
}

document.getElementById('refresh').onclick=fetchLeads; fetchLeads();
</script>
</body>
</html>
