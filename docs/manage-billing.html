<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly — Manage Billing</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#121822;--divider:#1b2531;
    --text:#e9f1f7;--muted:#8aa0b2;--cta:#6de1ff;--ctaText:#082433
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,Segoe UI,Inter,Arial}
  .wrap{max-width:760px;margin:15vh auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:22px;text-align:center}
  h1{margin:0 0 8px;font-weight:700}
  p{margin:6px 0 18px}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 16px;border-radius:12px;
    border:1px solid var(--divider);background:#152333;color:#cfe0ee;cursor:pointer;text-decoration:none}
  .btn.primary{background:var(--cta);border:none;color:var(--ctaText);font-weight:800}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Billing Portal</h1>
    <p id="msg" class="muted">Connecting you to Stripe…</p>
    <div style="margin-top:1.2rem">
      <a id="retry" href="#" class="btn" style="display:none">Retry</a>
      <a href="free-panel.html" class="btn">Back to Dashboard</a>
    </div>
  </div>
</div>

<script>
(async()=>{
  const msg = document.getElementById("msg");
  const retry = document.getElementById("retry");

  function getApiBase(){
    const raw = localStorage.getItem("apiBase")||"";
    let b = raw.trim().replace(/\/+$/,"");
    const m=b.match(/^(.*?)(?:\/api(?:\/.*)?)$/i); if(m) b=m[1];
    return b?b+"/api":(location.origin+"/api");
  }

  async function getPortal(){
    const base = getApiBase();
    const email = localStorage.getItem("fp.user.email")||"";
    const headers={"Content-Type":"application/json"}; if(email) headers["x-user-email"]=email;
    try{
      const r = await fetch(base+"/v1/onboard/portal",{method:"POST",headers});
      const j = await r.json();
      if(j && j.url){ window.location.href=j.url; return; }
      msg.textContent="No billing portal available for this account.";
      retry.style.display="inline-flex";
    }catch(e){
      msg.textContent="Failed to connect: "+(e?.message||e);
      retry.style.display="inline-flex";
    }
  }

  retry.onclick=(e)=>{ e.preventDefault(); msg.textContent="Retrying…"; retry.style.display="none"; getPortal(); };
  getPortal();
})();
</script>
</body>
</html>