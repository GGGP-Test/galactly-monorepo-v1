<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Step 3 — Tune by industry</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121822; --panel2:#0e141c; --muted:#8aa0b2; --text:#e9f1f7;
    --cta:#6de1ff; --ctaText:#082433; --divider:#1b2531; --ring:#24435f;
    --chip:#162235; --chipHi:#103247; --ok:#38e08f;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .crumb{background:#0f1723;border:1px solid var(--divider);padding:6px 10px;border-radius:10px}
  .pill{padding:4px 8px;border-radius:999px;background:#102033;color:#8fb0c6;font-size:12px}
  .btn{display:inline-flex;align-items:center;gap:.6rem;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
  .btn.pri{background:var(--cta);color:var(--ctaText)}
  .btn.sec{background:#152333;color:#cfe0ee}
  .btn.ghost{background:#0f1723;color:#9ec4de;border:1px solid var(--divider)}
  .btn.smol{padding:6px 10px;border-radius:10px;font-weight:600}
  .xlink{color:#a9c7de;text-decoration:none}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--divider);border-radius:16px}
  .card-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--divider)}
  .card-bd{padding:12px 14px}
  .hint{font-size:12px;color:#9cb3c8}
  .token{display:inline-flex;align-items:center;padding:4px 8px;margin:2px;border-radius:10px;background:#0e1622;border:1px solid var(--divider)}
  .one{font-weight:700}
  .sentence .editable{border-bottom:1px dashed #3a5572;cursor:text}
  .sentence.editing .editable{background:#0f1926;border:1px solid #2b425a;border-radius:8px;padding:2px 4px}
  .sentence .editable:focus{outline:2px solid var(--ring)}
  /* rotor */
  .rotor{height:420px;overflow:hidden;position:relative;background:var(--panel2);border:1px solid var(--divider);border-radius:14px}
  .rotor-list{list-style:none;margin:0;padding:0;position:absolute;inset:0;display:flex;flex-direction:column;align-items:stretch;gap:8px;scrollbar-width:none}
  .rotor-list::-webkit-scrollbar{display:none}
  .rotor-item{display:flex;align-items:center;justify-content:center;height:64px;flex:0 0 64px;color:#8fa6b9;
    transform-origin:center;transition:transform .12s ease,opacity .12s ease,color .12s ease,background .12s ease;
    border-radius:10px;margin:2px 8px}
  .rotor-item.active{color:#eaf6ff;background:#0f1c2a;border:1px solid #1f3246}
  .rotor-item.muted{opacity:.35;text-decoration:line-through}
  .rotor-overlay{position:absolute;inset:0;pointer-events:none;background:
      linear-gradient(180deg, rgba(11,15,20,0.85), rgba(11,15,20,0) 18%, rgba(11,15,20,0) 82%, rgba(11,15,20,0.85));border-radius:14px}
  .rotor-rail{position:absolute;left:0;right:0;top:50%;height:64px;margin-top:-32px;border:1px dashed #223045;border-left:0;border-right:0;pointer-events:none}
  .row{display:grid;grid-template-columns:1fr 280px;gap:12px;align-items:center;margin:10px 0}
  .row input[type=range]{width:100%}
  .h4{margin:8px 0 6px}
  .chips{user-select:none}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);
    color:#cfe0ee;margin:6px 8px 0 0;border:1px solid #203041;cursor:pointer}
  .chip.active{background:var(--chipHi);color:#eaf7ff;border-color:#1b4862}
  input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--divider);background:#0d1520;color:var(--text)}
  input[type=text]:focus{border-color:#385dff66;box-shadow:0 0 0 4px #2a3f5a66;outline:none}
  .badge{font-size:12px;padding:3px 8px;border-radius:11px;border:1px solid var(--divider);color:#a8c3d8}
  .badge.ok{color:#0f0}
  .stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <!-- one-liner header (single instance) -->
  <div class="card">
    <div class="card-bd">
      <div class="stack" style="justify-content:space-between">
        <div class="stack">
          <img id="fav" alt="" width="24" height="24" style="border-radius:6px;border:1px solid #2a3a4a;background:#fff"/>
          <div id="line" class="sentence one"></div>
        </div>
        <div class="right">
          <span id="apiBadge" class="badge">API: resolving…</span>
          <button id="editLine" class="btn smol ghost" type="button">Edit</button>
          <button id="doneLine" class="btn smol pri" type="button" hidden>Done</button>
          <a id="refresh" href="#" class="btn smol sec">Refresh from website</a>
          <a href="index.html" class="btn smol ghost">Back</a>
        </div>
      </div>
      <div id="status" class="hint" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="card-hd">
      <div class="stack">
        <span class="pill">Step 3</span>
        <strong>Tune by industry</strong>
      </div>
      <button id="advToggle" class="btn smol ghost"><span id="advLbl">Show advanced ▾</span></button>
    </div>

    <div class="card-bd" id="adv" hidden>
      <div class="grid">
        <!-- rotor -->
        <div>
          <div class="stack" style="justify-content:space-between;margin:0 4px 6px">
            <span class="hint">Industries</span>
            <label class="hint" style="display:flex;gap:6px;align-items:center"><input id="hideMuted" type="checkbox"> Hide muted</label>
          </div>
          <div class="rotor" id="rotor">
            <ul id="rotorList" class="rotor-list"></ul>
            <div class="rotor-rail"></div>
            <div class="rotor-overlay"></div>
          </div>
          <div class="hint" style="margin-top:6px">Scroll, drag or click to pick. Center item is active.</div>
        </div>

        <!-- industry detail -->
        <div>
          <div class="card" style="background:#0f1826">
            <div class="card-hd">
              <div class="stack">
                <strong id="panelTitle">Industry</strong>
                <label class="hint" style="display:flex;gap:6px;align-items:center"><input id="aiDecide" type="checkbox"> Let AI decide</label>
              </div>
              <button id="muteBtn" class="btn smol ghost">Mute</button>
            </div>
            <div class="card-bd" id="industryPane">
              <div id="metricBox"></div>

              <div class="h4"><strong id="opsTitle">Buyer operations for …</strong></div>
              <div id="opsChips" class="chips"></div>
              <div id="opsSliders"></div>

              <div class="h4" style="margin-top:10px"><strong id="tgtTitle">Targeting for …</strong></div>
              <div class="row">
                <div>
                  <input id="city" type="text" placeholder="Boost near city (e.g., HQ)">
                  <div id="cityChips" class="chips" style="margin-top:6px"></div>
                </div>
                <div>
                  <input id="titles" type="text" placeholder="Priority titles (comma-separated)">
                  <div class="hint">e.g., Operations Manager, Procurement, Plant Manager</div>
                </div>
              </div>

            </div>
          </div>

          <div class="right" style="justify-content:flex-end;margin-top:12px">
            <button id="save" class="btn sec">Save</button>
            <button id="finish" class="btn pri">Finish</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{
  // ---------- helpers ----------
  const $=q=>document.querySelector(q);
  const $$=q=>Array.from(document.querySelectorAll(q));
  const normHost=h=>(h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,"");
  const getS=(k,d)=>{try{const v=localStorage.getItem(k);return v===null?d:v}catch{return d}};
  const setS=(k,v)=>{try{localStorage.setItem(k,v)}catch{}};
  const fav=$("#fav"); const line=$("#line"); const apiBadge=$("#apiBadge"); const statusEl=$("#status");

  // ---------- seed ----------
  const seed = JSON.parse(getS("onb.seed","{}"));
  const host = normHost(seed.host||getS("fp.supplier.host",""));
  function setFav(h){ fav.src = h?("https://icons.duckduckgo.com/ip3/"+encodeURIComponent(h)+".ico"):""; }
  setFav(host);

  // ---------- API detect ----------
  async function apiDetect(){
    const tries=[getS("apiBase",""), location.origin+"/api", location.origin].filter(Boolean);
    for (const t of tries){
      const base=(t||"").replace(/\/+$/,"");
      const url = /\/api$/.test(base) ? base+"/health" : base+"/api/health";
      try{ const r=await fetch(url,{credentials:"omit"}); if(r.ok){ setS("apiBase",base); apiBadge.textContent="API: online"; apiBadge.classList.add("ok"); return base; } }catch{}
    }
    apiBadge.textContent="API: offline"; apiBadge.classList.remove("ok"); apiBadge.classList.add("err"); return (tries[0]||location.origin+"/api").replace(/\/+$/,"");
  }
  function classifyURL(b){ return /\/api$/.test(b)?(b+"/classify"):(b+"/api/classify"); }

  // ---------- one-liner ----------
  const state = {
    line:{host,verb:"supplies",products:"packaging",audience:"brands",region:"the U.S.",contacts:"Operations, Procurement"},
    ai:{ summary:"", productTags:[], sectorHints:[], evidence:[] },
    industries:[],             // [{key,label,muted:false,metrics:[{label,lo,hi,value}], ops:[..], opsWeights:Map, city:"", titles:"", aiDecide:false}]
    active:0
  };

  function drawLine(edit=false){
    const L=state.line;
    line.className="sentence one"+(edit?" editing":"");
    line.innerHTML="";
    const parts=[
      {txt:L.host,lock:true},
      {txt:"—",lock:true},
      {k:"verb",txt:L.verb},
      {k:"products",txt:L.products},
      {txt:"for",lock:true},
      {k:"audience",txt:L.audience},
      {txt:"in",lock:true},
      {k:"region",txt:L.region},
      {txt:".",lock:true},
      {txt:"Best contacts:",lock:true},
      {k:"contacts",txt:L.contacts}
    ];
    for(const p of parts){
      const span=document.createElement("span");
      span.className = "token "+(p.k?"editable":"");
      if(!p.lock && p.k){ span.contentEditable = edit; span.addEventListener("input",()=>{ state.line[p.k]=span.textContent.trim(); });}
      span.textContent=p.txt; line.appendChild(span); line.appendChild(document.createTextNode(" "));
    }
  }
  drawLine(false);
  $("#editLine").addEventListener("click",()=>{drawLine(true); $("#editLine").hidden=true; $("#doneLine").hidden=false;});
  $("#doneLine").addEventListener("click",()=>{drawLine(false); $("#editLine").hidden=false; $("#doneLine").hidden=true;});

  // ---------- industry library (precise metrics w/ 0–10 anchors) ----------
  const LIB = {
    beverage: {
      metrics:[
        ["High-speed line compatibility","0=manual/slow only — 10=proven at ≥500+ units/min (or ≥30 cases/min)"],
        ["Retail-ready print consistency","0=frequent color drift/misregister — 10=ΔE<2 & tight register @ volume"],
        ["Condensation tolerance","0=fails with light sweat — 10=survives heavy condensation (coolers/retort)"],
        ["Pallet stability for bottlers","0=shifts/collapses — 10=stable to ISTA 3A/3E or in-house equivalent"],
        ["Case integrity for glass/plastic","0=breakage/deformation — 10=spec holds @ peak load/transport"],
        ["Damage reduction targets in transit","0=no target — 10=meets ≤0.5% damage KPI"]
      ],
      ops:["Automated pallet wrapper","Hand pallet wrapping","E-commerce fulfillment","3PL / distribution"],
      titles:["Operations","Procurement","Plant Manager"]
    },
    food: {
      metrics:[
        ["Food-contact compliance (FDA/EC)","0=uncertified — 10=fully certified with documentation"],
        ["Oxygen/moisture barrier","0=none — 10=validated OTR/WVTR for shelf-life target"],
        ["Traceability & COA","0=none — 10=lot-level COA + recall-ready"],
        ["Sealing performance","0=frequent leaks — 10=validated hermetic seal @ scale"],
        ["Print/label regs","0=non-compliant — 10=GHS/NLEA compliant @ scale"]
      ],
      ops:["E-commerce fulfillment","Warehouse pick/pack","3PL / distribution"],
      titles:["Quality","Food Safety","Operations"]
    },
    cosmetics:{
      metrics:[
        ["Premium print/finish expectations","0=basic CMYK — 10=foil/spot UV/emboss @ scale"],
        ["Color consistency delta-E","0=ΔE>6 — 10=ΔE≤2"],
        ["Unboxing experience","0=plain — 10=designed tactile experience"]
      ],
      ops:["E-commerce fulfillment","3PL / distribution","Co-packing"],
      titles:["Brand","Operations","Procurement"]
    },
    electronics:{
      metrics:[
        ["ESD protection requirements","0=not needed — 10=ANSI/ESD S541-compliant"],
        ["Shock/vibration protection","0=insufficient — 10=drop/ISTA validated"],
        ["Moisture control","0=none — 10=desiccant & barrier spec maintained"]
      ],
      ops:["Warehouse pick/pack","3PL / distribution"],
      titles:["Operations","Supply Chain","Manufacturing"]
    },
    industrial:{
      metrics:[
        ["Heavy-load stability","0=frequent shift — 10=validated unitization"],
        ["Puncture/tear resistance","0=tears common — 10=spec meets peak hazards"],
        ["Automation uptime impact","0=frequent jams — 10=near-zero stops from packaging"]
      ],
      ops:["Automated pallet wrapper","3PL / distribution"],
      titles:["Operations","Procurement"]
    },
    logistics:{
      metrics:[
        ["3PL/e-com integration","0=manual — 10=ready labels/ASN/SLAs"],
        ["Damage in parcel","0=high — 10=≤0.5% returns due to damage"],
        ["Dock-to-stock speed","0=slow — 10=fast with ready SKUs"]
      ],
      ops:["E-commerce fulfillment","Warehouse pick/pack","3PL / distribution","Hand pallet wrapping"],
      titles:["Logistics","Warehouse","Operations"]
    },
    apparel:{
      metrics:[
        ["Presentation (crease/scuff)","0=issues common — 10=store-ready"],
        ["Parcel-rate optimization","0=oversized — 10=lowest practical DIM"],
        ["Return-friendly design","0=hassles — 10=easy reseal/scan"]
      ],
      ops:["E-commerce fulfillment","3PL / distribution"],
      titles:["E-com Ops","Logistics","Procurement"]
    }
  };

  // bottom-up weight guesser using evidence
  function scoreBySignals(metric, text){
    const t=(text||"").toLowerCase();
    let s=0.55; // prior
    const add=(w)=>{ s = 1 - (1-s)*(1-w); }; // combine as “at least one” prob
    const kw=(arr,w)=>{ if(arr.some(k=>t.includes(k))) add(w); };
    kw(["automation","line speed","throughput","ppm","cases/min"],0.35);
    if(/ista|drop|shock|vibration|retort|cooler/.test(t)) add(0.28);
    if(/fda|food|moisture|oxygen|wvtr|otr|barrier/.test(t)) add(0.35);
    if(/esd/.test(t)) add(0.35);
    if(/3pl|asn|e-?com|wms|fulfillment/.test(t)) add(0.35);
    if(/brand|print|delta[- ]?e|emboss|foil/.test(t)) add(0.3);
    if(/sustainab|pcr|recycl/.test(t)) add(0.2);
    // nudge if metric words appear
    const m = metric.toLowerCase().replace(/[^\w ]+/g," ").split(/\s+/).filter(Boolean);
    if (m.some(word=>t.includes(word))) add(0.25);
    // map prob to 0..10
    const v = Math.round(Math.max(0,Math.min(10, (s*10))));
    return v;
  }

  // ---------- rotor ----------
  const rotor = $("#rotor");
  const rotorList = $("#rotorList");
  function buildRotor(){
    rotorList.innerHTML="";
    const items = (state.industries||[]).filter(i=> !($("#hideMuted").checked && i.muted));
    items.forEach((ind,i)=>{
      const li=document.createElement("li");
      li.className="rotor-item"+(i===0?" active":"")+(ind.muted?" muted":"");
      li.textContent = ind.label;
      li.dataset.key = ind.key;
      li.addEventListener("click",()=> selectIndustryByKey(ind.key, true));
      rotorList.appendChild(li);
    });
    layoutRotor();
  }
  function layoutRotor(){
    const nodes = $$(".rotor-item");
    const box = rotor.getBoundingClientRect();
    const centerY = box.height/2;
    nodes.forEach(node=>{
      const rect = node.getBoundingClientRect();
      const y = (rect.top + rect.height/2) - box.top;
      const dy = (y - centerY) / 64; // steps
      const a = Math.max(-1, Math.min(1, dy));
      node.style.transform = `perspective(600px) translateZ(${(-Math.abs(a)*40)}px) scale(${1 - Math.abs(a)*0.08})`;
      node.style.opacity = String(1 - Math.abs(a)*0.45);
    });
    // update active highlight based on closest to center
    let best=null, bestDist=1e9, idx=-1;
    nodes.forEach((n,i)=>{
      const r=n.getBoundingClientRect();
      const y=(r.top+r.height/2)-box.top; const d=Math.abs(y-centerY);
      if(d<bestDist){bestDist=d; best=n; idx=i;}
    });
    nodes.forEach(n=>n.classList.remove("active"));
    if(best){ best.classList.add("active"); const key=best.dataset.key; const j = state.industries.findIndex(x=>x.key===key); if(j>=0 && j!==state.active){ state.active=j; renderIndustryPanel(); } }
  }
  function centerOnIndex(i){
    const nodes = $$(".rotor-item"); if(!nodes.length) return;
    const node = nodes[i]; if(!node) return;
    const top = node.offsetTop - (rotor.clientHeight/2 - node.clientHeight/2);
    rotorList.scrollTo({top, behavior:"smooth"});
  }
  function selectIndustryByKey(key, centerNow){
    const idx = state.industries.findIndex(x=>x.key===key);
    if (idx<0) return;
    state.active = idx;
    if(centerNow){
      const nodes = $$(".rotor-item");
      const i2 = nodes.findIndex(n=>n.dataset.key===key);
      if(i2>=0) centerOnIndex(i2);
    }
    renderIndustryPanel();
  }
  rotor.addEventListener("wheel",(e)=>{ e.preventDefault(); rotorList.scrollTop += e.deltaY; layoutRotor();},{passive:false});
  let drag=false, sy=0, st=0;
  rotor.addEventListener("pointerdown",e=>{ drag=true; sy=e.clientY; st=rotorList.scrollTop; rotor.setPointerCapture(e.pointerId);});
  rotor.addEventListener("pointermove",e=>{ if(!drag) return; rotorList.scrollTop = st + (sy - e.clientY); layoutRotor();});
  rotor.addEventListener("pointerup",()=>{ drag=false;});
  rotorList.addEventListener("scroll",()=> layoutRotor());
  $("#hideMuted").addEventListener("change",()=> buildRotor());

  // ---------- panel rendering ----------
  const metricBox=$("#metricBox"), opsChips=$("#opsChips"), opsSliders=$("#opsSliders");
  const panelTitle=$("#panelTitle"), opsTitle=$("#opsTitle"), tgtTitle=$("#tgtTitle");
  const cityEl=$("#city"), titlesEl=$("#titles"); const cityChips=$("#cityChips");
  const muteBtn=$("#muteBtn"); const aiDecide=$("#aiDecide");

  function addChip(text, box, onToggle){
    const s=document.createElement("span"); s.className="chip"; s.textContent=text;
    s.addEventListener("click",()=>{ const on=!s.classList.contains("active"); s.classList.toggle("active", on); onToggle && onToggle(on, text, s); });
    box.appendChild(s); return s;
  }

  function ensureOpSlider(ind,label){
    if (ind.opsWeights.has(label)) return;
    const wrap=document.createElement("div"); wrap.className="row"; wrap.dataset.label=label;
    const lab=document.createElement("div"); lab.textContent=label;
    const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value="7";
    input.addEventListener("input",()=>ind.opsWeights.set(label, Number(input.value)));
    wrap.appendChild(lab); wrap.appendChild(input); opsSliders.appendChild(wrap);
    ind.opsWeights.set(label,7);
  }
  function removeOpSlider(ind,label){
    const el=opsSliders.querySelector('[data-label="'+CSS.escape(label)+'"]'); if(el) el.remove();
    ind.opsWeights.delete(label);
  }

  function renderIndustryPanel(){
    const ind = state.industries[state.active]; if(!ind) return;
    panelTitle.textContent = ind.label;
    opsTitle.textContent = "Buyer operations for "+ind.label;
    tgtTitle.textContent = "Targeting for "+ind.label;
    aiDecide.checked = !!ind.aiDecide;
    muteBtn.textContent = ind.muted ? ("Unmute "+ind.label) : ("Mute "+ind.label);

    // metrics
    metricBox.innerHTML="";
    ind.metrics.forEach(m=>{
      const row=document.createElement("div"); row.className="row";
      const lab=document.createElement("div");
      lab.innerHTML = `<div><strong>${m.label}</strong></div><div class="hint">0—${m.lo} — 10—${m.hi}</div>`;
      const input=document.createElement("input"); input.type="range"; input.min="0"; input.max="10"; input.value=m.value;
      input.addEventListener("input",()=> m.value=Number(input.value));
      row.appendChild(lab); row.appendChild(input); metricBox.appendChild(row);
    });

    // ops
    opsChips.innerHTML=""; opsSliders.innerHTML="";
    ind.ops.forEach(op=>{
      const c = addChip(op, opsChips, (on,label)=> on?ensureOpSlider(ind,label):removeOpSlider(ind,label));
      if(ind.opsWeights.has(op)) c.classList.add("active");
    });
    for(const [lab,val] of ind.opsWeights.entries()){
      ensureOpSlider(ind, lab);
      const input = opsSliders.querySelector(`[data-label="${CSS.escape(lab)}"] input`);
      if (input) input.value = val;
      const chip = Array.from(opsChips.children).find(x=>x.textContent.trim()===lab); if(chip) chip.classList.add("active");
    }

    // target inputs
    cityEl.value = ind.city||"";
    titlesEl.value = ind.titles?.join(", ") || "";

    // quick picks
    cityChips.innerHTML="";
    ["New Jersey","Chicago","Los Angeles","New York","Dallas","Atlanta","Miami"].forEach(c=>{
      const ch=addChip(c, cityChips, (on,text)=>{ if(on){ cityEl.value=text; }});
      if (c===ind.city) ch.classList.add("active");
    });

    // reflect mute in rotor list
    $$(".rotor-item").forEach(n=>{ if(n.dataset.key===ind.key) n.classList.toggle("muted", ind.muted); });
  }

  muteBtn.addEventListener("click",()=>{
    const ind = state.industries[state.active]; if(!ind) return;
    ind.muted = !ind.muted; renderIndustryPanel();
  });
  aiDecide.addEventListener("change",()=>{
    const ind = state.industries[state.active]; if(!ind) return;
    ind.aiDecide = aiDecide.checked;
    if (ind.aiDecide){
      // auto-weight quickly from evidence
      const text = (state.ai.summary+" "+state.ai.productTags.join(" ")+" "+state.ai.evidence.join(" ")).toLowerCase();
      ind.metrics.forEach(m=>{ m.value = scoreBySignals(m.label, text); });
      renderIndustryPanel();
    }
  });
  cityEl.addEventListener("input",()=>{ const ind=state.industries[state.active]; if(ind) ind.city=cityEl.value.trim(); });
  titlesEl.addEventListener("input",()=>{ const ind=state.industries[state.active]; if(ind) ind.titles=titlesEl.value.split(",").map(s=>s.trim()).filter(Boolean); });

  // ---------- persona save/finish ----------
  function buildPersona(){
    const industriesPacked = state.industries.map(ind=>({
      key: ind.key, label: ind.label, muted: !!ind.muted, aiDecide: !!ind.aiDecide,
      metrics: ind.metrics.map(m=>({label:m.label,value:m.value})),
      operations: Array.from(ind.opsWeights.entries()).map(([label,value])=>({label,value})),
      targeting:{ city: ind.city||"", titles: ind.titles||[] }
    }));
    return {
      host, role: seed.role||"supplier", line: state.line,
      industries: industriesPacked,
      productTags: state.ai.productTags||[],
      sectorHints: state.ai.sectorHints||[]
    };
  }
  $("#save").addEventListener("click",()=>{
    const persona = buildPersona();
    setS("bf.persona", JSON.stringify(persona));
    setS("fp.persona", JSON.stringify(persona));
    setS("fp.autoImport","1");
    statusEl.textContent="Saved.";
  });
  $("#finish").addEventListener("click",()=>{
    $("#save").click();
    location.href="free-panel.html";
  });

  // ---------- fetch + apply ----------
  async function classify(host, email){
    const base = await apiDetect();
    const url = classifyURL(base)+`?host=${encodeURIComponent(host)}&email=${encodeURIComponent(seed.contact?.email||"")}`;
    try{
      const r=await fetch(url,{credentials:"omit"}); if(!r.ok) throw new Error(String(r.status));
      return await r.json();
    }catch(e){
      const alt = /\/api\/classify$/.test(url)?url.replace(/\/api\/classify$/,"/classify"):url.replace(/\/classify$/,"/api/classify");
      const r2=await fetch(alt,{credentials:"omit"}); if(!r2.ok) throw new Error(String(r2.status)); return await r2.json();
    }
  }

  function seedIndustries(ai){
    const hints = (ai.sectorHints||[]).map(s=>s.toLowerCase());
    const uniq = Array.from(new Set(hints.filter(k=>LIB[k])));
    const fallbacks = ["beverage","food","cosmetics","electronics","industrial","logistics","apparel"].filter(k=>LIB[k]);
    const keys = uniq.length? uniq : fallbacks;
    state.industries = keys.map(k=>{
      const src = LIB[k];
      return {
        key:k, label:k.charAt(0).toUpperCase()+k.slice(1), muted:false, aiDecide:false,
        metrics: src.metrics.map(([label,scale])=>({label, lo:scale.split("—")[0].replace(/^0=/,"").trim(), hi:scale.split("—").slice(-1)[0].replace(/^10=/,"").trim(), value:7})),
        ops: src.ops.slice(),
        opsWeights:new Map(),
        city:"",
        titles:(src.titles||[]).slice()
      };
    });
  }

  function prefillWeightsFromEvidence(ai){
    const text = (ai.summary+" "+(ai.productTags||[]).join(" ")+" "+(ai.evidence||[]).join(" ")).toLowerCase();
    state.industries.forEach(ind=>{
      ind.metrics.forEach(m=>{ m.value = scoreBySignals(m.label, text); });
      // small nudges per industry keywords
      if (/e-?com|3pl|fulfill|warehouse/.test(text) && /logistics|apparel|food|cosmetics/.test(ind.key)) {
        ind.opsWeights.set("E-commerce fulfillment",8);
        ind.opsWeights.set("3PL / distribution",7);
      }
    });
  }

  function applyAI(ai){
    state.ai = ai;
    // one-liner
    const prods = (ai.productTags||[]).slice(0,5).join(", ") || "packaging";
    const segs  = (ai.sectorHints||[]).slice(0,3).join(", ") || "brands";
    const contacts = /ops|operation|procure|plant|warehouse|supply|logistics/i.test(((ai.summary||"")+" "+(ai.productTags||[]).join(",")).toLowerCase())
      ? "Operations, Procurement" : "Procurement, Marketing";
    state.line = { host, verb:"supplies", products:prods, audience:segs, region:"the U.S.", contacts };
    drawLine(false);
  }

  async function boot(){
    if (!host){ line.textContent="Missing host — open index.html first."; return; }
    setFav(host);
    try{
      const ai = await classify(host, seed.contact?.email||"");
      statusEl.textContent = ai.cached ? "(cached)" : "";
      apiBadge.textContent = "API: online"; apiBadge.classList.add("ok");
      applyAI(ai);
      seedIndustries(ai);
      prefillWeightsFromEvidence(ai);
    }catch(e){
      statusEl.textContent="(offline — using defaults)";
      seedIndustries({sectorHints:[]});
    }
    buildRotor();
    centerOnIndex(0);
    renderIndustryPanel();
  }

  // advanced toggle default hidden
  $("#advToggle").addEventListener("click",(e)=>{
    e.preventDefault();
    const open = $("#adv").hasAttribute("hidden");
    if (open){ $("#adv").removeAttribute("hidden"); $("#advLbl").textContent="Hide advanced ▲"; }
    else { $("#adv").setAttribute("hidden",""); $("#advLbl").textContent="Show advanced ▾"; }
  });

  // refresh
  $("#refresh").addEventListener("click",(e)=>{ e.preventDefault(); boot(); });

  boot();
})();
</script>
</body>
</html>