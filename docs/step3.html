<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Galactly — Step 3</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1622; --panel-2:#0c1320;
    --muted:#8aa0b2; --text:#e9f1f7; --brand:#8ae3ff;
    --cta:#6de1ff; --ctaText:#082433; --divider:#1b2531;
    --chip:#152437; --chipOn:#103247;
    --accent:#ff7a44;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
  .crumbs{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 16px}
  .crumb{padding:6px 10px;border-radius:999px;background:#0e1a28;border:1px solid var(--divider);color:#cfe0ee}
  .btn{display:inline-flex;align-items:center;gap:.5rem;padding:10px 14px;border-radius:12px;
    background:#183046;color:#cfe0ee;border:1px solid var(--divider);cursor:pointer}
  .btn.primary{background:var(--cta);color:var(--ctaText);border:none}
  .btn.small{padding:6px 10px;border-radius:10px}
  .badge{font-size:12px;padding:5px 8px;border-radius:10px;border:1px solid var(--divider);background:#0d1724;color:#9cb6cc}
  .badge.click{cursor:pointer}
  h1{font-size:22px;margin:4px 0 14px}
  .panel{background:var(--panel);border:1px solid var(--divider);border-radius:16px}
  .panel-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--divider)}
  .panel-bd{padding:14px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
  .muted{color:#93a8bb}
  .hint{font-size:12px;color:#9bb2c8}
  .section{background:var(--panel-2);border:1px solid var(--divider);border-radius:14px;margin:14px 0}
  .section-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--divider)}
  .section-bd{padding:12px 14px}

  /* rotor */
  .rotor{height:420px;overflow:auto;scroll-snap-type:y mandatory;background:#0e1826;border:1px solid var(--divider);border-radius:14px;position:relative}
  .rotor-list{margin:0;padding:40px 0 40px 0;list-style:none}
  .rotor-item{scroll-snap-align:center;display:flex;align-items:center;justify-content:center;height:56px;transition:transform .18s ease,opacity .18s ease;
    color:#9fb4c8;font-weight:600}
  .rotor-item.active{color:#eaf7ff}
  .rotor .centerline{position:absolute;left:8px;right:8px;top:calc(50% - 28px);height:56px;border-radius:12px;background:linear-gradient(180deg,#0f2238,#0e1a2a);border:1px dashed #1e2f43;pointer-events:none}
  .rotor .sublabel{position:absolute;left:12px;bottom:8px;font-size:12px;color:#7f9ab2}

  /* scale/opacity is JS computed; these are baseline values */
  .rotor-item{opacity:.35;transform:scale(.88)}
  .rotor-item.near{opacity:.7;transform:scale(.95)}
  .rotor-item.active{opacity:1;transform:scale(1.08)}

  /* slider */
  .row{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:center;margin:10px 0}
  .lab{font-weight:700}
  .sub{font-size:12px;color:#93a8bb}
  input[type=range]{width:100%}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);color:#cfe0ee;border:1px solid #213448;border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip.on{background:var(--chipOn);border-color:#1b4862;color:#eaf7ff}

  /* double range (revenue) */
  .r-wrap{position:relative;height:30px}
  .r-wrap input[type=range]{position:absolute;left:0;right:0;top:6px;height:20px;background:transparent;-webkit-appearance:none;appearance:none;margin:0}
  .r-wrap input::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid #000;cursor:pointer;position:relative;z-index:2}
  .r-wrap input::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid #000;cursor:pointer;position:relative;z-index:2}
  .r-track{position:absolute;left:0;right:0;top:14px;height:4px;background:#24364a;border-radius:999px}
  .r-active{position:absolute;top:14px;height:4px;background:#ff8c5e;border-radius:999px}

  /* responsive */
  @media(max-width:980px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- crumbs / one-liner -->
  <div class="crumbs" id="crumbs">
    <span class="crumb" id="c-host">host</span>
    <span class="crumb" id="c-supplies">supplies</span>
    <span class="crumb">for</span>
    <span class="crumb" id="c-ind">industry</span>
    <span class="crumb">in</span>
    <span class="crumb" id="c-geo">the U.S.</span>
    <span class="crumb">Best contacts:</span>
    <span class="crumb" id="c-contacts">Procurement, Marketing</span>
    <span class="badge click" id="apiBadge">API: offline</span>
    <button class="btn small" id="backBtn">Back</button>
  </div>

  <h1>Step 3</h1>

  <div class="grid">
    <!-- Rotor column -->
    <div>
      <div class="panel">
        <div class="panel-hd">
          <strong>Industries</strong>
          <label class="hint"><input type="checkbox" id="toggleHideMuted"/> Hide muted</label>
        </div>
        <div class="panel-bd">
          <div class="rotor" id="rotor">
            <div class="centerline"></div>
            <ul class="rotor-list" id="rotorList"></ul>
            <div class="sublabel">Scroll, drag or click. Center item is active.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detail column -->
    <div id="detailCol">
      <div class="section">
        <div class="section-hd">
          <div><strong id="detailTitle">Beverage</strong> &nbsp; <label class="hint"><input type="checkbox" id="letAi"/> Let AI decide</label></div>
          <button class="btn small" id="muteBtn">Mute</button>
        </div>
        <div class="section-bd" id="metrics">
          <!-- metrics render here -->
        </div>
      </div>

      <div class="section">
        <div class="section-hd"><strong id="opsTitle">Buyer operations</strong></div>
        <div class="section-bd">
          <div class="chips" id="opsChips"></div>
          <div class="hint" style="margin-top:6px">Click to add; each selected operation gets its own importance slider (0–10).</div>
          <div id="opsSliders"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-hd"><strong id="personaTitle">Hot-buyer persona</strong></div>
        <div class="section-bd">
          <div class="row">
            <div>
              <div class="lab">Company revenue focus (USD). Drag both handles.</div>
              <div class="sub">$5M — $5B+ total revenue window.</div>
            </div>
            <div>
              <div class="r-wrap" id="revWrap">
                <div class="r-track"></div>
                <div class="r-active" id="revActive"></div>
                <input type="range" id="revMin" min="5" max="5000" step="5" value="25" aria-label="Revenue min (USD millions)"/>
                <input type="range" id="revMax" min="5" max="5000" step="5" value="60" aria-label="Revenue max (USD millions)"/>
              </div>
              <div class="hint"><span id="revReadout">$25M – $60M</span></div>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="lab">Company headcount (employees)</div>
              <div class="sub">1 — 5,000+ employees</div>
            </div>
            <div><input type="range" id="emp" min="1" max="5000" step="1" value="250"/><div class="hint"><span id="empReadout">250</span></div></div>
          </div>

          <div class="row">
            <div>
              <div class="lab">Best titles to reach</div>
              <div class="sub">We boost these roles first in each account.</div>
            </div>
            <div class="chips" id="titleChips"></div>
          </div>

          <div class="row">
            <div>
              <div class="lab">Boost near city (e.g., HQ)</div>
            </div>
            <div><input id="geoBoost" type="text" placeholder="e.g., New Jersey" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--divider);background:#0d1724;color:var(--text)"/></div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin:10px 0 24px">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn primary" id="finishBtn">Finish</button>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{

/* ---------------------------- core state ---------------------------- */
const $=q=>document.querySelector(q), $$=q=>Array.from(document.querySelectorAll(q));
const getS=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
const setS=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
const normHost=h=>(h||"").trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"").replace(/\/.*$/,"");

const seed = getS("onb.seed", {host:""});
const host = normHost(seed.host || getS("fp.supplier.host",""));
const apiBase = getS("api.base","");

/* --------------------------- UI references -------------------------- */
const rotor = $("#rotor"), rotorList=$("#rotorList");
const toggleHideMuted=$("#toggleHideMuted");
const apiBadge=$("#apiBadge");
const cHost=$("#c-host"), cSup=$("#c-supplies"), cInd=$("#c-ind"), cGeo=$("#c-geo"), cContacts=$("#c-contacts");
const detailTitle=$("#detailTitle"), muteBtn=$("#muteBtn"), letAi=$("#letAi");
const metrics=$("#metrics"), opsTitle=$("#opsTitle"), opsChips=$("#opsChips"), opsSliders=$("#opsSliders");
const personaTitle=$("#personaTitle"), revMin=$("#revMin"), revMax=$("#revMax"), revActive=$("#revActive"), revWrap=$("#revWrap"), revReadout=$("#revReadout");
const emp=$("#emp"), empReadout=$("#empReadout"), titleChips=$("#titleChips"), geoBoost=$("#geoBoost");

/* ------------------------ industry + defaults ----------------------- */
const INDUSTRY_SET = [
  "Beverage","Food","Cosmetics","Electronics","Industrial","Logistics",
  "Automotive","Personal Care","Home Care","Aerospace","Pharma","Cannabis"
];

const DEFAULTS = {
  // Metrics mimic “0 = low/none … 10 = top/validated” with concrete hints in UI
  Beverage:[
    {k:"High-speed line compatibility",v:7,sub:"0—manual/slow → 10—≥500+ units/min"},
    {k:"Retail-ready print consistency",v:6,sub:"0—drift → 10—ΔE<2 @ volume"},
    {k:"Condensation tolerance",v:6,sub:"0—fails w/ light sweat → 10—retort/cooler-ready"},
    {k:"Pallet stability for bottlers",v:7,sub:"0—shifts → 10—ISTA 3A/3E stable"},
    {k:"Case integrity for glass/plastic",v:6,sub:"0—breaks → 10—holds @ peak load"},
    {k:"Damage reduction targets in transit",v:6,sub:"0—none → 10—≤0.5% KPI"}
  ],
  Food:[
    {k:"Food-contact compliance (FDA/EC)",v:8,sub:"0—uncertified → 10—fully certified"},
    {k:"Oxygen/moisture barrier",v:7,sub:"0—none → 10—validated OTR/WVTR"},
    {k:"Traceability & COA",v:7,sub:"0—none → 10—lot-level COA + recall-ready"},
    {k:"Sealing performance",v:7,sub:"0—frequent leaks → 10—validated @ scale"},
    {k:"Print/label regs",v:6,sub:"0—non-compliant → 10—GHS/NLEA compliant"}
  ],
  Cosmetics:[
    {k:"Premium print/finish expectations",v:8,sub:"0—basic CMYK → 10—foil/spot UV/emboss"},
    {k:"Color consistency ΔE",v:7,sub:"0—ΔE>6 → 10—ΔE≤2"},
    {k:"Unboxing experience",v:7,sub:"0—plain → 10—designed tactile experience"}
  ],
  Electronics:[
    {k:"ESD protection requirements",v:7,sub:"0—none → 10—ANSI/ESD S541 compliant"},
    {k:"Shock/vibration protection",v:7,sub:"0—insufficient → 10—drop/ISTA validated"},
    {k:"Moisture control",v:6,sub:"0—none → 10—desiccant & barrier spec"}
  ],
  Industrial:[
    {k:"Heavy-duty load retention",v:7,sub:"0—shifts → 10—secure through lanes"},
    {k:"Corrosion/VCI needs",v:6,sub:"0—none → 10—VCI pack spec"},
    {k:"Unit cost @ target MOQ",v:6,sub:"0—uncompetitive → 10—meets/better than target"}
  ],
  Logistics:[
    {k:"3PL/e-com integration",v:7,sub:"0—manual → 10—ready labels/ASN/SLAs"},
    {k:"Damage in parcel",v:6,sub:"0—high → 10—<0.5% returns due to damage"},
    {k:"Dock-to-stock speed",v:6,sub:"0—slow → 10—fast with ready SKUs"}
  ]
};

// Per-industry buyer ops menu (click to add → slider appears)
const OPS_MENU = [
  "E-commerce fulfillment","Warehouse pick/pack","3PL / distribution",
  "Automated pallet wrapper","Hand pallet wrapping","Co-packing","Cold chain"
];

// Persona title presets
const TITLE_MENU = ["Operations","Procurement","Plant Manager","Packaging","Quality","Regulatory","Logistics","Supply Chain","Engineering"];

/* ------------------------------ model ------------------------------- */
let model = {
  host,
  industries: INDUSTRY_SET.map(name=>({
    name, muted:false, ai:false,
    metrics: (DEFAULTS[name]||[]).map(m=>({k:m.k, sub:m.sub, v:m.v})),
    ops: ["E-commerce fulfillment","3PL / distribution"], // starter chips
    opsWeights: {}, // k -> 0..10
    persona: {rev:[25,60], emp:250, titles:["Operations","Procurement","Plant Manager"], city:""}
  })),
  activeIdx:0,
  hideMuted:false,
  ai_hints:{conflicts:[]}
};

/* ------------------------- one-liner / API -------------------------- */
function setCrumbs(p){
  cHost.textContent = p.host || host || "–";
  cSup.textContent  = (p.supplies||"supplies").toLowerCase();
  cInd.textContent  = p.industry|| (model.industries[model.activeIdx]?.name||"industry").toLowerCase();
  cGeo.textContent  = p.geo||"the U.S.";
  cContacts.textContent = (p.contacts||["Operations","Procurement"]).join(", ");
}

async function classifyViaAPI(){
  if (!apiBase){ apiBadge.textContent="API: offline"; apiBadge.style.color="#ffb"; return null; }
  apiBadge.textContent="API: checking…";
  try{
    const url = apiBase.replace(/\/+$/,"") + "/classify?host=" + encodeURIComponent(host);
    const r = await fetch(url, {mode:"cors"});
    if (!r.ok) throw new Error(r.status);
    const j = await r.json();
    apiBadge.textContent="API: online"; apiBadge.style.color="#0f0";
    return j;
  }catch(e){
    apiBadge.textContent="API: offline"; apiBadge.style.color="#ffb";
    return null;
  }
}

apiBadge.addEventListener("click",()=>{
  const v = prompt("API base (example: https://api.yourdomain.com)\nI will call GET {base}/classify?host=example.com", apiBase||"");
  if (v!=null){ setS("api.base", v.trim()); location.reload(); }
});

/* --------------------------- rotor render --------------------------- */
function renderRotor(){
  rotorList.innerHTML="";
  const list = model.industries.filter(x=>model.hideMuted? !x.muted : true);
  list.forEach((it,idx)=>{
    const li = document.createElement("li");
    li.className="rotor-item";
    li.textContent = it.name;
    li.dataset.index = model.industries.findIndex(z=>z.name===it.name);
    li.addEventListener("click",()=>activateIndustry(+li.dataset.index,true));
    rotorList.appendChild(li);
  });
  requestAnimationFrame(()=>syncRotorVisual());
  // Snap to active
  setTimeout(()=>scrollItemIntoCenter(model.activeIdx), 30);
}

function scaleClass(distance){
  if (distance===0) return "active";
  if (distance===1) return "near";
  return "";
}

function syncRotorVisual(){
  const items=$$(".rotor-item");
  let center = rotor.scrollTop + (rotor.clientHeight/2);
  items.forEach((el,i)=>{
    const mid = el.offsetTop + el.clientHeight/2;
    const dist = Math.abs(mid-center)/el.clientHeight; // ~1 per row
    el.classList.remove("active","near");
    if (dist<0.5) el.classList.add("active");
    else if (dist<1.5) el.classList.add("near");
  });
}

function indexFromCenter(){
  const items=$$(".rotor-item");
  let center = rotor.scrollTop + (rotor.clientHeight/2);
  let bestIdx=0, best=1e9;
  items.forEach((el,i)=>{
    const mid = el.offsetTop + el.clientHeight/2;
    const d = Math.abs(mid-center);
    if (d<best){ best=d; bestIdx=i; }
  });
  // map visual index → real index
  const visual = items[bestIdx];
  return +visual.dataset.index;
}

function scrollItemIntoCenter(realIndex){
  const visual = $$(".rotor-item").find(el=>+el.dataset.index===realIndex);
  if (!visual) return;
  const top = visual.offsetTop - (rotor.clientHeight/2 - visual.clientHeight/2);
  rotor.scrollTo({top, behavior:"instant"});
  syncRotorVisual();
}

rotor.addEventListener("scroll",()=>{ syncRotorVisual(); debounceCenterPick(); }, {passive:true});
let centerTimer=null;
function debounceCenterPick(){
  if (centerTimer) cancelAnimationFrame(centerTimer);
  centerTimer = requestAnimationFrame(()=>{
    const idx = indexFromCenter();
    if (idx!==model.activeIdx) activateIndustry(idx,false);
  });
}

toggleHideMuted.addEventListener("change",()=>{ model.hideMuted=toggleHideMuted.checked; renderRotor(); });

/* --------------------------- detail render -------------------------- */
function renderDetail(){
  const ind = model.industries[model.activeIdx]; if (!ind) return;
  detailTitle.textContent = ind.name;
  personaTitle.textContent = `Hot-buyer persona — ${ind.name}`;
  opsTitle.textContent = `Buyer operations for ${ind.name}`;
  letAi.checked = !!ind.ai;
  muteBtn.textContent = ind.muted? `Unmute ${ind.name}` : `Mute ${ind.name}`;

  // Metrics
  metrics.innerHTML = ind.metrics.map(m=>`
    <div class="row">
      <div>
        <div class="lab">${m.k}</div>
        <div class="sub">${m.sub||"0—low priority → 10—top priority"}</div>
      </div>
      <div><input type="range" min="0" max="10" step="1" value="${m.v}" data-metric="${m.k}"/></div>
    </div>
  `).join("");

  // Ops chips
  opsChips.innerHTML = OPS_MENU.map(k=>{
    const on = ind.ops.includes(k);
    return `<span class="chip ${on?'on':''}" data-op="${k}">${k}</span>`;
  }).join("");

  // Sliders per selected op
  opsSliders.innerHTML = ind.ops.map(k=>{
    const v = (ind.opsWeights&&typeof ind.opsWeights[k]==="number")? ind.opsWeights[k]:7;
    return `
      <div class="row">
        <div><div class="lab">${k}</div><div class="sub">Importance (0–10)</div></div>
        <div><input type="range" min="0" max="10" step="1" value="${v}" data-opw="${k}"/></div>
      </div>
    `;
  }).join("");

  // Persona values
  const [mn,mx]=ind.persona.rev;
  revMin.value=mn; revMax.value=mx; updateRevTrack();
  emp.value=ind.persona.emp; empReadout.textContent=ind.persona.emp;
  geoBoost.value=ind.persona.city||"";

  // Titles
  titleChips.innerHTML = TITLE_MENU.map(t=>{
    const on = ind.persona.titles.includes(t);
    return `<span class="chip ${on?'on':''}" data-title="${t}">${t}</span>`;
  }).join("");

  // Wire inputs
  $$("input[data-metric]").forEach(inp=>{
    inp.addEventListener("input",()=>{
      const m = ind.metrics.find(z=>z.k===inp.dataset.metric);
      m.v = +inp.value;
      flagConflictsIfAny(ind);
    });
  });
  $$(".chip[data-op]").forEach(ch=>{
    ch.addEventListener("click",()=>{
      const k=ch.dataset.op;
      const i=ind.ops.indexOf(k);
      if (i>=0) ind.ops.splice(i,1); else ind.ops.push(k);
      renderDetail();
    });
  });
  $$("input[data-opw]").forEach(inp=>{
    inp.addEventListener("input",()=>{ ind.opsWeights[inp.dataset.opw]=+inp.value; });
  });
  $$(".chip[data-title]").forEach(ch=>{
    ch.addEventListener("click",()=>{
      const t=ch.dataset.title, i=ind.persona.titles.indexOf(t);
      if (i>=0) ind.persona.titles.splice(i,1); else ind.persona.titles.push(t);
      renderDetail();
    });
  });
}

/* ---------------------- persona sliders logic ----------------------- */
function clampRevenue(){
  let a=+revMin.value, b=+revMax.value;
  if (a>b){ const t=a; a=b; b=t; }
  a=Math.max(5,Math.min(5000,a));
  b=Math.max(5,Math.min(5000,b));
  revMin.value=a; revMax.value=b;
  updateRevTrack();
  const ind=model.industries[model.activeIdx];
  ind.persona.rev=[a,b];
  flagConflictsIfAny(ind);
}
function updateRevTrack(){
  const min=+revMin.min, max=+revMin.max, a=+revMin.value, b=+revMax.value;
  const p1=((a-min)/(max-min))*100, p2=((b-min)/(max-min))*100;
  revActive.style.left=p1+"%"; revActive.style.right=(100-p2)+"%";
  revReadout.textContent = `$${a}M – $${b>=5000? '5,000M+':'$'+b+'M'}`.replace('$$','$');
}
revMin.addEventListener("input",clampRevenue);
revMax.addEventListener("input",clampRevenue);
emp.addEventListener("input",()=>{ const ind=model.industries[model.activeIdx]; ind.persona.emp=+emp.value; empReadout.textContent=emp.value; flagConflictsIfAny(ind); });
geoBoost.addEventListener("change",()=>{ model.industries[model.activeIdx].persona.city=geoBoost.value.trim(); });

/* ------------------------ conflicts / AI hint ----------------------- */
function flagConflictsIfAny(ind){
  model.ai_hints.conflicts=[];
  const [a,b]=ind.persona.rev; const e=ind.persona.emp;
  // simple sanity: revenue < $10M rarely supports 500+ employees
  if (b<=10 && e>=500){ model.ai_hints.conflicts.push("rev<=10M vs emp>=500"); }
  // headcount 1–5K with revenue < 20M improbable
  if (e>=1000 && b<50){ model.ai_hints.conflicts.push("emp>=1K vs rev<50M"); }
  letAi.indeterminate = model.ai_hints.conflicts.length>0;
}

/* --------------------------- actions -------------------------------- */
muteBtn.addEventListener("click",()=>{
  const ind=model.industries[model.activeIdx];
  ind.muted=!ind.muted;
  muteBtn.textContent = ind.muted? `Unmute ${ind.name}` : `Mute ${ind.name}`;
  renderRotor();
});
letAi.addEventListener("change",()=>{ model.industries[model.activeIdx].ai = letAi.checked; });

function activateIndustry(idx, scrollAlso){
  model.activeIdx=idx;
  if (scrollAlso) scrollItemIntoCenter(idx);
  renderDetail();
  // update crumb industry
  cInd.textContent = model.industries[idx].name.toLowerCase();
}

$("#finishBtn").addEventListener("click",()=>saveAndFinish());
$("#saveBtn").addEventListener("click",()=>saveModel(true));
$("#backBtn").addEventListener("click",()=>history.back());

function saveModel(notify){
  setS("step3.model", model);
  if (notify) { const s=document.createElement("span"); s.textContent="Saved"; s.className="badge"; $("#saveBtn").after(s); setTimeout(()=>s.remove(),900); }
}
function saveAndFinish(){
  saveModel(false);
  alert("Saved! (Wire this to your dash route.)");
}

/* --------------------------- bootstrap ------------------------------ */
function fromClassifyPayload(p){
  // expected fields (example)
  // { host, supplies:["stretch film","pallets"], country:"US", bestContacts:["Operations","Procurement"], industries:[{name, muted, metrics:[{k,sub,v}], persona:{rev:[min,max], emp, titles, city}, ops:[...]}] }
  if (!p) return;
  if (p.host) model.host=normHost(p.host);
  if (Array.isArray(p.industries) && p.industries.length){
    model.industries = p.industries.map(x=>({
      name: x.name,
      muted: !!x.muted,
      ai: !!x.ai,
      metrics: (Array.isArray(x.metrics)? x.metrics : (DEFAULTS[x.name]||[])).map(m=>({k:m.k, sub:m.sub, v: typeof m.v==="number"? m.v : 6})),
      ops: Array.isArray(x.ops)? x.ops : ["E-commerce fulfillment","3PL / distribution"],
      opsWeights: x.opsWeights || {},
      persona: Object.assign({rev:[25,60], emp:250, titles:["Operations","Procurement"], city:""}, x.persona||{})
    }));
  }
  setCrumbs({
    host:model.host,
    supplies: (p.supplies||[]).slice(0,3).join(", ") + (p.supplies && p.supplies.length>3? ", etc.": ""),
    industry: model.industries[0]?.name,
    geo: p.country? ("the " + (p.country==="US"?"U.S.":p.country)) : "the U.S.",
    contacts: p.bestContacts||["Operations","Procurement"]
  });
}

function fallbackOneLiner(){
  setCrumbs({
    host:model.host,
    supplies: "packaging",
    industry: model.industries[0]?.name||"industry",
    geo:"the U.S.",
    contacts:["Operations","Procurement"]
  });
}

async function init(){
  // one-liner
  if (host) cHost.textContent=host;
  if (apiBase){ const payload = await classifyViaAPI(); if (payload) fromClassifyPayload(payload); else fallbackOneLiner(); }
  else { fallbackOneLiner(); }

  // render rotor + detail
  toggleHideMuted.checked = model.hideMuted;
  renderRotor();
  activateIndustry(model.activeIdx,true);

  // start at selected, not at bottom
  scrollItemIntoCenter(model.activeIdx);
}

init();

})();</script>
</body>
</html>