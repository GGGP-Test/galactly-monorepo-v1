<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Step 3 — Tune by industry</title>
<style>
  :root{
    --bg:#0b1117; --panel:#0f1622; --panel-2:#0c131d;
    --ink:#e9f1f7; --muted:#92a7ba; --line:#1a2432;
    --brand:#67d6ff; --cta:#7ee3ff; --accent:#ff6b3d;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:15px/1.4 system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:22px auto;padding:0 14px}
  .crumbs{display:flex;flex-wrap:wrap;gap:8px 10px;margin:0 0 10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;
    background:#0e1825;border:1px solid var(--line);color:#cfe0ee}
  .chip.badge{padding:6px 10px;font-size:12px;border-radius:10px}
  .chip.ok{color:#0f0;border-color:#17361b;background:#0f1a12}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#102033;color:#d4e7f7;cursor:pointer}
  .btn.primary{background:var(--cta);color:#062433;border-color:#5bcdf7}
  .row{display:flex;gap:18px;align-items:center;justify-content:space-between}
  .toggle{display:inline-flex;align-items:center;gap:8px}
  .grid{display:grid;grid-template-columns:300px 1fr;gap:18px;margin-top:12px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .pane{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
  .pane-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0f1622,#0e1420)}
  .pane-bd{padding:12px 14px}

  /* rotor */
  .rotor{height:420px;overflow:hidden;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--panel-2)}
  .rotor ul{list-style:none;margin:0;padding:0;position:relative;height:100%;width:100%}
  .rotor li{position:absolute;left:0;right:0;text-align:center;transition:transform .18s ease,opacity .18s ease;
    color:#9fb4c7;pointer-events:auto;user-select:none;font-weight:600}
  .rotor li.active{color:#eaf7ff}
  .rotor .hint{position:absolute;bottom:8px;left:14px;right:14px;color:var(--muted);font-size:12px}
  .rotor .ghost{position:absolute;top:50%;left:0;right:0;height:34px;border-radius:10px;transform:translateY(-50%);
    background:radial-gradient(60% 120% at 50% 50%,rgba(255,255,255,.04),rgba(255,255,255,0))}
  .mutedLbl{display:flex;align-items:center;gap:8px;margin-top:8px;color:#a9bfd1;font-size:13px}

  /* sliders */
  .metric{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:center;margin:12px 0}
  .metric small{color:var(--muted)}
  input[type=range]{width:100%;appearance:none;background:transparent}
  input[type=range]::-webkit-slider-runnable-track{height:6px;background:#1a2634;border-radius:999px}
  input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;
    background:var(--accent);margin-top:-5px;border:2px solid #fff}
  input[type=range]::-moz-range-track{height:6px;background:#1a2634;border-radius:999px}
  input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);border:2px solid #fff}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1b2a;color:#cfe2f2;cursor:pointer}
  .pill.on{background:#103247;border-color:#1b4862;color:#eaf7ff}
  .opsSel{display:grid;gap:10px;margin-top:10px}
  .opsRow{display:grid;grid-template-columns:1fr 120px;gap:12px;align-items:center}

  .section{border:1px solid var(--line);border-radius:14px;padding:12px;background:#0f1724;margin:14px 0}
  .section h4{margin:0 0 8px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

  /* double-handle revenue */
  .revTrack{position:relative;height:30px;padding:8px 0}
  .revTrack .bar{position:absolute;left:0;right:0;top:50%;height:6px;background:#162233;border-radius:8px;transform:translateY(-50%)}
  .revTrack input[type=range]{position:absolute;left:0;right:0;top:0;height:30px;pointer-events:none}
  .revTrack input[type=range]::-webkit-slider-thumb{pointer-events:auto}
  .revTrack input[type=range]::-moz-range-thumb{pointer-events:auto}
  .revRead{display:flex;justify-content:space-between;color:#9fb4c7;font-size:12px;margin-top:6px}

  .footer{display:flex;gap:10px;justify-content:flex-end;margin:14px 0}
  .hidden{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="crumbs" id="crumbs"></div>
    <div class="toggle">
      <span id="apiBadge" class="chip badge">API: offline</span>
      <button id="backBtn" class="btn">Back</button>
    </div>
  </div>

  <div class="row" style="margin:10px 0 6px">
    <h2 style="margin:0">Step 3</h2>
    <div style="display:flex;gap:10px">
      <button id="advBtn" class="btn">Show advanced ▾</button>
      <button id="saveBtn" class="btn">Save</button>
      <button id="finishBtn" class="btn primary">Finish</button>
    </div>
  </div>

  <div id="adv" class="grid hidden" aria-expanded="false">
    <div class="pane">
      <div class="pane-hd">
        <strong>Industries</strong>
        <label class="mutedLbl"><input id="hideMuted" type="checkbox"> Hide muted</label>
      </div>
      <div class="pane-bd">
        <div id="rotor" class="rotor" aria-label="Industry selector">
          <div class="ghost"></div>
          <ul id="rotorList"></ul>
          <div class="hint">Scroll, drag or click. Center item is active.</div>
        </div>
      </div>
    </div>

    <div class="pane">
      <div class="pane-hd">
        <div style="display:flex;align-items:center;gap:12px">
          <h3 id="indTitle" style="margin:0">—</h3>
          <label style="display:flex;align-items:center;gap:6px;color:#c5d7e5;font-size:13px">
            <input id="aiDecide" type="checkbox"> Let AI decide
          </label>
        </div>
        <button id="muteBtn" class="btn">Mute</button>
      </div>
      <div class="pane-bd">
        <div id="metrics"></div>

        <div class="section">
          <h4>Buyer operations for <span id="opsFor">—</span></h4>
          <div id="opsPool" class="chips"></div>
          <div id="opsSel" class="opsSel"></div>
        </div>

        <div class="section">
          <h4>Hot-buyer persona — <span id="personaFor">—</span></h4>
          <div class="row2">
            <div>
              <label style="display:block;margin:0 0 6px;color:#a9bfd1">Company revenue focus (USD). Drag both handles.</label>
              <div class="revTrack" id="revTrack">
                <div class="bar"></div>
                <input id="revMin" type="range" min="0" max="120" step="1" value="8" aria-label="Min revenue"/>
                <input id="revMax" type="range" min="0" max="120" step="1" value="80" aria-label="Max revenue"/>
              </div>
              <div class="revRead"><span id="revMinLbl">$0M</span><span id="revMaxLbl" style="margin-left:auto">$120M+</span></div>
            </div>
            <div>
              <label style="display:block;margin:0 0 6px;color:#a9bfd1">Company headcount (employees)</label>
              <input id="emp" type="range" min="1" max="5000" step="1" value="250"/>
              <div class="revRead"><span>1</span><span id="empLbl">250</span><span>5,000+</span></div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label style="display:block;margin:0 0 6px;color:#a9bfd1">Best titles to reach</label>
            <div id="titles" class="chips"></div>
          </div>

          <div style="margin-top:12px">
            <label style="display:block;margin:0 0 6px;color:#a9bfd1">Boost near city (e.g., HQ)</label>
            <input id="city" type="text" placeholder="e.g., New Jersey" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0d1520;color:#e9f1f7;outline:none"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="saveBtn2" class="btn">Save</button>
    <button id="finishBtn2" class="btn primary">Finish</button>
  </div>
</div>

<script>
(()=>{

  /* ---------------- Utilities ---------------- */
  const $ = (q,el=document)=>el.querySelector(q);
  const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const fmtM = n => (n>=120 ? "$120M+" : `$${n}M`);
  const hasAPI = ()=> typeof window.API_BASE==="string" && !!window.API_BASE;

  /* ---------------- Elements ---------------- */
  const crumbsEl=$("#crumbs"), adv=$("#adv"), advBtn=$("#advBtn");
  const rotor=$("#rotor"), rotorList=$("#rotorList"), hideMuted=$("#hideMuted");
  const apiBadge=$("#apiBadge");
  const indTitle=$("#indTitle"), muteBtn=$("#muteBtn"), aiDecide=$("#aiDecide");
  const metricsEl=$("#metrics"), opsFor=$("#opsFor"), personaFor=$("#personaFor");
  const opsPoolEl=$("#opsPool"), opsSelEl=$("#opsSel");
  const revMin=$("#revMin"), revMax=$("#revMax"), revMinLbl=$("#revMinLbl"), revMaxLbl=$("#revMaxLbl");
  const emp=$("#emp"), empLbl=$("#empLbl"), titlesEl=$("#titles"), city=$("#city");

  /* ---------------- State ---------------- */
  const state = {
    industries: [],
    muted: new Set(),
    hideMuted:false,
    selected: 0,
    persona: {},
    seed:null
  };

  /* ---------------- Library ---------------- */
  const LIB = {
    Beverage:{
      metrics:[
        "High-speed line compatibility",
        "Retail-ready print consistency",
        "Condensation tolerance",
        "Pallet stability for bottlers",
        "Case integrity for glass/plastic",
        "Damage reduction targets in transit"
      ],
      ops:["Automated pallet wrapper","Hand pallet wrapping","E-commerce fulfillment","3PL / distribution"],
      titles:["Operations","Procurement","Plant Manager"]
    },
    Food:{
      metrics:[
        "Food-contact compliance (FDA/EC)",
        "Oxygen/moisture barrier",
        "Traceability & COA",
        "Sealing performance",
        "Print/label regs"
      ],
      ops:["E-commerce fulfillment","Warehouse pick/pack","3PL / distribution"],
      titles:["Quality","Operations","Regulatory"]
    },
    Cosmetics:{
      metrics:[
        "Premium print/finish expectations",
        "Color consistency ΔE",
        "Unboxing experience"
      ],
      ops:["E-commerce fulfillment","3PL / distribution","Co-packing"],
      titles:["Brand","Packaging","Operations"]
    },
    Electronics:{
      metrics:["ESD protection requirements","Shock/vibration protection","Moisture control"],
      ops:["Warehouse pick/pack","3PL / distribution"],
      titles:["Operations","Packaging Engineer","Logistics"]
    },
    Industrial:{
      metrics:["Unit-load stability","Film puncture/abrasion resistance","Automation line uptime impact"],
      ops:["Palletizing","3PL / distribution"],
      titles:["Plant Manager","Operations","Procurement"]
    },
    Logistics:{
      metrics:["3PL/e-com integration","Damage in parcel","Dock-to-stock speed"],
      ops:["E-commerce fulfillment","Warehouse pick/pack","3PL / distribution"],
      titles:["Logistics","Operations","Supply Chain"]
    },
    Apparel:{
      metrics:["Presentation (crease/scuff)","Parcel-rate optimization","Return-friendly design"],
      ops:["E-commerce fulfillment","3PL / distribution"],
      titles:["E-com Ops","Operations","Procurement"]
    }
  };
  const DEFAULT_INDS = Object.keys(LIB);

  /* ---------------- Seed + crumbs ---------------- */
  function loadSeed(){
    try{
      const s=JSON.parse(localStorage.getItem("onb.seed")||"null");
      state.seed=s||null;
    }catch{ state.seed=null; }
    renderCrumbs();
  }
  function renderCrumbs(){
    const s=state.seed||{};
    const parts = [
      s.host || "(no domain)",
      "supplies",
      s.products || "boxes, labels, corrugate, etc.",
      "for",
      s.audience || "",
      "in",
      s.region || "the U.S.",
      "Best contacts:",
      (s.bestContacts && s.bestContacts.join(", ")) || "Procurement, Marketing"
    ];
    crumbsEl.innerHTML = "";
    parts.filter(Boolean).forEach(p=>{
      const c=document.createElement("div");
      c.className="chip";
      c.textContent=p;
      crumbsEl.appendChild(c);
    });
    if(hasAPI()){ apiBadge.textContent="API: online"; apiBadge.classList.add("ok"); }
    else { apiBadge.textContent="API: offline"; apiBadge.classList.remove("ok"); }
  }

  /* ---------------- Persona normalize (fixes your error) ---------------- */
  function normalizePersona(ind){
    const lib=LIB[ind]||{metrics:[],ops:[],titles:[]};
    let p = state.persona[ind] || {};
    // metrics -> array of {label,value}
    if (!Array.isArray(p.metrics) || !p.metrics.length){
      p.metrics = lib.metrics.map((l,i)=>({label:l,value:clamp(8-i,0,10)}));
    }else{
      p.metrics = p.metrics.map(m=>{
        if(typeof m==="string") return {label:m,value:7};
        return {label: m.label || "", value: clamp(+m.value||7,0,10)};
      });
      // ensure any missing lib metrics exist
      lib.metrics.forEach(l=>{ if(!p.metrics.find(x=>x.label===l)) p.metrics.push({label:l,value:7}); });
    }
    if (!Array.isArray(p.opsPool)) p.opsPool=[...lib.ops];
    if (!Array.isArray(p.opsSel)) p.opsSel=[];
    if (!Array.isArray(p.titles) || !p.titles.length) p.titles=[...lib.titles];
    if (!Array.isArray(p.rev) || p.rev.length!==2) p.rev=[8,80];
    p.rev=[clamp(+p.rev[0],0,120), clamp(+p.rev[1],0,120)]; if(p.rev[0]>p.rev[1]) p.rev.reverse();
    if (typeof p.emp!=="number") p.emp=250;
    if (typeof p.city!=="string") p.city="";
    p.ai = !!p.ai;
    state.persona[ind]=p;
  }
  function ensurePersona(ind){ normalizePersona(ind); }

  /* ---------------- Industries ---------------- */
  function adoptIndustries(list){
    const src = (list && list.length ? list : DEFAULT_INDS);
    const seen=new Set();
    state.industries = src.filter(n=> n && !seen.has(n) && (seen.add(n),true));
    if (!state.industries.length) state.industries=[...DEFAULT_INDS];
    state.industries.slice(0,30).forEach(ensurePersona);
  }

  /* ---------------- Rotor ---------------- */
  function rotorItems(){
    const arr = state.industries.filter(x=>!state.muted.has(x) || !state.hideMuted);
    return arr.length?arr:[...state.industries];
  }
  function renderRotor(){
    const items = rotorItems();
    rotorList.innerHTML="";
    items.forEach((name,i)=>{
      const li=document.createElement("li");
      li.textContent=name;
      li.setAttribute("data-i",i);
      rotorList.appendChild(li);
    });
    positionRotor();
  }
  function positionRotor(){
    const items = rotorItems();
    state.selected = clamp(state.selected,0,items.length-1);
    const lis = $$("li",rotorList);
    const step = 36; // tighter spacing
    const centerY = rotor.clientHeight/2 - 16;
    lis.forEach((li,i)=>{
      const d = i - state.selected;
      const y = centerY + d*step;
      const scale = 1 - Math.min(Math.abs(d)*0.12,0.5);
      const alpha = 1 - Math.min(Math.abs(d)*0.18,0.75);
      li.style.transform=`translateY(${y}px) scale(${scale})`;
      li.style.opacity=String(alpha);
      li.style.fontSize = (scale*18).toFixed(2)+"px";
      li.classList.toggle("active", i===state.selected);
    });
    updateDetail(items[state.selected]);
  }
  let wheelLock=0;
  rotor.addEventListener("wheel",(e)=>{
    e.preventDefault();
    const now=performance.now(); if(now-wheelLock<80) return; wheelLock=now;
    setSelected(state.selected + (e.deltaY>0?1:-1));
  },{passive:false});
  let dragY=null;
  rotor.addEventListener("mousedown",e=>startDrag(e.clientY));
  rotor.addEventListener("touchstart",e=>{ if(e.touches&&e.touches[0]) startDrag(e.touches[0].clientY); },{passive:false});
  function startDrag(y0){
    dragY=y0;
    const move=ev=>{
      const y=("touches" in ev)? ev.touches[0].clientY : ev.clientY;
      if(Math.abs(y-dragY)>20){ setSelected(state.selected + (y>dragY?1:-1)); dragY=y; }
    };
    const end=()=>{ window.removeEventListener("mousemove",move); window.removeEventListener("mouseup",end);
      window.removeEventListener("touchmove",move); window.removeEventListener("touchend",end); };
    window.addEventListener("mousemove",move);
    window.addEventListener("mouseup",end);
    window.addEventListener("touchmove",move,{passive:false});
    window.addEventListener("touchend",end);
  }
  function setSelected(idx){ state.selected=clamp(idx,0,rotorItems().length-1); positionRotor(); }
  rotorList.addEventListener("click",(e)=>{
    const li=e.target.closest("li"); if(!li) return;
    setSelected(+li.getAttribute("data-i"));
  });

  /* ---------------- Detail panel ---------------- */
  function updateDetail(ind){
    ensurePersona(ind);
    const P=state.persona[ind];
    indTitle.textContent = ind;
    opsFor.textContent = ind;
    personaFor.textContent = ind;
    muteBtn.textContent = (state.muted.has(ind)?"Unmute ":"Mute ")+ind;
    aiDecide.checked = !!P.ai;

    // metrics
    metricsEl.innerHTML="";
    P.metrics.forEach((m,ix)=>{
      const row=document.createElement("div");
      row.className="metric";
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${m.label}</div>
          <small>0—low priority — 10—top priority</small>
        </div>
        <div><input type="range" min="0" max="10" step="1" value="${m.value}" aria-label="${m.label} importance"></div>
      `;
      $("input",row).addEventListener("input",(e)=>{
        P.metrics[ix].value = +e.target.value; persist();
      });
      metricsEl.appendChild(row);
    });

    renderOps(ind);
    // persona sliders
    revMin.value=P.rev[0]; revMax.value=P.rev[1];
    revMinLbl.textContent=fmtM(+revMin.value);
    revMaxLbl.textContent=fmtM(+revMax.value);
    emp.value=P.emp; empLbl.textContent=P.emp.toLocaleString();
    renderTitles(ind);
    city.value=P.city||"";
  }

  function renderOps(ind){
    const P=state.persona[ind]; // guard everything
    if(!P.opsPool) P.opsPool=[];
    if(!P.opsSel) P.opsSel=[];
    opsPoolEl.innerHTML=""; opsSelEl.innerHTML="";
    P.opsPool.forEach(label=>{
      const el=document.createElement("div"); el.className="pill"; el.textContent=label;
      el.addEventListener("click",()=>{
        if(!P.opsSel.find(o=>o.label===label)){
          P.opsSel.push({label,value:7});
          renderOps(ind); persist();
        }
      });
      opsPoolEl.appendChild(el);
    });
    P.opsSel.forEach((o,i)=>{
      const row=document.createElement("div"); row.className="opsRow";
      row.innerHTML=`
        <div class="pill on" style="cursor:default">${o.label}</div>
        <input type="range" min="0" max="10" step="1" value="${o.value}" aria-label="${o.label} importance"/>
      `;
      $("input",row).addEventListener("input",(e)=>{ P.opsSel[i].value=+e.target.value; persist(); });
      opsSelEl.appendChild(row);
    });
  }

  function renderTitles(ind){
    const P=state.persona[ind];
    if(!Array.isArray(P.titles)) P.titles=[];
    titlesEl.innerHTML="";
    const pool = ["Operations","Procurement","Plant Manager","Packaging","Quality","Regulatory","Logistics","Supply Chain","Engineering","Brand"];
    pool.forEach(t=>{
      const p=document.createElement("div");
      p.className="pill"+(P.titles.includes(t)?" on":"");
      p.textContent=t;
      p.addEventListener("click",()=>{
        const on=P.titles.includes(t);
        if(on) P.titles=P.titles.filter(x=>x!==t); else P.titles.push(t);
        renderTitles(ind); persist();
      });
      titlesEl.appendChild(p);
    });
  }

  /* ---------------- Controls ---------------- */
  advBtn.addEventListener("click",()=>{
    const willHide = !adv.classList.contains("hidden");
    adv.classList.toggle("hidden");
    advBtn.textContent = willHide ? "Show advanced ▾" : "Hide advanced ▲";
    adv.setAttribute("aria-expanded", String(!willHide));
  });
  hideMuted.addEventListener("change",(e)=>{
    state.hideMuted = e.target.checked; renderRotor(); persist();
  });
  muteBtn.addEventListener("click",()=>{
    const ind=rotorItems()[state.selected];
    if(state.muted.has(ind)) state.muted.delete(ind); else state.muted.add(ind);
    renderRotor(); persist();
  });
  aiDecide.addEventListener("change",(e)=>{
    const ind=rotorItems()[state.selected]; ensurePersona(ind);
    state.persona[ind].ai = !!e.target.checked; persist();
  });

  function syncRev(){
    // keep handles ordered and persist
    if(+revMin.value > +revMax.value){ const t=revMin.value; revMin.value=revMax.value; revMax.value=t; }
    revMinLbl.textContent=fmtM(+revMin.value);
    revMaxLbl.textContent=fmtM(+revMax.value);
    const ind=rotorItems()[state.selected]; ensurePersona(ind);
    state.persona[ind].rev=[+revMin.value,+revMax.value]; persist();
  }
  ["input","change"].forEach(ev=>{ revMin.addEventListener(ev,syncRev); revMax.addEventListener(ev,syncRev); });
  emp.addEventListener("input",(e)=>{
    empLbl.textContent=(+e.target.value).toLocaleString();
    const ind=rotorItems()[state.selected]; ensurePersona(ind);
    state.persona[ind].emp=+e.target.value; persist();
  });
  city.addEventListener("input",(e)=>{
    const ind=rotorItems()[state.selected]; ensurePersona(ind);
    state.persona[ind].city=e.target.value.trim(); persist();
  });

  $("#saveBtn").addEventListener("click",persist);
  $("#saveBtn2").addEventListener("click",persist);
  $("#finishBtn").addEventListener("click",finish);
  $("#finishBtn2").addEventListener("click",finish);
  $("#backBtn").addEventListener("click",()=>history.back());

  function finish(){ persist(); alert("Saved! (hook redirect to dashboard)"); }

  /* ---------------- Persistence ---------------- */
  function persist(){
    try{
      const out={
        industries:[...state.industries],
        muted:[...state.muted],
        hideMuted:state.hideMuted,
        selected:state.selected,
        persona:state.persona
      };
      localStorage.setItem("onb.step3", JSON.stringify(out));
    }catch{}
  }
  function restore(){
    try{
      const raw=localStorage.getItem("onb.step3");
      if(!raw) return;
      const s=JSON.parse(raw);
      state.industries=s.industries||[];
      state.muted=new Set(s.muted||[]);
      state.hideMuted=!!s.hideMuted;
      state.selected=+s.selected||0;
      state.persona=s.persona||{};
      // upgrade existing persona records to current schema
      state.industries.forEach(normalizePersona);
    }catch{}
  }

  /* ---------------- Init ---------------- */
  function init(){
    loadSeed();
    restore();
    adoptIndustries(state.industries);
    hideMuted.checked = state.hideMuted;
    renderRotor();
    adv.classList.add("hidden");
    advBtn.textContent="Show advanced ▾";
  }
  init();

})();
</script>
</body>
</html>