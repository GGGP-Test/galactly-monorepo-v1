<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Galactly ‚Äî Live Buyers Feed</title>
  <style>
    :root{--bg:#0b0e13;--panel:#111725;--border:#1f2a3b;--text:#e8ecf1;--muted:#9ab;--accent:#7fb2ff}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    header .brand{font-weight:700}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:8px;font-size:12px;opacity:.85}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grow{flex:1 1 460px}
    .small{flex:1 1 280px}
    label{display:block;font-size:13px;margin:6px 0 6px;color:var(--muted)}
    input,textarea,select{width:100%;background:#0f1420;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px}
    textarea{min-height:92px}
    button{background:#1e2a3b;border:1px solid #2a3b55;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.12)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .lead{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .meta{opacity:.75;font-size:12px}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="brand">Galactly <span id="status" class="pill">connecting‚Ä¶</span></div>
    <div class="row">
      <label>API Base
        <input id="apiBase" size="52"/>
      </label>
      <button id="saveApi">Save</button>
    </div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="card grow">
        <h3 style="margin:0 0 8px">Find buyers now</h3>
        <div class="row">
          <div class="grow">
            <label>Your website (optional)
              <input id="vendorSite" placeholder="https://your-vendor.com"/>
            </label>
          </div>
          <div class="small">
            <label>Regions
              <input id="regions" placeholder="US, CA"/>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="grow">
            <label>Industries (comma‚Äëseparated)
              <input id="industries" placeholder="beverage, candy, cosmetics"/>
            </label>
          </div>
        </div>
        <label>Known / ideal buyer domains (one per line)
          <textarea id="buyers" placeholder="acmecandy.com\nliquiddeath.com\ndrinkolipop.com"></textarea>
        </label>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <label style="display:inline-block;margin-right:8px"><input type="checkbox" id="diy" checked/> DIY verify ads (show proof links)</label>
            <span class="meta">We‚Äôll also parse product & procurement pages</span>
          </div>
          <div>
            <button id="run">Find now</button>
          </div>
        </div>
      </div>

      <div class="card small">
        <h3 style="margin:0 0 8px">How to use</h3>
        <div class="meta">
          1) Paste a few buyer domains or just industry/region.<br/>
          2) Click <em>Find now</em> ‚Äî we fetch ad‚Äëproof links, product pages, and supplier intake.<br/>
          3) Click a card to verify. Hit <em>Confirm ad</em> to boost heat.
        </div>
      </div>
    </div>

    <h3 style="margin:18px 0 8px">Live feed</h3>
    <div id="feed" class="grid"></div>
  </div>

<script>
  const uidKey='galactly_uid';
  let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
  const apiInput=document.getElementById('apiBase');
  apiInput.value = localStorage.getItem('api_base') || 'https://<PUT-YOUR-NORTHFLANK-ROUTE>.northflank.app';
  document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('api_base', apiInput.value.trim()); location.reload(); };
  const API=(p)=> (localStorage.getItem('api_base')||apiInput.value).replace(/\/$/,'') + p;

  async function post(path, body){
    const r = await fetch(API(path), { method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body: JSON.stringify(body||{}) });
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function get(path){ const r = await fetch(API(path), { headers:{'x-galactly-user':uid} }); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

  // On-demand find
  document.getElementById('run').onclick=async()=>{
    const buyers = document.getElementById('buyers').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const industries = document.getElementById('industries').value.split(',').map(s=>s.trim()).filter(Boolean);
    const regions = document.getElementById('regions').value.split(',').map(s=>s.trim()).filter(Boolean);
    const body = { buyers, industries, regions, diy: document.getElementById('diy').checked, vendorSite: document.getElementById('vendorSite').value.trim() };
    try{
      const r = await post('/api/v1/find-now', body);
      document.getElementById('status').textContent = `ok ‚Ä¢ checked ${r.checked} ‚Ä¢ created ${r.created}`;
      await refresh();
    }catch(e){ document.getElementById('status').textContent='error'; }
  };

  // Feed
  const feed=document.getElementById('feed');
  function esc(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",
  ">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function card(lead){
    let host=''; try{ host=new URL(lead.source_url).hostname; }catch{}
    const div=document.createElement('div'); div.className='lead';
    div.innerHTML=`<div class="meta">${esc(lead.platform||'source')} ‚Ä¢ ${esc(host)}</div>
      <div><strong>${esc(lead.title||'Untitled')}</strong></div>
      <div>${esc(lead.snippet||'')}</div>
      <div class="row" style="gap:8px">
        <button data-act="open">Open</button>
        <button data-act="confirm">Confirm ad</button>
        <button data-act="like">üëç</button>
        <button data-act="dis">üëé</button>
        <button data-act="mute">Mute</button>
        <button data-act="claim">Claim</button>
        <button data-act="own">Own</button>
      </div>`;
    div.querySelector('[data-act=open]').onclick=()=>{ window.open(lead.source_url,'_blank','noopener'); post('/api/v1/events',{type:'click',leadId:lead.id,meta:{url:lead.source_url}}).catch(()=>{}); };
    div.querySelector('[data-act=confirm]').onclick=()=> post('/api/v1/events',{type:'confirm_ad',leadId:lead.id,meta:{url:lead.source_url}}).then(()=>refresh());
    div.querySelector('[data-act=like]').onclick=()=> post('/api/v1/events',{type:'like',leadId:lead.id});
    div.querySelector('[data-act=dis]').onclick=()=> post('/api/v1/events',{type:'dislike',leadId:lead.id});
    div.querySelector('[data-act=mute]').onclick=()=> post('/api/v1/events',{type:'mute_domain',leadId:lead.id,meta:{domain:host}});
    div.querySelector('[data-act=claim]').onclick=async()=>{
      const r = await post('/api/v1/claim',{leadId:lead.id});
      if(r?.ok){ lead._windowId=r.windowId; setTimeout(refresh, 500); }
    };
    div.querySelector('[data-act=own]').onclick=async()=>{
      if(!lead._windowId) return;
      const r = await post('/api/v1/own',{windowId:lead._windowId});
      if(r?.ok) refresh();
    };
    return div;
  }

  async function refresh(){
    try{
      const data = await get('/api/v1/leads');
      feed.innerHTML='';
      (data.leads||[]).forEach(L => feed.appendChild(card(L)));
      document.getElementById('status').textContent = 'ok';
      setTimeout(refresh, (data.nextRefreshSec||15)*1000);
    }catch(e){ document.getElementById('status').textContent='error'; setTimeout(refresh, 5000); }
  }
  refresh();
</script>
</body>
</html>
