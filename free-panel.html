<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Galactly — Live packaging leads</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--ink:#e9eef7;--mut:#9aa3b2;--bg:#0b0f18;--card:#0d1322;--line:rgba(255,255,255,.08);--accent:#86f7d6;--accent2:#57a4ff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 700px at 85% -10%, rgba(120,160,255,.12), rgba(0,0,0,0) 60%), radial-gradient(900px 500px at 15% 110%, rgba(120,200,255,.08), rgba(0,0,0,0) 60%), linear-gradient(180deg,#0b0e18,#06070c 55%); color:var(--ink)}
  a{color:inherit}
  .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--line);backdrop-filter:blur(8px) saturate(1.05);background:rgba(6,8,12,.55)}
  .dot{width:7px;height:7px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .spacer{flex:1}
  .pill{opacity:.85;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
  .close{border:1px solid var(--line);background:transparent;border-radius:12px;color:var(--ink);padding:8px 12px;cursor:pointer}
  .wrap{max-width:1240px;margin:18px auto;padding:0 18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
  .card{background:linear-gradient(180deg,#0b1020,#0a0f1b);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 36px rgba(0,0,0,.32)}
  .title{font-weight:800;margin:0 0 6px;font-size:18px;line-height:1.25}
  .snip{color:var(--mut);font-size:13px;line-height:1.45;max-height:3.7em;overflow:hidden}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .tag{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#cfd6e6}
  .heat{display:inline-flex;gap:6px;align-items:center}
  .heat i{width:8px;height:8px;border-radius:50%}
  .why{display:flex;align-items:center;gap:6px;margin-top:12px;color:#cfd6e6;cursor:pointer}
  .why small{color:var(--mut)}
  .why:hover small{color:#fff}
  .banner{margin:12px 0 18px;border:1px dashed var(--line);border-radius:14px;padding:14px 16px;color:var(--mut);text-align:center}
  .why-pop{position:fixed;inset:auto 18px 18px auto;max-width:380px;background:#0d1322;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.38);display:none}
  .why-pop.show{display:block}
  .why-pop h4{margin:0 0 8px;font-size:14px}
  .why-pop ul{margin:0;padding:0 0 0 18px}
  .why-pop li{margin:6px 0;color:#cbd3e6;font-size:13px}
  .gate{position:fixed;inset:0;display:none;place-items:center;background:rgba(4,6,10,.58);backdrop-filter:blur(6px)}
  .gate.show{display:grid}
  .panel{width:min(680px,92vw);background:linear-gradient(180deg,#0b1020,#0a0f1b);border:1px solid var(--line);border-radius:18px;padding:18px}
  .panel h2{margin:0 0 6px}
  .panel p{margin:0 0 10px;color:#cfd6e6}
  .f{display:grid;gap:10px;margin-top:12px}
  .f input[type="email"], .f input[type="url"], .f input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1426;color:#fff}
  .row2{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .cta{display:flex;gap:10px;align-items:center;margin-top:8px}
  .btn{border:1px solid var(--line);background:#0f1426;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,#fff,#e9f0ff);color:#0a0d12;border:0}
  .reveal{overflow:hidden;transition:max-height .25s ease}
  .hint{font-size:12px;color:var(--mut)}
  .headerline{display:flex;gap:10px;align-items:center;margin:0 0 10px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="headerline">
      <div class="dot"></div>
      <strong>Live feed</strong>
      <span id="refresh" class="pill">refresh in —</span>
    </div>
    <div class="spacer"></div>
    <span class="pill" id="who">— online</span>
    <button class="close" onclick="location.href='./index.html'">Close</button>
  </div>

  <div class="wrap">
    <div id="banner" class="banner" hidden></div>
    <div id="grid" class="grid"></div>
  </div>

  <div id="whyPop" class="why-pop">
    <h4>Why AI shows you this lead</h4>
    <ul id="whyList"></ul>
    <div class="hint" id="originHint"></div>
  </div>

  <div id="gate" class="gate">
    <div class="panel">
      <h2>Get in. It’s free.</h2>
      <p>We tune the feed for packaging vendors only. Verify email to enter.</p>
      <div class="f">
        <input id="f_email" type="email" placeholder="Work email (required)" />
        <div class="row2">
          <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
            <input id="chkListMe" type="checkbox" />
            <span>Also list my company for inbound opportunities</span>
          </label>
        </div>
        <div id="moreBox" class="reveal" style="max-height:0">
          <input id="f_company" type="text" placeholder="Company name (optional)" />
          <input id="f_site" type="url" placeholder="Company website (optional)" />
          <div class="hint">We show your profile to buyers who match your ICP.</div>
        </div>
        <div class="cta">
          <button id="enterBtn" class="btn primary">Enter live feed</button>
          <button class="btn" onclick="document.getElementById('gate').classList.remove('show')">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
// -------- API base (inline, NF by default) --------
(function(){
  const DEFAULT='https://p01--animated-cellar--vz4ftkwrzdfs.code.run';
  const q=new URLSearchParams(location.search);
  let base=q.get('api')||localStorage.getItem('apiBase')||DEFAULT;
  function norm(v){ if(!v) return DEFAULT; v=String(v).trim().replace(/\/+$/,''); if(!/^https?:\/\//i.test(v)) v='https://'+v; return v; }
  base=norm(base); window.API_BASE=base; try{localStorage.setItem('apiBase',base)}catch{}
})();

// -------- presence (soft + server if available) --------
const whoEl=document.getElementById('who');
const ONLINE_KEY='galactly:live:pings';
const me=Math.random().toString(36).slice(2);
function getP(){ try{return JSON.parse(localStorage.getItem(ONLINE_KEY)||'{}')}catch{return{}} }
function setP(o){ localStorage.setItem(ONLINE_KEY,JSON.stringify(o)); }
function beat(){ const o=getP(); o[me]=Date.now(); setP(o); }
function sweep(){ const o=getP(),now=Date.now(); for(const k of Object.keys(o)) if(now-o[k]>25000) delete o[k]; setP(o); showOnline(Object.keys(o).length); }
function showOnline(soft){
  const hour=(new Date()).getHours();
  const floor = (hour>=7 && hour<=22) ? 34 : 28; // never look empty
  const fudge = Math.min(8, Math.round(soft*0.2)+2);
  const display = Math.max(floor, soft+fudge);
  whoEl.textContent = display+" online";
}
window.addEventListener('storage',e=>{ if(e.key===ONLINE_KEY) sweep(); });
setInterval(beat,7000); setInterval(sweep,5000); beat(); sweep();

// -------- onboarding gate --------
const gate=document.getElementById('gate');
const enterBtn=document.getElementById('enterBtn');
const chkListMe=document.getElementById('chkListMe');
const moreBox=document.getElementById('moreBox');
chkListMe.addEventListener('change',()=>{ moreBox.style.maxHeight=chkListMe.checked?'180px':'0'; });
function needGate(){ return !localStorage.getItem('galactly:onboarded'); }
function openGate(){ gate.classList.add('show'); }
function closeGate(){ gate.classList.remove('show'); }
enterBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('f_email').value.trim();
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert('Enter a valid email'); return; }
  const payload = { region:'US', email, alerts:true };
  try{
    await fetch(window.API_BASE + '/api/v1/gate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(chkListMe.checked){
      const company=document.getElementById('f_company').value.trim();
      const site=document.getElementById('f_site').value.trim();
      if(company||site){
        await fetch(window.API_BASE + '/api/v1/expose', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ company, site, role:'Packaging supplier', location:'', moq:'', leadtime:'', caps:'', links:'' }) });
      }
    }
    localStorage.setItem('galactly:onboarded','1');
    closeGate();
    kick();
  }catch(e){ alert('Network error. Try again.'); }
});

// -------- UI helpers --------
const grid=document.getElementById('grid');
const banner=document.getElementById('banner');
const refreshEl=document.getElementById('refresh');
const whyPop=document.getElementById('whyPop');
const whyList=document.getElementById('whyList');
const originHint=document.getElementById('originHint');

function relTime(ms){
  const s=Math.max(1, Math.floor(ms/1000));
  if(s<60) return s+'s ago';
  const m=Math.floor(s/60); if(m<60) return m+'m ago';
  const h=Math.floor(m/60); if(h<24) return h+'h ago';
  const d=Math.floor(h/24); return d+'d ago';
}

function heatOf(it){
  const t=((it.title||'')+' '+(it.snippet||'')).toLowerCase();
  const hot=['rfp','rfq','request for proposal','seeking','buy','need supplier','co pack','co-packer'];
  const warm=['recommend','looking for','any vendor','suggest'];
  if(hot.some(k=>t.includes(k))) return {label:'HOT', color:'#ff6b6b'};
  if(warm.some(k=>t.includes(k))) return {label:'WARM', color:'#ffd166'};
  return {label:'OK', color:'#6ee7b7'};
}

function card(it){
  const u=new URL(it.url,location.href);
  const h=heatOf(it);
  const el=document.createElement('div'); el.className='card';
  const ageTag = it.__addedAt ? `<span class="tag">${relTime(Date.now()-it.__addedAt)}</span>` : '';
  el.innerHTML=`
    <a href="${it.url}" target="_blank" rel="noopener" class="title">${it.title||it.url}</a>
    <div class="snip">${(it.snippet||'').replace(/</g,'&lt;')}</div>
    <div class="row">
      <span class="tag">${it.source||'web'}</span>
      <span class="tag">${u.hostname.replace(/^www\./,'')}</span>
      ${ageTag}
      <span class="tag heat"><i style="background:${h.color}"></i>${h.label}</span>
    </div>
    <div class="why" data-origin="${it.url}">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>
      <small>Why AI shows you this lead?</small>
    </div>`;
  el.querySelector('.why').addEventListener('click',()=>showWhy(it));
  return el;
}

function showWhy(it){
  whyList.innerHTML='';
  const reasons=[]; const t=((it.title||'')+' '+(it.snippet||'')).toLowerCase();
  ['rfp','rfq','request for proposal','procurement','buy','seeking','packaging','corrugated','carton','supplier','outsourcing']
    .forEach(k=>{ if(t.includes(k)) reasons.push(`Matched keyword “${k}”.`); });
  reasons.push(`Source: ${it.source||'web'}.`);
  (reasons.length?reasons:['Topical relevance score high.']).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; whyList.appendChild(li); });
  originHint.innerHTML=`Origin: <a href="${it.url}" target="_blank" rel="noopener">${new URL(it.url,location.href).hostname}</a>`;
  whyPop.classList.add('show'); setTimeout(()=>document.addEventListener('click',()=>whyPop.classList.remove('show'),{once:true}),0);
}

// -------- data flow (endless-ish) --------
const QUERY='packaging buyer OR procurement OR RFP site:gov OR site:linkedin.com';
let feed=[], seen=new Set();
function upsert(items){
  let added=0;
  for(const it of items){
    const key=(it.url||'').replace(/[#?].*$/,'');
    if(!key) continue;
    if(!seen.has(key)){
      seen.add(key);
      it.__addedAt = Date.now();
      feed.unshift(it);
      added++;
    }
  }
  if(feed.length>120){ feed=feed.slice(0,120); seen=new Set(feed.map(x=>x.url.replace(/[#?].*$/,''))); }
  return added;
}
function render(){
  grid.replaceChildren();
  for(const it of feed){ grid.appendChild(card(it)); }
}

const refreshElTick = { v:30 };
function countdown(){ refreshEl.textContent=`refresh in ${refreshElTick.v}s`; if(--refreshElTick.v<0){ refreshElTick.v=30; kick(); } }

async function fetchPrimary(){
  const API=(window.API_BASE||'').replace(/\/$/,'');
  if(!API) throw new Error('NO_API');
  const url=`${API}/api/v1/leads?limit=24&q=${encodeURIComponent(QUERY)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP_'+res.status);
  return res.json();
}

function normalizeItems(data){
  if(Array.isArray(data?.items)) return data.items;
  if(Array.isArray(data?.leads)){
    // map DB-style leads to web-like
    return data.leads.map(l=>({
      source: l.platform||'web',
      title: l.kw||l.cat||'Lead',
      url: '#',
      snippet: `${l.region||''} • fit ${l.fit||''}`.trim()
    }));
  }
  return [];
}

async function kick(){
  try{
    const data=await fetchPrimary();
    const items=normalizeItems(data);
    const n=upsert(items);
    if(!feed.length){ banner.hidden=false; banner.textContent='No items yet. Check backend keys.'; }
    else { banner.hidden=true; }
    if(n>0) render();
    if(typeof data.humansOnline==='number') whoEl.textContent = Math.max(parseInt(whoEl.textContent)||0, data.humansOnline)+" online";
  }catch(err){
    if(!feed.length){ banner.hidden=false; banner.textContent='Network error. Showing demo.'; }
    // tiny demo to avoid blank screen
    const demo=[
      {source:'linkedin',title:'3PL needs packaging supplier for new ecommerce client',url:'https://www.linkedin.com/feed/update/demo2',snippet:'Die-cut mailers, branded tape, poly mailers. Monthly volumes 20–40k.'},
      {source:'web',title:'City RFP: Corrugated Boxes & Packaging Materials',url:'https://example.gov/rfp/corrugated-boxes',snippet:'Request for proposals for corrugated boxes in multiple sizes.'}
    ];
    upsert(demo); render();
  }
}

if(needGate()) openGate(); else kick();
setInterval(countdown,1000);
</script>
</body>
</html>
