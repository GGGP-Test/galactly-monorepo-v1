<!doctype html>
const uidEl = document.getElementById('uid');
const countEl = document.getElementById('count');
const apiEl = document.getElementById('api');


let userId = localStorage.getItem('gal_uid');
if (!userId) { userId = 'u-' + Math.random().toString(36).slice(2,10); localStorage.setItem('gal_uid', userId); }
uidEl.textContent = userId;
if (API_BASE) apiEl.textContent = 'API: ' + API_BASE;


async function api(path, opts={}){
const r = await fetch((API_BASE||'') + path, {
headers: { 'content-type':'application/json', 'x-galactly-user': userId, ...(opts.headers||{}) },
method: opts.method||'GET',
body: opts.body ? JSON.stringify(opts.body) : undefined,
cache: 'no-store'
});
if (!r.ok) throw new Error('HTTP '+r.status);
const ct = r.headers.get('content-type')||'';
return ct.includes('application/json') ? r.json() : r.text();
}


function cardTpl(L){
const url = L.source_url || '#';
const dom = url ? (new URL(url)).hostname.replace(/^www\./,'') : '';
return `
<article class="card" data-id="${L.id}" data-domain="${dom}">
<div class="meta"><span class="pill">${L.platform||'web'}</span><span class="pill">fit ${L.fit_user??'-'}%</span><span class="pill">heat ${L.heat??'-'}</span></div>
<strong>${(L.title||'Untitled').slice(0,140)}</strong>
<div>${(L.snippet||'').slice(0,200)}</div>
${url ? `<a href="${url}" target="_blank" rel="noopener">${dom}</a>` : ''}
<div class="btns">
<button class="primary" data-act="claim">Claim</button>
<button data-act="like">üëç More like this</button>
<button data-act="dislike">üëé Less</button>
${dom ? `<button data-act="mute">Mute ${dom}</button>` : ''}
</div>
</article>`;
}


async function postEvent(leadId, type, meta){
try{
await api('/api/v1/events', { method:'POST', body:{ leadId, type, meta }});
}catch(e){ console.warn('event failed', e); }
}


function wireCard(el){
el.addEventListener('click', async (ev)=>{
const b = ev.target.closest('button'); if (!b) return;
const act = b.dataset.act; const id = Number(el.dataset.id); const dom = el.dataset.domain;
if (act === 'claim') {
try{
const r = await api('/api/v1/claim', { method:'POST', body:{ leadId:id } });
if (r?.ok) { b.textContent='Reserved'; b.disabled=true; }
}catch(e){ console.warn(e); }
} else if (act === 'like') {
postEvent(id,'like');
} else if (act === 'dislike') {
postEvent(id,'dislike');
} else if (act === 'mute') {
if (dom) postEvent(id,'mute_domain',{ domain:dom });
el.remove();
}
});
}


async function load(){
try{
const r = await api('/api/v1/leads');
const items = (r && r.leads) ? r.leads : [];
countEl.textContent = items.length + ' leads';
grid.innerHTML = items.map(cardTpl).join('');
[...grid.children].forEach(wireCard);
}catch(e){
grid.innerHTML = `<div class="card">Failed to load: ${e.message}</div>`;
}
}


btnRefresh.addEventListener('click', load);
load();
setInterval(load, 15000);
})();
</script>
</body>
</html>
