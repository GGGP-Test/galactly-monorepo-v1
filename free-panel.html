<!doctype html>
<div><label>API:
<input id="apiBase" size="48"/></label>
<button id="saveApi">Save</button>
</div>
</header>
<div class="wrap">
<div id="feed" class="grid"></div>
</div>


<script>
const uidKey='galactly_uid';
let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
const apiInput=document.getElementById('apiBase');
const saved=localStorage.getItem('api_base')||'';
apiInput.value=saved||'https://<PUT-YOUR-NORTHFLANK-ROUTE>.northflank.app';
document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('api_base', apiInput.value.trim()); location.reload(); };
const API=(p)=> (localStorage.getItem('api_base')||apiInput.value).replace(/\/$/,'') + p;


async function post(path, body){
const r=await fetch(API(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body)});
return r.json();
}
async function events(type, lead, meta){ if(!lead||!lead.id) return; try{ await post('/api/v1/events',{type,leadId:lead.id,meta:meta||{}});}catch(e){} }
function openLead(lead){ events('click', lead, {url:lead.source_url}); window.open(lead.source_url,'_blank','noopener'); }
function likeLead(lead){ events('like', lead); }
function dislikeLead(lead){ events('dislike', lead); }
function muteLead(lead){ let host=''; try{host=new URL(lead.source_url).hostname;}catch(e){} events('mute_domain', lead, {domain:host}); }


const elFeed=document.getElementById('feed');
function card(lead){
const d=document.createElement('div'); d.className='card';
d.innerHTML=`<div class="meta">${lead.platform||'source'} ‚Ä¢ ${new URL(lead.source_url).hostname}</div>
<div><strong>${escapeHtml(lead.title||'Untitled')}</strong></div>
<div>${escapeHtml(lead.snippet||'')}</div>
<div class="btns">
<button>Open</button>
<button>üëç</button>
<button>üëé</button>
<button>Mute</button>
</div>`;
const [bOpen,bLike,bDis,bMute]=d.querySelectorAll('button');
bOpen.onclick=()=>openLead(lead);
bLike.onclick=()=>likeLead(lead);
bDis.onclick=()=>dislikeLead(lead);
bMute.onclick=()=>muteLead(lead);
return d;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }


async function fetchLeads(){
try{
const r=await fetch(API('/api/v1/leads'), { headers: {'x-galactly-user':uid} });
const data=await r.json();
if(!data?.ok){ throw new Error('bad response'); }
elFeed.innerHTML='';
for(const L of data.leads){ elFeed.appendChild(card(L)); }
document.getElementById('status').textContent='ok';
setTimeout(fetchLeads, (data.nextRefreshSec||15)*1000);
}catch(e){ document.getElementById('status').textContent='error'; setTimeout(fetchLeads, 5000); }
}
fetchLeads();
</script>
</body>
</html>
