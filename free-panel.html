<!DOCTYPE html>
if(!localStorage.getItem(KEY)) showGate();


gateForm.addEventListener('submit',async(ev)=>{
ev.preventDefault();
const email=(document.getElementById('email').value||'').trim();
const site=(document.getElementById('site').value||'').trim();
if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) return alert('Enter a valid email');
localStorage.setItem(KEY, JSON.stringify({email,listMe:listMe.checked,site}));
hideGate();
// Optional: hit a lightweight event endpoint later
loadFeed(true);
});


// --- Live feed ---
const grid=document.getElementById('grid');
const empty=document.getElementById('empty');
const refreshEl=document.getElementById('refreshIn');
const onlineEl=document.getElementById('online');
let countdown=25, timer=null;


function tag(label){const span=document.createElement('span'); span.className='tag'; span.textContent=label; return span}
function origin(href,txt){const a=document.createElement('a'); a.className='origin'; a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=txt; return a}
function explain(it){ // heuristic reasons
const t=(it.title||'').toLowerCase(); const s=(it.snippet||'').toLowerCase();
const cues=['rfp','rfq','bid','vendor','supplier','packaging','pallet','box','carton','label','fulfillment','contract','buy','procure'];
const hits=cues.filter(k=>t.includes(k)||s.includes(k));
const host=it.displayLink||new URL(it.url).host;
let why=`Signals on ${host}: `+ (hits.length? hits.slice(0,4).join(', '):'engagement spike / buyer intent keywords');
return why+ (it.url?` Â· <a class="origin" href="${it.url}" target="_blank" rel="noopener">open source</a>`:'');
}


function card(it){
const el=document.createElement('div'); el.className='card';
const h=document.createElement('h3'); h.innerHTML=it.title||it.url; el.appendChild(h);
const p=document.createElement('p'); p.textContent=it.snippet||''; el.appendChild(p);
const row=document.createElement('div'); row.className='row';
row.appendChild(tag(it.source||'web'));
row.appendChild(origin(it.url, it.displayLink||new URL(it.url).host));
el.appendChild(row);
const why=document.createElement('div'); why.className='why'; why.innerHTML='<i>i</i> Why AI shows you this lead?'; el.appendChild(why);
const reason=document.createElement('div'); reason.className='reason'; reason.innerHTML=explain(it); el.appendChild(reason);
why.addEventListener('click',()=>el.classList.toggle('open'));
return el;
}


async function fetchJSON(u){try{const r=await fetch(u,{headers:{'accept':'application/json'}}); if(!r.ok) return null; return await r.json()}catch(_){return null}}


async function loadFeed(force){
clearInterval(timer); countdown=25; tickCountdown(); timer=setInterval(tickCountdown,1000);
const q='packaging buyers RFP';
// Prefer /leads, fallback to /peek
let data=await fetchJSON(`/api/v1/leads?limit=24&q=${encodeURIComponent(q)}`);
if(!data||!Array.isArray(data.items)||!data.items.length){
data=await fetchJSON(`/api/v1/peek?type=web&limit=24&q=${encodeURIComponent(q)}`);
}
const items=data&&Array.isArray(data.items)?data.items:[];
grid.innerHTML='';
if(!items.length){ empty.style.display='block'; return } else empty.style.display='none';
items.forEach(it=>{try{grid.appendChild(card(it))}catch(e){}});
const n=items.length; onlineEl.textContent = `${Math.max(7,Math.min(99,Math.floor(n*1.4)))} online`;
}


function tickCountdown(){ refreshEl.textContent=`refresh in ${countdown--}s`; if(countdown<=0){loadFeed();} }


// Kick off after gate if already opted in
if(localStorage.getItem(KEY)) loadFeed();
</script>
</body>
</html>
