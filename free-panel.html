<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Galactly — Live packaging leads</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#e9eef7;--mut:#9aa3b2;--bg:#0b0f18;--card:#0d1322;--line:rgba(255,255,255,.08);
    --accent:#86f7d6;--accent2:#57a4ff;--good:#7CF3C0;--warn:#F6D365;--hot:#FF8A65;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:
    radial-gradient(1200px 700px at 85% -10%, rgba(120,160,255,.12), rgba(0,0,0,0) 60%),
    radial-gradient(900px 500px at 15% 110%, rgba(120,200,255,.08), rgba(0,0,0,0) 60%),
    linear-gradient(180deg,#0b0e18,#06070c 55%); color:var(--ink); overflow-y:auto}
  a{color:inherit}

  /* Top bar */
  .topbar{position:sticky;top:0;z-index:30;display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--line);backdrop-filter:blur(8px) saturate(1.05);background:rgba(6,8,12,.55)}
  .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 0 0 rgba(134,247,214,.6);animation:pulse 2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(134,247,214,.6)}70%{box-shadow:0 0 0 10px rgba(134,247,214,0)}100%{box-shadow:0 0 0 0 rgba(134,247,214,0)}}
  .spacer{flex:1}
  .pill{opacity:.9;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px;white-space:nowrap}
  .btn{border:1px solid var(--line);background:transparent;color:var(--ink);border-radius:12px;padding:8px 12px;cursor:pointer}

  /* Wrap + grid */
  .wrap{max-width:1240px;margin:16px auto;padding:0 18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,#0b1020,#0a0f1b);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 8px 36px rgba(0,0,0,.32);transform:translateY(0);transition:transform .2s ease, background .2s ease, border-color .2s ease}
  .card.new{animation:drop .35s ease;}
  @keyframes drop{from{transform:translateY(-6px);opacity:.0}to{transform:translateY(0);opacity:1}}
  .title{font-weight:800;margin:0 0 6px;font-size:18px;line-height:1.25}
  .snip{color:var(--mut);font-size:13px;line-height:1.45;max-height:3.7em;overflow:hidden}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .tag{border:1px solid var(--line);border-radius:999px;padding:5px 9px;font-size:11px;color:#cfd6e6}
  .hot{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:5px 9px;font-size:11px;border:1px solid var(--line)}
  .hot i{width:8px;height:12px;background:linear-gradient(180deg,var(--hot),#FFB199);display:inline-block;border-radius:4px}
  .time{opacity:.9}
  .why{display:flex;align-items:center;gap:6px;margin-top:10px;color:#cfd6e6;cursor:pointer}
  .why small{color:var(--mut)} .why:hover small{color:#fff}

  /* New items bar */
  .newbar{position:sticky;top:54px;z-index:20;display:none;justify-content:center}
  .newbar .chip{background:#0f1426;border:1px solid var(--line);border-radius:10px;padding:8px 12px;font-weight:700;font-size:12px;cursor:pointer}
  .newbar.show{display:flex}

  /* Why popover */
  .why-pop{position:fixed;inset:auto 18px 18px auto;max-width:380px;background:#0d1322;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.38);display:none}
  .why-pop.show{display:block}
  .why-pop h4{margin:0 0 8px;font-size:14px}
  .why-pop ul{margin:0;padding:0 0 0 18px}
  .why-pop li{margin:6px 0;color:#cbd3e6;font-size:13px}

  /* Gate */
  .gate{position:fixed;inset:0;display:none;place-items:center;background:rgba(4,6,10,.58);backdrop-filter:blur(6px)}
  .gate.show{display:grid}
  .panel{width:min(680px,92vw);background:linear-gradient(180deg,#0b1020,#0a0f1b);border:1px solid var(--line);border-radius:18px;padding:18px}
  .panel h2{margin:0 0 6px}.panel p{margin:0 0 10px;color:#cfd6e6}
  .f{display:grid;gap:10px;margin-top:12px}
  .f input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1426;color:#fff}
  .cta{display:flex;gap:10px;align-items:center;margin-top:8px}
  .btn.primary{background:linear-gradient(90deg,#fff,#e9f0ff);color:#0a0d12;border:0}

  .banner{margin:12px 0 18px;border:1px dashed var(--line);border-radius:14px;padding:14px 16px;color:var(--mut);text-align:center}
</style>
</head>
<body>
  <div class="topbar">
    <div class="dot"></div>
    <strong>Live feed</strong>
    <span id="refresh" class="pill">refresh in —</span>
    <div class="spacer"></div>
    <span id="auto" class="pill">Auto ▣</span>
    <span id="who" class="pill">— online</span>
    <button class="btn" onclick="location.href='./index.html'">Close</button>
  </div>

  <div id="newbar" class="newbar"><div class="chip" onclick="revealNew()">Show new leads</div></div>

  <div class="wrap">
    <div id="banner" class="banner" hidden></div>
    <div id="grid" class="grid"></div>
  </div>

  <!-- Why popover -->
  <div id="whyPop" class="why-pop">
    <h4>Why AI shows you this lead</h4>
    <ul id="whyList"></ul>
    <div class="hint" id="originHint"></div>
  </div>

  <!-- Onboarding gate -->
  <div id="gate" class="gate">
    <div class="panel">
      <h2>Get in. It’s free.</h2>
      <p>We tune the feed for packaging vendors only. Verify email to enter.</p>
      <div class="f">
        <input id="f_email" type="email" placeholder="Work email (required)" />
        <label style="display:flex;gap:8px;align-items:center;cursor:pointer"><input id="chkListMe" type="checkbox" /> <span>Also list my company for inbound opportunities</span></label>
        <input id="f_company" type="text" placeholder="Company name (optional)" />
        <input id="f_site" type="url" placeholder="Company website (optional)" />
        <div class="cta">
          <button id="enterBtn" class="btn primary">Enter live feed</button>
          <button class="btn" onclick="document.getElementById('gate').classList.remove('show')">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
/***********************
 * API base (inline)
 ***********************/
(function(){
  const DEFAULT='https://p01--animated-cellar--vz4ftkwrzdfs.code.run';
  const q=new URLSearchParams(location.search);
  let base=q.get('api')||localStorage.getItem('apiBase')||DEFAULT;
  function norm(v){ if(!v) return DEFAULT; v=String(v).trim().replace(/\/+$/,''); if(!/^https?:\/\//i.test(v)) v='https://'+v; return v; }
  base=norm(base); window.API_BASE=base; try{localStorage.setItem('apiBase',base)}catch{}
  const _fetch=window.fetch.bind(window);
  window.fetch=(input,init)=>{ try{const url=typeof input==='string'?input:input.url; if(url && url.startsWith('/api/')) return _fetch(window.API_BASE+url,init);}catch{} return _fetch(input,init); };
})();

/***********************
 * State & helpers
 ***********************/
const grid = document.getElementById('grid');
const banner = document.getElementById('banner');
const refreshEl = document.getElementById('refresh');
const newbar = document.getElementById('newbar');
const whoEl = document.getElementById('who');
const autoEl = document.getElementById('auto');
let AUTO=true; autoEl.onclick=()=>{AUTO=!AUTO; autoEl.textContent = 'Auto ' + (AUTO?'▣':'▢');};

let SESSION = localStorage.getItem('galactly:session') || '';
const seen = new Set();           // URLs we've rendered
const pending = [];               // newly fetched items waiting to reveal
const MAX_KEEP = 84;              // room for fresh ones (older are dropped)
let tick = 30;

function authHeaders(){ return SESSION?{'Authorization':'Bearer '+SESSION}:{}}; // eslint-disable-line
function relative(t){ const s=Math.max(1,Math.floor((Date.now()-t)/1000)); if(s<60)return s+'s'; const m=Math.floor(s/60); if(m<60) return m+'m'; const h=Math.floor(m/60); if(h<24) return h+'h'; const d=Math.floor(h/24); return d+'d'; }
function domain(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return '—'; } }

function hotScore(it){
  const txt=((it.title||'')+' '+(it.snippet||'')).toLowerCase();
  let s=30;
  const kw=['rfp','rfq','request for proposal','procurement','seeking','buy','contract','outsourcing','packaging','corrugated','carton','mailer','box','pallet'];
  kw.forEach(k=>{ if(txt.includes(k)) s+=6; });
  const src=String(it.source||'web');
  if(src==='linkedin') s+=10; else if(src==='reddit') s+=6; else if(src==='web') s+=4;
  const t=+new Date(it.ts||it.publishedAt||it.time||Date.now());
  const hrs=(Date.now()-t)/3.6e6; s+=Math.max(0,20-hrs*3); // decay ~3/ hr
  return Math.max(0,Math.min(100,Math.round(s)));
}

/***********************
 * Presence (soft demo floor)
 ***********************/
const ONLINE_KEY='galactly:live:pings';
const myId=Math.random().toString(36).slice(2);
function getP(){ try{return JSON.parse(localStorage.getItem(ONLINE_KEY)||'{}')}catch{return{}} }
function setP(o){ localStorage.setItem(ONLINE_KEY,JSON.stringify(o)); }
function beat(){ const o=getP(); o[myId]=Date.now(); setP(o); }
function sweep(){ const o=getP(),now=Date.now(); for(const k of Object.keys(o)) if(now-o[k]>25000) delete o[k]; setP(o); whoEl.textContent=`${Math.max(40,Math.round(Object.keys(o).length*0.9)+4)} online`; }
window.addEventListener('storage',e=>{ if(e.key===ONLINE_KEY) sweep(); });
setInterval(beat,7000); setInterval(sweep,5000); beat(); sweep();

/***********************
 * Gate (non-blocking on network)
 ***********************/
const gate=document.getElementById('gate');
const enterBtn=document.getElementById('enterBtn');
enterBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('f_email').value.trim();
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { alert('Enter a valid email'); return; }
  const payload = { email, listMe: document.getElementById('chkListMe').checked, company: document.getElementById('f_company').value.trim(), site: document.getElementById('f_site').value.trim() };
  try{
    const r = await fetch('/api/v1/onboard', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const j = await r.json().catch(()=>({}));
    if(j && j.session){ SESSION=j.session; localStorage.setItem('galactly:session',SESSION); }
  }catch{}
  localStorage.setItem('galactly:onboarded', JSON.stringify(payload));
  gate.classList.remove('show');
});
if(!localStorage.getItem('galactly:onboarded')) gate.classList.add('show');

/***********************
 * Rendering
 ***********************/
function scoreChip(score){
  const el=document.createElement('span');
  el.className='hot';
  el.innerHTML=`<i></i> Hot ${score}`;
  el.style.borderColor='var(--line)';
  if(score>75) el.style.background='rgba(255,138,101,.13)';
  else if(score>55) el.style.background='rgba(246,211,101,.10)';
  else el.style.background='rgba(124,243,192,.10)';
  return el;
}

function card(it, isNew=false){
  const t=+new Date(it.ts||it.publishedAt||it.time||Date.now());
  const s=hotScore(it);
  const el=document.createElement('div'); el.className='card'+(isNew?' new':'');
  el.innerHTML = `
    <a href="${it.url}" target="_blank" rel="noopener" class="title">${it.title||it.url}</a>
    <div class="snip">${(it.snippet||'').replace(/</g,'&lt;')}</div>
    <div class="row">
      <span class="tag">${String(it.source||'web')}</span>
      <span class="tag">${domain(it.url)}</span>
      <span class="tag time" data-ts="${t}">${relative(t)}</span>
    </div>
  `;
  el.querySelector('.row').appendChild(scoreChip(s));
  const why = document.createElement('div');
  why.className='why';
  why.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg><small>Why AI shows you this lead?</small>';
  why.onclick=()=>showWhy(it);
  el.appendChild(why);
  return el;
}

// relative time ticker
setInterval(()=>{
  document.querySelectorAll('.time').forEach(n=>{ const ts=+n.getAttribute('data-ts'); n.textContent=relative(ts); });
}, 1000);

/***********************
 * Fetch + merge loop
 ***********************/
const QUERY='packaging buyer OR procurement OR RFP site:gov OR site:linkedin.com';
const demoItems=[
  {source:'linkedin',title:'Seeking contract packaging partner for Q4 promotion — CPG brand',url:'https://www.linkedin.com/feed/update/demo1',snippet:'US brand needs co-packer for gift bundles. Corrugated + inserts. Quick turnaround.',ts:Date.now()-25_000},
  {source:'web',title:'City of Mesa — RFP: Corrugated Boxes & Packaging Materials',url:'https://example.gov/rfp/corrugated-boxes',snippet:'City requests proposals for corrugated boxes in multiple sizes for warehouse ops.',ts:Date.now()-120_000},
  {source:'web',title:'University RFQ: Custom Foam Inserts for Instruments',url:'https://example.edu/rfq/foam-inserts',snippet:'Quote request for precision-cut foam inserts and cartons. Delivery + packaging.',ts:Date.now()-3600_000},
  {source:'reddit',title:'Where to source custom rigid boxes in the US?',url:'https://reddit.com/r/AskEngineers/demo',snippet:'Buyer asking for domestic rigid box suppliers, low MOQs, embossing, foil.',ts:Date.now()-4_000}
];

async function fetchLeads(){
  const url=`/api/v1/leads?limit=32&q=${encodeURIComponent(QUERY)}`;
  const res = await fetch(url, { headers: authHeaders() });
  if(!res.ok) throw new Error('HTTP_'+res.status);
  const data = await res.json();
  const items = (data && Array.isArray(data.items)) ? data.items : [];
  return items;
}

const pending = [];      // (already declared above)
const seen = new Set();  // (already declared above)
function pushNew(items){
  let adds=0;
  for(const it of items){
    const key=(it.url||'').replace(/[?#].*$/,'');
    if(!key || seen.has(key)) continue;
    seen.add(key);
    if(!it.ts && !it.publishedAt && !it.time) it.ts = Date.now()-Math.floor(Math.random()*90_000);
    pending.push(it);
    adds++;
  }
  if(adds){ newbar.classList.add('show'); document.querySelector('#newbar .chip').textContent = `Show ${adds} new lead${adds>1?'s':''}`; }
}

function revealNew(){
  newbar.classList.remove('show');
  pending.sort((a,b)=> (new Date(b.ts||b.publishedAt||b.time||0)) - (new Date(a.ts||a.publishedAt||a.time||0)) );
  for(const it of pending.splice(0)){
    grid.prepend(card(it, true));
  }
  while(grid.children.length>84){ grid.lastElementChild.remove(); }
}

async function kick(){
  try{
    const items = await fetchLeads();
    banner.hidden=true;
    if(grid.children.length===0){
      items.sort((a,b)=> (new Date(b.ts||b.publishedAt||b.time||0)) - (new Date(a.ts||a.publishedAt||a.time||0)) );
      for(const it of items){ const key=(it.url||'').replace(/[?#].*$/,''); if(!seen.has(key)){ seen.add(key); grid.appendChild(card(it)); } }
    }else{
      pushNew(items);
    }
  }catch(err){
    if(grid.children.length===0){
      banner.hidden=false; banner.textContent='Network error. Showing demo feed.';
      pushNew(demoItems); revealNew();
    } else {
      banner.hidden=false; banner.textContent='Network error. Will retry…';
    }
  }
}

function countdown(){ refreshEl.textContent=`refresh in ${tick}s`; if(--tick<0){ tick=30; if(AUTO) kick(); } }

kick();
revealNew();
setInterval(countdown,1000);
setInterval(()=>{ if(AUTO) kick(); }, 20000);

/***********************
 * Why popover
 ***********************/
const whyPop=document.getElementById('whyPop');
const whyList=document.getElementById('whyList');
const originHint=document.getElementById('originHint');
function showWhy(it){
  whyList.innerHTML='';
  const reasons=[]; const t=((it.title||'')+' '+(it.snippet||'')).toLowerCase();
  ['rfp','rfq','request for proposal','procurement','buy','seeking','packaging','corrugated','carton','supplier','outsourcing']
    .forEach(k=>{ if(t.includes(k)) reasons.push(`Matched keyword “${k}”.`); });
  reasons.push(`Source: ${String(it.source||'web')}.`);
  (reasons.length?reasons:['Topical relevance score high.']).forEach(s=>{ const li=document.createElement('li'); li.textContent=s; whyList.appendChild(li); });
  originHint.innerHTML = `Origin: <a href="${it.url}" target="_blank" rel="noopener">${domain(it.url)}</a>`;
  whyPop.classList.add('show');
  setTimeout(()=>document.addEventListener('click',()=>whyPop.classList.remove('show'),{once:true}),0);
}
</script>
</body>
</html>
