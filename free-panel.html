<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galactly ‚Äî DIY Lead Finder</title>
  <style>
    :root{
      --bg:#0b0e13; --card:#111725; --line:#1f2a3b; --text:#e8ecf1; --muted:#9bb1c7;
      --btn:#1e2a3b; --btn-line:#2a3b55; --accent:#69b3ff; --green:#36d399; --red:#f87272;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line)}
    header .brand{font-weight:700}
    .pill{border:1px solid var(--btn-line);border-radius:999px;padding:2px 8px;color:var(--muted);font-size:12px;margin-left:8px}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .form{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
    .form .field{grid-column:span 12}
    @media (min-width:920px){ .form .field.sm-4{grid-column:span 4} .form .field.sm-6{grid-column:span 6} }
    label{display:block;font-size:12px;opacity:.85;margin-bottom:6px}
    input,textarea,select{width:100%;background:#0e1420;border:1px solid var(--btn-line);color:var(--text);padding:9px 10px;border-radius:10px}
    textarea{min-height:70px;resize:vertical}
    button{background:var(--btn);border:1px solid var(--btn-line);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .btn-acc{border-color:#2c6ebf}
    .btn-ok{border-color:#2c7a57}
    .btn-bad{border-color:#9b2c2c}
    .mute{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .meta{font-size:12px;color:var(--muted)}
    a{color:var(--accent)}
    .spacer{height:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">Galactly <span id="status" class="pill">init‚Ä¶</span></div>
    <div>
      <label class="mute">API Base</label>
      <input id="apiBase" size="42" />
      <button id="saveApi">Save</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <form id="finder" class="form" onsubmit="return false">
        <div class="field sm-6">
          <label>Your website (optional)</label>
          <input id="vendorDomain" placeholder="acme-packaging.com" />
        </div>
        <div class="field sm-6">
          <label>Seed buyer domains (comma or newline separated)</label>
          <textarea id="buyers" placeholder="liquiddeath.com, soylent.com\nexamplebrand.com"></textarea>
        </div>
        <div class="field sm-4">
          <label>Industries (comma separated)</label>
          <input id="industries" placeholder="beverage, food, cosmetics" />
        </div>
        <div class="field sm-4">
          <label>Regions (ISO-2, comma: e.g. US,CA,GB)</label>
          <input id="regions" placeholder="US,CA" />
        </div>
        <div class="field sm-4">
          <label>Meta Ad Library Countries (ISO-2, env-driven)</label>
          <input id="metaCountries" placeholder="US,CA" />
        </div>
        <div class="field sm-6">
          <button id="run" class="btn-acc">Find buyers now</button>
          <span class="mute" id="result"></span>
        </div>
      </form>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <div style="flex:1">
        <div class="mute" style="margin:6px 2px">Live feed</div>
        <div id="feed" class="grid"></div>
      </div>
    </div>
  </div>

<script>
  // ------- tiny state -------
  const uidKey='galactly_uid';
  let uid=localStorage.getItem(uidKey); if(!uid){ uid='u-'+Math.random().toString(36).slice(2); localStorage.setItem(uidKey,uid); }
  const apiInput=document.getElementById('apiBase');
  apiInput.value=localStorage.getItem('api_base')||'https://<PUT-YOUR-NORTHFLANK-ROUTE>.code.run';
  document.getElementById('saveApi').onclick=()=>{ localStorage.setItem('api_base', apiInput.value.trim()); location.reload(); };
  const API=(p)=> (localStorage.getItem('api_base')||apiInput.value).replace(/\/$/,'') + p;

  function textToList(v){
    if(!v) return [];
    return v.split(/\n|,|;|\s+/).map(s=>s.trim()).filter(Boolean);
  }
  function setStatus(s){ document.getElementById('status').textContent=s; }

  async function post(path, body){
    const r=await fetch(API(path), {method:'POST', headers:{'content-type':'application/json','x-galactly-user':uid}, body:JSON.stringify(body)});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function events(type, lead, meta){ if(!lead||!lead.id) return; try{ await post('/api/v1/events',{type,leadId:lead.id,meta:meta||{}});}catch(e){} }
  function openLead(lead){ try{ events('click', lead, {url:lead.source_url}); window.open(lead.source_url,'_blank','noopener'); }catch(e){} }
  function likeLead(l){ events('like',l); }
  function dislikeLead(l){ events('dislike',l); }
  function muteLead(l){ let host=''; try{host=new URL(l.source_url).hostname;}catch(e){} events('mute_domain', l, {domain:host}); }
  async function claimLead(l){ const r=await post('/api/v1/claim',{leadId:l.id}); if(r?.ok){ l._win=r.windowId; l._exp=Date.now()+(r.reservedForSec||120)*1000; render(); } }
  async function ownLead(l){ if(!l._win) return; const r=await post('/api/v1/own',{windowId:l._win}); if(r?.ok){ events('own',l); l._owned=true; render(); } }

  // ------- form submit -------
  document.getElementById('run').onclick=async ()=>{
    const buyers=textToList(document.getElementById('buyers').value);
    const industries=textToList(document.getElementById('industries').value);
    const regions=textToList(document.getElementById('regions').value);
    const vendorDomain=(document.getElementById('vendorDomain').value||'').trim();
    // optionally reflect desired meta countries to backend via env (UI hint only)
    const metaCountries=(document.getElementById('metaCountries').value||'').trim();
    if(metaCountries) localStorage.setItem('adlib_meta_countries_hint', metaCountries);

    setStatus('running‚Ä¶');
    document.getElementById('result').textContent='';
    try{
      const out=await post('/api/v1/find-now',{ buyers, industries, regions, vendorDomain });
      document.getElementById('result').textContent=`checked ${out.checked}, created ${out.created} (ads: ${out.advertisers})`;
      setStatus('ok');
      await fetchLeads();
    }catch(e){ setStatus('error'); document.getElementById('result').textContent='error: '+e.message; }
  };

  // ------- feed -------
  const feedEl=document.getElementById('feed');
  let last=null;
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function remain(l){ if(!l._exp) return ''; const s=Math.max(0,Math.ceil((l._exp-Date.now())/1000)); return s+'s'; }
  function card(L){
    const d=document.createElement('div'); d.className='card';
    let host=''; try{ host=new URL(L.source_url).hostname; }catch{}
    d.innerHTML=`
      <div class="meta">${escapeHtml(L.platform||'source')} ‚Ä¢ ${escapeHtml(host)}</div>
      <div><strong>${escapeHtml(L.title||'Untitled')}</strong></div>
      <div class="meta">${escapeHtml(L.snippet||'')}</div>
      <div class="row" style="gap:8px;margin-top:8px">
        <button data-a="open">Open</button>
        <button data-a="like">üëç</button>
        <button data-a="dis">üëé</button>
        <button data-a="mute">Mute</button>
        <button data-a="claim" class="btn-ok">Claim</button>
        <button data-a="own" class="btn-ok">Own</button>
        <button data-a="confirm" class="btn-acc">Confirm ad</button>
        <span class="meta" data-a="left"></span>
      </div>`;
    d.querySelector('[data-a=open]').onclick=()=>openLead(L);
    d.querySelector('[data-a=like]').onclick=()=>likeLead(L);
    d.querySelector('[data-a=dis]').onclick=()=>dislikeLead(L);
    d.querySelector('[data-a=mute]').onclick=()=>muteLead(L);
    d.querySelector('[data-a=claim]').onclick=()=>claimLead(L);
    d.querySelector('[data-a=own]').onclick=()=>ownLead(L);
    d.querySelector('[data-a=confirm]').onclick=()=>events('confirm_ad', L, {url:L.source_url});
    const left=d.querySelector('[data-a=left]');
    if(L._win && !L._owned){ left.textContent='reserved '+remain(L); }
    if(L._owned){ left.textContent='owned'; }
    return d;
  }
  function render(){ if(!last) return; feedEl.innerHTML=''; for(const L of last.leads){ feedEl.appendChild(card(L)); } }

  async function fetchLeads(){
    try{
      const r=await fetch(API('/api/v1/leads'), { headers:{'x-galactly-user':uid} });
      const data=await r.json(); last=data; render(); setStatus('ok');
      setTimeout(fetchLeads, (data.nextRefreshSec||20)*1000);
    }catch(e){ setStatus('error'); setTimeout(fetchLeads, 6000); }
  }
  fetchLeads();
</script>
</body>
</html>
