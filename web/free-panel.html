<!doctype html>
// claim/own flow
async function claimLead(lead){
const r=await post('/api/v1/claim',{leadId:lead.id});
if(r?.ok){ lead._windowId=r.windowId; lead._exp=Date.now()+(r.reservedForSec||120)*1000; render(); }
}
async function ownLead(lead){ if(!lead._windowId) return; const r=await post('/api/v1/own',{windowId:lead._windowId}); if(r?.ok){ events('own',lead); lead._owned=true; render(); } }
function remain(lead){ if(!lead._exp) return ''; const s=Math.max(0,Math.ceil((lead._exp-Date.now())/1000)); return s+'s'; }


const elFeed=document.getElementById('feed');
function card(lead){
const d=document.createElement('div'); d.className='card';
let host=''; try{host=new URL(lead.source_url).hostname;}catch(e){}
d.innerHTML=`<div class="meta">${lead.platform||'source'} ‚Ä¢ ${host}</div>
<div><strong>${escapeHtml(lead.title||'Untitled')}</strong></div>
<div>${escapeHtml(lead.snippet||'')}</div>
<div class="btns">
<button data-a="open">Open</button>
<button data-a="like">üëç</button>
<button data-a="dis">üëé</button>
<button data-a="mute">Mute</button>
<button data-a="claim">Claim</button>
<button data-a="own">Own</button>
<span class="meta" data-a="left"></span>
</div>`;
d.querySelector('[data-a=open]').onclick=()=>openLead(lead);
d.querySelector('[data-a=like]').onclick=()=>likeLead(lead);
d.querySelector('[data-a=dis]').onclick=()=>dislikeLead(lead);
d.querySelector('[data-a=mute]').onclick=()=>muteLead(lead);
d.querySelector('[data-a=claim]').onclick=()=>claimLead(lead);
d.querySelector('[data-a=own]').onclick=()=>ownLead(lead);
const left=d.querySelector('[data-a=left]');
if(lead._windowId&&!lead._owned){ const t=remain(lead); left.textContent=t?('reserved '+t):''; }
if(lead._owned){ left.textContent='owned'; }
return d;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }


let lastData=null; function render(){ if(!lastData) return; elFeed.innerHTML=''; for(const L of lastData.leads){ elFeed.appendChild(card(L)); } }


async function fetchLeads(){
try{
const r=await fetch(API('/api/v1/leads'), { headers: {'x-galactly-user':uid} });
const data=await r.json(); lastData=data;
if(!data?.ok){ throw new Error('bad response'); }
render();
document.getElementById('status').textContent='ok';
setTimeout(fetchLeads, (data.nextRefreshSec||15)*1000);
}catch(e){ document.getElementById('status').textContent='error'; setTimeout(fetchLeads, 5000); }
}
fetchLeads();
</script>
</body>
</html>
