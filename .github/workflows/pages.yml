name: Deploy Pages (safe subset from docs)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PUBLIC_SRC: docs
  PUBLIC_OUT: public

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Assemble public site
        run: |
          set -euo pipefail

          rm -rf "$PUBLIC_OUT"
          mkdir -p "$PUBLIC_OUT"

          # ----- allow-list: ONLY these files/dirs are deployed -----
          # Core public pages
          cp -v "$PUBLIC_SRC/index.html"      "$PUBLIC_OUT/" || true
          cp -v "$PUBLIC_SRC/start.html"      "$PUBLIC_OUT/" || true
          cp -v "$PUBLIC_SRC/login.html"      "$PUBLIC_OUT/" || true
          cp -v "$PUBLIC_SRC/bridge.html"     "$PUBLIC_OUT/" || true   # <- NEW
          cp -v "$PUBLIC_SRC/step3.html"      "$PUBLIC_OUT/" || true
          cp -v "$PUBLIC_SRC/pricing.html"    "$PUBLIC_OUT/" || true
          cp -v "$PUBLIC_SRC/free-panel.html" "$PUBLIC_OUT/" || true
          [ -f "$PUBLIC_SRC/404.html" ]    && cp -v "$PUBLIC_SRC/404.html"    "$PUBLIC_OUT/404.html"    || true
          [ -f "$PUBLIC_SRC/robots.txt" ]  && cp -v "$PUBLIC_SRC/robots.txt"  "$PUBLIC_OUT/robots.txt"  || true
          [ -f "$PUBLIC_SRC/sitemap.xml" ] && cp -v "$PUBLIC_SRC/sitemap.xml" "$PUBLIC_OUT/sitemap.xml" || true

          # ===== FAVICONS + MANIFEST (copy to ROOT) =====
          for f in \
            favicon.ico \
            apple-touch-icon.png \
            favicon-16x16.png \
            favicon-32x32.png \
            android-chrome-192x192.png \
            android-chrome-512x512.png \
            site.webmanifest
          do
            [ -f "$PUBLIC_SRC/$f" ] && cp -v "$PUBLIC_SRC/$f" "$PUBLIC_OUT/$f" || true
          done
          # (Optional) if you keep them under docs/favicons/, also lift them to root:
          if [ -d "$PUBLIC_SRC/favicons" ]; then
            for f in apple-touch-icon.png favicon-16x16.png favicon-32x32.png android-chrome-192x192.png android-chrome-512x512.png site.webmanifest; do
              [ -f "$PUBLIC_SRC/favicons/$f" ] && cp -v "$PUBLIC_SRC/favicons/$f" "$PUBLIC_OUT/$f" || true
            done
          fi
          # ============================================

          # Shared assets
          [ -d "$PUBLIC_SRC/assets" ]   && rsync -a --delete "$PUBLIC_SRC/assets/"   "$PUBLIC_OUT/assets/"   || true
          [ -d "$PUBLIC_SRC/img" ]      && rsync -a --delete "$PUBLIC_SRC/img/"      "$PUBLIC_OUT/img/"      || true
          [ -d "$PUBLIC_SRC/css" ]      && rsync -a --delete "$PUBLIC_SRC/css/"      "$PUBLIC_OUT/css/"      || true
          [ -d "$PUBLIC_SRC/js" ]       && rsync -a --delete "$PUBLIC_SRC/js/"       "$PUBLIC_OUT/js/"       || true
          [ -d "$PUBLIC_SRC/fragments" ] && rsync -a --delete "$PUBLIC_SRC/fragments/" "$PUBLIC_OUT/fragments/" || true

          # Sections
          if [ -d "$PUBLIC_SRC/sections/process" ]; then
            mkdir -p "$PUBLIC_OUT/sections/process"
            rsync -a --delete "$PUBLIC_SRC/sections/process/" "$PUBLIC_OUT/sections/process/"
          fi
          if [ -d "$PUBLIC_SRC/sections/orbit" ]; then
            mkdir -p "$PUBLIC_OUT/sections/orbit"
            rsync -a --delete "$PUBLIC_SRC/sections/orbit/" "$PUBLIC_OUT/sections/orbit/"
          fi

          # Prevent Jekyll munging
          : > "$PUBLIC_OUT/.nojekyll"

          echo "Public site contents:"
          find "$PUBLIC_OUT" -maxdepth 2 -type f | sort

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4